<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>S22 Market - Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
    <meta name="theme-color" content="#4f46e5">
    <meta name="description" content="Ù…ØªØ¬Ø± S22 Market - Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø¹Ø±ÙˆØ¶">

    <link rel="apple-touch-icon" href="LOGO.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --bg-body: #f8fafc;
            --nav-height: 70px;
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        /* Dark Mode Setup */
        body.dark-mode {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-body);
            padding-bottom: calc(var(--nav-height) + 20px);
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
            /* Ù„Ù…Ù†Ø¹ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ù…ØªØµÙØ­ */
        }

        body.dark-mode {
            color: var(--text-main);
        }

        body.dark-mode .bg-white,
        body.dark-mode .product-card {
            background-color: var(--bg-card) !important;
            border-color: #334155 !important;
            color: var(--text-main);
        }

        body.dark-mode .text-gray-800 {
            color: #f1f5f9 !important;
        }

        body.dark-mode .text-gray-600 {
            color: #cbd5e1 !important;
        }

        body.dark-mode .bg-gray-100 {
            background-color: #334155 !important;
        }

        /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Glassmorphism Navigation */
        .glass-nav {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.05);
        }

        body.dark-mode .glass-nav {
            background: rgba(30, 41, 59, 0.85);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Bottom Nav Items */
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            color: #94a3b8;
            gap: 4px;
            transition: 0.3s;
            position: relative;
            width: 20%;
        }

        .nav-item.active {
            color: var(--primary);
            font-weight: 700;
            transform: scale(1.05);
        }

        /* Floating Action Button (FAB) */
        .fab-container {
            position: relative;
            top: -25px;
        }

        .fab-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.5);
            border: 4px solid var(--bg-body);
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(245, 158, 11, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0);
            }
        }

        /* Product Card */
        .product-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            border: 1px solid #f1f5f9;
            position: relative;
        }

        .product-image {
            aspect-ratio: 1/1;
            background-color: #f8fafc;
            overflow: hidden;
            position: relative;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: 0.5s;
        }

        /* Stories / Categories */
        .cat-icon {
            width: 62px;
            height: 62px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--primary);
            background: white;
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .cat-icon::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 50%;
            background: linear-gradient(45deg, #f59e0b, #ec4899, #6366f1);
            z-index: -1;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            right: -100%;
            width: 85%;
            max-width: 300px;
            height: 100%;
            background: white;
            z-index: 60;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.active {
            right: 0;
        }

        .backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
            backdrop-filter: blur(4px);
        }

        .backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Pull to Refresh Spinner */
        #ptr-spinner {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            pointer-events: none;
            transition: transform 0.2s;
            transform: translateY(-50px);
            z-index: 30;
        }

        .spinner-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 14px;
        }

        .spinner-icon.loading {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        body.dark-mode .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
        }

        /* Header Sticky */
        .sticky-header {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        body.dark-mode .sticky-header {
            background: rgba(30, 41, 59, 0.95);
        }
    </style>
</head>

<body>

    <div id="ptr-spinner">
        <div class="spinner-icon"><i class="fas fa-sync-alt"></i></div>
    </div>

    <header id="main-header"
        class="fixed top-0 left-0 right-0 z-40 px-4 py-3 transition-all duration-300 backdrop-blur-md">
        <div class="flex items-center justify-between gap-4 mb-3">
            <button id="menu-btn"
                class="w-10 h-10 flex items-center justify-center text-gray-700 hover:bg-gray-100 rounded-full transition">
                <i class="fas fa-bars text-xl"></i>
            </button>

            <h1 class="text-2xl font-black text-gray-800 tracking-tighter"
                onclick="window.scrollTo({top:0, behavior:'smooth'})">
                S22<span class="text-indigo-600">MARKET</span>
            </h1>

            <a href="cart.html"
                class="w-10 h-10 flex items-center justify-center text-gray-700 relative hover:bg-gray-100 rounded-full transition">
                <i class="fas fa-shopping-bag text-xl"></i>
                <span id="header-cart-badge"
                    class="absolute top-1 right-0 bg-red-500 text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center hidden border-2 border-white scale-0 transition-transform duration-300">0</span>
            </a>
        </div>

        <div class="relative">
            <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input type="search" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ØŒ Ù…Ø·Ø¹Ù…..."
                class="w-full bg-gray-100 dark:bg-slate-700 dark:text-white text-gray-800 rounded-2xl py-3 pr-11 pl-12 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition shadow-inner">

            <button id="voice-search-btn"
                class="absolute left-2 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center text-indigo-500 hover:bg-indigo-50 rounded-full transition">
                <i class="fas fa-microphone"></i>
            </button>
        </div>
    </header>

    <div class="h-[135px]"></div>

    <main class="space-y-6 pb-6">

        <section class="px-4">
            <div class="flex justify-between items-end mb-3">
                <h2 class="font-bold text-gray-800 text-lg">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>
                <a href="classproductindex.html"
                    class="text-xs text-indigo-600 font-bold bg-indigo-50 px-2 py-1 rounded-md">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
            </div>
            <div class="flex gap-4 overflow-x-auto no-scrollbar pb-2 snap-x" id="categories-container">
                <div class="flex flex-col items-center gap-2 min-w-[70px] snap-center">
                    <div class="cat-icon skeleton"></div>
                    <div class="h-2 w-10 skeleton rounded"></div>
                </div>
                <div class="flex flex-col items-center gap-2 min-w-[70px] snap-center">
                    <div class="cat-icon skeleton"></div>
                    <div class="h-2 w-10 skeleton rounded"></div>
                </div>
                <div class="flex flex-col items-center gap-2 min-w-[70px] snap-center">
                    <div class="cat-icon skeleton"></div>
                    <div class="h-2 w-10 skeleton rounded"></div>
                </div>
            </div>
        </section>

        <section class="px-4">
            <div class="swiper main-slider rounded-2xl overflow-hidden shadow-lg h-44 sm:h-56 bg-gray-200 relative">
                <div class="swiper-wrapper" id="hero-slider-wrapper">
                    <div class="swiper-slide skeleton w-full h-full"></div>
                </div>
                <div class="swiper-pagination"></div>
            </div>
        </section>

        <section class="px-4">
            <div class="grid grid-cols-2 gap-3">
                <a href="s22marketfood.html"
                    class="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-2xl border border-orange-100 dark:border-orange-900/30 flex items-center justify-between group">
                    <div>
                        <h3 class="font-bold text-orange-800 dark:text-orange-400">Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</h3>
                        <p class="text-[10px] text-orange-600 dark:text-orange-300/70 mt-1">Ø§Ø·Ù„Ø¨ ÙˆØ¬Ø¨ØªÙƒ Ø§Ù„Ø¢Ù† ğŸ”</p>
                    </div>
                    <div
                        class="w-10 h-10 bg-white dark:bg-orange-800 rounded-full flex items-center justify-center text-orange-500 shadow-sm group-hover:scale-110 transition">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
                <a href="auctions.html"
                    class="bg-red-50 dark:bg-red-900/20 p-4 rounded-2xl border border-red-100 dark:border-red-900/30 flex items-center justify-between group">
                    <div>
                        <h3 class="font-bold text-red-800 dark:text-red-400">Ø§Ù„Ù…Ø²Ø§Ø¯Ø§Øª</h3>
                        <p class="text-[10px] text-red-600 dark:text-red-300/70 mt-1">ØµÙÙ‚Ø§Øª Ù„Ø§ ØªÙÙˆØª ğŸ†</p>
                    </div>
                    <div
                        class="w-10 h-10 bg-white dark:bg-red-800 rounded-full flex items-center justify-center text-red-500 shadow-sm group-hover:scale-110 transition">
                        <i class="fas fa-gavel"></i>
                    </div>
                </a>
            </div>
        </section>

        <div id="home-dynamic-sections"></div>

        <section class="px-4" id="default-products-section">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                    <span class="w-1 h-5 bg-indigo-600 rounded-full"></span> ÙˆØµÙ„ Ø­Ø¯ÙŠØ«Ø§Ù‹
                </h2>
            </div>

            <div id="products-grid" class="grid grid-cols-2 gap-3 sm:gap-4">
            </div>
        </section>

        <div class="h-10"></div>
    </main>

    <div class="backdrop" id="backdrop"></div>
    <aside class="sidebar flex flex-col" id="sidebar">
        <div class="bg-gradient-to-br from-indigo-600 to-purple-700 p-6 text-white pt-10">
            <div class="flex items-center gap-3 mb-3">
                <div
                    class="w-14 h-14 bg-white/20 backdrop-blur rounded-full flex items-center justify-center text-2xl font-bold border-2 border-white/30">
                    <i class="fas fa-user"></i>
                </div>
                <div id="sidebar-user-info">
                    <h3 class="font-bold text-lg">Ø²Ø§Ø¦Ø± ÙƒØ±ÙŠÙ…</h3>
                    <a href="login.html"
                        class="text-xs bg-white/20 px-3 py-1 rounded-full hover:bg-white/30 transition inline-block mt-1">ØªØ³Ø¬ÙŠÙ„
                        Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
                </div>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-1">
            <a href="index.html"
                class="flex items-center gap-4 px-4 py-3 text-indigo-600 bg-indigo-50 rounded-xl font-bold dark:bg-slate-700 dark:text-white">
                <i class="fas fa-home w-5 text-center"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </a>
            <a href="s22marketfood.html"
                class="flex items-center gap-4 px-4 py-3 text-gray-600 hover:bg-gray-50 dark:text-gray-300 dark:hover:bg-slate-700 rounded-xl transition">
                <i class="fas fa-utensils w-5 text-center text-orange-500"></i> Ø§Ù„Ù…Ø·Ø§Ø¹Ù…
            </a>
            <a href="cart.html"
                class="flex items-center gap-4 px-4 py-3 text-gray-600 hover:bg-gray-50 dark:text-gray-300 dark:hover:bg-slate-700 rounded-xl transition">
                <i class="fas fa-shopping-cart w-5 text-center text-blue-500"></i> Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
            </a>

            <div class="my-3 border-t border-gray-100 dark:border-gray-700"></div>

            <a href="profile.html?action=open_store"
                class="flex items-center gap-4 px-4 py-3 text-gray-600 hover:bg-green-50 dark:text-gray-300 dark:hover:bg-green-900/20 rounded-xl transition group">
                <i class="fas fa-store w-5 text-center text-green-600"></i>
                <span class="font-bold text-green-700 dark:text-green-400">Ø§ÙØªØ­ Ù…ØªØ¬Ø±Ùƒ Ù…Ø¬Ø§Ù†Ø§Ù‹</span>
            </a>

            <button id="dark-mode-toggle"
                class="w-full flex items-center justify-between px-4 py-3 mt-4 bg-gray-100 dark:bg-slate-700 rounded-xl text-gray-700 dark:text-gray-200">
                <span class="flex items-center gap-2 text-sm font-bold"><i class="fas fa-moon"></i> Ø§Ù„Ù…Ø¸Ù‡Ø±</span>
                <div
                    class="w-10 h-5 bg-gray-300 dark:bg-indigo-600 rounded-full relative transition-colors duration-300">
                    <div
                        class="w-4 h-4 bg-white rounded-full absolute top-0.5 left-0.5 shadow-sm transition-transform duration-300 dark:translate-x-5">
                    </div>
                </div>
            </button>
        </nav>
    </aside>

    <nav
        class="fixed bottom-0 left-0 right-0 h-[70px] glass-nav flex justify-around items-center z-50 pb-[env(safe-area-inset-bottom)]">
        <a href="index.html" class="nav-item active">
            <i class="fas fa-home text-lg"></i> <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </a>
        <a href="s22marketfood.html" class="nav-item">
            <i class="fas fa-utensils text-lg"></i> <span>Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</span>
        </a>
        <a href="auctions.html" class="fab-container">
            <div class="fab-btn"><i class="fas fa-gavel"></i></div>
        </a>
        <a href="cart.html" class="nav-item">
            <div class="relative">
                <i class="fas fa-shopping-cart text-lg"></i>
                <span id="nav-cart-badge"
                    class="absolute -top-1 -right-2 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center font-bold hidden border border-white">0</span>
            </div>
            <span>Ø§Ù„Ø³Ù„Ø©</span>
        </a>
        <a href="profile.html" class="nav-item">
            <i class="fas fa-user text-lg"></i> <span>Ø­Ø³Ø§Ø¨ÙŠ</span>
        </a>
    </nav>

    <div id="toast-container"
        class="fixed bottom-24 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 w-max max-w-[90%]"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, query, where, orderBy, limit, updateDoc, onSnapshot, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Global State ---
        let currentUser = null;
        let userWishlist = new Set();

        // --- Elements ---
        const productsGrid = document.getElementById('products-grid');
        const categoriesContainer = document.getElementById('categories-container');
        const heroWrapper = document.getElementById('hero-slider-wrapper');
        const header = document.getElementById('main-header');

        // --- 1. Initialization ---
        async function initApp() {
            renderSkeletons();

            // ØªÙ†ÙÙŠØ° ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø³Ø±Ø¹Ø©
            await Promise.all([
                loadCategories(),
                loadHeroSlider(),
                loadProducts() // This includes dynamic sections + default
            ]);

            setupPullToRefresh();
        }

        function renderSkeletons() {
            // Ø±Ø³Ù… Ø¹Ù†Ø§ØµØ± ÙˆÙ‡Ù…ÙŠØ© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            productsGrid.innerHTML = Array(4).fill(0).map(() => `
                <div class="product-card p-0">
                    <div class="product-image skeleton h-40"></div>
                    <div class="p-3">
                        <div class="h-3 bg-gray-200 rounded w-3/4 mb-2 skeleton"></div>
                        <div class="h-3 bg-gray-200 rounded w-1/2 skeleton"></div>
                    </div>
                </div>
            `).join('');
        }

        // --- 2. Data Loading Functions ---

        async function loadCategories() {
            try {
                // Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¨Ø³ÙŠØ·
                const q = query(collection(db, "categories"), orderBy("orderIndex", "asc"));
                const snap = await getDocs(q);

                let html = `
                    <a href="classproductindex.html" class="flex flex-col items-center gap-2 min-w-[70px] snap-center cursor-pointer group">
                        <div class="cat-icon bg-indigo-50 border-indigo-100"><i class="fas fa-th-large"></i></div>
                        <span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Ø§Ù„ÙƒÙ„</span>
                    </a>`;

                snap.forEach(doc => {
                    const data = doc.data();
                    html += `
                        <a href="classproductindex.html?category=${doc.id}" class="flex flex-col items-center gap-2 min-w-[70px] snap-center cursor-pointer group">
                            <div class="cat-icon"><i class="fas ${data.icon || 'fa-tag'}"></i></div>
                            <span class="text-[10px] font-bold text-gray-600 dark:text-gray-300 truncate w-16 text-center">${data.name}</span>
                        </a>`;
                });
                categoriesContainer.innerHTML = html;
            } catch (e) {
                console.error("Categories Error:", e);
                categoriesContainer.innerHTML = '<p class="text-xs text-red-400 p-2">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>';
            }
        }

        async function loadHeroSlider() {
            try {
                const q = query(collection(db, "offers"), orderBy("createdAt", "desc"), limit(5));
                const snap = await getDocs(q);

                if (!snap.empty) {
                    heroWrapper.innerHTML = '';
                    snap.forEach(doc => {
                        const o = doc.data();
                        heroWrapper.innerHTML += `
                            <div class="swiper-slide cursor-pointer" onclick="location.href='PRESENTPRODUCT.html?offer=${doc.id}'">
                                <img src="${o.imageUrl || 'https://placehold.co/600x300'}" class="w-full h-full object-cover" alt="${o.title}">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent flex flex-col justify-end p-4 text-white">
                                    <h3 class="font-bold text-lg">${o.title}</h3>
                                    ${o.description ? `<p class="text-xs opacity-90 line-clamp-1">${o.description}</p>` : ''}
                                </div>
                            </div>`;
                    });
                    new Swiper('.main-slider', {
                        pagination: { el: '.swiper-pagination', clickable: true },
                        autoplay: { delay: 4000 },
                        loop: true
                    });
                } else {
                    heroWrapper.innerHTML = '<div class="swiper-slide bg-indigo-600 flex items-center justify-center text-white">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ S22 Market</div>';
                }
            } catch (e) { console.error("Slider Error:", e); }
        }

        async function loadProducts() {
            // Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„: Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø« 20 Ù…Ù†ØªØ¬ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù…ØŒ Ø«Ù… ÙÙ„ØªØ±ØªÙ‡Ø§ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
            // Ù‡Ø°Ø§ ÙŠØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ÙÙ‡Ø±Ø³Ø© (Indexes) ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³
            try {
                // Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹ Ù„Ø§ ÙŠÙØ´Ù„
                const q = query(collection(db, "products"), orderBy("createdAt", "desc"), limit(20));
                const snap = await getDocs(q);

                productsGrid.innerHTML = '';
                let count = 0;

                snap.forEach(doc => {
                    const p = doc.data();
                    // Ø§Ù„ÙÙ„ØªØ±Ø© Ù‡Ù†Ø§ ÙÙŠ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ÙØ§ÙŠØ±Ø¨ÙŠØ³
                    if (p.productType === 'course') return;
                    if (count >= 10) return; // Ø¹Ø±Ø¶ 10 ÙÙ‚Ø·

                    count++;
                    const card = createProductCard(doc.id, p);
                    productsGrid.innerHTML += card;
                });

                if (count === 0) productsGrid.innerHTML = '<div class="col-span-2 text-center text-gray-400 py-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¶Ø§ÙØ© Ø­Ø¯ÙŠØ«Ø§Ù‹</div>';

                // ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù…ÙØ¶Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                updateWishlistUI();

            } catch (e) {
                console.error("Products Error:", e);
                productsGrid.innerHTML = `<div class="col-span-2 text-center text-red-400 py-4 bg-red-50 rounded-lg text-xs">ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³ (Firestore Rules/Indexes)<br>${e.message}</div>`;
            }
        }

        function createProductCard(id, p) {
            const img = (p.imageUrls && p.imageUrls[0]) ? p.imageUrls[0] : (p.imageUrl || 'https://placehold.co/300?text=No+Image');
            const price = Number(p.price || 0).toLocaleString();

            return `
            <div class="product-card group" onclick="location.href='PRESENTPRODUCT.html?product=${id}'">
                <div class="product-image">
                    <img src="${img}" loading="lazy" alt="${p.name}">
                    ${p.productType === 'direct' ? '<span class="absolute top-2 right-2 bg-emerald-500 text-white text-[9px] px-2 py-0.5 rounded shadow">Ù…Ø¨Ø§Ø´Ø±</span>' : ''}
                    <button class="absolute top-2 left-2 w-8 h-8 bg-white/90 backdrop-blur rounded-full flex items-center justify-center text-gray-400 shadow-sm opacity-0 group-hover:opacity-100 transition-all duration-300" 
                        onclick="event.stopPropagation(); toggleWishlist('${id}', this)">
                        <i class="far fa-heart heart-icon" data-id="${id}"></i>
                    </button>
                </div>
                <div class="p-3">
                    <h3 class="text-sm font-bold text-gray-800 dark:text-gray-200 line-clamp-2 h-9 leading-snug mb-1">${p.name}</h3>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-indigo-600 dark:text-indigo-400 font-bold text-sm">${price} Ø¯.Ø¬</span>
                        <button class="w-8 h-8 rounded-full bg-indigo-50 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-300 flex items-center justify-center hover:bg-indigo-600 hover:text-white transition shadow-sm"
                            onclick="event.stopPropagation(); addToCart('${id}', '${p.name}', ${p.price || 0}, '${img}')">
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>`;
        }

        // --- 3. Interaction & Logic ---

        // Wishlist System
        window.toggleWishlist = async (id, btn) => {
            if (!currentUser) return showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');

            const icon = btn.querySelector('i');
            const isLiked = userWishlist.has(id);

            // UI Optimistic Update
            if (isLiked) {
                userWishlist.delete(id);
                icon.className = 'far fa-heart text-gray-400';
            } else {
                userWishlist.add(id);
                icon.className = 'fas fa-heart text-red-500 animate-bounce';
            }

            // Backend Update
            const userRef = doc(db, "users", currentUser.uid);
            try {
                if (isLiked) {
                    await updateDoc(userRef, { wishlist: arrayRemove(id) });
                    showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©');
                } else {
                    await updateDoc(userRef, { wishlist: arrayUnion(id) });
                    showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©', 'success');
                }
            } catch (e) { console.error(e); }
        };

        function updateWishlistUI() {
            document.querySelectorAll('.heart-icon').forEach(icon => {
                const id = icon.dataset.id;
                if (userWishlist.has(id)) {
                    icon.className = 'fas fa-heart text-red-500';
                    icon.parentElement.style.opacity = '1';
                }
            });
        }

        // Cart System (Simple LocalStorage)
        window.addToCart = (id, name, price, img) => {
            let cart = JSON.parse(localStorage.getItem('s22market_cart')) || [];
            const existing = cart.find(item => item.id === id);

            if (existing) {
                existing.quantity++;
            } else {
                cart.push({ id, name, price, image: img, quantity: 1 });
            }

            localStorage.setItem('s22market_cart', JSON.stringify(cart));
            updateCartBadge();
            showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        };

        function updateCartBadge() {
            const cart = JSON.parse(localStorage.getItem('s22market_cart')) || [];
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);

            ['header-cart-badge', 'nav-cart-badge'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = count > 99 ? '99+' : count;
                    if (count > 0) {
                        el.classList.remove('hidden', 'scale-0');
                        el.classList.add('scale-100');
                    } else {
                        el.classList.add('hidden');
                    }
                }
            });
        }

        // --- 4. UI Utilities ---

        function showToast(msg, type = 'normal') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            const colors = type === 'success' ? 'bg-green-600' : (type === 'error' ? 'bg-red-600' : 'bg-gray-800');
            const icon = type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle');

            toast.className = `${colors} text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 text-sm transform transition-all duration-300 translate-y-10 opacity-0`;
            toast.innerHTML = `<i class="fas ${icon}"></i> <span>${msg}</span>`;

            container.appendChild(toast);

            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });

            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Pull to Refresh Logic (Mobile Feel)
        function setupPullToRefresh() {
            let startY = 0;
            const spinner = document.getElementById('ptr-spinner');
            const icon = spinner.querySelector('.spinner-icon');

            window.addEventListener('touchstart', e => {
                if (window.scrollY === 0) startY = e.touches[0].clientY;
            }, { passive: true });

            window.addEventListener('touchmove', e => {
                const y = e.touches[0].clientY;
                const pull = y - startY;
                if (window.scrollY === 0 && pull > 0 && pull < 200) {
                    spinner.style.transform = `translateY(${pull / 2 - 50}px)`;
                    icon.style.transform = `rotate(${pull}deg)`;
                }
            }, { passive: true });

            window.addEventListener('touchend', async () => {
                if (window.scrollY === 0) {
                    const currentTransform = getComputedStyle(spinner).transform;
                    // Check if pulled enough (simple logic)
                    if (currentTransform.includes('matrix') && parseFloat(currentTransform.split(',')[5]) > 10) {
                        spinner.style.transition = '0.3s';
                        spinner.style.transform = 'translateY(20px)';
                        icon.classList.add('loading');

                        await initApp(); // Reload data

                        setTimeout(() => {
                            spinner.style.transform = 'translateY(-50px)';
                            icon.classList.remove('loading');
                            showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
                        }, 500);
                    } else {
                        spinner.style.transform = 'translateY(-50px)';
                    }
                }
                startY = 0;
            });
        }

        // UI Header Scroll Effect
        window.addEventListener('scroll', () => {
            if (window.scrollY > 10) header.classList.add('sticky-header');
            else header.classList.remove('sticky-header');
        });

        // Sidebar Logic
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.getElementById('backdrop');
        const menuBtn = document.getElementById('menu-btn');

        function toggleSidebar() {
            sidebar.classList.toggle('active');
            backdrop.classList.toggle('active');
            document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
        }
        menuBtn.onclick = toggleSidebar;
        backdrop.onclick = toggleSidebar;

        // Dark Mode Logic
        const dmToggle = document.getElementById('dark-mode-toggle');
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

        dmToggle.onclick = () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        };

        // --- 5. Auth Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Update Sidebar
                document.getElementById('sidebar-user-info').innerHTML = `
                    <h3 class="font-bold text-lg">${user.displayName || 'Ù…Ø³ØªØ®Ø¯Ù… S22'}</h3>
                    <button onclick="window.logOut()" class="text-xs text-indigo-200 hover:text-white underline mt-1">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                `;
                window.logOut = () => auth.signOut().then(() => location.reload());

                // Get Wishlist
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    userWishlist = new Set(userDoc.data().wishlist || []);
                    updateWishlistUI();
                }
            } else {
                currentUser = null;
                userWishlist.clear();
            }
        });

        // Init Badge
        updateCartBadge();

        // Start App
        initApp();

    </script>
</body>

</html>