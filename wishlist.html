<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - المفضلة ❤️</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="app-style.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="LOGO.jpg">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f3f4f6;
        }

        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Skeleton */
        .skeleton {
            background: linear-gradient(90deg, #e5e7eb 25%, #d1d5db 50%, #e5e7eb 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body>
    <!-- Navbar (Simplified) -->
    <nav class="bg-indigo-600 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2 text-2xl font-bold">
                <i class="fas fa-arrow-right text-lg"></i>
                <h1>المفضلة</h1>
            </a>
            <div id="user-info" class="hidden flex items-center gap-2">
                <span id="user-name" class="text-sm font-medium"></span>
                <i class="fas fa-user-circle text-xl"></i>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto p-4 md:p-6 min-h-screen pb-24">
        <div id="auth-warning" class="hidden text-center py-20">
            <i class="fas fa-lock text-6xl text-gray-300 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-700">يرجى تسجيل الدخول</h2>
            <p class="text-gray-500 mb-6">يجب عليك تسجيل الدخول لعرض قائمة المفضلة.</p>
            <button onclick="window.location.href='login.html'"
                class="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-indigo-700">تسجيل
                الدخول</button>
        </div>

        <div id="loader" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <!-- Skeletons -->
            <div class="bg-white rounded-xl p-4 shadow-sm h-64 skeleton"></div>
            <div class="bg-white rounded-xl p-4 shadow-sm h-64 skeleton"></div>
            <div class="bg-white rounded-xl p-4 shadow-sm h-64 skeleton"></div>
            <div class="bg-white rounded-xl p-4 shadow-sm h-64 skeleton"></div>
        </div>

        <div id="empty-wishlist" class="hidden text-center py-20 fade-in-up">
            <i class="far fa-heart text-6xl text-gray-300 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-700">قائمة المفضلة فارغة</h2>
            <p class="text-gray-500 mb-6">اضغط على رمز القلب ❤️ بجانب المنتجات لإضافتها هنا.</p>
            <a href="classproductindex.html"
                class="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-indigo-700">تصفح
                المنتجات</a>
        </div>

        <div id="wishlist-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 hidden"></div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>الرئيسية</span>
        </a>
        <a href="s22marketfood.html" class="nav-item">
            <i class="fas fa-utensils"></i>
            <span>طعام</span>
        </a>
        <a href="cart.html" class="nav-item">
            <div class="relative">
                <i class="fas fa-shopping-basket"></i>
                <span id="cart-badge"
                    class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 text-xs flex items-center justify-center hidden">0</span>
            </div>
            <span>السلة</span>
        </a>
        <a href="profile.html" class="nav-item active">
            <i class="fas fa-user mb-1 text-lg"></i>
            <span>حسابي</span>
        </a>
    </nav>

    <script type="module">
        import { auth, db } from './app-core.js';
        import { doc, getDoc, updateDoc, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const grid = document.getElementById('wishlist-grid');
        const loader = document.getElementById('loader');
        const emptyState = document.getElementById('empty-wishlist');
        const authWarning = document.getElementById('auth-warning');

        // Hide warning by default (we support guests now)
        if (authWarning) authWarning.classList.add('hidden');

        let currentUser = null;

        // Initialize: Check Auth state but load LS immediately if needed
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                if (document.getElementById('user-info')) document.getElementById('user-info').classList.remove('hidden');
                if (document.getElementById('user-name')) document.getElementById('user-name').textContent = user.displayName || 'مستخدم';
                // Potentially sync LS to Firestore here if we wanted to be fancy, 
                // but for now just load User's Firestore wishlist
                loadWishlist(true);
            } else {
                // Guest Mode
                loadWishlist(false);
            }
        });

        async function loadWishlist(isAuth) {
            let wishlistIds = [];

            try {
                if (isAuth && currentUser) {
                    const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                    wishlistIds = userDoc.exists() ? (userDoc.data().wishlist || []) : [];
                } else {
                    // LocalStorage
                    const local = localStorage.getItem('s22_wishlist');
                    wishlistIds = local ? JSON.parse(local) : [];
                }

                if (wishlistIds.length === 0) {
                    loader.classList.add('hidden');
                    grid.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    return;
                }

                // Hide empty state if we have items
                emptyState.classList.add('hidden');

                // Fetch Products
                // Note: For guests, IDs are in LS. For users, in Firestore.
                // We fetch product details from Firestore in both cases.
                const productPromises = wishlistIds.map(id => getDoc(doc(db, 'products', id)));
                const snapshots = await Promise.all(productPromises);

                const products = snapshots.map(snap => snap.exists() ? { id: snap.id, ...snap.data() } : null).filter(p => p !== null);

                // If some products were deleted from DB but existed in wishlist, we might want to clean them up?
                // skipping for now.

                if (products.length === 0) {
                    // IDs existed but products don't (deleted products)
                    loader.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    return;
                }

                renderGrid(products);
                loader.classList.add('hidden');
                grid.classList.remove('hidden');

            } catch (error) {
                console.error("Error loading wishlist:", error);
                loader.classList.add('hidden');
            }
        }

        function renderGrid(products) {
            grid.innerHTML = '';
            products.forEach((product, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-md overflow-hidden relative fade-in-up flex flex-col group';
                card.style.animationDelay = `${index * 0.05}s`;

                const price = product.discount > 0
                    ? `<span class="text-green-600 font-bold text-lg">${(product.price * (1 - product.discount / 100)).toFixed(2)} د.ج</span> <span class="text-gray-400 line-through text-sm">${product.price}</span>`
                    : `<span class="text-indigo-600 font-bold text-lg">${product.price} د.ج</span>`;

                card.innerHTML = `
                    <div class="relative h-48 bg-gray-100 overflow-hidden">
                        <img src="${product.imageUrl || 'https://via.placeholder.com/150'}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" alt="${product.name}">
                        <button class="absolute top-2 left-2 bg-white/90 p-2 rounded-full text-red-500 shadow-sm hover:bg-red-50 transition-colors remove-btn" data-id="${product.id}" title="حذف من المفضلة">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="p-4 flex flex-col flex-1">
                        <h3 class="font-bold text-gray-800 mb-1 truncate text-right">${product.name}</h3>
                        <div class="mt-auto flex justify-between items-center dir-rtl">
                             <!-- Price is already formatted -->
                             <div class="flex items-center gap-2">${price}</div>
                        </div>
                        <a href="PRESENTPRODUCT.html?id=${product.id}&product=${product.id}" class="mt-3 block text-center bg-indigo-50 text-indigo-700 py-2 rounded-lg hover:bg-indigo-600 hover:text-white transition-all text-sm font-bold">عرض التفاصيل</a>
                    </div>
                `;
                grid.appendChild(card);
            });

            // Attach Remove Listeners
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => removeFromWishlist(e.currentTarget.dataset.id));
            });
        }

        async function removeFromWishlist(id) {
            if (!confirm('حذف من المفضلة؟')) return;

            // Optimistic UI Update (Optional, but let's just reload for simplicity and consistency)
            try {
                if (currentUser) {
                    await updateDoc(doc(db, 'users', currentUser.uid), {
                        wishlist: arrayRemove(id)
                    });
                } else {
                    const local = JSON.parse(localStorage.getItem('s22_wishlist') || '[]');
                    const newLocal = local.filter(item => item !== id);
                    localStorage.setItem('s22_wishlist', JSON.stringify(newLocal));
                }
                // Reload
                const isAuth = !!currentUser;
                loadWishlist(isAuth);
            } catch (e) { console.error(e); }
        }

        // PWA Reg
        // Service Worker removed
    </script>
</body>

</html>