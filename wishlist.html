<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - المفضلة ❤️</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="LOGO.jpg">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f3f4f6;
        }

        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Skeleton */
        .skeleton {
            background: linear-gradient(90deg, #e5e7eb 25%, #d1d5db 50%, #e5e7eb 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body>
    <!-- Navbar (Simplified) -->
    <nav class="bg-indigo-600 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2 text-2xl font-bold">
                <i class="fas fa-arrow-right text-lg"></i>
                <h1>المفضلة</h1>
            </a>
            <div id="user-info" class="hidden flex items-center gap-2">
                <span id="user-name" class="text-sm font-medium"></span>
                <i class="fas fa-user-circle text-xl"></i>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto p-4 md:p-6 min-h-screen pb-24">
        <div id="auth-warning" class="hidden text-center py-20">
            <i class="fas fa-lock text-6xl text-gray-300 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-700">يرجى تسجيل الدخول</h2>
            <p class="text-gray-500 mb-6">يجب عليك تسجيل الدخول لعرض قائمة المفضلة.</p>
            <a href="login.html"
                class="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-indigo-700">تسجيل
                الدخول</a>
        </div>

        <div id="loader" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <!-- Skeletons -->
            <div class="bg-white rounded-xl p-4 shadow-sm h-64 skeleton"></div>
            <div class="bg-white rounded-xl p-4 shadow-sm h-64 skeleton"></div>
            <div class="bg-white rounded-xl p-4 shadow-sm h-64 skeleton"></div>
            <div class="bg-white rounded-xl p-4 shadow-sm h-64 skeleton"></div>
        </div>

        <div id="empty-wishlist" class="hidden text-center py-20 fade-in-up">
            <i class="far fa-heart text-6xl text-gray-300 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-700">قائمة المفضلة فارغة</h2>
            <p class="text-gray-500 mb-6">اضغط على رمز القلب ❤️ بجانب المنتجات لإضافتها هنا.</p>
            <a href="classproductindex.html"
                class="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-indigo-700">تصفح
                المنتجات</a>
        </div>

        <div id="wishlist-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 hidden"></div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Config (Same as others)
        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const grid = document.getElementById('wishlist-grid');
        const loader = document.getElementById('loader');
        const emptyState = document.getElementById('empty-wishlist');
        const authWarning = document.getElementById('auth-warning');

        let currentUser = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('user-name').textContent = user.displayName || 'مستخدم';
                loadWishlist();
            } else {
                loader.classList.add('hidden');
                authWarning.classList.remove('hidden');
            }
        });

        async function loadWishlist() {
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                const wishlist = userDoc.exists() ? (userDoc.data().wishlist || []) : [];

                if (wishlist.length === 0) {
                    loader.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    return;
                }

                // Fetch all products in parallel
                // Note: In production with many items, fetch in batches or use 'in' query if robust.
                // For now, parallel getDoc is fine for reasonable wishlist size.
                const productPromises = wishlist.map(id => getDoc(doc(db, 'products', id)));
                const snapshots = await Promise.all(productPromises);

                const products = snapshots.map(snap => snap.exists() ? { id: snap.id, ...snap.data() } : null).filter(p => p !== null);

                renderGrid(products);
                loader.classList.add('hidden');
                grid.classList.remove('hidden');

            } catch (error) {
                console.error("Error loading wishlist:", error);
                loader.classList.add('hidden');
                // Could show error state
            }
        }

        function renderGrid(products) {
            grid.innerHTML = '';
            products.forEach((product, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-md overflow-hidden relative fade-in-up flex flex-col';
                card.style.animationDelay = `${index * 0.05}s`;

                const price = product.discount > 0
                    ? `<span class="text-green-600 font-bold text-lg">${(product.price * (1 - product.discount / 100)).toFixed(2)} د.ج</span> <span class="text-gray-400 line-through text-sm">${product.price}</span>`
                    : `<span class="text-indigo-600 font-bold text-lg">${product.price} د.ج</span>`;

                card.innerHTML = `
                    <div class="relative h-48 bg-gray-100">
                        <img src="${product.imageUrl || 'https://via.placeholder.com/150'}" class="w-full h-full object-cover" alt="${product.name}">
                        <button class="absolute top-2 left-2 bg-white/90 p-2 rounded-full text-red-500 shadow-sm hover:scale-110 transition-transform remove-btn" data-id="${product.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="p-4 flex flex-col flex-1">
                        <h3 class="font-bold text-gray-800 mb-1 truncate">${product.name}</h3>
                        <div class="mt-auto flex justify-between items-center">
                            ${price}
                        </div>
                        <a href="PRESENTPRODUCT.html?id=${product.id}" class="mt-3 block text-center bg-gray-100 text-gray-700 py-2 rounded-lg hover:bg-gray-200 text-sm font-semibold">عرض التفاصيل</a>
                    </div>
                `;
                grid.appendChild(card);
            });

            // Attach Remove Listeners
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => removeFromWishlist(e.currentTarget.dataset.id));
            });
        }

        async function removeFromWishlist(id) {
            if (!confirm('حذف من المفضلة؟')) return;
            try {
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    wishlist: arrayRemove(id)
                });
                // Reload or remove element DOM
                loadWishlist();
            } catch (e) { console.error(e); }
        }

        // PWA Reg
        // Service Worker removed
    </script>
</body>

</html>