<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Dawarat - Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª (Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f1f5f9; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #4f46e5; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        .small-loader { border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; translateY(0); } }
        
        #user-menu-dropdown.show {
            display: block;
            animation: slideInUp 0.2s ease-out;
        }
        
        /* (Ø¬Ø¯ÙŠØ¯) Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 40; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .modal-backdrop.active { opacity: 1; pointer-events: all; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 500px; z-index: 50; transform: scale(0.95); opacity: 0; transition: all 0.3s ease; }
        .modal-backdrop.active .modal-content { transform: scale(1); opacity: 1; }

        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 10001; }
        .toast { background-color: #2d3748; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: 10px; display: flex; align-items: center; gap: 10px; animation: slideInUp 0.3s ease, fadeOut 0.5s ease 2.5s forwards; }
        .toast.error { background-color: #c53030; }
        @keyframes fadeOut { from { opacity: 1; } to: { opacity: 0; } }

    </style>
</head>
<body>

    <header class="bg-white shadow-sm sticky top-0 z-30">
        <div class="max-w-7xl mx-auto py-3 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
             <a href="index.html" class="flex items-center gap-3">
                <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800">
                    S22<span class="text-blue-600">MARKET</span>
                </h1>
            </a>
            <div id="header-actions" class="flex items-center gap-4 relative">
                <a href="index.html" id="store-btn" class="relative text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 px-5 py-2.5 rounded-full transition-colors flex items-center gap-2 shadow-lg">
                    <i class="fas fa-store"></i>
                    <span>Ø§Ù„Ù…ØªØ¬Ø±</span>
                </a>
                <a href="login.html" id="login-btn" class="hidden relative text-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 px-5 py-2.5 rounded-full transition-colors items-center gap-2 sm:flex">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</span>
                </a>
                <div id="user-menu" class="hidden">
                    <button id="user-menu-button" class="flex items-center gap-2 text-lg font-semibold text-gray-700 bg-green-100 hover:bg-green-200 px-5 py-2.5 rounded-full transition-colors">
                        <i class="fas fa-user-check text-green-700"></i>
                        <span id="user-menu-name">...</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div id="user-menu-dropdown" class="hidden absolute left-0 top-full mt-2 w-60 bg-white rounded-xl shadow-lg border z-50 overflow-hidden">
                        <div class="p-3 border-b">
                            <p class="text-sm text-gray-500">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ</p>
                            <p class="font-bold text-gray-800" id="user-menu-displayname">...</p>
                        </div>
                        <a href="profile.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i class="fas fa-user-circle fa-fw ml-2 text-gray-400"></i> Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ ÙˆÙ…Ø­Ø§ÙØ·ÙŠ</a>
                        
                        <div class="px-4 pt-3 pb-1 text-xs font-semibold text-gray-400 uppercase">Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©</div>
                        <a href="dawarat_learning_dashboard.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i class="fas fa-graduation-cap fa-fw ml-2 text-indigo-400"></i> Ø¨Ø°Ù„ÙˆØ±Ø§ØªÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</a>
                        <a href="dawarat_loyalty_tasks.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i class="fas fa-tasks fa-fw ml-2 text-purple-400"></i> ÙƒØ³Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Øª (Ø§Ù„Ù…Ù‡Ø§Ù…)</a>
                        <a href="dawarat_loyalty_rewards.html" class="block px-4 py-3 text-gray-700 bg-gray-100 font-bold transition-colors"><i class="fas fa-gift fa-fw ml-2 text-yellow-400"></i> Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª</a>

                        <div class="px-4 pt-3 pb-1 text-xs font-semibold text-gray-400 uppercase">Ø§Ù„Ù…ØªØ¬Ø±</div>
                        <a href="seller-dashboard.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i class="fas fa-store fa-fw ml-2 text-blue-400"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¨Ø§Ø¦Ø¹</a>
                        <a href="order_history.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i class="fas fa-archive fa-fw ml-2 text-gray-400"></i> Ø£Ø±Ø´ÙŠÙ Ø·Ù„Ø¨Ø§ØªÙŠ</a>
                        <a href="loyalty_card.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i class="fas fa-star fa-fw ml-2 text-orange-400"></i> Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆÙØ§Ø¡ (Ø§Ù„Ø¬ÙˆØ§Ù‡Ø±)</a>

                        <button id="logout-btn" class="w-full text-right px-4 py-3 text-red-600 hover:bg-red-50 border-t transition-colors"><i class="fas fa-sign-out-alt fa-fw ml-2"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
        
        <div id="auth-loader" class="text-center py-20">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600 text-lg">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª Ø§Ù„Ù…ØªØ§Ø­Ø©...</p>
        </div>

        <div id="rewards-content" class="hidden" style="animation: slideInUp 0.5s ease-out;">
            <div class="text-center mb-8">
                <i class="fas fa-gift text-5xl text-yellow-500 mb-3"></i>
                <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900">Ù…ØªØ¬Ø± Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª (Ø¨Ø§Ù„Ø¹Ù…Ù„Ø§Øª ğŸª™)</h1>
                <p class="mt-3 text-lg text-gray-600">Ø§Ø³ØªØ®Ø¯Ù… "Ø§Ù„Ø¹Ù…Ù„Ø§Øª" Ø§Ù„ØªÙŠ ÙƒØ³Ø¨ØªÙ‡Ø§ Ù…Ù† Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¨Ø°Ù„ÙˆØ±Ø§Øª Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª Ø§Ù„Ù‚ÙŠÙ…Ø©.</p>
            </div>

            <div class="mb-8 p-6 bg-white rounded-xl shadow-md flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-700">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Øª</h2>
                <div id="user-coins-balance" class="text-4xl font-extrabold text-green-600">
                    <span class="animate-pulse">...</span> ğŸª™
                </div>
            </div>

            <div id="rewards-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>

            <div id="no-rewards-msg" class="hidden text-center py-20 bg-white rounded-xl shadow-md">
                <i class="fas fa-box-open text-5xl text-gray-400"></i>
                <p class="mt-4 text-xl font-semibold text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙƒØ§ÙØ¢Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø­Ø§Ù„ÙŠÙ‹Ø§.</p>
            </div>
        </div>
    </main>
    
    <div id="claim-reward-modal" class="modal-backdrop">
        <div class="modal-content">
             <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-xl font-bold">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„</h3>
                <button id="close-claim-modal-btn" class="text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            
            <p id="claim-confirm-text" class="text-lg text-gray-700 text-center my-6">
                Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„...ØŸ
            </p>

            <div class="flex justify-end gap-4 mt-6 border-t pt-4">
                <button id="cancel-claim-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
                    Ø¥Ù„ØºØ§Ø¡
                </button>
                <button id="confirm-claim-btn" class="w-40 flex justify-center items-center gap-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg disabled:bg-green-400">
                    <span class="button-text">Ù†Ø¹Ù…ØŒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„</span>
                    <div class="small-loader button-loader hidden"></div>
                </button>
            </div>
        </div>
    </div>
    
    <div id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, addDoc, query, where, serverTimestamp, orderBy, increment, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ... (Ù†ÙØ³ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase) ...
        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
        const authLoader = document.getElementById('auth-loader');
        const rewardsContent = document.getElementById('rewards-content');
        const rewardsGrid = document.getElementById('rewards-grid');
        const noRewardsMsg = document.getElementById('no-rewards-msg');
        const userCoinsBalance = document.getElementById('user-coins-balance');

        // --- Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‡ÙŠØ¯Ø± ---
        const loginBtn = document.getElementById('login-btn');
        const userMenu = document.getElementById('user-menu');
        const userMenuButton = document.getElementById('user-menu-button');
        const userMenuDropdown = document.getElementById('user-menu-dropdown');
        const logoutBtn = document.getElementById('logout-btn');
        
        // --- (Ø¬Ø¯ÙŠØ¯) Ø¹Ù†Ø§ØµØ± Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ ---
        const claimModal = document.getElementById('claim-reward-modal');
        const closeClaimModalBtn = document.getElementById('close-claim-modal-btn');
        const cancelClaimBtn = document.getElementById('cancel-claim-btn');
        const confirmClaimBtn = document.getElementById('confirm-claim-btn');
        const claimConfirmText = document.getElementById('claim-confirm-text');
        
        // --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ---
        let currentUser = null;
        let currentUserData = {};
        let currentClaimData = {}; // (Ø¬Ø¯ÙŠØ¯) Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©
        
        // --- (Ø¬Ø¯ÙŠØ¯) Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ---
        const DAW_SETTINGS_DOC_ID = "dawarat_loyalty_config";
        const REWARDS_COLLECTION_ID = "dawarat_rewards";

        // --- (Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©: showToast, toggleButtonState, ... ) ---
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'error' : ''}`;
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
            toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        };
        function toggleButtonState(button, isLoading) {
            const text = button.querySelector('.button-text');
            const loader = button.querySelector('.button-loader');
            if (isLoading) {
                button.disabled = true;
                if (text) text.classList.add('hidden');
                if (loader) loader.classList.remove('hidden');
            } else {
                button.disabled = false;
                if (text) text.classList.remove('hidden');
                if (loader) loader.classList.add('hidden');
            }
        }
        
        // --- (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª ---
        async function loadRewards(user) {
            try {
                // 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„Ø±ØµÙŠØ¯)
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    currentUserData = userDocSnap.data();
                    userCoinsBalance.textContent = `${(currentUserData.dawarat_coins || 0).toLocaleString()} ğŸª™`;
                }

                // 2. Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
                const rewardsQuery = collection(db, "settings", DAW_SETTINGS_DOC_ID, REWARDS_COLLECTION_ID);
                const rewardsSnapshot = await getDocs(query(rewardsQuery, orderBy("points")));

                rewardsGrid.innerHTML = '';
                if (rewardsSnapshot.empty) {
                    noRewardsMsg.classList.remove('hidden');
                } else {
                    rewardsSnapshot.forEach(doc => {
                        const reward = { id: doc.id, ...doc.data() };
                        rewardsGrid.appendChild(createRewardCard(reward));
                    });
                }
                
            } catch (error) {
                console.error("Error loading rewards: ", error);
                rewardsGrid.innerHTML = '<p class="text-red-500 col-span-full text-center">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª.</p>';
            }
        }
        
        // --- (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ±Øª Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© ---
        function createRewardCard(reward) {
            const card = document.createElement('div');
            card.className = 'bg-white p-5 rounded-lg shadow-md flex flex-col items-center text-center';
            
            const userBalance = currentUserData.dawarat_coins || 0;
            const canAfford = userBalance >= reward.points;

            card.innerHTML = `
                <div class="text-5xl text-yellow-500 mb-3">
                    <i class="fas fa-gift"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900">${reward.title}</h3>
                <p class="text-3xl font-extrabold text-green-600 my-3">
                    ${reward.points.toLocaleString()} ğŸª™
                </p>
                <button class="claim-reward-btn w-full mt-auto bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                        ${!canAfford ? 'disabled' : ''}
                        data-reward-id="${reward.id}"
                        data-reward-title="${reward.title}"
                        data-reward-points="${reward.points}">
                    ${canAfford ? 'Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¢Ù†' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙ'}
                </button>
            `;
            return card;
        }

        // --- (Ø¬Ø¯ÙŠØ¯) Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ---
        rewardsGrid.addEventListener('click', (e) => {
            const claimBtn = e.target.closest('.claim-reward-btn');
            if (claimBtn) {
                const { rewardId, rewardTitle, rewardPoints } = claimBtn.dataset;
                
                currentClaimData = {
                    id: rewardId,
                    title: rewardTitle,
                    points: parseInt(rewardPoints, 10)
                };

                claimConfirmText.innerHTML = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ 
                    <strong class="text-green-600">${currentClaimData.points} Ø¹Ù…Ù„Ø© ğŸª™</strong>
                    Ù…Ù‚Ø§Ø¨Ù„ 
                    <strong class="text-indigo-600">${currentClaimData.title}</strong>ØŸ`;
                
                claimModal.classList.add('active');
            }
        });

        closeClaimModalBtn.onclick = () => claimModal.classList.remove('active');
        cancelClaimBtn.onclick = () => claimModal.classList.remove('active');
        
        // --- (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ (Ø§Ù„Ø£Ù‡Ù…) ---
        confirmClaimBtn.addEventListener('click', async () => {
            toggleButtonState(confirmClaimBtn, true);

            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                
                // 1. Ø§Ø³ØªØ®Ø¯Ø§Ù… Transaction Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø£Ù…Ø§Ù†
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userDocRef);
                    if (!userDoc.exists()) { throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…."); }
                    
                    const data = userDoc.data();
                    const currentCoins = data.dawarat_coins || 0;

                    if (currentCoins < currentClaimData.points) {
                        throw new Error("Ø±ØµÙŠØ¯Ùƒ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.");
                    }
                    
                    // 2. Ø®ØµÙ… Ø§Ù„Ø¹Ù…Ù„Ø§Øª
                    const newCoins = currentCoins - currentClaimData.points;
                    transaction.update(userDocRef, { dawarat_coins: newCoins });

                    // 3. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª
                    const logRef = doc(collection(db, `users/${currentUser.uid}/dawarat_coin_changes`));
                    transaction.set(logRef, {
                        type: 'reward_spent',
                        pointsSubtracted: currentClaimData.points, // (Ø¬Ø¯ÙŠØ¯) Ù†Ù‚Ø§Ø· Ù…Ø®ØµÙˆÙ…Ø©
                        reason: `Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…ÙƒØ§ÙØ£Ø©: ${currentClaimData.title}`,
                        timestamp: serverTimestamp()
                    });
                });

                // 4. (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±
                const notifRef = doc(collection(db, `users/${currentUser.uid}/notifications`));
                await addDoc(collection(db, `users/${currentUser.uid}/notifications`), {
                    title: "ğŸ ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©!",
                    body: `Ù„Ù‚Ø¯ Ù†Ø¬Ø­Øª ÙÙŠ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ${currentClaimData.points} Ø¹Ù…Ù„Ø© ğŸª™ Ù…Ù‚Ø§Ø¨Ù„ "${currentClaimData.title}".`,
                    isRead: false,
                    timestamp: serverTimestamp(),
                    type: "reward_claimed"
                });

                // 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                const newBalance = (currentUserData.dawarat_coins || 0) - currentClaimData.points;
                currentUserData.dawarat_coins = newBalance;
                userCoinsBalance.textContent = `${newBalance.toLocaleString()} ğŸª™`;
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒØ±ÙˆØª Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± (ØªØ¹Ø·ÙŠÙ„ Ù…Ø§ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø´Ø±Ø§Ø¤Ù‡)
                await loadRewards(currentUser); 
                
                claimModal.classList.remove('active');
                showToast('ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');

            } catch (error) {
                console.error("Error claiming reward: ", error);
                showToast(error.message || 'ÙØ´Ù„ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©.', 'error');
            } finally {
                toggleButtonState(confirmClaimBtn, false);
            }
        });

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ØµÙØ­Ø© ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loginBtn.classList.add('hidden');
                userMenu.classList.remove('hidden');
                
                const displayName = user.displayName || "Ø¹Ù…ÙŠÙ„Ù†Ø§";
                const userMenuName = document.getElementById('user-menu-name');
                const userMenuDisplayName = document.getElementById('user-menu-displayname');
                
                if (userMenuName) userMenuName.textContent = displayName.split(' ')[0];
                if (userMenuDisplayName) userMenuDisplayName.textContent = displayName;

                // Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙØ­Ø©
                authLoader.classList.add('hidden');
                rewardsContent.classList.remove('hidden');
                loadRewards(user); 

            } else {
                window.location.href = 'login.html'; 
            }
        });

        // --- Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ (Ù„Ù€ S22 Market) ---
        const userMenuButton = document.getElementById('user-menu-button');
        const userMenuDropdown = document.getElementById('user-menu-dropdown');
        
        if (userMenuButton) {
            userMenuButton.addEventListener('click', (e) => {
                e.stopPropagation();
                userMenuDropdown.classList.toggle('show');
            });
        }
        document.addEventListener('click', () => {
            if (userMenuDropdown && userMenuDropdown.classList.contains('show')) {
                userMenuDropdown.classList.remove('show');
            }
        });
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                signOut(auth).catch((error) => console.error('Logout Error', error));
            });
        }
    </script>
</body>
</html>