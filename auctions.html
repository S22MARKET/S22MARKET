<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S22 Market - المزادات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
        }
    </style>
</head>

<body class="pb-20">

    <header class="bg-white shadow-sm sticky top-0 z-50 px-4 py-3 flex items-center justify-between">
        <a href="index.html" class="text-gray-600 text-xl"><i class="fas fa-home"></i></a>
        <h1 class="text-lg font-bold text-gray-800">المزادات الحالية <i class="fas fa-gavel text-primary-600"></i></h1>
        <div class="w-8"></div>
    </header>

    <main class="max-w-3xl mx-auto p-4 space-y-4" id="auctions-container">
        <div class="text-center py-10">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mx-auto"></div>
        </div>
    </main>

    <script type="module">
        import { db, collection, query, where, getDocs, orderBy } from './js/firebase-config.js';

        async function loadAuctions() {
            const container = document.getElementById('auctions-container');
            try {
                // Query active auctions
                const q = query(
                    collection(db, "auctions"),
                    where("status", "==", "active"),
                    orderBy("endTime", "asc")
                );

                const snapshot = await getDocs(q);
                container.innerHTML = '';

                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center py-20 text-gray-500">
                            <i class="fas fa-gavel text-4xl mb-3 text-gray-300"></i>
                            <p>لا توجد مزادات نشطة حالياً.</p>
                        </div>`;
                    return;
                }

                snapshot.forEach(doc => {
                    const auction = doc.data();
                    const now = new Date();
                    const endTime = auction.endTime?.toDate ? auction.endTime.toDate() : new Date(auction.endTime);
                    const remainingTime = endTime - now;

                    if (remainingTime <= 0) return; // Skip expired ones that might still be marked active

                    const card = document.createElement('div');
                    card.className = "bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden";
                    card.innerHTML = `
                        <div class="relative h-48 bg-gray-200 bg-cover bg-center" style="background-image: url('${auction.imageUrl || 'https://placehold.co/600x300'}')">
                            <div class="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded">مباشر</div>
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold text-lg text-gray-800 mb-1">${auction.title}</h3>
                            <p class="text-gray-500 text-sm mb-4 line-clamp-2">${auction.description || ''}</p>
                            
                            <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg mb-4">
                                <div>
                                    <span class="text-xs text-gray-500 block">السعر الحالي</span>
                                    <span class="text-xl font-bold text-indigo-600">${(auction.currentPrice || auction.startPrice || 0).toLocaleString()} د.ج</span>
                                </div>
                                <div class="text-left">
                                    <span class="text-xs text-gray-500 block">ينتهي في</span>
                                    <span class="text-sm font-bold text-red-500 countdown" data-end="${endTime.toISOString()}">جاري الحساب...</span>
                                </div>
                            </div>

                            <a href="auction-details.html?id=${doc.id}" class="block w-full text-center bg-indigo-600 text-white font-bold py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                                شارك في المزاد
                            </a>
                        </div>
                    `;
                    container.appendChild(card);
                });

                startCountdown();

            } catch (error) {
                console.error("Error loading auctions:", error);
                container.innerHTML = '<p class="text-center text-red-500 py-10">حدث خطأ أثناء تحميل المزادات.</p>';
            }
        }

        function startCountdown() {
            setInterval(() => {
                document.querySelectorAll('.countdown').forEach(el => {
                    const end = new Date(el.dataset.end);
                    const now = new Date();
                    const diff = end - now;

                    if (diff <= 0) {
                        el.textContent = "انتهى المزاد";
                        el.className = "text-sm font-bold text-gray-400";
                    } else {
                        const h = Math.floor(diff / (1000 * 60 * 60));
                        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const s = Math.floor((diff % (1000 * 60)) / 1000);
                        el.textContent = `${h}س ${m}د ${s}ث`;
                    }
                });
            }, 1000);
        }

        loadAuctions();
    </script>
</body>

</html>