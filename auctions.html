<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S22 Auctions - Ù…Ø²Ø§Ø¯Ø§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
        }

        .auction-card {
            transition: all 0.3s ease;
        }

        .auction-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ef4444;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .countdown-badge {
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>

<body class="pb-20">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2 text-gray-600 hover:text-red-600">
                <i class="fas fa-arrow-right"></i> <span class="hidden sm:inline">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±</span>
            </a>
            <h1 class="text-2xl font-extrabold text-gray-800 flex items-center gap-2">
                <i class="fas fa-gavel text-red-600"></i>
                S22<span class="text-red-600">AUCTIONS</span>
            </h1>
            <div class="w-20 flex justify-end">
                <div id="user-status"
                    class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">

        <!-- Welcome Section -->
        <div
            class="bg-gradient-to-r from-red-600 to-red-800 rounded-2xl p-6 md:p-10 mb-10 text-white shadow-lg relative overflow-hidden">
            <div class="relative z-10">
                <h2 class="text-3xl md:text-5xl font-bold mb-4">Ø²Ø§ÙŠØ¯ ÙˆØ§Ø±Ø¨Ø­! ğŸ†</h2>
                <p class="text-lg md:text-xl opacity-90 mb-6">Ø§ØºØªÙ†Ù… Ø§Ù„ÙØ±ØµØ© ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬Ø§Øª Ø­ØµØ±ÙŠØ© Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±.</p>
                <div
                    class="inline-flex bg-white text-red-600 px-4 py-2 rounded-full font-bold shadow-md items-center gap-2">
                    <i class="fas fa-fire"></i> Ù…Ø²Ø§Ø¯Ø§Øª Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù†
                </div>
            </div>
            <!-- Decorative Pattern -->
            <i class="fas fa-gavel absolute -bottom-4 -left-4 text-9xl text-red-900 opacity-30 transform rotate-12"></i>
            <i
                class="fas fa-stopwatch absolute top-4 -right-4 text-8xl text-red-900 opacity-30 transform -rotate-12"></i>
        </div>

        <!-- Filters -->
        <div class="flex gap-4 overflow-x-auto pb-4 mb-6 scrollbar-hide">
            <button
                class="bg-gray-800 text-white px-6 py-2 rounded-full font-bold whitespace-nowrap shadow-md">Ø§Ù„ÙƒÙ„</button>
            <button
                class="bg-white text-gray-600 px-6 py-2 rounded-full font-semibold whitespace-nowrap border hover:bg-gray-50">Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª
                ğŸ“±</button>
            <button
                class="bg-white text-gray-600 px-6 py-2 rounded-full font-semibold whitespace-nowrap border hover:bg-gray-50">ØªØ­Ù
                ğŸº</button>
            <button
                class="bg-white text-gray-600 px-6 py-2 rounded-full font-semibold whitespace-nowrap border hover:bg-gray-50">Ø³ÙŠØ§Ø±Ø§Øª
                ğŸš—</button>
        </div>

        <!-- Auctions Grid -->
        <h3 class="text-2xl font-bold text-gray-800 mb-6 border-r-4 border-red-500 pr-3">Ø§Ù„Ù…Ø²Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ©</h3>

        <div id="loading-indicator" class="text-center py-20">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ø¯Ø§Øª...</p>
        </div>

        <div id="auctions-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
            <!-- Cards will be injected here -->
        </div>

        <div id="no-auctions-msg" class="hidden text-center py-20 bg-white rounded-xl shadow-sm">
            <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-bold text-gray-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø²Ø§Ø¯Ø§Øª Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
            <p class="text-gray-500">ØªØ±Ù‚Ø¨ÙˆØ§ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù‚Ø±ÙŠØ¨Ø§Ù‹!</p>
        </div>

    </main>

    <!-- Mobile Enhancements -->
    <script>
        /**
         * Mobile Enhancements Script
         * Handles back button for overlays, pull-to-refresh, and page transitions.
         */

        class MobileEnhancements {
            constructor() {
                this.overlayStack = []; // Stack to track open overlays (sidebar, modals)
                this.touchStartY = 0;
                this.refreshThreshold = 150; // Pull distance to trigger refresh
                this.isPulling = false;
                this.spinner = null;

                this.init();
            }

            init() {
                this.setupBackButton();
                this.setupPullToRefresh();
                this.setupPageTransitions();
                this.setupAutoHidingNavbar();
                this.setupPWAInstall();
                this.injectStyles();
            }

            // --- Back Button Logic ---

            setupBackButton() {
                // Push initial state to handle the first back press
                window.history.replaceState({ overlay: null }, document.title, window.location.href);

                window.addEventListener('popstate', (event) => {
                    if (this.overlayStack.length > 0) {
                        // If overlays are open, close the top one
                        const topOverlay = this.overlayStack.pop();
                        if (topOverlay && typeof topOverlay.close === 'function') {
                            topOverlay.close();
                            // Prevent default back navigation by pushing state again ONLY if we closed something
                            // However, popstate already happened, effectively "going back".
                            // If we want to stay on page, we need to push state again.
                            // But standard pattern:
                            // Open Overlay -> Push State
                            // Back Press -> Pop State -> Close Overlay

                            // So we don't need to push state here. The "Back" action removed the state we added when opening.
                        }
                    } else {
                        // Normal back navigation matches browser behavior
                    }
                });
            }

            /**
             * Call this when opening an overlay (Sidebar, Modal)
             * @param {Function} closeCallback - Function to actually close the UI element
             * @param {string} name - Name for debugging
             */
            pushOverlay(closeCallback, name = 'overlay') {
                this.overlayStack.push({ close: closeCallback, name });
                window.history.pushState({ overlay: name }, document.title, window.location.href);
            }

            /**
             * Call this when closing an overlay Programmatically (e.g. clicking 'X' button)
             * This ensures the history state is kept in sync (removes the state we added)
             */
            closeOverlay() {
                if (this.overlayStack.length > 0) {
                    // We do NOT pop here. We let the popstate event handler do it.
                    // This ensures consistent behavior whether the user presses Back or clicks 'X'.
                    window.history.back();
                }
            }

            // --- Pull to Refresh Logic ---

            setupPullToRefresh() {
                // Create Spinner
                this.spinner = document.createElement('div');
                this.spinner.className = 'ptr-spinner';
                this.spinner.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>';
                document.body.prepend(this.spinner);

                window.addEventListener('touchstart', (e) => {
                    if (window.scrollY === 0) {
                        this.touchStartY = e.touches[0].clientY;
                    }
                }, { passive: true });

                window.addEventListener('touchmove', (e) => {
                    if (window.scrollY === 0 && this.touchStartY > 0) {
                        const touchY = e.touches[0].clientY;
                        const pullDistance = touchY - this.touchStartY;

                        if (pullDistance > 0) {
                            this.isPulling = true;
                            // Visual feedback
                            this.spinner.style.transform = `translateY(${Math.min(pullDistance / 2, 80)}px) translateX(-50%) rotate(${pullDistance}deg)`;
                            this.spinner.style.opacity = Math.min(pullDistance / 100, 1);
                        }
                    }
                }, { passive: true });

                window.addEventListener('touchend', (e) => {
                    if (this.isPulling) {
                        const touchY = e.changedTouches[0].clientY;
                        const pullDistance = touchY - this.touchStartY;

                        if (pullDistance > this.refreshThreshold) {
                            this.triggerRefresh();
                        } else {
                            this.resetSpinner();
                        }
                        this.isPulling = false;
                        this.touchStartY = 0;
                    }
                });
            }

            triggerRefresh() {
                this.spinner.style.transition = '0.3s';
                this.spinner.style.transform = 'translateY(60px) translateX(-50%) rotate(360deg)';
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            }

            resetSpinner() {
                this.spinner.style.transition = '0.3s';
                this.spinner.style.transform = 'translateY(-50px) translateX(-50%)';
                this.spinner.style.opacity = '0';
            }

            // --- Page Transitions ---

            setupPageTransitions() {
                document.body.classList.add('page-enter');

                // Hijack internal links for exit animation (optional, can be disabled if buggy)
                // document.addEventListener('click', (e) => {
                //     const link = e.target.closest('a');
                //     if (link && link.href && link.href.startsWith(window.location.origin) && !link.target) {
                //         e.preventDefault();
                //         document.body.classList.add('page-exit');
                //         setTimeout(() => {
                //             window.location.href = link.href;
                //         }, 300);
                //     }
                // });
            }

            injectStyles() {
                const style = document.createElement('style');
                style.textContent = `
            /* Pull to Refresh Spinner */
            .ptr-spinner {
                position: fixed;
                top: -50px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 40px;
                background: white;
                border-radius: 50%;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                color: var(--primary, #4f46e5);
                opacity: 0;
                pointer-events: none;
            }

            /* Page Transitions */
            .page-enter {
                animation: fadeEnter 0.4s ease-out forwards;
            }
            @keyframes fadeEnter {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .page-exit {
                opacity: 0;
                transform: scale(0.98);
                transition: 0.3s;
            }

            /* Auto Hide Navbar */
            .bottom-nav {
                transition: transform 0.3s ease-in-out;
            }
            .bottom-nav.nav-hidden {
                transform: translateY(100%);
            }

            /* PWA Modal */
            .pwa-modal {
                position: fixed;
                bottom: 20px;
                left: 20px;
                right: 20px;
                background: white;
                border-radius: 16px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.15);
                z-index: 9999;
                transform: translateY(150%);
                transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                max-width: 400px;
                margin: 0 auto;
                border: 1px solid rgba(0,0,0,0.05);
            }
            
            .pwa-modal.active {
                transform: translateY(0);
            }

            .pwa-content {
                padding: 20px;
            }
        `;
                document.head.appendChild(style);
            }



            setupAutoHidingNavbar() {
                let lastScrollY = window.scrollY;
                const bottomNav = document.querySelector('.bottom-nav');
                if (!bottomNav) return;

                window.addEventListener('scroll', () => {
                    const currentScrollY = window.scrollY;
                    if (Math.abs(currentScrollY - lastScrollY) < 10) return;
                    if (currentScrollY > lastScrollY && currentScrollY > 100) {
                        bottomNav.classList.add('nav-hidden');
                    } else {
                        bottomNav.classList.remove('nav-hidden');
                    }
                    lastScrollY = currentScrollY;
                }, { passive: true });
            }

            // --- PWA Install Logic ğŸ“² ---
            setupPWAInstall() {
                let deferredPrompt;

                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;

                    // Check if user already dismissed it recently (optional: use localStorage)
                    if (localStorage.getItem('pwa-dismissed')) return;

                    // Show Custom Modal
                    this.showInstallModal(deferredPrompt);
                });
            }

            showInstallModal(deferredPrompt) {
                // Create Modal HTML
                const modal = document.createElement('div');
                modal.className = 'pwa-modal';
                modal.innerHTML = `
            <div class="pwa-content">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center text-indigo-600 text-2xl">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-gray-800">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
                        <p class="text-xs text-gray-500">ØªØ¬Ø±Ø¨Ø© Ø£Ø³Ø±Ø¹ ÙˆØ£ÙØ¶Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª!</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button id="pwa-dismiss" class="flex-1 py-2 text-gray-500 font-bold bg-gray-50 rounded-lg">Ù„ÙŠØ³ Ø§Ù„Ø¢Ù†</button>
                    <button id="pwa-install" class="flex-1 py-2 text-white font-bold bg-indigo-600 rounded-lg shadow-lg shadow-indigo-200">ØªØ«Ø¨ÙŠØª</button>
                </div>
            </div>
        `;
                document.body.appendChild(modal);

                // Animate In
                setTimeout(() => modal.classList.add('active'), 100);

                // Handlers
                document.getElementById('pwa-dismiss').onclick = () => {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                    localStorage.setItem('pwa-dismissed', 'true');
                };

                document.getElementById('pwa-install').onclick = async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                        }
                        deferredPrompt = null;
                    }
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                };
            }
        }

        // Initialize
        const mobileApp = new MobileEnhancements();

        // Global Helper for existing code to call
        window.openMobileOverlay = (closeCallback, name) => mobileApp.pushOverlay(closeCallback, name);
        window.closeMobileOverlay = () => mobileApp.closeOverlay();
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc, query, orderBy, serverTimestamp, where, limit, updateDoc, onSnapshot, arrayUnion, arrayRemove, setDoc, writeBatch, Timestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, sendPasswordResetEmail, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const auctionsGrid = document.getElementById('auctions-grid');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noAuctionsMsg = document.getElementById('no-auctions-msg');
        const userStatus = document.getElementById('user-status');

        // 1. Auth Check
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userStatus.innerHTML = `<img src="${user.photoURL || 'https://placehold.co/100'}" class="w-full h-full rounded-full object-cover">`;
            }
            loadAuctions();
        });

        // 2. Load Auctions
        async function loadAuctions() {
            try {
                // Query both 'products' (type=auction) AND legacy 'auctions' collection to cover all bases
                // Strategy: Try 'products' first.

                let auctions = [];
                let errorDetails = "";

                // Try Products Collection
                try {
                    const qProduct = query(
                        collection(db, "products"),
                        where("productType", "==", "auction"),
                        orderBy("createdAt", "desc")
                    );
                    const snapP = await getDocs(qProduct);
                    snapP.forEach(doc => auctions.push({ id: doc.id, ...doc.data(), source: 'products' }));
                } catch (e) {
                    console.warn("Product query failed (likely index):", e);
                    errorDetails += e.message;
                }

                // If empty, Try Legacy 'auctions' Collection
                if (auctions.length === 0) {
                    try {
                        const qLegacy = query(collection(db, "auctions"), where("status", "==", "active"));
                        const snapL = await getDocs(qLegacy);
                        snapL.forEach(doc => auctions.push({ id: doc.id, ...doc.data(), source: 'auctions' }));
                    } catch (e) { console.warn("Legacy query failed:", e); }
                }

                loadingIndicator.classList.add('hidden');

                if (auctions.length === 0) {
                    noAuctionsMsg.classList.remove('hidden');
                    // If error occurred and no results, show hint
                    if (errorDetails.includes("index")) {
                        auctionsGrid.classList.remove('hidden');
                        auctionsGrid.innerHTML = `<div class="p-4 bg-yellow-100 text-yellow-800 rounded">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù…Ø·Ù„ÙˆØ¨ Ø¥Ù†Ø´Ø§Ø¡ ÙÙ‡Ø±Ø³ (Index) Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²Ø§Ø¯Ø§Øª. Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„.</div>`;
                    }
                    return;
                }

                auctionsGrid.classList.remove('hidden');
                auctionsGrid.innerHTML = '';

                auctions.forEach(data => {
                    const card = createAuctionCard(data.id, data);
                    auctionsGrid.appendChild(card);
                });

                setInterval(updateTimers, 1000);

            } catch (error) {
                console.error("Error loading auctions:", error);
                loadingIndicator.innerHTML = `<p class="text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£.<br><span class="text-xs text-gray-400">${error.message}</span></p>`;
            }
        }

        function createAuctionCard(id, data) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-xl shadow-sm overflow-hidden auction-card border border-gray-100 group flex flex-col';

            const image = (data.imageUrls && data.imageUrls.length) ? data.imageUrls[0] : (data.imageUrl || 'https://placehold.co/400x300');
            const name = data.name || data.title || 'Ù…Ø²Ø§Ø¯ Ù…Ù…ÙŠØ²';
            const startPrice = data.price || data.startPrice || 0;
            const currentBid = data.currentBid || startPrice;

            // Handle different date formats (legacy vs new)
            let endDate;
            if (data.auctionEndTime && data.auctionEndTime.toDate) endDate = data.auctionEndTime.toDate();
            else if (data.endTime && data.endTime.toDate) endDate = data.endTime.toDate();
            else if (data.endTime) endDate = new Date(data.endTime);
            else endDate = new Date(Date.now() + 86400000);

            div.innerHTML = `
                <div class="h-48 bg-gray-200 relative overflow-hidden">
                    <img src="${image}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                    <div class="absolute top-2 right-2 bg-red-600 text-white px-3 py-1 rounded-lg text-xs font-bold shadow-md animate-pulse">
                        <i class="fas fa-circle text-[8px] mr-1"></i> Ù…Ø¨Ø§Ø´Ø±
                    </div>
                </div>
                <div class="p-4 flex flex-col flex-grow">
                    <h3 class="text-lg font-bold text-gray-800 mb-2 truncate">${name}</h3>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-gray-50 p-2 rounded-lg text-center">
                            <div class="text-xs text-gray-500">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                            <div class="font-bold text-blue-600 text-lg">${currentBid.toLocaleString()} Ø¯.Ø¬</div>
                        </div>
                         <div class="bg-red-50 p-2 rounded-lg text-center">
                            <div class="text-xs text-red-500">ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„</div>
                            <div class="font-bold text-red-700 text-sm countdown-badge" data-end="${endDate.toISOString()}">--:--:--</div>
                        </div>
                    </div>

                    <a href="PRESENTPRODUCT.html?product=${id}" class="mt-auto w-full bg-gray-900 hover:bg-black text-white py-3 rounded-lg font-bold text-center transition-colors flex items-center justify-center gap-2">
                        <i class="fas fa-gavel"></i> Ø´Ø§Ø±Ùƒ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ø¯
                    </a>
                </div>
            `;
            return div;
        }

        function updateTimers() {
            document.querySelectorAll('.countdown-badge').forEach(el => {
                const end = new Date(el.dataset.end);
                const now = new Date();
                const diff = end - now;

                if (diff <= 0) {
                    el.textContent = "Ø§Ù†ØªÙ‡Ù‰";
                    el.classList.add('text-gray-500');
                    el.classList.remove('text-red-700');
                } else {
                    const h = Math.floor(diff / (1000 * 60 * 60));
                    const m = Math.floor((diff / (1000 * 60)) % 60);
                    const s = Math.floor((diff / 1000) % 60);
                    el.textContent = `${h}Ø³ ${m}Ø¯ ${s}Ø«`;
                }
            });
        }

    </script>
</body>

</html>