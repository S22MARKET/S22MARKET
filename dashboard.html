<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - ููุญุฉ ุงูุชุญูู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f0f2f5;
        }

        .hidden {
            display: none;
        }

        .dashboard-tab:hover {
            background-color: #4338ca;
        }

        .dashboard-tab.active-tab {
            background-color: #4f46e5;
            color: white;
            font-weight: bold;
        }

        .dashboard-panel {
            animation: fadeIn 0.5s;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div id="dashboard-page" class="hidden">
        <div class="relative min-h-screen md:flex">
            <div class="bg-gray-800 text-gray-100 flex justify-between md:hidden">
                <a href="dashboard.html" class="block p-4 text-white font-bold">S22 Market</a>
                <button id="mobile-menu-btn" class="p-4 focus:outline-none focus:bg-gray-700">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <aside id="sidebar"
                class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 right-0 transform translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30">
                <div class="p-3 text-center border-b border-gray-700">
                    <h2 class="text-2xl font-bold">S22 Market</h2>
                    <p id="admin-welcome-name" class="text-sm text-indigo-300">ุฌุงุฑู ุงูุชุญููู...</p>
                </div>
                <nav class="flex-1 p-2 space-y-2">
                    <a href="dashboard.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-chart-line fa-fw mr-3"></i> ููุญุฉ ุงูุชุญูู</a>

                    <a href="admin-layout.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-chart-line fa-fw mr-3"></i> ููุงุฆู ุตูุญุฉ ุงููุชุฌุฑ </a>


                    <a href="admin-sellers.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700 relative">
                        <i class="fas fa-users-cog fa-fw mr-3"></i> ุฅุฏุงุฑุฉ ุงูุจุงุฆุนูู
                        <span id="sellers-badge"
                            class="hidden absolute left-4 bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">0</span>
                    </a>
                    <a href="admin-reports.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-flag fa-fw mr-3 text-red-400"></i> ุงูุฅุจูุงุบุงุช</a>
                    <a href="admin-products.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-boxes fa-fw mr-3"></i> ุงูููุชุฌุงุช</a>
                    <a href="admin-offers.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-star fa-fw mr-3"></i> ุงูุนุฑูุถ</a>
                    <a href="admin-product-requests.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-user-plus fa-fw mr-3"></i> ุทูุจุงุช ุงูุฒูุงุฑ</a>
                    <a href="admin-categories.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-sitemap fa-fw mr-3"></i> ุงูุฃูุณุงู</a>
                    <a href="admin-orders.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-clipboard-list fa-fw mr-3"></i> ุงูุทูุจุงุช</a>
                    <a href="admin-coupons.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-tags fa-fw mr-3"></i> ุงูููุจููุงุช</a>
                    <a href="admin-inquiries.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-envelope-open-text fa-fw mr-3"></i> ุงูุฑุณุงุฆู ุงููุงุฑุฏุฉ</a>
                    <a href="admin-applications.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fab fa-google-play fa-fw mr-3"></i> ุงูุชุทุจููุงุช</a>
                    <a href="admin-layout.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-layer-group fa-fw mr-3"></i> ูุงุฌูุฉ ุงููุชุฌุฑ</a>
                    <a href="admin-notepad.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-book fa-fw mr-3"></i> ุงููููุฑุฉ</a>

                    <hr class="border-gray-700 my-2">
                    <h6 class="px-4 text-xs font-semibold text-gray-400 uppercase">ูุธุงู ุงูููุงุก (ุงููุชุฌุฑ)</h6>
                    <a href="admin-loyalty-settings.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-gem fa-fw mr-3 text-yellow-400"></i> ุฅุนุฏุงุฏุงุช ุงูุฌูุงูุฑ ๐</a>
                    <a href="admin-loyalty-approvals.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-check-to-slot fa-fw mr-3 text-green-400"></i> ููุงููุงุช ุงูููุงู</a>
                    <a href="admin-referrals-pending.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-check-double fa-fw mr-3 text-blue-400"></i> ููุงููุงุช ุงูุฏุนูุงุช</a>
                    <hr class="border-gray-700 my-2">

                    <a href="admin-settings.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-cogs fa-fw mr-3"></i> ุฅุนุฏุงุฏุงุช ุงููุชุฌุฑ</a>

                    <hr class="border-gray-700 my-2">
                    <h6 class="px-4 text-xs font-semibold text-gray-400 uppercase">ุงูุฃูุงุฏูููุฉ</h6>
                    <a href="dawarat_admin_manager.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"
                        target="_blank">
                        <i class="fas fa-graduation-cap fa-fw mr-3 text-gray-400"></i>
                        <span>ุฅุฏุงุฑุฉ ุงูุจุฐููุฑุงุช</span>
                        <i class="fas fa-external-link-alt fa-xs ml-auto"></i>
                    </a>

                </nav>
                <div class="p-4 border-t border-gray-700">
                    <button id="logout-btn"
                        class="w-full bg-red-600 py-2 rounded-md hover:bg-red-700 transition-colors"><i
                            class="fas fa-sign-out-alt mr-2"></i> ุชุณุฌูู ุงูุฎุฑูุฌ</button>
                </div>
            </aside>


            <main class="flex-1 p-4 md:p-8 overflow-y-auto bg-gray-100">
                <!-- Header with Greeting -->
                <div
                    class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl shadow-2xl p-6 sm:p-8 mb-6 text-white">
                    <h2 class="text-3xl sm:text-4xl font-black mb-2">ูุฑุญุจุงู ุจู ูู ููุญุฉ ุงูุชุญูู ๐</h2>
                    <p class="text-indigo-100 text-sm sm:text-base">ุฅููู ูุธุฑุฉ ุณุฑูุนุฉ ุนูู ุฃุฏุงุก ุงููุชุฌุฑ ุงูููู</p>
                </div>

                <!-- Overview Statistics Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8">

                    <!-- Total Users Card -->
                    <div
                        class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-blue-500 hover:shadow-xl transition-all transform hover:scale-105">
                        <div class="flex items-center justify-between mb-4">
                            <div class="bg-blue-100 p-3 rounded-xl">
                                <i class="fas fa-users text-blue-600 text-2xl"></i>
                            </div>
                            <span
                                class="text-xs font-semibold text-blue-600 bg-blue-100 px-2 py-1 rounded-full">ุงููุณุชุฎุฏููู</span>
                        </div>
                        <h3 class="text-gray-600 text-sm font-semibold mb-1">ุฅุฌูุงูู ุงููุณุชุฎุฏููู</h3>
                        <p class="text-3xl font-black text-gray-800" id="total-users">0</p>
                        <p class="text-xs text-gray-500 mt-2">ูุณุฌููู ูู ุงูููุตุฉ</p>
                    </div>

                    <!-- Total Products Card -->
                    <div
                        class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-green-500 hover:shadow-xl transition-all transform hover:scale-105">
                        <div class="flex items-center justify-between mb-4">
                            <div class="bg-green-100 p-3 rounded-xl">
                                <i class="fas fa-box text-green-600 text-2xl"></i>
                            </div>
                            <span
                                class="text-xs font-semibold text-green-600 bg-green-100 px-2 py-1 rounded-full">ุงูููุชุฌุงุช</span>
                        </div>
                        <h3 class="text-gray-600 text-sm font-semibold mb-1">ุฅุฌูุงูู ุงูููุชุฌุงุช</h3>
                        <p class="text-3xl font-black text-gray-800" id="total-products">0</p>
                        <p class="text-xs text-gray-500 mt-2">ููุชุฌ ูุนุฑูุถ</p>
                    </div>

                    <!-- Total Orders Card -->
                    <div
                        class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-purple-500 hover:shadow-xl transition-all transform hover:scale-105">
                        <div class="flex items-center justify-between mb-4">
                            <div class="bg-purple-100 p-3 rounded-xl">
                                <i class="fas fa-shopping-cart text-purple-600 text-2xl"></i>
                            </div>
                            <span
                                class="text-xs font-semibold text-purple-600 bg-purple-100 px-2 py-1 rounded-full">ุงูุทูุจุงุช</span>
                        </div>
                        <h3 class="text-gray-600 text-sm font-semibold mb-1">ุฅุฌูุงูู ุงูุทูุจุงุช</h3>
                        <p class="text-3xl font-black text-gray-800" id="total-orders">0</p>
                        <p class="text-xs text-gray-500 mt-2">ุทูุจ ููุชูู</p>
                    </div>

                    <!-- Pending Approvals Card -->
                    <div
                        class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-orange-500 hover:shadow-xl transition-all transform hover:scale-105">
                        <div class="flex items-center justify-between mb-4">
                            <div class="bg-orange-100 p-3 rounded-xl">
                                <i class="fas fa-clock text-orange-600 text-2xl"></i>
                            </div>
                            <span
                                class="text-xs font-semibold text-orange-600 bg-orange-100 px-2 py-1 rounded-full animate-pulse"
                                id="pending-count-badge">0</span>
                        </div>
                        <h3 class="text-gray-600 text-sm font-semibold mb-1">ูุนูู ููููุงููุฉ</h3>
                        <p class="text-3xl font-black text-gray-800" id="total-pending">0</p>
                        <p class="text-xs text-gray-500 mt-2">ุจุญุงุฌุฉ ููุฑุงุฌุนุฉ</p>
                    </div>
                </div>

                <!-- Quick Actions Panel -->
                <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
                    <h3 class="text-xl font-black text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-bolt text-yellow-500"></i>
                        ุฅุฌุฑุงุกุงุช ุณุฑูุนุฉ
                    </h3>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <a href="admin-sellers.html"
                            class="flex flex-col items-center gap-2 p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl hover:shadow-md transition-all hover:scale-105 cursor-pointer group">
                            <div class="bg-blue-600 p-3 rounded-full group-hover:bg-blue-700 transition-colors">
                                <i class="fas fa-store text-white text-xl"></i>
                            </div>
                            <span class="text-sm font-bold text-gray-700 text-center">ููุงููุฉ ูุชุงุฌุฑ</span>
                        </a>

                        <a href="admin-product-requests.html"
                            class="flex flex-col items-center gap-2 p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-xl hover:shadow-md transition-all hover:scale-105 cursor-pointer group">
                            <div class="bg-green-600 p-3 rounded-full group-hover:bg-green-700 transition-colors">
                                <i class="fas fa-box text-white text-xl"></i>
                            </div>
                            <span class="text-sm font-bold text-gray-700 text-center">ูุฑุงุฌุนุฉ ููุชุฌุงุช</span>
                        </a>

                        <a href="admin-offers.html"
                            class="flex flex-col items-center gap-2 p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl hover:shadow-md transition-all hover:scale-105 cursor-pointer group">
                            <div class="bg-purple-600 p-3 rounded-full group-hover:bg-purple-700 transition-colors">
                                <i class="fas fa-tags text-white text-xl"></i>
                            </div>
                            <span class="text-sm font-bold text-gray-700 text-center">ุฅูุดุงุก ุนุฑุถ</span>
                        </a>

                        <a href="admin-inquiries.html"
                            class="flex flex-col items-center gap-2 p-4 bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl hover:shadow-md transition-all hover:scale-105 cursor-pointer group">
                            <div class="bg-orange-600 p-3 rounded-full group-hover:bg-orange-700 transition-colors">
                                <i class="fas fa-comments text-white text-xl"></i>
                            </div>
                            <span class="text-sm font-bold text-gray-700 text-center">ุงูุงุณุชูุณุงุฑุงุช</span>
                        </a>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Sales Chart Placeholder -->
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h3 class="text-lg font-black text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-chart-line text-indigo-600"></i>
                            ๐ ูุดุงุท ุงููุจูุนุงุช
                        </h3>
                        <canvas id="salesChart" style="max-height: 250px;"></canvas>
                    </div>

                    <!-- Categories Breakdown Placeholder -->
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h3 class="text-lg font-black text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-chart-pie text-purple-600"></i>
                            ๐ ุงููุฆุงุช ุงูุฃูุซุฑ ูุจูุนุงู
                        </h3>
                        <canvas id="categoriesChart" style="max-height: 250px;"></canvas>
                    </div>
                </div>

                <!-- Recent Activity Feed -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-xl font-black text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-history text-indigo-600"></i>
                        ุขุฎุฑ ุงููุดุงุทุงุช
                    </h3>
                    <div id="recent-activity" class="space-y-3">
                        <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                            <div class="loader w-8 h-8 border-2"></div>
                            <span class="text-gray-500">ุฌุงุฑู ุชุญููู ุขุฎุฑ ุงููุดุงุทุงุช...</span>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN_EMAILS = [
            's22market@gmail.com',
            'yacinee474474@gmail.com',
            'nourmt01@gmail.com'
        ];

        let productsCache = [];
        let ordersCache = [];
        let myChart = null;
        let profitChart = null;
        let topProductsChart = null;

        const dashboardPage = document.getElementById('dashboard-page');
        const logoutBtn = document.getElementById('logout-btn');
        const getEl = (id) => document.getElementById(id);

        // ============================================================
        // ูุธุงู ุงูุญูุงูุฉ (Guard)
        // ============================================================
        onAuthStateChanged(auth, (user) => {
            if (user && ADMIN_EMAILS.includes(user.email)) {
                dashboardPage.classList.remove('hidden');
                getEl('admin-welcome-name').textContent = `ูุฑุญุจุงูุ ${user.displayName || user.email.split('@')[0]}`;
                initializeDashboard();
            } else {
                window.location.href = 'admin-login.html';
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = 'admin-login.html';
        });

        // ูุงุฆูุฉ ุงูููุจุงูู
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('translate-x-full');
            });
        }

        function setActiveTab() {
            const currentPage = window.location.pathname.split('/').pop();
            const tabs = document.querySelectorAll('.dashboard-tab');
            tabs.forEach(tab => {
                const tabHref = tab.getAttribute('href').split('/').pop();
                if (tabHref === currentPage || (currentPage === '' && tabHref === 'dashboard.html') || (currentPage === 'dashboard.html' && tabHref === 'dashboard.html')) {
                    tab.classList.add('active-tab');
                } else {
                    tab.classList.remove('active-tab');
                }
            });
        }

        function initializeDashboard() {
            setActiveTab();

            loadAnalytics();

            // ุงูุงุณุชูุงุน ูุชุญุฏูุซุงุช ุงูููุชุฌุงุช (ููุญุณุงุจุงุช)
            onSnapshot(query(collection(db, "products")), (snapshot) => {
                productsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAnalytics();
            });

            // ุงูุงุณุชูุงุน ูุชุญุฏูุซุงุช ุงูุทูุจุงุช
            onSnapshot(query(collection(db, "orders")), (snapshot) => {
                ordersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAnalytics();
            });

            // ุงูุงุณุชูุงุน ูุทูุจุงุช ุงููุชุงุฌุฑ ุงููุนููุฉ (ุฅุดุนุงุฑ ููุฑู)
            onSnapshot(query(collection(db, "users"), where("storeRequest.status", "==", "pending")), (snapshot) => {
                const count = snapshot.size;
                const badge = document.getElementById('sellers-badge');
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            });
        }

        function loadAnalytics() {
            const panel = document.getElementById('analytics-panel');
            panel.innerHTML = `
            <h1 class="text-3xl font-bold text-gray-800 mb-6">ููุญุฉ ุงูุชุญูู ุงูุฑุฆูุณูุฉ (ุงููุชุฌุฑ)</h1>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <i class="fas fa-hand-holding-usd text-4xl text-green-500 mr-4"></i>
                    <div><p class="text-gray-500">ุฅุฌูุงูู ุงูุฃุฑุจุงุญ</p><p id="total-profit" class="text-2xl font-bold">0 ุฏ.ุฌ</p></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <i class="fas fa-divide text-4xl text-yellow-500 mr-4"></i>
                    <div><p class="text-gray-500">ูุชูุณุท ุงูุฑุจุญ / ุทูุจ</p><p id="avg-profit" class="text-2xl font-bold">0 ุฏ.ุฌ</p></div>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <i class="fas fa-check-circle text-4xl text-blue-500 mr-4"></i>
                    <div><p class="text-gray-500">ุงูุทูุจุงุช ุงูููุชููุฉ</p><p id="completed-orders" class="text-2xl font-bold">0</p></div>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <i class="fas fa-spinner text-4xl text-orange-500 mr-4"></i>
                    <div><p class="text-gray-500">ุงูุทูุจุงุช ุบูุฑ ุงูููุชููุฉ</p><p id="incomplete-orders" class="text-2xl font-bold">0</p></div>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-md flex items-center col-span-1 sm:col-span-2 lg:col-span-4">
                    <i class="fas fa-boxes text-4xl text-purple-500 mr-4"></i>
                    <div><p class="text-gray-500">ุฅุฌูุงูู ุงูููุชุฌุงุช (ุงููุดุทุฉ)</p><p id="total-products" class="text-2xl font-bold">0</p></div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4">ุงูุทูุจุงุช ุงูููุชููุฉ (ุขุฎุฑ 7 ุฃูุงู)</h2>
                    <canvas id="ordersChart"></canvas>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4">ุงูุฃุฑุจุงุญ ุงูููููุฉ (ุขุฎุฑ 7 ุฃูุงู)</h2>
                    <canvas id="profitChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-bold mb-4">ุฃุนูู 7 ููุชุฌุงุช ุชุญููููุง ููุฃุฑุจุงุญ</h2>
                <canvas id="topProductsChart"></canvas>
            </div>
            `;
        }

        function updateAnalytics() {
            if (!getEl('total-products')) return;

            // 1. ููุชุฑุฉ ุงูููุชุฌุงุช: ุงุณุชุจุนุงุฏ ุงูููุฑุณุงุช + ุงุณุชุจุนุงุฏ ุงููุญุฐููุฉ (sold_out ูุง ูุณุชุจุนุฏ ูู ุงูุฅุญุตุงุก ูุฃูู ููุชุฌ ููุฌูุฏ)
            const marketProducts = productsCache.filter(p => p.productType !== 'course');

            const completedOrders = ordersCache.filter(o => o.status === 'completed');
            const incompleteOrders = ordersCache.filter(o => o.status === 'new' || o.status === 'pending'); // ุดูููุง pending
            const totalProfit = completedOrders.reduce((sum, order) => sum + (order.profit || 0), 0);
            const completedOrdersCount = completedOrders.length;
            const incompleteOrdersCount = incompleteOrders.length;
            const avgProfit = completedOrdersCount > 0 ? totalProfit / completedOrdersCount : 0;

            getEl('total-products').textContent = marketProducts.length;
            getEl('total-profit').textContent = `${totalProfit.toLocaleString()} ุฏ.ุฌ`;
            getEl('avg-profit').textContent = `${avgProfit.toFixed(0).toLocaleString()} ุฏ.ุฌ`;
            getEl('completed-orders').textContent = completedOrdersCount;
            getEl('incomplete-orders').textContent = incompleteOrdersCount;

            // ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ูููุฎุทุทุงุช (Charts)
            const last7Days = {};
            const last7DaysProfit = {};

            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const key = d.toISOString().split('T')[0];
                last7Days[key] = 0;
                last7DaysProfit[key] = 0;
            }

            completedOrders.forEach(order => {
                if (order.createdAt?.toDate) {
                    const orderDate = order.createdAt.toDate().toISOString().split('T')[0];
                    if (last7Days.hasOwnProperty(orderDate)) {
                        last7Days[orderDate]++;
                        last7DaysProfit[orderDate] += (order.profit || 0);
                    }
                }
            });

            const chartLabels = Object.keys(last7Days).map(date => new Date(date).toLocaleDateString('ar-EG', { weekday: 'short', day: 'numeric' }));

            const ordersChartData = Object.values(last7Days);
            const ordersCtx = getEl('ordersChart')?.getContext('2d');
            if (ordersCtx) {
                if (myChart) myChart.destroy();
                myChart = new Chart(ordersCtx, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'ุนุฏุฏ ุงูุทูุจุงุช',
                            data: ordersChartData,
                            backgroundColor: 'rgba(79, 70, 229, 0.8)',
                            borderColor: 'rgba(79, 70, 229, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
                });
            }

            const profitChartData = Object.values(last7DaysProfit);
            const profitCtx = getEl('profitChart')?.getContext('2d');
            if (profitCtx) {
                if (profitChart) profitChart.destroy();
                profitChart = new Chart(profitCtx, {
                    type: 'line',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'ุงูุฃุฑุจุงุญ (ุฏ.ุฌ)',
                            data: profitChartData,
                            backgroundColor: 'rgba(22, 163, 74, 0.2)',
                            borderColor: 'rgba(22, 163, 74, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                });
            }

            const productProfits = {};
            completedOrders.forEach(order => {
                (order.items || []).forEach(item => {
                    // ุชูุธูู ุงูุงุณู ูุฅุฒุงูุฉ ุฃู HTML ูุฏูู
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = item.name || 'ููุชุฌ ุบูุฑ ูุนุฑูู';
                    const productName = tempDiv.textContent || tempDiv.innerText || "";

                    // ุญุณุงุจ ุฑุจุญ ุชูุฑูุจู ููู ููุชุฌ ูู ุงูุทูุจ
                    const itemProfit = (order.profit || 0) / (order.items.length || 1);
                    if (productProfits[productName]) {
                        productProfits[productName] += itemProfit;
                    } else {
                        productProfits[productName] = itemProfit;
                    }
                });
            });
            const sortedProducts = Object.entries(productProfits).sort(([, a], [, b]) => b - a).slice(0, 7);
            const topProductsLabels = sortedProducts.map(p => p[0]);
            const topProductsData = sortedProducts.map(p => p[1]);
            const topProductsCtx = getEl('topProductsChart')?.getContext('2d');
            if (topProductsCtx) {
                if (topProductsChart) topProductsChart.destroy();
                topProductsChart = new Chart(topProductsCtx, {
                    type: 'bar',
                    data: {
                        labels: topProductsLabels,
                        datasets: [{
                            label: 'ุฅุฌูุงูู ุงูุฑุจุญ',
                            data: topProductsData,
                            backgroundColor: 'rgba(153, 102, 255, 0.8)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'ุฅุฌูุงูู ุงูุฑุจุญ (ุฏ.ุฌ)' } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function (context) { return `ุงูุฑุจุญ: ${context.parsed.y.toLocaleString()} ุฏ.ุฌ`; } } } } }
                });
            }
        }
    </script>
</body>

</html>