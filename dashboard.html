<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - لوحة التحكم النهائية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.6/purify.min.js"></script>

    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f0f2f5; }
        .hidden { display: none; }
        .active-tab { background-color: #4f46e5; color: white; }
        .dashboard-panel { animation: fadeIn 0.5s; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 40;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: white; padding: 1.5rem; border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%;
            max-width: 700px; z-index: 50; max-height: 90vh; overflow-y: auto;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #4f46e5;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #48bb78; }
        input:checked + .slider:before { transform: translateX(24px); }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }

        .ql-toolbar { border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; }
        .ql-container { border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; min-height: 80px; }
        .ql-editor { font-family: 'Tajawal', sans-serif; }

        @media (max-width: 768px) {
            .responsive-table thead { display: none; }
            .responsive-table tr {
                display: block; border: 1px solid #e5e7eb; border-radius: 0.5rem;
                padding: 1rem; margin-bottom: 1rem; background-color: white;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            }
             .responsive-table td {
                display: flex; justify-content: space-between; align-items: center;
                padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;
            }
            .responsive-table td:last-child { border-bottom: none; }
            .responsive-table td::before {
                content: attr(data-label); font-weight: 600;
                margin-left: 0.5rem; color: #4b5563;
            }
             .responsive-table .actions-cell { justify-content: flex-end; gap: 1rem; }
             .responsive-table .actions-cell::before { content: ""; flex-grow: 1; }
             .responsive-table .order-status-select, .responsive-table .profit-input, .responsive-table .doneBy-input, .responsive-table .suppliers-textarea {
                width: auto; flex-grow: 1; max-width: 180px; text-align: left;
             }
        }
    </style>
</head>
<body>

<div id="login-page" class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
    <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-xl space-y-6">
        <div class="text-center">
            <i class="fas fa-shield-alt text-6xl text-indigo-600 mb-4"></i>
            <h2 class="text-3xl font-extrabold text-gray-900">لوحة تحكم S22 Market</h2>
            <p class="mt-2 text-sm text-gray-600">
                مرحباً بك مجدداً! الرجاء تسجيل الدخول للمتابعة.
            </p>
        </div>

        <form id="login-form" class="space-y-6">
            <div>
                <label for="admin-email" class="sr-only">البريد الإلكتروني</label>
                <input id="admin-email" name="email" type="email" autocomplete="email" required
                       class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
                       placeholder="البريد الإلكتروني">
            </div>

            <div class="relative">
                <label for="admin-password" class="sr-only">كلمة المرور</label>
                <input id="admin-password" name="password" type="password" autocomplete="current-password" required
                       class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
                       placeholder="كلمة المرور">
                <button type="button" id="toggle-password"
                        class="absolute inset-y-0 left-0 flex items-center px-4 text-gray-500 hover:text-indigo-600 focus:outline-none">
                    <i class="fas fa-eye-slash"></i>
                </button>
            </div>

            <p id="login-error" class="hidden text-sm text-red-600 text-center">
                <i class="fas fa-exclamation-circle mr-1"></i> البريد الإلكتروني أو كلمة المرور غير صحيحة.
            </p>

            <div>
                <button type="submit"
                        class="w-full flex justify-center py-3 px-4 border border-transparent text-lg font-bold rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-300">
                    <i class="fas fa-sign-in-alt ml-2"></i> دخول
                </button>
            </div>
        </form>

        <div class="text-center mt-4">
             <a href="index.html"
                class="font-medium text-indigo-600 hover:text-indigo-500 transition-colors">
                 <i class="fas fa-arrow-left ml-1"></i> العودة إلى المتجر
            </a>
        </div>
    </div>
</div>


    <div id="dashboard-page" class="hidden">
        <div class="relative min-h-screen md:flex">
            <div class="bg-gray-800 text-gray-100 flex justify-between md:hidden">
                <a href="#" class="block p-4 text-white font-bold">S22 Market</a>
                <button id="mobile-menu-btn" class="p-4 focus:outline-none focus:bg-gray-700">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <aside id="sidebar" class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 right-0 transform translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30">
                <div class="p-3 text-center border-b border-gray-700">
                    <h2 class="text-2xl font-bold">S22 Market</h2>
                </div>
                <nav class="flex-1 p-2 space-y-2">
                    <a href="#analytics" class="dashboard-tab active-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i class="fas fa-chart-line fa-fw mr-3"></i> لوحة التحكم</a>
                    <a href="#products" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i class="fas fa-boxes fa-fw mr-3"></i> المنتجات</a>
                    <a href="#offers" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i class="fas fa-star fa-fw mr-3"></i> العروض</a>
                    <a href="#productRequests" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i class="fas fa-user-plus fa-fw mr-3"></i> طلبات الزوار</a>
                    <a href="#categories" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i class="fas fa-sitemap fa-fw mr-3"></i> الأقسام</a>
                    <a href="#orders" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i class="fas fa-clipboard-list fa-fw mr-3"></i> الطلبات</a>
                    <a href="#coupons" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i class="fas fa-tags fa-fw mr-3"></i> الكوبونات</a>
                    <a href="#inquiries" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i class="fas fa-envelope-open-text fa-fw mr-3"></i> الرسائل الواردة</a>
                    <a href="#applications" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i class="fab fa-google-play fa-fw mr-3"></i> التطبيقات</a>
                    <a href="#notepad" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i class="fas fa-book fa-fw mr-3"></i> المفكرة</a>
                    <a href="#settings" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i class="fas fa-cogs fa-fw mr-3"></i> إعدادات المتجر</a>
                </nav>
                <div class="p-4 border-t border-gray-700">
                    <button id="logout-btn" class="w-full bg-red-600 py-2 rounded-md hover:bg-red-700 transition-colors"><i class="fas fa-sign-out-alt mr-2"></i> تسجيل الخروج</button>
                </div>
            </aside>

            <main class="flex-1 p-4 md:p-8 overflow-y-auto">
                <div id="analytics-panel" class="dashboard-panel"></div>
                <div id="products-panel" class="dashboard-panel hidden"></div>
                <div id="offers-panel" class="dashboard-panel hidden"></div>
                <div id="productRequests-panel" class="dashboard-panel hidden"></div>
                <div id="categories-panel" class="dashboard-panel hidden"></div>
                <div id="orders-panel" class="dashboard-panel hidden"></div>
                <div id="coupons-panel" class="dashboard-panel hidden"></div>
                <div id="inquiries-panel" class="dashboard-panel hidden"></div>
                <div id="applications-panel" class="dashboard-panel hidden"></div>
                <div id="notepad-panel" class="dashboard-panel hidden"></div>
                <div id="settings-panel" class="dashboard-panel hidden"></div>
            </main>
        </div>
    </div>

    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, serverTimestamp, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const generateUniqueId = () => 'sub_' + Math.random().toString(36).substring(2, 11);

        let categoriesCache = [];
        let productsCache = [];
        let offersCache = []; // [+] NEW: Cache for offers
        let ordersCache = [];
        let couponsCache = [];
        let applicationsCache = [];
        let notesCache = [];
        let myChart = null;
        let profitChart = null;
        let topProductsChart = null;
        let selectedFileStore = {};

        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        
        const getEl = (id) => document.getElementById(id);
        const getVal = (id) => getEl(id)?.value || '';
        const getNum = (id) => parseFloat(getVal(id));
        const getInt = (id) => parseInt(getVal(id), 10);
        const getChecked = (id) => getEl(id)?.checked || false;


        onAuthStateChanged(auth, user => {
            if (user) {
                loginPage.classList.add('hidden');
                dashboardPage.classList.remove('hidden');
                initializeDashboard();
            } else {
                loginPage.classList.remove('hidden');
                dashboardPage.classList.add('hidden');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = getVal('admin-email');
            const password = getVal('admin-password');
            loginError.classList.add('hidden');
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login Error:", error);
                loginError.textContent = "فشل الدخول. تحقق من البريد وكلمة المرور.";
                loginError.classList.remove('hidden');
            }
        });

        logoutBtn.addEventListener('click', async () => { await signOut(auth); });

        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('translate-x-full');
        });

        function initializeDashboard() {
            const tabs = document.querySelectorAll('.dashboard-tab');
            const panels = document.querySelectorAll('.dashboard-panel');

            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    tabs.forEach(t => t.classList.remove('active-tab'));
                    tab.classList.add('active-tab');
                    const targetPanelId = tab.getAttribute('href').substring(1) + '-panel';
                    panels.forEach(panel => panel.classList.toggle('hidden', panel.id !== targetPanelId));
                    if (window.innerWidth < 768 && !sidebar.classList.contains('translate-x-full')) {
                        sidebar.classList.add('translate-x-full');
                    }
                });
            });
            
            loadAnalytics();
            loadCategories();
            loadProducts();
            loadOffers(); // [+] NEW: Load offers
            loadOrders();
            loadCoupons();
            loadInquiries(); 
            loadApplications();
            loadNotepad();
            loadProductRequests();
            loadStoreSettings();
        }
        
        function loadAnalytics() {
            const panel = document.getElementById('analytics-panel');
            panel.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">لوحة التحكم الرئيسية</h1>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                        <i class="fas fa-hand-holding-usd text-4xl text-green-500 mr-4"></i>
                        <div><p class="text-gray-500">إجمالي الأرباح</p><p id="total-profit" class="text-2xl font-bold">0 د.ج</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                        <i class="fas fa-divide text-4xl text-yellow-500 mr-4"></i>
                        <div><p class="text-gray-500">متوسط الربح / طلب</p><p id="avg-profit" class="text-2xl font-bold">0 د.ج</p></div>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                        <i class="fas fa-check-circle text-4xl text-blue-500 mr-4"></i>
                        <div><p class="text-gray-500">الطلبات المكتملة</p><p id="completed-orders" class="text-2xl font-bold">0</p></div>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                        <i class="fas fa-spinner text-4xl text-orange-500 mr-4"></i>
                        <div><p class="text-gray-500">الطلبات غير المكتملة</p><p id="incomplete-orders" class="text-2xl font-bold">0</p></div>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center col-span-1 sm:col-span-2 lg:col-span-4">
                        <i class="fas fa-boxes text-4xl text-purple-500 mr-4"></i>
                        <div><p class="text-gray-500">إجمالي المنتجات</p><p id="total-products" class="text-2xl font-bold">0</p></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4">الطلبات المكتملة (آخر 7 أيام)</h2>
                        <canvas id="ordersChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4">الأرباح اليومية (آخر 7 أيام)</h2>
                        <canvas id="profitChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4">أعلى 7 منتجات تحقيقًا للأرباح</h2>
                    <canvas id="topProductsChart"></canvas>
                </div>
                `;
        }
        function updateAnalytics() {
            if(!getEl('total-products')) return; 
            
            const completedOrders = ordersCache.filter(o => o.status === 'completed');
            const incompleteOrders = ordersCache.filter(o => o.status === 'new');

            const totalProfit = completedOrders.reduce((sum, order) => sum + (order.profit || 0), 0);
            const completedOrdersCount = completedOrders.length;
            const incompleteOrdersCount = incompleteOrders.length;

            const avgProfit = completedOrdersCount > 0 ? totalProfit / completedOrdersCount : 0;

            getEl('total-products').textContent = productsCache.length;
            getEl('total-profit').textContent = `${totalProfit.toLocaleString()} د.ج`;
            getEl('avg-profit').textContent = `${avgProfit.toFixed(0).toLocaleString()} د.ج`;
            getEl('completed-orders').textContent = completedOrdersCount;
            getEl('incomplete-orders').textContent = incompleteOrdersCount;

            const last7Days = {};
            const last7DaysProfit = {};

            for(let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const key = d.toISOString().split('T')[0];
                last7Days[key] = 0;
                last7DaysProfit[key] = 0;
            }

            completedOrders.forEach(order => {
                if (order.createdAt?.toDate) {
                    const orderDate = order.createdAt.toDate().toISOString().split('T')[0];
                    if (last7Days.hasOwnProperty(orderDate)) {
                        last7Days[orderDate]++;
                        last7DaysProfit[orderDate] += (order.profit || 0);
                    }
                }
            });

            const chartLabels = Object.keys(last7Days).map(date => new Date(date).toLocaleDateString('ar-EG', { weekday: 'short', day: 'numeric'}));
            
            const ordersChartData = Object.values(last7Days);
            const ordersCtx = getEl('ordersChart')?.getContext('2d');
            if (ordersCtx) {
                if (myChart) myChart.destroy();
                myChart = new Chart(ordersCtx, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'عدد الطلبات',
                            data: ordersChartData,
                            backgroundColor: 'rgba(79, 70, 229, 0.8)',
                            borderColor: 'rgba(79, 70, 229, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
                });
            }

            const profitChartData = Object.values(last7DaysProfit);
            const profitCtx = getEl('profitChart')?.getContext('2d');
            if (profitCtx) {
                if (profitChart) profitChart.destroy();
                profitChart = new Chart(profitCtx, {
                    type: 'line',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'الأرباح (د.ج)',
                            data: profitChartData,
                            backgroundColor: 'rgba(22, 163, 74, 0.2)',
                            borderColor: 'rgba(22, 163, 74, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                });
            }

            const productProfits = {};
            completedOrders.forEach(order => {
                 (order.items || []).forEach(item => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = item.name || 'منتج غير معروف';
                    const productName = tempDiv.textContent || tempDiv.innerText || "";
                    
                    const itemProfit = (order.profit || 0) / (order.items.length || 1);
                    
                    if (productProfits[productName]) {
                        productProfits[productName] += itemProfit;
                    } else {
                        productProfits[productName] = itemProfit;
                    }
                 });
            });

            const sortedProducts = Object.entries(productProfits)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 7);

            const topProductsLabels = sortedProducts.map(p => p[0]);
            const topProductsData = sortedProducts.map(p => p[1]);

            const topProductsCtx = getEl('topProductsChart')?.getContext('2d');
            if (topProductsCtx) {
                if (topProductsChart) topProductsChart.destroy();
                topProductsChart = new Chart(topProductsCtx, {
                    type: 'bar',
                    data: {
                        labels: topProductsLabels,
                        datasets: [{
                            label: 'إجمالي الربح',
                            data: topProductsData,
                            backgroundColor: 'rgba(153, 102, 255, 0.8)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'إجمالي الربح (د.ج)' } },
                            x: {}
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { label: function(context) { return `الربح: ${context.parsed.y.toLocaleString()} د.ج`; } } }
                        }
                    }
                });
        }}
        
        function loadCategories() {
            const panel = getEl('categories-panel');
            panel.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-gray-800">إدارة الأقسام</h1><button id="add-category-btn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i> إضافة قسم</button></div><div id="categories-list" class="space-y-4"></div>`;
            getEl('add-category-btn').addEventListener('click', () => showCategoryModal());
            const list = getEl('categories-list');
            
            onSnapshot(query(collection(db, "categories"), orderBy("orderIndex")), (snapshot) => {
                categoriesCache = [];
                list.innerHTML = snapshot.empty ? '<p class="text-center text-gray-500">لا توجد أقسام. أضف قسماً جديداً للبدء.</p>' : '';
                snapshot.forEach(doc => {
                    const category = { id: doc.id, ...doc.data() };
                    categoriesCache.push(category);
                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded-xl shadow-md border flex flex-col md:flex-row justify-between md:items-center';
                    
                    const subcatHtml = (category.subcategories || []).map(sub => 
                        `<span class="inline-block ${sub.active ? 'bg-green-100 text-green-800' : 'bg-gray-200 text-gray-700'} px-3 py-1 rounded-full text-sm mr-2 mb-2">
                            ${sub.name} <i class="fas ${sub.active ? 'fa-check' : 'fa-times'} ml-1"></i>
                        </span>`
                    ).join('');

                    el.innerHTML = `
                        <div>
                            <h4 class="text-xl font-bold">${category.name}</h4>
                            <div class="mt-2 pl-4">${subcatHtml || '<p class="text-sm text-gray-500">لا توجد فروع</p>'}</div>
                        </div>
                        <div class="mt-3 md:mt-0 flex-shrink-0">
                            <button class="edit-category-btn text-indigo-500 hover:text-indigo-700 mr-4" data-id="${category.id}"><i class="fas fa-edit"></i> تعديل</button>
                            <button class="delete-category-btn text-red-500 hover:text-red-700" data-id="${category.id}"><i class="fas fa-trash"></i> حذف</button>
                        </div>`;
                    list.appendChild(el);
                });
                attachCategoryActionListeners();
            });
        }
      function showCategoryModal(category = null) {
    const title = category ? 'تعديل القسم' : 'إضافة قسم جديد';
    
    // التأكد من أن كل فرع لديه ID فريد (مهم للتوافق مع البيانات القديمة)
    const subcategories = (category?.subcategories || []).map(sub => ({
        ...sub,
        id: sub.id || generateUniqueId() // أنشئ ID إذا لم يكن موجوداً
    }));

    let subcategoriesHtml = subcategories.map((sub) => `
        <div class="flex items-center gap-2 mb-2 subcategory-item" data-id="${sub.id}">
            <input type="text" class="w-full p-2 border rounded sub-name" value="${sub.name || ''}" placeholder="اسم الفرع">
            <label class="flex items-center gap-1 cursor-pointer text-sm">
                <input type="checkbox" class="sub-active" ${sub.active ? 'checked' : ''}> فعال
            </label>
            <button type="button" class="text-red-500 remove-sub-btn"><i class="fas fa-times-circle"></i></button>
        </div>
    `).join('');

    const content = `
        <div><label class="font-semibold">اسم القسم الرئيسي</label><input type="text" id="category-name" class="mt-1 w-full p-2 border rounded" value="${category ? category.name : ''}" required></div>
        <div class="mt-4"><label class="font-semibold">رقم الترتيب (الأصغر يظهر أولاً)</label><input type="number" id="category-order" class="mt-1 w-full p-2 border rounded" value="${category ? category.orderIndex || 0 : 0}"></div>
        <div class="mt-4">
            <label class="font-semibold">الفروع (Sub-categories)</label>
            <div id="subcategories-container" class="mt-2 space-y-2 bg-gray-50 p-3 rounded-md">${subcategoriesHtml}</div>
            <button type="button" id="add-subcategory-btn" class="text-sm mt-2 text-indigo-600 font-semibold hover:underline"><i class="fas fa-plus-circle mr-1"></i>إضافة فرع جديد</button>
        </div>`;

    showModal(title, content, async () => {
        const name = getVal('category-name').trim();
        const orderIndex = getInt('category-order') || 0;

        if (!name) { alert('الرجاء إدخال اسم القسم الرئيسي.'); return; }

        const subsData = [];
        document.querySelectorAll('.subcategory-item').forEach(item => {
            const subName = item.querySelector('.sub-name')?.value.trim();
            const subActive = item.querySelector('.sub-active')?.checked;
            // احصل على الـ ID القديم أو أنشئ واحداً جديداً
            const subId = item.dataset.id || generateUniqueId(); 
            if(subName) subsData.push({ id: subId, name: subName, active: subActive });
        });

        showLoadingModal();
        try {
            const data = { name, subcategories: subsData, orderIndex: orderIndex };
            if (category) await updateDoc(doc(db, "categories", category.id), data);
            else await addDoc(collection(db, "categories"), data);
            closeModal();
        } catch (error) {
            console.error("Error saving category:", error);
            alert("حدث خطأ أثناء الحفظ: " + error.message);
            closeModal();
        }
    });

    const addSubcategory = () => {
        const container = getEl('subcategories-container');
        const newItem = document.createElement('div');
        newItem.className = 'flex items-center gap-2 mb-2 subcategory-item';
        // عند إضافة فرع جديد، يتم إعطاؤه ID مباشرة
        newItem.dataset.id = generateUniqueId(); 
        newItem.innerHTML = `
            <input type="text" class="w-full p-2 border rounded sub-name" placeholder="اسم الفرع">
            <label class="flex items-center gap-1 cursor-pointer text-sm"><input type="checkbox" class="sub-active" checked> فعال</label>
            <button type="button" class="text-red-500 remove-sub-btn"><i class="fas fa-times-circle"></i></button>
        `;
        newItem.querySelector('.remove-sub-btn').onclick = () => newItem.remove();
        container.appendChild(newItem);
    };

    getEl('add-subcategory-btn').onclick = addSubcategory;
    document.querySelectorAll('.remove-sub-btn').forEach(btn => btn.onclick = (e) => e.currentTarget.closest('.subcategory-item').remove());
}








        function attachCategoryActionListeners() {
            document.querySelectorAll('.edit-category-btn').forEach(btn => {
                btn.onclick = () => {
                    const category = categoriesCache.find(c => c.id === btn.dataset.id);
                    if (category) showCategoryModal(category);
                };
            });
            document.querySelectorAll('.delete-category-btn').forEach(btn => {
                btn.onclick = async () => {
                     showDeleteConfirmationModal(async () => {
                        try {
                            await deleteDoc(doc(db, "categories", btn.dataset.id));
                            closeModal();
                        } catch (error) {
                             console.error("Error deleting category:", error);
                             showModal('خطأ', "حدث خطأ أثناء الحفظ: " + error.message, closeModal, 'موافق', false);
                        }
                    });
                };
            });
        }
        
        function loadProducts() {
            const panel = getEl('products-panel');
            panel.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-gray-800">إدارة المنتجات</h1><button id="add-product-btn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i> إضافة منتج</button></div>
            <div id="products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>`;

            getEl('add-product-btn').addEventListener('click', () => showProductTypeChoiceModal());
            
            const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
           
            onSnapshot(q, (snapshot) => {
                productsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProductsGrid();
                updateAnalytics();
            }, (error) => {
                console.error("Error fetching products in real-time: ", error);
                alert("حدث خطأ في تحديث قائمة المنتجات. قد تحتاج إلى تحديث الصفحة لرؤية التغييرات. المشكلة غالبًا بسبب فهرس ناقص في قاعدة البيانات، يرجى مراجعة الكونسول.");
            });
        }

        function renderProductsGrid() {
            const list = getEl('products-list');
            list.innerHTML = productsCache.length === 0 ? '<p class="text-center text-gray-500 col-span-full mt-8">لا توجد منتجات. أضف منتجاً جديداً للبدء.</p>' : '';
            
            productsCache.forEach(product => {
                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-xl shadow-md flex flex-col relative`;
                
                let availabilityBadge = '';
                switch(product.availability) {
                    case 'soon':
                        availabilityBadge = '<span class="absolute top-2 left-2 bg-yellow-500 text-white text-xs font-bold px-2 py-1 rounded-full">قريبًا إن شاء الله</span>';
                        break;
                    case 'sold_out':
                        availabilityBadge = '<span class="absolute top-2 left-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">نفذ المخزون</span>';
                        break;
                    default:
                        availabilityBadge = '<span class="absolute top-2 left-2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full">متوفر</span>';
                }

                let orderTypeBadge = '';
                if(product.orderMethod === 'direct') {
                    orderTypeBadge = '<span class="absolute top-2 right-2 bg-green-600 text-white text-xs font-bold px-2 py-1 rounded-full"><i class="fas fa-paper-plane mr-1"></i>طلب مباشر</span>';
                }

                const image = (product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls[0] : (product.imageUrl || 'https://placehold.co/300x160/e2e8f0/94a3b8?text=No+Image');

                let profitDisplay = '';
                if (product.profitType === 'percentage' && product.price && product.profitValue) {
                    const calculatedProfit = (product.price * product.profitValue) / 100;
                    profitDisplay = `<span class="text-xs text-green-600">الربح: ${calculatedProfit.toLocaleString()} د.ج</span>`;
                } else if (product.profitValue) {
                    profitDisplay = `<span class="text-xs text-green-600">الربح: ${product.profitValue.toLocaleString()} د.ج</span>`;
                }

                card.innerHTML = `
                    ${availabilityBadge}
                    ${orderTypeBadge}
                    <img src="${image}" class="w-full h-40 object-cover rounded-lg mb-4 bg-gray-100">
                    <div class="description-content font-bold text-xl mb-2">${product.name || ''}</div>
                    <div class="flex-grow text-gray-600 text-sm mb-3">${product.supplier ? `<i class="fas fa-user-tie fa-fw mr-1 text-gray-400"></i>${product.supplier}` : ''}</div>
                    <div class="flex justify-between items-center">
                        <p class="text-lg font-bold text-indigo-600">${(product.price || 0).toLocaleString()} د.ج</p>
                        ${profitDisplay}
                    </div>
                    <div class="border-t mt-4 pt-3 flex justify-end gap-2">
                        <button class="copy-product-link-btn text-gray-400 hover:text-green-600" data-id="${product.id}" title="نسخ رابط المنتج"><i class="fas fa-link"></i></button>
                        <button class="edit-product-btn text-gray-400 hover:text-indigo-600" data-id="${product.id}" title="تعديل"><i class="fas fa-edit"></i></button>
                        <button class="delete-product-btn text-gray-400 hover:text-red-600" data-id="${product.id}" title="حذف"><i class="fas fa-trash"></i></button>
                    </div>`;
                
                card.querySelector('.description-content').innerHTML = product.name || '';
                list.appendChild(card);
            });
            attachProductActionListeners();
        }






function populateSubcategories(categoryId, productSubCategoryInfo = null) {
    const subCategoryContainer = getEl('product-subcategory-container');
    const subCategorySelect = getEl('product-subcategory');
    if (!subCategoryContainer || !subCategorySelect) return;

    const selectedCategory = categoriesCache.find(c => c.id === categoryId);
    
    // تأكد أن كل فرع لديه ID قبل عرضه
    const allSubcategories = (selectedCategory?.subcategories || []).map(sub => ({
        ...sub,
        id: sub.id || generateUniqueId() // احترازي: أنشئ ID إذا لم يكن موجوداً
    }));

    const activeSubcategories = allSubcategories.filter(s => s.active);

    if (activeSubcategories.length > 0) {
        subCategorySelect.innerHTML = '<option value="">اختر فرع...</option>';
        activeSubcategories.forEach(sub => {
            // استخدم الـ ID الحقيقي والثابت 'sub.id'
            const isSelected = productSubCategoryInfo && sub.id === productSubCategoryInfo.id;
            subCategorySelect.innerHTML += `<option value="${sub.name}" data-id="${sub.id}" ${isSelected ? 'selected' : ''}>${sub.name}</option>`;
        });
        subCategoryContainer.classList.remove('hidden');
    } else {
        subCategoryContainer.classList.add('hidden');
        subCategorySelect.innerHTML = '';
    }
}
        async function uploadImageToImgBB(file) {
            const formData = new FormData();
            formData.append('image', file);
            formData.append('key', "ac296feb5a275923598bdbfd4f9aed8c");
            const response = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: formData });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`ImgBB upload failed with status ${response.status}: ${errorText}`);
            }
            const result = await response.json();
            if (result.success) return result.data.url;
            else throw new Error(`ImgBB Error: ${result.error.message}`);
        }
        
        function resizeAndCompressImage(file, maxWidth = 800, quality = 0.85) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let { width, height } = img;
                        if (width > maxWidth) {
                            const scale = maxWidth / width;
                            width = maxWidth;
                            height = height * scale;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob(blob => { 
                            if (!blob) {
                                reject(new Error("Canvas to Blob conversion failed"));
                                return;
                            }
                            resolve(new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() })); 
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = reject;
                };
                reader.onerror = error => reject(error);
            });
        }
        
        function showProductTypeChoiceModal() {
            const title = "إضافة منتج جديد";
            const content = `
                <p class="text-center text-lg text-gray-700 mb-6">اختر طريقة تسجيل المنتج التي تناسبك:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button id="add-traditional-product" class="text-center p-6 bg-blue-50 hover:bg-blue-100 rounded-lg border-2 border-blue-200 hover:border-blue-400 transition-all">
                        <i class="fas fa-shopping-cart text-5xl text-blue-500 mb-4"></i>
                        <h3 class="text-xl font-bold text-blue-800">منتج تقليدي</h3>
                        <p class="text-sm text-gray-600 mt-2">يضاف إلى السلة ويتم طلبه عبر الموقع.</p>
                    </button>
                    <button id="add-direct-product" class="text-center p-6 bg-green-50 hover:bg-green-100 rounded-lg border-2 border-green-200 hover:border-green-400 transition-all">
                        <i class="fas fa-paper-plane text-5xl text-green-500 mb-4"></i>
                        <h3 class="text-xl font-bold text-green-800">منتج بطلب مباشر</h3>
                        <p class="text-sm text-gray-600 mt-2">يتم طلبه عبر واتساب، فيسبوك، إلخ.</p>
                    </button>
                </div>
            `;
            showModal(title, content, null, '', false); 

            getEl('add-traditional-product').onclick = () => {
                closeModal();
                showProductModal('traditional');
            };
            getEl('add-direct-product').onclick = () => {
                closeModal();
                showProductModal('direct');
            };
            getEl('modal-confirm').parentElement.classList.add('hidden');
        }

        function showProductModal(productType, product = null) {
            const isDirectOrder = productType === 'direct';
            let title = '';
            if (product) {
                title = isDirectOrder ? 'تعديل منتج (طلب مباشر)' : 'تعديل منتج (تقليدي)';
            } else {
                title = isDirectOrder ? 'إضافة منتج بطلب مباشر' : 'إضافة منتج تقليدي';
            }
            
            const categoryOptions = categoriesCache.map(cat => `<option value="${cat.id}" ${product && product.categoryId === cat.id ? 'selected' : ''}>${cat.name}</option>`).join('');
            let existingImages = product ? (product.imageUrls || (product.imageUrl ? [product.imageUrl] : [])) : [];
            const existingImagesHTML = existingImages.map(url => `<div class="relative group"><img src="${url}" class="w-24 h-24 rounded object-cover border"><div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><span class="text-white text-xs text-center">سيتم حذفها عند رفع صور جديدة</span></div></div>`).join('');
            
            const shippingOptions = product?.shippingOptions || [];
            let shippingOptionsHTML = shippingOptions.map(opt => `
                <div class="flex items-center gap-2 mb-2 shipping-option-item">
                    <input type="text" class="w-full p-2 border rounded shipping-location" value="${opt.location || ''}" placeholder="اسم الموقع (مثال: الجزائر العاصمة)">
                    <input type="number" class="w-32 p-2 border rounded shipping-cost" value="${opt.cost || ''}" placeholder="السعر (د.ج)">
                    <button type="button" class="text-red-500 remove-shipping-btn"><i class="fas fa-times-circle"></i></button>
                </div>
            `).join('');
            
            let orderSpecificHTML = '';
            if (isDirectOrder) {
                orderSpecificHTML = `
                <div class="border-t pt-4 mt-4">
                    <h3 class="font-bold text-lg text-green-700 mb-2">روابط التواصل المباشر (مطلوبة)</h3>
                    <div class="mt-2 space-y-3 bg-green-50 p-4 rounded-lg border border-green-200">
                        <p class="text-sm text-gray-600">أدخل روابط التواصل التي ستظهر للزبون. اترك الحقل فارغاً إذا لم ترد عرضه.</p>
                        <div>
                            <label class="font-semibold text-sm flex items-center gap-2"><i class="fab fa-whatsapp text-green-500"></i> رقم واتساب</label>
                            <input type="text" id="contact-link-whatsapp" class="mt-1 w-full p-2 border rounded" dir="ltr" placeholder="213..." value="${product?.directContactLinks?.whatsapp || ''}">
                        </div>
                        <div>
                            <label class="font-semibold text-sm flex items-center gap-2"><i class="fab fa-facebook text-blue-600"></i> رابط فيسبوك</label>
                            <input type="url" id="contact-link-facebook" class="mt-1 w-full p-2 border rounded" placeholder="https://facebook.com/..." value="${product?.directContactLinks?.facebook || ''}">
                        </div>
                         <div>
                            <label class="font-semibold text-sm flex items-center gap-2"><i class="fab fa-instagram text-pink-500"></i> رابط انستغرام</label>
                            <input type="url" id="contact-link-instagram" class="mt-1 w-full p-2 border rounded" placeholder="https://instagram.com/..." value="${product?.directContactLinks?.instagram || ''}">
                        </div>
                        <div>
                            <label class="font-semibold text-sm flex items-center gap-2"><i class="fab fa-telegram text-sky-500"></i> رابط تيليجرام</label>
                            <input type="url" id="contact-link-telegram" class="mt-1 w-full p-2 border rounded" placeholder="https://t.me/..." value="${product?.directContactLinks?.telegram || ''}">
                        </div>
                         <div>
                            <label class="font-semibold text-sm flex items-center gap-2"><i class="fas fa-phone-alt text-teal-500"></i> رقم هاتف للاتصال</label>
                            <input type="tel" id="contact-link-phone" class="mt-1 w-full p-2 border rounded" dir="ltr" placeholder="0..." value="${product?.directContactLinks?.phone || ''}">
                        </div>
                    </div>
                </div>`;
            }

            const commonFields = `<div class="space-y-4">
                <div><label class="font-semibold">اسم المنتج</label><div id="product-name-editor" class="mt-1 bg-white"></div></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="font-semibold">السعر (د.ج)</label><input type="number" id="product-price" class="mt-1 w-full p-2 border rounded" value="${product?.price || ''}" required></div>
                    <div><label class="font-semibold">SKU / رمز المنتج</label><input type="text" id="product-sku" class="mt-1 w-full p-2 border rounded" value="${product?.sku || ''}" placeholder="رمز فريد للمنتج"></div>
                </div>
                <div>
                    <label class="font-semibold">حالة التوفر</label>
                    <select id="product-availability" class="w-full p-2 border rounded mt-1 bg-white">
                        <option value="available" ${!product || product.availability === 'available' ? 'selected' : ''}>متوفر</option>
                        <option value="soon" ${product?.availability === 'soon' ? 'selected' : ''}>قريبًا إن شاء الله</option>
                        <option value="sold_out" ${product?.availability === 'sold_out' ? 'selected' : ''}>نفذ المخزون</option>
                    </select>
                </div>
                <div><label class="font-semibold">الوصف</label><div id="product-description-editor" class="mt-1 bg-white" style="min-height: 150px;"></div></div>
                <div><label class="font-semibold">موقع المنتج (اختياري)</label><input type="text" id="product-location" class="mt-1 w-full p-2 border rounded" value="${product?.location || ''}" placeholder="مثال: مستودع الجزائر العاصمة"></div>
                
                <div class="border-t pt-4 mt-4">
                    <label class="font-semibold">أسعار التوصيل الخاصة بالمنتج (اختياري)</label>
                    <p class="text-sm text-gray-500 mb-2">إذا تركتها فارغة، سيتم تطبيق إعدادات الشحن العامة.</p>
                    <div id="shipping-options-container" class="space-y-2 bg-gray-50 p-3 rounded-md">${shippingOptionsHTML}</div>
                    <button type="button" id="add-shipping-option-btn" class="text-sm mt-2 text-indigo-600 font-semibold hover:underline"><i class="fas fa-plus-circle mr-1"></i>إضافة سعر توصيل لموقع جديد</button>
                </div>

                ${orderSpecificHTML}

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4 mt-4">
                    <div><label class="font-semibold text-gray-700">المورد (داخلي)</label><input type="text" id="product-supplier" class="mt-1 w-full p-2 border rounded" value="${product?.supplier || ''}" placeholder="اسم المورد أو الشركة"></div>
                    <div><label class="font-semibold text-gray-700">تواصل المورد (داخلي)</label><textarea id="product-supplier-contact" class="mt-1 w-full p-2 border rounded" rows="3" placeholder="أرقام الهواتف، الإيميل...">${product?.supplierContact || ''}</textarea></div>
                </div>
                <div><label class="font-semibold text-green-700">الربح من هذا المنتج (داخلي)</label><div class="flex items-center mt-1"><input type="number" id="product-profit-value" class="w-full p-2 border rounded-r-md" value="${product?.profitValue || ''}" placeholder="0"><select id="product-profit-type" class="p-2 border-l-0 border rounded-l-md bg-gray-100"><option value="fixed" ${product?.profitType === 'fixed' ? 'selected' : ''}>د.ج</option><option value="percentage" ${product?.profitType === 'percentage' ? 'selected' : ''}>%</option></select></div></div>
                <div><label class="font-semibold">القسم الرئيسي</label><select id="product-category-select" class="mt-1 w-full p-2 border rounded bg-white" required><option value="">اختر قسم...</option>${categoryOptions}</select></div>
                <div id="product-subcategory-container" class="hidden"><label class="font-semibold">الفرع</label><select id="product-subcategory" class="mt-1 w-full p-2 border rounded bg-white"></select></div>
                <div class="border-t pt-4"><label class="font-semibold">صور المنتج (يمكنك اختيار عدة صور)</label><input type="file" id="product-images" class="mt-1 w-full p-2 border rounded text-sm" accept="image/*" multiple>${product ? `<p class="text-sm text-gray-500 mt-1">الصور الحالية. رفع صور جديدة سيقوم باستبدالها.</p><div class="flex flex-wrap gap-2 mt-2">${existingImagesHTML}</div>` : ''}<div id="image-preview-container" class="flex flex-wrap gap-2 mt-2"></div></div>
            </div>`;

            let nameQuill, descriptionQuill;

            showModal(title, commonFields, async () => {
                let nameHTML = nameQuill.root.innerHTML.trim();
                let descriptionHTML = descriptionQuill.root.innerHTML.trim();
                if (nameHTML === '<p><br></p>') nameHTML = '';
                if (descriptionHTML === '<p><br></p>') descriptionHTML = '';
                
                const cleanName = DOMPurify.sanitize(nameHTML);
                const cleanDescription = DOMPurify.sanitize(descriptionHTML);

                const price = getNum('product-price');
                const categoryId = getVal('product-category-select');
                
                const shippingOptionsData = [];
                document.querySelectorAll('.shipping-option-item').forEach(item => {
                    const loc = item.querySelector('.shipping-location')?.value.trim();
                    const costVal = item.querySelector('.shipping-cost')?.value;
                    if (loc && costVal) {
                        const cost = parseFloat(costVal);
                        if (!isNaN(cost)) shippingOptionsData.push({ location: loc, cost });
                    }
                });

                if (!cleanName || isNaN(price) || !categoryId) {
                    return alert('يرجى ملء الحقول الإلزامية: اسم المنتج، السعر، والقسم الرئيسي.');
                }
                
                const directContactLinks = {
                    whatsapp: isDirectOrder ? getVal('contact-link-whatsapp').trim() : '',
                    facebook: isDirectOrder ? getVal('contact-link-facebook').trim() : '',
                    instagram: isDirectOrder ? getVal('contact-link-instagram').trim() : '',
                    telegram: isDirectOrder ? getVal('contact-link-telegram').trim() : '',
                    phone: isDirectOrder ? getVal('contact-link-phone').trim() : ''
                };

                if (isDirectOrder && Object.values(directContactLinks).every(link => !link)) {
                    return alert('لمنتجات الطلب المباشر، يجب إدخال وسيلة تواصل واحدة على الأقل.');
                }
                
                try {
                    const imageFiles = getEl('product-images')?.files || [];
                    let newImageUrls = [];
                    if (imageFiles.length === 0 && product) {
                        newImageUrls = product.imageUrls || (product.imageUrl ? [product.imageUrl] : []);
                    }
                    
                    if (imageFiles.length > 0) {
                        showLoadingModal(`جاري ضغط ورفع الصور (${imageFiles.length})...`);
                        const uploadPromises = Array.from(imageFiles).map(file => resizeAndCompressImage(file).then(uploadImageToImgBB));
                        newImageUrls = await Promise.all(uploadPromises);
                    }

                    if (newImageUrls.length === 0 && !product) {
                        return alert('يجب رفع صورة واحدة على الأقل للمنتج الجديد.');
                    }

                    showLoadingModal('جاري حفظ البيانات...');
                    
                    const subcatSelect = getEl('product-subcategory');
                    const selectedSubcatOption = subcatSelect && subcatSelect.selectedIndex > -1 ? subcatSelect.options[subcatSelect.selectedIndex] : null;
                    
                    const productData = {
                        name: cleanName,
                        price: price,
                        description: cleanDescription,
                        categoryId: categoryId,
                        imageUrls: newImageUrls,
                        availability: getVal('product-availability'),
                        sku: getVal('product-sku').trim(),
                        location: getVal('product-location').trim(),
                        subCategoryName: selectedSubcatOption ? selectedSubcatOption.value : null,
                        subCategoryID: selectedSubcatOption ? selectedSubcatOption.dataset.id : null,
                        supplier: getVal('product-supplier').trim(),
                        supplierContact: getVal('product-supplier-contact').trim(),
                        profitValue: getNum('product-profit-value') || 0,
                        profitType: getVal('product-profit-type'),
                        shippingOptions: shippingOptionsData,
                        orderMethod: productType,
                        directContactLinks: directContactLinks,
                        updatedAt: serverTimestamp()
                    };
                    
                    if (product) {
                        await updateDoc(doc(db, "products", product.id), productData);
                    } else {
                        productData.createdAt = serverTimestamp();
                        await addDoc(collection(db, "products"), productData);
                    }
                    
                    closeModal();
                } catch (error) {
                    showModal('خطأ فادح', `فشل حفظ المنتج: ${error.message}`, () => closeModal(), 'موافق', false);
                }
            });
            
            const fullToolbarOptions = [['bold', 'italic', 'underline', 'strike'],[{ 'list': 'ordered'}, { 'list': 'bullet' }],[{ 'align': [] }],[{ 'color': [] }, { 'background': [] }],['link'],['clean']];
            nameQuill = new Quill('#product-name-editor', { theme: 'snow', modules: { toolbar: [ ['bold', 'italic', 'underline'], [{ 'color': [] }] ] } });
            descriptionQuill = new Quill('#product-description-editor', { theme: 'snow', modules: { toolbar: fullToolbarOptions } });
            if (product) { if(product.name) nameQuill.root.innerHTML = product.name; if(product.description) descriptionQuill.root.innerHTML = product.description; }

            getEl('product-category-select').addEventListener('change', (e) => populateSubcategories(e.target.value));
            getEl('product-images').addEventListener('change', (e) => {
                const previewContainer = getEl('image-preview-container');
                previewContainer.innerHTML = '';
                Array.from(e.target.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const img = document.createElement('img');
                        img.src = ev.target.result;
                        img.className = 'w-24 h-24 rounded object-cover border';
                        previewContainer.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                });
            });

            const addShippingOption = () => {
                const container = getEl('shipping-options-container');
                const newItem = document.createElement('div');
                newItem.className = 'flex items-center gap-2 mb-2 shipping-option-item';
                newItem.innerHTML = `
                    <input type="text" class="w-full p-2 border rounded shipping-location" placeholder="اسم الموقع (مثال: وهران)">
                    <input type="number" class="w-32 p-2 border rounded shipping-cost" placeholder="السعر (د.ج)">
                    <button type="button" class="text-red-500 remove-shipping-btn"><i class="fas fa-times-circle"></i></button>
                `;
                newItem.querySelector('.remove-shipping-btn').onclick = () => newItem.remove();
                container.appendChild(newItem);
            };

            getEl('add-shipping-option-btn').onclick = addShippingOption;
            document.querySelectorAll('.remove-shipping-btn').forEach(btn => btn.onclick = (e) => e.currentTarget.closest('.shipping-option-item').remove());
            
            if (product?.categoryId) {
                populateSubcategories(product.categoryId, { id: product.subCategoryID });
            }
        }
        function attachProductActionListeners() {
            document.querySelectorAll('.edit-product-btn').forEach(btn => btn.onclick = () => {
                const productToEdit = productsCache.find(p => p.id === btn.dataset.id);
                if (productToEdit) {
                    const type = productToEdit.orderMethod || 'traditional'; 
                    showProductModal(type, productToEdit);
                }
            });

            document.querySelectorAll('.delete-product-btn').forEach(btn => {
                btn.onclick = async () => {
                    showDeleteConfirmationModal(async () => {
                        try {
                            await deleteDoc(doc(db, "products", btn.dataset.id));
                            closeModal();
                        } catch(error) {
                            showModal('خطأ',`فشل حذف المنتج: ${error.message}`, closeModal, 'موافق', false);
                        }
                    });
                }
            });
            document.querySelectorAll('.copy-product-link-btn').forEach(btn => btn.onclick = (e) => {
                const button = e.currentTarget;
const productUrl = `https://s22market.github.io/S22MARKET/index.html?product=${button.dataset.id}`;                navigator.clipboard.writeText(productUrl).then(() => {
                    const originalIcon = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check text-green-500"></i>'; 
                    setTimeout(() => { button.innerHTML = originalIcon; }, 2000);
                });
            });
        }
        
        // [+] START: NEW FUNCTIONS FOR OFFERS MANAGEMENT
        function loadOffers() {
            const panel = getEl('offers-panel');
            panel.innerHTML = `<div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">إدارة العروض</h1>
                <button id="add-offer-btn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-indigo-700">
                    <i class="fas fa-plus mr-2"></i> إضافة عرض
                </button>
            </div>
            <div id="offers-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>`;
            
            getEl('add-offer-btn').addEventListener('click', () => showOfferModal());

            onSnapshot(query(collection(db, "offers"), orderBy("createdAt", "desc")), (snapshot) => {
                offersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOffersGrid();
            });
        }

        function renderOffersGrid() {
            const list = getEl('offers-list');
            list.innerHTML = offersCache.length === 0 ? '<p class="text-center text-gray-500 col-span-full mt-8">لا توجد عروض. أضف عرضاً جديداً للبدء.</p>' : '';
            
            offersCache.forEach(offer => {
                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-xl shadow-md flex flex-col`;
                
                const image = offer.imageUrl || 'https://placehold.co/300x160/e2e8f0/94a3b8?text=No+Image';

                card.innerHTML = `
                    <img src="${image}" class="w-full h-40 object-cover rounded-lg mb-4 bg-gray-100">
                    <h3 class="font-bold text-xl mb-2">${offer.title}</h3>
                    <p class="flex-grow text-gray-600 text-sm mb-3">${offer.description || ''}</p>
                    <p class="text-lg font-bold text-indigo-600">${(offer.price || 0).toLocaleString()} د.ج</p>
                    <div class="border-t mt-4 pt-3 flex justify-end gap-2">
                        <button class="edit-offer-btn text-gray-400 hover:text-indigo-600" data-id="${offer.id}" title="تعديل"><i class="fas fa-edit"></i></button>
                        <button class="delete-offer-btn text-gray-400 hover:text-red-600" data-id="${offer.id}" title="حذف"><i class="fas fa-trash"></i></button>
                    </div>`;
                list.appendChild(card);
            });
            attachOfferActionListeners();
        }

        function showOfferModal(offer = null) {
            const title = offer ? 'تعديل العرض' : 'إضافة عرض جديد';
            const content = `<div class="space-y-4">
                <div><label class="font-semibold">عنوان العرض</label><input type="text" id="offer-title" class="mt-1 w-full p-2 border rounded" value="${offer?.title || ''}" required></div>
                <div><label class="font-semibold">وصف العرض</label><textarea id="offer-description" class="mt-1 w-full p-2 border rounded" rows="3">${offer?.description || ''}</textarea></div>
                <div><label class="font-semibold">سعر العرض (د.ج)</label><input type="number" id="offer-price" class="mt-1 w-full p-2 border rounded" value="${offer?.price || ''}" required></div>
                <div class="border-t pt-4">
                    <label class="font-semibold">صورة العرض</label>
                    <input type="file" id="offer-image" class="mt-1 w-full p-2 border rounded text-sm" accept="image/*">
                    ${offer ? `<p class="text-sm text-gray-500 mt-1">الصورة الحالية. رفع صورة جديدة سيقوم باستبدالها.</p><div class="flex flex-wrap gap-2 mt-2"><img src="${offer.imageUrl}" class="w-24 h-24 rounded object-cover border"></div>` : ''}
                    <div id="offer-image-preview" class="flex flex-wrap gap-2 mt-2"></div>
                </div>
            </div>`;

            showModal(title, content, async () => {
                const offerTitle = getVal('offer-title').trim();
                const offerPrice = getNum('offer-price');

                if (!offerTitle || isNaN(offerPrice)) {
                    return alert('يرجى ملء عنوان العرض وسعره.');
                }

                try {
                    const imageFile = getEl('offer-image')?.files[0];
                    let imageUrl = offer?.imageUrl || null;

                    if (imageFile) {
                        showLoadingModal('جاري ضغط ورفع الصورة...');
                        const compressedFile = await resizeAndCompressImage(imageFile);
                        imageUrl = await uploadImageToImgBB(compressedFile);
                    }
                    
                    if (!imageUrl && !offer) {
                         return alert('يجب رفع صورة للعرض الجديد.');
                    }

                    showLoadingModal('جاري حفظ البيانات...');
                    
                    const offerData = {
                        title: offerTitle,
                        description: getVal('offer-description').trim(),
                        price: offerPrice,
                        imageUrl: imageUrl,
                        updatedAt: serverTimestamp()
                    };
                    
                    if (offer) {
                        await updateDoc(doc(db, "offers", offer.id), offerData);
                    } else {
                        offerData.createdAt = serverTimestamp();
                        await addDoc(collection(db, "offers"), offerData);
                    }
                    closeModal();
                } catch (error) {
                    showModal('خطأ فادح', `فشل حفظ العرض: ${error.message}`, () => closeModal(), 'موافق', false);
                }
            });

            getEl('offer-image').addEventListener('change', (e) => {
                const previewContainer = getEl('offer-image-preview');
                previewContainer.innerHTML = '';
                if (e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const img = document.createElement('img');
                        img.src = ev.target.result;
                        img.className = 'w-24 h-24 rounded object-cover border';
                        previewContainer.appendChild(img);
                    }
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
        }

        function attachOfferActionListeners() {
            document.querySelectorAll('.edit-offer-btn').forEach(btn => btn.onclick = () => {
                const offerToEdit = offersCache.find(o => o.id === btn.dataset.id);
                if (offerToEdit) showOfferModal(offerToEdit);
            });

            document.querySelectorAll('.delete-offer-btn').forEach(btn => {
                btn.onclick = async () => {
                    showDeleteConfirmationModal(async () => {
                        try {
                            await deleteDoc(doc(db, "offers", btn.dataset.id));
                            closeModal();
                        } catch(error) {
                            showModal('خطأ',`فشل حذف العرض: ${error.message}`, closeModal, 'موافق', false);
                        }
                    });
                }
            });
        }
        // [-] END: NEW FUNCTIONS FOR OFFERS MANAGEMENT

        function loadOrders() {
            const panel = getEl('orders-panel');
            panel.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">الطلبات الواردة</h1>
                       <div class="overflow-x-auto bg-white rounded-xl shadow-md">
                         <table class="w-full text-right responsive-table">
                           <thead class="bg-gray-100">
                             <tr>
                               <th class="p-3 font-semibold">العميل</th><th class="p-3 font-semibold">الهاتف</th><th class="p-3 font-semibold">الموقع</th>
                               <th class="p-3 font-semibold">نوع التوصيل</th><th class="p-3 font-semibold">المنتجات</th><th class="p-3 font-semibold">المبلغ</th>
                               <th class="p-3 font-semibold">الربح</th><th class="p-3 font-semibold">ملاحظات</th><th class="p-3 font-semibold">الحالة</th>
                               <th class="p-3 font-semibold">تمت بواسطة</th><th class="p-3 font-semibold">الموردون</th><th class="p-3 font-semibold">التاريخ</th>
                               <th class="p-3 font-semibold">إجراءات</th>
                             </tr>
                           </thead>
                           <tbody id="orders-table-body"></tbody>
                         </table>
                       </div>`;
            const tableBody = getEl('orders-table-body');
            
            onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), (snapshot) => {
                ordersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                tableBody.innerHTML = snapshot.empty ? `<tr><td colspan="13" class="p-8 text-center text-gray-500">لا توجد طلبات حاليًا.</td></tr>` : '';

                ordersCache.forEach(order => {
                    const date = order.createdAt?.toDate().toLocaleDateString('ar-EG-u-nu-latn', { year: 'numeric', month: 'short', day: 'numeric' }) || 'N/A';
                    const statusColor = order.status === 'completed' ? 'bg-green-100 text-green-800' : (order.status === 'canceled' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800');
                    const rowColor = order.status === 'completed' ? 'bg-green-50/50' : (order.status === 'canceled' ? 'bg-red-50/50' : 'bg-white');
                    const product = productsCache.find(p => p.id === (order.items && order.items[0] ? order.items[0].id : null));
                    
                    let defaultProfit = ''; let defaultSupplierInfo = '';
                    if (product) {
                        if (order.profit === undefined || order.profit === null) {
                            const orderQuantity = (order.items || []).reduce((sum, item) => sum + item.quantity, 0);
                            if (product.profitType === 'percentage' && product.price && product.profitValue) defaultProfit = ((product.price * product.profitValue) / 100) * orderQuantity;
                            else if (product.profitType === 'fixed' && product.profitValue) defaultProfit = product.profitValue * orderQuantity;
                        }
                        if (!order.suppliers) defaultSupplierInfo = [product.supplier, product.supplierContact].filter(Boolean).join(' - ');
                    }

                    let deliveryDisplay = order.deliveryPreference === 'Home' ? '<span class="text-blue-600 font-semibold"><i class="fas fa-home mr-1"></i> للمنزل</span>' : (order.deliveryPreference === 'Office' ? '<span class="text-purple-600 font-semibold"><i class="fas fa-building mr-1"></i> للمكتب</span>' : '---');
                    const itemsHtml = (order.items || []).map(item => `<div>${item.quantity} x ${item.name}</div>`).join('');
                    
                    const totalPriceDisplay = order.shippingCost ? `${order.totalPrice.toLocaleString()} د.ج (شامل توصيل ${order.shippingCost.toLocaleString()} د.ج)` : `${(order.totalPrice || 0).toLocaleString()} د.ج`;

                    const row = tableBody.insertRow();
                    row.className = `border-b ${rowColor} transition-colors`;
                    row.innerHTML = `
                        <td data-label="العميل" class="p-3 font-semibold">${order.customerName}</td><td data-label="الهاتف" class="p-3 font-mono" dir="ltr"><a href="tel:${order.customerContact}" class="hover:underline">${order.customerContact}</a></td>
                        <td data-label="الموقع" class="p-3 text-sm font-medium">${order.customerLocation || '---'}</td><td data-label="نوع التوصيل" class="p-3 text-sm">${deliveryDisplay}</td>
                        <td data-label="المنتجات" class="p-3 text-sm">${itemsHtml}</td><td data-label="المبلغ" class="p-3 font-mono">${totalPriceDisplay}</td>
                        <td data-label="الربح" class="p-3"><input type="number" class="profit-input w-24 p-1 border rounded text-center font-mono transition-colors" placeholder="0" value="${order.profit ?? defaultProfit}" data-id="${order.id}"></td>
                        <td data-label="ملاحظات" class="p-3 text-sm text-gray-600">${order.customerInquiry || '---'}</td>
                        <td data-label="الحالة" class="p-3 actions-cell"><select class="order-status-select p-2 rounded-lg border-gray-300 ${statusColor}" data-id="${order.id}"><option value="new" ${order.status === 'new' ? 'selected' : ''}>جديد</option><option value="completed" ${order.status === 'completed' ? 'selected' : ''}>مكتمل</option><option value="canceled" ${order.status === 'canceled' ? 'selected' : ''}>ملغي</option></select></td>
                        <td data-label="تمت بواسطة" class="p-3"><input type="text" class="doneBy-input w-full p-2 border rounded transition-colors" placeholder="اكتب هنا..." value="${order.doneBy || ''}" data-id="${order.id}"></td>
                        <td data-label="الموردون" class="p-3"><textarea rows="4" class="suppliers-textarea w-full p-2 border rounded transition-colors" placeholder="اكتب هنا..." maxlength="500" data-id="${order.id}">${order.suppliers ?? defaultSupplierInfo}</textarea></td>
                        <td data-label="التاريخ" class="p-3 font-mono text-sm">${date}</td>
                        <td data-label="إجراءات" class="p-3 actions-cell"><button class="copy-order-btn text-blue-500 hover:text-blue-700 mr-2" data-id="${order.id}" title="نسخ معلومات الطلب للمورد"><i class="fas fa-copy fa-lg"></i></button><button class="delete-order-btn text-red-500 hover:text-red-700" data-id="${order.id}"><i class="fas fa-trash fa-lg"></i></button></td>`;
                });
                attachOrderActionListeners();
                updateAnalytics(); 
            });
        }
        function attachOrderActionListeners() {
            document.querySelectorAll('.order-status-select').forEach(select => select.onchange = async (e) => await updateDoc(doc(db, "orders", e.target.dataset.id), { status: e.target.value }));
            const addDebouncedListener = (selector, fieldName, isNumeric = false) => {
                document.querySelectorAll(selector).forEach(input => {
                    let debounceTimer;
                    input.onkeyup = (e) => {
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(async () => {
                            const id = e.target.dataset.id;
                            let value = e.target.value;
                            if (isNumeric) value = parseFloat(value) || 0;
                            try { await updateDoc(doc(db, "orders", id), { [fieldName]: value }); e.target.classList.add('border-green-400'); setTimeout(() => e.target.classList.remove('border-green-400'), 2000); }
                            catch (error) { e.target.classList.add('border-red-400'); }
                        }, 1000);
                    };
                });
            };
            addDebouncedListener('.profit-input', 'profit', true); addDebouncedListener('.doneBy-input', 'doneBy'); addDebouncedListener('.suppliers-textarea', 'suppliers');
            document.querySelectorAll('.copy-order-btn').forEach(btn => btn.onclick = (e) => {
                const order = ordersCache.find(o => o.id === e.currentTarget.dataset.id); if (!order) return;
                const itemsText = (order.items || []).map(item => `   - ${item.quantity} x ${item.name}`).join('\n');
                const deliveryPreferenceText = order.deliveryPreference === 'Home' ? 'المنزل' : (order.deliveryPreference === 'Office' ? 'المكتب' : 'غير محدد');
                const finalPriceText = order.shippingCost ? `${order.totalPrice.toLocaleString()} د.ج (شامل التوصيل)` : `${order.totalPrice.toLocaleString()} د.ج`;
                const messageToCopy = `السلام عليكم ورحمة الله تعالى وبركاته\n\n📋 **معلومات الطلبية** 📋\n\n👤 **اسم العميل:** ${order.customerName}\n📞 **رقم الهاتف:** ${order.customerContact}\n📦 **المنتج:**\n${itemsText}\n📍 **العنوان:** ${order.customerLocation}\n🚚 **التوصيل إلى:** ${deliveryPreferenceText}\n💰 **السعر الإجمالي:** ${finalPriceText}`.trim();
                navigator.clipboard.writeText(messageToCopy).then(() => {
                    const originalIcon = e.currentTarget.innerHTML;
                    e.currentTarget.innerHTML = '<i class="fas fa-check text-green-500 fa-lg"></i>';
                    setTimeout(() => { e.currentTarget.innerHTML = originalIcon; }, 2500);
                });
            });
            document.querySelectorAll('.delete-order-btn').forEach(btn => {
                btn.onclick = () => {
                     showDeleteConfirmationModal(async () => {
                        try {
                            await deleteDoc(doc(db, "orders", btn.dataset.id));
                            closeModal();
                        } catch(error) {
                            showModal('خطأ',`فشل حذف الطلب: ${error.message}`, closeModal, 'موافق', false);
                        }
                    });
                }
            });
        }
        
        function loadCoupons() {
            const panel = getEl('coupons-panel');
            panel.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">إدارة الكوبونات</h1><button id="add-coupon-btn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i> إضافة كوبون</button></div>
                <div class="overflow-x-auto bg-white rounded-xl shadow-md">
                <table class="w-full text-right responsive-table"><thead class="bg-gray-100"><tr>
                    <th class="p-3">الكود</th><th class="p-3">نوع/قيمة التخفيض</th><th class="p-3">الحالة</th>
                    <th class="p-3">الاستخدام</th><th class="p-3">مرات النسخ</th><th class="p-3">فترة الصلاحية</th><th class="p-3">إجراءات</th>
                </tr></thead><tbody id="coupons-table-body"></tbody></table></div>`;
            getEl('add-coupon-btn').onclick = () => showCouponModal();
            onSnapshot(query(collection(db, "coupons"), orderBy("createdAt", "desc")), snapshot => {
                couponsCache = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderCouponsTable();
            });
        }
        function renderCouponsTable() {
            const tBody = getEl('coupons-table-body');
            tBody.innerHTML = couponsCache.length === 0 ? `<tr><td colspan="7" class="p-8 text-center">لم تقم بإضافة أي كوبونات بعد.</td></tr>` : '';
            
            couponsCache.forEach(coupon => {
                const now = new Date();
                const startDate = coupon.startsAt?.toDate();
                const expiryDate = coupon.expiresAt?.toDate();
                
                let statusText, statusClass;
                if (!coupon.isActive) {
                    statusText = 'معطل'; statusClass = 'bg-gray-200 text-gray-800';
                } else if (startDate && startDate > now) {
                    statusText = 'لم يبدأ بعد'; statusClass = 'bg-blue-100 text-blue-800';
                } else if (expiryDate && expiryDate < now) {
                    statusText = 'منتهي'; statusClass = 'bg-red-100 text-red-800';
                } else if (coupon.usageLimit && (coupon.usageCount || 0) >= coupon.usageLimit) {
                    statusText = 'استنفذ'; statusClass = 'bg-yellow-100 text-yellow-800';
                } else {
                    statusText = 'نشط'; statusClass = 'bg-green-100 text-green-800';
                }

                const discountText = coupon.discountType === 'percentage' ? `${coupon.discountValue}%` : `${(coupon.discountValue || 0).toLocaleString()} د.ج`;
                const validityText = `${startDate ? startDate.toLocaleDateString('ar-EG') : 'فوراً'} - ${expiryDate ? expiryDate.toLocaleDateString('ar-EG') : 'بلا نهاية'}`;
                const usageText = `${coupon.usageCount || 0}${coupon.usageLimit ? ` / ${coupon.usageLimit}` : ''}`;
                const copyCountText = `${coupon.copyCount || 0} مرة`;

                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td data-label="الكود" class="p-3 font-mono font-bold">${coupon.code}</td>
                    <td data-label="التخفيض" class="p-3">${discountText}</td>
                    <td data-label="الحالة" class="p-3"><span class="px-2 py-1 text-sm font-semibold rounded-full ${statusClass}">${statusText}</span></td>
                    <td data-label="الاستخدام" class="p-3">${usageText}</td>
                    <td data-label="مرات النسخ" class="p-3">${copyCountText}</td>
                    <td data-label="الصلاحية" class="p-3 font-mono text-sm">${validityText}</td>
                    <td data-label="إجراءات" class="p-3 actions-cell">
                        <button class="edit-coupon-btn text-indigo-500 hover:text-indigo-700 mr-4" data-id="${coupon.id}"><i class="fas fa-edit"></i></button>
                        <button class="delete-coupon-btn text-red-500 hover:text-red-700" data-id="${coupon.id}"><i class="fas fa-trash"></i></button>
                    </td>`;
                tBody.appendChild(row);
            });

            document.querySelectorAll('.edit-coupon-btn').forEach(btn => btn.onclick = e => showCouponModal(couponsCache.find(c => c.id === e.currentTarget.dataset.id)));
            document.querySelectorAll('.delete-coupon-btn').forEach(btn => btn.onclick = e => {
                showDeleteConfirmationModal(async () => {
                    try {
                        await deleteDoc(doc(db, "coupons", e.currentTarget.dataset.id));
                        closeModal();
                    } catch(error) {
                         showModal('خطأ', `فشل حذف الكوبون: ${error.message}`, closeModal, 'موافق', false);
                    }
                });
            });
        }
        function showCouponModal(coupon = null) {
            const tempDiv = document.createElement('div');
            const productOptions = productsCache.map(p => {
                tempDiv.innerHTML = p.name;
                const productName = tempDiv.textContent || tempDiv.innerText || "";
                return `<option value="${p.id}">${productName}</option>`;
            }).join('');
            const content = `<div class="space-y-4">
                <input type="text" id="coupon-code" placeholder="كود التخفيض (مثال: SAVE10)" class="w-full p-2 border rounded uppercase" value="${coupon?.code || ''}">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="font-semibold text-sm">نوع التخفيض</label><select id="coupon-type" class="w-full p-2 mt-1 border rounded bg-white"><option value="percentage" ${coupon?.discountType === 'percentage' ? 'selected' : ''}>نسبة مئوية (%)</option><option value="fixed" ${coupon?.discountType === 'fixed' ? 'selected' : ''}>مبلغ ثابت (د.ج)</option></select></div>
                    <div><label class="font-semibold text-sm">قيمة التخفيض</label><input type="number" id="coupon-value" placeholder="مثال: 10 أو 100" class="w-full p-2 mt-1 border rounded" value="${coupon?.discountValue || ''}"></div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="font-semibold text-sm">تاريخ بداية الصلاحية (اختياري)</label><input type="date" id="coupon-start" class="w-full p-2 mt-1 border rounded" value="${coupon?.startsAt ? coupon.startsAt.toDate().toISOString().split('T')[0] : ''}"></div>
                    <div><label class="font-semibold text-sm">تاريخ انتهاء الصلاحية (اختياري)</label><input type="date" id="coupon-expiry" class="w-full p-2 mt-1 border rounded" value="${coupon?.expiresAt ? coupon.expiresAt.toDate().toISOString().split('T')[0] : ''}"></div>
                </div>
                 <div><label class="font-semibold text-sm">الحد الأقصى لمرات الاستخدام (اختياري)</label><input type="number" id="coupon-usage-limit" placeholder="اتركه فارغاً للاستخدام غير المحدود" class="w-full p-2 mt-1 border rounded" value="${coupon?.usageLimit || ''}"></div>
                <div><label class="font-semibold text-sm">على ماذا يطبق الكوبون؟</label><select id="coupon-applies-to" class="w-full p-2 mt-1 border rounded bg-white"><option value="all" ${coupon?.appliesTo === 'all' ? 'selected' : ''}>كل المنتجات</option><option value="specific_products" ${coupon?.appliesTo === 'specific_products' ? 'selected' : ''}>منتجات محددة</option></select></div>
                <div id="coupon-products-container" class="hidden"><label class="font-semibold text-sm">اختر المنتجات</label><select id="coupon-products" multiple class="w-full p-2 mt-1 border rounded bg-white h-32">${productOptions}</select></div>
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg"><label for="coupon-active-toggle" class="font-semibold">تفعيل الكوبون</label><label class="toggle-switch"><input type="checkbox" id="coupon-active-toggle" ${coupon?.isActive !== false ? 'checked' : ''}><span class="slider"></span></label></div>
            </div>`;

            showModal(coupon ? 'تعديل كوبون' : 'إضافة كوبون', content, async () => {
                const startDate = getVal('coupon-start');
                const expiryDate = getVal('coupon-expiry');
                const discountValue = getNum('coupon-value');
                const appliesTo = getVal('coupon-applies-to');

                const data = {
                    code: getVal('coupon-code').trim().toUpperCase(),
                    discountType: getVal('coupon-type'),
                    discountValue: discountValue,
                    startsAt: startDate ? Timestamp.fromDate(new Date(startDate)) : null,
                    expiresAt: expiryDate ? Timestamp.fromDate(new Date(expiryDate)) : null,
                    usageLimit: getInt('coupon-usage-limit') || null,
                    appliesTo: appliesTo,
                    productIds: appliesTo === 'specific_products' ? Array.from(getEl('coupon-products').selectedOptions).map(opt => opt.value) : [],
                    isActive: getChecked('coupon-active-toggle'),
                    updatedAt: serverTimestamp()
                };
                if(!data.code || isNaN(data.discountValue)) return alert('الرجاء إدخال الكود وقيمة التخفيض.');
                if(data.appliesTo === 'specific_products' && data.productIds.length === 0) return alert('الرجاء اختيار منتج واحد على الأقل.');
                
                showLoadingModal();
                try {
                    if (coupon) await updateDoc(doc(db, "coupons", coupon.id), data);
                    else { data.createdAt = serverTimestamp(); data.usageCount = 0; data.copyCount = 0; await addDoc(collection(db, "coupons"), data); }
                    closeModal();
                } catch(error) {
                     showModal('خطأ فادح', `فشل حفظ الكوبون: ${error.message}`, () => closeModal(), 'موافق', false);
                }
            });

            const appliesToSelect = getEl('coupon-applies-to');
            const productsContainer = getEl('coupon-products-container');
            const toggleProducts = () => productsContainer.classList.toggle('hidden', appliesToSelect.value !== 'specific_products');
            appliesToSelect.onchange = toggleProducts;
            if (coupon?.appliesTo === 'specific_products' && coupon.productIds) {
                coupon.productIds.forEach(id => { const option = document.querySelector(`#coupon-products option[value="${id}"]`); if (option) option.selected = true; });
            }
            toggleProducts();
        }

        function loadInquiries() { 
            const panel = getEl('inquiries-panel'); 
            panel.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">الرسائل والطلبات الواردة</h1><div class="overflow-x-auto bg-white rounded-xl shadow-md"><table class="w-full text-right responsive-table"><thead class="bg-gray-100"><tr><th class="p-4">النوع</th><th class="p-4">الرسالة/الطلب</th><th class="p-4">معلومات التواصل</th><th class="p-4">المشرف</th><th class="p-4">الحالة</th><th class="p-4">التاريخ</th><th class="p-4">إجراءات</th></tr></thead><tbody id="inquiries-table-body"></tbody></table></div>`; 
            onSnapshot(query(collection(db, "inquiries"), orderBy("createdAt", "desc")), (snapshot) => { 
                const tableBody = getEl('inquiries-table-body'); 
                tableBody.innerHTML = snapshot.empty ? `<tr><td colspan="7" class="p-8 text-center text-gray-500">لا توجد رسائل حاليًا.</td></tr>` : ''; 
                snapshot.forEach(doc => { 
                    const inquiry = { id: doc.id, ...doc.data() }; 
                    const date = inquiry.createdAt?.toDate().toLocaleString('ar-EG', { dateStyle: 'medium', timeStyle: 'short' }); 
                    let typeText = inquiry.type === 'product' ? '📝 طلب منتج' : '🚩 شكوى/رأي'; let typeColor = inquiry.type === 'product' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800';
                    let rowClass = 'bg-white font-semibold'; let statusColorClass = 'bg-yellow-100 text-yellow-800'; 
                    if (inquiry.status === 'قيد الإجراء') { rowClass = 'bg-indigo-50'; statusColorClass = 'bg-indigo-100 text-indigo-800'; }
                    else if (inquiry.status === 'تمت المعالجة') { rowClass = 'bg-green-50 text-gray-600'; statusColorClass = 'bg-green-100 text-green-800'; }
                    let contactHTML = `<div><strong>الاسم:</strong> ${inquiry.fullName}</div>${inquiry.phone ? `<div><i class="fas fa-phone fa-fw mr-1"></i> ${inquiry.phone}</div>` : ''}${inquiry.contactLink ? `<div><a href="${inquiry.contactLink}" target="_blank" class="text-blue-600 hover:underline"><i class="fas fa-external-link-alt fa-fw mr-1"></i> رابط التواصل</a></div>` : ''}`;
                    const row = tableBody.insertRow(); 
                    row.className = `border-b ${rowClass} hover:bg-gray-50 transition-colors`; 
                    row.innerHTML = `<td data-label="النوع" class="p-4"><span class="px-3 py-1 rounded-full text-sm ${typeColor}">${typeText}</span></td><td data-label="الرسالة" class="p-4" style="white-space: pre-wrap; max-width: 350px;">${inquiry.message}</td><td data-label="التواصل" class="p-4 text-sm">${contactHTML}</td><td data-label="المشرف" class="p-4"><input type="text" class="supervisor-input w-full p-2 border rounded-md" value="${inquiry.supervisor || ''}" data-id="${inquiry.id}"></td><td data-label="الحالة" class="p-4"><select class="inquiry-status-select w-full p-2 rounded-lg border-gray-300 ${statusColorClass}" data-id="${inquiry.id}"><option value="جديد" ${inquiry.status === 'جديد' ? 'selected' : ''}>جديد</option><option value="قيد الإجراء" ${inquiry.status === 'قيد الإجراء' ? 'selected' : ''}>قيد الإجراء</option><option value="تمت المعالجة" ${inquiry.status === 'تمت المعالجة' ? 'selected' : ''}>تمت المعالجة</option></select></td><td data-label="التاريخ" class="p-4 text-sm text-gray-500">${date}</td><td data-label="إجراءات" class="p-4"><button class="delete-inquiry-btn text-gray-400 hover:text-red-600" data-id="${inquiry.id}"><i class="fas fa-trash fa-lg"></i></button></td>`; 
                }); 
                attachInquiryActionListeners(); 
            }); 
        } 
        function attachInquiryActionListeners() { 
            document.querySelectorAll('.inquiry-status-select').forEach(select => select.onchange = async (e) => await updateDoc(doc(db, "inquiries", e.target.dataset.id), { status: e.target.value })); 
            document.querySelectorAll('.supervisor-input').forEach(input => input.addEventListener('change', async (e) => await updateDoc(doc(db, "inquiries", e.target.dataset.id), { supervisor: e.target.value.trim() })));
            document.querySelectorAll('.delete-inquiry-btn').forEach(btn => btn.onclick = async () => { 
                showDeleteConfirmationModal(async () => {
                    await deleteDoc(doc(db, "inquiries", btn.dataset.id));
                    closeModal();
                });
            }); 
        }

        function loadApplications() {
            const panel = getEl('applications-panel');
            panel.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-gray-800">إدارة التطبيقات</h1><button id="add-app-btn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i> إضافة تطبيق</button></div>
            <div class="overflow-x-auto"><table class="w-full text-right responsive-table"><thead class="bg-gray-100"><tr><th class="p-3">الأيقونة</th><th class="p-3">الاسم</th><th class="p-3">رابط التحميل (Android)</th><th class="p-3">رابط التحميل (iPhone)</th><th class="p-3">إجراءات</th></tr></thead><tbody id="apps-table-body"></tbody></table></div>`;
            getEl('add-app-btn').addEventListener('click', () => showApplicationModal());
            onSnapshot(query(collection(db, "applications"), orderBy("createdAt", "desc")), (snapshot) => {
                applicationsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const tableBody = getEl('apps-table-body');
                tableBody.innerHTML = snapshot.empty ? '<tr><td colspan="5" class="p-8 text-center text-gray-500">لا توجد تطبيقات.</td></tr>' : '';
                applicationsCache.forEach(app => {
                    const row = tableBody.insertRow();
                    row.className = 'border-b bg-white';
                    row.innerHTML = `<td data-label="الأيقونة" class="p-3"><img src="${app.iconUrl || ''}" alt="${app.name}" class="w-16 h-16 object-cover rounded-md"></td><td data-label="الاسم" class="p-3 font-semibold">${app.name}</td><td data-label="Android" class="p-3"><a href="${app.apkUrl || '#'}" target="_blank" class="text-blue-600 hover:underline">${app.apkUrl ? 'رابط مباشر' : '---'}</a></td><td data-label="iPhone" class="p-3"><a href="${app.iosUrl || '#'}" target="_blank" class="text-blue-600 hover:underline">${app.iosUrl ? 'رابط AppStore' : '---'}</a></td><td data-label="إجراءات" class="p-3 actions-cell"><button class="edit-app-btn text-indigo-500 hover:text-indigo-700 mr-4" data-id="${app.id}"><i class="fas fa-edit fa-lg"></i></button><button class="delete-app-btn text-red-500 hover:text-red-700" data-id="${app.id}"><i class="fas fa-trash fa-lg"></i></button></td>`;
                });
                attachApplicationActionListeners();
            });
        }
        function showApplicationModal(app = null) {
            const title = app ? 'تعديل التطبيق' : 'إضافة تطبيق جديد';
            const content = `<div class="space-y-4"><div><label class="font-semibold">اسم التطبيق</label><input type="text" id="app-name" class="mt-1 w-full p-2 border rounded" value="${app?.name || ''}" required></div><div><label class="font-semibold">الوصف</label><textarea id="app-description" class="mt-1 w-full p-2 border rounded" rows="4">${app?.description || ''}</textarea></div><div><label class="font-semibold">رابط أيقونة التطبيق</label><input type="text" id="app-icon-url" class="mt-1 w-full p-2 border rounded" value="${app?.iconUrl || ''}" required></div><div class="border-t pt-4 space-y-4"><h4 class="font-bold text-gray-800">روابط التحميل</h4><div><label class="font-semibold flex items-center gap-2 text-gray-700"><i class="fab fa-google-play text-lg"></i> رابط التطبيق على Google Play</label><input type="text" id="app-google-play-url" class="mt-1 w-full p-2 border rounded" value="${app?.googlePlayUrl || ''}"></div><div><label class="font-semibold flex items-center gap-2 text-green-700"><i class="fas fa-file-archive text-lg"></i> رابط التحميل المباشر (ملف APK)</label><input type="text" id="app-apk-url" class="mt-1 w-full p-2 border rounded" value="${app?.apkUrl || ''}"></div><div><label class="font-semibold flex items-center gap-2 text-sky-600"><i class="fab fa-telegram text-lg"></i> رابط التطبيق على Telegram</label><input type="text" id="app-telegram-url" class="mt-1 w-full p-2 border rounded" value="${app?.telegramUrl || ''}"></div><div><label class="font-semibold flex items-center gap-2 text-black"><i class="fab fa-apple text-lg"></i> رابط التطبيق على App Store (للآيفون)</label><input type="text" id="app-ios-url" class="mt-1 w-full p-2 border rounded" value="${app?.iosUrl || ''}"></div></div></div>`;
            showModal(title, content, async () => {
                const name = getVal('app-name').trim();
                const iconUrl = getVal('app-icon-url').trim();
                const googlePlayUrl = getVal('app-google-play-url').trim(); 
                const apkUrl = getVal('app-apk-url').trim(); 
                const telegramUrl = getVal('app-telegram-url').trim(); 
                const iosUrl = getVal('app-ios-url').trim();

                if (!name || !iconUrl) return alert('يرجى ملء اسم التطبيق ورابط الأيقونة.');
                if (!googlePlayUrl && !apkUrl && !telegramUrl && !iosUrl) return alert('يجب توفير رابط تحميل واحد على الأقل.');

                try {
                    showLoadingModal('جاري حفظ البيانات...');
                    const appData = { 
                        name, 
                        description: getVal('app-description').trim(), 
                        iconUrl, googlePlayUrl, apkUrl, telegramUrl, iosUrl, 
                        updatedAt: serverTimestamp() 
                    };
                    if (app) await updateDoc(doc(db, "applications", app.id), appData);
                    else { appData.createdAt = serverTimestamp(); await addDoc(collection(db, "applications"), appData); }
                    closeModal();
                } catch (error) { showModal('خطأ فادح', `فشل حفظ التطبيق: ${error.message}`, () => closeModal(), 'موافق', false); }
            });
        }
        function attachApplicationActionListeners() {
            document.querySelectorAll('.edit-app-btn').forEach(btn => btn.onclick = () => showApplicationModal(applicationsCache.find(a => a.id === btn.dataset.id)));
            document.querySelectorAll('.delete-app-btn').forEach(btn => btn.onclick = async (e) => {
                showDeleteConfirmationModal(async () => {
                    await deleteDoc(doc(db, "applications", e.currentTarget.dataset.id));
                    closeModal();
                });
            });
        }

        function loadNotepad() {
            const panel = getEl('notepad-panel');
            panel.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-gray-800">المفكرة الاحترافية</h1><button id="add-note-btn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i> إضافة ملاحظة</button></div><div id="notes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>`;
            getEl('add-note-btn').addEventListener('click', () => showNoteModal());
            onSnapshot(query(collection(db, "notes"), orderBy("updatedAt", "desc")), (snapshot) => {
                notesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const listContainer = getEl('notes-list');
                listContainer.innerHTML = snapshot.empty ? '<p class="text-center text-gray-500 col-span-full mt-8">لا توجد ملاحظات.</p>' : '';
                notesCache.forEach(note => {
                    const statusMap = { 'Pending': { text: 'قيد الانتظار', color: 'bg-yellow-100 text-yellow-800' }, 'In Progress': { text: 'قيد التنفيذ', color: 'bg-blue-100 text-blue-800' }, 'Resolved': { text: 'تمت التسوية', color: 'bg-green-100 text-green-800' } };
                    const statusInfo = statusMap[note.status] || { text: note.status, color: 'bg-gray-100 text-gray-800' };
                    const date = note.updatedAt?.toDate().toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const card = document.createElement('div');
                    card.className = 'bg-white p-5 rounded-xl shadow-md border-l-4 flex flex-col';
                    card.style.borderLeftColor = note.status === 'Resolved' ? '#10B981' : (note.status === 'In Progress' ? '#3B82F6' : '#F59E0B');
                    card.innerHTML = `<div class="flex-grow"><div class="flex justify-between items-start"><h3 class="text-xl font-bold text-gray-800 mb-2">${note.title}</h3><span class="text-xs font-bold px-2 py-1 rounded-full ${statusInfo.color}">${statusInfo.text}</span></div>${note.linkedSupplier ? `<p class="text-sm text-gray-500 mb-3"><i class="fas fa-user-tie fa-fw mr-1"></i> مرتبط بالمورد: <strong>${note.linkedSupplier}</strong></p>` : ''}${note.amount > 0 ? `<p class="text-lg font-mono font-bold text-indigo-600 mb-4">${note.amount.toLocaleString()} د.ج</p>` : ''}<div class="prose prose-sm max-w-none text-gray-700 mb-4 ql-editor-display">${note.content}</div></div><div class="border-t pt-3 mt-auto flex justify-between items-center text-sm"><span class="text-gray-400">${date}</span><div><button class="edit-note-btn text-indigo-500 hover:text-indigo-700 mr-3" data-id="${note.id}"><i class="fas fa-edit"></i> تعديل</button><button class="delete-note-btn text-red-500 hover:text-red-700" data-id="${note.id}"><i class="fas fa-trash"></i> حذف</button></div></div>`;
                    const displayContent = card.querySelector('.ql-editor-display');
                    displayContent.innerHTML = DOMPurify.sanitize(note.content);
                    listContainer.appendChild(card);
                });
                attachNoteActionListeners();
            });
        }
        function showNoteModal(note = null) {
            const title = note ? 'تعديل الملاحظة' : 'إضافة ملاحظة جديدة';
            const uniqueSuppliers = [...new Set(productsCache.map(p => p.supplier).filter(Boolean))];
            const supplierOptions = uniqueSuppliers.map(s => `<option value="${s}" ${note?.linkedSupplier === s ? 'selected' : ''}>${s}</option>`).join('');
            const content = `<div class="space-y-4"><div><label class="font-semibold">عنوان الملاحظة</label><input type="text" id="note-title" class="mt-1 w-full p-2 border rounded" value="${note?.title || ''}" required></div><div><label class="font-semibold">المحتوى</label><div id="note-content-editor" class="mt-1 bg-white" style="min-height: 150px;"></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="font-semibold">المبلغ المالي (د.ج)</label><input type="number" id="note-amount" class="mt-1 w-full p-2 border rounded" placeholder="اختياري" value="${note?.amount || ''}"></div><div><label class="font-semibold">الحالة</label><select id="note-status" class="mt-1 w-full p-2 border rounded bg-white"><option value="Pending" ${note?.status === 'Pending' ? 'selected' : ''}>قيد الانتظار</option><option value="In Progress" ${note?.status === 'In Progress' ? 'selected' : ''}>قيد التنفيذ</option><option value="Resolved" ${note?.status === 'Resolved' ? 'selected' : ''}>تمت التسوية</option></select></div></div><div><label class="font-semibold">ربط بمورد (اختياري)</label><select id="note-linked-supplier" class="mt-1 w-full p-2 border rounded bg-white"><option value="">-- بدون ربط --</option>${supplierOptions}</select></div></div>`;
            let noteQuill;
            showModal(title, content, async () => {
                const noteTitle = getVal('note-title').trim();
                const noteContentHTML = noteQuill.root.innerHTML.trim();
                if (!noteTitle || noteContentHTML === '<p><br></p>') return alert('يرجى إدخال عنوان ومحتوى للملاحظة.');
                
                const cleanContent = DOMPurify.sanitize(noteContentHTML);
                const noteData = { 
                    title: noteTitle, 
                    content: cleanContent, 
                    amount: getNum('note-amount') || 0, 
                    status: getVal('note-status'), 
                    linkedSupplier: getVal('note-linked-supplier'), 
                    updatedAt: serverTimestamp() 
                };
                showLoadingModal('جاري الحفظ...');
                try {
                    if (note) await updateDoc(doc(db, "notes", note.id), noteData);
                    else { noteData.createdAt = serverTimestamp(); await addDoc(collection(db, "notes"), noteData); }
                    closeModal();
                } catch (error) { showModal('خطأ', `فشل حفظ الملاحظة: ${error.message}`, () => closeModal(), 'موافق', false); }
            });
            noteQuill = new Quill('#note-content-editor', { theme: 'snow', modules: { toolbar: [['bold', 'italic', 'underline'], [{'list': 'ordered'}, {'list': 'bullet'}],[{ 'color': [] }, { 'background': [] }],['clean']] } });
            if (note?.content) noteQuill.root.innerHTML = note.content;
        }
        function attachNoteActionListeners() {
            document.querySelectorAll('.edit-note-btn').forEach(btn => btn.onclick = () => showNoteModal(notesCache.find(n => n.id === btn.dataset.id)));
            document.querySelectorAll('.delete-note-btn').forEach(btn => btn.onclick = async (e) => { 
                showDeleteConfirmationModal(async () => {
                    await deleteDoc(doc(db, "notes", e.currentTarget.dataset.id));
                    closeModal();
                });
            });
        }

        async function loadStoreSettings() {
            const panel = getEl('settings-panel');
            panel.innerHTML = `<div class="loader mx-auto mt-10"></div>`;
            const docRef = doc(db, "settings", "storeConfig");
            const docSnap = await getDoc(docRef);
            const settings = docSnap.exists() ? docSnap.data() : {};

            panel.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">إعدادات المتجر</h1>
                <div class="space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">شعار المتجر (اللوقو)</h3>
                        <p class="text-sm text-gray-500 mb-3">هذا هو الشعار الذي يظهر للزبائن.</p>
                        <div id="logo-image-preview" class="mt-2 mb-3"><img src="${settings.logoUrl || 'https://placehold.co/200x80/e2e8f0/94a3b8?text=Logo'}" class="w-40 h-auto object-contain rounded-md bg-gray-100 p-2 border"></div>
                        <input type="file" id="logo-image-file" accept="image/*" class="mt-2">
                    </div>
                    
                     <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">رسالة إعلانية عامة (Banner)</h3>
                        <div class="flex items-center justify-between mb-4">
                            <label for="banner-active-toggle" class="font-semibold text-lg">تفعيل الرسالة الإعلانية</label>
                            <label class="toggle-switch"><input type="checkbox" id="banner-active-toggle" ${settings.isBannerActive ? 'checked' : ''}><span class="slider"></span></label>
                        </div>
                        <div class="mt-4"><label class="font-semibold">نص الرسالة</label><input type="text" id="banner-message" class="w-full p-2 mt-1 border rounded" placeholder="مثال: تخفيضات 20% على كل المنتجات!" value="${settings.bannerMessage || ''}"></div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">نافذة التوصيات المنبثقة</h3>
                        <div class="flex items-center justify-between mb-4"><label for="recommendation-active-toggle" class="font-semibold text-lg">تفعيل نافذة "هل تحتاج توصية؟"</label><label class="toggle-switch"><input type="checkbox" id="recommendation-active-toggle" ${settings.isRecommendationActive ? 'checked' : ''}><span class="slider"></span></label></div>
                        <div class="mt-4"><label class="font-semibold">نص الرسالة</label><textarea id="recommendation-message" rows="3" class="w-full p-2 mt-1 border rounded" placeholder="...">${settings.recommendationMessage || 'هل تحتاج توصية؟ يمكننا أن نعرض عليك أفضل عروضنا الحصرية!'}</textarea></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                           <div><label class="font-semibold">مرات الظهور في اليوم</label><input type="number" id="recommendation-daily-freq" class="w-full p-2 mt-1 border rounded" value="${settings.recommendationDailyFreq || '1'}"></div>
                           <div><label class="font-semibold">مرات الظهور في الأسبوع</label><input type="number" id="recommendation-weekly-freq" class="w-full p-2 mt-1 border rounded" value="${settings.recommendationWeeklyFreq || '3'}"></div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-md">
                         <h3 class="text-xl font-bold mb-4 border-b pb-2">إعدادات الشحن والتوصيل</h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label class="font-semibold">تكلفة الشحن (د.ج)</label><input type="number" id="shipping-cost" class="w-full p-2 mt-1 border rounded" value="${settings.shippingCost || ''}" placeholder="مثال: 600"></div>
                            <div><label class="font-semibold">حد الشحن المجاني (د.ج)</label><input type="number" id="free-shipping-threshold" class="w-full p-2 mt-1 border rounded" value="${settings.freeShippingThreshold || ''}" placeholder="اتركه فارغاً لتعطيل الشحن المجاني"></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">الإعدادات العامة وحالة المتجر</h3>
                         <div class="flex items-center justify-between bg-red-50 p-4 rounded-lg mb-4"><label for="manual-closed-toggle" class="font-semibold text-lg text-red-800">فرض إغلاق المتجر (للطوارئ)</label><label class="toggle-switch"><input type="checkbox" id="manual-closed-toggle" ${settings.isManuallyClosed ? 'checked' : ''}><span class="slider"></span></label></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label class="font-semibold">وقت الفتح</label><input type="time" id="open-time" class="w-full p-2 mt-1 border rounded" value="${settings.openTime || ''}"></div>
                            <div><label class="font-semibold">وقت الإغلاق</label><input type="time" id="close-time" class="w-full p-2 mt-1 border rounded" value="${settings.closeTime || ''}"></div>
                        </div>
                        <div class="mt-4"><label class="font-semibold">رسالة الإغلاق</label><input type="text" id="closed-message" placeholder="مثال: المتجر مغلق حاليًا، نفتح غدًا على الساعة 09:00" class="w-full p-2 mt-1 border rounded" value="${settings.closedMessage || ''}"></div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">روابط التواصل</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="social-phone" placeholder="رقم الهاتف" class="p-2 border rounded" value="${settings.socialLinks?.phone || ''}">
                            <input type="text" id="social-whatsapp" placeholder="رقم الواتساب (بدون +)" class="p-2 border rounded" value="${settings.socialLinks?.whatsapp || ''}">
                            <input type="url" id="social-facebook" placeholder="رابط فيسبوك" class="p-2 border rounded" value="${settings.socialLinks?.facebook || ''}">
                            <input type="url" id="social-instagram" placeholder="رابط انستغرام" class="p-2 border rounded" value="${settings.socialLinks?.instagram || ''}">
                            <input type="url" id="social-x" placeholder="رابط X (تويتر سابقاً)" class="p-2 border rounded" value="${settings.socialLinks?.x || ''}">
                            <input type="url" id="social-tiktok" placeholder="رابط تيك توك" class="p-2 border rounded" value="${settings.socialLinks?.tiktok || ''}">
                            <input type="url" id="social-telegram1" placeholder="رابط تيليجرام 1 (مثال: القناة)" class="p-2 border rounded" value="${settings.socialLinks?.telegram1 || ''}">
                            <input type="url" id="social-telegram2" placeholder="رابط تيليجرام 2 (مثال: المجموعة)" class="p-2 border rounded" value="${settings.socialLinks?.telegram2 || ''}">
                            <input type="url" id="social-snapchat" placeholder="رابط سناب شات" class="p-2 border rounded" value="${settings.socialLinks?.snapchat || ''}">
                        </div>
                        </div>
                    
                     <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">تحسينات SEO & Pixels</h3>
                        <div class="space-y-4">
                           <div><label class="font-semibold">عنوان المتجر (Meta Title)</label><input type="text" id="seo-title" placeholder="اسم متجرك | أفضل المنتجات..." class="w-full p-2 mt-1 border rounded" value="${settings.seoTitle || ''}"></div>
                           <div><label class="font-semibold">وصف المتجر (Meta Description)</label><textarea id="seo-description" rows="3" class="w-full p-2 mt-1 border rounded">${settings.seoDescription || ''}</textarea></div>
                           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                               <div><label class="font-semibold">Facebook Pixel ID</label><input type="text" id="fb-pixel-id" placeholder="123456789012345" class="w-full p-2 mt-1 border rounded" value="${settings.fbPixelId || ''}"></div>
                               <div><label class="font-semibold">Google Analytics ID</label><input type="text" id="ga-id" placeholder="G-XXXXXXXXXX" class="w-full p-2 mt-1 border rounded" value="${settings.gaId || ''}"></div>
                           </div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 text-right">
                    <button id="save-settings-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700">حفظ كل الإعدادات</button>
                </div>`;
            
            getEl('logo-image-file').onchange = (e) => {
                if(e.target.files && e.target.files[0]) {
                    selectedFileStore.logo = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const previewImg = document.querySelector('#logo-image-preview img');
                        if (previewImg) previewImg.src = ev.target.result;
                    };
                    reader.readAsDataURL(selectedFileStore.logo);
                }
            };
            getEl('save-settings-btn').onclick = () => saveGeneralSettings(settings);
        }

       async function saveGeneralSettings(currentSettings) { 
            showLoadingModal("جاري حفظ الإعدادات...");
            try {
                let logoUrl = currentSettings.logoUrl || null;
                if (selectedFileStore.logo) {
                    const compressedFile = await resizeAndCompressImage(selectedFileStore.logo, 400);
                    logoUrl = await uploadImageToImgBB(compressedFile);
                    selectedFileStore.logo = null;
                }

                const settingsData = {
                    logoUrl,
                    isBannerActive: getChecked('banner-active-toggle'),
                    bannerMessage: getVal('banner-message'),
                    isRecommendationActive: getChecked('recommendation-active-toggle'),
                    recommendationMessage: getVal('recommendation-message'),
                    recommendationDailyFreq: getInt('recommendation-daily-freq') || 1,
                    recommendationWeeklyFreq: getInt('recommendation-weekly-freq') || 3,
                    shippingCost: getNum('shipping-cost') || 0,
                    freeShippingThreshold: getNum('free-shipping-threshold') || null,
                    isManuallyClosed: getChecked('manual-closed-toggle'),
                    openTime: getVal('open-time'),
                    closeTime: getVal('close-time'),
                    closedMessage: getVal('closed-message'),
                    socialLinks: {
                        phone: getVal('social-phone').trim(),
                        whatsapp: getVal('social-whatsapp').trim(),
                        facebook: getVal('social-facebook').trim(),
                        instagram: getVal('social-instagram').trim(),
                        x: getVal('social-x').trim(),
                        tiktok: getVal('social-tiktok').trim(),
                        telegram1: getVal('social-telegram1').trim(),
                        telegram2: getVal('social-telegram2').trim(),
                        snapchat: getVal('social-snapchat').trim(),
                    },
                    seoTitle: getVal('seo-title').trim(),
                    seoDescription: getVal('seo-description').trim(),
                    fbPixelId: getVal('fb-pixel-id').trim(),
                    gaId: getVal('ga-id').trim(),
                };

                await setDoc(doc(db, "settings", "storeConfig"), settingsData, { merge: true });
                
                closeModal(); 

                showModal(
                    'نجاح',
                    `<div class="text-center">
                        <i class="fas fa-check-circle text-5xl text-green-500 mx-auto mb-4"></i>
                        <p class="text-lg">تم تحديث إعدادات المتجر بنجاح!</p>
                    </div>`,
                    () => closeModal(),
                    'حسنًا',
                    false
                );

            } catch (error) {
                closeModal();
                showModal('خطأ فادح', `فشل حفظ الإعدادات: ${error.message}`, () => closeModal(), 'موافق', false);
            }
        }
        
        function showModal(title, content, onConfirm, confirmText = 'حفظ', showCancel = true) {
            const modalContainer = getEl('modal-container');
            modalContainer.innerHTML = `<div class="modal-backdrop" id="modal-backdrop"><div class="modal-content"><div class="flex justify-between items-center mb-4 border-b pb-3"><h3 class="text-xl font-bold">${title}</h3><button id="modal-close-btn" class="text-gray-400 hover:text-gray-800 text-2xl">&times;</button></div><div id="modal-body">${content}</div><div class="flex justify-end gap-4 mt-6 border-t pt-4">${showCancel ? `<button id="modal-cancel" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg font-semibold hover:bg-gray-300">إلغاء</button>` : ''}<button id="modal-confirm" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-indigo-700">${confirmText}</button></div></div></div>`;
            if (showCancel) getEl('modal-cancel').addEventListener('click', closeModal);
            getEl('modal-close-btn').addEventListener('click', closeModal);
            getEl('modal-backdrop').addEventListener('click', (e) => { if (e.target.id === 'modal-backdrop' && showCancel) closeModal(); });
            getEl('modal-confirm').addEventListener('click', onConfirm);
        }
        function closeModal() { getEl('modal-container').innerHTML = ''; }
        function showLoadingModal(text = 'جاري الحفظ...') { getEl('modal-container').innerHTML = `<div class="modal-backdrop"><div class="modal-content text-center"><div class="loader mx-auto"></div><p class="mt-4 text-lg font-semibold text-gray-700">${text}</p></div></div>`; }
        
        function showDeleteConfirmationModal(onConfirm) {
            const confirmationText = "S22MARKET";
            const content = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
                    <p class="text-lg font-bold mb-2">هل أنت متأكد تماماً؟</p>
                    <p class="text-gray-600 mb-4">هذا الإجراء لا يمكن التراجع عنه. لتأكيد الحذف، الرجاء كتابة <strong class="font-mono text-red-700">${confirmationText}</strong> في الحقل أدناه.</p>
                    <input type="text" id="delete-confirmation-input" class="w-full p-2 border rounded-md text-center font-mono tracking-widest" placeholder="${confirmationText}">
                    <p id="delete-error-msg" class="text-red-600 text-sm mt-2 hidden">النص غير متطابق.</p>
                </div>
            `;
            showModal('تأكيد الحذف النهائي', content, () => {
                 const input = getEl('delete-confirmation-input');
                 if(input.value === confirmationText) {
                     showLoadingModal('جاري الحذف...');
                     onConfirm();
                 } else {
                     const errorMsg = getEl('delete-error-msg');
                     input.classList.add('border-red-500', 'shake');
                     errorMsg.classList.remove('hidden');
                     setTimeout(() => input.classList.remove('shake'), 820);
                 }
            }, 'تأكيد الحذف', true);

            const confirmBtn = getEl('modal-confirm');
            const inputField = getEl('delete-confirmation-input');
            confirmBtn.disabled = true;
            confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
            confirmBtn.classList.remove('hover:bg-indigo-700');
            confirmBtn.style.backgroundColor = '#dc2626'; // Red color for delete button
            confirmBtn.style.borderColor = '#dc2626';

            inputField.addEventListener('input', () => {
                if (inputField.value === confirmationText) {
                    confirmBtn.disabled = false;
                    confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    confirmBtn.classList.add('hover:bg-red-700');
                    inputField.classList.remove('border-red-500');
                    getEl('delete-error-msg').classList.add('hidden');
                } else {
                    confirmBtn.disabled = true;
                    confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    confirmBtn.classList.remove('hover:bg-red-700');
                }
            });
        }
        
        const adminPassword = getEl('admin-password');
        const togglePasswordBtn = getEl('toggle-password');
        if (togglePasswordBtn && adminPassword) {
            togglePasswordBtn.addEventListener('click', () => {
                const type = adminPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                adminPassword.setAttribute('type', type);
                const icon = togglePasswordBtn.querySelector('i');
                if (icon) {
                    icon.classList.toggle('fa-eye');
                    icon.classList.toggle('fa-eye-slash');
                }
            });
        }
        
        function loadProductRequests() {
            const panel = getEl('productRequests-panel');
            panel.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">طلبات إضافة المنتجات من الزوار</h1>
                       <div id="product-requests-list" class="space-y-6"></div>`;

            onSnapshot(query(collection(db, "productRequests"), orderBy("createdAt", "desc")), (snapshot) => {
                const list = getEl('product-requests-list');
                list.innerHTML = snapshot.empty ? '<div class="text-center p-8 bg-white rounded-lg shadow-md"><p class="text-gray-500 text-lg">لا توجد طلبات لإضافة منتجات حاليًا.</p></div>' : '';

                snapshot.forEach(doc => {
                    const request = { id: doc.id, ...doc.data() };
                    const date = request.createdAt?.toDate().toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' });
                    const statusColor = request.status === 'approved' ? 'border-green-500' : (request.status === 'rejected' ? 'border-red-500' : 'border-yellow-500');
                    const deliveryOptionsMap = {
                        self_delivery: 'يوفر التوصيل بنفسه',
                        s22_delivery: 'يريد من المتجر توفير التوصيل',
                        later: 'سيتم التنسيق لاحقاً'
                    };

                    const imagesHTML = (request.imageUrls || []).map(url => `
                        <a href="${url}" target="_blank" class="block w-20 h-20">
                           <img src="${url}" class="w-full h-full object-cover rounded-md border hover:opacity-80 transition-opacity">
                        </a>
                    `).join('');

                    const card = document.createElement('div');
                    card.className = `bg-white p-5 rounded-xl shadow-lg border-l-4 ${statusColor} transition-shadow hover:shadow-xl`;
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-extrabold text-gray-800">${request.productName}</h3>
                                <p class="text-sm text-gray-500 mt-1">القسم المقترح: <strong>${request.categoryName}</strong> ${request.suggestedCategory ? `(اقتراح جديد: ${request.suggestedCategory})` : ''}</p>
                            </div>
                            <span class="text-xs font-mono text-gray-400">${date}</span>
                        </div>
                        
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-700 mb-2">الصور المرفقة:</h4>
                            <div class="flex flex-wrap gap-3">${imagesHTML || '<p class="text-sm text-gray-400">لا توجد صور.</p>'}</div>
                        </div>

                        <div class="my-4 p-4 bg-gray-50 rounded-lg text-gray-700 text-sm">${request.productDescription}</div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm mb-4 border-t border-b py-4">
                            <div><strong class="block text-gray-500">الكمية المتوفرة</strong><span class="font-bold text-lg">${request.quantity || 'غير محدد'}</span></div>
                            <div><strong class="block text-gray-500">منطقة البيع</strong><span class="font-semibold">${request.sellingArea || 'غير محدد'}</span></div>
                            <div><strong class="block text-gray-500">التوصيل</strong><span class="font-semibold">${deliveryOptionsMap[request.deliveryOption] || 'غير محدد'}</span></div>
                        </div>

                        <div class="pt-3">
                            <h4 class="font-semibold mb-2 text-gray-700">معلومات مقدم الطلب:</h4>
                            <p><strong>الاسم:</strong> ${request.userName}</p>
                            <p><strong>الهاتف:</strong> <a href="tel:${request.userPhone}" class="text-blue-600 hover:underline">${request.userPhone}</a></p>
                            <p><strong>البريد:</strong> <a href="mailto:${request.userEmail}" class="text-blue-600 hover:underline">${request.userEmail}</a></p>
                            <p><strong>التخصص:</strong> ${request.userSpecialty || 'لم يحدد'}</p>
                        </div>

                        ${request.status !== 'approved' ? `
                        <div class="flex justify-end gap-3 mt-5">
                            <button class="reject-request-btn text-red-600 font-semibold py-2 px-4 rounded-lg hover:bg-red-50 transition-colors" data-id="${request.id}">
                               <i class="fas fa-trash-alt mr-2"></i> حذف ورفض الطلب
                            </button>
                            <button class="approve-request-btn bg-green-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-green-700 transition-transform hover:scale-105" data-id='${JSON.stringify(request)}'>
                                <i class="fas fa-plus mr-2"></i> إنشاء منتج من هذا الطلب
                            </button>
                        </div>` : `
                        <div class="mt-5 p-3 bg-green-100 text-green-800 text-center rounded-lg font-semibold">
                            <i class="fas fa-check-circle mr-2"></i> تمت الموافقة على هذا الطلب وإنشاء منتج منه.
                        </div>
                        `}
                    `;
                    list.appendChild(card);
                });
                attachRequestActionListeners();
            });
        }

        function attachRequestActionListeners() {
            document.querySelectorAll('.approve-request-btn').forEach(btn => {
                btn.onclick = async () => {
                    const button = btn;
                    button.disabled = true;
                    button.innerHTML = '<div class="loader !w-6 !h-6 !border-4 mx-auto"></div>';

                    try {
                        const requestDataString = btn.dataset.id;
                        const requestData = JSON.parse(requestDataString);

                        const category = categoriesCache.find(c => c.name === requestData.categoryName);
                        
                        const deliveryOptionsMap = {
                            self_delivery: 'يوفر التوصيل بنفسه',
                            s22_delivery: 'يريد من المتجر توفير التوصيل',
                            later: 'سيتم التنسيق لاحقاً'
                        };

                        const productDescription = `<p>${requestData.productDescription}</p>`;
                        const supplierContactInfo = `الهاتف: ${requestData.userPhone}\nالبريد: ${requestData.userEmail}\nالتخصص: ${requestData.userSpecialty}\n\n-- ملاحظات الطلب --\nالكمية: ${requestData.quantity}\nمنطقة البيع: ${requestData.sellingArea}\nالتوصيل: ${deliveryOptionsMap[requestData.deliveryOption]}`;

                        const newProductData = {
                            name: `<h3>${requestData.productName}</h3>`,
                            price: 0, 
                            description: productDescription,
                            categoryId: category ? category.id : '',
                            subCategoryName: null,
                            subCategoryID: null,
                            supplier: requestData.userName,
                            supplierContact: supplierContactInfo,
                            imageUrls: requestData.imageUrls || [],
                            location: requestData.sellingArea,
                            availability: 'available',
                            sku: '',
                            profitValue: 0,
                            profitType: 'fixed',
                            shippingOptions: [],
                            orderMethod: 'traditional',
                            directContactLinks: {
                                whatsapp: '',
                                facebook: '',
                                instagram: '',
                                telegram: '',
                                phone: ''
                            },
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp()
                        };

                        const productRef = await addDoc(collection(db, "products"), newProductData);
                        
                        await updateDoc(doc(db, "productRequests", requestData.id), { status: "approved" });

                        showModal(
                            'نجاح',
                            `<div class="text-center">
                                <i class="fas fa-check-circle text-5xl text-green-500 mx-auto mb-4"></i>
                                <p class="text-lg">تم إنشاء المنتج بنجاح!</p>
                                <p class="text-sm text-gray-600 mt-2">يمكنك الآن تعديل سعره وتفاصيله من قسم المنتجات.</p>
                            </div>`,
                            () => {
                                closeModal();
                                document.querySelector('a[href="#products"]').click();
                                setTimeout(() => {
                                    const newCard = Array.from(document.querySelectorAll('.edit-product-btn')).find(button => button.dataset.id === productRef.id)?.closest('.bg-white');
                                    if(newCard) {
                                        newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        newCard.style.transition = 'all 0.3s ease';
                                        newCard.style.boxShadow = '0 0 25px rgba(79, 70, 229, 0.7)';
                                        setTimeout(() => { newCard.style.boxShadow = ''; }, 3000);
                                    }
                                }, 500);
                            },
                            'حسنًا',
                            false
                        );

                    } catch (e) {
                        console.error("Failed to create product from request:", e);
                        alert("حدث خطأ فادح أثناء إنشاء المنتج: " + e.message);
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-plus mr-2"></i> إنشاء منتج من هذا الطلب';
                    }
                };
            });

            document.querySelectorAll('.reject-request-btn').forEach(btn => {
                btn.onclick = async () => {
                     showDeleteConfirmationModal(async () => {
                        try {
                           await deleteDoc(doc(db, "productRequests", btn.dataset.id));
                           closeModal();
                        } catch(error) {
                           console.error("Error deleting request:", error);
                           showModal('خطأ', "حدث خطأ أثناء حذف الطلب.", closeModal, 'موافق', false);
                        }
                    });
                };
            });
        }
    </script>
</body>
</html>