<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - لوحة التحكم المطورة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f0f2f5; }
        .hidden { display: none; }
        .active-tab { background-color: #4f46e5; color: white; }
        .dashboard-panel { animation: fadeIn 0.5s; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 40;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: white; padding: 1.5rem; border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%;
            max-width: 700px; z-index: 50; max-height: 90vh; overflow-y: auto;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #4f46e5;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .ql-toolbar { border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; }
        .ql-container { border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; min-height: 80px; }
        .ql-editor { font-family: 'Tajawal', sans-serif; }

        @media (max-width: 768px) {
            .responsive-table thead { display: none; }
            .responsive-table tr {
                display: block; border: 1px solid #e5e7eb; border-radius: 0.5rem;
                padding: 1rem; margin-bottom: 1rem; background-color: white;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            }
             .responsive-table td {
                display: flex; justify-content: space-between; align-items: center;
                padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;
            }
            .responsive-table td:last-child { border-bottom: none; }
            .responsive-table td::before {
                content: attr(data-label); font-weight: 600;
                margin-left: 0.5rem; color: #4b5563;
            }
             .responsive-table .actions-cell { justify-content: flex-end; gap: 1rem; }
             .responsive-table .actions-cell::before { content: ""; flex-grow: 1; }
             .responsive-table .order-status-select, .responsive-table .profit-input, .responsive-table .doneBy-input, .responsive-table .suppliers-textarea {
                width: auto; flex-grow: 1; max-width: 180px; text-align: left;
             }
        }
    </style>
</head>
<body>

    <div id="login-page" class="min-h-screen flex items-center justify-center bg-gray-50">
        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg text-center">
            <i class="fas fa-user-shield text-5xl text-indigo-600 mb-4"></i>
            <h2 class="text-3xl font-extrabold text-gray-900 mb-2">لوحة التحكم</h2>
            <p class="text-gray-600 mb-6">الرجاء تسجيل الدخول للمتابعة.</p>
            <form id="login-form">
                <div class="space-y-4">
                    <input type="email" id="admin-email" class="w-full px-4 py-3 bg-gray-100 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-indigo-500 transition" placeholder="البريد الإلكتروني" required>
                    <div class="relative">
                        <input type="password" id="admin-password" class="w-full px-4 py-3 bg-gray-100 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-indigo-500 transition" placeholder="كلمة المرور" required>
                        <button type="button" id="toggle-password" class="absolute top-1/2 left-3 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            <i class="fas fa-eye-slash"></i>
                        </button>
                    </div>
                </div>
                <p id="login-error" class="hidden text-red-500 mt-3">البريد الإلكتروني أو كلمة المرور غير صحيحة.</p>
                <button type="submit" class="w-full mt-6 bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition-colors text-lg">
                    <i class="fas fa-sign-in-alt mr-2"></i> دخول
                </button>
            </form>
             <a href="index.html" class="block w-full mt-4 bg-gray-200 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-300 transition-colors text-lg">
                <i class="fas fa-arrow-left mr-2"></i> العودة للمتجر
            </a>
        </div>
    </div>

    <div id="dashboard-page" class="hidden">
        <div class="relative min-h-screen md:flex">
            <div class="bg-gray-800 text-gray-100 flex justify-between md:hidden">
                <a href="#" class="block p-4 text-white font-bold">S22 Market</a>
                <button id="mobile-menu-btn" class="p-4 focus:outline-none focus:bg-gray-700">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <aside id="sidebar" class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 right-0 transform translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out">
                <div class="p-3 text-center border-b border-gray-700">
                    <h2 class="text-2xl font-bold">S22 Market</h2>
                </div>
                <nav class="flex-1 p-2 space-y-2">
                    <a href="#analytics" class="dashboard-tab active-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i class="fas fa-chart-line fa-fw mr-3"></i> لوحة التحكم</a>
                    <a href="#products" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i class="fas fa-boxes fa-fw mr-3"></i> المنتجات</a>
                    <a href="#categories" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i class="fas fa-sitemap fa-fw mr-3"></i> الأقسام</a>
                    <a href="#orders" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i class="fas fa-clipboard-list fa-fw mr-3"></i> الطلبات</a>
                </nav>
                <div class="p-4 border-t border-gray-700">
                    <button id="logout-btn" class="w-full bg-red-600 py-2 rounded-md hover:bg-red-700 transition-colors"><i class="fas fa-sign-out-alt mr-2"></i> تسجيل الخروج</button>
                </div>
            </aside>

            <main class="flex-1 p-4 md:p-8 overflow-y-auto">
                <div id="analytics-panel" class="dashboard-panel"></div>
                <div id="products-panel" class="dashboard-panel hidden"></div>
                <div id="categories-panel" class="dashboard-panel hidden"></div>
                <div id="orders-panel" class="dashboard-panel hidden"></div>
            </main>
        </div>
    </div>

    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAxEq-nkLDc3_HM38xb3mhb8ekSXmuFQ7I",
            authDomain: "s22market-4bdb9.firebaseapp.com",
            databaseURL: "https://s22market-4bdb9-default-rtdb.firebaseio.com",
            projectId: "s22market-4bdb9",
            storageBucket: "s22market-4bdb9.appspot.com",
            messagingSenderId: "1029564929614",
            appId: "1:1029564929614:web:2866722c34cf1fb2b8951f",
            measurementId: "G-VH16M3Q33V"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let categoriesCache = [];
        let productsCache = [];
        let ordersCache = [];
        let myChart = null;

        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');

        onAuthStateChanged(auth, user => {
            if (user) {
                loginPage.classList.add('hidden');
                dashboardPage.classList.remove('hidden');
                initializeDashboard();
            } else {
                loginPage.classList.remove('hidden');
                dashboardPage.classList.add('hidden');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            loginError.classList.add('hidden');
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                loginError.textContent = "فشل الدخول. تحقق من البريد وكلمة المرور.";
                loginError.classList.remove('hidden');
            }
        });

        logoutBtn.addEventListener('click', async () => { await signOut(auth); });

        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('translate-x-full');
        });

        function initializeDashboard() {
            const tabs = document.querySelectorAll('.dashboard-tab');
            const panels = document.querySelectorAll('.dashboard-panel');

            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    tabs.forEach(t => t.classList.remove('active-tab'));
                    tab.classList.add('active-tab');
                    const targetPanelId = tab.getAttribute('href').substring(1) + '-panel';
                    panels.forEach(panel => panel.classList.toggle('hidden', panel.id !== targetPanelId));
                    if (window.innerWidth < 768 && !sidebar.classList.contains('translate-x-full')) {
                        sidebar.classList.add('translate-x-full');
                    }
                });
            });
            
            loadAnalytics();
            loadCategories();
            loadProducts();
            loadOrders();
        }
        
        // ===================================
        // Analytics Section
        // ===================================
        function loadAnalytics() {
            const panel = document.getElementById('analytics-panel');
            panel.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">لوحة التحكم الرئيسية</h1>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                        <i class="fas fa-coins text-4xl text-yellow-400 mr-4"></i>
                        <div><p class="text-gray-500">إجمالي الإيرادات</p><p id="total-revenue" class="text-2xl font-bold">0 د.ج</p></div>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                        <i class="fas fa-hand-holding-usd text-4xl text-green-500 mr-4"></i>
                        <div><p class="text-gray-500">إجمالي الأرباح</p><p id="total-profit" class="text-2xl font-bold">0 د.ج</p></div>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                        <i class="fas fa-clipboard-list text-4xl text-blue-500 mr-4"></i>
                        <div><p class="text-gray-500">إجمالي الطلبات</p><p id="total-orders" class="text-2xl font-bold">0</p></div>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                        <i class="fas fa-boxes text-4xl text-purple-500 mr-4"></i>
                        <div><p class="text-gray-500">المنتجات</p><p id="total-products" class="text-2xl font-bold">0</p></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4">الطلبات المكتملة (آخر 7 أيام)</h2>
                    <canvas id="ordersChart"></canvas>
                </div>`;
        }

        function updateAnalytics() {
            if(!document.getElementById('total-products')) return; 
            document.getElementById('total-products').textContent = productsCache.length;
            const completedOrders = ordersCache.filter(o => o.status === 'completed');
            const totalRevenue = completedOrders.reduce((sum, order) => sum + (order.price || 0), 0);
            const totalProfit = completedOrders.reduce((sum, order) => sum + (order.profit || 0), 0);
            document.getElementById('total-revenue').textContent = `${totalRevenue.toLocaleString()} د.ج`;
            document.getElementById('total-profit').textContent = `${totalProfit.toLocaleString()} د.ج`;
            document.getElementById('total-orders').textContent = ordersCache.length;

            const last7Days = {};
            for(let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const key = d.toISOString().split('T')[0];
                last7Days[key] = 0;
            }

            completedOrders.forEach(order => {
                if (order.createdAt?.toDate) {
                    const orderDate = order.createdAt.toDate().toISOString().split('T')[0];
                    if (last7Days.hasOwnProperty(orderDate)) {
                        last7Days[orderDate]++;
                    }
                }
            });

            const chartLabels = Object.keys(last7Days).map(date => new Date(date).toLocaleDateString('ar-EG', { weekday: 'short', day: 'numeric'}));
            const chartData = Object.values(last7Days);

            const ctx = document.getElementById('ordersChart')?.getContext('2d');
            if (!ctx) return;
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'عدد الطلبات',
                        data: chartData,
                        backgroundColor: 'rgba(79, 70, 229, 0.8)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
            });
        }
        
        // ===================================
        // Categories Section
        // ===================================
        function loadCategories() {
            const panel = document.getElementById('categories-panel');
            panel.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-gray-800">إدارة الأقسام</h1><button id="add-category-btn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i> إضافة قسم</button></div><div id="categories-list" class="space-y-4"></div>`;
            document.getElementById('add-category-btn').addEventListener('click', () => showCategoryModal());
            const list = document.getElementById('categories-list');
            
            onSnapshot(query(collection(db, "categories"), orderBy("name")), (snapshot) => {
                categoriesCache = [];
                list.innerHTML = snapshot.empty ? '<p class="text-center text-gray-500">لا توجد أقسام. أضف قسماً جديداً للبدء.</p>' : '';
                snapshot.forEach(doc => {
                    const category = { id: doc.id, ...doc.data() };
                    categoriesCache.push(category);
                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded-xl shadow-md border flex flex-col md:flex-row justify-between md:items-center';
                    
                    const subcatHtml = (category.subcategories || []).map(sub => 
                        `<span class="inline-block ${sub.active ? 'bg-green-100 text-green-800' : 'bg-gray-200 text-gray-700'} px-3 py-1 rounded-full text-sm mr-2 mb-2">
                            ${sub.name} <i class="fas ${sub.active ? 'fa-check' : 'fa-times'} ml-1"></i>
                        </span>`
                    ).join('');

                    el.innerHTML = `
                        <div>
                            <h4 class="text-xl font-bold">${category.name}</h4>
                            <div class="mt-2 pl-4">${subcatHtml || '<p class="text-sm text-gray-500">لا توجد فروع</p>'}</div>
                        </div>
                        <div class="mt-3 md:mt-0 flex-shrink-0">
                            <button class="edit-category-btn text-indigo-500 hover:text-indigo-700 mr-4" data-id="${category.id}"><i class="fas fa-edit"></i> تعديل</button>
                            <button class="delete-category-btn text-red-500 hover:text-red-700" data-id="${category.id}"><i class="fas fa-trash"></i> حذف</button>
                        </div>`;
                    list.appendChild(el);
                });
                attachCategoryActionListeners();
            });
        }

        function showCategoryModal(category = null) {
            const title = category ? 'تعديل القسم' : 'إضافة قسم جديد';
            const subcategories = category?.subcategories || [];

            let subcategoriesHtml = subcategories.map((sub, index) => `
                <div class="flex items-center gap-2 mb-2 subcategory-item">
                    <input type="text" class="w-full p-2 border rounded sub-name" value="${sub.name || ''}" placeholder="اسم الفرع">
                    <label class="flex items-center gap-1 cursor-pointer text-sm"><input type="checkbox" class="sub-active" ${sub.active ? 'checked' : ''}> فعال</label>
                    <button type="button" class="text-red-500 remove-sub-btn"><i class="fas fa-times-circle"></i></button>
                </div>
            `).join('');

            const content = `
                <div><label class="font-semibold">اسم القسم الرئيسي</label><input type="text" id="category-name" class="mt-1 w-full p-2 border rounded" value="${category ? category.name : ''}" required></div>
                <div class="mt-4">
                    <label class="font-semibold">الفروع (Sub-categories)</label>
                    <div id="subcategories-container" class="mt-2 space-y-2 bg-gray-50 p-3 rounded-md">${subcategoriesHtml}</div>
                    <button type="button" id="add-subcategory-btn" class="text-sm mt-2 text-indigo-600 font-semibold hover:underline"><i class="fas fa-plus-circle mr-1"></i>إضافة فرع جديد</button>
                </div>`;

            showModal(title, content, async () => {
                const name = document.getElementById('category-name').value.trim();
                if (!name) { alert('الرجاء إدخال اسم القسم الرئيسي.'); return; }

                const subsData = [];
                document.querySelectorAll('.subcategory-item').forEach(item => {
                    const subName = item.querySelector('.sub-name').value.trim();
                    const subActive = item.querySelector('.sub-active').checked;
                    if(subName) subsData.push({ name: subName, active: subActive });
                });

                showLoadingModal();
                try {
                    const data = { name, subcategories: subsData };
                    if (category) await updateDoc(doc(db, "categories", category.id), data);
                    else await addDoc(collection(db, "categories"), data);
                    closeModal();
                } catch (error) {
                    console.error("Error saving category:", error);
                    alert("حدث خطأ أثناء الحفظ.");
                    closeModal();
                }
            });

            const addSubcategory = () => {
                const container = document.getElementById('subcategories-container');
                const newItem = document.createElement('div');
                newItem.className = 'flex items-center gap-2 mb-2 subcategory-item';
                newItem.innerHTML = `
                    <input type="text" class="w-full p-2 border rounded sub-name" placeholder="اسم الفرع">
                    <label class="flex items-center gap-1 cursor-pointer text-sm"><input type="checkbox" class="sub-active" checked> فعال</label>
                    <button type="button" class="text-red-500 remove-sub-btn"><i class="fas fa-times-circle"></i></button>
                `;
                newItem.querySelector('.remove-sub-btn').onclick = () => newItem.remove();
                container.appendChild(newItem);
            };

            document.getElementById('add-subcategory-btn').onclick = addSubcategory;
            document.querySelectorAll('.remove-sub-btn').forEach(btn => btn.onclick = (e) => e.currentTarget.closest('.subcategory-item').remove());
        }

        function attachCategoryActionListeners() {
            document.querySelectorAll('.edit-category-btn').forEach(btn => {
                btn.onclick = () => {
                    const category = categoriesCache.find(c => c.id === btn.dataset.id);
                    if (category) showCategoryModal(category);
                };
            });
            document.querySelectorAll('.delete-category-btn').forEach(btn => {
                btn.onclick = () => {
                    showModal('تأكيد الحذف', 'هل أنت متأكد من حذف هذا القسم؟ سيؤثر هذا على المنتجات المرتبطة به.', async () => {
                        try {
                            await deleteDoc(doc(db, "categories", btn.dataset.id));
                            closeModal();
                        } catch (error) { showModal('خطأ', 'فشل حذف القسم.', () => closeModal(), 'موافق', false); }
                    }, 'نعم, حذف', true);
                };
            });
        }
        
        // ===================================
        // Products Section
        // ===================================
        function loadProducts() {
            const panel = document.getElementById('products-panel');
            panel.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-gray-800">إدارة المنتجات</h1><button id="add-product-btn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i> إضافة منتج</button></div><div class="overflow-x-auto"><table class="w-full text-right responsive-table"><thead class="bg-gray-100"><tr><th class="p-3">الصورة</th><th class="p-3">الاسم</th><th class="p-3">القسم</th><th class="p-3">الفرع</th><th class="p-3">السعر</th><th class="p-3">الموقع</th><th class="p-3">إجراءات</th></tr></thead><tbody id="products-table-body"></tbody></table></div>`;
            document.getElementById('add-product-btn').addEventListener('click', () => showProductModal());
            const tableBody = document.getElementById('products-table-body');

            onSnapshot(query(collection(db, "products"), orderBy("createdAt", "desc")), (snapshot) => {
                productsCache = [];
                tableBody.innerHTML = snapshot.empty ? '<tr><td colspan="7" class="p-8 text-center text-gray-500">لا توجد منتجات. أضف منتجاً جديداً للبدء.</td></tr>' : '';
                snapshot.forEach(doc => {
                    const product = { id: doc.id, ...doc.data() };
                    productsCache.push(product);
                    const catName = categoriesCache.find(c => c.id === product.categoryId)?.name || '<span class="text-red-500">غير محدد</span>';
                    
                    const image = (product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls[0] : product.imageUrl;

                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = product.name;
                    const productNamePlainText = tempDiv.textContent || tempDiv.innerText || "";

                    const row = tableBody.insertRow();
                    row.className = 'border-b bg-white';
                    row.innerHTML = `
                        <td data-label="الصورة" class="p-3"><img src="${image || ''}" alt="${productNamePlainText}" class="w-16 h-16 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/64x64/e2e8f0/94a3b8?text=Error';"></td>
                        <td data-label="الاسم" class="p-3 font-semibold">${product.name}</td>
                        <td data-label="القسم" class="p-3">${catName}</td>
                        <td data-label="الفرع" class="p-3">${product.subCategoryName || '---'}</td>
                        <td data-label="السعر" class="p-3 font-mono">${(product.price || 0).toLocaleString()} د.ج</td>
                        <td data-label="الموقع" class="p-3">${product.location || '---'}</td>
                        <td data-label="إجراءات" class="p-3 actions-cell">
                            <button class="copy-product-link-btn text-green-500 hover:text-green-700 mr-4" data-id="${product.id}" title="نسخ رابط المنتج"><i class="fas fa-link fa-lg"></i></button>
                            <button class="edit-product-btn text-indigo-500 hover:text-indigo-700 mr-4" data-id="${product.id}"><i class="fas fa-edit fa-lg"></i></button>
                            <button class="delete-product-btn text-red-500 hover:text-red-700" data-id="${product.id}"><i class="fas fa-trash fa-lg"></i></button>
                        </td>`;
                });
                attachProductActionListeners();
                updateAnalytics();
            });
        }
        
        function populateSubcategories(categoryId, productSubCategory = null) {
            const subCategoryContainer = document.getElementById('product-subcategory-container');
            const subCategorySelect = document.getElementById('product-subcategory');
            if (!subCategoryContainer || !subCategorySelect) return;

            const selectedCategory = categoriesCache.find(c => c.id === categoryId);
            const activeSubcategories = selectedCategory?.subcategories?.filter(s => s.active) || [];

            if (activeSubcategories.length > 0) {
                subCategorySelect.innerHTML = '<option value="">اختر فرع...</option>';
                activeSubcategories.forEach(sub => {
                    const isSelected = sub.name === productSubCategory ? 'selected' : '';
                    subCategorySelect.innerHTML += `<option value="${sub.name}" ${isSelected}>${sub.name}</option>`;
                });
                subCategoryContainer.classList.remove('hidden');
            } else {
                subCategoryContainer.classList.add('hidden');
                subCategorySelect.innerHTML = '';
            }
        }
        
        function resizeAndCompressImage(file, maxWidth = 800, quality = 0.85) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        if (img.width <= maxWidth) {
                            resolve(file);
                            return;
                        }
                        const canvas = document.createElement('canvas');
                        const scale = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob(blob => {
                            resolve(blob);
                        }, 'image/jpeg', quality);
                    };
                };
                reader.onerror = error => reject(error);
            });
        }
      function showProductModal(product = null) {
            const title = product ? 'تعديل المنتج' : 'إضافة منتج جديد';
            
            const categoryOptions = categoriesCache.map(cat => 
                `<option value="${cat.id}" ${product && product.categoryId === cat.id ? 'selected' : ''}>${cat.name}</option>`
            ).join('');

            let existingImages = [];
            if (product) {
                if (product.imageUrls && product.imageUrls.length > 0) {
                    existingImages = product.imageUrls;
                } else if (product.imageUrl) {
                    existingImages = [product.imageUrl];
                }
            }

            const existingImagesHTML = existingImages.map(url => 
                `<div class="relative group"><img src="${url}" class="w-24 h-24 rounded object-cover border"><div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><span class="text-white text-xs text-center">سيتم حذفها عند رفع صور جديدة</span></div></div>`
            ).join('');
            
            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="font-semibold">اسم المنتج</label>
                        <div id="product-name-editor" class="mt-1 bg-white"></div>
                    </div>
                    <div><label class="font-semibold">السعر (د.ج)</label><input type="number" id="product-price" class="mt-1 w-full p-2 border rounded" value="${product ? product.price : ''}" required></div>
                    <div>
                        <label class="font-semibold">الوصف</label>
                        <textarea id="product-description" class="mt-1 w-full p-2 border rounded" rows="4" placeholder="اكتب وصفاً جذاباً للمنتج...">${product ? (product.description || '') : ''}</textarea>
                    </div>
                     <div>
                        <label class="font-semibold">موقع المنتج (اختياري)</label>
                        <input type="text" id="product-location" class="mt-1 w-full p-2 border rounded" value="${product ? product.location || '' : ''}" placeholder="مثال: مستودع الجزائر العاصمة">
                    </div>

                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4 mt-4">
                        <div>
                            <label class="font-semibold text-gray-700">المورد (داخلي)</label>
                            <input type="text" id="product-supplier" class="mt-1 w-full p-2 border rounded" value="${product ? product.supplier || '' : ''}" placeholder="اسم المورد أو الشركة">
                        </div>
                        <div>
                            <label class="font-semibold text-gray-700">تواصل المورد (داخلي)</label>
<textarea id="product-supplier-contact" class="mt-1 w-full p-2 border rounded" rows="3" placeholder="أرقام الهواتف، الإيميل، العنوان، ملاحظات...">${product ? product.supplierContact || '' : ''}</textarea>                        </div>
                    </div>
                     <div>
                        <label class="font-semibold text-green-700">الربح من هذا المنتج (داخلي)</label>
                        <input type="number" id="product-profit" class="mt-1 w-full p-2 border rounded" value="${product ? product.profit || '' : ''}" placeholder="0">
                    </div>
                    <div>
                        <label class="font-semibold">القسم الرئيسي</label>
                        <select id="product-category-select" class="mt-1 w-full p-2 border rounded bg-white" required>
                            <option value="">اختر قسم...</option>
                            ${categoryOptions}
                        </select>
                    </div>
                    <div id="product-subcategory-container" class="hidden">
                        <label class="font-semibold">الفرع</label>
                        <select id="product-subcategory" class="mt-1 w-full p-2 border rounded bg-white"></select>
                    </div>
                    <div>
                        <label class="font-semibold">صور المنتج (يمكنك اختيار عدة صور)</label>
                        <input type="file" id="product-images" class="mt-1 w-full p-2 border rounded text-sm" accept="image/*" multiple>
                         ${product ? `<p class="text-sm text-gray-500 mt-1">الصور الحالية. رفع صور جديدة سيقوم باستبدالها.</p><div class="flex flex-wrap gap-2 mt-2">${existingImagesHTML}</div>` : ''}
                        <div id="image-preview-container" class="flex flex-wrap gap-2 mt-2"></div>
                    </div>
                </div>`;
            
            let quill;

            showModal(title, content, async () => {
                const IMGBB_API_KEY = 'ac296feb5a275923598bdbfd4f9aed8c';

                let name = quill.root.innerHTML.trim();
                if (name === '<p><br></p>') name = '';

                const price = parseFloat(document.getElementById('product-price').value);
                const description = document.getElementById('product-description').value.trim();
                const location = document.getElementById('product-location').value.trim();
                const categoryId = document.getElementById('product-category-select').value;
                const subCategoryName = document.getElementById('product-subcategory').value || null;
                const imageFiles = document.getElementById('product-images').files;

                // START MODIFICATION: Get values from new fields
                const supplier = document.getElementById('product-supplier').value.trim();
                const supplierContact = document.getElementById('product-supplier-contact').value.trim();
                const profit = parseFloat(document.getElementById('product-profit').value) || 0;
                // END MODIFICATION

                if (!name || isNaN(price) || !categoryId) {
                    return showModal('خطأ في الإدخال', 'يرجى ملء الحقول الإلزامية: اسم المنتج، السعر، والقسم الرئيسي.', () => showProductModal(product), 'موافق', false);
                }
                
                if (IMGBB_API_KEY === 'YOUR_IMGBB_API_KEY' && imageFiles.length > 0) {
                    return showModal('خطأ في الإعداد', 'الرجاء وضع مفتاح API الخاص بك من موقع ImgBB في الكود أولاً (ملف dashboard.html).', () => showProductModal(product), 'موافق', false);
                }

                try {
                    let newImageUrls = [];
                    if (imageFiles.length === 0 && product) {
                        newImageUrls = product.imageUrls || (product.imageUrl ? [product.imageUrl] : []);
                    }

                    if (imageFiles.length > 0) {
                        showLoadingModal(`جاري ضغط ورفع الصور (${imageFiles.length})...`);
                        
                        const uploadPromises = Array.from(imageFiles).map(async file => {
                            const compressedBlob = await resizeAndCompressImage(file);
                            const formData = new FormData();
                            formData.append('image', compressedBlob);

                            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                            const result = await response.json();
                            if (result.success) return result.data.url;
                            else throw new Error(`فشل رفع الصورة: ${file.name}`);
                        });
                        newImageUrls = await Promise.all(uploadPromises);
                    }
                    
                    if (newImageUrls.length === 0 && !product) {
                         return showModal('خطأ', 'يجب رفع صورة واحدة على الأقل للمنتج الجديد.', () => showProductModal(product), 'موافق', false);
                    }

                    showLoadingModal('جاري حفظ البيانات...');
                    
                    // START MODIFICATION: Add new fields to the productData object
                    const productData = { 
                        name, 
                        price, 
                        description, 
                        location, 
                        categoryId, 
                        subCategoryName, 
                        imageUrls: newImageUrls, 
                        supplier, 
                        supplierContact,
                        profit,
                        updatedAt: serverTimestamp() 
                    };
                    // END MODIFICATION
                    
                    if (product) {
                        await updateDoc(doc(db, "products", product.id), productData);
                    } else {
                        productData.createdAt = serverTimestamp();
                        await addDoc(collection(db, "products"), productData);
                    }
                    closeModal();

                } catch (error) {
                    console.error("Error saving product:", error);
                    showModal('خطأ فادح', `فشل حفظ المنتج: ${error.message}`, () => closeModal(), 'موافق', false);
                }
            });
            
            quill = new Quill('#product-name-editor', {
                theme: 'snow',
                modules: { toolbar: [ ['bold', 'italic', 'underline'], [{ 'color': [] }] ] }
            });

            if (product && product.name) {
                quill.root.innerHTML = product.name;
            }

            const categorySelect = document.getElementById('product-category-select');
            categorySelect.addEventListener('change', (e) => populateSubcategories(e.target.value));
            
            const imageInput = document.getElementById('product-images');
            const previewContainer = document.getElementById('image-preview-container');
            imageInput.addEventListener('change', () => {
                previewContainer.innerHTML = ''; 
                Array.from(imageInput.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'w-24 h-24 rounded object-cover border';
                        previewContainer.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                });
            });

            if (product && product.categoryId) {
                populateSubcategories(product.categoryId, product.subCategoryName);
            }
        }
  function attachProductActionListeners() {
    // Edit Product
    document.querySelectorAll('.edit-product-btn').forEach(btn => {
        btn.onclick = () => {
            const product = productsCache.find(p => p.id === btn.dataset.id);
            if (product) showProductModal(product);
        };
    });
    // Delete Product
    document.querySelectorAll('.delete-product-btn').forEach(btn => {
        btn.onclick = () => {
            const { id } = btn.dataset;
            showModal('تأكيد الحذف', 'هل أنت متأكد من حذف هذا المنتج؟ لا يمكن التراجع عن هذا الإجراء.', async () => {
                showLoadingModal('جاري الحذف...');
                try {
                    await deleteDoc(doc(db, "products", id));
                    closeModal();
                } catch (error) {
                    showModal('خطأ', `فشل حذف المنتج: ${error.message}`, () => closeModal(), 'موافق', false);
                }
            }, 'نعم, حذف', true);
        };
    });

    // Copy Product Link
    document.querySelectorAll('.copy-product-link-btn').forEach(btn => {
        btn.onclick = (e) => {
            const button = e.currentTarget;
            const productId = button.dataset.id;
            const productUrl = `https://s22market.github.io/S22MARKET/index.html?product=${productId}`;

            navigator.clipboard.writeText(productUrl).then(() => {
                const originalIcon = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check text-green-500 fa-lg"></i>'; // Success icon
                setTimeout(() => {
                    button.innerHTML = originalIcon;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy link: ', err);
                alert('فشل نسخ الرابط. يرجى نسخه يدوياً.');
            });
        };
    });
}
        
        // ===================================
        // Orders Section
        // ===================================
        function loadOrders() {
            const panel = document.getElementById('orders-panel');
            panel.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">الطلبات الواردة</h1>
                       <div class="overflow-x-auto bg-white rounded-xl shadow-md">
                         <table class="w-full text-right responsive-table">
                           <thead class="bg-gray-100">
                             <tr>
                               <th class="p-3 font-semibold">العميل</th><th class="p-3 font-semibold">الهاتف</th>
                               <th class="p-3 font-semibold">الموقع</th><th class="p-3 font-semibold">المنتج</th>
                               <th class="p-3 font-semibold">المبلغ</th><th class="p-3 font-semibold">الربح</th>
                               <th class="p-3 font-semibold">الاستفسار</th><th class="p-3 font-semibold">الحالة</th>
                               <th class="p-3 font-semibold">تمت بواسطة</th><th class="p-3 font-semibold">الموردون</th>
                               <th class="p-3 font-semibold">التاريخ</th><th class="p-3 font-semibold">إجراءات</th>
                             </tr>
                           </thead>
                           <tbody id="orders-table-body"></tbody>
                         </table>
                       </div>`;
            const tableBody = document.getElementById('orders-table-body');
            
            onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), (snapshot) => {
                ordersCache = []; 
                tableBody.innerHTML = snapshot.empty ? `<tr><td colspan="12" class="p-8 text-center text-gray-500">لا توجد طلبات حاليًا.</td></tr>` : '';

                snapshot.forEach(doc => {
                    const order = { id: doc.id, ...doc.data() };
                    ordersCache.push(order);
                    const date = order.createdAt?.toDate().toLocaleDateString('ar-EG-u-nu-latn', { year: 'numeric', month: 'short', day: 'numeric' }) || 'N/A';
                    
                    const statusColor = order.status === 'completed' ? 'bg-green-100 text-green-800' : (order.status === 'canceled' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800');
                    const rowColor = order.status === 'completed' ? 'bg-green-50/50' : (order.status === 'canceled' ? 'bg-red-50/50' : 'bg-white');

                    const row = tableBody.insertRow();
                    row.className = `border-b ${rowColor} transition-colors`;
                    row.innerHTML = `
                        <td data-label="العميل" class="p-3 font-semibold">${order.customerName}</td>
                        <td data-label="الهاتف" class="p-3 font-mono" dir="ltr"><a href="tel:${order.customerContact}" class="hover:underline">${order.customerContact}</a></td>
                        <td data-label="الموقع" class="p-3 text-sm font-medium">${order.customerLocation || '---'}</td>
                        <td data-label="المنتج" class="p-3">${order.quantity} x ${order.productName}</td>
                        <td data-label="المبلغ" class="p-3 font-mono">${(order.price || 0).toLocaleString()} د.ج</td>
                        <td data-label="الربح" class="p-3"><input type="number" class="profit-input w-24 p-1 border rounded text-center font-mono transition-colors" placeholder="0" value="${order.profit || ''}" data-id="${order.id}"></td>
                        <td data-label="الاستفسار" class="p-3 text-sm text-gray-600">${order.customerInquiry || '---'}</td>
                        <td data-label="الحالة" class="p-3 actions-cell">
                            <select class="order-status-select p-2 rounded-lg border-gray-300 ${statusColor}" data-id="${order.id}">
                                <option value="new" ${order.status === 'new' ? 'selected' : ''}>جديد</option>
                                <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>مكتمل</option>
                                <option value="canceled" ${order.status === 'canceled' ? 'selected' : ''}>ملغي</option>
                            </select>
                        </td>
                        <td data-label="تمت بواسطة" class="p-3"><input type="text" class="doneBy-input w-full p-2 border rounded transition-colors" placeholder="اكتب هنا..." value="${order.doneBy || ''}" data-id="${order.id}"></td>
                        <td data-label="الموردون" class="p-3"><textarea rows="3" class="suppliers-textarea w-full p-2 border rounded transition-colors" placeholder="اكتب هنا..." maxlength="500" data-id="${order.id}">${order.suppliers || ''}</textarea></td>
                        <td data-label="التاريخ" class="p-3 font-mono text-sm">${date}</td>
                        <td data-label="إجراءات" class="p-3"><button class="delete-order-btn text-red-500 hover:text-red-700" data-id="${order.id}"><i class="fas fa-trash fa-lg"></i></button></td>
                    `;
                });
                
                attachOrderActionListeners();
                updateAnalytics(); 
            });
        }
        
        function attachOrderActionListeners() {
            document.querySelectorAll('.order-status-select').forEach(select => {
                select.onchange = async (e) => {
                    await updateDoc(doc(db, "orders", e.target.dataset.id), { status: e.target.value });
                };
            });
            
            const addDebouncedListener = (selector, fieldName, isNumeric = false) => {
                document.querySelectorAll(selector).forEach(input => {
                    let debounceTimer;
                    input.onkeyup = (e) => {
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(async () => {
                            const id = e.target.dataset.id;
                            let value = e.target.value;
                            if (isNumeric) value = parseFloat(value) || 0;
                            try {
                                await updateDoc(doc(db, "orders", id), { [fieldName]: value });
                                e.target.classList.add('border-green-400');
                                setTimeout(() => e.target.classList.remove('border-green-400'), 2000);
                            } catch (error) { e.target.classList.add('border-red-400'); }
                        }, 1000);
                    };
                });
            };
            
            addDebouncedListener('.profit-input', 'profit', true);
            addDebouncedListener('.doneBy-input', 'doneBy');
            addDebouncedListener('.suppliers-textarea', 'suppliers');
            
            document.querySelectorAll('.delete-order-btn').forEach(btn => {
                btn.onclick = () => {
                    const { id } = btn.dataset;
                    showModal('تأكيد الحذف', 'هل أنت متأكد من حذف هذا الطلب؟ لا يمكن التراجع عن هذا الإجراء.', async () => {
                        showLoadingModal('جاري الحذف...');
                        try {
                            await deleteDoc(doc(db, "orders", id));
                            closeModal();
                        } catch (error) {
                            showModal('خطأ', `فشل حذف الطلب: ${error.message}`, () => closeModal(), 'موافق', false);
                        }
                    }, 'نعم, حذف', true);
                };
            });
        }
        
        // --- Modal & Utility Functions ---
        function showModal(title, content, onConfirm, confirmText = 'حفظ', showCancel = true) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div class="modal-backdrop" id="modal-backdrop">
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-4 border-b pb-3"><h3 class="text-xl font-bold">${title}</h3><button id="modal-close-btn" class="text-gray-400 hover:text-gray-800 text-2xl">&times;</button></div>
                        <div id="modal-body">${content}</div>
                        <div class="flex justify-end gap-4 mt-6 border-t pt-4">
                            ${showCancel ? `<button id="modal-cancel" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg font-semibold hover:bg-gray-300">إلغاء</button>` : ''}
                            <button id="modal-confirm" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-indigo-700">${confirmText}</button>
                        </div>
                    </div>
                </div>`;
            if (showCancel) document.getElementById('modal-cancel').addEventListener('click', closeModal);
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
            document.getElementById('modal-backdrop').addEventListener('click', (e) => { if (e.target.id === 'modal-backdrop' && showCancel) closeModal(); });
            document.getElementById('modal-confirm').addEventListener('click', onConfirm);
        }

        function closeModal() { document.getElementById('modal-container').innerHTML = ''; }
        function showLoadingModal(text = 'جاري الحفظ...') {
             document.getElementById('modal-container').innerHTML = `<div class="modal-backdrop"><div class="modal-content text-center"><div class="loader mx-auto"></div><p class="mt-4 text-lg font-semibold text-gray-700">${text}</p></div></div>`;
        }

        const adminPassword = document.getElementById('admin-password');
        const togglePasswordBtn = document.getElementById('toggle-password');
        if (togglePasswordBtn) {
            togglePasswordBtn.addEventListener('click', () => {
                const type = adminPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                adminPassword.setAttribute('type', type);
                togglePasswordBtn.querySelector('i').classList.toggle('fa-eye');
                togglePasswordBtn.querySelector('i').classList.toggle('fa-eye-slash');
            });
        }
    </script>
</body>
</html>