<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="app-style.css">
    <script src="theme-manager.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ThemeManager.createFloatingSwitcher(); // Deprecated in favor of Sidebar
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f0f2f5;
        }

        .hidden {
            display: none;
        }

        .dashboard-tab:hover {
            background-color: #4338ca;
        }

        .dashboard-tab.active-tab {
            background-color: #4f46e5;
            color: white;
            font-weight: bold;
        }

        .dashboard-panel {
            animation: fadeIn 0.5s;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Skeleton & Animations */
        .skeleton {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
            display: inline-block;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div id="dashboard-page" class="hidden">
        <div class="relative min-h-screen md:flex">
            <div class="bg-gray-800 text-gray-100 flex justify-between md:hidden">
                <a href="dashboard.html" class="block p-4 text-white font-bold">S22 Market</a>
                <button id="mobile-menu-btn" class="p-4 focus:outline-none focus:bg-gray-700">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <aside id="sidebar"
                class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 right-0 transform translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30">
                <div class="p-3 text-center border-b border-gray-700">
                    <h2 class="text-2xl font-bold">S22 Market</h2>
                    <p id="admin-welcome-name" class="text-sm text-indigo-300">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
                <nav class="flex-1 p-2 space-y-2">
                    <a href="dashboard.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-chart-line fa-fw mr-3"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
                    <a href="admin-subscriptions.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-crown fa-fw mr-3 text-yellow-500"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</a>
                    <a href="admin-contributions.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-headset fa-fw mr-3"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø§Øª</a>

                    <a href="admin-layout.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-chart-line fa-fw mr-3"></i> Ù‚ÙˆØ§Ø¦Ù… ØµÙØ­Ø© Ø§Ù„Ù…ØªØ¬Ø± </a>


                    <a href="admin-sellers.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700 relative">
                        <i class="fas fa-users-cog fa-fw mr-3"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹ÙŠÙ†
                        <span id="sellers-badge"
                            class="hidden absolute left-4 bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">0</span>
                    </a>
                    <a href="admin-reports.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-flag fa-fw mr-3 text-red-400"></i> Ø§Ù„Ø¥Ø¨Ù„Ø§ØºØ§Øª</a>
                    <a href="admin-products.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-boxes fa-fw mr-3"></i> Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
                    <a href="admin-offers.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-star fa-fw mr-3"></i> Ø§Ù„Ø¹Ø±ÙˆØ¶</a>
                    <a href="admin-product-requests.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-user-plus fa-fw mr-3"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²ÙˆØ§Ø±</a>
                    <a href="admin-categories.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-sitemap fa-fw mr-3"></i> Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</a>
                    <a href="admin-orders.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-clipboard-list fa-fw mr-3"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
                    <a href="admin-coupons.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-tags fa-fw mr-3"></i> Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª</a>
                    <a href="admin-inquiries.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-envelope-open-text fa-fw mr-3"></i> Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</a>
                    <a href="admin-applications.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fab fa-google-play fa-fw mr-3"></i> Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</a>
                    <a href="admin-layout.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-layer-group fa-fw mr-3"></i> ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ØªØ¬Ø±</a>
                    <a href="admin-notepad.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-book fa-fw mr-3"></i> Ø§Ù„Ù…ÙÙƒØ±Ø©</a>



                    <a href="admin-settings.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-cogs fa-fw mr-3"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±</a>

                    <hr class="border-gray-700 my-2">
                    <h6 class="px-4 text-xs font-semibold text-gray-400 uppercase">Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©</h6>
                    <a href="dawarat_admin_manager.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"
                        target="_blank">
                        <i class="fas fa-graduation-cap fa-fw mr-3 text-gray-400"></i>
                        <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø°Ù„ÙˆØ±Ø§Øª</span>
                        <i class="fas fa-external-link-alt fa-xs ml-auto"></i>
                    </a>

                </nav>
                <div class="p-4 border-t border-gray-700">
                    <button id="logout-btn"
                        class="w-full bg-red-600 py-2 rounded-md hover:bg-red-700 transition-colors"><i
                            class="fas fa-sign-out-alt mr-2"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                    <!-- Theme Switcher Container -->
                    <div id="sidebar-theme-container"></div>
                </div>
            </aside>


            <main class="flex-1 p-4 md:p-8 overflow-y-auto bg-gray-100">
                <!-- Header with Greeting -->
                <div
                    class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl shadow-2xl p-6 sm:p-8 mb-6 text-white">
                    <h2 class="text-3xl sm:text-4xl font-black mb-2">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ğŸ‘‹</h2>
                    <p class="text-indigo-100 text-sm sm:text-base">Ø¥Ù„ÙŠÙƒ Ù†Ø¸Ø±Ø© Ø³Ø±ÙŠØ¹Ø© Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ÙŠÙˆÙ…</p>
                </div>

                <!-- Overview Statistics Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8">

                    <!-- Total Users Card -->
                    <div
                        class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-blue-500 hover:shadow-xl transition-all transform hover:scale-105">
                        <div class="flex items-center justify-between mb-4">
                            <div class="bg-blue-100 p-3 rounded-xl">
                                <i class="fas fa-users text-blue-600 text-2xl"></i>
                            </div>
                            <span
                                class="text-xs font-semibold text-blue-600 bg-blue-100 px-2 py-1 rounded-full">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                        </div>
                        <h3 class="text-gray-600 text-sm font-semibold mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                        <p class="text-3xl font-black text-gray-800" id="total-users">0</p>
                        <p class="text-xs text-gray-500 mt-2">Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©</p>
                    </div>

                    <!-- Total Products Card -->
                    <div
                        class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-green-500 hover:shadow-xl transition-all transform hover:scale-105">
                        <div class="flex items-center justify-between mb-4">
                            <div class="bg-green-100 p-3 rounded-xl">
                                <i class="fas fa-box text-green-600 text-2xl"></i>
                            </div>
                            <span
                                class="text-xs font-semibold text-green-600 bg-green-100 px-2 py-1 rounded-full">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
                        </div>
                        <h3 class="text-gray-600 text-sm font-semibold mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
                        <p class="text-3xl font-black text-gray-800" id="total-products">0</p>
                        <p class="text-xs text-gray-500 mt-2">Ù…Ù†ØªØ¬ Ù…Ø¹Ø±ÙˆØ¶</p>
                    </div>

                    <!-- Total Orders Card -->
                    <div
                        class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-purple-500 hover:shadow-xl transition-all transform hover:scale-105">
                        <div class="flex items-center justify-between mb-4">
                            <div class="bg-purple-100 p-3 rounded-xl">
                                <i class="fas fa-shopping-cart text-purple-600 text-2xl"></i>
                            </div>
                            <span
                                class="text-xs font-semibold text-purple-600 bg-purple-100 px-2 py-1 rounded-full">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
                        </div>
                        <h3 class="text-gray-600 text-sm font-semibold mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
                        <p class="text-3xl font-black text-gray-800" id="total-orders">0</p>
                        <p class="text-xs text-gray-500 mt-2">Ø·Ù„Ø¨ Ù…ÙƒØªÙ…Ù„</p>
                    </div>

                    <!-- Pending Approvals Card -->
                    <div
                        class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-orange-500 hover:shadow-xl transition-all transform hover:scale-105">
                        <div class="flex items-center justify-between mb-4">
                            <div class="bg-orange-100 p-3 rounded-xl">
                                <i class="fas fa-clock text-orange-600 text-2xl"></i>
                            </div>
                            <span
                                class="text-xs font-semibold text-orange-600 bg-orange-100 px-2 py-1 rounded-full animate-pulse"
                                id="pending-count-badge">0</span>
                        </div>
                        <h3 class="text-gray-600 text-sm font-semibold mb-1">Ù…Ø¹Ù„Ù‚ Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©</h3>
                        <p class="text-3xl font-black text-gray-800" id="total-pending">0</p>
                        <p class="text-xs text-gray-500 mt-2">Ø¨Ø­Ø§Ø¬Ø© Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</p>
                    </div>
                </div>

                <!-- Quick Actions Panel -->
                <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
                    <h3 class="text-xl font-black text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-bolt text-yellow-500"></i>
                        Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©
                    </h3>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <a href="admin-sellers.html"
                            class="flex flex-col items-center gap-2 p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl hover:shadow-md transition-all hover:scale-105 cursor-pointer group">
                            <div class="bg-blue-600 p-3 rounded-full group-hover:bg-blue-700 transition-colors">
                                <i class="fas fa-store text-white text-xl"></i>
                            </div>
                            <span class="text-sm font-bold text-gray-700 text-center">Ù…ÙˆØ§ÙÙ‚Ø© Ù…ØªØ§Ø¬Ø±</span>
                        </a>

                        <a href="admin-product-requests.html"
                            class="flex flex-col items-center gap-2 p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-xl hover:shadow-md transition-all hover:scale-105 cursor-pointer group">
                            <div class="bg-green-600 p-3 rounded-full group-hover:bg-green-700 transition-colors">
                                <i class="fas fa-box text-white text-xl"></i>
                            </div>
                            <span class="text-sm font-bold text-gray-700 text-center">Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ù†ØªØ¬Ø§Øª</span>
                        </a>

                        <a href="admin-offers.html"
                            class="flex flex-col items-center gap-2 p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl hover:shadow-md transition-all hover:scale-105 cursor-pointer group">
                            <div class="bg-purple-600 p-3 rounded-full group-hover:bg-purple-700 transition-colors">
                                <i class="fas fa-tags text-white text-xl"></i>
                            </div>
                            <span class="text-sm font-bold text-gray-700 text-center">Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶</span>
                        </a>

                        <a href="admin-inquiries.html"
                            class="flex flex-col items-center gap-2 p-4 bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl hover:shadow-md transition-all hover:scale-105 cursor-pointer group">
                            <div class="bg-orange-600 p-3 rounded-full group-hover:bg-orange-700 transition-colors">
                                <i class="fas fa-comments text-white text-xl"></i>
                            </div>
                            <span class="text-sm font-bold text-gray-700 text-center">Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª</span>
                        </a>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Sales Chart Placeholder -->
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h3 class="text-lg font-black text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-chart-line text-indigo-600"></i>
                            ğŸ“ˆ Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
                        </h3>
                        <canvas id="salesChart" style="max-height: 250px;"></canvas>
                    </div>

                    <!-- Categories Breakdown Placeholder -->
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h3 class="text-lg font-black text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-chart-pie text-purple-600"></i>
                            ğŸ“Š Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹
                        </h3>
                        <canvas id="categoriesChart" style="max-height: 250px;"></canvas>
                    </div>
                </div>

                <!-- Recent Activity Feed -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-xl font-black text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-history text-indigo-600"></i>
                        Ø¢Ø®Ø± Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
                    </h3>
                    <div id="recent-activity" class="space-y-3">
                        <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                            <div class="loader w-8 h-8 border-2"></div>
                            <span class="text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª...</span>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, browserLocalPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- INLINED AUTH (Self-Contained) ---
        async function requireAuth(authInstance) {
            await setPersistence(authInstance, browserLocalPersistence);
            return new Promise((resolve) => {
                const unsubscribe = onAuthStateChanged(authInstance, (user) => {
                    if (!user) {
                        window.location.href = 'admin-login.html';
                        resolve(null);
                    } else {
                        resolve(user);
                    }
                    unsubscribe();
                });
            });
        }

        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Keep for reference
        const ADMIN_EMAILS = [
            's22market@gmail.com',
            'yacinee474474@gmail.com',
            'nourmt01@gmail.com'
        ];

        let productsCache = [];
        let ordersCache = [];
        let myChart = null;
        let profitChart = null;
        let topProductsChart = null;

        const dashboardPage = document.getElementById('dashboard-page');
        const logoutBtn = document.getElementById('logout-btn');
        const getEl = (id) => document.getElementById(id);

        // ============================================================
        // Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© (Guard)
        // ============================================================
        requireAuth(auth).then(async (user) => {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            const isAdminEmail = ADMIN_EMAILS.includes(user.email);
            const isAdminRole = userDoc.exists() && userDoc.data().role === 'admin';

            if (isAdminRole || isAdminEmail) {
                dashboardPage.classList.remove('hidden');
                getEl('admin-welcome-name').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${user.displayName || user.email.split('@')[0]}`;
                initializeDashboard();
                ThemeManager.renderSidebarControl('sidebar-theme-container'); // Sidebar Theme
            } else {
                window.location.href = 'index.html';
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = 'admin-login.html';
        });

        function loadRecentActivity() {
            const container = getEl('recent-activity');

            // Subscribe to multiple collections for real-time feed
            const qOrders = query(collection(db, "orders"), orderBy("createdAt", "desc"), limit(5));
            const qUsers = query(collection(db, "users"), orderBy("createdAt", "desc"), limit(5));

            // We'll use a snapshot on orders mostly as primary activity
            onSnapshot(qOrders, (orderSnap) => {
                const activities = [];

                orderSnap.forEach(doc => {
                    const data = doc.data();
                    activities.push({
                        type: 'order',
                        text: `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¨Ù‚ÙŠÙ…Ø© ${data.total || 0} Ø¯.Ø¬`,
                        subtext: `Ù…Ù† Ø§Ù„Ø³ÙŠØ¯Ø©/Ø§Ù„Ø³ÙŠØ¯ ${data.customerName || 'Ø¹Ù…ÙŠÙ„'}`,
                        time: data.createdAt,
                        icon: 'fa-shopping-bag',
                        color: 'bg-indigo-100 text-indigo-600'
                    });
                });

                // Render immediately
                renderActivities(container, activities);
            });
        }

        function renderActivities(container, items) {
            if (items.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø´Ø§Ø·Ø§Øª Ø­Ø¯ÙŠØ«Ø©</div>';
                return;
            }

            container.innerHTML = items.map(item => {
                // Time Formatting
                let timeStr = 'Ø§Ù„Ø¢Ù†';
                if (item.time && item.time.toDate) {
                    const date = item.time.toDate();
                    timeStr = date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                }

                return `
                <div class="flex items-start gap-4 p-3 hover:bg-gray-50 rounded-xl transition-colors border-b border-gray-50 last:border-0">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center ${item.color} flex-shrink-0">
                        <i class="fas ${item.icon}"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="font-bold text-gray-800 text-sm">${item.text}</h4>
                        <p class="text-xs text-gray-500">${item.subtext}</p>
                    </div>
                    <span class="text-[10px] font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded-full">${timeStr}</span>
                </div>
                `;
            }).join('');
        }

        // --- Sidebar Logic Enhanced ---
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');

        // Add Overlay and Close Button dynamically
        const overlay = document.createElement('div');
        overlay.className = 'fixed inset-0 bg-black/50 z-20 hidden md:hidden transition-opacity opacity-0';
        document.body.appendChild(overlay);

        // Add Close Button to Sidebar Header
        const sidebarHeader = sidebar.querySelector('div.border-b'); // Targeting the existing header
        const closeBtn = document.createElement('button');
        closeBtn.className = 'absolute top-4 left-4 text-gray-400 hover:text-white md:hidden';
        closeBtn.innerHTML = '<i class="fas fa-times text-xl"></i>';
        closeBtn.onclick = closeSidebar;
        if (sidebarHeader) sidebarHeader.appendChild(closeBtn);

        function openSidebar() {
            sidebar.classList.remove('translate-x-full');
            overlay.classList.remove('hidden');
            setTimeout(() => overlay.classList.remove('opacity-0'), 10);
        }

        function closeSidebar() {
            sidebar.classList.add('translate-x-full');
            overlay.classList.add('opacity-0');
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }

        if (mobileMenuBtn) {
            mobileMenuBtn.onclick = (e) => {
                e.stopPropagation();
                openSidebar();
            };
        }

        overlay.onclick = closeSidebar;

        // Auto-refresh logic removal/cleanup if needed (none here)

        // Update init
        function initializeDashboard() {
            setActiveTab();
            loadAnalytics();
            loadRecentActivity(); // Added Call

            // ... (rest of listeners)
            onSnapshot(query(collection(db, "products")), (snapshot) => {
                productsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAnalytics();
            });
            onSnapshot(query(collection(db, "orders")), (snapshot) => {
                ordersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAnalytics();
            });
            onSnapshot(query(collection(db, "users"), where("storeRequest.status", "==", "pending")), (snapshot) => {
                const count = snapshot.size;
                const badge = document.getElementById('sellers-badge');
                if (badge) {
                    badge.textContent = count > 0 ? count : '';
                    if (count > 0) badge.classList.remove('hidden'); else badge.classList.add('hidden');
                }
            });
        }

        function loadAnalytics() {
            const panel = document.getElementById('analytics-panel');
            panel.innerHTML = `
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ù„Ù…ØªØ¬Ø±)</h1>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <i class="fas fa-hand-holding-usd text-4xl text-green-500 mr-4"></i>
                    <div><p class="text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</p><p id="total-profit" class="text-2xl font-bold"><span class="skeleton w-24 h-8"></span></p></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <i class="fas fa-divide text-4xl text-yellow-500 mr-4"></i>
                    <div><p class="text-gray-500">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø±Ø¨Ø­ / Ø·Ù„Ø¨</p><p id="avg-profit" class="text-2xl font-bold"><span class="skeleton w-20 h-8"></span></p></div>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <i class="fas fa-check-circle text-4xl text-blue-500 mr-4"></i>
                    <div><p class="text-gray-500">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</p><p id="completed-orders" class="text-2xl font-bold"><span class="skeleton w-16 h-8"></span></p></div>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <i class="fas fa-spinner text-4xl text-orange-500 mr-4"></i>
                    <div><p class="text-gray-500">Ø§Ù„Ø·Ù„Ø¨Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</p><p id="incomplete-orders" class="text-2xl font-bold"><span class="skeleton w-16 h-8"></span></p></div>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-md flex items-center col-span-1 sm:col-span-2 lg:col-span-4">
                    <i class="fas fa-boxes text-4xl text-purple-500 mr-4"></i>
                    <div><p class="text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø§Ù„Ù†Ø´Ø·Ø©)</p><p id="total-products" class="text-2xl font-bold"><span class="skeleton w-16 h-8"></span></p></div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© (Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…)</h2>
                    <canvas id="ordersChart"></canvas>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4">Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…)</h2>
                    <canvas id="profitChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-bold mb-4">Ø£Ø¹Ù„Ù‰ 7 Ù…Ù†ØªØ¬Ø§Øª ØªØ­Ù‚ÙŠÙ‚Ù‹Ø§ Ù„Ù„Ø£Ø±Ø¨Ø§Ø­</h2>
                <canvas id="topProductsChart"></canvas>
            </div>
            `;
        }

        function updateAnalytics() {
            if (!getEl('total-products')) return;

            // 1. ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª + Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© (sold_out Ù„Ø§ ÙŠØ³ØªØ¨Ø¹Ø¯ Ù…Ù† Ø§Ù„Ø¥Ø­ØµØ§Ø¡ Ù„Ø£Ù†Ù‡ Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯)
            const marketProducts = productsCache.filter(p => p.productType !== 'course');

            const completedOrders = ordersCache.filter(o => o.status === 'completed');
            const incompleteOrders = ordersCache.filter(o => o.status === 'new' || o.status === 'pending'); // Ø´Ù…Ù„Ù†Ø§ pending
            const totalProfit = completedOrders.reduce((sum, order) => sum + (order.profit || 0), 0);
            const completedOrdersCount = completedOrders.length;
            const incompleteOrdersCount = incompleteOrders.length;
            const avgProfit = completedOrdersCount > 0 ? totalProfit / completedOrdersCount : 0;

            // Animate values
            animateValue(getEl('total-products'), 0, marketProducts.length, 1000);
            animateValue(getEl('total-profit'), 0, totalProfit, 1500);
            animateValue(getEl('avg-profit'), 0, parseInt(avgProfit.toFixed(0)), 1200);
            animateValue(getEl('completed-orders'), 0, completedOrdersCount, 800);
            animateValue(getEl('incomplete-orders'), 0, incompleteOrdersCount, 800);

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø®Ø·Ø·Ø§Øª (Charts)
            const last7Days = {};
            const last7DaysProfit = {};

            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const key = d.toISOString().split('T')[0];
                last7Days[key] = 0;
                last7DaysProfit[key] = 0;
            }

            completedOrders.forEach(order => {
                if (order.createdAt?.toDate) {
                    const orderDate = order.createdAt.toDate().toISOString().split('T')[0];
                    if (last7Days.hasOwnProperty(orderDate)) {
                        last7Days[orderDate]++;
                        last7DaysProfit[orderDate] += (order.profit || 0);
                    }
                }
            });

            const chartLabels = Object.keys(last7Days).map(date => new Date(date).toLocaleDateString('ar-EG', { weekday: 'short', day: 'numeric' }));

            const ordersChartData = Object.values(last7Days);
            const ordersCtx = getEl('ordersChart')?.getContext('2d');
            if (ordersCtx) {
                if (myChart) myChart.destroy();
                myChart = new Chart(ordersCtx, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
                            data: ordersChartData,
                            backgroundColor: 'rgba(79, 70, 229, 0.8)',
                            borderColor: 'rgba(79, 70, 229, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
                });
            }

            const profitChartData = Object.values(last7DaysProfit);
            const profitCtx = getEl('profitChart')?.getContext('2d');
            if (profitCtx) {
                if (profitChart) profitChart.destroy();
                profitChart = new Chart(profitCtx, {
                    type: 'line',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ (Ø¯.Ø¬)',
                            data: profitChartData,
                            backgroundColor: 'rgba(22, 163, 74, 0.2)',
                            borderColor: 'rgba(22, 163, 74, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                });
            }

            const productProfits = {};
            completedOrders.forEach(order => {
                (order.items || []).forEach(item => {
                    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù… Ù„Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ HTML Ù‚Ø¯ÙŠÙ…
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = item.name || 'Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    const productName = tempDiv.textContent || tempDiv.innerText || "";

                    // Ø­Ø³Ø§Ø¨ Ø±Ø¨Ø­ ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„ÙƒÙ„ Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨
                    const itemProfit = (order.profit || 0) / (order.items.length || 1);
                    if (productProfits[productName]) {
                        productProfits[productName] += itemProfit;
                    } else {
                        productProfits[productName] = itemProfit;
                    }
                });
            });
            const sortedProducts = Object.entries(productProfits).sort(([, a], [, b]) => b - a).slice(0, 7);
            const topProductsLabels = sortedProducts.map(p => p[0]);
            const topProductsData = sortedProducts.map(p => p[1]);
            const topProductsCtx = getEl('topProductsChart')?.getContext('2d');
            if (topProductsCtx) {
                if (topProductsChart) topProductsChart.destroy();
                topProductsChart = new Chart(topProductsCtx, {
                    type: 'bar',
                    data: {
                        labels: topProductsLabels,
                        datasets: [{
                            label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­',
                            data: topProductsData,
                            backgroundColor: 'rgba(153, 102, 255, 0.8)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­ (Ø¯.Ø¬)' } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function (context) { return `Ø§Ù„Ø±Ø¨Ø­: ${context.parsed.y.toLocaleString()} Ø¯.Ø¬`; } } } } }
                });
            }
        }
    </script>
</body>

</html>