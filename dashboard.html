<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f0f2f5;
        }

        .hidden {
            display: none;
        }

        .dashboard-tab:hover {
            background-color: #4338ca;
        }

        .dashboard-tab.active-tab {
            background-color: #4f46e5;
            color: white;
            font-weight: bold;
        }

        .dashboard-panel {
            animation: fadeIn 0.5s;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div id="dashboard-page" class="hidden">
        <div class="relative min-h-screen md:flex">
            <div class="bg-gray-800 text-gray-100 flex justify-between md:hidden">
                <a href="dashboard.html" class="block p-4 text-white font-bold">S22 Market</a>
                <button id="mobile-menu-btn" class="p-4 focus:outline-none focus:bg-gray-700">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <aside id="sidebar"
                class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 right-0 transform translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30">
                <div class="p-3 text-center border-b border-gray-700">
                    <h2 class="text-2xl font-bold">S22 Market</h2>
                    <p id="admin-welcome-name" class="text-sm text-indigo-300">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
                <nav class="flex-1 p-2 space-y-2">
                    <a href="dashboard.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-chart-line fa-fw mr-3"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>

                    <a href="admin-layout.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-chart-line fa-fw mr-3"></i> Ù‚ÙˆØ§Ø¦Ù… ØµÙØ­Ø© Ø§Ù„Ù…ØªØ¬Ø± </a>


                    <a href="admin-sellers.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700 relative">
                        <i class="fas fa-users-cog fa-fw mr-3"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹ÙŠÙ†
                        <span id="sellers-badge"
                            class="hidden absolute left-4 bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">0</span>
                    </a>
                    <a href="admin-reports.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-flag fa-fw mr-3 text-red-400"></i> Ø§Ù„Ø¥Ø¨Ù„Ø§ØºØ§Øª</a>
                    <a href="admin-products.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-boxes fa-fw mr-3"></i> Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
                    <a href="admin-offers.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-star fa-fw mr-3"></i> Ø§Ù„Ø¹Ø±ÙˆØ¶</a>
                    <a href="admin-product-requests.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-user-plus fa-fw mr-3"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²ÙˆØ§Ø±</a>
                    <a href="admin-categories.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-sitemap fa-fw mr-3"></i> Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</a>
                    <a href="admin-orders.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-clipboard-list fa-fw mr-3"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
                    <a href="admin-coupons.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-tags fa-fw mr-3"></i> Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª</a>
                    <a href="admin-inquiries.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-envelope-open-text fa-fw mr-3"></i> Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</a>
                    <a href="admin-applications.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fab fa-google-play fa-fw mr-3"></i> Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</a>
                    <a href="admin-layout.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-layer-group fa-fw mr-3"></i> ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ØªØ¬Ø±</a>
                    <a href="admin-notepad.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-book fa-fw mr-3"></i> Ø§Ù„Ù…ÙÙƒØ±Ø©</a>

                    <hr class="border-gray-700 my-2">
                    <h6 class="px-4 text-xs font-semibold text-gray-400 uppercase">Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆÙ„Ø§Ø¡ (Ø§Ù„Ù…ØªØ¬Ø±)</h6>
                    <a href="admin-loyalty-settings.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-gem fa-fw mr-3 text-yellow-400"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù‡Ø± ğŸ’</a>
                    <a href="admin-loyalty-approvals.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-check-to-slot fa-fw mr-3 text-green-400"></i> Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù…</a>
                    <a href="admin-referrals-pending.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-check-double fa-fw mr-3 text-blue-400"></i> Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</a>
                    <hr class="border-gray-700 my-2">

                    <a href="admin-settings.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-cogs fa-fw mr-3"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±</a>

                    <hr class="border-gray-700 my-2">
                    <h6 class="px-4 text-xs font-semibold text-gray-400 uppercase">Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©</h6>
                    <a href="dawarat_admin_manager.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"
                        target="_blank">
                        <i class="fas fa-graduation-cap fa-fw mr-3 text-gray-400"></i>
                        <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø°Ù„ÙˆØ±Ø§Øª</span>
                        <i class="fas fa-external-link-alt fa-xs ml-auto"></i>
                    </a>

                </nav>
                <div class="p-4 border-t border-gray-700">
                    <button id="logout-btn"
                        class="w-full bg-red-600 py-2 rounded-md hover:bg-red-700 transition-colors"><i
                            class="fas fa-sign-out-alt mr-2"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                </div>
            </aside>

            <main class="flex-1 p-4 md:p-8 overflow-y-auto">
                <div id="analytics-panel" class="dashboard-panel">
                    <div class="text-center py-20">
                        <div class="loader mx-auto"></div>
                        <p class="mt-4 text-gray-600">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN_EMAILS = [
            's22market@gmail.com',
            'yacinee474474@gmail.com',
            'nourmt01@gmail.com'
        ];

        let productsCache = [];
        let ordersCache = [];
        let myChart = null;
        let profitChart = null;
        let topProductsChart = null;

        const dashboardPage = document.getElementById('dashboard-page');
        const logoutBtn = document.getElementById('logout-btn');
        const getEl = (id) => document.getElementById(id);

        // ============================================================
        // Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© (Guard)
        // ============================================================
        onAuthStateChanged(auth, (user) => {
            if (user && ADMIN_EMAILS.includes(user.email)) {
                dashboardPage.classList.remove('hidden');
                getEl('admin-welcome-name').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${user.displayName || user.email.split('@')[0]}`;
                initializeDashboard();
            } else {
                window.location.href = 'admin-login.html';
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = 'admin-login.html';
        });

        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('translate-x-full');
            });
        }

        function setActiveTab() {
            const currentPage = window.location.pathname.split('/').pop();
            const tabs = document.querySelectorAll('.dashboard-tab');
            tabs.forEach(tab => {
                const tabHref = tab.getAttribute('href').split('/').pop();
                if (tabHref === currentPage || (currentPage === '' && tabHref === 'dashboard.html') || (currentPage === 'dashboard.html' && tabHref === 'dashboard.html')) {
                    tab.classList.add('active-tab');
                } else {
                    tab.classList.remove('active-tab');
                }
            });
        }

        function initializeDashboard() {
            setActiveTab();

            loadAnalytics();

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª)
            onSnapshot(query(collection(db, "products")), (snapshot) => {
                productsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAnalytics();
            });

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            onSnapshot(query(collection(db, "orders")), (snapshot) => {
                ordersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAnalytics();
            });

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø¬Ø± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© (Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ±ÙŠ)
            onSnapshot(query(collection(db, "users"), where("storeRequest.status", "==", "pending")), (snapshot) => {
                const count = snapshot.size;
                const badge = document.getElementById('sellers-badge');
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            });
        }

        function loadAnalytics() {
            const panel = document.getElementById('analytics-panel');
            panel.innerHTML = `
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ù„Ù…ØªØ¬Ø±)</h1>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <i class="fas fa-hand-holding-usd text-4xl text-green-500 mr-4"></i>
                    <div><p class="text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</p><p id="total-profit" class="text-2xl font-bold">0 Ø¯.Ø¬</p></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <i class="fas fa-divide text-4xl text-yellow-500 mr-4"></i>
                    <div><p class="text-gray-500">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø±Ø¨Ø­ / Ø·Ù„Ø¨</p><p id="avg-profit" class="text-2xl font-bold">0 Ø¯.Ø¬</p></div>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <i class="fas fa-check-circle text-4xl text-blue-500 mr-4"></i>
                    <div><p class="text-gray-500">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</p><p id="completed-orders" class="text-2xl font-bold">0</p></div>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <i class="fas fa-spinner text-4xl text-orange-500 mr-4"></i>
                    <div><p class="text-gray-500">Ø§Ù„Ø·Ù„Ø¨Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</p><p id="incomplete-orders" class="text-2xl font-bold">0</p></div>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-md flex items-center col-span-1 sm:col-span-2 lg:col-span-4">
                    <i class="fas fa-boxes text-4xl text-purple-500 mr-4"></i>
                    <div><p class="text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø§Ù„Ù†Ø´Ø·Ø©)</p><p id="total-products" class="text-2xl font-bold">0</p></div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© (Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…)</h2>
                    <canvas id="ordersChart"></canvas>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4">Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…)</h2>
                    <canvas id="profitChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-bold mb-4">Ø£Ø¹Ù„Ù‰ 7 Ù…Ù†ØªØ¬Ø§Øª ØªØ­Ù‚ÙŠÙ‚Ù‹Ø§ Ù„Ù„Ø£Ø±Ø¨Ø§Ø­</h2>
                <canvas id="topProductsChart"></canvas>
            </div>
            `;
        }

        function updateAnalytics() {
            if (!getEl('total-products')) return;

            // 1. ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª + Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© (sold_out Ù„Ø§ ÙŠØ³ØªØ¨Ø¹Ø¯ Ù…Ù† Ø§Ù„Ø¥Ø­ØµØ§Ø¡ Ù„Ø£Ù†Ù‡ Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯)
            const marketProducts = productsCache.filter(p => p.productType !== 'course');

            const completedOrders = ordersCache.filter(o => o.status === 'completed');
            const incompleteOrders = ordersCache.filter(o => o.status === 'new' || o.status === 'pending'); // Ø´Ù…Ù„Ù†Ø§ pending
            const totalProfit = completedOrders.reduce((sum, order) => sum + (order.profit || 0), 0);
            const completedOrdersCount = completedOrders.length;
            const incompleteOrdersCount = incompleteOrders.length;
            const avgProfit = completedOrdersCount > 0 ? totalProfit / completedOrdersCount : 0;

            getEl('total-products').textContent = marketProducts.length;
            getEl('total-profit').textContent = `${totalProfit.toLocaleString()} Ø¯.Ø¬`;
            getEl('avg-profit').textContent = `${avgProfit.toFixed(0).toLocaleString()} Ø¯.Ø¬`;
            getEl('completed-orders').textContent = completedOrdersCount;
            getEl('incomplete-orders').textContent = incompleteOrdersCount;

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø®Ø·Ø·Ø§Øª (Charts)
            const last7Days = {};
            const last7DaysProfit = {};

            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const key = d.toISOString().split('T')[0];
                last7Days[key] = 0;
                last7DaysProfit[key] = 0;
            }

            completedOrders.forEach(order => {
                if (order.createdAt?.toDate) {
                    const orderDate = order.createdAt.toDate().toISOString().split('T')[0];
                    if (last7Days.hasOwnProperty(orderDate)) {
                        last7Days[orderDate]++;
                        last7DaysProfit[orderDate] += (order.profit || 0);
                    }
                }
            });

            const chartLabels = Object.keys(last7Days).map(date => new Date(date).toLocaleDateString('ar-EG', { weekday: 'short', day: 'numeric' }));

            const ordersChartData = Object.values(last7Days);
            const ordersCtx = getEl('ordersChart')?.getContext('2d');
            if (ordersCtx) {
                if (myChart) myChart.destroy();
                myChart = new Chart(ordersCtx, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
                            data: ordersChartData,
                            backgroundColor: 'rgba(79, 70, 229, 0.8)',
                            borderColor: 'rgba(79, 70, 229, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
                });
            }

            const profitChartData = Object.values(last7DaysProfit);
            const profitCtx = getEl('profitChart')?.getContext('2d');
            if (profitCtx) {
                if (profitChart) profitChart.destroy();
                profitChart = new Chart(profitCtx, {
                    type: 'line',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ (Ø¯.Ø¬)',
                            data: profitChartData,
                            backgroundColor: 'rgba(22, 163, 74, 0.2)',
                            borderColor: 'rgba(22, 163, 74, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                });
            }

            const productProfits = {};
            completedOrders.forEach(order => {
                (order.items || []).forEach(item => {
                    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù… Ù„Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ HTML Ù‚Ø¯ÙŠÙ…
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = item.name || 'Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    const productName = tempDiv.textContent || tempDiv.innerText || "";

                    // Ø­Ø³Ø§Ø¨ Ø±Ø¨Ø­ ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„ÙƒÙ„ Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨
                    const itemProfit = (order.profit || 0) / (order.items.length || 1);
                    if (productProfits[productName]) {
                        productProfits[productName] += itemProfit;
                    } else {
                        productProfits[productName] = itemProfit;
                    }
                });
            });
            const sortedProducts = Object.entries(productProfits).sort(([, a], [, b]) => b - a).slice(0, 7);
            const topProductsLabels = sortedProducts.map(p => p[0]);
            const topProductsData = sortedProducts.map(p => p[1]);
            const topProductsCtx = getEl('topProductsChart')?.getContext('2d');
            if (topProductsCtx) {
                if (topProductsChart) topProductsChart.destroy();
                topProductsChart = new Chart(topProductsCtx, {
                    type: 'bar',
                    data: {
                        labels: topProductsLabels,
                        datasets: [{
                            label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­',
                            data: topProductsData,
                            backgroundColor: 'rgba(153, 102, 255, 0.8)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­ (Ø¯.Ø¬)' } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function (context) { return `Ø§Ù„Ø±Ø¨Ø­: ${context.parsed.y.toLocaleString()} Ø¯.Ø¬`; } } } } }
                });
            }
        }
    </script>
</body>

</html>