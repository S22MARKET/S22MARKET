<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - Ø·Ù„Ø¨Ø§Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.6/purify.min.js"></script>

    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f0f2f5;
        }

        .hidden {
            display: none;
        }

        .dashboard-tab:hover {
            background-color: #4338ca;
        }

        .dashboard-tab.active-tab {
            background-color: #4f46e5;
            color: white;
            font-weight: bold;
        }

        .dashboard-panel {
            animation: fadeIn 0.5s;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 700px;
            z-index: 50;
            max-height: 90vh;
            overflow-y: auto;
        }

        .ql-toolbar {
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }

        .ql-container {
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            min-height: 80px;
        }

        .ql-editor {
            font-family: 'Tajawal', sans-serif;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* (Ø³ØªØ§ÙŠÙ„ Ø®Ø§Øµ Ø¨Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©) */
        @media (max-width: 768px) {
            .responsive-table thead {
                display: none;
            }

            .responsive-table tr {
                display: block;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 1rem;
                margin-bottom: 1rem;
                background-color: white;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            }

            .responsive-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 0;
                border-bottom: 1px solid #f3f4f6;
            }

            .responsive-table td:last-child {
                border-bottom: none;
            }

            .responsive-table td::before {
                content: attr(data-label);
                font-weight: 600;
                margin-left: 0.5rem;
                color: #4b5563;
            }
        }
    </style>
</head>

<body>

    <div id="login-page" class="hidden min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-xl space-y-6">
            <h2 class="text-3xl font-extrabold text-center text-gray-900">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <p class="text-center text-red-500">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ <a href="dashboard.html"
                    class="font-bold underline">ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>.</p>
        </div>
    </div>

    <div id="dashboard-page" class="hidden">
        <div class="relative min-h-screen md:flex">

            <aside id="sidebar"
                class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 right-0 transform translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30">
                <div class="p-3 text-center border-b border-gray-700">
                    <h2 class="text-2xl font-bold">S22 Market</h2>
                    <p id="admin-welcome-name" class="text-sm text-indigo-300"></p>
                </div>
                <nav class="flex-1 p-2 space-y-2">
                    <a href="dashboard.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-chart-line fa-fw mr-3"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
                    <a href="admin-sellers.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-users-cog fa-fw mr-3"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹ÙŠÙ†</a>
                    <a href="admin-reports.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-flag fa-fw mr-3 text-red-400"></i> Ø§Ù„Ø¥Ø¨Ù„Ø§ØºØ§Øª</a>
                    <a href="admin-products.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-boxes fa-fw mr-3"></i> Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
                    <a href="admin-offers.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-star fa-fw mr-3"></i> Ø§Ù„Ø¹Ø±ÙˆØ¶</a>
                    <a href="admin-product-requests.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-user-plus fa-fw mr-3"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²ÙˆØ§Ø±</a>
                    <a href="admin-categories.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-sitemap fa-fw mr-3"></i> Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</a>
                    <a href="admin-orders.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-clipboard-list fa-fw mr-3"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
                    <a href="admin-coupons.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-tags fa-fw mr-3"></i> Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª</a>
                    <a href="admin-inquiries.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-envelope-open-text fa-fw mr-3"></i> Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</a>
                    <a href="admin-applications.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fab fa-google-play fa-fw mr-3"></i> Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</a>
                    <a href="admin-notepad.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-book fa-fw mr-3"></i> Ø§Ù„Ù…ÙÙƒØ±Ø©</a>

                    <hr class="border-gray-700 my-2">
                    <h6 class="px-4 text-xs font-semibold text-gray-400 uppercase">Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆÙ„Ø§Ø¡ (Ø§Ù„Ù…ØªØ¬Ø±)</h6>
                    <a href="admin-loyalty-settings.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-gem fa-fw mr-3 text-yellow-400"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù‡Ø± ğŸ’</a>
                    <a href="admin-loyalty-approvals.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-check-to-slot fa-fw mr-3 text-green-400"></i> Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù…</a>
                    <a href="admin-referrals-pending.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-check-double fa-fw mr-3 text-blue-400"></i> Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</a>
                    <hr class="border-gray-700 my-2">

                    <a href="admin-settings.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-cogs fa-fw mr-3"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±</a>

                    <hr class="border-gray-700 my-2">
                    <h6 class="px-4 text-xs font-semibold text-gray-400 uppercase">Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©</h6>
                    <a href="dawarat_admin_manager.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"
                        target="_blank">
                        <i class="fas fa-graduation-cap fa-fw mr-3 text-gray-400"></i>
                        <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø°Ù„ÙˆØ±Ø§Øª</span>
                        <i class="fas fa-external-link-alt fa-xs ml-auto"></i>
                    </a>

                </nav>
                <div class="p-4 border-t border-gray-700">
                    <button id="logout-btn"
                        class="w-full bg-red-600 py-2 rounded-md hover:bg-red-700 transition-colors"><i
                            class="fas fa-sign-out-alt mr-2"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                </div>
            </aside>
            <main class="flex-1 p-4 md:p-8 overflow-y-auto">
                <div id="productRequests-panel" class="dashboard-panel">
                    <div class="text-center py-20">
                        <div class="loader mx-auto"></div>
                        <p class="mt-4 text-gray-600">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, deleteDoc, onSnapshot, query, serverTimestamp, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN_EMAILS = [
            's22market@gmail.com',
            'yacinee474474@gmail.com',
            'nourmt01@gmail.com'
        ];

        let categoriesCache = [];

        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const logoutBtn = document.getElementById('logout-btn');
        const getEl = (id) => document.getElementById(id);
        const getVal = (id) => getEl(id)?.value || '';
        const getNum = (id) => parseFloat(getVal(id));
        const getChecked = (id) => getEl(id)?.checked || false;


        function checkAdminPermissions(user) {
            if (user && ADMIN_EMAILS.includes(user.email)) {
                loginPage.classList.add('hidden');
                dashboardPage.classList.remove('hidden');
                getEl('admin-welcome-name').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${user.displayName || user.email.split('@')[0]}`;
                initializeDashboard();
            } else {
                dashboardPage.classList.add('hidden');
                loginPage.classList.remove('hidden');
                if (user) signOut(auth);
            }
        }
        onAuthStateChanged(auth, user => { checkAdminPermissions(user); });
        logoutBtn.addEventListener('click', async () => { await signOut(auth); });

        function setActiveTab() {
            const currentPage = window.location.pathname.split('/').pop();
            const tabs = document.querySelectorAll('.dashboard-tab');
            tabs.forEach(tab => {
                const tabHref = tab.getAttribute('href').split('/').pop();
                if (tabHref === currentPage) {
                    tab.classList.add('active-tab');
                } else {
                    tab.classList.remove('active-tab');
                }
            });
        }

        async function initializeDashboard() {
            setActiveTab();
            onSnapshot(query(collection(db, "categories"), orderBy("orderIndex")), (snapshot) => {
                categoriesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });
            loadProductRequests();
        }

        // --- (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²ÙˆØ§Ø±) ---

        function loadProductRequests() {
            const panel = getEl('productRequests-panel');
            // Skeleton Layout
            panel.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">Ø·Ù„Ø¨Ø§Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>
        <div id="requests-skeleton" class="space-y-6">
             ${Array(3).fill(0).map(() => `
                <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col md:flex-row gap-6">
                    <div class="skeleton w-full md:w-48 h-48 rounded-lg"></div>
                    <div class="flex-1 space-y-4">
                        <div class="skeleton h-8 w-3/4"></div>
                        <div class="skeleton h-4 w-1/2"></div>
                        <div class="skeleton h-20 w-full"></div>
                        <div class="flex gap-4">
                             <div class="skeleton h-10 w-24 rounded-lg"></div>
                             <div class="skeleton h-10 w-24 rounded-lg"></div>
                        </div>
                    </div>
                </div>
             `).join('')}
        </div>
        <div id="requests-list" class="space-y-6 hidden"></div>`;

            onSnapshot(query(collection(db, "productRequests"), orderBy("createdAt", "desc")), (snapshot) => {
                const list = getEl('requests-list');
                const skeleton = getEl('requests-skeleton');

                skeleton.classList.add('hidden');
                list.classList.remove('hidden');

                list.innerHTML = snapshot.empty ? '<p class="text-center text-gray-500 bg-white p-8 rounded-xl shadow">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠÙ‹Ø§.</p>' : '';
                snapshot.docs.forEach((doc, index) => {
                    const el = renderProductRequests(doc.id, doc.data());
                    el.classList.add('fade-in-up');
                    el.style.animationDelay = `${index * 0.1}s`;
                    list.appendChild(el);
                });
                attachRequestListeners();
            });
        }

        function renderProductRequests(id, req) {
            const el = document.createElement('div');
            el.className = 'bg-white rounded-xl shadow-lg overflow-hidden';

            const date = req.createdAt?.toDate().toLocaleString('ar-EG', { dateStyle: 'medium', timeStyle: 'short' }) || 'N/A';
            const statusColor = req.status === 'approved' ? 'bg-green-100 text-green-800' : (req.status === 'rejected' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800');

            const imagesHTML = (req.imageUrls || []).map(url => `<a href="${url}" target="_blank"><img src="${url}" class="w-24 h-24 object-cover rounded-md border hover:opacity-80"></a>`).join('');

            const submitterType = req.sellerId
                ? `<span class="bg-purple-100 text-purple-800 text-xs font-bold px-2 py-1 rounded-full">Ø¨Ø§Ø¦Ø¹ Ù…Ø³Ø¬Ù„</span>`
                : `<span class="bg-gray-100 text-gray-800 text-xs font-bold px-2 py-1 rounded-full">Ø²Ø§Ø¦Ø±</span>`;

            el.innerHTML = `
            <div class="p-5 border-b flex flex-col md:flex-row justify-between md:items-center gap-3 ${req.status === 'approved' ? 'bg-green-50' : (req.status === 'rejected' ? 'bg-red-50' : 'bg-white')}">
                <div>
                    <h3 class="text-2xl font-bold">${req.productName}</h3>
                    <p class="text-sm text-gray-500 font-mono">${date}</p>
                </div>
                <div><select class="request-status-select p-2 rounded-lg border-gray-300 ${statusColor}" data-id="${id}">
                    <option value="pending" ${req.status === 'pending' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                    <option value="approved" ${req.status === 'approved' ? 'selected' : ''}>ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</option>
                    <option value="rejected" ${req.status === 'rejected' ? 'selected' : ''}>Ù…Ø±ÙÙˆØ¶</option>
                </select></div>
            </div>
            <div class="p-5 grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <h4 class="font-bold text-lg border-b pb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h4>
                    <p><strong>Ø§Ù„ÙˆØµÙ:</strong> ${req.productDescription}</p>
                    <p><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${req.categoryName} ${req.suggestedCategory ? `(Ù…Ù‚ØªØ±Ø­: ${req.suggestedCategory})` : ''}</p>
                    <p><strong>Ø§Ù„ÙƒÙ…ÙŠØ©:</strong> ${req.quantity}</p>
                    <p><strong>Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¨ÙŠØ¹:</strong> ${req.sellingArea}</p>
                    <p><strong>Ø®ÙŠØ§Ø± Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> ${req.deliveryOption}</p>
                    <div class="flex flex-wrap gap-2">${imagesHTML}</div>
                </div>
                <div class="space-y-4 bg-gray-50 p-4 rounded-lg border">
                    <h4 class="font-bold text-lg border-b pb-2 flex justify-between items-center">
                        <span>ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨</span>
                        ${submitterType}
                    </h4>
                    <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${req.userName}</p>
                    <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> <a href="tel:${req.userPhone}" class="text-indigo-600 hover:underline" dir="ltr">${req.userPhone}</a></p>
                    <p><strong>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</strong> ${req.userEmail || '---'}</p>
                    <p><strong>Ø§Ù„ØªØ®ØµØµ:</strong> ${req.userSpecialty || '---'}</p>
                    <div class="flex flex-wrap gap-4 text-xl">
                        ${req.userFacebook ? `<a href="${req.userFacebook}" target="_blank" class="text-blue-600 hover:text-blue-800"><i class="fab fa-facebook-square"></i></a>` : ''}
                        ${req.userInstagram ? `<a href="https://instagram.com/${req.userInstagram.replace('@', '')}" target="_blank" class="text-pink-600 hover:text-pink-800"><i class="fab fa-instagram-square"></i></a>` : ''}
                        ${req.userTelegram ? `<a href="https://t.me/${req.userTelegram.replace('@', '')}" target="_blank" class="text-sky-500 hover:text-sky-700"><i class="fab fa-telegram"></i></a>` : ''}
                        ${req.userWhatsapp ? `<a href="https://wa.me/${req.userWhatsapp.replace(/\D/g, '')}" target="_blank" class="text-green-500 hover:text-green-700"><i class="fab fa-whatsapp-square"></i></a>` : ''}
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end gap-3">
                <button class="approve-request-btn bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700" data-id="${id}">
                    <i class="fas fa-check mr-2"></i> Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØªØ­ÙˆÙŠÙ„ Ù„Ù…Ù†ØªØ¬
                </button>
                <button class="delete-request-btn text-red-500 hover:text-red-700 px-4 py-2" data-id="${id}">
                    <i class="fas fa-trash mr-2"></i> Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨
                </button>
            </div>`;
            return el;
        }

        function attachRequestListeners() {
            document.querySelectorAll('.request-status-select').forEach(select => select.onchange = async (e) => await updateDoc(doc(db, "productRequests", e.target.dataset.id), { status: e.target.value }));

            document.querySelectorAll('.delete-request-btn').forEach(btn => {
                btn.onclick = () => {
                    showDeleteConfirmationModal(async () => {
                        try {
                            await deleteDoc(doc(db, "productRequests", btn.dataset.id));
                            closeModal();
                        } catch (error) {
                            showModal('Ø®Ø·Ø£', `ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨: ${error.message}`, closeModal, 'Ù…ÙˆØ§ÙÙ‚', false);
                        }
                    });
                }
            });

            document.querySelectorAll('.approve-request-btn').forEach(btn => {
                btn.onclick = async () => {
                    const requestId = btn.dataset.id;
                    const reqDoc = await getDoc(doc(db, "productRequests", requestId));
                    if (!reqDoc.exists()) return alert('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    const req = reqDoc.data();

                    const productNameHTML = `<h3>${req.productName}</h3>`;
                    const productDescriptionHTML = `<p>${req.productDescription}</p>`;

                    // (*** ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…ØªØ¬Ø± ÙÙ‚Ø· ***)
                    showProductModal('traditional', { // (Ø§Ø³ØªØ®Ø¯Ø§Ù… 'traditional' ÙƒÙ‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù‚Ø¯ÙŠÙ…Ø©ØŒ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡Ø§ Ø¥Ù„Ù‰ 'regular')
                        name: productNameHTML,
                        price: 0,
                        description: productDescriptionHTML,
                        imageUrls: req.imageUrls,
                        supplier: req.userName,
                        supplierContact: `Ø§Ù„Ù‡Ø§ØªÙ: ${req.userPhone}\nØ§Ù„Ø¥ÙŠÙ…ÙŠÙ„: ${req.userEmail}`,
                        sellerId: req.sellerId || null,
                        sellerName: req.sellerName || null
                    });

                    await updateDoc(doc(db, "productRequests", requestId), { status: 'approved' });
                }
            });
        }

        // --- (Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ø§Ù…Ø©) ---

        const generateUniqueId = () => 'sub_' + Math.random().toString(36).substring(2, 11);

        async function uploadImageToImgBB(file) {
            const apiKey = "ac296feb5a275923598bdbfd4f9aed8c";
            const formData = new FormData();
            formData.append('image', file);
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, { method: 'POST', body: formData });
                if (!response.ok) {
                    const errorText = await response.text();
                    return { success: false, error: `ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: (${response.status})` };
                }
                const result = await response.json();
                if (result.success) { return { success: true, url: result.data.url }; }
                else { return { success: false, error: `Ø®Ø·Ø£ Ù…Ù† Ø®Ø¯Ù…Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±: ${result.error.message}` }; }
            } catch (error) {
                return { success: false, error: `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.` };
            }
        }

        function resizeAndCompressImage(file, maxWidth = 800, quality = 0.85) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let { width, height } = img;
                        if (width > maxWidth) { const scale = maxWidth / width; width = maxWidth; height = height * scale; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob(blob => {
                            if (!blob) { reject(new Error("Canvas to Blob conversion failed")); return; }
                            resolve(new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() }));
                        }, 'image/jpeg', quality);
                    }; img.onerror = reject;
                }; reader.onerror = error => reject(error);
            });
        }

        function populateSubcategories(categoryId, selectedSubCategoryId = null) {
            const subCategoryContainer = getEl('product-subcategory-container');
            const subCategorySelect = getEl('product-subcategory');
            if (!subCategoryContainer || !subCategorySelect) return;
            const selectedCategory = categoriesCache.find(c => c.id === categoryId);
            const allSubcategories = selectedCategory?.subcategories || [];
            const validSubcategories = allSubcategories.filter(s => s.active && s.id);
            if (validSubcategories.length > 0) {
                subCategorySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙØ±Ø¹...</option>';
                validSubcategories.forEach(sub => {
                    const isSelected = selectedSubCategoryId && sub.id === selectedSubCategoryId;
                    subCategorySelect.innerHTML += `<option value="${sub.name}" data-id="${sub.id}" ${isSelected ? 'selected' : ''}>${sub.name}</option>`;
                });
                subCategoryContainer.classList.remove('hidden');
            } else {
                subCategoryContainer.classList.add('hidden');
                subCategorySelect.innerHTML = '';
            }
        }

        // (*** ØªØ¹Ø¯ÙŠÙ„: Ù‡Ø°Ù‡ Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…ØªØ¬Ø± ÙÙ‚Ø· ***)
        // (ØªÙ… Ù†Ø³Ø®Ù‡Ø§ Ù…Ù† admin-products.html Ø§Ù„Ù…Ø¹Ø¯Ù„)
        function showProductModal(productType, product = null) {
            const isDirectOrder = productType === 'direct';
            let title = 'Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬';

            const categoryOptions = categoriesCache.map(cat => `<option value="${cat.id}" ${product && product.categoryId === cat.id ? 'selected' : ''}>${cat.name}</option>`).join('');
            let existingImages = product ? (product.imageUrls || (product.imageUrl ? [product.imageUrl] : [])) : [];
            const existingImagesHTML = existingImages.map(url => `<div class="relative group"><img src="${url}" class="w-24 h-24 rounded object-cover border"></div>`).join('');
            const shippingOptions = product?.shippingOptions || [];
            let shippingOptionsHTML = shippingOptions.map(opt => `
            <div class="flex items-center gap-2 mb-2 shipping-option-item">
                <input type="text" class="w-full p-2 border rounded shipping-location" value="${opt.location || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹">
                <input type="number" class="w-32 p-2 border rounded shipping-cost" value="${opt.cost || ''}" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø¯.Ø¬)">
                <button type="button" class="text-red-500 remove-shipping-btn"><i class="fas fa-times-circle"></i></button>
            </div>
        `).join('');

            let orderSpecificHTML = `
            <div id="direct-contact-container" class="hidden border-t pt-4 mt-4">
                <h3 class="font-bold text-lg text-green-700 mb-2">Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
                <div class="mt-2 space-y-3 bg-green-50 p-4 rounded-lg border border-green-200">
                    <div><label class="font-semibold text-sm"><i class="fab fa-whatsapp text-green-500"></i> ÙˆØ§ØªØ³Ø§Ø¨</label><input type="text" id="contact-link-whatsapp" class="mt-1 w-full p-2 border rounded" dir="ltr" value="${product?.directContactLinks?.whatsapp || ''}"></div>
                    <div><label class="font-semibold text-sm"><i class="fab fa-facebook text-blue-600"></i> ÙÙŠØ³Ø¨ÙˆÙƒ</label><input type="url" id="contact-link-facebook" class="mt-1 w-full p-2 border rounded" value="${product?.directContactLinks?.facebook || ''}"></div>
                    <div><label class="font-semibold text-sm"><i class="fab fa-instagram text-pink-500"></i> Ø§Ù†Ø³ØªØºØ±Ø§Ù…</label><input type="url" id="contact-link-instagram" class="mt-1 w-full p-2 border rounded" value="${product?.directContactLinks?.instagram || ''}"></div>
                    <div><label class="font-semibold text-sm"><i class="fab fa-telegram text-sky-500"></i> ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</label><input type="url" id="contact-link-telegram" class="mt-1 w-full p-2 border rounded" value="${product?.directContactLinks?.telegram || ''}"></div>
                    <div><label class="font-semibold text-sm"><i class="fas fa-phone-alt text-teal-500"></i> Ù‡Ø§ØªÙ</label><input type="tel" id="contact-link-phone" class="mt-1 w-full p-2 border rounded" dir="ltr" value="${product?.directContactLinks?.phone || ''}"></div>
                </div>
            </div>`;

            const commonFields = `<div class="space-y-4">
            <div>
                <label class="font-semibold">Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬ <span class="text-red-500">*</span></label>
                <select id="product-type" class="w-full p-2 border rounded mt-1 bg-white">
                    <option value="regular" ${productType === 'regular' ? 'selected' : ''}>Ù…Ù†ØªØ¬ Ø¹Ø§Ø¯ÙŠ (ÙŠØ¶Ø§Ù Ù„Ù„Ø³Ù„Ø©)</option>
                    <option value="direct" ${productType === 'direct' ? 'selected' : ''}>Ù…Ù†ØªØ¬ ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø± (ÙˆØ§ØªØ³Ø§Ø¨ØŒ Ø¥Ù„Ø®)</option>
                </select>
            </div>
            ${orderSpecificHTML}
            <hr>
            <div><label class="font-semibold">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><div id="product-name-editor" class="mt-1 bg-white"></div></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="font-semibold">Ø§Ù„Ø³Ø¹Ø± (Ø¯.Ø¬)</label><input type="number" id="product-price" class="mt-1 w-full p-2 border rounded" value="${product?.price || ''}" required></div>
                <div><label class="font-semibold">SKU / Ø±Ù…Ø² Ø§Ù„Ù…Ù†ØªØ¬</label><input type="text" id="product-sku" class="mt-1 w-full p-2 border rounded" value="${product?.sku || ''}" placeholder="Ø±Ù…Ø² ÙØ±ÙŠØ¯ Ù„Ù„Ù…Ù†ØªØ¬"></div>
            </div>
            <div><label class="font-semibold">Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙØ±</label><select id="product-availability" class="w-full p-2 border rounded mt-1 bg-white"><option value="available" selected>Ù…ØªÙˆÙØ±</option><option value="soon">Ù‚Ø±ÙŠØ¨Ù‹Ø§</option><option value="sold_out">Ù†ÙØ° Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</option></select></div>
            <div><label class="font-semibold">Ø§Ù„ÙˆØµÙ</label><div id="product-description-editor" class="mt-1 bg-white" style="min-height: 150px;"></div></div>
            <div><label class="font-semibold">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input type="text" id="product-location" class="mt-1 w-full p-2 border rounded" value="${product?.location || ''}" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± Ø§Ù„Ø¹Ø§ØµÙ…Ø©"></div>
            <div class="border-t pt-4 mt-4"><label class="font-semibold">Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø®Ø§ØµØ©</label><div id="shipping-options-container" class="space-y-2 bg-gray-50 p-3 rounded-md">${shippingOptionsHTML}</div><button type="button" id="add-shipping-option-btn" class="text-sm mt-2 text-indigo-600 font-semibold hover:underline"><i class="fas fa-plus-circle mr-1"></i>Ø¥Ø¶Ø§ÙØ© Ø³Ø¹Ø± ØªÙˆØµÙŠÙ„</button></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4 mt-4">
                <div><label class="font-semibold text-gray-700">Ø§Ù„Ù…ÙˆØ±Ø¯ (Ø¯Ø§Ø®Ù„ÙŠ)</label><input type="text" id="product-supplier" class="mt-1 w-full p-2 border rounded" value="${product?.supplier || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ Ø£Ùˆ Ø§Ù„Ø´Ø±ÙƒØ©"></div>
                <div><label class="font-semibold text-gray-700">ØªÙˆØ§ØµÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ (Ø¯Ø§Ø®Ù„ÙŠ)</label><textarea id="product-supplier-contact" class="mt-1 w-full p-2 border rounded" rows="3" placeholder="Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆØ§ØªÙØŒ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„...">${product?.supplierContact || ''}</textarea></div>
            </div>
            <div><label class="font-semibold text-green-700">Ø§Ù„Ø±Ø¨Ø­ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ (Ø¯Ø§Ø®Ù„ÙŠ)</label><div class="flex items-center mt-1"><input type="number" id="product-profit-value" class="w-full p-2 border rounded-r-md" value="${product?.profitValue || ''}" placeholder="0"><select id="product-profit-type" class="p-2 border-l-0 border rounded-l-md bg-gray-100"><option value="fixed" ${product?.profitType === 'fixed' ? 'selected' : ''}>Ø¯.Ø¬</option><option value="percentage" ${product?.profitType === 'percentage' ? 'selected' : ''}>%</option></select></div></div>
            <div><label class="font-semibold text-purple-700">Ø§Ù„Ø¬ÙˆØ§Ù‡Ø± Ø§Ù„Ù…Ø®ØµØµØ© (Override)</label><input type="number" id="product-loyalty-override" class="mt-1 w-full p-2 border rounded" value="${product?.loyaltyPointsOverride || ''}" placeholder="Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ø§Ù…Ø©"><p class="text-xs text-gray-500 mt-1">Ø¥Ø°Ø§ ÙˆØ¶Ø¹Øª 0ØŒ Ù„Ù† ÙŠØ±Ø¨Ø­ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙŠ Ø¬ÙˆØ§Ù‡Ø±.</p></div>
            <div class="border-t pt-4 mt-4 space-y-4"><h3 class="text-lg font-bold text-gray-500">Ø§Ù„ØªØµÙ†ÙŠÙ ÙˆØ§Ù„ØµÙˆØ±</h3><div><label class="font-semibold">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label><select id="product-category-select" class="mt-1 w-full p-2 border rounded bg-white" required><option value="">Ø§Ø®ØªØ± Ù‚Ø³Ù…...</option>${categoryOptions}</select></div><div id="product-subcategory-container" class="hidden"><label class="font-semibold">Ø§Ù„ÙØ±Ø¹</label><select id="product-subcategory" class="mt-1 w-full p-2 border rounded bg-white"></select></div><div><label class="font-semibold">ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬</label><p class="text-sm text-gray-500">Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø·Ù„Ø¨:</p><div class="flex flex-wrap gap-2 mt-2">${existingImagesHTML}</div></div>
        </div>`;

            let nameQuill, descriptionQuill;
            showModal(title, commonFields, async () => {
                let nameHTML = nameQuill.root.innerHTML.trim();
                let descriptionHTML = descriptionQuill.root.innerHTML.trim();
                if (nameHTML === '<p><br></p>') nameHTML = '';
                if (descriptionHTML === '<p><br></p>') descriptionHTML = '';

                const cleanName = DOMPurify.sanitize(nameHTML);
                const cleanDescription = DOMPurify.sanitize(descriptionHTML);
                const price = getNum('product-price');
                const categoryId = getVal('product-category-select');
                if (!cleanName || !categoryId) { return alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©: Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ.'); }

                const newProductType = getVal('product-type');
                const directContactLinks = {
                    whatsapp: getVal('contact-link-whatsapp').trim(),
                    facebook: getVal('contact-link-facebook').trim(),
                    instagram: getVal('contact-link-instagram').trim(),
                    telegram: getVal('contact-link-telegram').trim(),
                    phone: getVal('contact-link-phone').trim()
                };
                if (newProductType === 'regular' && isNaN(price)) {
                    return alert('Ù„Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¹Ø§Ø¯ÙŠ: ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³Ø¹Ø±.');
                }
                if (newProductType === 'direct' && Object.values(directContactLinks).every(link => !link)) {
                    return alert('Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±ØŒ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ³ÙŠÙ„Ø© ØªÙˆØ§ØµÙ„ ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
                }

                const subcatSelect = getEl('product-subcategory');
                const selectedSubcatOption = subcatSelect && subcatSelect.selectedIndex > -1 ? subcatSelect.options[subcatSelect.selectedIndex] : null;
                const subcatIdToSave = selectedSubcatOption ? selectedSubcatOption.dataset.id : null;

                try {
                    const shippingOptionsData = [];
                    document.querySelectorAll('.shipping-option-item').forEach(item => {
                        const loc = item.querySelector('.shipping-location')?.value.trim();
                        const costVal = item.querySelector('.shipping-cost')?.value;
                        if (loc && costVal) { const cost = parseFloat(costVal); if (!isNaN(cost)) shippingOptionsData.push({ location: loc, cost }); }
                    });

                    showLoadingModal('Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

                    const productData = {
                        name: cleanName, price: price || 0, description: cleanDescription, categoryId, imageUrls: existingImages,
                        availability: getVal('product-availability'),
                        sku: getVal('product-sku').trim(),
                        location: getVal('product-location').trim(),
                        subCategoryName: selectedSubcatOption ? selectedSubcatOption.value : null,
                        subCategoryID: subcatIdToSave,
                        supplier: getVal('product-supplier').trim(),
                        supplierContact: getVal('product-supplier-contact').trim(),
                        profitValue: getNum('product-profit-value') || 0,
                        profitType: getVal('product-profit-type'),
                        shippingOptions: shippingOptionsData,
                        productType: newProductType,
                        directContactLinks: (newProductType === 'direct') ? directContactLinks : {},
                        loyaltyPointsOverride: getNum('product-loyalty-override') || null,
                        updatedAt: serverTimestamp(),
                        createdAt: serverTimestamp(),
                        sellerId: product.sellerId || null,
                        sellerName: product.sellerName || null
                    };

                    await addDoc(collection(db, "products"), productData);
                    closeModal();
                } catch (error) {
                    showModal('Ø®Ø·Ø£ ÙØ§Ø¯Ø­', `ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬: ${error.message}`, () => closeModal(), 'Ù…ÙˆØ§ÙÙ‚', false);
                }
            });

            const fullToolbarOptions = [['bold', 'italic', 'underline', 'strike'], [{ 'list': 'ordered' }, { 'list': 'bullet' }], [{ 'align': [] }], [{ 'color': [] }, { 'background': [] }], ['link'], ['clean']];
            nameQuill = new Quill('#product-name-editor', { theme: 'snow', modules: { toolbar: [['bold', 'italic', 'underline'], [{ 'color': [] }]] } });
            descriptionQuill = new Quill('#product-description-editor', { theme: 'snow', modules: { toolbar: fullToolbarOptions } });
            if (product) { if (product.name) nameQuill.root.innerHTML = product.name; if (product.description) descriptionQuill.root.innerHTML = product.description; }

            getEl('product-category-select').addEventListener('change', (e) => populateSubcategories(e.target.value));

            const addShippingOption = () => {
                const container = getEl('shipping-options-container');
                const newItem = document.createElement('div');
                newItem.className = 'flex items-center gap-2 mb-2 shipping-option-item';
                newItem.innerHTML = `
                    <input type="text" class="w-full p-2 border rounded shipping-location" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù…Ø«Ø§Ù„: ÙˆÙ‡Ø±Ø§Ù†)">
                    <input type="number" class="w-32 p-2 border rounded shipping-cost" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø¯.Ø¬)">
                    <button type="button" class="text-red-500 remove-shipping-btn"><i class="fas fa-times-circle"></i></button>
                `;
                newItem.querySelector('.remove-sub-btn').onclick = () => newItem.remove();
                container.appendChild(newItem);
            };

            getEl('add-shipping-option-btn').onclick = addShippingOption;
            document.querySelectorAll('.remove-shipping-btn').forEach(btn => btn.onclick = (e) => e.currentTarget.closest('.shipping-option-item').remove());

            if (product?.categoryId) {
                populateSubcategories(product.categoryId, product.subCategoryID);
            }

            const productTypeSelect = getEl('product-type');
            const contactContainer = getEl('direct-contact-container');
            const toggleFields = () => {
                const type = productTypeSelect.value;
                contactContainer.classList.toggle('hidden', type !== 'direct');
            };
            productTypeSelect.addEventListener('change', toggleFields);
            toggleFields();
        }

        function showModal(title, content, onConfirm, confirmText = 'Ø­ÙØ¸', showCancel = true) {
            const modalContainer = getEl('modal-container');
            const confirmBtnHTML = `<button id="modal-confirm" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-indigo-700">${confirmText}</button>`;
            const cancelBtnHTML = showCancel ? `<button id="modal-cancel" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg font-semibold hover:bg-gray-300">Ø¥Ù„ØºØ§Ø¡</button>` : '';
            modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop">
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h3 class="text-xl font-bold">${title}</h3>
                        <button id="modal-close-btn" class="text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
                    </div>
                    <div id="modal-body">${content}</div>
                    <div class="flex justify-end gap-4 mt-6 border-t pt-4">
                        ${cancelBtnHTML}
                        ${onConfirm ? confirmBtnHTML : ''}
                    </div>
                </div>
            </div>`;
            if (showCancel) getEl('modal-cancel').onclick = closeModal;
            getEl('modal-close-btn').onclick = closeModal;
            getEl('modal-backdrop').onclick = (e) => { if (e.target.id === 'modal-backdrop') closeModal(); };
            if (onConfirm) getEl('modal-confirm').onclick = onConfirm;
        }
        function showLoadingModal(text = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
            getEl('modal-container').innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop-loader">
                <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm w-full">
                    <div class="loader mx-auto"></div>
                    <p class="mt-4 text-lg font-semibold text-gray-700">${text}</p>
                </div>
            </div>`;
        }
        function showDeleteConfirmationModal(onConfirm) {
            showModal('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
                '<p class="text-lg">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø­Ø°ÙØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.</p>',
                onConfirm,
                'Ù†Ø¹Ù…ØŒ Ù‚Ù… Ø¨Ø§Ù„Ø­Ø°Ù');
            getEl('modal-confirm').classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            getEl('modal-confirm').classList.add('bg-red-600', 'hover:bg-red-700');
        }
        function closeModal() {
            getEl('modal-container').innerHTML = '';
        }
    </script>
</body>

</html>