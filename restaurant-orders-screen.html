<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 KITCHEN - شاشة المطبخ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* KDS Theme: Dark/Orange (High Contrast) */
            --dark-bg: #1a1a1a;
            --card-bg: #262626;
            --primary-bg: #171717;
            --accent-color: #f97316;
            /* Orange 500 */
            --text-primary: #ffffff;
            --text-secondary: #d4d4d4;
            --ticket-new-bg: #ef4444;
            /* Red for new */
            --ticket-cooking-bg: #f59e0b;
            /* Amber for cooking */
            --ticket-ready-bg: #22c55e;
            /* Green for ready */
        }

        body.light-mode {
            --dark-bg: #f5f5f5;
            --card-bg: #ffffff;
            --primary-bg: #e5e5e5;
            --text-primary: #171717;
            --text-secondary: #525252;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        /* Ticket Card Styles */
        .ticket-card {
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            border: 2px solid transparent;
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
            page-break-inside: avoid;
        }

        .ticket-card.new {
            border-color: var(--ticket-new-bg);
            animation: pulse-border 2s infinite;
        }

        .ticket-card.preparing {
            border-color: var(--ticket-cooking-bg);
        }

        .ticket-header {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ticket-header.new {
            background-color: rgba(239, 68, 68, 0.2);
        }

        .ticket-header.preparing {
            background-color: rgba(245, 158, 11, 0.2);
        }

        .ticket-body {
            padding: 1rem;
            flex-grow: 1;
            font-size: 1.1rem;
            /* Larger font for kitchen */
        }

        .ticket-footer {
            padding: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(0, 0, 0, 0.2);
        }

        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* Sidebar transitions */
        aside#sidebar {
            transition: transform 0.3s ease-in-out;
        }

        /* Modal & Animations */
        .modal-content {
            animation: scaleIn 0.2s ease-out;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 3px;
        }

        /* Grid Layout */
        .kds-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            padding-bottom: 2rem;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">

    <!-- Sound Activation Modal -->
    <div id="sound-activation-modal"
        class="hidden fixed inset-0 bg-black/95 flex items-center justify-center z-[10000] backdrop-blur-sm">
        <div
            class="modal-content bg-neutral-900 rounded-2xl border border-orange-500/30 p-8 max-w-lg w-full text-center">
            <i class="fas fa-fire-burner text-6xl text-orange-500 mb-6 animate-pulse"></i>
            <h2 class="text-3xl font-bold text-white mb-2">تفعيل شاشة المطبخ</h2>
            <p class="text-gray-400 mb-8">يرجى الضغط للتفعيل وبدء استقبال الطلبات</p>
            <button id="activate-sound-btn"
                class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-4 rounded-xl text-xl transition-all">
                <i class="fas fa-power-off mr-2"></i> تشغيل النظام
            </button>
        </div>
    </div>

    <!-- New Order Alert Modal (Fullscreen Splash) -->
    <div id="new-order-modal"
        class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-red-600/90 backdrop-blur-md cursor-pointer"
        onclick="hideNewOrderAlert()">
        <div class="text-center animate-bounce">
            <i class="fas fa-bell text-9xl text-white mb-4 block"></i>
            <h1 class="text-6xl font-black text-white border-4 border-white inline-block px-12 py-4 rounded-full">طلب
                جديد</h1>
            <p id="alert-order-info" class="text-2xl text-white mt-4 font-mono font-bold">...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-neutral-900 border-b border-neutral-800 p-3 flex justify-between items-center shadow-lg z-20">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-black tracking-tight flex items-center gap-2">
                <span class="bg-orange-600 text-white px-2 py-1 rounded text-lg">KDS</span>
                <span>S22 KITCHEN</span>
            </h1>
            <div class="h-8 w-px bg-neutral-700 mx-2"></div>
            <div class="flex items-center gap-2 bg-neutral-800 px-3 py-1 rounded-full border border-neutral-700">
                <span id="connection-status" class="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse"></span>
                <span id="connection-text" class="text-xs font-mono text-gray-400">ONLINE</span>
            </div>
            <div class="h-8 w-px bg-neutral-700 mx-2"></div>
            <div id="stats-summary" class="flex gap-4 text-sm font-mono text-gray-400">
                <span>انتظار: <b id="count-new" class="text-red-500">0</b></span>
                <span>طبخ: <b id="count-cooking" class="text-amber-500">0</b></span>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="toggleTheme()"
                class="w-10 h-10 rounded-full bg-neutral-800 hover:bg-neutral-700 flex items-center justify-center text-gray-400 transition-colors">
                <i id="theme-icon" class="fas fa-sun"></i>
            </button>
            <button id="mute-btn"
                class="w-10 h-10 rounded-full bg-neutral-800 hover:bg-neutral-700 flex items-center justify-center text-gray-400 transition-colors">
                <i id="mute-icon" class="fas fa-volume-up"></i>
            </button>
            <button id="menu-toggle-btn"
                class="w-12 h-12 rounded-lg bg-orange-600 hover:bg-orange-500 text-white flex items-center justify-center text-xl shadow-lg transition-transform hover:scale-105">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- Sidebar -->
    <aside id="sidebar"
        class="fixed top-0 right-0 h-screen w-80 bg-neutral-900 shadow-2xl z-50 transform translate-x-full border-l border-neutral-800 flex flex-col">
        <div class="p-6 border-b border-neutral-800 flex justify-between items-center bg-neutral-950">
            <h2 class="text-xl font-bold text-white">القائمة الرئيسية</h2>
            <button id="menu-close-btn" class="text-gray-400 hover:text-white text-2xl"><i
                    class="fas fa-times"></i></button>
        </div>
        <nav id="sidebar-nav-container" class="flex-1 p-4 space-y-2 overflow-y-auto custom-scrollbar">
            <!-- SidebarManager injects here -->
        </nav>
        <div class="p-4 border-t border-neutral-800 bg-neutral-950">
            <button onclick="location.reload()"
                class="w-full py-3 bg-neutral-800 hover:bg-neutral-700 rounded-lg text-gray-300 font-bold transition-colors">
                <i class="fas fa-sync-alt mr-2"></i> تحديث النظام
            </button>
        </div>
    </aside>
    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black/80 z-40 backdrop-blur-sm" onclick="closeMenu()">
    </div>

    <!-- Main Board Area -->
    <main class="flex-1 overflow-hidden flex flex-col bg-[#121212]">
        <!-- Filter Tabs -->
        <div class="p-4 flex gap-2 justify-center border-b border-neutral-800 bg-neutral-900 shadow-md">
            <button
                class="px-6 py-2 rounded-full font-bold text-sm bg-orange-600 text-white shadow-lg transition-transform hover:scale-105 filter-tab active"
                data-filter="active">
                نشط (KDS)
            </button>
            <button
                class="px-6 py-2 rounded-full font-bold text-sm bg-neutral-800 text-gray-400 hover:bg-neutral-700 transition-colors filter-tab"
                data-filter="completed">
                سجل المكتملة
            </button>
        </div>

        <!-- Scrollable Board -->
        <div id="board-container" class="flex-1 overflow-y-auto p-4 custom-scrollbar">
            <div id="orders-grid" class="kds-grid">
                <!-- Tickets go here -->
            </div>
        </div>
    </main>

    <audio id="notification-sound" src="alerta.mp3" preload="auto" loop></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, updateDoc, doc, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { SidebarManager } from './sidebar-manager.js';

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // State
        let ordersCache = [];
        let viewFilter = 'active'; // 'active' (new/preparing) or 'completed'
        let currentUser = null;
        let newlyAddedIds = new Set();
        let isInitialLoad = true;

        // Audio Manager
        const audioManager = {
            element: document.getElementById('notification-sound'),
            isMuted: false,
            isUnlocked: false,
            unlock() {
                if (this.isUnlocked) return;
                this.element.play().then(() => {
                    this.element.pause();
                    this.isUnlocked = true;
                    console.log("Audio Unlocked");
                }).catch(e => console.warn(e));
            },
            play() {
                if (this.isMuted || !this.isUnlocked) return;
                this.element.currentTime = 0;
                this.element.play().catch(e => console.error(e));
            },
            stop() {
                this.element.pause();
                this.element.currentTime = 0;
            },
            toggleMute() {
                this.isMuted = !this.isMuted;
                const icon = document.getElementById('mute-icon');
                icon.className = this.isMuted ? 'fas fa-volume-mute text-red-500' : 'fas fa-volume-up';
            }
        };

        // UI Handlers
        window.openMenu = () => {
            document.getElementById('sidebar-overlay').classList.remove('hidden');
            document.getElementById('sidebar').classList.remove('translate-x-full');
        };
        window.closeMenu = () => {
            document.getElementById('sidebar').classList.add('translate-x-full');
            setTimeout(() => document.getElementById('sidebar-overlay').classList.add('hidden'), 300);
        };
        document.getElementById('menu-toggle-btn').onclick = window.openMenu;
        document.getElementById('menu-close-btn').onclick = window.closeMenu;
        document.getElementById('mute-btn').onclick = () => audioManager.toggleMute();

        // Theme
        window.toggleTheme = () => {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            localStorage.setItem('kdsTheme', isLight ? 'light' : 'dark');
            document.getElementById('theme-icon').className = isLight ? 'fas fa-moon' : 'fas fa-sun';
        };
        if (localStorage.getItem('kdsTheme') === 'light') window.toggleTheme();

        // New Order Alert
        window.hideNewOrderAlert = () => {
            document.getElementById('new-order-modal').classList.add('hidden');
            audioManager.stop();
        };

        function showAlert(order) {
            const el = document.getElementById('new-order-modal');
            const info = document.getElementById('alert-order-info');
            info.textContent = `#${order.id.slice(-4)} | ${order.customerName}`;
            el.classList.remove('hidden');
            audioManager.play();
        }

        // --- Core KDS Logic ---

        function updateStats() {
            const newCount = ordersCache.filter(o => o.status === 'new' || o.status === 'pending').length;
            const cookCount = ordersCache.filter(o => o.status === 'preparing').length;
            document.getElementById('count-new').textContent = newCount;
            document.getElementById('count-cooking').textContent = cookCount;
        }

        function renderBoard() {
            const grid = document.getElementById('orders-grid');
            grid.innerHTML = '';

            let filtered = [];
            if (viewFilter === 'active') {
                filtered = ordersCache.filter(o => ['new', 'pending', 'preparing'].includes(o.status));
            } else {
                filtered = ordersCache.filter(o => ['completed', 'picked_up', 'canceled', 'ready'].includes(o.status));
            }

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full h-96 flex flex-col items-center justify-center text-gray-600">
                    <i class="fas fa-clipboard-check text-8xl mb-4 opacity-20"></i>
                    <p class="text-2xl font-bold opacity-50">لا توجد طلبات في هذه القائمة</p>
                </div>`;
                return;
            }

            filtered.forEach(order => {
                const isPreparing = order.status === 'preparing';
                const isNew = order.status === 'new' || order.status === 'pending';

                // Time Calc
                const created = order.createdAt?.toDate ? order.createdAt.toDate() : new Date();
                const diffMs = new Date() - created;
                const diffMins = Math.floor(diffMs / 60000);

                let timeColor = 'text-gray-400';
                if (diffMins > 10) timeColor = 'text-yellow-500';
                if (diffMins > 20) timeColor = 'text-red-500 animate-pulse';

                // Status Badge
                let statusBadge = '';
                let cardBorderClass = 'border-gray-700';
                let headerClass = 'bg-neutral-800';

                if (isNew) {
                    statusBadge = '<span class="bg-red-600 text-white px-2 py-0.5 rounded text-sm font-bold">جديد</span>';
                    cardBorderClass = 'ticket-card new';
                    headerClass = 'ticket-header new';
                } else if (isPreparing) {
                    statusBadge = '<span class="bg-amber-500 text-black px-2 py-0.5 rounded text-sm font-bold">طبخ</span>';
                    cardBorderClass = 'ticket-card preparing';
                    headerClass = 'ticket-header preparing';
                }

                // Items HTML
                const itemsHtml = (order.items || []).map(item => {
                    const addons = item.selectedAddons?.map(a => `<div class="text-sm text-gray-400 mr-4">+ ${a.name}</div>`).join('') || '';
                    const instructions = item.cookingInstructions ? `<div class="text-sm text-red-400 mr-4 p-1 bg-red-900/20 rounded mt-1"><i class="fas fa-exclamation-circle"></i> ${item.cookingInstructions}</div>` : '';
                    return `
                        <div class="mb-3 pb-3 border-b border-gray-800 last:border-0 last:mb-0 last:pb-0">
                            <div class="flex justify-between items-start">
                                <span class="font-bold text-xl ${isNew ? 'text-white' : 'text-gray-200'}">${item.name}</span>
                                <span class="bg-neutral-700 text-white font-mono text-lg px-2 rounded ml-2">${item.quantity}</span>
                            </div>
                            ${addons}
                            ${instructions}
                        </div>
                    `;
                }).join('');

                // Action Buttons
                let actionBtns = '';
                if (isNew) {
                    actionBtns = `
                        <button onclick="window.updateStatus('${order.id}', 'preparing')" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg text-lg transition-colors shadow-lg">
                            <i class="fas fa-fire mb-1"></i> ابدأ الطبخ
                        </button>
                    `;
                } else if (isPreparing) {
                    actionBtns = `
                        <button onclick="window.updateStatus('${order.id}', 'ready')" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-lg transition-colors shadow-lg">
                            <i class="fas fa-bell mb-1"></i> جاهز للتقديم
                        </button>
                    `;
                } else {
                    actionBtns = `<div class="text-center text-gray-500 font-bold py-2">مكتمل</div>`;
                }

                const cardIdx = document.createElement('div');
                cardIdx.className = cardBorderClass;
                cardIdx.innerHTML = `
                    <div class="${headerClass}">
                        <div>
                             <span class="font-mono font-bold text-gray-500 text-sm">#${order.id.slice(-4)}</span>
                             <div class="font-bold text-lg truncate max-w-[150px]">${order.customerName || 'زائر'}</div>
                        </div>
                        <div class="text-left">
                             ${statusBadge}
                             <div class="font-mono text-xl font-bold mt-1 ${timeColor}" data-time="${created.getTime()}">${diffMins} د</div>
                        </div>
                    </div>
                    <div class="ticket-body custom-scrollbar overflow-y-auto max-h-[400px]">
                        ${itemsHtml}
                    </div>
                    <div class="ticket-footer">
                        ${actionBtns}
                        ${order.tableNumber ? `<div class="mt-2 text-center text-sm font-bold bg-neutral-800 rounded py-1">طاولة: ${order.tableNumber}</div>` : ''}
                    </div>
                `;
                grid.appendChild(cardIdx);
            });
        }

        // Actions
        window.updateStatus = async (id, status) => {
            try {
                // If moving to ready/completed, simpler update
                const finalStatus = status === 'ready' ? 'completed' : status; // using completed for now for simplicity, or could separate 'ready' if waiters exist
                await updateDoc(doc(db, "orders", id), {
                    status: finalStatus,
                    updatedAt: new Date()
                });
            } catch (e) {
                console.error(e);
                alert("خطأ في التحديث");
            }
        };

        // Live Timer Update
        setInterval(() => {
            document.querySelectorAll('[data-time]').forEach(el => {
                const t = parseInt(el.dataset.time);
                const diff = Math.floor((Date.now() - t) / 60000);
                el.innerText = diff + ' د';
                // Color update
                if (diff > 20) el.className = "font-mono text-xl font-bold mt-1 text-red-500 animate-pulse";
                else if (diff > 10) el.className = "font-mono text-xl font-bold mt-1 text-yellow-500";
            });
        }, 30000); // Every 30s

        // Tab Switching
        document.querySelectorAll('.filter-tab').forEach(btn => {
            btn.onclick = (e) => {
                document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active', 'bg-orange-600', 'text-white'));
                e.target.classList.add('active', 'bg-orange-600', 'text-white');
                e.target.classList.remove('bg-neutral-800', 'text-gray-400');

                // Reset others style
                document.querySelectorAll('.filter-tab:not(.active)').forEach(b => b.classList.add('bg-neutral-800', 'text-gray-400'));

                viewFilter = e.target.dataset.filter;
                renderBoard();
            };
        });

        // Initialize
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                SidebarManager.render('sidebar-nav-container', 'kitchen');
                setupListener(user.uid);

                // Setup Sound Modal if not activated
                if (localStorage.getItem('soundActivated') !== 'true') {
                    document.getElementById('sound-activation-modal').classList.remove('hidden');
                    document.getElementById('activate-sound-btn').onclick = () => {
                        audioManager.unlock();
                        localStorage.setItem('soundActivated', 'true');
                        document.getElementById('sound-activation-modal').classList.add('hidden');
                    };
                } else {
                    audioManager.isUnlocked = true;
                    // Try auto unlock on first click anywhere just in case
                    document.addEventListener('click', () => audioManager.unlock(), { once: true });
                }

            } else {
                window.location.href = 'login.html';
            }
        });

        function setupListener(uid) {
            // Usually filter by sellerId or merchantId
            const q = query(
                collection(db, "orders"),
                where("sellerId", "==", uid) // Assuming sellerId is used for restaurants
                // orderBy("createdAt", "desc") // requires index usually
            );

            onSnapshot(q, (snapshot) => {
                const orders = [];
                snapshot.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));

                // Sort locally to avoid index issues for now if possible
                orders.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                ordersCache = orders;
                updateStats();
                renderBoard();

                // New Order Alert Check
                if (!isInitialLoad) {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const data = change.doc.data();
                            // Only alert if status is new and recent (< 10 mins)
                            const isRecent = data.createdAt && (Date.now() - data.createdAt.toMillis() < 600000);
                            if (data.status === 'new' && isRecent && !newlyAddedIds.has(change.doc.id)) {
                                showAlert({ id: change.doc.id, ...data });
                                newlyAddedIds.add(change.doc.id);
                            }
                        }
                    });
                }
                isInitialLoad = false;
            });
        }

    </script>
</body>

</html>