<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S22 Market - ØªØ­Ù…ÙŠÙ„...</title>
    <meta name="description" content="">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <style>
        :root {
            --primary-color: #4f46e5; 
            --primary-hover: #4338ca;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-primary: #1e293b;
            --border-color: #e2e8f0;
        }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg-body); color: var(--text-primary); }
        html { scroll-behavior: smooth; }

        /* (Ø¬Ø¯ÙŠØ¯) Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Ù…Ù† index Ø§Ù„Ù‚Ø¯ÙŠÙ…) */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); z-index: 1100;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .overlay.active { opacity: 1; visibility: visible; }
        .side-bar {
            position: fixed; top: 0; right: -100%; width: 32rem; max-width: 90%;
            height: 100vh; background-color: var(--bg-card);
            border-left: 1px solid var(--border-color); z-index: 1200;
            transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .side-bar.active { right: 0; }
        
        /* Ø³ØªØ§ÙŠÙ„ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background-color: var(--bg-card); border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); display: flex;
            justify-content: space-around; padding: 0.5rem 0; z-index: 900;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; color: #64748b; text-decoration: none; flex-grow: 1; padding: 0.25rem 0; }
        .nav-item i { font-size: 1.25rem; margin-bottom: 0.25rem; }
        .nav-item.active { color: var(--primary-color); }

        /* Ø³ØªØ§ÙŠÙ„ ÙƒØ±Øª Ø§Ù„ÙƒØ§Ø±ÙˆØ³ÙŠÙ„ */
        .swiper-container { overflow: hidden; }
        .swiper-scrollbar { display: none; }
        .swiper-slide { width: auto; }
        
        .carousel-card {
            width: 160px; /* Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ±Øª */
            background-color: var(--bg-card); border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden;
            border: 1px solid var(--border-color); flex-shrink: 0;
            display: flex; flex-direction: column; /* (Ø¬Ø¯ÙŠØ¯) Ù„Ø¶Ù…Ø§Ù† Ø§Ø±ØªÙØ§Ø¹ Ù…ØªÙ†Ø§Ø³Ù‚ */
        }
        .carousel-card-image { aspect-ratio: 1 / 1; background-size: cover; background-position: center; }
        .carousel-card-content { padding: 0.5rem; flex-grow: 1; display: flex; flex-direction: column; }
        .carousel-card-title {
            font-size: 0.875rem; font-weight: 700; line-height: 1.4;
            height: 2.45em; /* Ø³Ø·Ø±ÙŠÙ† */
            overflow: hidden; margin-bottom: 0.25rem;
        }
        
        /* (Ø¬Ø¯ÙŠØ¯) Ø³ØªØ§ÙŠÙ„ ÙƒØ±Øª Ø§Ù„Ø¹Ø±Ø¶ (Ø£ÙƒØ¨Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹) */
        .offer-carousel-card {
            width: 280px; /* Ø¹Ø±Ø¶ ÙƒØ±Øª Ø§Ù„Ø¹Ø±Ø¶ */
            background-color: var(--bg-card); border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden;
            border: 1px solid var(--border-color); flex-shrink: 0;
        }
        .offer-carousel-image { aspect-ratio: 16 / 9; background-size: cover; background-position: center; }
        .offer-carousel-title { font-size: 1rem; font-weight: 700; margin: 0.75rem 0.75rem 0.5rem; }
        .offer-price { color: var(--primary-color); font-size: 1.25rem; font-weight: 800; margin: 0 0.75rem 0.75rem; }
        
        /* (Ø¬Ø¯ÙŠØ¯) Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª (Ù…Ù† offers.html) */
        .countdown-timer-container {
            background-color: rgba(239, 68, 68, 0.1);
            border-top: 1px solid rgba(239, 68, 68, 0.2);
            padding: 0.5rem 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .countdown-label { font-size: 0.75rem; font-weight: 700; color: #b91c1c; }
        .countdown-timer {
            direction: ltr; font-family: monospace, 'Tajawal', sans-serif;
            font-size: 1rem; font-weight: 700; color: #dc2626;
            display: flex; gap: 0.25rem;
        }
        .countdown-timer > div { display: flex; flex-direction: column; align-items: center; min-width: 1.5rem; }
        .countdown-timer span { font-size: 0.6rem; font-weight: 500; color: #b91c1c; }


        /* (Ø¬Ø¯ÙŠØ¯) Ø³ØªØ§ÙŠÙ„ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
        .category-icon-item { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; text-decoration: none; color: var(--text-primary); font-weight: 600; font-size: 0.875rem; }
        .category-icon-circle { width: 64px; height: 64px; border-radius: 50%; background-color: var(--bg-card); border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all 0.2s ease; }
        .category-icon-item:hover .category-icon-circle { transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* (Ø¬Ø¯ÙŠØ¯) Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… */
        .fab {
            position: fixed; bottom: 90px; /* ÙÙˆÙ‚ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ */
            left: 20px; width: 60px; height: 60px;
            background-color: var(--primary-color); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 800; transition: transform 0.2s;
        }
        .fab:hover { transform: scale(1.05); background-color: var(--primary-hover); }
        
        /* (Ø¬Ø¯ÙŠØ¯) Ø³ØªØ§ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
        #user-menu-dropdown.show { display: block; animation: slideInUp 0.2s ease-out; }
        
        /* (Ø¬Ø¯ÙŠØ¯) Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù„ÙˆØ¯Ø± ÙˆØ§Ù„ØªÙˆØ³Øª */
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        .small-loader { border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(20px); } }
        
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s; padding: 1rem; backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--bg-card); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); width: 100%; max-width: 700px; max-height: 95vh; display: flex; flex-direction: column; overflow: hidden; animation: scaleIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); position: relative; border-radius: 1rem; }
        
        #toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 1001; width: calc(100% - 2rem); max-width: 400px; }
        .toast { padding: 1rem 1.5rem; border-radius: 0.75rem; color: white; background-color: #10b981; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 0.75rem; animation: slideInUp 0.5s, fadeOut 0.5s 4.5s forwards; }
        .toast.error { background-color: #ef4444; }

    </style>
</head>
<body class="pb-24">

    <div class="overlay"></div>
    <aside class="side-bar flex flex-col">
        <div class="p-4 text-left flex-shrink-0">
            <button id="close-btn" class="text-3xl text-gray-500 hover:text-red-500 transition-colors">&times;</button>
        </div>
        <nav class="flex-grow overflow-y-auto">
            <div class="p-4 space-y-4">
                 <a href="add-product-request.html" id="sidebar-add-product-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg hover:bg-blue-700 transition-all transform hover:scale-105 flex items-center justify-center gap-2 shadow-lg">
                    <i class="fas fa-plus-circle"></i>
                    <span>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</span>
                </a>
          
                <a href="s22marketfood.html" 
                   id="sidebar-orders-btn" 
                   target="_blank"
                   rel="noopener noreferrer"
                   class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg text-lg hover:bg-orange-600 transition-all transform hover:scale-105 flex items-center justify-center gap-2 shadow-lg">
                   <i class="fas fa-utensils"></i>
                   <span>Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª</span>
                </a>
            </div>
            
            <div class="px-6 py-2">
                 <h3 class="text-lg font-bold text-gray-800 border-b pb-2">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h3>
            </div>
            <div id="sidebar-categories-container" class="py-2">
                <div class="text-center p-4"><div class="loader mx-auto"></div></div>
            </div>
        </nav>
        <div class="mt-auto p-4 border-t border-gray-200 space-y-3">
            <a href="#" id="sidebar-complaint-btn" class="w-full text-center text-gray-700 bg-gray-100 hover:bg-gray-200 flex items-center justify-center gap-2 border border-gray-200 font-semibold py-3 px-4 rounded-lg">
                <i class="fas fa-flag"></i> <span>Ø´ÙƒÙˆÙ‰/Ø±Ø£ÙŠ</span>
            </a>
            <a href="dashboard.html" id="admin-login-btn" class="w-full text-center text-gray-700 bg-gray-100 hover:bg-gray-200 flex items-center justify-center gap-2 border border-gray-200 font-semibold py-3 px-4 rounded-lg">
                <i class="fas fa-user-shield"></i> <span>Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</span>
            </a>
        </div>
    </aside>

    <div id="page-container">
        
        <header class="main-header">
            <div class="max-w-7xl mx-auto py-3 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                
                <button id="search-btn" class="text-2xl text-gray-600 hover:text-blue-600">
                    <i class="fas fa-search"></i>
                </button>
                
                <div id="logo-container" onclick="location.href=window.location.pathname" class="cursor-pointer">
                    <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800">
                        S22<span class="text-blue-600">MARKET</span>
                    </h1>
                </div>
                
                <div id="header-actions" class="flex items-center gap-3 relative">
                    <button id="menu-btn" class="text-2xl text-gray-600 hover:text-blue-600"><i class="fas fa-bars"></i></button>
                    
                    <a href="login.html" id="login-btn" class="hidden"></a>
                    <div id="user-menu" class="hidden">
                        <button id="user-menu-button"></button>
                        <div id="user-menu-dropdown" class="hidden absolute left-0 top-full mt-2 w-60 bg-white rounded-xl shadow-lg border z-50 overflow-hidden">
                            <div class="p-3 border-b">
                                <p class="text-sm text-gray-500">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ</p>
                                <p class="font-bold text-gray-800" id="user-menu-displayname">...</p>
                            </div>
                            <a href="profile.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i class="fas fa-user-circle fa-fw ml-2 text-gray-400"></i> Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ ÙˆÙ…Ø­Ø§ÙØ·ÙŠ</a>
                            <div class="px-4 pt-3 pb-1 text-xs font-semibold text-gray-400 uppercase">Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©</div>
                            <a href="dawarat_learning_dashboard.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i class="fas fa-graduation-cap fa-fw ml-2 text-indigo-400"></i> Ø¨Ø°Ù„ÙˆØ±Ø§ØªÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</a>
                            <div class="px-4 pt-3 pb-1 text-xs font-semibold text-gray-400 uppercase">Ø§Ù„Ù…ØªØ¬Ø±</div>
                            <a href="order_history.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i class="fas fa-archive fa-fw ml-2 text-gray-400"></i> Ø£Ø±Ø´ÙŠÙ Ø·Ù„Ø¨Ø§ØªÙŠ</a>
                            <a href="loyalty_card.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i class="fas fa-star fa-fw ml-2 text-orange-400"></i> Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆÙØ§Ø¡ (Ø§Ù„Ø¬ÙˆØ§Ù‡Ø±)</a>
                            <button id="logout-btn" class="w-full text-right px-4 py-3 text-red-600 hover:bg-red-50 border-t transition-colors"><i class="fas fa-sign-out-alt fa-fw ml-2"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto py-6 sm:py-8 md:py-10 px-4 sm:px-6 lg:px-8 space-y-12">

            <section id="offers-carousel-section" class="hidden">
                 <h2 class="text-2xl font-extrabold text-gray-800 mb-4 border-r-4 border-red-500 pr-4">Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø­ØµØ±ÙŠØ© <i class="fas fa-fire text-red-500"></i></h2>
                <div class="swiper swiper-container">
                    <div id="offers-carousel-wrapper" class="swiper-wrapper">
                        </div>
                </div>
            </section>
            
            <section id="category-icons-section">
                <div class="swiper swiper-container">
                    <div id="category-icons-wrapper" class="swiper-wrapper">
                        </div>
                </div>
            </section>

            <section id="courses-carousel-section" class="hidden">
                <h2 class="text-2xl font-extrabold text-gray-800 mb-4 border-r-4 border-indigo-500 pr-4">Ø£Ø­Ø¯Ø« Ø§Ù„Ø¨Ø°Ù„ÙˆØ±Ø§Øª ğŸ“</h2>
                <div class="swiper swiper-container">
                    <div id="courses-carousel-wrapper" class="swiper-wrapper">
                        </div>
                </div>
            </section>

            <section id="products-carousel-section" class="hidden">
                <h2 class="text-2xl font-extrabold text-gray-800 mb-4 border-r-4 border-blue-500 pr-4">Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªØ¬Ø± ğŸ›ï¸</h2>
                <div class="swiper swiper-container">
                    <div id="products-carousel-wrapper" class="swiper-wrapper">
                        </div>
                </div>
            </section>
            
            <div id="store-loader" class="text-center py-20">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-gray-600">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØµØ©...</p>
            </div>
            
        </main>
    </div>
    
    <a href="add-product-request.html" class="fab" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬">
        <i class="fas fa-plus"></i>
    </a>
    
    <footer class="bottom-nav">
        <a href="index.html" class="nav-item active">
            <i class="fas fa-home"></i>
            <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </a>
        <a href="dawarat_courses.html" class="nav-item">
            <i class="fas fa-graduation-cap"></i>
            <span>Ø§Ù„Ø¨Ø°Ù„ÙˆØ±Ø§Øª</span>
        </a>


<a href="cart.html" id="bottom-cart-btn" class="nav-item relative">
    <i class="fas fa-shopping-cart"></i>
    <span>Ø§Ù„Ø³Ù„Ø©</span>
    <span id="cart-badge-bottom" class="absolute ...">0</span>
</a>


        <a href="profile.html" id="bottom-profile-btn" class="nav-item">
            <i class="fas fa-user-circle"></i>
            <span>Ø­Ø³Ø§Ø¨ÙŠ</span>
        </a>
        <a href="login.html" id="bottom-login-btn" class="nav-item hidden">
            <i class="fas fa-sign-in-alt"></i>
            <span>Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
        </a>
    </footer>

    <div id="modal-container"></div>
    <div id="toast-container"></div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, addDoc, query, orderBy, serverTimestamp, where, limit, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // ... (Ù†ÙØ³ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase) ...
    const firebaseConfig = {
        apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
        authDomain: "s22market-4e3e6.firebaseapp.com",
        projectId: "s22market-4e3e6",
        storageBucket: "s22market-4e3e6.appspot.com",
        messagingSenderId: "119186699901",
        appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
        measurementId: "G-MWYNCVP4WQ"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let productsCache = [];
    let offersCache = [];
    let categoriesCache = [];
    let cart = [];
    let storeSettings = {}; 

    // (Ø¬Ø¯ÙŠØ¯) Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©
    const elements = {
        modalContainer: document.getElementById('modal-container'),
        toastContainer: document.getElementById('toast-container'),
        loader: document.getElementById('store-loader'),
        
        // Ø§Ù„Ù‡ÙŠØ¯Ø±
        menuBtn: document.getElementById('menu-btn'), // (Ø¬Ø¯ÙŠØ¯) Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        loginBtn: document.getElementById('login-btn'),
        userMenu: document.getElementById('user-menu'),
        userMenuButton: document.getElementById('user-menu-button'),
        userMenuDropdown: document.getElementById('user-menu-dropdown'),
        userMenuName: document.getElementById('user-menu-name'),
        userMenuDisplayName: document.getElementById('user-menu-displayname'),
        logoutBtn: document.getElementById('logout-btn'),
        
        // Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ
        bottomCartBtn: document.getElementById('bottom-cart-btn'),
        cartBadgeBottom: document.getElementById('cart-badge-bottom'),
        bottomProfileBtn: document.getElementById('bottom-profile-btn'),
        bottomLoginBtn: document.getElementById('bottom-login-btn'),
        
        // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Ø¬Ø¯ÙŠØ¯)
        sidebar: document.querySelector('.side-bar'),
        overlay: document.querySelector('.overlay'),
        closeSidebarBtn: document.getElementById('close-btn'),
        sidebarCategoriesContainer: document.getElementById('sidebar-categories-container'),
        sidebarComplaintBtn: document.getElementById('sidebar-complaint-btn'),
        sidebarAddProductBtn: document.getElementById('sidebar-add-product-btn'),
        sidebarOrdersBtn: document.getElementById('sidebar-orders-btn'),
        
        // Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        offersCarouselSection: document.getElementById('offers-carousel-section'), // (Ø¬Ø¯ÙŠØ¯)
        offersCarouselWrapper: document.getElementById('offers-carousel-wrapper'), // (Ø¬Ø¯ÙŠØ¯)
        categoryIconsWrapper: document.getElementById('category-icons-wrapper'),
        coursesCarouselSection: document.getElementById('courses-carousel-section'),
        coursesCarouselWrapper: document.getElementById('courses-carousel-wrapper'),
        productsCarouselSection: document.getElementById('products-carousel-section'),
        productsCarouselWrapper: document.getElementById('products-carousel-wrapper'),
    };
    
    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (Toast, Modals) ---
    function showToast(message, isSuccess = true) { /* ... (ÙƒÙ…Ø§ Ù‡ÙŠ) ... */ }
    function showLoadingModal(text = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...') { /* ... (ÙƒÙ…Ø§ Ù‡ÙŠ) ... */ }
    function closeModal() { elements.modalContainer.innerHTML = ''; }
    
    // (Ø¬Ø¯ÙŠØ¯) Ø¯ÙˆØ§Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Ù…Ù† index Ø§Ù„Ù‚Ø¯ÙŠÙ…)
    function showInquiryModal(type) { /* ... (ÙƒÙˆØ¯ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´ÙƒÙˆÙ‰) ... */ }
    async function handleInquirySubmit(e, type) { /* ... (ÙƒÙˆØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰) ... */ }
    function showRedirectModal({ title, icon, message, targetUrl }) { /* ... (ÙƒÙˆØ¯ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„) ... */ }
    const closeSidebar = () => {
        elements.sidebar.classList.remove('active');
        elements.overlay.classList.remove('active');
        document.body.style.overflow = 'auto';
    };

    // --- Ø¯ÙˆØ§Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø± ---
    function applyStoreSettings() {
        document.title = storeSettings.seoTitle || 'S22 Market';
        // ... (Ø¨Ù‚ÙŠØ© ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª) ...
    }
    async function loadStoreSettings() {
        try {
            const settingsDoc = await getDoc(doc(db, "settings", "storeConfig"));
            if(settingsDoc.exists()){
                storeSettings = settingsDoc.data();
                applyStoreSettings();
            }
        } catch(e) { console.error("Could not fetch store settings:", e); }
    }

    // --- (Ø¬Ø¯ÙŠØ¯) Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø¤Ù‚Øª (Ù…Ù† offers.html) ---
    function calculateTimeRemaining(endTime) {
        const total = Date.parse(endTime) - Date.parse(new Date());
        const seconds = Math.floor((total / 1000) % 60);
        const minutes = Math.floor((total / 1000 / 60) % 60);
        const hours = Math.floor((total / (1000 * 60 * 60)) % 24);
        const days = Math.floor(total / (1000 * 60 * 60 * 24));
        return { total, days, hours, minutes, seconds };
    }
    function updateCountdowns() {
        const countdownElements = document.querySelectorAll('.countdown-timer');
        countdownElements.forEach(el => {
            const endTime = el.dataset.endTime;
            if (!endTime) return;
            const t = calculateTimeRemaining(endTime);
            if (t.total <= 0) {
                el.parentElement.classList.add('hidden');
            } else {
                el.innerHTML = `
                    <div>${t.days} <span>ÙŠÙˆÙ…</span></div> :
                    <div>${t.hours} <span>Ø³</span></div> :
                    <div>${t.minutes} <span>Ø¯</span></div> :
                    <div>${t.seconds} <span>Ø«</span></div>
                `;
            }
        });
    }

    // --- (Ø¬Ø¯ÙŠØ¯) Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø±ÙÙ (Carousels) Ø§Ù„Ù…Ø·ÙˆØ±Ø© ---
    
    // (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø·ÙˆØ±Ø©
    async function fetchAndRenderOffers() {
        try {
            const snapshot = await getDocs(query(collection(db, "offers"), orderBy("createdAt", "desc"), limit(5)));
            offersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), isOffer: true }));
            
            if (offersCache.length > 0) {
                elements.offersCarouselWrapper.innerHTML = '';
                offersCache.forEach(offer => {
                    elements.offersCarouselWrapper.appendChild(createOfferCard(offer));
                });
                elements.offersCarouselSection.classList.remove('hidden');
                
                new Swiper('#offers-carousel-section .swiper-container', {
                    slidesPerView: 'auto',
                    spaceBetween: 16,
                    freeMode: true,
                });
                
                // (Ø¬Ø¯ÙŠØ¯) ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª
                if (document.querySelector('.countdown-timer')) {
                    updateCountdowns();
                    setInterval(updateCountdowns, 1000);
                }
            }
        } catch (error) { console.error("Error fetching offers:", error); }
    }

    // (Ø¬Ø¯ÙŠØ¯) ÙƒØ±Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø·ÙˆØ±
    function createOfferCard(offer) {
        const card = document.createElement('div');
        card.className = 'swiper-slide offer-carousel-card';
        
        const image = offer.imageUrl || 'https://placehold.co/400x200';
        
        let countdownHTML = '';
        if (offer.expiryDate && offer.expiryDate.toDate) {
            const expiryTime = offer.expiryDate.toDate();
            if (expiryTime > new Date()) {
                countdownHTML = `
                <div class="countdown-timer-container">
                    <span class="countdown-label"><i class="fas fa-fire-alt ml-1"></i> ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø¹Ø±Ø¶:</span>
                    <div class="countdown-timer" data-end-time="${expiryTime.toISOString()}"></div>
                </div>`;
            }
        }

        card.innerHTML = `
            <a href="PRESENTPRODUCT.html?offer=${offer.id}" class="block">
                <div class="offer-carousel-image" style="background-image: url('${image}')"></div>
                <h3 class="offer-carousel-title">${offer.title}</h3>
                <p class="offer-price">${(offer.price || 0).toLocaleString()} Ø¯.Ø¬</p>
                ${countdownHTML}
            </a>`;
        return card;
    }

    // (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª)
    async function fetchAndRenderCategories() {
        try {
            const snapshot = await getDocs(query(collection(db, "categories"), orderBy("orderIndex")));
            categoriesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            let categoriesIconsHTML = '';
            let categoriesSidebarHTML = `<div class="p-2 space-y-1">`;
            
            // Ø¥Ø¶Ø§ÙØ© "ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª" Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
            categoriesIconsHTML += `
                <a href="classproductindex.html" class="swiper-slide category-icon-item">
                    <div class="category-icon-circle"><i class="fas fa-store text-2xl text-gray-500"></i></div>
                    <span>ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
                </a>`;
            
            // (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¶Ø§ÙØ© "ØªØµÙØ­ Ø§Ù„Ø¨Ø°Ù„ÙˆØ±Ø§Øª" Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
            categoriesIconsHTML += `
                <a href="dawarat_courses.html" class="swiper-slide category-icon-item">
                    <div class="category-icon-circle"><i class="fas fa-graduation-cap text-2xl text-indigo-500"></i></div>
                    <span>Ø§Ù„Ø¨Ø°Ù„ÙˆØ±Ø§Øª</span>
                </a>`;

            categoriesCache.forEach(cat => {
                const activeSubcategories = cat.subcategories?.filter(s => s.active && s.id) || [];
                
                // 1. Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª (Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙ‚Ø·)
                categoriesIconsHTML += `
                <a href="classproductindex.html?category=${cat.id}" class="swiper-slide category-icon-item">
                    <div class="category-icon-circle"><i class="fas fa-tags text-2xl text-blue-500"></i></div>
                    <span>${cat.name}</span>
                </a>`;
                
                // 2. Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Ù…Ø¹ Ø§Ù„ÙØ±ÙˆØ¹)
                categoriesSidebarHTML += `
                    <div>
                        <a href="classproductindex.html?category=${cat.id}" class="flex items-center justify-between gap-4 p-3 text-lg font-semibold rounded-lg category-filter-btn hover:bg-gray-100" data-id="${cat.id}">
                            <div class="flex items-center gap-4"><i class="fas fa-tags w-8 text-center text-gray-400"></i> <span>${cat.name}</span></div>
                            ${activeSubcategories.length > 0 ? `<i class="fas fa-chevron-down text-sm text-gray-400"></i>` : ''}
                        </a>`;
                if(activeSubcategories.length > 0){
                    categoriesSidebarHTML += `<div class="pr-8 mt-1 space-y-1 hidden">`; // Submenu hidden by default
                    activeSubcategories.forEach(sub => {
                        categoriesSidebarHTML += `<a href="classproductindex.html?subcategory=${sub.id}" class="block p-2 rounded-md hover:bg-gray-100 text-gray-600 font-medium">${sub.name}</a>`;
                    });
                    categoriesSidebarHTML += `</div>`;
                }
                categoriesSidebarHTML += `</div>`;
            });
            categoriesSidebarHTML += `</div>`;

            // Ø±Ø³Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
            elements.categoryIconsWrapper.innerHTML = categoriesIconsHTML;
            new Swiper('#category-icons-section .swiper-container', {
                slidesPerView: 'auto',
                spaceBetween: 16,
                freeMode: true,
            });
            
            // Ø±Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
            elements.sidebarCategoriesContainer.innerHTML = categoriesSidebarHTML;

        } catch (error) { console.error("Error fetching categories:", error); }
    }

    // (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø¨Ø°Ù„ÙˆØ±Ø§Øª
    async function fetchAndRenderProducts() {
        try {
            const snapshot = await getDocs(query(
                collection(db, "products"), 
                orderBy("createdAt", "desc"), 
                limit(20)
            ));
            productsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // 1. ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨Ø°Ù„ÙˆØ±Ø§Øª
            const courses = productsCache.filter(p => p.productType === 'course' && p.availability !== 'sold_out');
            if (courses.length > 0) {
                elements.coursesCarouselWrapper.innerHTML = '';
                courses.forEach(course => {
                    elements.coursesCarouselWrapper.appendChild(createProductCard(course));
                });
                elements.coursesCarouselSection.classList.remove('hidden');
                new Swiper('#courses-carousel-section .swiper-container', {
                    slidesPerView: 'auto',
                    spaceBetween: 16,
                    freeMode: true,
                });
            }

            // 2. ÙÙ„ØªØ±Ø© Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±
            const products = productsCache.filter(p => (p.productType === 'regular' || !p.productType) && p.availability !== 'sold_out');
             if (products.length > 0) {
                elements.productsCarouselWrapper.innerHTML = '';
                products.forEach(product => {
                    elements.productsCarouselWrapper.appendChild(createProductCard(product));
                });
                elements.productsCarouselSection.classList.remove('hidden');
                new Swiper('#products-carousel-section .swiper-container', {
                    slidesPerView: 'auto',
                    spaceBetween: 16,
                    freeMode: true,
                });
            }

        } catch (error) { 
            console.error("Error fetching products:", error);
            elements.loader.innerHTML = '<p class="text-red-500">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.</p>';
        }
    }
    
    // (Ø¬Ø¯ÙŠØ¯) ÙƒØ±Øª Ø§Ù„Ù…Ù†ØªØ¬ (Ù„Ù„ÙƒØ§Ø±ÙˆØ³ÙŠÙ„)
    function createProductCard(product) {
        const card = document.createElement('div');
        card.className = 'swiper-slide carousel-card';
        
        const image = (product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls[0] : 'https://placehold.co/300x300';
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = product.name;
        const productName = tempDiv.textContent || tempDiv.innerText || "";
        
        let cardLink = `PRESENTPRODUCT.html?product=${product.id}`;
        let priceHTML = `<p class="text-blue-600 font-bold mx-2 mb-2">${(product.price || 0).toLocaleString()} Ø¯.Ø¬</p>`;

        if (product.productType === 'course') {
            cardLink = `dawarat_content.html?id=${product.id}`;
            priceHTML = `<p class="text-indigo-600 font-bold mx-2 mb-2">Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø°Ù„ÙˆØ±Ø©</p>`;
        } else if (product.productType === 'direct') {
            cardLink = `PRESENTPRODUCT.html?product=${product.id}`;
            priceHTML = `<p class="text-green-600 font-bold mx-2 mb-2">Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</p>`;
        }

        card.innerHTML = `
            <a href="${cardLink}" class="block flex flex-col flex-grow">
                <div class="carousel-card-image" style="background-image: url('${image}')"></div>
                <div class="carousel-card-content">
                    <h3 class="carousel-card-title">${productName}</h3>
                    <div class="flex-grow"></div> ${priceHTML}
                </div>
            </a>`;
        return card;
    }

    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø³Ù„Ø© ---
    function loadCartFromStorage() { /* ... (ÙƒÙ…Ø§ Ù‡ÙŠ) ... */ }
    function saveCartToStorage() { /* ... (ÙƒÙ…Ø§ Ù‡ÙŠ) ... */ }
    function updateCartIcon() {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        elements.cartBadgeBottom.textContent = totalItems;
        elements.cartBadgeBottom.classList.toggle('hidden', totalItems === 0);
    }
    function showCartModal() { /* ... (ÙƒÙ…Ø§ Ù‡ÙŠ) ... */ }
    window.updateCartQuantity = (productId, newQuantity) => { /* ... (ÙƒÙ…Ø§ Ù‡ÙŠ) ... */ };
    
    // --- Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
    async function initializeStore() {
        
        loadCartFromStorage();
        elements.bottomCartBtn.onclick = showCartModal;

        elements.loader.classList.remove('hidden');
        
        await Promise.all([
            loadStoreSettings(),
            fetchAndRenderCategories(),
            fetchAndRenderOffers(),
            fetchAndRenderProducts()
        ]);
        
        elements.loader.classList.add('hidden');
        
        // (Ø¬Ø¯ÙŠØ¯) Ø±Ø¨Ø· Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
        elements.menuBtn.onclick = () => {
            elements.sidebar.classList.add('active');
            elements.overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        };
        elements.closeSidebarBtn.onclick = closeSidebar;
        elements.overlay.onclick = closeSidebar;
        elements.sidebarComplaintBtn.onclick = (e) => { e.preventDefault(); showInquiryModal('complaint'); closeSidebar(); };
        elements.sidebarAddProductBtn.onclick = (e) => { e.preventDefault(); closeSidebar(); showRedirectModal({ title: "Ø¹Ø±Ø¶ Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯", icon: "ğŸ“¦", message: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ù„Ø¯ÙŠÙƒ Ù…Ù†ØªØ¬ ØªØ±ÙŠØ¯ Ø¹Ø±Ø¶Ù‡ ÙŠØ§ Ø²Ø¨ÙˆÙ†Ù†Ø§ Ø§Ù„ÙƒØ±ÙŠÙ…. Ù†Ø­Ù† Ø³Ù†Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡ ÙƒÙ…Ø§ Ø³Ù†Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø§Ù‚ØªÙ†Ø§Ø¦Ù‡ ÙˆØ¨ÙŠØ¹Ù‡ Ø¹Ù„Ù‰ Ø­Ø¯ Ø§Ù„Ø³ÙˆØ§Ø¡.", targetUrl: e.currentTarget.href }); };
        elements.sidebarOrdersBtn.onclick = (e) => { e.preventDefault(); closeSidebar(); showRedirectModal({ title: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª", icon: "ğŸ˜‹", message: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø²Ø§Ø¦Ø±Ù†Ø§ Ø§Ù„ÙƒØ±ÙŠÙ…ØŒ ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ùƒ Ø¬Ø§Ø¦Ø¹. Ù„Ø§ ØªÙ†Ø³Ù‰ØŒ Ù†Ø­Ù† Ù†Ù‡ØªÙ… Ø¨ÙƒÙ„ Ø´ÙŠØ¡ Ø¹ÙˆØ¶Ø§Ù‹ Ø¹Ù†Ùƒ. ÙƒÙ…Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø£Ù† ØªØ¬Ø¯ ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ù„Ø¹Ø¯Ø© Ù…Ø·Ø§Ø¹Ù… Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹.", targetUrl: e.currentTarget.href }); };
        
        // (Ø¬Ø¯ÙŠØ¯) Ø±Ø¨Ø· Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© (Ø§Ù„ØªÙŠ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±ØŒ ÙˆØ§Ù„ØªÙŠ Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ø§Ù„Ø¢Ù† ÙƒØ§Ø­ØªÙŠØ§Ø·)
        elements.userMenuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            elements.userMenuDropdown.classList.toggle('show');
        });
        document.addEventListener('click', (e) => {
            if (elements.userMenuDropdown && elements.userMenuDropdown.classList.contains('show') && !elements.userMenuButton.contains(e.target)) {
                elements.userMenuDropdown.classList.remove('show');
            }
        });
        elements.logoutBtn.addEventListener('click', () => {
            signOut(auth).catch((error) => console.error('Logout Error', error));
        });

        // (Ø¬Ø¯ÙŠØ¯) Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù„Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ ÙˆØ§Ù„Ù‡ÙŠØ¯Ø±
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„
                elements.bottomProfileBtn.classList.remove('hidden');
                elements.bottomLoginBtn.classList.add('hidden');
                
                // (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©)
                elements.loginBtn.classList.add('hidden');
                elements.loginBtn.classList.remove('sm:flex');
                elements.userMenu.classList.remove('hidden');
                const displayName = user.displayName || "Ø²Ø¨ÙˆÙ†Ù†Ø§";
                elements.userMenuName.textContent = displayName.split(' ')[0];
                elements.userMenuDisplayName.textContent = displayName;
                
            } else {
                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø²Ø§Ø¦Ø±
                elements.bottomProfileBtn.classList.add('hidden');
                elements.bottomLoginBtn.classList.remove('hidden');

                // (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©)
                elements.loginBtn.classList.remove('hidden');
                elements.loginBtn.classList.add('sm:flex');
                elements.userMenu.classList.add('hidden');
            }
        });
    }

    initializeStore();
    </script>
</body>
</html>