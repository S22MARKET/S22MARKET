<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - تصفح المنتجات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f0f2f5;
        }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 40;
            display: flex; align-items: center; justify-content: center;
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: white; padding: 1.5rem; border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%;
            max-width: 500px; z-index: 50;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #3b82f6;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <header class="bg-white shadow-sm sticky top-0 z-30">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800">S22<span class="text-blue-600">MARKET</span></h1>
            </div>
    </header>

    <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
            <aside class="md:col-span-1 bg-white p-6 rounded-xl shadow-md h-fit sticky top-24">
                <h3 class="text-xl font-bold mb-4 border-b pb-2">البحث والتصنيف</h3>
                <div class="space-y-4">
                    <div>
                        <label for="search-input" class="font-semibold">ابحث عن منتج</label>
                        <input type="text" id="search-input" placeholder="اسم المنتج، وصف..." class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="price-filter" class="font-semibold">ترتيب حسب السعر</label>
                        <select id="price-filter" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="default">افتراضي</option>
                            <option value="asc">من الأرخص للأغلى</option>
                            <option value="desc">من الأغلى للأرخص</option>
                        </select>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">الأقسام</h4>
                        <div id="store-categories" class="space-y-2">
                            <div class="text-center p-4"><div class="loader mx-auto"></div></div>
                        </div>
                    </div>
                </div>
            </aside>
            <div class="md:col-span-3">
                 <div id="store-loader" class="text-center py-20"><div class="loader mx-auto"></div><p class="mt-4 text-gray-600">جاري تحميل المنتجات...</p></div>
                 <div id="products-grid" class="hidden grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                    </div>
                 <div id="no-products-msg" class="hidden text-center py-20 text-gray-500">
                    <i class="fas fa-store-slash fa-4x text-gray-400"></i>
                    <p class="mt-4 text-xl">لا توجد منتجات مطابقة للبحث أو في هذا القسم حاليًا.</p>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="text-center py-6 bg-gray-800 text-white mt-12">
        <p>&copy; 2025 S22MARKET. جميع الحقوق محفوظة.</p>
    </footer>

    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAxEq-nkLDc3_HM38xb3mhb8ekSXmuFQ7I",
            authDomain: "s22market-4bdb9.firebaseapp.com",
            databaseURL: "https://s22market-4bdb9-default-rtdb.firebaseio.com",
            projectId: "s22market-4bdb9",
            storageBucket: "s22market-4bdb9.firebasestorage.app",
            messagingSenderId: "1029564929614",
            appId: "1:1029564929614:web:2866722c34cf1fb2b8951f",
            measurementId: "G-VH16M3Q33V"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let productsCache = [];
        const modalContainer = document.getElementById('modal-container');

        function closeModal() {
            modalContainer.innerHTML = '';
        }
        
        function showLoadingModal(text = 'جاري إرسال طلبك...') {
             modalContainer.innerHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content text-center">
                        <div class="loader mx-auto"></div>
                        <p class="mt-4 text-lg font-semibold text-gray-700">${text}</p>
                    </div>
                </div>
            `;
        }

        function renderStoreProducts() {
            const grid = document.getElementById('products-grid');
            const noProductsMsg = document.getElementById('no-products-msg');
            grid.innerHTML = '';

            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const priceSort = document.getElementById('price-filter').value;
            const activeCategoryBtn = document.querySelector('.category-filter-btn.active');
            const selectedCategoryId = activeCategoryBtn ? activeCategoryBtn.dataset.id : 'all';

            let filteredProducts = productsCache;
            if (selectedCategoryId !== 'all') {
                filteredProducts = filteredProducts.filter(p => p.categoryId === selectedCategoryId);
            }
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(p => p.name.toLowerCase().includes(searchTerm) || (p.description && p.description.toLowerCase().includes(searchTerm)));
            }
            if (priceSort === 'asc') {
                filteredProducts.sort((a, b) => a.price - b.price);
            } else if (priceSort === 'desc') {
                filteredProducts.sort((a, b) => b.price - a.price);
            }

            if (filteredProducts.length === 0) {
                grid.classList.add('hidden');
                noProductsMsg.classList.remove('hidden');
            } else {
                grid.classList.remove('hidden');
                noProductsMsg.classList.add('hidden');
                filteredProducts.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-xl shadow-md overflow-hidden group transform hover:-translate-y-2 transition-transform duration-300 cursor-pointer flex flex-col';
                    card.innerHTML = `
                        <div class="h-56 overflow-hidden">
                            <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e2e8f0/4a5568?text=Image+Not+Found';">
                        </div>
                        <div class="p-5 flex-grow flex flex-col">
                            <h3 class="text-lg font-bold text-gray-800 truncate">${product.name}</h3>
                            <p class="text-sm text-gray-500 mt-1 flex-grow">${product.description || ''}</p>
                            <p class="text-blue-600 text-2xl font-extrabold mt-4">${product.price.toLocaleString()} د.ج</p>
                        </div>
                    `;
                    card.addEventListener('click', () => showOrderModal(product));
                    grid.appendChild(card);
                });
            }
        }
        
        function showOrderModal(product) {
            const contactMethods = product.contactMethods || [];
            let contactButtonsHTML = '';
            if (contactMethods.length > 0) {
                contactButtonsHTML = `
                    <div class="my-4">
                        <div class="relative"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div><div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">أو تواصل مباشرة عبر</span></div></div>
                        <div class="mt-4 grid grid-cols-2 gap-3">
                            ${contactMethods.map(method => `<button data-url="${method.url}" data-method-name="${method.name}" class="social-order-btn inline-flex w-full justify-center items-center gap-2 rounded-md bg-gray-100 px-4 py-2 text-sm font-semibold text-gray-800 hover:bg-gray-200"><i class="${method.icon || 'fas fa-arrow-up-right-from-square'}"></i>${method.name}</button>`).join('')}
                        </div>
                    </div>
                `;
            }

            const modalHTML = `
                <div class="modal-backdrop" id="modal-backdrop">
                    <div class="modal-content">
                        <div class="flex justify-between items-start">
                             <h3 class="text-xl font-bold mb-4 text-gray-900">طلب المنتج: ${product.name}</h3>
                             <button id="modal-cancel" class="text-gray-400 hover:text-gray-600">&times;</button>
                        </div>
                        <p class="font-semibold text-gray-700 mb-4">أدخل معلوماتك لتسجيل الطلب أولاً.</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">الاسم الكامل</label>
                                <input type="text" id="customer-name" class="mt-1 block w-full border-gray-300 rounded-md p-2 shadow-sm" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">رقم الهاتف</label>
                                <input type="tel" id="customer-contact" class="mt-1 block w-full border-gray-300 rounded-md p-2 shadow-sm" required>
                            </div>
                        </div>
                        <div class="mt-6">
                            <button id="website-order-btn" class="w-full bg-blue-600 text-white font-bold py-2.5 rounded-lg hover:bg-blue-700 transition">تأكيد الطلب عبر الموقع</button>
                        </div>
                        ${contactButtonsHTML}
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalHTML;
            
            async function handleOrder(contactMethod) {
                const customerName = document.getElementById('customer-name').value;
                const customerContact = document.getElementById('customer-contact').value;

                if (!customerName || !customerContact) {
                    alert('الرجاء إدخال الاسم ورقم الهاتف أولاً لتسجيل الطلب.');
                    return null;
                }
                
                showLoadingModal('جاري تسجيل طلبك...');
                
                const orderData = {
                    customerName, customerContact,
                    productId: product.id, productName: product.name,
                    price: product.price, status: 'new',
                    contactMethod: contactMethod,
                    createdAt: serverTimestamp()
                };
                
                try {
                    await addDoc(collection(db, "orders"), orderData);
                    return true;
                } catch(e) {
                    console.error("Error adding document: ", e);
                    alert("حدث خطأ أثناء تسجيل الطلب.");
                    return false;
                }
            }

            document.getElementById('modal-cancel').addEventListener('click', closeModal);
            document.getElementById('modal-backdrop').addEventListener('click', (e) => {
                if(e.target.id === 'modal-backdrop') closeModal();
            });

            document.getElementById('website-order-btn').addEventListener('click', async () => {
                const success = await handleOrder('الموقع');
                if (success) {
                    closeModal();
                    alert('تم إرسال طلبك بنجاح! سنتصل بك قريباً.');
                }
            });

            document.querySelectorAll('.social-order-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const methodName = e.currentTarget.dataset.methodName;
                    const url = e.currentTarget.dataset.url;
                    const success = await handleOrder(methodName);
                    if (success) {
                         closeModal();
                         window.open(url, '_blank');
                    }
                });
            });
        }

        async function initializeStore() {
            document.getElementById('store-loader').style.display = 'block';
            document.getElementById('products-grid').classList.add('hidden');

            const catQuery = query(collection(db, "categories"), orderBy("name"));
            const catSnapshot = await getDocs(catQuery);
            const categories = catSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const storeCategoriesEl = document.getElementById('store-categories');
            storeCategoriesEl.innerHTML = '<button class="category-filter-btn active bg-blue-100 font-bold w-full text-right p-2 rounded-md" data-id="all">كل المنتجات</button>';
            categories.forEach(cat => {
                storeCategoriesEl.innerHTML += `<button class="category-filter-btn w-full text-right p-2 rounded-md hover:bg-gray-100" data-id="${cat.id}">${cat.name}</button>`;
            });

            document.querySelectorAll('.category-filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.category-filter-btn').forEach(b => b.classList.remove('active', 'bg-blue-100', 'font-bold'));
                    e.currentTarget.classList.add('active', 'bg-blue-100', 'font-bold');
                    renderStoreProducts();
                });
            });
            
            const prodQuery = query(collection(db, "products"), orderBy("createdAt", "desc"));
            const prodSnapshot = await getDocs(prodQuery);
            productsCache = prodSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            document.getElementById('store-loader').style.display = 'none';
            document.getElementById('products-grid').classList.remove('hidden');
            renderStoreProducts();

            document.getElementById('search-input').addEventListener('input', renderStoreProducts);
            document.getElementById('price-filter').addEventListener('change', renderStoreProducts);
        }

        initializeStore();
    </script>
</body>
</html>
