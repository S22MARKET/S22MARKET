<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>S22 Market - Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
    <meta name="theme-color" content="#4f46e5">
    <meta name="description" content="Ù…ØªØ¬Ø± S22 Market - Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø¹Ø±ÙˆØ¶">

    <link rel="apple-touch-icon" href="LOGO.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>


    <meta name="theme-color" content="#3b82f6">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --bg-body: #f8fafc;
            --nav-height: 70px;

            /* Dark Mode Variables */
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-sub: #94a3b8;
            --border-color: #f1f5f9;
        }

        body.dark-mode {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-sub: #cbd5e1;
            --border-color: #334155;
        }

        body.dark-mode .product-card,
        body.dark-mode .sidebar,
        body.dark-mode .glass-nav,
        body.dark-mode #main-header {
            background: var(--bg-card) !important;
            border-color: var(--border-color);
            color: var(--text-main);
        }

        body.dark-mode .text-gray-800,
        body.dark-mode .text-gray-700 {
            color: var(--text-main) !important;
        }

        body.dark-mode .bg-gray-100 {
            background-color: #334155 !important;
            color: white !important;
        }

        body.dark-mode .cat-icon {
            background: #1e293b;
            border-color: #334155;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-body);
            padding-bottom: calc(var(--nav-height) + 20px);
            /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Stores Slider */
        .stores-slider {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 10px;
            scroll-behavior: smooth;
        }

        .store-card-mini {
            min-width: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .store-card-mini:active {
            transform: scale(0.95);
        }

        .store-avatar-mini {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* Filter Panel in Header */
        #header-filters {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            max-height: 0;
        }

        #header-filters.open {
            max-height: 120px;
            margin-top: 10px;
        }

        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø²Ø¬Ø§Ø¬ (Glassmorphism) */
        .glass-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
        }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            color: #94a3b8;
            gap: 4px;
            transition: 0.3s;
            position: relative;
            width: 20%;
        }

        .nav-item i {
            font-size: 20px;
            transition: 0.3s;
        }

        .nav-item.active {
            color: var(--primary);
            font-weight: 700;
        }

        .nav-item.active i {
            transform: translateY(-3px);
        }

        /* Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… (Ù„Ù„Ù…Ø²Ø§Ø¯Ø§Øª) */
        .fab-container {
            position: relative;
            top: -25px;
        }

        .fab-btn {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
            border: 4px solid var(--bg-body);
        }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
        .sidebar-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 60;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
            backdrop-filter: blur(2px);
        }

        .sidebar-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -100%;
            width: 85%;
            max-width: 320px;
            height: 100%;
            background: white;
            z-index: 70;
            transition: right 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -5px 0 25px rgba(0, 0, 0, 0.15);
        }

        .sidebar.active {
            right: 0;
        }

        /* ÙƒØ±ÙˆØª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
        .product-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
            border: 1px solid #f1f5f9;
            transition: transform 0.2s;
            position: relative;
        }

        .product-card:active {
            transform: scale(0.98);
        }

        .product-image {
            aspect-ratio: 1/1;
            background-color: #f1f5f9;
            position: relative;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: 0.5s;
        }

        /* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Stories Style) */
        .cat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-width: 80px;
            cursor: pointer;
        }

        .cat-icon {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            /* Ø¯Ø§Ø¦Ø±ÙŠ Ù…Ø«Ù„ Ø§Ù„Ø³ØªÙˆØ±ÙŠ */
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            font-size: 24px;
            transition: 0.3s;
            color: var(--primary);
        }

        /* Ø­Ù„Ù‚Ø© Ù…Ù„ÙˆÙ†Ø© Ø­ÙˆÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
        .cat-icon::before {
            content: '';
            position: absolute;
            top: -2px;
            bottom: -2px;
            left: -2px;
            right: -2px;
            border-radius: 50%;
            background: linear-gradient(45deg, #f59e0b, #ec4899, #8b5cf6);
            z-index: -1;
        }

        /* Ø·Ø¨Ù‚Ø© Ø¨ÙŠØ¶Ø§Ø¡ Ù„Ù„ÙØµÙ„ */
        .cat-icon::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            border-radius: 50%;
            background: var(--bg-card);
            z-index: -1;
        }

        .cat-item:active .cat-icon {
            transform: scale(0.95);
        }

        /* Loader Animation */
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¸Ù‡ÙˆØ± */
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* New & Discount Badges */
        .badge-new {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 800;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
            animation: pulse-green 2s infinite;
        }

        .badge-discount {
            background: linear-gradient(135deg, #f43f5e, #e11d48);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        /* Cart Fly Animation */
        .fly-item {
            position: fixed;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1);
            pointer-events: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body>

    <header
        class="fixed top-0 left-0 right-0 bg-white/90 backdrop-blur-md z-40 px-4 py-3 shadow-sm transition-all duration-300"
        id="main-header">
        <div class="flex items-center justify-between gap-4">
            <button id="menu-btn"
                class="w-10 h-10 flex items-center justify-center text-gray-700 hover:bg-gray-50 rounded-full transition">
                <i class="fas fa-bars text-xl"></i>
            </button>

            <h1 class="text-xl font-extrabold text-gray-800 tracking-tight cursor-pointer"
                onclick="location.href='index.html'">
                S22<span class="text-indigo-600">MARKET</span>
            </h1>

            <div class="flex items-center gap-1">
                <a id="header-user-icon" href="login.html"
                    class="w-10 h-10 flex items-center justify-center text-gray-700 hover:bg-gray-50 rounded-full transition">
                    <i class="fas fa-user text-xl"></i>
                </a>

                <a href="cart.html"
                    class="w-10 h-10 flex items-center justify-center text-gray-700 relative hover:bg-gray-50 rounded-full transition">
                    <i class="fas fa-shopping-bag text-xl"></i>
                    <span id="header-cart-badge"
                        class="absolute top-1 right-0 bg-red-500 text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center hidden border-2 border-white">0</span>
                </a>
            </div>
        </div>

        <div class="mt-3 relative flex gap-2 items-center">
            <div class="relative flex-grow">
                <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ØŒ Ù…ØªØ¬Ø±ØŒ Ø£Ùˆ Ø®Ø¯Ù…Ø©..." inputmode="search"
                    enterkeyhint="search"
                    class="w-full bg-gray-100 text-gray-800 rounded-2xl py-3 pr-11 pl-12 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition shadow-inner">

                <!-- Voice Search Button -->
                <button id="voice-search-btn"
                    class="absolute left-2 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center text-indigo-500 hover:bg-indigo-50 rounded-full transition">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>

            <button id="filter-toggle-btn"
                class="w-12 h-11 bg-gray-100 rounded-2xl flex items-center justify-center text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 transition shadow-inner">
                <i class="fas fa-sliders-h"></i>
            </button>
        </div>

        <!-- Filter Panel -->
        <div id="header-filters" class="px-1">
            <div class="bg-gray-50 border border-gray-100 rounded-xl p-3 mt-2">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-gray-500">Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± (Ø¯.Ø¬)</span>
                    <span class="text-[10px] text-indigo-500 cursor-pointer" onclick="resetSearchFilters()">Ù…Ø³Ø­</span>
                </div>
                <div class="flex gap-2 items-center">
                    <input type="number" id="filter-min-price" placeholder="Ù…Ù†"
                        class="w-full bg-white border border-gray-200 rounded-lg px-2 py-1.5 text-sm text-center focus:border-indigo-500 focus:outline-none">
                    <span class="text-gray-400 text-xs">-</span>
                    <input type="number" id="filter-max-price" placeholder="Ø¥Ù„Ù‰"
                        class="w-full bg-white border border-gray-200 rounded-lg px-2 py-1.5 text-sm text-center focus:border-indigo-500 focus:outline-none">
                </div>
            </div>
        </div>
    </header>

    <div class="h-[120px]"></div>

    <main class="space-y-8 pb-4">

        <section class="px-4">
            <div class="flex justify-between items-end mb-3">
                <h2 class="font-bold text-gray-800 text-lg">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>
                <a href="classproductindex.html" class="text-xs text-indigo-600 font-bold">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
            </div>
            <div class="flex gap-4 overflow-x-auto no-scrollbar pb-2" id="categories-container">
                <div class="cat-item">
                    <div class="cat-icon skeleton"></div>
                    <div class="h-3 w-10 skeleton rounded"></div>
                </div>
                <div class="cat-item">
                    <div class="cat-icon skeleton"></div>
                    <div class="h-3 w-10 skeleton rounded"></div>
                </div>
                <div class="cat-item">
                    <div class="cat-icon skeleton"></div>
                    <div class="h-3 w-10 skeleton rounded"></div>
                </div>
                <div class="cat-item">
                    <div class="cat-icon skeleton"></div>
                    <div class="h-3 w-10 skeleton rounded"></div>
                </div>
                <div class="cat-item">
                    <div class="cat-icon skeleton"></div>
                    <div class="h-3 w-10 skeleton rounded"></div>
                </div>
            </div>
        </section>

        <section class="px-4">
            <div class="swiper main-slider rounded-2xl overflow-hidden shadow-lg h-44 sm:h-56 relative bg-gray-200">
                <div class="swiper-wrapper" id="hero-slider-wrapper">
                    <div class="swiper-slide skeleton w-full h-full"></div>
                </div>
                <div class="swiper-pagination"></div>
            </div>
        </section>

        <section class="px-4">
            <div class="grid grid-cols-2 gap-3">
                <a href="s22marketfood.html"
                    class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-2xl border border-orange-200 flex items-center justify-between hover:shadow-md transition">
                    <div>
                        <h3 class="font-bold text-orange-800">Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</h3>
                        <p class="text-[10px] text-orange-600 mt-1">Ø§Ø·Ù„Ø¨ ÙˆØ¬Ø¨ØªÙƒ ğŸ”</p>
                    </div>
                    <div
                        class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-orange-500 shadow-sm">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
                <a href="auctions.html"
                    class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-2xl border border-red-200 flex items-center justify-between hover:shadow-md transition">
                    <div>
                        <h3 class="font-bold text-red-800">Ø§Ù„Ù…Ø²Ø§Ø¯Ø§Øª</h3>
                        <p class="text-[10px] text-red-600 mt-1">Ø²Ø§ÙŠØ¯ ÙˆØ§Ø±Ø¨Ø­ ğŸ†</p>
                    </div>
                    <div
                        class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-red-500 shadow-sm">
                        <i class="fas fa-gavel"></i>
                    </div>
                </a>
            </div>
        </section>

        <!-- Stores Section -->
        <section class="px-4 hidden" id="stores-section">
            <div class="flex justify-between items-end mb-3">
                <h2 class="font-bold text-gray-800 text-lg">Ø§Ù„Ù…ØªØ§Ø¬Ø± Ø§Ù„Ù…Ù…ÙŠØ²Ø©</h2>
                <a href="classproductindex.html?showStores=true" class="text-xs text-indigo-600 font-bold">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
            </div>
            <div class="stores-slider no-scrollbar" id="stores-container">
                <!-- Stores Loaded Here -->
            </div>
        </section>

        <section class="px-4">
            <div id="home-dynamic-sections" class="space-y-8 mb-8"></div>

            <div class="flex justify-between items-center mb-4 hidden" id="default-recent-title">
                <h2 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                    <i class="fas fa-fire text-orange-500"></i> ÙˆØµÙ„ Ø­Ø¯ÙŠØ«Ø§Ù‹
                </h2>
            </div>

            <div id="products-grid" class="grid grid-cols-2 gap-3 sm:gap-4 hidden">
                <!-- Skeleton Loading Items -->
                <div class="product-card">
                    <div class="product-image skeleton h-full"></div>
                    <div class="p-3">
                        <div class="h-4 bg-gray-200 rounded w-3/4 mb-2 skeleton"></div>
                        <div class="h-4 bg-gray-200 rounded w-1/4 skeleton"></div>
                    </div>
                </div>
                <div class="product-card">
                    <div class="product-image skeleton h-full"></div>
                    <div class="p-3">
                        <div class="h-4 bg-gray-200 rounded w-3/4 mb-2 skeleton"></div>
                        <div class="h-4 bg-gray-200 rounded w-1/4 skeleton"></div>
                    </div>
                </div>
                <div class="product-card">
                    <div class="product-image skeleton h-full"></div>
                    <div class="p-3">
                        <div class="h-4 bg-gray-200 rounded w-3/4 mb-2 skeleton"></div>
                        <div class="h-4 bg-gray-200 rounded w-1/4 skeleton"></div>
                    </div>
                </div>
                <div class="product-card">
                    <div class="product-image skeleton h-full"></div>
                    <div class="p-3">
                        <div class="h-4 bg-gray-200 rounded w-3/4 mb-2 skeleton"></div>
                        <div class="h-4 bg-gray-200 rounded w-1/4 skeleton"></div>
                    </div>
                </div>
            </div>

            <div id="loading-spinner" class="py-8 text-center hidden">
                <div
                    class="inline-block w-6 h-6 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin">
                </div>
            </div>
        </section>

    </main>

    <div class="sidebar-backdrop" id="sidebar-backdrop"></div>
    <aside class="sidebar flex flex-col" id="sidebar">
        <div class="bg-gradient-to-br from-indigo-600 to-purple-700 p-6 text-white">
            <div class="flex items-center gap-3 mb-3">
                <div
                    class="w-14 h-14 bg-white/20 backdrop-blur rounded-full flex items-center justify-center text-2xl font-bold border-2 border-white/30">
                    <i class="fas fa-user"></i>
                </div>
                <div id="sidebar-user-info">
                    <h3 class="font-bold text-lg">Ø²Ø§Ø¦Ø± ÙƒØ±ÙŠÙ…</h3>
                    <a href="login.html"
                        class="text-xs bg-white/20 px-3 py-1 rounded-full hover:bg-white/30 transition inline-block mt-1">ØªØ³Ø¬ÙŠÙ„
                        Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
                </div>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-1">
            <a href="index.html"
                class="flex items-center gap-4 px-4 py-3 text-gray-700 bg-indigo-50 rounded-xl font-bold">
                <i class="fas fa-home w-5 text-center text-indigo-600"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </a>
            <a href="s22marketfood.html"
                class="flex items-center gap-4 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-xl transition">
                <i class="fas fa-utensils w-5 text-center text-orange-500"></i> Ø§Ù„Ù…Ø·Ø§Ø¹Ù…
            </a>
            <a href="auctions.html"
                class="flex items-center gap-4 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-xl transition">
                <i class="fas fa-gavel w-5 text-center text-red-500"></i> Ø§Ù„Ù…Ø²Ø§Ø¯Ø§Øª
            </a>
            <a href="offers.html"
                class="flex items-center gap-4 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-xl transition">
                <i class="fas fa-tags w-5 text-center text-yellow-500"></i> Ø§Ù„Ø¹Ø±ÙˆØ¶
            </a>

            <div class="my-3 border-t border-gray-100"></div>

            <a href="profile.html?action=open_store"
                class="flex items-center gap-4 px-4 py-3 text-gray-600 hover:bg-green-50 rounded-xl transition group">
                <i class="fas fa-store w-5 text-center text-green-600 group-hover:scale-110 transition-transform"></i>
                <span class="font-bold text-green-700">Ø§ÙØªØ­ Ù…ØªØ¬Ø±Ùƒ Ù…Ø¬Ø§Ù†Ø§Ù‹</span>
            </a>

            <a href="seller-dashboard.html" id="sidebar-seller-link"
                class="hidden flex items-center gap-4 px-4 py-3 text-gray-600 hover:bg-purple-50 rounded-xl transition">
                <i class="fas fa-chart-pie w-5 text-center text-purple-600"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ØªØ§Ø¬Ø±
            </a>
        </nav>

        <div class="px-4 pb-4">
            <button id="dark-mode-toggle"
                class="w-full flex items-center justify-between px-4 py-3 bg-gray-100 rounded-xl text-gray-700 hover:bg-gray-200 transition">
                <span class="flex items-center gap-2 font-bold"><i class="fas fa-moon"></i> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
                <div class="w-10 h-5 bg-gray-300 rounded-full relative transition-colors duration-300" id="dm-switch">
                    <div class="w-4 h-4 bg-white rounded-full absolute top-0.5 left-0.5 shadow-sm transition-transform duration-300"
                        id="dm-knob"></div>
                </div>
            </button>
        </div>

        <div class="p-4 text-center text-xs text-gray-400 border-t">
            S22 Market v3.1 (GitHub Fix)
        </div>
    </aside>

    <nav class="bottom-nav glass-nav">
        <a href="index.html" class="nav-item active">
            <i class="fas fa-home"></i> <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </a>
        <a href="s22marketfood.html" class="nav-item">
            <i class="fas fa-utensils"></i> <span>Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</span>
        </a>

        <a href="auctions.html" class="fab-container">
            <div class="fab-btn">
                <i class="fas fa-gavel"></i>
            </div>
        </a>

        <a href="cart.html" class="nav-item">
            <div class="relative">
                <i class="fas fa-shopping-cart"></i>
                <span id="nav-cart-badge"
                    class="absolute -top-1 -right-2 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center font-bold border-2 border-white hidden">0</span>
            </div>
            <span>Ø§Ù„Ø³Ù„Ø©</span>
        </a>
        <a href="profile.html" class="nav-item">
            <i class="fas fa-user"></i> <span>Ø­Ø³Ø§Ø¨ÙŠ</span>
        </a>
    </nav>

    <div id="toast-container"></div>

    <!-- Login Promotion Modal -->
    <div id="login-promo-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="promo-backdrop"></div>
        <div
            class="relative bg-white/90 backdrop-blur-xl border border-white/20 rounded-3xl p-6 md:p-8 w-full max-w-sm text-center shadow-2xl transform scale-100 transition-all">
            <button id="close-promo-btn"
                class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200 transition">
                <i class="fas fa-times"></i>
            </button>
            <div
                class="w-20 h-20 bg-gradient-to-tr from-indigo-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-indigo-500/30 text-white text-3xl animate-bounce">
                <i class="fas fa-gift"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ ÙˆØ§Ø±Ø¨Ø­!</h3>
            <p class="text-gray-600 mb-6 text-sm leading-relaxed">
                Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø§Ù„Ø¢Ù† Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ®ÙÙŠØ¶Ø§Øª Ø­ØµØ±ÙŠØ© ÙˆÙ…Ø²Ø§ÙŠØ§ Ø®Ø§ØµØ© Ù„Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙÙ‚Ø·. Ù„Ø§ ØªÙÙˆØª Ø§Ù„ÙØ±ØµØ©!
            </p>
            <div class="space-y-3">
                <a href="login.html"
                    class="block w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-indigo-500/30 transition-transform transform active:scale-95">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
                </a>
                <button id="promo-later-btn"
                    class="block w-full py-3 px-4 text-gray-500 hover:text-gray-700 font-medium text-sm transition">
                    Ù„Ø§Ø­Ù‚Ø§Ù‹
                </button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const promoModal = document.getElementById('login-promo-modal');
            const closeBtn = document.getElementById('close-promo-btn');
            const backdrop = document.getElementById('promo-backdrop');
            const laterBtn = document.getElementById('promo-later-btn');

            if (!sessionStorage.getItem('loginPromoSeen')) {
                setTimeout(() => {
                    if (promoModal) promoModal.classList.remove('hidden');
                }, 3000);
            }

            const closeModal = () => {
                if (promoModal) promoModal.classList.add('hidden');
                sessionStorage.setItem('loginPromoSeen', 'true');
            };

            if (closeBtn) closeBtn.addEventListener('click', closeModal);
            if (backdrop) backdrop.addEventListener('click', closeModal);
            if (laterBtn) laterBtn.addEventListener('click', closeModal);
        });
    </script>

    <!-- Mobile Enhancements -->
    <!-- Mobile Enhancements -->
    <script>
        /**
         * Mobile Enhancements Script
         * Handles back button for overlays, pull-to-refresh, and page transitions.
         */

        class MobileEnhancements {
            constructor() {
                this.overlayStack = []; // Stack to track open overlays (sidebar, modals)
                this.touchStartY = 0;
                this.refreshThreshold = 150; // Pull distance to trigger refresh
                this.isPulling = false;
                this.spinner = null;

                this.init();
            }

            init() {
                this.setupBackButton();
                this.setupPullToRefresh();
                this.setupPageTransitions();
                this.setupAutoHidingNavbar();
                // this.setupPWAInstall(); // Removed PWA Install
                this.injectStyles();
            }

            // --- Back Button Logic ---

            setupBackButton() {
                // Push initial state to handle the first back press
                window.history.replaceState({ overlay: null }, document.title, window.location.href);

                window.addEventListener('popstate', (event) => {
                    if (this.overlayStack.length > 0) {
                        // If overlays are open, close the top one
                        const topOverlay = this.overlayStack.pop();
                        if (topOverlay && typeof topOverlay.close === 'function') {
                            topOverlay.close();
                            // Prevent default back navigation by pushing state again ONLY if we closed something
                            // However, popstate already happened, effectively "going back".
                            // If we want to stay on page, we need to push state again.
                            // But standard pattern:
                            // Open Overlay -> Push State
                            // Back Press -> Pop State -> Close Overlay

                            // So we don't need to push state here. The "Back" action removed the state we added when opening.
                        }
                    } else {
                        // Normal back navigation matches browser behavior
                    }
                });
            }

            /**
             * Call this when opening an overlay (Sidebar, Modal)
             * @param {Function} closeCallback - Function to actually close the UI element
             * @param {string} name - Name for debugging
             */
            pushOverlay(closeCallback, name = 'overlay') {
                this.overlayStack.push({ close: closeCallback, name });
                window.history.pushState({ overlay: name }, document.title, window.location.href);
            }

            /**
             * Call this when closing an overlay Programmatically (e.g. clicking 'X' button)
             * This ensures the history state is kept in sync (removes the state we added)
             */
            closeOverlay() {
                if (this.overlayStack.length > 0) {
                    // We do NOT pop here. We let the popstate event handler do it.
                    // This ensures consistent behavior whether the user presses Back or clicks 'X'.
                    window.history.back();
                }
            }

            // --- Pull to Refresh Logic ---

            setupPullToRefresh() {
                // Create Spinner
                this.spinner = document.createElement('div');
                this.spinner.className = 'ptr-spinner';
                this.spinner.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>';
                document.body.prepend(this.spinner);

                window.addEventListener('touchstart', (e) => {
                    if (window.scrollY === 0) {
                        this.touchStartY = e.touches[0].clientY;
                    }
                }, { passive: true });

                window.addEventListener('touchmove', (e) => {
                    if (window.scrollY === 0 && this.touchStartY > 0) {
                        const touchY = e.touches[0].clientY;
                        const pullDistance = touchY - this.touchStartY;

                        if (pullDistance > 0) {
                            this.isPulling = true;
                            // Visual feedback
                            this.spinner.style.transform = `translateY(${Math.min(pullDistance / 2, 80)}px) translateX(-50%) rotate(${pullDistance}deg)`;
                            this.spinner.style.opacity = Math.min(pullDistance / 100, 1);
                        }
                    }
                }, { passive: true });

                window.addEventListener('touchend', (e) => {
                    if (this.isPulling) {
                        const touchY = e.changedTouches[0].clientY;
                        const pullDistance = touchY - this.touchStartY;

                        if (pullDistance > this.refreshThreshold) {
                            this.triggerRefresh();
                        } else {
                            this.resetSpinner();
                        }
                        this.isPulling = false;
                        this.touchStartY = 0;
                    }
                });
            }

            triggerRefresh() {
                this.spinner.style.transition = '0.3s';
                this.spinner.style.transform = 'translateY(60px) translateX(-50%) rotate(360deg)';
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            }

            resetSpinner() {
                this.spinner.style.transition = '0.3s';
                this.spinner.style.transform = 'translateY(-50px) translateX(-50%)';
                this.spinner.style.opacity = '0';
            }

            // --- Page Transitions ---

            setupPageTransitions() {
                document.body.classList.add('page-enter');

                // Hijack internal links for exit animation (optional, can be disabled if buggy)
                // document.addEventListener('click', (e) => {
                //     const link = e.target.closest('a');
                //     if (link && link.href && link.href.startsWith(window.location.origin) && !link.target) {
                //         e.preventDefault();
                //         document.body.classList.add('page-exit');
                //         setTimeout(() => {
                //             window.location.href = link.href;
                //         }, 300);
                //     }
                // });
            }

            injectStyles() {
                const style = document.createElement('style');
                style.textContent = `
                    /* Pull to Refresh Spinner */
                    .ptr-spinner {
                        position: fixed;
                        top: -50px;
                        left: 50%;
                        transform: translateX(-50%);
                        width: 40px;
                        height: 40px;
                        background: white;
                        border-radius: 50%;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 1000;
                        color: var(--primary, #4f46e5);
                        opacity: 0;
                        pointer-events: none;
                    }

                    /* Page Transitions */
                    .page-enter {
                        animation: fadeEnter 0.4s ease-out forwards;
                    }
                    @keyframes fadeEnter {
                        from { opacity: 0; transform: translateY(10px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                    
                    .page-exit {
                        opacity: 0;
                        transform: scale(0.98);
                        transition: 0.3s;
                    }

                    /* Auto Hide Navbar */
                    .bottom-nav {
                        transition: transform 0.3s ease-in-out;
                    }
                    .bottom-nav.nav-hidden {
                        transform: translateY(100%);
                    }

                    /* PWA Modal */
                    .pwa-modal {
                        position: fixed;
                        bottom: 20px;
                        left: 20px;
                        right: 20px;
                        background: white;
                        border-radius: 16px;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
                        z-index: 9999;
                        transform: translateY(150%);
                        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                        max-width: 400px;
                        margin: 0 auto;
                        border: 1px solid rgba(0,0,0,0.05);
                    }
                    
                    .pwa-modal.active {
                        transform: translateY(0);
                    }

                    .pwa-content {
                        padding: 20px;
                    }
                `;
                document.head.appendChild(style);
            }



            setupAutoHidingNavbar() {
                let lastScrollY = window.scrollY;
                const bottomNav = document.querySelector('.bottom-nav');
                if (!bottomNav) return;

                window.addEventListener('scroll', () => {
                    const currentScrollY = window.scrollY;
                    if (Math.abs(currentScrollY - lastScrollY) < 10) return;
                    if (currentScrollY > lastScrollY && currentScrollY > 100) {
                        bottomNav.classList.add('nav-hidden');
                    } else {
                        bottomNav.classList.remove('nav-hidden');
                    }
                    lastScrollY = currentScrollY;
                }, { passive: true });
            }


        }

        // Initialize
        const mobileApp = new MobileEnhancements();

        // Global Helper for existing code to call
        window.openMobileOverlay = (closeCallback, name) => mobileApp.pushOverlay(closeCallback, name);
        window.closeMobileOverlay = () => mobileApp.closeOverlay();
    </script>

    <script type="module">
        // --- Inlined: Firebase Config ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc, query, orderBy, serverTimestamp, where, limit, updateDoc, onSnapshot, arrayUnion, arrayRemove, setDoc, writeBatch, Timestamp, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, sendPasswordResetEmail, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        // --- End Inlined Config ---

        // --- 2. Global State & UI Elements ---
        let currentUser = null;
        let userWishlist = new Set();
        let currentUserProfile = null;

        const sidebar = document.getElementById('sidebar');
        const backdrop = document.getElementById('sidebar-backdrop');
        const menuBtn = document.getElementById('menu-btn');
        const productsGrid = document.getElementById('products-grid');
        const categoriesContainer = document.getElementById('categories-container');
        const storeSection = document.getElementById('stores-section');
        const storesContainer = document.getElementById('stores-container');
        const heroWrapper = document.getElementById('hero-slider-wrapper');
        const searchInput = document.getElementById('search-input');
        const header = document.getElementById('main-header');

        // Filter Elements
        const filterToggleBtn = document.getElementById('filter-toggle-btn');
        const headerFilters = document.getElementById('header-filters');
        const filterMin = document.getElementById('filter-min-price');
        const filterMax = document.getElementById('filter-max-price');

        // Filter Toggle Logic
        if (filterToggleBtn) {
            filterToggleBtn.addEventListener('click', () => {
                headerFilters.classList.toggle('open');
                filterToggleBtn.classList.toggle('bg-indigo-50');
                filterToggleBtn.classList.toggle('text-indigo-600');
            });
        }

        window.resetSearchFilters = () => {
            filterMin.value = '';
            filterMax.value = '';
        };

        // --- 3. UI Interactions ---

        // Scroll Effect for Header
        window.addEventListener('scroll', () => {
            if (window.scrollY > 20) {
                header.classList.add('shadow-md');
                // Check if not dark mode for bg
                if (!document.body.classList.contains('dark-mode')) {
                    header.classList.add('bg-white/95');
                    header.classList.remove('bg-white/0');
                }
            } else {
                header.classList.remove('shadow-md');
            }
        });

        // --- Voice Search Logic ğŸ™ï¸ ---
        const voiceBtn = document.getElementById('voice-search-btn');
        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ar-SA';
            recognition.continuous = false;

            voiceBtn.onclick = () => {
                recognition.start();
                voiceBtn.innerHTML = '<i class="fas fa-microphone-slash animate-pulse text-red-500"></i>';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                searchInput.value = transcript;
                window.location.href = `classproductindex.html?search=${encodeURIComponent(transcript.trim())}`;
            };

            recognition.onend = () => {
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            };
        } else {
            voiceBtn.style.display = 'none'; // Hide if not supported
        }

        // --- Dark Mode Logic ğŸŒ™ ---
        const dmToggle = document.getElementById('dark-mode-toggle');
        const dmSwitch = document.getElementById('dm-switch');
        const dmKnob = document.getElementById('dm-knob');

        // Check LocalStorage
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            updateToggleUI(true);
        }

        function updateToggleUI(isDark) {
            if (isDark) {
                dmSwitch.classList.replace('bg-gray-300', 'bg-indigo-600');
                dmKnob.style.transform = 'translateX(20px)';
            } else {
                dmSwitch.classList.replace('bg-indigo-600', 'bg-gray-300');
                dmKnob.style.transform = 'translateX(0)';
            }
        }

        if (dmToggle) {
            dmToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isDark = document.body.classList.contains('dark-mode');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                updateToggleUI(isDark);
            });
        }

        // Sidebar Toggle
        // Initialize Mobile Features
        const toggleSidebar = () => {
            const isActive = sidebar.classList.toggle('active');
            backdrop.classList.toggle('active');
            document.body.style.overflow = isActive ? 'hidden' : '';

            // Integrate with Shared Mobile Logic
            if (isActive && window.openMobileOverlay) {
                // Pass the function that actively closes the sidebar (without logic loop)
                window.openMobileOverlay(() => {
                    sidebar.classList.remove('active');
                    backdrop.classList.remove('active');
                    document.body.style.overflow = '';
                }, 'sidebar');
            }
        };

        menuBtn.addEventListener('click', toggleSidebar);
        backdrop.addEventListener('click', () => {
            // If user clicks backdrop manually, we should also sync history if possible.
            // But simplest is to just toggle, and if we added state, we just go back.
            // Ideally: if open, backing out handles it. 
            // If clicking backdrop to close: we should call closeMobileOverlay() to pop the history state.
            if (sidebar.classList.contains('active')) {
                if (window.closeMobileOverlay) window.closeMobileOverlay();
                else toggleSidebar(); // Fallback
            }
        });

        // Search Redirect
        // Search Redirect with Params
        const handleSearch = () => {
            const query = searchInput.value.trim();
            const min = filterMin ? filterMin.value : '';
            const max = filterMax ? filterMax.value : '';

            if (query || min || max) {
                let url = `classproductindex.html?search=${encodeURIComponent(query)}`;
                if (min) url += `&minPrice=${min}`;
                if (max) url += `&maxPrice=${max}`;
                window.location.href = url;
            }
        };

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSearch();
        });

        // Also allow updating search live from filters if needed? No, just keep standard behavior.

        // --- 4. Data Fetching Functions ---

        async function initHome() {
            // A. Load Featured Stores
            loadFeaturedStores();
            // B. Load Dynamic Sections (Custom Home Layout)
            await loadHomeSections();

            // B. Load Categories (Independent)
            try {
                const catSnap = await getDocs(query(collection(db, "categories"), orderBy("orderIndex")));
                let catHTML = `
                    <a href="classproductindex.html" class="cat-item">
                        <div class="cat-icon bg-indigo-50 border-indigo-100"><i class="fas fa-th-large"></i></div>
                        <span class="text-[10px] font-bold text-gray-600">Ø§Ù„ÙƒÙ„</span>
                    </a>`;

                catSnap.forEach(doc => {
                    const c = doc.data();
                    const icon = c.icon || 'fa-box';
                    catHTML += `
                        <a href="classproductindex.html?category=${doc.id}" class="cat-item">
                            <div class="cat-icon"><i class="fas ${icon}"></i></div>
                            <span class="text-[10px] font-bold text-gray-600 truncate w-16 text-center">${c.name}</span>
                        </a>`;
                });
                categoriesContainer.innerHTML = catHTML;
            } catch (e) { console.error("Categories failed", e); }

            // B. Load Hero Slider (Offers)
            try {
                const offerSnap = await getDocs(query(collection(db, "offers"), orderBy("createdAt", "desc"), limit(5)));
                if (!offerSnap.empty) {
                    heroWrapper.innerHTML = '';
                    offerSnap.forEach(doc => {
                        const o = doc.data();
                        const img = o.imageUrl || 'https://placehold.co/600x300';
                        heroWrapper.innerHTML += `
                            <div class="swiper-slide bg-gray-200">
                                <a href="PRESENTPRODUCT.html?offer=${doc.id}" class="block w-full h-full relative">
                                    <img src="${img}" class="w-full h-full object-cover">
                                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent p-4 text-white">
                                        <h3 class="font-bold text-lg leading-tight mb-1">${o.title}</h3>
                                        <p class="text-xs opacity-90 line-clamp-1">${o.description || ''}</p>
                                    </div>
                                </a>
                            </div>`;
                    });

                    // Add Navigation Buttons for Large Screens
                    heroWrapper.parentElement.insertAdjacentHTML('beforeend', `
                        <div class="swiper-button-next !w-8 !h-8 !bg-white/80 !rounded-full !text-indigo-600 !text-xs !hidden sm:!flex after:!text-xs shadow-md"></div>
                        <div class="swiper-button-prev !w-8 !h-8 !bg-white/80 !rounded-full !text-indigo-600 !text-xs !hidden sm:!flex after:!text-xs shadow-md"></div>
                    `);

                    new Swiper('.main-slider', {
                        pagination: { el: '.swiper-pagination', dynamicBullets: true },
                        navigation: {
                            nextEl: '.swiper-button-next',
                            prevEl: '.swiper-button-prev',
                        },
                        autoplay: { delay: 4000, disableOnInteraction: false },
                        loop: true,
                        effect: 'fade'
                    });
                } else {
                    heroWrapper.innerHTML = `<div class="swiper-slide"><img src="https://placehold.co/600x300/4f46e5/ffffff?text=Welcome+S22" class="w-full h-full object-cover"></div>`;
                }
            } catch (e) { console.error("Offers failed", e); }

            // C. Load Recent Products (Logic moved to loadHomeSections to prevent double fetching)
            // Legacy code removed.
        }

        async function loadFeaturedStores() {
            try {
                // Fetch Vendors and Restaurants
                // Note: For Scalability, should use a limit and maybe a 'isFeatured' flag
                // For now, we fetch a batch of sellers
                const q = query(collection(db, "users"), where("role", "in", ["vendor", "restaurant"]), limit(10));
                const snap = await getDocs(q);

                if (!snap.empty) {
                    let html = '';
                    snap.forEach(doc => {
                        const s = doc.data();
                        const name = s.storeName || s.displayName || 'Ù…ØªØ¬Ø±';
                        const avatar = s.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&color=fff&size=128`;

                        // Exclude admin or invalid
                        if (!s.role) return;

                        html += `
                            <div class="store-card-mini" onclick="location.href='classproductindex.html?sellerId=${doc.id}'">
                                <img src="${avatar}" class="store-avatar-mini" loading="lazy">
                                <span class="text-[10px] font-bold text-gray-700 truncate w-16 text-center">${name}</span>
                            </div>
                        `;
                    });

                    if (html) {
                        storesContainer.innerHTML = html;
                        storeSection.classList.remove('hidden');
                    }
                }
            } catch (e) {
                console.error("Error loading stores:", e);
                // Fail silently for UI
            }
        }

        // --- Dynamic Sections Logic ---
        async function loadHomeSections() {
            const container = document.getElementById('home-dynamic-sections');
            const defaultGrid = document.getElementById('products-grid');
            const defaultTitle = document.getElementById('default-recent-title');

            try {
                const q = query(collection(db, "home_sections"), orderBy("orderIndex", "asc"));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    // If no dynamic sections, show default recent products
                    defaultGrid.classList.remove('hidden');
                    defaultTitle.classList.remove('hidden');

                    // Helper to load default products
                    loadDefaultRecentProducts();
                    return;
                }

                container.innerHTML = '';

                // Hide default hardcoded section if we have dynamic ones
                // (Or keep it if you prefer mixed, but typically dynamic replaces static)
                // For now, we assume if dynamic sections exist, we use them.

                for (const docSnap of snapshot.docs) {
                    const section = docSnap.data();
                    if (section.isActive === false) continue; // Skip inactive

                    const sectionDiv = document.createElement('section');
                    // sectionDiv.className = "px-4"; 

                    // Header
                    const headerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                                 ${getSectionIcon(section.type)} ${section.title}
                            </h2>
                            ${section.type === 'category' ? `<a href="classproductindex.html?category=${section.config?.categoryId || ''}" class="text-xs text-indigo-600 font-bold">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>` : ''}
                        </div>`;

                    sectionDiv.innerHTML = headerHTML;

                    // Content Container
                    const gridDiv = document.createElement('div');
                    gridDiv.className = "grid grid-cols-2 gap-3 sm:gap-4";
                    sectionDiv.appendChild(gridDiv);

                    // Fetch Data based on type
                    let products = [];
                    try {
                        if (section.type === 'recent') {
                            try {
                                // Use the robust method: Fetch simple batch then sort in memory
                                // This bypasses Index requirements completely
                                const qProd = query(collection(db, "products"), limit(50));
                                const snap = await getDocs(qProd);
                                products = snap.docs
                                    .map(d => ({ id: d.id, ...d.data() }))
                                    .filter(p => p.productType !== 'course')
                                    .sort((a, b) => {
                                        // Sort desc by createdAt, handling missing dates safely
                                        const dateA = a.createdAt?.seconds || 0;
                                        const dateB = b.createdAt?.seconds || 0;
                                        return dateB - dateA;
                                    })
                                    .slice(0, 6); // Take top 6 after filtering details
                            } catch (e) {
                                console.error("Error fetching recent section:", e);
                            }
                        } else if (section.type === 'category') {
                            if (section.config && section.config.categoryId) {
                                const qCat = query(collection(db, "products"), where("categoryId", "==", section.config.categoryId), limit(6));
                                const snap = await getDocs(qCat);
                                products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                            }
                        } else if (section.type === 'offers') {
                            // Fetch from offers collection
                            const qOff = query(collection(db, "offers"), limit(6));
                            const snap = await getDocs(qOff);
                            products = snap.docs.map(d => ({ id: d.id, ...d.data(), isOffer: true }));
                        }
                    } catch (err) {
                        console.error(`Error loading section ${section.title}:`, err);
                        gridDiv.innerHTML = '<p class="text-red-400 text-xs">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…</p>';
                        container.appendChild(sectionDiv);
                        continue;
                    }

                    // Render Items
                    if (products.length > 0) {
                        products.forEach(p => {
                            // If it's an offer, map it to product-like structure for the card if needed, 
                            // or create a special card.
                            // Assuming createProductCard handles standard product object.
                            // For offers, we might need adapter.
                            if (p.isOffer) {
                                // Simple adapter for offer to product card
                                p.name = p.title;
                                p.price = p.discountPrice || p.price || 0;
                            }
                            gridDiv.innerHTML += createProductCardHTML(p);
                        });
                    } else {
                        gridDiv.innerHTML = '<div class="col-span-full text-center py-4 text-gray-400 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù„Ø¹Ø±Ø¶Ù‡Ø§</div>';
                    }

                    container.appendChild(sectionDiv);
                }

                // Setup wishlist listeners for new dynamic content
                setupWishlistButtons();

            } catch (e) {
                console.error("Error loading home sections:", e);
                // Fallback
                defaultGrid.classList.remove('hidden');
                defaultTitle.classList.remove('hidden');
                loadDefaultRecentProducts();
            }
        }

        function getSectionIcon(type) {
            if (type === 'recent') return '<i class="fas fa-clock text-blue-500"></i>';
            if (type === 'category') return '<i class="fas fa-folder-open text-indigo-500"></i>';
            if (type === 'offers') return '<i class="fas fa-fire text-orange-500"></i>';
            return '<i class="fas fa-layer-group"></i>';
        }

        function createProductCardHTML(p) {
            const img = (p.imageUrls && p.imageUrls[0]) ? p.imageUrls[0] : (p.imageUrl || 'https://placehold.co/300');
            const isDirect = p.productType === 'direct';
            const price = p.price ? p.price.toLocaleString() : '0';

            // Badge Logic
            let badgesHTML = '';

            // 1. New Badge (Top Left, below wishlist if needed, or Top Right stacked)
            // Logic: Created within last 7 days
            if (p.createdAt) {
                const createdDate = p.createdAt.seconds ? new Date(p.createdAt.seconds * 1000) : new Date(p.createdAt);
                const diffTime = Math.abs(new Date() - createdDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays <= 7) {
                    badgesHTML += `<span class="badge-new absolute top-2 right-2 z-10">Ø¬Ø¯ÙŠØ¯</span>`;
                }
            }

            // 2. Discount Badge (If originalPrice exists and is higher)
            if (p.originalPrice && p.originalPrice > p.price) {
                const discount = Math.round(((p.originalPrice - p.price) / p.originalPrice) * 100);
                if (discount > 0) {
                    // Position: Top Right (Stacked if New exists, we'll use a flex container there ideally)
                    // For simplicity, let's put it top right but offset if 'New' exists? 
                    // Or better: Just put absolute.
                    // Let's wrap badges in a container.
                }
            }

            // Refined Badge Container
            let badgesContainer = '<div class="absolute top-2 right-2 flex flex-col gap-1 items-end z-10">';

            if (p.createdAt) {
                const createdDate = p.createdAt.seconds ? new Date(p.createdAt.seconds * 1000) : new Date(p.createdAt);
                const diffDays = Math.ceil(Math.abs(new Date() - createdDate) / (1000 * 60 * 60 * 24));
                if (diffDays <= 7) {
                    badgesContainer += `<span class="badge-new">Ø¬Ø¯ÙŠØ¯</span>`;
                }
            }

            if (p.originalPrice && p.originalPrice > p.price) {
                const discount = Math.round(((p.originalPrice - p.price) / p.originalPrice) * 100);
                if (discount > 0) badgesContainer += `<span class="badge-discount bg-red-500 text-white">-${discount}%</span>`;
            }

            if (isDirect) {
                badgesContainer += `<span class="bg-indigo-600 text-white text-[10px] px-2 py-1 rounded-md font-bold shadow-sm backdrop-blur">Ù…Ø¨Ø§Ø´Ø±</span>`;
            }

            badgesContainer += '</div>';

            return `
                <div class="product-card group relative bg-white rounded-2xl overflow-hidden border border-slate-100 hover:border-indigo-100 hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1" onclick="location.href='PRESENTPRODUCT.html?product=${p.id}${p.isOffer ? '&offer=true' : ''}'">
                    
                    <div class="product-image h-40 sm:h-48 relative overflow-hidden bg-gray-50">
                        <img src="${img}" alt="${p.name}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" loading="lazy" id="img-${p.id}">
                        
                        <!-- Badges -->
                        ${badgesContainer}

                        <!-- Wishlist Button -->
                        <button class="wishlist-btn absolute top-2 left-2 w-9 h-9 bg-white/80 backdrop-blur text-slate-400 hover:text-red-500 hover:bg-white rounded-full flex items-center justify-center shadow-sm transition-all duration-300 z-20" data-id="${p.id}" onclick="event.stopPropagation()">
                            <i class="far fa-heart"></i>
                        </button>
                        
                        <!-- Quick Add Overlay (Mobile Friendly) -->
                        <div class="absolute inset-x-0 bottom-0 p-3 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex justify-end">
                            <!-- Maybe quick view icon here? -->
                        </div>
                    </div>

                    <div class="p-4">
                        <div class="mb-2">
                             <a href="classproductindex.html?category=${p.categoryId || 'all'}" class="text-[10px] text-slate-400 hover:text-indigo-500 transition-colors" onclick="event.stopPropagation()">${p.categoryName || 'Ø¹Ø§Ù…'}</a>
                             <h3 class="text-sm font-bold text-slate-800 line-clamp-2 leading-relaxed h-[2.5rem]">${p.name}</h3>
                        </div>

                        <div class="flex justify-between items-end border-t border-slate-50 pt-3 mt-1">
                            <div class="flex flex-col">
                                ${p.originalPrice && p.originalPrice > p.price ? `<span class="text-[10px] text-slate-400 line-through decoration-red-400">${p.originalPrice.toLocaleString()} Ø¯.Ø¬</span>` : ''}
                                <span class="text-indigo-600 font-extrabold text-base">${price} <span class="text-[10px] font-normal text-slate-500">Ø¯.Ø¬</span></span>
                            </div>
                            
                            <button class="add-to-cart-btn w-9 h-9 rounded-xl bg-orange-50 text-orange-500 hover:bg-orange-500 hover:text-white flex items-center justify-center transition-all duration-300 shadow-sm hover:shadow-orange-200 active:scale-90" 
                                onclick="event.stopPropagation(); addToCartWithAnimation(this, '${p.id}', '${String(p.name).replace(/'/g, "\\'")}', ${p.price}, '${img}')">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
        }

        // Helper Animation for Cart
        function addToCartWithAnimation(btn, id, name, price, img) {
            // 1. Trigger Fly Animation
            const cartIcon = document.querySelector('.fa-shopping-bag') || document.querySelector('.fa-shopping-cart'); // Target nav icon
            if (cartIcon) {
                const startRect = btn.getBoundingClientRect();
                const endRect = cartIcon.getBoundingClientRect();

                const flyer = document.createElement('img');
                flyer.src = img;
                flyer.className = 'fly-item';
                flyer.style.left = `${startRect.left}px`;
                flyer.style.top = `${startRect.top}px`;
                document.body.appendChild(flyer);

                // Force reflow
                void flyer.offsetWidth;

                flyer.style.left = `${endRect.left}px`;
                flyer.style.top = `${endRect.top}px`;
                flyer.style.width = '20px';
                flyer.style.height = '20px';
                flyer.style.opacity = '0.5';

                setTimeout(() => {
                    flyer.remove();
                    // Shake Cart
                    cartIcon.parentElement.classList.add('animate-bounce');
                    setTimeout(() => cartIcon.parentElement.classList.remove('animate-bounce'), 1000);
                }, 800);
            }

            // 2. Add to LocalStorage Logic
            let cart = JSON.parse(localStorage.getItem('s22market_cart')) || [];
            const existing = cart.find(i => i.id === id);
            if (existing) {
                existing.quantity++;
            } else {
                cart.push({
                    id: id,
                    name: name,
                    price: price,
                    image: img,
                    quantity: 1,
                    itemType: 'market', // Default for homepage items
                    storeName: 'S22 Market' // Default or fetch if available
                });
            }
            localStorage.setItem('s22market_cart', JSON.stringify(cart));

            // 3. Update Badge UI
            const count = cart.reduce((sum, i) => sum + i.quantity, 0);
            ['header-cart-badge', 'nav-cart-badge'].forEach(bid => {
                const el = document.getElementById(bid);
                if (el) { el.textContent = count > 9 ? '9+' : count; el.classList.remove('hidden'); }
            });

            // 4. Toast
            showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© ğŸ›’');
        }

        async function loadDefaultRecentProducts() {
            const productsGrid = document.getElementById('products-grid');

            try {
                // Fetch more to allow for filtering
                const q = query(collection(db, "products"), limit(50));
                const prodSnap = await getDocs(q);

                productsGrid.innerHTML = '';

                if (prodSnap.empty) {
                    productsGrid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>';
                    return;
                }

                let products = prodSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Filter by Wilaya
                if (currentUserProfile && currentUserProfile.wilaya) {
                    const userWilaya = currentUserProfile.wilaya;
                    console.log("Filtering products by Wilaya:", userWilaya);

                    // Get unique seller IDs
                    const sellerIds = [...new Set(products.map(p => p.sellerId).filter(id => id))];

                    if (sellerIds.length > 0) {
                        // Fetch sellers in parallel
                        // Optimization: Check local cache or fetch
                        // We will just fetch individually for simplicity (or chunks if widely supported, but in is limited)
                        // Given limit 50, fetch usually < 20 sellers.

                        const validSellerIds = new Set();
                        await Promise.all(sellerIds.map(async (sid) => {
                            try {
                                const sDoc = await getDoc(doc(db, "users", sid));
                                if (sDoc.exists()) {
                                    const sData = sDoc.data();
                                    // Check coverage
                                    // 1. isNational
                                    const isNat = sData.fulfillment?.isNational || (sData.role === 'vendor' && sData.isNational === true); // Handle legacy/new
                                    if (isNat) {
                                        validSellerIds.add(sid);
                                        return;
                                    }
                                    // 2. coveredWilayas (store or user doc)
                                    const covered = sData.fulfillment?.coveredWilayas || sData.coveredWilayas || [sData.wilaya];
                                    if (covered && covered.includes(userWilaya)) {
                                        validSellerIds.add(sid);
                                        return;
                                    }
                                    // 3. Simple wilaya match
                                    if (sData.wilaya === userWilaya) validSellerIds.add(sid);
                                }
                            } catch (e) { console.log("Err checking seller", sid, e); }
                        }));

                        // Filter products
                        products = products.filter(p => validSellerIds.has(p.sellerId));

                        // Badge or Message
                        if (products.length > 0) {
                            const title = document.getElementById('default-recent-title');
                            if (title) title.innerHTML = `<i class="fas fa-map-marker-alt text-indigo-500"></i> Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ ${userWilaya} ÙˆØ§Ù„ÙƒÙˆØª Ø§Ù„ÙˆØ·Ù†ÙŠ`;
                        } else {
                            productsGrid.innerHTML = `<div class="col-span-full text-center py-10 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…ØªØ§Ø­Ø© ÙÙŠ ${userWilaya} Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
                            return;
                        }
                    }
                }

                products.forEach(p => {
                    if (p.productType !== 'course') {
                        productsGrid.innerHTML += createProductCardHTML(p);
                    }
                });

                productsGrid.classList.remove('hidden');
                document.getElementById('default-recent-title').classList.remove('hidden');
                setupWishlistButtons();

            } catch (e) {
                console.error("ÙØ´Ù„ Ø§Ù„Ø¬Ù„Ø¨:", e);
                productsGrid.innerHTML = `<div class="col-span-full text-center py-4 text-red-500" dir="ltr">Error: ${e.message}</div>`;
                productsGrid.classList.remove('hidden');
            }
        }

        // --- 5. Auth & Wishlist Logic ---

        function setupWishlistButtons() {
            document.querySelectorAll('.wishlist-btn').forEach(btn => {
                const id = btn.dataset.id;
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©
                if (userWishlist.has(id)) {
                    btn.innerHTML = '<i class="fas fa-heart text-red-500"></i>';
                    btn.style.opacity = '1';
                }

                btn.addEventListener('click', async (e) => {
                    e.preventDefault(); e.stopPropagation();
                    if (!currentUser) return showToast('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ”’', false);

                    const icon = btn.querySelector('i');
                    if (userWishlist.has(id)) {
                        userWishlist.delete(id);
                        icon.className = 'far fa-heart text-gray-400';
                        try { await updateDoc(doc(db, "users", currentUser.uid), { wishlist: arrayRemove(id) }); } catch (e) { }
                    } else {
                        userWishlist.add(id);
                        icon.className = 'fas fa-heart text-red-500';
                        icon.classList.add('animate-bounce'); // ØªØ£Ø«ÙŠØ± Ø¨Ø³ÙŠØ·
                        try { await updateDoc(doc(db, "users", currentUser.uid), { wishlist: arrayUnion(id) }); } catch (e) { }
                    }
                });
            });
        }

        function showToast(message, success = true) {
            const container = document.getElementById('toast-container');
            if (!container) return; // Should exist in HTML
            const el = document.createElement('div');
            el.className = `fixed bottom-20 left-1/2 -translate-x-1/2 z-50 bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg text-sm flex items-center gap-2 animate-bounce`;
            el.innerHTML = `<i class="fas ${success ? 'fa-check-circle text-green-400' : 'fa-exclamation-circle text-red-400'}"></i> ${message}`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        // --- Main Auth Observer ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;

                // ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
                const headerUserIcon = document.getElementById('header-user-icon');
                if (headerUserIcon) headerUserIcon.href = 'profile.html';

                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
                const userInfoDiv = document.getElementById('sidebar-user-info');
                userInfoDiv.innerHTML = `
                    <h3 class="font-bold text-lg text-white">${user.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…'}</h3>
                    <div class="flex gap-3 text-xs text-indigo-100 mt-1">
                        <span class="bg-white/20 px-2 py-0.5 rounded">Ø¹Ø¶Ùˆ Ù…Ø³Ø¬Ù„</span>
                        <a href="#" id="sidebar-logout" class="hover:text-white underline">Ø®Ø±ÙˆØ¬</a>
                    </div>`;

                document.getElementById('sidebar-logout').onclick = () => auth.signOut().then(() => window.location.reload());

                // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ù„Ø¯ÙˆØ±ØŒ Ø§Ù„Ù…ÙØ¶Ù„Ø©)
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        currentUserProfile = data; // Save for filtering
                        if (data.wishlist) userWishlist = new Set(data.wishlist);
                        setupWishlistButtons(); // Re-run to update UI icons

                        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø§Ø¨Ø· Ù„ÙˆØ­Ø© Ø§Ù„ØªØ§Ø¬Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨Ø§Ø¦Ø¹Ø§Ù‹
                        if (data.role === 'vendor' || data.role === 'restaurant') {
                            document.getElementById('sidebar-seller-link').classList.remove('hidden');
                            document.getElementById('sidebar-seller-link').classList.add('flex');
                        }
                    }
                } catch (e) { console.error(e); }

                // ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø©
                const cart = JSON.parse(localStorage.getItem('s22market_cart')) || [];
                const count = cart.reduce((sum, i) => sum + i.quantity, 0);
                if (count > 0) {
                    ['header-cart-badge', 'nav-cart-badge'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) { el.textContent = count > 9 ? '9+' : count; el.classList.remove('hidden'); }
                    });
                }

            } else {
                currentUser = null;
                currentUserProfile = null;
                userWishlist.clear();

                // Ø¥Ø¹Ø§Ø¯Ø© Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                const headerUserIcon = document.getElementById('header-user-icon');
                if (headerUserIcon) headerUserIcon.href = 'login.html';
            }
        });

        // PWA Service Worker Registration removed from here, moving to separate script block



        // --- Inlined: SpinWheel ---
        class SpinWheel {
            constructor() {
                this.config = null;
                this.segments = [];
                this.todayStr = new Date().toISOString().split('T')[0];
                this.user = null;
                this.isSpinning = false;

                this.init();
            }

            async init() {
                // 1. Auth Listener
                onAuthStateChanged(auth, (user) => {
                    this.user = user;
                    if (user) {
                        this.loadConfig();
                    } else {
                        this.removeUI();
                    }
                });
            }

            async loadConfig() {
                try {
                    const snap = await getDoc(doc(db, "settings", "daily_rewards"));
                    if (snap.exists()) {
                        this.config = snap.data();
                        if (this.config.isActive && this.checkSchedule()) {
                            // Check if already played today
                            const played = await this.checkIfPlayedToday();
                            if (!played) {
                                this.renderFloatingButton();
                                this.renderModal();
                            }
                        }
                    }
                } catch (e) {
                    console.error("Wheel Init Error:", e);
                }
            }

            checkSchedule() {
                if (!this.config.schedule) return true;

                const now = new Date();
                const currentHour = now.getHours();
                const currentDay = now.getDay(); // 0 = Sunday

                const { startHour, endHour, activeDays } = this.config.schedule;

                if (currentHour < startHour || currentHour >= endHour) return false;
                if (activeDays && !activeDays.includes(currentDay)) return false;

                return true;
            }

            async checkIfPlayedToday() {
                if (!this.user) return true;
                // Check local storage first for speed (optimization)
                const localKey = `s22_spin_${this.user.uid}_${this.todayStr}`;
                if (localStorage.getItem(localKey)) return true;

                // Verify with Firestore
                // We query the 'claims' subcollection for this user
                const q = query(
                    collection(db, "daily_rewards_history", this.todayStr, "claims"),
                    where("userId", "==", this.user.uid)
                );
                const snap = await getDocs(q);
                const played = !snap.empty;

                if (played) localStorage.setItem(localKey, 'true');
                return played;
            }

            renderFloatingButton() {
                if (document.getElementById('spin-fab')) return;

                const btn = document.createElement('div');
                btn.id = 'spin-fab';
                btn.className = 'fixed bottom-24 left-4 z-40 animate-bounce cursor-pointer';
                btn.innerHTML = `
                    <div class="relative group">
                        <div class="absolute -inset-1 bg-gradient-to-r from-pink-600 to-purple-600 rounded-full blur opacity-75 group-hover:opacity-100 transition duration-1000 group-hover:duration-200"></div>
                        <button class="relative w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white text-3xl shadow-2xl border-2 border-white transform transition hover:scale-110">
                            ğŸ¡
                        </button>
                        <div class="absolute -top-10 left-1/2 -translate-x-1/2 w-max bg-gray-900 text-white text-xs py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition">
                            Ø¬Ø±Ø¨ Ø­Ø¸Ùƒ Ø§Ù„ÙŠÙˆÙ…!
                        </div>
                    </div>
                `;
                btn.onclick = () => this.openModal();
                document.body.appendChild(btn);
            }

            renderModal() {
                if (document.getElementById('spin-modal')) return;

                // Inject Styles
                const style = document.createElement('style');
                style.textContent = `
                    .wheel-container { position: relative; width: 300px; height: 300px; margin: 0 auto; }
                    .wheel { width: 100%; height: 100%; border-radius: 50%; border: 8px solid white; box-shadow: 0 0 20px rgba(0,0,0,0.2); transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99); position: relative; overflow: hidden; background: #333; }
                    .wheel-segment { position: absolute; width: 50%; height: 50%; top: 50%; left: 50%; transform-origin: 0% 0%; clip-path: polygon(0 0, 100% 0, 100% 100%); }
                    .wheel-text { position: absolute; left: 120%; top: 20%; transform: rotate(45deg); font-weight: bold; color: white; font-size: 12px; white-space: nowrap; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
                    .wheel-arrow { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 30px; height: 40px; z-index: 10; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3)); }
                    .wheel-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; background: white; border-radius: 50%; z-index: 5; display: flex; align-items: center; justify-content: center; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); }
                `;
                document.head.appendChild(style);

                const modal = document.createElement('div');
                modal.id = 'spin-modal';
                modal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden backdrop-blur-sm';
                modal.innerHTML = `
                    <div class="bg-white rounded-3xl p-6 max-w-sm w-full relative text-center shadow-2xl overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-20 bg-gradient-to-b from-indigo-100 to-white -z-10"></div>
                        
                        <h2 class="text-2xl font-extrabold text-indigo-900 mb-1">Ø¹Ø¬Ù„Ø© Ø§Ù„Ø­Ø¸ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ğŸ¡</h2>
                        <p class="text-xs text-gray-500 mb-6">Ø¬Ø±Ø¨ Ø­Ø¸Ùƒ ÙˆØ¥Ø±Ø¨Ø­ Ø¬ÙˆØ§Ø¦Ø² Ù‚ÙŠÙ…Ø©!</p>

                        <div class="wheel-container mb-6">
                            <img src="https://cdn-icons-png.flaticon.com/512/295/295128.png" class="wheel-arrow">
                            <div class="wheel" id="the-wheel">
                                <!-- Segments Injected Here -->
                            </div>
                            <button id="spin-btn-action" class="wheel-center text-indigo-600 text-xl font-bold bg-white hover:bg-indigo-50 border-4 border-indigo-100 rounded-full w-16 h-16 shadow-inner transition">
                                Ø§Ù„Ø¹Ø¨
                            </button>
                        </div>

                        <div id="spin-status" class="h-6 text-sm font-bold text-indigo-600"></div>

                        <button onclick="document.getElementById('spin-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('spin-btn-action').onclick = () => this.spin();
            }

            openModal() {
                if (!this.checkSchedule()) {
                    alert('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ø¸ ØºÙŠØ± Ù…ØªØ§Ø­Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª.');
                    return;
                }
                this.drawWheel();
                document.getElementById('spin-modal').classList.remove('hidden');
            }

            drawWheel() {
                const wheel = document.getElementById('the-wheel');
                wheel.innerHTML = '';
                this.segments = this.config.segments || [];

                if (this.segments.length === 0) return;

                const sliceAngle = 360 / this.segments.length;
                let gradientStr = 'conic-gradient(';
                let currentDeg = 0;

                this.segments.forEach((seg, i) => {
                    const endDeg = currentDeg + sliceAngle;
                    gradientStr += `${seg.color} ${currentDeg}deg ${endDeg}deg${i === this.segments.length - 1 ? '' : ','}`;

                    const label = document.createElement('div');
                    const midAngle = currentDeg + (sliceAngle / 2);
                    label.style.cssText = `
                        position: absolute;
                        top: 50%; left: 50%;
                        width: 50%; height: 20px;
                        transform-origin: 0% 50%;
                        transform: rotate(${midAngle - 90}deg) translate(20px);
                        text-align: right;
                        color: white;
                        font-size: 10px;
                        font-weight: bold;
                        pointer-events: none;
                        padding-right: 15px;
                        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
                    `;
                    label.innerHTML = `<span style="display:inline-block; transform: rotate(90deg)">${seg.label}</span>`;
                    currentDeg = endDeg;
                });
                gradientStr += ')';
                wheel.style.background = gradientStr;
            }

            async spin() {
                if (this.isSpinning) return;
                this.isSpinning = true;
                const btn = document.getElementById('spin-btn-action');
                const status = document.getElementById('spin-status');
                btn.disabled = true;
                status.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø³Ø­Ø¨...';

                try {
                    const resultDoc = await runTransaction(db, async (transaction) => {
                        const statsRef = doc(db, "daily_rewards_history", this.todayStr);
                        const statsDoc = await transaction.get(statsRef);

                        let currentCounts = {};
                        let totalSpins = 0;

                        if (statsDoc.exists()) {
                            const d = statsDoc.data();
                            currentCounts = d.segmentCounts || {};
                            totalSpins = d.totalSpins || 0;
                        }

                        const availableSegments = this.segments.filter(seg => {
                            const count = currentCounts[seg.id] || 0;
                            const limit = seg.limit || 0;
                            if (limit > 0 && count >= limit) return false;
                            return true;
                        });

                        let winningSegment;

                        if (availableSegments.length === 0) {
                            winningSegment = this.segments.find(s => s.type === 'hardluck') || this.segments[0];
                        } else {
                            const totalWeight = availableSegments.reduce((sum, s) => sum + (s.probability || 0), 0);
                            let random = Math.random() * totalWeight;

                            for (const seg of availableSegments) {
                                random -= (seg.probability || 0);
                                if (random <= 0) {
                                    winningSegment = seg;
                                    break;
                                }
                            }
                            if (!winningSegment) winningSegment = availableSegments[availableSegments.length - 1]; // Fallback
                        }

                        const newCount = (currentCounts[winningSegment.id] || 0) + 1;
                        transaction.set(statsRef, {
                            totalSpins: totalSpins + 1,
                            segmentCounts: { ...currentCounts, [winningSegment.id]: newCount },
                            lastUpdated: serverTimestamp()
                        }, { merge: true });

                        const claimRef = doc(collection(db, "daily_rewards_history", this.todayStr, "claims"));
                        transaction.set(claimRef, {
                            userId: this.user.uid,
                            userName: this.user.displayName || 'Anonymous',
                            segmentId: winningSegment.id,
                            rewardValue: winningSegment.value,
                            type: winningSegment.type,
                            timestamp: serverTimestamp()
                        });

                        if (winningSegment.type === 'points' && winningSegment.value > 0) {
                            const userRef = doc(db, "users", this.user.uid);
                            transaction.update(userRef, {
                                points: increment(winningSegment.value)
                            });
                        }

                        return winningSegment;
                    });

                    const segmentIndex = this.segments.findIndex(s => s.id === resultDoc.id);
                    const segmentAngle = 360 / this.segments.length;
                    const targetRotation = 3600 + (360 - (segmentIndex * segmentAngle)) - (segmentAngle / 2);

                    const wheel = document.getElementById('the-wheel');
                    wheel.style.transform = `rotate(${targetRotation}deg)`;

                    setTimeout(() => {
                        this.showResult(resultDoc);
                        localStorage.setItem(`s22_spin_${this.user.uid}_${this.todayStr}`, 'true');
                    }, 4100);

                } catch (e) {
                    console.error(e);
                    status.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
                    this.isSpinning = false;
                    btn.disabled = false;
                }
            }

            showResult(segment) {
                const modal = document.getElementById('spin-modal');
                const isWin = segment.type !== 'hardluck';

                const content = modal.querySelector('.bg-white');
                content.innerHTML = `
                    <div class="py-10 animate-pulse">
                        <div class="text-6xl mb-4">${isWin ? 'ğŸ‰' : 'ğŸ¥º'}</div>
                        <h2 class="text-3xl font-extrabold ${isWin ? 'text-green-600' : 'text-gray-600'} mb-2">
                            ${isWin ? 'Ø£Ù„Ù Ù…Ø¨Ø±ÙˆÙƒ!' : 'Ø­Ø¸ Ø£ÙˆÙØ±!'}
                        </h2>
                        <p class="text-gray-800 text-lg font-bold mb-6">
                            ${segment.label}
                        </p>
                        <button onclick="location.reload()" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-indigo-700 transition">
                            Ø­Ø³Ù†Ø§Ù‹
                        </button>
                    </div>
                `;
                document.getElementById('spin-fab')?.remove();
            }

            removeUI() {
                document.getElementById('spin-fab')?.remove();
                document.getElementById('spin-modal')?.remove();
            }
        }

        // Init SpinWheel
        new SpinWheel();
        // --- End Inlined SpinWheel ---

        // Start
        initHome();

    </script>
    <script>
        // Unregister Service Worker to ensure fresh content
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function (registrations) {
                for (let registration of registrations) {
                    registration.unregister();
                    console.log('Service Worker Unregistered');
                }
            });
        }
    </script>

</body>

</html>