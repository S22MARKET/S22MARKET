<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - إدارة البائعين</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="app-style.css">
    <script src="theme-manager.js"></script>
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f0f2f5;
        }

        .hidden {
            display: none;
        }

        .dashboard-tab:hover {
            background-color: #4338ca;
        }

        .dashboard-tab.active-tab {
            background-color: #4f46e5;
            color: white;
            font-weight: bold;
        }

        .dashboard-panel {
            animation: fadeIn 0.5s;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 700px;
            z-index: 50;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Skeleton & Animation */
        .skeleton {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .fade-in-up {
            opacity: 0;
            animation: fadeInUp 0.4s ease-out forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .responsive-table thead {
                display: none;
            }

            .responsive-table tr {
                display: block;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 1rem;
                margin-bottom: 1rem;
                background-color: white;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            }

            .responsive-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 0;
                border-bottom: 1px solid #f3f4f6;
            }

            .responsive-table td:last-child {
                border-bottom: none;
            }

            .responsive-table td::before {
                content: attr(data-label);
                font-weight: 600;
                margin-left: 0.5rem;
                color: #4b5563;
            }

            .responsive-table .actions-cell {
                justify-content: flex-end;
                gap: 1rem;
            }

            .responsive-table .actions-cell::before {
                content: "";
                flex-grow: 1;
            }
        }
    </style>
</head>

<body>

    <div id="login-page" class="hidden min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-xl space-y-6">
            <h2 class="text-3xl font-extrabold text-center text-gray-900">يرجى تسجيل الدخول</h2>
            <p class="text-center text-red-500">تم تسجيل خروجك. يرجى العودة إلى <a href="dashboard.html"
                    class="font-bold underline">صفحة الدخول الرئيسية</a>.</p>
        </div>
    </div>

    <div id="dashboard-page" class="hidden">
        <div class="relative min-h-screen md:flex">

            <aside id="sidebar"
                class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 right-0 transform translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30">
                <div class="p-3 text-center border-b border-gray-700">
                    <h2 class="text-2xl font-bold">S22 Market</h2>
                    <p id="admin-welcome-name" class="text-sm text-indigo-300"></p>
                </div>
                <nav class="flex-1 p-2 space-y-2">
                    <a href="dashboard.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-chart-line fa-fw mr-3"></i> لوحة التحكم</a>
                    <a href="admin-subscriptions.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-crown fa-fw mr-3 text-yellow-500"></i> إدارة الاشتراكات</a>
                    <a href="admin-sellers.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-users-cog fa-fw mr-3"></i> إدارة البائعين</a>
                    <a href="admin-reports.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-flag fa-fw mr-3 text-red-400"></i> الإبلاغات</a>
                    <a href="admin-products.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-boxes fa-fw mr-3"></i> المنتجات</a>
                    <a href="admin-offers.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-star fa-fw mr-3"></i> العروض</a>
                    <a href="admin-product-requests.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-user-plus fa-fw mr-3"></i> طلبات الزوار</a>
                    <a href="admin-categories.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-sitemap fa-fw mr-3"></i> الأقسام</a>
                    <a href="admin-orders.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-clipboard-list fa-fw mr-3"></i> الطلبات</a>
                    <a href="admin-coupons.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-tags fa-fw mr-3"></i> الكوبونات</a>
                    <a href="admin-inquiries.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-envelope-open-text fa-fw mr-3"></i> الرسائل الواردة</a>
                    <a href="admin-applications.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fab fa-google-play fa-fw mr-3"></i> التطبيقات</a>
                    <a href="admin-notepad.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-book fa-fw mr-3"></i> المفكرة</a>



                    <a href="admin-settings.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-cogs fa-fw mr-3"></i> إعدادات المتجر</a>

                    <hr class="border-gray-700 my-2">
                    <h6 class="px-4 text-xs font-semibold text-gray-400 uppercase">الأكاديمية</h6>
                    <a href="dawarat_admin_manager.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"
                        target="_blank">
                        <i class="fas fa-graduation-cap fa-fw mr-3 text-gray-400"></i>
                        <span>إدارة البذلورات</span>
                        <i class="fas fa-external-link-alt fa-xs ml-auto"></i>
                    </a>

                </nav>
                <div class="p-4 border-t border-gray-700">
                    <button id="logout-btn"
                        class="w-full bg-red-600 py-2 rounded-md hover:bg-red-700 transition-colors"><i
                            class="fas fa-sign-out-alt mr-2"></i> تسجيل الخروج</button>
                    <div id="sidebar-theme-container"></div>
                </div>
            </aside>
            <main class="flex-1 p-4 md:p-8 overflow-y-auto">
                <div id="sellers-panel" class="dashboard-panel">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">إدارة البائعين (التجار والزبائن)</h1>
                    <div class="overflow-x-auto bg-white rounded-xl shadow-md">
                        <div id="sellers-loader" class="text-center py-20">
                            <div class="loader mx-auto"></div>
                            <p class="mt-4 text-gray-600">جاري تحميل بيانات البائعين والمنتجات...</p>
                        </div>
                        <table class="w-full text-right responsive-table hidden" id="sellers-table">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-4">البائع</th>
                                    <th class="p-4">اسم المتجر</th>
                                    <th class="p-4">عدد المنتجات</th>
                                    <th class="p-4">هل باع؟</th>
                                    <th class="p-4">الحد الأقصى للمنتجات</th>
                                    <th class="p-4">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="sellers-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="modal-container"></div>

    <script type="module">
        import { auth, db } from './app-core.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { collection, doc, deleteDoc, onSnapshot, query, where, orderBy, getDocs, updateDoc, Timestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- INLINED AUTH (Self-Contained) ---
        async function requireAuth(authInstance) {
            return new Promise((resolve) => {
                const unsubscribe = onAuthStateChanged(authInstance, (user) => {
                    if (!user) {
                        try { window.location.href = 'admin-login.html'; } catch (e) { console.error(e); }
                        resolve(null);
                    } else {
                        resolve(user);
                    }
                    unsubscribe();
                });
            });
        }

        // Keep for reference
        const ADMIN_EMAILS = [
            's22market@gmail.com',
            'yacinee474474@gmail.com',
            'nourmt01@gmail.com'
        ];

        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const logoutBtn = document.getElementById('logout-btn');
        const getEl = (id) => document.getElementById(id);

        requireAuth(auth).then(async (user) => {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            const isAdminEmail = ADMIN_EMAILS.includes(user.email);
            const isAdminRole = userDoc.exists() && userDoc.data().role === 'admin';

            if (isAdminRole || isAdminEmail) {
                if (loginPage) loginPage.classList.add('hidden');
                if (dashboardPage) dashboardPage.classList.remove('hidden');
                if (getEl('admin-welcome-name')) getEl('admin-welcome-name').textContent = `مرحباً، ${user.displayName || user.email.split('@')[0]}`;
                initializeDashboard();
                ThemeManager.renderSidebarControl('sidebar-theme-container');
            } else {
                window.location.href = 'index.html';
            }
        });

        logoutBtn.addEventListener('click', async () => { await signOut(auth); });

        function setActiveTab() {
            const currentPage = window.location.pathname.split('/').pop();
            const tabs = document.querySelectorAll('.dashboard-tab');
            tabs.forEach(tab => {
                const tabHref = tab.getAttribute('href').split('/').pop();
                if (tabHref === currentPage) {
                    tab.classList.add('active-tab');
                } else {
                    tab.classList.remove('active-tab');
                }
            });
        }

        // (الدالة الرئيسية لهذه الصفحة)
        async function initializeDashboard() {
            setActiveTab();
            loadSellers();
        }

        // --- (الكود الخاص بإدارة البائعين) ---

        // State Management
        let state = {
            pendingRequests: [],
            closureRequests: [],
            activeSellers: []
        };

        // Unsubscribe functions
        let unsubPending = null;
        let unsubClosure = null;
        let unsubSellers = null;

        async function loadSellers() {
            const sellersTable = getEl('sellers-table');
            const tbody = getEl('sellers-table-body');
            const oldLoader = getEl('sellers-loader');
            if (oldLoader) oldLoader.classList.add('hidden');
            sellersTable.classList.remove('hidden');

            // Unsubscribe from previous listeners if any
            if (unsubPending) unsubPending();
            if (unsubClosure) unsubClosure();
            if (unsubSellers) unsubSellers();

            // 1. Pending Store Requests
            const qPending = query(collection(db, "users"), where("storeRequest.status", "==", "pending"));
            unsubPending = onSnapshot(qPending, (snapshot) => {
                state.pendingRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }, (error) => console.error("Error fetching pending requests:", error));

            // 2. Closure Requests
            const qClosure = query(collection(db, "users"), where("storeRequest.closureStatus", "==", "pending"));
            unsubClosure = onSnapshot(qClosure, (snapshot) => {
                state.closureRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }, (error) => console.error("Error fetching closure requests:", error));

            // 3. Active Sellers
            const qActive = query(collection(db, "users"), where("role", "in", ["vendor", "restaurant"]));
            unsubSellers = onSnapshot(qActive, (snapshot) => {
                state.activeSellers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }, (error) => console.error("Error fetching active sellers:", error));
        }

        function renderAll() {
            const tableBody = getEl('sellers-table-body');
            tableBody.innerHTML = '';

            const { pendingRequests, closureRequests, activeSellers } = state;

            // Prioritize Closure Requests
            closureRequests.forEach(user => {
                const row = tableBody.insertRow();
                row.className = 'bg-red-50 border-b border-red-200';
                row.innerHTML = `
                <td class="p-4 border-l border-red-200">
                    <span class="bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded">طلب إغلاق</span>
                    <div class="font-bold mt-1">${user.displayName}</div>
                    <div class="text-xs text-gray-500">${user.storeName}</div>
                </td>
                <td colspan="4" class="p-4 text-gray-700">
                    يرغب هذا البائع في إغلاق متجره نهائياً.
                    <br><span class="text-xs text-gray-500">تاريخ الطلب: ${user.storeRequest.closureRequestedAt?.toDate().toLocaleDateString('ar-EG') || '---'}</span>
                </td>
                <td class="p-4 text-left">
                    <button onclick="approveClosure('${user.id}')" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 text-sm ml-2">تأكيد الإغلاق</button>
                    <button onclick="rejectClosure('${user.id}')" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm">إلغاء</button>
                </td>
                `;
            });

            // Store Requests
            pendingRequests.forEach(user => {
                const req = user.storeRequest;

                // Social Links
                const linksHtml = `
                    ${req.facebook ? `<a href="${req.facebook}" target="_blank" class="text-blue-600 hover:text-blue-800 ml-2" title="فيسبوك"><i class="fab fa-facebook fa-lg"></i></a>` : ''}
                    ${req.instagram ? `<a href="${req.instagram}" target="_blank" class="text-pink-600 hover:text-pink-800 ml-2" title="انستغرام"><i class="fab fa-instagram fa-lg"></i></a>` : ''}
                    ${req.phone ? `<a href="tel:${req.phone}" class="text-green-600 hover:text-green-800 ml-2" title="اتصال"><i class="fas fa-phone fa-lg"></i></a>` : ''}
                `;

                const row = tableBody.insertRow();
                row.className = 'bg-yellow-50 border-b border-yellow-200 hover:bg-yellow-100 transition';
                row.innerHTML = `
                <td class="p-4 border-l border-yellow-200 align-top">
                    <span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-1 rounded">طلب جديد</span>
                    <div class="font-bold mt-2 text-gray-800"><i class="fas fa-user-circle ml-1 text-gray-400"></i> ${req.applicantName || user.displayName}</div>
                    <div class="text-xs text-gray-500 mt-1 mr-5">حساب: ${user.displayName}</div>
                    <div class="text-xs text-gray-500 mr-5">${user.email}</div>
                    <div class="mt-2 text-sm font-bold text-gray-700"><i class="fas fa-map-marker-alt ml-1 text-red-400"></i> ${req.region || 'غير محدد'}</div>
                </td>
                <td class="p-4 align-top">
                    <div class="font-bold text-lg text-indigo-700 mb-1">${req.storeName}</div>
                    <div class="flex flex-wrap gap-2 text-xs mb-2">
                        <span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full border border-indigo-200">
                            ${req.storeType === 'restaurant' ? '<i class="fas fa-utensils"></i> مطعم' : '<i class="fas fa-store"></i> متجر'}
                        </span>
                        <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded-full border border-purple-200">
                            ${req.specialty || 'عام'}
                        </span>
                    </div>
                </td>
                <td class="p-4 align-top">
                    <div class="text-sm text-gray-700 bg-white p-2 rounded border border-yellow-200 mb-2">
                        <span class="font-bold block text-xs text-gray-400 mb-1">الوصف:</span>
                        ${req.description || 'لا يوجد وصف'}
                    </div>
                    ${req.additionalInfo ? `
                    <div class="text-sm text-gray-700 bg-white p-2 rounded border border-yellow-200 mb-2">
                        <span class="font-bold block text-xs text-gray-400 mb-1">معلومات إضافية:</span>
                        ${req.additionalInfo}
                    </div>` : ''}
                    <div class="flex items-center mt-2">${linksHtml}</div>
                </td>
                <td class="p-4 text-center">---</td>
                <td class="p-4 text-center">---</td>
                <td class="p-4 text-left align-middle">
                    <div class="flex flex-col gap-2">
                        <button onclick="approveSeller('${user.id}', '${req.storeType}', '${req.storeName}')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 font-bold shadow-sm transition transform hover:scale-105">
                            <i class="fas fa-check ml-1"></i> قبول
                        </button>
                        <button onclick="rejectSeller('${user.id}')" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg hover:bg-red-200 font-bold shadow-sm transition border border-red-200">
                            <i class="fas fa-times ml-1"></i> رفض
                        </button>
                    </div>
                </td>
            `;
            });

            // Active Sellers
            // Avoid duplicating users who are in closure requests list
            const displayedClosureIds = new Set(closureRequests.map(u => u.id));

            activeSellers.forEach(user => {
                if (displayedClosureIds.has(user.id)) return; // Already shown in closure section

                const row = tableBody.insertRow();
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                <td class="p-4">
                    <div class="font-bold">${user.displayName}</div>
                    <div class="text-xs text-gray-500">${user.email}</div>
                </td>
                <td class="p-4">
                    ${user.storeName || '---'}
                    <span class="block text-xs text-gray-400">${user.role === 'restaurant' ? 'مطعم' : 'متجر'}</span>
                </td>
                <td class="p-4 text-center">---</td>
                <td class="p-4 text-center">---</td>
                <td data-label="الحد الأقصى" class="p-4">
                    <input type="number" 
                           class="product-limit-input w-24 p-2 border rounded text-center" 
                           value="${user.productLimit ?? 10}" 
                           data-id="${user.id}"
                           onchange="updateUserLimit(this)">
                </td>
                <td class="p-4 actions-cell space-x-2 space-x-reverse">
                    <button class="${user.isSuspended ? 'text-green-600 hover:text-green-800' : 'text-yellow-600 hover:text-yellow-800'}" 
                            onclick="toggleSuspension('${user.id}', ${user.isSuspended || false})" 
                            title="${user.isSuspended ? 'تنشيط المتجر' : 'تجميد المتجر (إغلاق مؤقت)'}">
                        <i class="fas ${user.isSuspended ? 'fa-play' : 'fa-pause'}"></i>
                    </button>
                    <a href="store-orders-screen.html?uid=${user.id}" target="_blank" class="text-orange-500 hover:text-orange-700" title="شاشة المطبخ">
                        <i class="fas fa-utensils"></i>
                    </a>
                    <button class="text-red-600 hover:text-red-800" onclick="deleteUser('${user.id}')" title="حذف نهائي">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="text-blue-600 hover:text-blue-800" onclick="openSubscriptionModal('${user.id}', '${user.displayName}')" title="إدارة الاشتراك">
                        <i class="fas fa-calendar-check lg:text-lg"></i>
                    </button>
                </td>
             `;
            });

            if (pendingRequests.length === 0 && closureRequests.length === 0 && activeSellers.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">لا يوجد بيانات لعرضها</td></tr>`;
            }
        }

        // --- Suspension Action ---
        window.toggleSuspension = async (uid, currentStatus) => {
            const action = currentStatus ? 'تنشيط' : 'تجميد';
            if (!confirm(`هل أنت متأكد من ${action} هذا المتجر؟\n${!currentStatus ? 'سيتم منع البائع من الدخول للوحة التحكم.' : 'سيتمكن البائع من الدخول مجدداً.'}`)) return;

            try {
                await updateDoc(doc(db, "users", uid), { isSuspended: !currentStatus });
                // alert(`تم ${action} المتجر بنجاح.`); // No need for alert, UI updates automatically
            } catch (e) {
                console.error(e);
                alert("حدث خطأ أثناء التحديث.");
            }
        };

        // --- Closure Actions ---
        window.approveClosure = async (uid) => {
            if (confirm('هل أنت متأكد من إغلاق هذا المتجر؟ سيتم تحويل المستخدم إلى مستخدم عادي.')) {
                try {
                    await updateDoc(doc(db, "users", uid), {
                        role: "user",
                        storeName: null,
                        storeRequest: null,
                        isOpen: false
                    });
                    alert("تم إغلاق المتجر بنجاح.");
                } catch (e) { console.error(e); alert("حدث خطأ."); }
            }
        };

        window.rejectClosure = async (uid) => {
            try {
                await updateDoc(doc(db, "users", uid), {
                    "storeRequest.closureStatus": "rejected"
                });
                alert("تم إلغاء طلب الإغلاق.");
            } catch (e) { console.error(e); alert("حدث خطأ."); }
        };

        // --- Actions ---
        window.approveSeller = async (uid, type, storeName) => {
            if (!confirm('هل أنت متأكد من قبول هذا البائع؟')) return;
            try {
                await updateDoc(doc(db, "users", uid), {
                    role: type,
                    storeName: storeName,
                    'storeRequest.status': 'approved',
                    approvedAt: Timestamp.now()
                });
                alert('تم قبول البائع بنجاح!');
            } catch (e) { console.error(e); alert('خطأ: ' + e.message); }
        };

        window.rejectSeller = async (uid) => {
            // New logic: Ask for reason
            const reason = prompt("الرجاء إدخال سبب الرفض (سيظهر للمستخدم):");
            if (reason === null) return; // Cancelled

            const reasonText = reason.trim() || "لم يتم ذكر سبب محدد.";

            try {
                await updateDoc(doc(db, "users", uid), {
                    'storeRequest.status': 'rejected',
                    'storeRequest.rejectionReason': reasonText,
                    'storeRequest.rejectedAt': Timestamp.now()
                });
                alert('تم رفض الطلب.');
            } catch (e) { console.error(e); alert("خطأ: " + e.message); }
        };

        window.updateUserLimit = async (input) => {
            const uid = input.dataset.id;
            try {
                await updateDoc(doc(db, 'users', uid), { productLimit: parseInt(input.value) });
                input.classList.add('border-green-500');
                setTimeout(() => input.classList.remove('border-green-500'), 1000);
            } catch (e) {
                console.error(e); input.classList.add('border-red-500');
            }
        };

        window.deleteUser = async (uid) => {
            const confirmMsg = "هل أنت متأكد تماماً من حذف هذا المستخدم؟\n\nتحذير: هذا الإجراء سيقوم بحذف:\n- جميع المنتجات\n- جميع الطلبات\n- الأقسام والكوبونات\n- مناطق التوصيل والعمال\n- وكل البيانات المرتبطة بهذا المتجر.\n\nلا يمكن التراجع عن هذا الإجراء!";
            if (!confirm(confirmMsg)) return;

            const row = document.querySelector(`button[onclick="deleteUser('${uid}')"]`).closest('tr');
            if (row) row.style.opacity = '0.5';

            try {
                // Show global loading if possible or just use alert at the end
                // Helper to delete collection by sellerId
                const deleteBySellerId = async (collectionName) => {
                    const q = query(collection(db, collectionName), where("sellerId", "==", uid));
                    const snapshot = await getDocs(q);
                    const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deletePromises);
                    console.log(`Deleted ${snapshot.size} docs from ${collectionName}`);
                };

                // 1. Delete all related collections
                const collections = [
                    "products",
                    "orders",
                    "categories",
                    "coupons",
                    "offers",
                    "delivery_zones",
                    "delivery_personnel",
                    "loyalty_approvals"
                ];

                for (const col of collections) {
                    await deleteBySellerId(col);
                }

                // 2. Delete User Document (and ideally subcollections if we could list them, 
                // but we rely on client-side known paths if strictly needed. 
                // For now, deleting parent allows cleanup).
            } catch (e) {
                console.error("Cascade Delete Error:", e);
                alert("حدث خطأ أثناء الحذف: " + e.message);
                if (row) row.style.opacity = '1';
            }
        };

        // --- Subscription Management ---
        window.openSubscriptionModal = async (uid, name) => {
            // Get current subscription status
            let userDoc;
            try {
                userDoc = await getDoc(doc(db, "users", uid));
            } catch (e) { console.error(e); alert("خطأ في جلب البيانات"); return; }

            const userData = userDoc.data();
            const sub = userData.subscription || {};
            const endDate = sub.endDate ? sub.endDate.toDate() : null;
            const now = new Date();
            const isValid = endDate && endDate > now;

            const formatDate = (date) => {
                if (!date) return '---';
                return date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
            };

            const content = `
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 text-center">
                        <p class="text-sm text-gray-500">حالة الاشتراك الحالية للمتجر:</p>
                        <h4 class="font-bold text-lg ${isValid ? 'text-green-600' : 'text-red-600'}">
                            ${isValid ? 'نشط' : 'منتهي / غير مشترك'}
                        </h4>
                        <p class="text-xs text-gray-600 mt-1">ينتهي في: <span class="font-bold font-mono dir-ltr">${formatDate(endDate)}</span></p>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">تمديد / تعيين الاشتراك</label>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <button onclick="setSubDuration('${uid}', 30)" class="bg-indigo-50 text-indigo-700 py-2 rounded border border-indigo-200 hover:bg-indigo-100 font-bold text-sm">شهر (30 يوم)</button>
                            <button onclick="setSubDuration('${uid}', 90)" class="bg-indigo-50 text-indigo-700 py-2 rounded border border-indigo-200 hover:bg-indigo-100 font-bold text-sm">3 أشهر</button>
                            <button onclick="setSubDuration('${uid}', 180)" class="bg-indigo-50 text-indigo-700 py-2 rounded border border-indigo-200 hover:bg-indigo-100 font-bold text-sm">6 أشهر</button>
                            <button onclick="setSubDuration('${uid}', 365)" class="bg-indigo-50 text-indigo-700 py-2 rounded border border-indigo-200 hover:bg-indigo-100 font-bold text-sm">سنة (365 يوم)</button>
                        </div>
                        
                        <div class="relative flex py-2 items-center">
                            <div class="flex-grow border-t border-gray-300"></div>
                            <span class="flex-shrink-0 mx-4 text-gray-400 text-xs">أو تحديد تاريخ مخصص</span>
                            <div class="flex-grow border-t border-gray-300"></div>
                        </div>

                        <div class="flex gap-2">
                            <input type="date" id="custom-sub-date" class="flex-1 p-2 border rounded text-sm">
                            <button onclick="setSubCustomDate('${uid}')" class="bg-gray-800 text-white px-4 rounded text-sm hover:bg-gray-900">حفظ</button>
                        </div>
                    </div>

                    <div class="pt-4 border-t mt-2">
                        <button onclick="cancelSubscription('${uid}')" class="w-full text-red-600 border border-red-200 bg-red-50 p-2 rounded hover:bg-red-100 text-sm font-bold">
                            <i class="fas fa-ban ml-1"></i> إلغاء / إيقاف الاشتراك
                        </button>
                    </div>
                </div>
            `;

            showModal(`إدارة اشتراك: ${name}`, content, null, '', false); // No default confirm button, custom actions
        };

        window.setSubDuration = async (uid, days) => {
            const date = new Date();
            date.setDate(date.getDate() + days); // Add days to NOW. Alternatively, add to existing endDate if we want to extend. For now, reset/set from now is safer/simpler logic.
            // Requirement: "عداد اشتراك" - usually implies extending or setting a period. Let's assume setting from NOW for simplicity unless requested otherwise.
            // actually better: if active, add to existing? No, start simple: Set new expiry.

            await updateSubscription(uid, date);
        };

        window.setSubCustomDate = async (uid) => {
            const dateInput = document.getElementById('custom-sub-date').value;
            if (!dateInput) return alert('يرجى اختيار تاريخ');
            const date = new Date(dateInput);
            await updateSubscription(uid, date);
        };

        window.cancelSubscription = async (uid) => {
            if (!confirm('هل أنت متأكد من تعطيل اشتراك هذا المتجر؟')) return;
            // Set to yesterday
            const date = new Date();
            date.setDate(date.getDate() - 1);
            await updateSubscription(uid, date, false);
        };

        async function updateSubscription(uid, endDate, isActive = true) {
            showLoadingModal('جاري تحديث الاشتراك...');
            try {
                await updateDoc(doc(db, "users", uid), {
                    subscription: {
                        endDate: Timestamp.fromDate(endDate),
                        updatedAt: Timestamp.now(),
                        isActive: isActive
                    }
                });
                closeModal();
                alert('تم حدثت البيانات بنجاح!');
                // The onSnapshot will update the list/UI if we display subscription info there, 
                // but currently we don't display it in the table. That's fine.
            } catch (e) {
                console.error(e);
                closeModal();
                alert('حدث خطأ: ' + e.message);
            }
        }


        // --- (دوال المساعدة العامة) ---
        function showModal(title, content, onConfirm, confirmText = 'حفظ', showCancel = true) {
            const modalContainer = getEl('modal-container');
            const confirmBtnHTML = `<button id="modal-confirm" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-indigo-700">${confirmText}</button>`;
            const cancelBtnHTML = showCancel ? `<button id="modal-cancel" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg font-semibold hover:bg-gray-300">إلغاء</button>` : '';
            modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop">
                <div class="modal-content !max-w-lg">
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h3 class="text-xl font-bold">${title}</h3>
                        <button id="modal-close-btn" class="text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
                    </div>
                    <div id="modal-body">${content}</div>
                    <div class="flex justify-end gap-4 mt-6 border-t pt-4">
                        ${cancelBtnHTML}
                        ${onConfirm ? confirmBtnHTML : ''}
                    </div>
                </div>
            </div>`;
            if (showCancel) getEl('modal-cancel').onclick = closeModal;
            getEl('modal-close-btn').onclick = closeModal;
            getEl('modal-backdrop').onclick = (e) => { if (e.target.id === 'modal-backdrop') closeModal(); };
            if (onConfirm) getEl('modal-confirm').onclick = onConfirm;
        }
        function showLoadingModal(text = 'جاري التحميل...') {
            getEl('modal-container').innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop-loader">
                <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm w-full">
                    <div class="loader mx-auto"></div>
                    <p class="mt-4 text-lg font-semibold text-gray-700">${text}</p>
                </div>
            </div>`;
        }
        function showDeleteConfirmationModal(onConfirm, confirmText = 'نعم، قم بالحذف') {
            showModal('تأكيد الحذف',
                '<p class="text-lg">هل أنت متأكد من رغبتك في هذا الإجراء؟ لا يمكن التراجع عنه.</p>',
                onConfirm,
                confirmText);
            getEl('modal-confirm').classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            getEl('modal-confirm').classList.add('bg-red-600', 'hover:bg-red-700');
        }
        function closeModal() {
            getEl('modal-container').innerHTML = '';
        }

    </script>
</body>

</html>