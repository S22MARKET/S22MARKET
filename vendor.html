<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S22 Market - Ù…ØªØ¬Ø±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
            padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
        }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØºÙ„Ø§Ù */
        .vendor-header {
            position: relative;
            height: 250px;
            overflow: hidden;
        }

        .vendor-cover {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: brightness(0.8);
            transition: transform 0.5s;
        }

        .vendor-info-card {
            margin-top: -60px;
            position: relative;
            z-index: 10;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05);
        }

        .vendor-logo {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 4px solid white;
            object-fit: cover;
            position: absolute;
            top: -45px;
            right: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            background: white;
        }

        /* ÙƒØ§Ø±Øª Ø§Ù„Ù…Ù†ØªØ¬ */
        .product-card {
            background: white;
            border-radius: 16px;
            padding: 12px;
            display: flex;
            gap: 12px;
            border: 1px solid #f1f5f9;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
            transition: all 0.2s;
        }

        .product-card:active {
            transform: scale(0.98);
            background-color: #f8fafc;
        }

        .prod-img {
            width: 90px;
            height: 90px;
            border-radius: 12px;
            object-fit: cover;
            flex-shrink: 0;
        }

        /* Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… Ù„Ù„Ø³Ù„Ø© */
        #floating-cart {
            position: fixed;
            bottom: 20px;
            left: 16px;
            right: 16px;
            background: #1f2937;
            color: white;
            padding: 16px;
            border-radius: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 25px rgba(31, 41, 55, 0.3);
            z-index: 50;
            transform: translateY(150%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #floating-cart.visible {
            transform: translateY(0);
        }

        /* Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Sticky */
        .sticky-tabs {
            position: sticky;
            top: 0;
            background: white;
            z-index: 20;
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
            white-space: nowrap;
            overflow-x: auto;
        }

        .tab-btn {
            display: inline-block;
            padding: 8px 16px;
            margin: 0 4px;
            border-radius: 20px;
            background: #f1f5f9;
            color: #64748b;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #1f2937;
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Loader */
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body>

    <a href="index.html"
        class="fixed top-4 left-4 z-30 w-10 h-10 bg-white/80 backdrop-blur rounded-full flex items-center justify-center text-gray-800 shadow-lg hover:bg-white">
        <i class="fas fa-arrow-left"></i>
    </a>

    <div id="page-loader" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
        <p class="mt-4 text-gray-500 font-bold">Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ØªØ¬Ø±...</p>
    </div>

    <main id="main-content" class="hidden">

        <div class="vendor-header">
            <img id="vendor-cover" src="" class="vendor-cover" alt="Cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
        </div>

        <div class="vendor-info-card">
            <img id="vendor-logo" src="" class="vendor-logo" alt="Logo">

            <div class="pt-8">
                <div class="flex justify-between items-start">
                    <div>
                        <h1 id="vendor-name" class="text-2xl font-black text-gray-900"></h1>
                        <div class="flex items-center gap-2 mt-1 text-sm text-gray-500">
                            <span id="vendor-category">Ù…ØªØ¬Ø± Ø¹Ø§Ù…</span> â€¢
                            <span class="text-green-600 font-bold bg-green-50 px-2 py-0.5 rounded text-xs"><i
                                    class="fas fa-motorcycle"></i> ØªÙˆØµÙŠÙ„ Ø³Ø±ÙŠØ¹</span>
                        </div>
                    </div>
                    <div class="text-left flex flex-col items-end gap-2">
                        <div class="flex items-center gap-1 bg-yellow-50 px-2 py-1 rounded-lg border border-yellow-100">
                            <i class="fas fa-star text-yellow-500 text-xs"></i>
                            <span class="font-bold text-sm text-yellow-700">4.8</span>
                        </div>
                        <button id="like-btn" onclick="toggleLike()"
                            class="flex items-center gap-1 bg-gray-50 px-3 py-1.5 rounded-full border border-gray-200 transition-all active:scale-95">
                            <i id="like-icon" class="far fa-heart text-red-500"></i>
                            <span id="likes-count" class="text-xs font-bold text-gray-600">0</span>
                        </button>
                    </div>
                </div>

                <p id="vendor-desc" class="mt-4 text-gray-600 text-sm leading-relaxed line-clamp-2"></p>

                <div class="grid grid-cols-2 gap-3 mt-6">
                    <a id="btn-whatsapp" href="#" target="_blank"
                        class="bg-green-50 text-green-700 py-2.5 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-green-100 transition">
                        <i class="fab fa-whatsapp text-xl"></i> ÙˆØ§ØªØ³Ø§Ø¨
                    </a>
                    <button onclick="shareStore()"
                        class="bg-gray-50 text-gray-700 py-2.5 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-gray-100 transition">
                        <i class="fas fa-share-alt text-xl"></i> Ù…Ø´Ø§Ø±ÙƒØ©
                    </button>
                </div>
            </div>
        </div>

        <div class="sticky-tabs no-scrollbar" id="categories-tabs">
            <button class="tab-btn active" onclick="filterProducts('all')">Ø§Ù„ÙƒÙ„</button>
            <button class="tab-btn" onclick="filterProducts('offers')">Ø¹Ø±ÙˆØ¶ ğŸ”¥</button>
        </div>

        <div class="p-4 space-y-4 min-h-[400px]" id="products-list">
        </div>

    </main>

    <div id="floating-cart" onclick="location.href='cart.html'">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center font-bold text-white border border-white/30"
                id="cart-count">0</div>
            <div class="flex flex-col">
                <span class="text-xs text-gray-300">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                <span class="font-bold text-lg" id="cart-total">0 Ø¯.Ø¬</span>
            </div>
        </div>
        <button
            class="flex items-center gap-2 font-bold text-sm bg-white text-gray-900 px-4 py-2 rounded-lg hover:bg-gray-100">
            Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ <i class="fas fa-angle-left"></i>
        </button>
    </div>

    <div id="toast-container" class="fixed bottom-24 left-1/2 -translate-x-1/2 z-50 w-max max-w-[90%]"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, orderBy, runTransaction, deleteDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let vendorProducts = [];
        let cart = JSON.parse(localStorage.getItem('s22market_cart')) || [];
        let currentUser = null;
        let vendorId = null;
        let isLiked = false;
        let likesCount = 0;

        // UI Elements
        const productsContainer = document.getElementById('products-list');
        const cartBar = document.getElementById('floating-cart');
        const tabsContainer = document.getElementById('categories-tabs');

        // --- Core Functions ---

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            initPage();
        });

        async function initPage() {
            const params = new URLSearchParams(window.location.search);
            vendorId = params.get('id');

            if (!vendorId) {
                alert("Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØ¬Ø± ØºÙŠØ± ØµØ§Ù„Ø­");
                window.location.href = 'index.html';
                return;
            }

            try {
                // 1. Fetch Vendor Info
                const userDoc = await getDoc(doc(db, "users", vendorId));
                if (!userDoc.exists()) throw new Error("Ø§Ù„Ù…ØªØ¬Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");

                const vendor = userDoc.data();
                const reqData = vendor.storeRequest || {};

                // Update UI
                document.title = vendor.storeName || vendor.displayName;
                document.getElementById('vendor-name').textContent = vendor.storeName || vendor.displayName;
                document.getElementById('vendor-desc').textContent = vendor.description || reqData.description || 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù…ØªØ¬Ø±Ù†Ø§';
                document.getElementById('vendor-cover').src = vendor.coverUrl || reqData.coverUrl || 'https://placehold.co/600x200/1f2937/ffffff?text=Cover';
                document.getElementById('vendor-logo').src = vendor.logoUrl || vendor.photoURL || 'https://placehold.co/100/1f2937/ffffff?text=Logo';
                document.getElementById('vendor-category').textContent = vendor.role === 'restaurant' ? 'Ù…Ø·Ø¹Ù…' : 'Ù…ØªØ¬Ø±';

                // Likes Logic
                likesCount = vendor.likesCount || 0;
                document.getElementById('likes-count').textContent = likesCount;
                if (currentUser) {
                    const likeDoc = await getDoc(doc(db, "users", vendorId, "likes", currentUser.uid));
                    isLiked = likeDoc.exists();
                    updateLikeUI();
                }

                // Contact Links
                const links = reqData.links || {};
                const whatsappBtn = document.getElementById('btn-whatsapp');
                if (links.whatsapp || links.phone) {
                    const number = links.whatsapp || links.phone;
                    whatsappBtn.href = `https://wa.me/${number.replace(/\D/g, '')}`;
                } else {
                    whatsappBtn.classList.add('hidden');
                }

                // 2. Fetch Products
                const q = query(collection(db, "products"), where("sellerId", "==", vendorId), orderBy("createdAt", "desc"));
                const snap = await getDocs(q);

                vendorProducts = snap.docs.map(d => ({ id: d.id, ...d.data() }));

                // Extract Categories for Tabs
                const categories = [...new Set(vendorProducts.map(p => p.subCategoryName || 'Ø¹Ø§Ù…'))];
                categories.forEach(cat => {
                    const btn = document.createElement('button');
                    btn.className = 'tab-btn';
                    btn.textContent = cat;
                    btn.onclick = () => filterProducts(cat, btn);
                    tabsContainer.appendChild(btn);
                });

                renderProducts(vendorProducts);
                updateCartUI();

                // Hide Loader
                document.getElementById('page-loader').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');

            } catch (error) {
                console.error(error);
                document.body.innerHTML = `<div class="flex flex-col items-center justify-center h-screen"><i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i><p class="text-gray-600">${error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£'}</p><a href="index.html" class="mt-4 text-blue-600 font-bold">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></div>`;
            }
        }

        // --- Like System ---
        function updateLikeUI() {
            const btn = document.getElementById('like-btn');
            const icon = document.getElementById('like-icon');
            const count = document.getElementById('likes-count');

            count.textContent = likesCount;
            if (isLiked) {
                icon.className = 'fas fa-heart text-red-500 animate-pulse';
                btn.classList.add('bg-red-50', 'border-red-200');
            } else {
                icon.className = 'far fa-heart text-red-500';
                btn.classList.remove('bg-red-50', 'border-red-200');
            }
        }

        window.toggleLike = async () => {
            if (!currentUser) {
                showToast("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ØªØ¬Ø±");
                return;
            }

            // Optimistic UI
            isLiked = !isLiked;
            likesCount += isLiked ? 1 : -1;
            updateLikeUI();

            const btn = document.getElementById('like-btn');
            btn.disabled = true;

            try {
                const userRef = doc(db, "users", vendorId);
                const likeRef = doc(db, "users", vendorId, "likes", currentUser.uid);

                await runTransaction(db, async (transaction) => {
                    const sfDoc = await transaction.get(userRef);
                    if (!sfDoc.exists()) throw "Vendor does not exist!";

                    const currentCount = sfDoc.data().likesCount || 0;

                    if (isLiked) {
                        transaction.set(likeRef, { timestamp: serverTimestamp() });
                        transaction.update(userRef, { likesCount: currentCount + 1 });
                    } else {
                        transaction.delete(likeRef);
                        transaction.update(userRef, { likesCount: Math.max(0, currentCount - 1) });
                    }
                });

            } catch (error) {
                console.error("Like failed: ", error);
                // Revert
                isLiked = !isLiked;
                likesCount += isLiked ? 1 : -1;
                updateLikeUI();
                showToast("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
            } finally {
                btn.disabled = false;
            }
        };

        // --- Render Logic ---

        window.filterProducts = (category, btnElement) => {
            // Update Active Tab
            if (btnElement) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btnElement.classList.add('active');
            }

            let filtered = [];
            if (category === 'all') filtered = vendorProducts;
            else if (category === 'offers') filtered = vendorProducts.filter(p => p.oldPrice > p.price); // Assuming offer logic
            else filtered = vendorProducts.filter(p => p.subCategoryName === category);

            renderProducts(filtered);
        };

        function renderProducts(list) {
            productsContainer.innerHTML = '';

            if (list.length === 0) {
                productsContainer.innerHTML = `<div class="text-center py-10 text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</div>`;
                return;
            }

            list.forEach(product => {
                const img = (product.imageUrls && product.imageUrls[0]) ? product.imageUrls[0] : (product.imageUrl || 'https://placehold.co/100');
                const isDirect = product.productType === 'direct';
                const isAuction = product.productType === 'auction';

                const card = document.createElement('div');
                card.className = 'product-card relative';

                let actionBtn = `<button class="w-8 h-8 rounded-full ${isDirect ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'} flex items-center justify-center hover:bg-indigo-600 hover:text-white transition-colors add-btn" data-id="${product.id}">
                            <i class="fas ${isDirect ? 'fa-paper-plane' : 'fa-plus'}"></i>
                        </button>`;

                if (isAuction) {
                    actionBtn = `<button class="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-600 hover:text-white transition-colors" onclick="location.href='auction-details.html?id=${product.id}'">
                            <i class="fas fa-gavel"></i>
                        </button>`;
                }

                card.innerHTML = `
                    <div class="absolute top-2 left-2 flex gap-1 z-10">
                         ${isAuction ? '<span class="bg-red-600 text-white text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm">Ù…Ø²Ø§Ø¯</span>' : ''}
                    </div>
                    <img src="${img}" class="prod-img" onclick="location.href='PRESENTPRODUCT.html?product=${product.id}'">
                    <div class="flex-grow flex flex-col justify-between" onclick="location.href='PRESENTPRODUCT.html?product=${product.id}'">
                        <div>
                            <h3 class="font-bold text-gray-800 line-clamp-1">${product.name}</h3>
                            <p class="text-xs text-gray-500 line-clamp-2 mt-1">${product.description || ''}</p>
                        </div>
                        <div class="flex justify-between items-end mt-2">
                            <span class="font-bold text-indigo-600 text-lg">${product.price.toLocaleString()} Ø¯.Ø¬</span>
                        </div>
                    </div>
                    <div class="flex flex-col justify-end">
                        ${actionBtn}
                    </div>
                `;

                // Add Button Logic
                if (!isAuction) {
                    const btn = card.querySelector('.add-btn');
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        if (isDirect) {
                            window.location.href = `PRESENTPRODUCT.html?product=${product.id}`; // Direct goes to detail for contact
                        } else {
                            addToCart(product);
                            btn.innerHTML = '<i class="fas fa-check"></i>';
                            btn.classList.add('bg-green-500', 'text-white');
                            setTimeout(() => {
                                btn.innerHTML = '<i class="fas fa-plus"></i>';
                                btn.classList.remove('bg-green-500', 'text-white');
                            }, 1000);
                        }
                    };
                }

                productsContainer.appendChild(card);
            });
        }

        // --- Cart Logic ---

        function addToCart(product) {
            const existing = cart.find(i => i.id === product.id);
            if (existing) {
                existing.quantity++;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    image: (product.imageUrls && product.imageUrls[0]) || product.imageUrl,
                    quantity: 1,
                    sellerId: product.sellerId // Important for multi-vendor
                });
            }
            saveCart();
            updateCartUI();
            showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©');
        }

        function saveCart() {
            localStorage.setItem('s22market_cart', JSON.stringify(cart));
        }

        function updateCartUI() {
            const count = cart.reduce((sum, i) => sum + i.quantity, 0);
            const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);

            if (count > 0) {
                document.getElementById('cart-count').textContent = count;
                document.getElementById('cart-total').textContent = total.toLocaleString() + ' Ø¯.Ø¬';
                cartBar.classList.add('visible');
                // Make space for the bar
                document.body.style.paddingBottom = '100px';
            } else {
                cartBar.classList.remove('visible');
                document.body.style.paddingBottom = '20px';
            }
        }

        // --- Utils ---

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg text-sm font-bold flex items-center gap-2 animate-bounce';
            el.innerHTML = `<i class="fas fa-check-circle text-green-400"></i> ${msg}`;
            container.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        window.shareStore = () => {
            if (navigator.share) {
                navigator.share({
                    title: document.title,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                alert("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØ¬Ø±!");
            }
        };

        // Initialize is handled in auth listener

    </script>
</body>

</html>