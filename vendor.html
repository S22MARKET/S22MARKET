<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S22 Market - Ù…ØªØ¬Ø±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
            padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
        }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØºÙ„Ø§Ù */
        /* Mobile-First Header */
        .vendor-header {
            position: relative;
            height: 35vh;
            /* Dynamic height */
            min-height: 200px;
            max-height: 300px;
            overflow: hidden;
        }

        .vendor-cover {
            width: 100%;
            height: 100%;
            object-fit: cover;
            animation: zoomSlow 20s infinite alternate;
        }

        @keyframes zoomSlow {
            from {
                transform: scale(1);
            }

            to {
                transform: scale(1.1);
            }
        }

        .vendor-info-card {
            margin-top: -40px;
            position: relative;
            z-index: 10;
            background: white;
            border-radius: 24px 24px 0 0;
            padding: 24px 20px;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.08);
        }

        .vendor-logo {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            /* Modern square-ish */
            border: 4px solid white;
            object-fit: cover;
            position: absolute;
            top: -40px;
            right: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            background: white;
        }

        /* App-Like Product Card */
        .product-card {
            background: white;
            border-radius: 20px;
            padding: 12px;
            display: flex;
            gap: 14px;
            border: 1px solid #f3f4f6;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
        }

        .product-card:active {
            transform: scale(0.97);
        }

        .prod-img {
            width: 100px;
            height: 100px;
            border-radius: 16px;
            object-fit: cover;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        /* Pill Tabs */
        .sticky-tabs {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 40;
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            white-space: nowrap;
            overflow-x: auto;
            display: flex;
            gap: 8px;
            scroll-snap-type: x mandatory;
        }

        .tab-btn {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 100px;
            background: #f8fafc;
            color: #64748b;
            font-size: 14px;
            font-weight: 800;
            transition: all 0.3s;
            border: 1px solid transparent;
            scroll-snap-align: start;
        }

        .tab-btn.active {
            background: #0f172a;
            color: white;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2);
            transform: scale(1.05);
        }

        /* Floating Cart with Glassmorphism */
        #floating-cart {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body>

    <a href="index.html"
        class="fixed top-4 left-4 z-30 w-10 h-10 bg-white/80 backdrop-blur rounded-full flex items-center justify-center text-gray-800 shadow-lg hover:bg-white">
        <i class="fas fa-arrow-left"></i>
    </a>

    <div id="page-loader" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
        <p class="mt-4 text-gray-500 font-bold">Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ØªØ¬Ø±...</p>
    </div>

    <main id="main-content" class="hidden">

        <div class="vendor-header">
            <img id="vendor-cover" src="" class="vendor-cover" alt="Cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
        </div>

        <div class="vendor-info-card">
            <img id="vendor-logo" src="" class="vendor-logo" alt="Logo">

            <div class="pt-8">
                <div class="flex justify-between items-start">
                    <div>
                        <h1 id="vendor-name" class="text-2xl font-black text-gray-900"></h1>
                        <div class="flex items-center gap-2 mt-1 text-sm text-gray-500">
                            <span id="vendor-category">Ù…ØªØ¬Ø± Ø¹Ø§Ù…</span> â€¢
                            <span class="text-green-600 font-bold bg-green-50 px-2 py-0.5 rounded text-xs"><i
                                    class="fas fa-motorcycle"></i> ØªÙˆØµÙŠÙ„ Ø³Ø±ÙŠØ¹</span>
                        </div>
                    </div>
                    <div class="text-left flex flex-col items-end gap-2">
                        <div class="flex items-center gap-1 bg-yellow-50 px-2 py-1 rounded-lg border border-yellow-100">
                            <i class="fas fa-star text-yellow-500 text-xs"></i>
                            <span class="font-bold text-sm text-yellow-700">4.8</span>
                        </div>
                        <button id="like-btn" onclick="toggleLike()"
                            class="flex items-center gap-1 bg-gray-50 px-3 py-1.5 rounded-full border border-gray-200 transition-all active:scale-95">
                            <i id="like-icon" class="far fa-heart text-red-500"></i>
                            <span id="likes-count" class="text-xs font-bold text-gray-600">0</span>
                        </button>
                    </div>
                </div>

                <p id="vendor-desc" class="mt-4 text-gray-600 text-sm leading-relaxed line-clamp-2"></p>

                <div class="grid grid-cols-2 gap-3 mt-6">
                    <a id="btn-whatsapp" href="#" target="_blank"
                        class="bg-green-50 text-green-700 py-2.5 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-green-100 transition">
                        <i class="fab fa-whatsapp text-xl"></i> ÙˆØ§ØªØ³Ø§Ø¨
                    </a>
                    <button onclick="shareStore()"
                        class="bg-gray-50 text-gray-700 py-2.5 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-gray-100 transition">
                        <i class="fas fa-share-alt text-xl"></i> Ù…Ø´Ø§Ø±ÙƒØ©
                    </button>
                </div>
            </div>

            <!-- Customer Stories / Visual Reviews -->
            <div class="mt-8 mb-2">
                <div class="flex items-center justify-between px-1 mb-3">
                    <h3 class="font-bold text-gray-800 text-lg">ØªØ¬Ø§Ø±Ø¨ Ø§Ù„Ù†Ø§Ø³ ğŸ“¸</h3>
                    <span
                        class="text-xs text-orange-600 font-bold bg-orange-50 px-2 py-1 rounded-full cursor-pointer hover:bg-orange-100">Ø¹Ø±Ø¶
                        Ø§Ù„ÙƒÙ„</span>
                </div>
                <!-- Stories Container -->
                <div class="flex gap-3 overflow-x-auto pb-4 no-scrollbar px-1" id="review-stories-container">
                    <!-- Static placeholders for now, will be dynamic later -->
                    <div class="flex flex-col items-center gap-1 min-w-[70px] cursor-pointer group">
                        <div class="w-16 h-16 rounded-full p-[2px] bg-gradient-to-tr from-pink-500 to-purple-600">
                            <img src="https://images.unsplash.com/photo-1546069901-ba9599a7e63c?auto=format&fit=crop&q=80&w=150"
                                class="w-full h-full rounded-full border-2 border-white object-cover group-hover:scale-95 transition-transform">
                        </div>
                        <span class="text-[10px] font-bold text-gray-600 truncate w-14 text-center">Ø£Ø­Ù…Ø¯</span>
                    </div>
                    <div class="flex flex-col items-center gap-1 min-w-[70px] cursor-pointer group">
                        <div class="w-16 h-16 rounded-full p-[2px] bg-gradient-to-tr from-pink-500 to-purple-600">
                            <img src="https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?auto=format&fit=crop&q=80&w=150"
                                class="w-full h-full rounded-full border-2 border-white object-cover group-hover:scale-95 transition-transform">
                        </div>
                        <span class="text-[10px] font-bold text-gray-600 truncate w-14 text-center">Ø³Ø§Ø±Ø©</span>
                    </div>
                    <div class="flex flex-col items-center gap-1 min-w-[70px] cursor-pointer group">
                        <div class="w-16 h-16 rounded-full p-[2px] bg-gray-200">
                            <img src="https://images.unsplash.com/photo-1482049016688-2d3e1b311543?auto=format&fit=crop&q=80&w=150"
                                class="w-full h-full rounded-full border-2 border-white object-cover group-hover:scale-95 transition-transform">
                        </div>
                        <span class="text-[10px] font-bold text-gray-600 truncate w-14 text-center">Ø¹Ù„ÙŠ</span>
                    </div>
                    <!-- Add Review Button -->
                    <button class="flex flex-col items-center gap-1 min-w-[70px] cursor-pointer group">
                        <div
                            class="w-16 h-16 rounded-full border-2 border-dashed border-gray-300 flex items-center justify-center bg-gray-50 hover:bg-gray-100 hover:border-gray-400 trasition-colors">
                            <i class="fas fa-camera text-gray-400 text-lg"></i>
                        </div>
                        <span class="text-[10px] font-bold text-gray-400 truncate w-14 text-center">Ø£Ø¶Ù ØµÙˆØ±ØªÙƒ</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="sticky-tabs no-scrollbar" id="categories-tabs">
            <button class="tab-btn active" onclick="filterProducts('all')">Ø§Ù„ÙƒÙ„</button>
            <button class="tab-btn" onclick="filterProducts('offers')">Ø¹Ø±ÙˆØ¶ ğŸ”¥</button>
        </div>

        <div class="p-4 space-y-4 min-h-[400px]" id="products-list">
        </div>

    </main>

    <div id="floating-cart" onclick="location.href='cart.html'">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center font-bold text-white border border-white/30"
                id="cart-count">0</div>
            <div class="flex flex-col">
                <span class="text-xs text-gray-300">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                <span class="font-bold text-lg" id="cart-total">0 Ø¯.Ø¬</span>
            </div>
        </div>
        <button
            class="flex items-center gap-2 font-bold text-sm bg-white text-gray-900 px-4 py-2 rounded-lg hover:bg-gray-100">
            Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ <i class="fas fa-angle-left"></i>
        </button>
    </div>

    <!-- AI Food Assistant FAB -->
    <div class="fixed bottom-24 right-4 z-40 animate-bounce cursor-pointer group" onclick="toggleAIAssistant()">
        <div
            class="w-14 h-14 bg-gradient-to-br from-indigo-600 to-blue-500 rounded-full shadow-lg shadow-blue-500/30 flex items-center justify-center border-2 border-white relative overflow-hidden">
            <i class="fas fa-robot text-2xl text-white relative z-10"></i>
            <div
                class="absolute inset-0 bg-white/20 transform -translate-y-full group-hover:translate-y-0 transition-transform">
            </div>
        </div>
        <span
            class="absolute right-16 top-2 bg-white px-3 py-1 rounded-xl text-xs font-bold shadow-md w-max animate-pulse hidden group-hover:block transition-all">Ù…Ø­ØªØ§Ø±
            ÙˆØ´ ØªØ§ÙƒÙ„ØŸ ğŸ¤”</span>
    </div>

    <!-- AI Assistant Overlay -->
    <div id="ai-overlay"
        class="fixed inset-0 bg-black/50 z-[60] hidden items-end sm:items-center justify-center backdrop-blur-sm">
        <div
            class="bg-white w-full sm:w-[400px] h-[80vh] sm:h-[600px] rounded-t-3xl sm:rounded-3xl shadow-2xl flex flex-col overflow-hidden animate-[slideUp_0.3s_ease-out]">
            <!-- Header -->
            <div class="bg-indigo-600 p-4 text-white flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center border border-white/30">
                        <i class="fas fa-robot text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg">Dr. S22 ğŸ¤–</h3>
                        <p class="text-xs opacity-80">Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ Ù„Ù„Ø·Ù„Ø¨</p>
                    </div>
                </div>
                <button onclick="toggleAIAssistant()"
                    class="w-8 h-8 flex items-center justify-center bg-white/10 rounded-full hover:bg-white/20 transition"><i
                        class="fas fa-times"></i></button>
            </div>

            <!-- Chat Area -->
            <div class="flex-1 bg-gray-50 p-4 overflow-y-auto space-y-4" id="ai-chat-box">
                <!-- Initial Message -->
                <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-indigo-600 text-xs"></i>
                    </div>
                    <div class="bg-white p-3 rounded-2xl rounded-tr-none shadow-sm text-sm text-gray-700 max-w-[80%]">
                        Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! ğŸ‘‹ Ø£Ù†Ø§ Ø§Ù„Ø¯ÙƒØªÙˆØ± S22. Ø´Ø§ÙŠÙÙƒ Ù…Ø­ØªØ§Ø±.. ÙƒÙŠÙ Ø£Ù‚Ø¯Ø± Ø£Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„ÙŠÙˆÙ…ØŸ
                    </div>
                </div>

                <!-- Options -->
                <div class="flex flex-wrap gap-2 mt-2 justify-end" id="ai-options">
                    <button onclick="aiReply('cold')"
                        class="bg-blue-100 text-blue-700 px-4 py-2 rounded-xl text-xs font-bold hover:bg-blue-200 transition">Ø¨Ø±Ø¯Ø§Ù†
                        ÙˆØ§Ø¨ØºÙ‰ Ø§ØªØ¯ÙØ§ ğŸ¥¶</button>
                    <button onclick="aiReply('quick')"
                        class="bg-orange-100 text-orange-700 px-4 py-2 rounded-xl text-xs font-bold hover:bg-orange-200 transition">ØºØ¯Ø§Ø¡
                        Ø³Ø±ÙŠØ¹ âš¡</button>
                    <button onclick="aiReply('surprise')"
                        class="bg-purple-100 text-purple-700 px-4 py-2 rounded-xl text-xs font-bold hover:bg-purple-200 transition">ÙØ§Ø¬Ø¦Ù†ÙŠ!
                        ğŸ²</button>
                    <button onclick="aiReply('broke')"
                        class="bg-green-100 text-green-700 px-4 py-2 rounded-xl text-xs font-bold hover:bg-green-200 transition">Ù…Ø·ÙØ±
                        (Ø±Ø®ÙŠØµ) ğŸ’¸</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-24 left-1/2 -translate-x-1/2 z-50 w-max max-w-[90%]"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, orderBy, runTransaction, deleteDoc, setDoc, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let vendorProducts = [];
        let cart = JSON.parse(localStorage.getItem('s22market_cart')) || [];
        let currentUser = null;
        let vendorId = null;
        let isLiked = false;
        let likesCount = 0;

        // UI Elements
        const productsContainer = document.getElementById('products-list');
        const cartBar = document.getElementById('floating-cart');
        const tabsContainer = document.getElementById('categories-tabs');

        // --- Core Functions ---

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            initPage();
        });

        async function initPage() {
            const params = new URLSearchParams(window.location.search);
            vendorId = params.get('id');

            // Sanitize ID
            if (vendorId) vendorId = vendorId.trim();

            console.log("Initializing Vendor Page for ID:", vendorId);

            if (!vendorId) {
                document.body.innerHTML = `<div class="p-10 text-center text-red-500 font-bold">Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØ¬Ø± ØºÙŠØ± ØµØ§Ù„Ø­ (Ù†Ù‚Øµ Ø§Ù„Ù…Ø¹Ø±Ù)</div>`;
                return;
            }

            try {
                // 1. Fetch Vendor Info
                const userDoc = await getDoc(doc(db, "users", vendorId));

                if (!userDoc.exists()) {
                    // Check if it's a permission issue disguised as emptiness? 
                    // Actually Firestore throws 'permission-denied' before returning non-exists usually.
                    throw new Error("Ø§Ù„Ù…ØªØ¬Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØªÙ… Ø­Ø°ÙÙ‡");
                }

                const vendor = userDoc.data();
                console.log("Vendor Loaded:", vendor);

                // Unified View: No Redirection for Restaurant
                // We will render restaurant data here in the professional layout

                const reqData = vendor.storeRequest || {};

                // Update UI
                document.title = vendor.storeName || vendor.displayName;
                document.getElementById('vendor-name').textContent = vendor.storeName || vendor.displayName;
                document.getElementById('vendor-desc').textContent = vendor.description || reqData.description || 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù…ØªØ¬Ø±Ù†Ø§';
                document.getElementById('vendor-cover').src = vendor.coverUrl || reqData.coverUrl || 'https://placehold.co/600x200/1f2937/ffffff?text=Cover';
                document.getElementById('vendor-logo').src = vendor.logoUrl || vendor.photoURL || 'https://placehold.co/100/1f2937/ffffff?text=Logo';

                const roleText = vendor.role === 'restaurant' ? 'Ù…Ø·Ø¹Ù…' : 'Ù…ØªØ¬Ø±';
                document.getElementById('vendor-category').textContent = roleText;

                // Likes Logic
                likesCount = vendor.likesCount || 0;
                document.getElementById('likes-count').textContent = likesCount;
                if (currentUser) {
                    const likeDoc = await getDoc(doc(db, "users", vendorId, "likes", currentUser.uid));
                    isLiked = likeDoc.exists();
                    updateLikeUI();
                }

                // Contact Links
                const links = reqData.links || vendor.socialLinks || {};
                const whatsappBtn = document.getElementById('btn-whatsapp');
                // Check multiple possible phone fields
                const phone = links.whatsapp || links.phone || vendor.phone;

                if (phone) {
                    whatsappBtn.href = `https://wa.me/${phone.replace(/\D/g, '')}`;
                    whatsappBtn.classList.remove('hidden');
                } else {
                    whatsappBtn.classList.add('hidden');
                }

                // 2. Fetch Products
                const q = query(collection(db, "products"), where("sellerId", "==", vendorId), orderBy("createdAt", "desc"), limit(50));
                const snap = await getDocs(q);

                vendorProducts = snap.docs.map(d => ({ id: d.id, ...d.data() }));

                // Extract Categories for Tabs (Handle both 'subCategoryName' for stores and 'categoryName' for restaurants)
                // Stores usually use `subCategoryName`. Restaurants might use `categoryName` or linked `categoryId`.
                // We'll prioritize `subCategoryName`, then `categoryName`, then fall back to 'Ø¹Ø§Ù…'

                const categorySet = new Set();
                vendorProducts.forEach(p => {
                    const cat = p.subCategoryName || p.categoryName || 'Ø¹Ø§Ù…';
                    categorySet.add(cat);
                });

                const categories = ['Ø§Ù„ÙƒÙ„', ...categorySet];

                // Clear existing tabs except static ones if any (but we are rebuilding all)
                tabsContainer.innerHTML = '';

                categories.forEach(cat => {
                    const btn = document.createElement('button');
                    btn.className = `tab-btn ${cat === 'Ø§Ù„ÙƒÙ„' ? 'active' : ''}`;
                    btn.textContent = cat;
                    // Special handling for 'offers' if we want to keep it
                    if (cat === 'Ø§Ù„ÙƒÙ„') {
                        btn.onclick = () => filterProducts('all', btn);
                    } else {
                        btn.onclick = () => filterProducts(cat, btn);
                    }
                    tabsContainer.appendChild(btn);
                });

                // Add "Offers" tab manually if not present in categories but logic exists
                const offersBtn = document.createElement('button');
                offersBtn.className = 'tab-btn';
                offersBtn.textContent = 'Ø¹Ø±ÙˆØ¶ ğŸ”¥';
                offersBtn.onclick = () => filterProducts('offers', offersBtn);
                tabsContainer.appendChild(offersBtn);

                renderProducts(vendorProducts);
                updateCartUI();

                // Hide Loader
                document.getElementById('page-loader').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');

            } catch (error) {
                console.error("Vendor Page Error:", error);

                let errorMsg = "Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ø£Ù† Ø§Ù„Ù…ØªØ¬Ø± Ù„Ù… ÙŠØ¹Ø¯ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹.";
                let errorTitle = "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ù…ØªØ¬Ø± ØºÙŠØ± Ù…ØªØ§Ø­";

                if (error.code === 'permission-denied') {
                    errorTitle = "ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ù†ÙŠ";
                    errorMsg = "Ù„Ø§ ØªÙ…Ù„Ùƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø£Ùˆ ØºÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„Ø¹Ø§Ù…Ø©.";
                } else if (error.message.includes("ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯")) {
                    errorMsg = "Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.";
                }

                document.body.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-screen bg-gray-50 px-4 text-center">
                        <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mb-6">
                            <i class="fas fa-store-slash text-4xl text-red-500"></i>
                         </div>
                        <h1 class="text-2xl font-bold text-gray-800 mb-2">${errorTitle}</h1>
                        <p class="text-gray-500 max-w-xs mx-auto mb-8">
                            ${errorMsg}
                            <br><span class="text-xs text-red-400 mt-2 block" dir="ltr">DEBUG: ${error.message}</span>
                        </p>
                        <a href="index.html" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-indigo-700 transition transform hover:scale-105">
                            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                        </a>
                    </div>
                `;
            }
        }

        // --- Like System ---
        function updateLikeUI() {
            const btn = document.getElementById('like-btn');
            const icon = document.getElementById('like-icon');
            const count = document.getElementById('likes-count');

            count.textContent = likesCount;
            if (isLiked) {
                icon.className = 'fas fa-heart text-red-500 animate-pulse';
                btn.classList.add('bg-red-50', 'border-red-200');
            } else {
                icon.className = 'far fa-heart text-red-500';
                btn.classList.remove('bg-red-50', 'border-red-200');
            }
        }

        window.toggleLike = async () => {
            if (!currentUser) {
                showToast("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ØªØ¬Ø±");
                return;
            }

            // Optimistic UI
            isLiked = !isLiked;
            likesCount += isLiked ? 1 : -1;
            updateLikeUI();

            const btn = document.getElementById('like-btn');
            btn.disabled = true;

            try {
                const userRef = doc(db, "users", vendorId);
                const likeRef = doc(db, "users", vendorId, "likes", currentUser.uid);

                await runTransaction(db, async (transaction) => {
                    const sfDoc = await transaction.get(userRef);
                    if (!sfDoc.exists()) throw "Vendor does not exist!";

                    const currentCount = sfDoc.data().likesCount || 0;

                    if (isLiked) {
                        transaction.set(likeRef, { timestamp: serverTimestamp() });
                        transaction.update(userRef, { likesCount: currentCount + 1 });
                    } else {
                        transaction.delete(likeRef);
                        transaction.update(userRef, { likesCount: Math.max(0, currentCount - 1) });
                    }
                });

            } catch (error) {
                console.error("Like failed: ", error);
                // Revert
                isLiked = !isLiked;
                likesCount += isLiked ? 1 : -1;
                updateLikeUI();
                showToast("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
            } finally {
                btn.disabled = false;
            }
        };

        // --- Render Logic ---

        window.filterProducts = (category, btnElement) => {
            // Update Active Tab
            if (btnElement) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btnElement.classList.add('active');
            }

            let filtered = [];
            if (category === 'all' || category === 'Ø§Ù„ÙƒÙ„') filtered = vendorProducts;
            else if (category === 'offers') filtered = vendorProducts.filter(p => p.oldPrice > p.price); // Assuming offer logic
            else filtered = vendorProducts.filter(p => (p.subCategoryName === category || p.categoryName === category));

            renderProducts(filtered);
        };

        function renderProducts(list) {
            productsContainer.innerHTML = '';

            if (list.length === 0) {
                productsContainer.innerHTML = `< div class="text-center py-10 text-gray-400" > Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</div > `;
                return;
            }

            list.forEach(product => {
                const img = (product.imageUrls && product.imageUrls[0]) ? product.imageUrls[0] : (product.imageUrl || 'https://placehold.co/100');
                const isDirect = product.productType === 'direct';
                const isAuction = product.productType === 'auction';

                const card = document.createElement('div');
                card.className = 'product-card relative';

                let actionBtn = `<button class="w-8 h-8 rounded-full ${isDirect ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'} flex items-center justify-center hover:bg-indigo-600 hover:text-white transition-colors add-btn" data-id="${product.id}">
                    <i class="fas ${isDirect ? 'fa-paper-plane' : 'fa-plus'}"></i>
                </button>`;

                if (isAuction) {
                    actionBtn = `<button class="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-600 hover:text-white transition-colors" onclick="location.href='auction-details.html?id=${product.id}'">
                    <i class="fas fa-gavel"></i>
                    </button>`;
                }

                // App-Like Card Structure
                card.innerHTML = `
                    <div class="relative">
                        <img src="${img}" class="prod-img" onclick="location.href='PRESENTPRODUCT.html?product=${product.id}'">
                        ${isAuction ? '<span class="absolute top-1 right-1 bg-red-600 text-white text-[10px] px-2 py-0.5 rounded-full font-bold shadow-md">Ù…Ø²Ø§Ø¯</span>' : ''}
                    </div>
                    
                    <div class="flex-grow flex flex-col justify-between py-1" onclick="location.href='PRESENTPRODUCT.html?product=${product.id}'">
                        <div>
                            <div class="flex justify-between items-start">
                                <h3 class="font-extrabold text-gray-800 text-base leading-tight line-clamp-2">
                                    ${(typeof product.name === 'object') ? (product.name.ar || product.name.en || 'Ù…Ù†ØªØ¬') : product.name}
                                </h3>
                            </div>
                            <p class="text-xs text-gray-400 line-clamp-2 mt-1 font-medium">${product.description || 'ÙˆØµÙ Ù…Ø®ØªØµØ± Ù„Ù„Ù…Ù†ØªØ¬...'}</p>
                        </div>
                        
                        <div class="flex justify-between items-end mt-2">
                            <div class="flex flex-col">
                                ${product.oldPrice && product.oldPrice > product.price ? `<span class="text-xs text-gray-400 line-through Decoration-red-500">${product.oldPrice.toLocaleString()}</span>` : ''}
                                <span class="font-black text-indigo-600 text-lg ">${product.price.toLocaleString()} <span class="text-xs font-normal text-gray-500">Ø¯.Ø¬</span></span>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col justify-end pb-1">
                        ${actionBtn.replace('class="', 'class="shadow-md scale-110 ')}
                    </div>
                `;

                // Add Button Logic
                if (!isAuction) {
                    const btn = card.querySelector('.add-btn');
                    if (btn) {
                        btn.onclick = (e) => {
                            e.stopPropagation();
                            if (isDirect) {
                                window.location.href = `PRESENTPRODUCT.html?product=${product.id}`;
                            } else {
                                addToCart(product);
                                btn.innerHTML = '<i class="fas fa-check"></i>';
                                btn.classList.add('bg-green-500', 'text-white');
                                setTimeout(() => {
                                    btn.innerHTML = '<i class="fas fa-plus"></i>';
                                    btn.classList.remove('bg-green-500', 'text-white');
                                }, 1000);
                            }
                        };
                    }
                }

                productsContainer.appendChild(card);
            });
        }

        // --- Cart Logic ---

        function addToCart(product) {
            const existing = cart.find(i => i.id === product.id);
            if (existing) {
                existing.quantity++;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    image: (product.imageUrls && product.imageUrls[0]) || product.imageUrl,
                    quantity: 1,
                    sellerId: product.sellerId // Important for multi-vendor
                });
            }
            saveCart();
            updateCartUI();
            showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©');
        }

        function saveCart() {
            localStorage.setItem('s22market_cart', JSON.stringify(cart));
        }

        function updateCartUI() {
            const count = cart.reduce((sum, i) => sum + i.quantity, 0);
            const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);

            if (count > 0) {
                document.getElementById('cart-count').textContent = count;
                document.getElementById('cart-total').textContent = total.toLocaleString() + ' Ø¯.Ø¬';
                cartBar.classList.add('visible');
                // Make space for the bar
                document.body.style.paddingBottom = '100px';
            } else {
                cartBar.classList.remove('visible');
                document.body.style.paddingBottom = '20px';
            }
        }

        // --- Utils ---

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg text-sm font-bold flex items-center gap-2 animate-bounce';
            el.innerHTML = `< i class="fas fa-check-circle text-green-400" ></i > ${msg} `;
            container.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        window.shareStore = () => {
            if (navigator.share) {
                navigator.share({
                    title: document.title,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                alert("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØ¬Ø±!");
            }
        };

        // Initial Load handled in auth listener

        // --- AI Assistant Logic ---
        window.toggleAIAssistant = () => {
            const el = document.getElementById('ai-overlay');
            el.classList.toggle('hidden');
            el.classList.toggle('flex');
        };

        window.aiReply = async (type) => {
            // Helper to get name
            const getName = (p) => {
                if (!p.name) return 'Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                if (typeof p.name === 'object') return p.name.ar || p.name.en || 'Ù…Ù†ØªØ¬';
                return p.name;
            };

            const chatBox = document.getElementById('ai-chat-box');
            const options = document.getElementById('ai-options');

            // User Msg
            let userText = "";
            if (type === 'cold') userText = "Ø¨Ø±Ø¯Ø§Ù† ÙˆØ§Ø¨ØºÙ‰ Ø§ØªØ¯ÙØ§ ğŸ¥¶";
            if (type === 'quick') userText = "ØºØ¯Ø§Ø¡ Ø³Ø±ÙŠØ¹ âš¡";
            if (type === 'surprise') userText = "ÙØ§Ø¬Ø¦Ù†ÙŠ! ğŸ²";
            if (type === 'broke') userText = "Ù…Ø·ÙØ± (Ø±Ø®ÙŠØµ) ğŸ’¸";

            chatBox.innerHTML += `
                    <div class="flex gap-3 justify-end animate-fade-in">
                        <div class="bg-indigo-600 p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-white max-w-[80%]">
                            ${userText}
                        </div>
                    </div>
                    `;

            // Simulate Typing
            chatBox.innerHTML += `
                    <div class="flex gap-3 animate-fade-in" id="ai-typing">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-indigo-600 text-xs"></i>
                    </div>
                    <div class="bg-gray-200 p-3 rounded-2xl rounded-tr-none shadow-sm flex gap-1 items-center h-10">
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce delay-75"></div>
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce delay-150"></div>
                    </div>
                </div>
                    `;
            chatBox.scrollTop = chatBox.scrollHeight;
            options.classList.add('hidden'); // Hide options

            // Fake Delay
            await new Promise(r => setTimeout(r, 1500));
            document.getElementById('ai-typing').remove();

            // Logic to pick product
            let suggestion = null;
            if (vendorProducts.length > 0) {
                // Simple logic for demo
                if (type === 'broke') {
                    // Find cheapest
                    suggestion = vendorProducts.sort((a, b) => a.price - b.price)[0];
                } else if (type === 'surprise') {
                    suggestion = vendorProducts[Math.floor(Math.random() * vendorProducts.length)];
                } else {
                    suggestion = vendorProducts[0]; // Fallback
                }
            }

            let responseHTML = '';
            if (suggestion) {
                const img = (suggestion.imageUrls && suggestion.imageUrls[0]) || suggestion.imageUrl || 'https://placehold.co/100';
                const pName = getName(suggestion);

                responseHTML = `
                    <div class="flex gap-3 animate-fade-in">
                        <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-robot text-indigo-600 text-xs"></i>
                        </div>
                        <div class="flex flex-col gap-2 max-w-[85%]">
                            <div class="bg-white p-3 rounded-2xl rounded-tr-none shadow-sm text-sm text-gray-700">
                                Ù„Ù‚ÙŠØª Ù„Ùƒ Ø´ÙŠØ¡ Ø¨ÙŠØ¹Ø¬Ø¨Ùƒ! ğŸ˜‹ Ø¬Ø±Ø¨ Ù‡Ø°Ø§:
                            </div>
                            <div class="bg-white p-3 rounded-xl shadow-md border border-gray-100 cursor-pointer hover:scale-105 transition-transform" onclick="location.href='PRESENTPRODUCT.html?product=${suggestion.id}'">
                                <img src="${img}" class="w-full h-32 object-cover rounded-lg mb-2">
                                <h4 class="font-bold text-gray-900">${pName}</h4>
                                <div class="flex justify-between items-center mt-1">
                                    <span class="text-indigo-600 font-bold">${suggestion.price} Ø¯.Ø¬</span>
                                    <button class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-xs">Ø·Ù„Ø¨</button>
                                </div>
                            </div>
                            <div class="flex gap-2 justify-center mt-2">
                                <button onclick="toggleAIAssistant()" class="text-xs text-gray-500 underline">Ø´ÙƒØ±Ø§Ù‹ØŒ ÙŠÙƒÙÙŠ</button>
                                <button onclick="aiReply('${type}')" class="text-xs text-indigo-600 font-bold">Ø§Ù‚ØªØ±Ø§Ø­ Ø«Ø§Ù†ÙŠ ğŸ”„</button>
                            </div>
                        </div>
                    </div>
                    `;
            } else {
                responseHTML = `
                    <div class="flex gap-3 animate-fade-in">
                        <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-robot text-indigo-600 text-xs"></i>
                        </div>
                        <div class="bg-white p-3 rounded-2xl rounded-tr-none shadow-sm text-sm text-gray-700">
                            Ù„Ù„Ø£Ø³Ù Ù…Ø§ Ù„Ù‚ÙŠØª Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØ¬Ø± ØªÙ†Ø§Ø³Ø¨ Ø·Ù„Ø¨Ùƒ ğŸ˜”
                        </div>
                    </div>`;
            }

            chatBox.innerHTML += responseHTML;
            chatBox.scrollTop = chatBox.scrollHeight;
        };

    </script>
</body>

</html>