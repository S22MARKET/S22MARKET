<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - Ø§Ù„Ù…ØªØ¬Ø±</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="LOGO.jpg">
    <!-- NoUiSlider -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <style>
        :root {
            --primary-color: #3b82f6;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-primary: #1e293b;
            --border-color: #e2e8f0;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .product-card {
            background-color: var(--bg-card);
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid var(--border-color);
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
        }

        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
        }

        .product-image-container {
            aspect-ratio: 1 / 1;
            overflow: hidden;
            position: relative;
        }

        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .product-card:hover .product-image {
            transform: scale(1.1);
        }

        .product-card-content {
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .product-card-title {
            font-size: 1.1rem;
            font-weight: 700;
            line-height: 1.4;
            height: 2.8em;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .product-card-price {
            color: var(--primary-color);
            font-size: 1.25rem;
            font-weight: 800;
        }

        .filter-sidebar {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            max-width: 320px;
            height: 100vh;
            background: white;
            z-index: 2000;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .filter-sidebar.active {
            right: 0;
        }

        .filter-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .filter-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Store Header Styles */
        .store-header {
            background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
            color: white;
            padding: 3rem 1rem;
            border-radius: 0 0 2rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px -10px rgba(59, 130, 246, 0.5);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .store-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .store-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            object-fit: cover;
            margin: 0 auto 1rem;
            background-color: white;
            position: relative;
            z-index: 10;
        }

        .store-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Footer Branding */
        .s22-footer {
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
            border-top: 1px solid #e2e8f0;
            background: #ffffff;
        }

        .s22-logo-text {
            font-family: 'Tajawal', sans-serif;
            font-weight: 800;
            background: -webkit-linear-gradient(45deg, #1e293b, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* NoUiSlider Customization */
        .noUi-connect {
            background: var(--primary-color);
        }

        .noUi-horizontal .noUi-handle {
            width: 18px;
            height: 18px;
            right: -9px;
            top: -4px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid var(--primary-color);
            box-shadow: none;
            cursor: grab;
        }

        .noUi-target {
            border: none;
            background: #e5e7eb;
            height: 6px;
            box-shadow: none;
        }

        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }

        #splash-screen.hidden-splash {
            opacity: 0;
            visibility: hidden;
        }

        .splash-content {
            text-align: center;
            color: white;
            animation: scaleIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .splash-logo {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 1rem;
            text-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .splash-loader {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* New & Discount Badges */
        .badge-new {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 800;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
            animation: pulse-green 2s infinite;
        }

        .badge-discount {
            background: linear-gradient(135deg, #f43f5e, #e11d48);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        /* Cart Fly Animation */
        .fly-item {
            position: fixed;
            z-index: 9999;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1);
            pointer-events: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body>
    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="splash-content">
            <div class="splash-logo">S22<span class="text-blue-200">MARKET</span></div>
            <div class="splash-loader"></div>
            <p class="mt-4 text-blue-100 text-sm font-medium">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²...</p>
        </div>
    </div>

    <!-- Generic Header (Hidden if in Seller Mode, or simplified) -->
    <header id="main-header" class="bg-white shadow-sm sticky top-0 z-50 transition-transform duration-300">
        <div class="max-w-7xl mx-auto py-3 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <a href="index.html" class="text-2xl text-gray-600 hover:text-blue-600" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
                <i class="fas fa-arrow-right"></i>
            </a>
            <h1 onclick="location.href='index.html'" class="cursor-pointer text-xl sm:text-2xl font-bold text-gray-800">
                S22<span class="text-blue-600">MARKET</span>
            </h1>
            <a href="cart.html" class="relative text-2xl text-gray-600 hover:text-blue-600">
                <i class="fas fa-shopping-cart"></i>
            </a>
        </div>
    </header>

    <!-- Store Profile Header (Injected dynamically) -->
    <div id="store-hero-section" class="hidden"></div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">

        <!-- Filter Overlay & Sidebar -->
        <div class="filter-overlay" id="filter-overlay"></div>
        <aside class="filter-sidebar" id="filter-sidebar">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">ØªØµÙÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
                <button id="close-filter-btn" class="text-gray-500 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <div class="space-y-6">
                <div>
                    <h3 class="font-bold mb-3 text-sm text-gray-700">Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨</h3>
                    <select id="sidebar-sort" class="w-full p-2 border rounded-lg bg-gray-50">
                        <option value="default">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
                        <option value="asc">Ø§Ù„Ø³Ø¹Ø±: Ø§Ù„Ø£Ù‚Ù„ Ø£ÙˆÙ„Ø§Ù‹</option>
                        <option value="desc">Ø§Ù„Ø³Ø¹Ø±: Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø£ÙˆÙ„Ø§Ù‹</option>
                    </select>
                </div>
                <div>
                    <h3 class="font-bold mb-4 text-sm text-gray-700">Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± (Ø¯.Ø¬)</h3>
                    <div id="price-slider" class="mb-4 mx-2"></div>
                    <div class="flex justify-between text-sm text-gray-600 font-medium">
                        <span id="price-min-val">0</span>
                        <span id="price-max-val">50000+</span>
                    </div>
                </div>
                <button id="apply-filters-btn"
                    class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition shadow-lg mt-4">ØªØ·Ø¨ÙŠÙ‚
                    Ø§Ù„ÙÙ„ØªØ±</button>
                <button id="reset-filters-btn"
                    class="w-full text-gray-500 font-bold py-2 hover:text-red-500 text-sm mt-2">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            </div>
        </aside>

        <!-- Search & Filter Bar -->
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-8 mt-4 sticky top-16 z-40">
            <div class="flex flex-col sm:flex-row gap-4 items-center justify-between">
                <div class="relative w-full flex-grow">
                    <span class="absolute inset-y-0 right-0 flex items-center pr-3"><i
                            class="fas fa-search text-gray-400"></i></span>
                    <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø±..."
                        class="w-full pr-10 pl-4 py-3 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 focus:bg-white transition-colors">
                </div>
                <button id="open-filter-btn"
                    class="w-full sm:w-auto flex items-center justify-center gap-2 bg-white border border-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-50 transition shadow-sm font-bold whitespace-nowrap">
                    <i class="fas fa-sliders-h"></i> <span>ÙÙ„ØªØ±Ø©</span>
                </button>
            </div>
        </div>

        <h2 id="section-title" class="text-2xl font-bold text-gray-800 mb-6 px-1">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>

        <!-- Products Grid -->
        <div id="products-grid"
            class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 sm:gap-6 min-h-[300px]">
            <!-- Skeletons injected here -->
        </div>

        <div id="no-products-msg"
            class="hidden text-center py-20 bg-white rounded-xl shadow-sm border border-dashed border-gray-300">
            <div class="text-6xl mb-4">ğŸª</div>
            <p class="text-xl font-bold text-gray-800">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>
            <p class="text-gray-500 mt-2">Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØ¬Ø± Ù„Ù… ÙŠÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯ØŒ Ø£Ùˆ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ø¨Ø­Ø«Ùƒ.</p>
        </div>

    </main>

    <!-- Specific Footer -->
    <footer class="s22-footer">
        <div class="max-w-7xl mx-auto px-4">
            <p class="text-gray-600 font-medium mb-2">ØªÙ… ØµÙ†Ø¹ Ù…Ù† Ø·Ø±Ù </p>
            <h3 class="text-2xl s22-logo-text mb-4">S22 MARKET</h3>
            <div class="flex justify-center gap-4 text-2xl text-gray-400">
                <i class="fab fa-instagram hover:text-pink-600 transition-colors cursor-pointer"
                    onclick="window.open('https://instagram.com/s22market', '_blank')"></i>
                <i class="fab fa-facebook hover:text-blue-600 transition-colors cursor-pointer"
                    onclick="window.open('https://facebook.com/s22market', '_blank')"></i>
                <i class="fas fa-globe hover:text-green-500 transition-colors cursor-pointer"
                    onclick="window.location.href='index.html'"></i>
            </div>
            <p class="text-xs text-gray-400 mt-6">&copy; 2025 S22 Market. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where, orderBy, limit, doc, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let currentSellerId = null;
        let sellerInfo = null;
        let currentProducts = [];
        let currentUser = null;
        let userWishlist = new Set();
        let priceSlider = document.getElementById('price-slider');

        // Elements
        const elements = {
            grid: document.getElementById('products-grid'),
            noProductsMsg: document.getElementById('no-products-msg'),
            searchInput: document.getElementById('search-input'),
            storeHero: document.getElementById('store-hero-section'),
            mainHeader: document.getElementById('main-header'),
            filterSidebar: document.getElementById('filter-sidebar'),
            filterOverlay: document.getElementById('filter-overlay'),
            openFilterBtn: document.getElementById('open-filter-btn'),
            closeFilterBtn: document.getElementById('close-filter-btn'),
            applyFiltersBtn: document.getElementById('apply-filters-btn'),
            resetFiltersBtn: document.getElementById('reset-filters-btn'),
            sidebarSort: document.getElementById('sidebar-sort'),
            priceMinVal: document.getElementById('price-min-val'),
            priceMaxVal: document.getElementById('price-max-val'),
        };

        // Initialize Slider
        noUiSlider.create(priceSlider, {
            start: [0, 50000],
            connect: true,
            range: { 'min': 0, 'max': 50000 },
            step: 500,
            direction: 'rtl',
            format: { to: v => Math.round(v), from: v => Number(v) }
        });

        priceSlider.noUiSlider.on('update', function (values) {
            elements.priceMinVal.textContent = values[0];
            elements.priceMaxVal.textContent = values[1] + (values[1] == 50000 ? '+' : '');
        });

        // Initialize
        async function init() {
            // Check URL for sellerId
            const params = new URLSearchParams(window.location.search);
            currentSellerId = params.get('sellerId');

            if (currentSellerId) {
                await fetchSellerInfo(currentSellerId);
                // Hide main header or styling adjustments could be done here
            } else {
                document.getElementById('section-title').textContent = "ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª";
            }

            // Auth State
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    try {
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        if (userDoc.exists() && userDoc.data().wishlist) {
                            userWishlist = new Set(userDoc.data().wishlist);
                        }
                    } catch (e) { console.error("Wishlist load error", e); }
                } else {
                    currentUser = null;
                    userWishlist.clear();
                }
                if (currentProducts.length > 0) renderProducts(currentProducts);
            });

            await fetchProducts();
            setupEventListeners();
        }

        async function fetchSellerInfo(uid) {
            try {
                const docSnap = await getDoc(doc(db, "users", uid));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    sellerInfo = data;
                    renderStoreHeader(data);
                }
            } catch (e) {
                console.error("Error fetching seller info", e);
            }
        }

        function renderStoreHeader(seller) {
            const storeName = seller.storeName || seller.displayName || "Ù…ØªØ¬Ø±";
            const role = seller.role || 'vendor';
            const type = role === 'restaurant' ? 'Ù…Ø·Ø¹Ù…' : 'Ù…ØªØ¬Ø±';

            // Avatar logic
            const avatar = seller.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(storeName)}&background=random&color=fff&size=128`;

            // Description logic
            const description = (seller.storeRequest && seller.storeRequest.description) ?
                seller.storeRequest.description : "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù…ØªØ¬Ø±Ù†Ø§";

            elements.storeHero.innerHTML = `
                <div class="store-header">
                    <div class="relative z-10">
                        <img src="${avatar}" alt="${storeName}" class="store-avatar">
                        <h1 class="text-3xl sm:text-4xl font-extrabold mb-2">${storeName}</h1>
                        <div class="store-badge">
                            <i class="${role === 'restaurant' ? 'fas fa-utensils' : 'fas fa-store'}"></i>
                            <span>${type} Ù…ÙˆØ«ÙˆÙ‚</span>
                        </div>
                        <p class="mt-4 text-blue-100 max-w-2xl mx-auto text-sm sm:text-base opacity-90 px-4">${description}</p>
                        
                        <div class="mt-6 flex justify-center gap-4">
                             ${seller.storeRequest && seller.storeRequest.links && seller.storeRequest.links.facebook ?
                    `<a href="${seller.storeRequest.links.facebook}" target="_blank" class="bg-white/10 hover:bg-white/20 w-10 h-10 flex items-center justify-center rounded-full transition text-white"><i class="fab fa-facebook text-xl"></i></a>` : ''}
                             ${seller.storeRequest && seller.storeRequest.links && seller.storeRequest.links.instagram ?
                    `<a href="${seller.storeRequest.links.instagram}" target="_blank" class="bg-white/10 hover:bg-white/20 w-10 h-10 flex items-center justify-center rounded-full transition text-white"><i class="fab fa-instagram text-xl"></i></a>` : ''}
                             ${seller.storeRequest && seller.storeRequest.links && seller.storeRequest.links.phone ?
                    `<a href="tel:${seller.storeRequest.links.phone}" class="bg-white/10 hover:bg-white/20 w-10 h-10 flex items-center justify-center rounded-full transition text-white"><i class="fas fa-phone text-xl"></i></a>` : ''}
                        </div>
                    </div>
                </div>
            `;
            elements.storeHero.classList.remove('hidden');
            document.title = `${storeName} - S22 Market`;
            document.getElementById('section-title').textContent = `Ù…Ù†ØªØ¬Ø§Øª ${storeName}`;
        }

        async function fetchProducts() {
            renderSkeletons();
            const productsRef = collection(db, "products");
            let constraints = [];

            // Filter by Seller
            if (currentSellerId) {
                constraints.push(where('sellerId', '==', currentSellerId));
            }

            try {
                // Fetch products
                // We fetch up to 100 products. If filtering by category is needed in future, 
                // we can add where('categoryId', '==', ...) if index exists, or filter client side.
                // For now, simple fetch + client side sort/filter is robust without needing new indexes.
                const q = query(productsRef, ...constraints, limit(100));
                const snapshot = await getDocs(q);

                let products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Apply Sorting
                const sortValue = elements.sidebarSort.value;
                if (sortValue === 'asc') products.sort((a, b) => (a.price || 0) - (b.price || 0));
                else if (sortValue === 'desc') products.sort((a, b) => (b.price || 0) - (a.price || 0));
                else products.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); // Default Desc

                // Apply Price Filter
                const [min, max] = priceSlider.noUiSlider.get().map(Number);
                products = products.filter(p => {
                    const price = p.price || 0;
                    return price >= min && (max === 50000 ? true : price <= max);
                });

                currentProducts = products;
                renderProducts(products);

            } catch (error) {
                console.error("Error fetching products:", error);

                // Fallback for missing index error specifically if we added 'orderBy' with 'where'
                if (error.message.includes('index')) {
                    elements.grid.innerHTML = `<div class="col-span-full text-center text-red-500 py-10">
                        Ù…Ø·Ù„ÙˆØ¨ Ø¥Ù†Ø´Ø§Ø¡ ÙÙ‡Ø±Ø³ (Index) ÙÙŠ Firebase Ù„ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶.<br>
                        <span class="text-xs text-gray-400 font-mono mt-2 block select-all bg-gray-100 p-2 rounded">${error.message}</span>
                     </div>`;
                    return;
                }

                elements.grid.innerHTML = `<div class="col-span-full text-center text-red-500 py-10">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.<br><span class="text-xs text-gray-400">${error.message}</span></div>`;
            }
        }

        function renderSkeletons() {
            elements.grid.innerHTML = Array(6).fill(0).map(() => `
                <div class="bg-white rounded-xl overflow-hidden border border-gray-100 shadow-sm h-72">
                    <div class="h-40 w-full skeleton"></div>
                    <div class="p-4 space-y-3">
                        <div class="h-4 w-3/4 skeleton rounded"></div>
                        <div class="h-4 w-1/2 skeleton rounded"></div>
                        <div class="h-8 w-full skeleton rounded mt-4"></div>
                    </div>
                </div>
            `).join('');
            elements.noProductsMsg.classList.add('hidden');
        }

        function renderProducts(products) {

            // Search Filter
            const term = elements.searchInput.value.toLowerCase().trim();
            const filtered = term ? products.filter(p => p.name.toLowerCase().includes(term)) : products;

            elements.grid.innerHTML = '';

            if (filtered.length === 0) {
                elements.grid.classList.add('hidden');
                elements.noProductsMsg.classList.remove('hidden');
                return;
            }

            elements.grid.classList.remove('hidden');
            elements.noProductsMsg.classList.add('hidden');

            filtered.forEach((product, index) => {
                const card = createProductCard(product);
                card.style.animationDelay = `${index * 50}ms`;
                elements.grid.appendChild(card);
            });
        }

        function createProductCard(product) {
            const image = (product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls[0] : (product.imageUrl || 'https://placehold.co/400x400');
            const card = document.createElement('div');
            // Premium Card Container
            card.className = 'product-card group relative bg-white rounded-2xl overflow-hidden border border-slate-100 hover:border-indigo-100 hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1';
            card.onclick = () => location.href = `PRESENTPRODUCT.html?product=${product.id}`;

            const isLiked = userWishlist.has(product.id);
            const heartClass = isLiked ? 'fas fa-heart text-red-500' : 'far fa-heart text-gray-400';
            const price = (product.price || 0).toLocaleString();

            // Badge Logic
            let badgesContainer = '<div class="absolute top-2 right-2 flex flex-col gap-1 items-end z-10">';

            // New Badge
            if (product.createdAt) {
                const createdDate = product.createdAt.seconds ? new Date(product.createdAt.seconds * 1000) : new Date(product.createdAt);
                const diffDays = Math.ceil(Math.abs(new Date() - createdDate) / (1000 * 60 * 60 * 24));
                if (diffDays <= 7) badgesContainer += `<span class="badge-new">Ø¬Ø¯ÙŠØ¯</span>`;
            }

            // Discount Badge
            if (product.originalPrice && product.originalPrice > product.price) {
                const discount = Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100);
                if (discount > 0) badgesContainer += `<span class="badge-discount bg-red-500 text-white">-${discount}%</span>`;
            }

            // Direct/Other Tags
            if (product.productType === 'direct') {
                badgesContainer += `<span class="bg-indigo-600 text-white text-[10px] px-2 py-1 rounded-md font-bold shadow-sm backdrop-blur">Ù…Ø¨Ø§Ø´Ø±</span>`;
            }

            badgesContainer += '</div>';

            card.innerHTML = `
                <div class="product-image h-48 relative overflow-hidden bg-gray-50">
                    <img src="${image}" alt="${product.name}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" loading="lazy" id="img-${product.id}">
                    
                    ${product.availability === 'sold_out' ? '<div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white font-bold z-20">Ù†ÙØ°Øª Ø§Ù„ÙƒÙ…ÙŠØ©</div>' : ''}
                    
                    ${badgesContainer}

                    <button class="wishlist-btn absolute top-2 left-2 w-9 h-9 bg-white/80 backdrop-blur text-slate-400 hover:text-red-500 hover:bg-white rounded-full flex items-center justify-center shadow-sm transition-all duration-300 z-20" data-id="${product.id}">
                        <i class="${heartClass}"></i>
                    </button>
                    
                    <div class="absolute inset-x-0 bottom-0 p-3 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex justify-end"></div>
                </div>

                <div class="p-4">
                    <div class="mb-2">
                         <span class="text-[10px] text-slate-400 hover:text-indigo-500 transition-colors block mb-1">${product.categoryName || 'Ø¹Ø§Ù…'}</span>
                         <h3 class="text-sm font-bold text-slate-800 line-clamp-2 leading-relaxed h-[2.5rem]">${product.name}</h3>
                    </div>

                    <div class="flex justify-between items-end border-t border-slate-50 pt-3 mt-1">
                        <div class="flex flex-col">
                            ${product.originalPrice && product.originalPrice > product.price ? `<span class="text-[10px] text-slate-400 line-through decoration-red-400">${product.originalPrice.toLocaleString()} Ø¯.Ø¬</span>` : ''}
                            <span class="text-indigo-600 font-extrabold text-base">${price} <span class="text-[10px] font-normal text-slate-500">Ø¯.Ø¬</span></span>
                        </div>
                        
                        <button class="add-to-cart-btn w-9 h-9 rounded-xl bg-orange-50 text-orange-500 hover:bg-orange-500 hover:text-white flex items-center justify-center transition-all duration-300 shadow-sm hover:shadow-orange-200 active:scale-90" 
                            data-id="${product.id}" data-name="${product.name}" data-price="${product.price}" data-img="${image}">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            `;

            // Re-attach listeners using event delegation or direct bind
            const wishBtn = card.querySelector('.wishlist-btn');
            wishBtn.addEventListener('click', handleWishlist);

            const cartBtn = card.querySelector('.add-to-cart-btn');
            cartBtn.addEventListener('click', (e) => {
                e.preventDefault(); e.stopPropagation();
                addToCartWithAnimation(cartBtn, product.id, product.name, product.price, image);
            });

            return card;
        }

        // Helper Handlers
        async function handleWishlist(e) {
            e.preventDefault(); e.stopPropagation();
            if (!currentUser) return alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ”’");

            const btn = e.currentTarget;
            const icon = btn.querySelector('i');
            const id = btn.dataset.id;

            if (userWishlist.has(id)) {
                userWishlist.delete(id);
                icon.className = 'far fa-heart text-gray-400';
                try { await updateDoc(doc(db, "users", currentUser.uid), { wishlist: arrayRemove(id) }); } catch (e) { }
            } else {
                userWishlist.add(id);
                icon.className = 'fas fa-heart text-red-500 animate-bounce';
                try { await updateDoc(doc(db, "users", currentUser.uid), { wishlist: arrayUnion(id) }); } catch (e) { }
            }
        }

        // Animation Function (Consistent with Home)
        function addToCartWithAnimation(btn, id, name, price, img) {
            // 1. Fly Animation
            const cartIcon = document.querySelector('.fa-shopping-cart'); // Header icon
            if (cartIcon) {
                const startRect = btn.getBoundingClientRect();
                const endRect = cartIcon.getBoundingClientRect();

                const flyer = document.createElement('img');
                flyer.src = img;
                flyer.className = 'fly-item';
                flyer.style.left = `${startRect.left}px`;
                flyer.style.top = `${startRect.top}px`;
                document.body.appendChild(flyer);

                // Force flow
                void flyer.offsetWidth;

                flyer.style.left = `${endRect.left}px`;
                flyer.style.top = `${endRect.top}px`;
                flyer.style.width = '20px';
                flyer.style.height = '20px';
                flyer.style.opacity = '0.5';

                setTimeout(() => {
                    flyer.remove();
                    cartIcon.parentElement.classList.add('animate-bounce');
                    setTimeout(() => cartIcon.parentElement.classList.remove('animate-bounce'), 1000);
                }, 800);
            }

            // 2. Storage
            let cart = JSON.parse(localStorage.getItem('s22market_cart')) || [];
            const existing = cart.find(i => i.id === id);
            if (existing) {
                existing.quantity++;
            } else {
                cart.push({ id, name, price, quantity: 1, image: img, sellerId: currentSellerId || 'unknown' });
            }
            localStorage.setItem('s22market_cart', JSON.stringify(cart));

            // 3. UI Update (Wait for animation? No, immediate feedback is better)
            // But we don't have a badge update function globally here.
            // Let's simple check local storage count
            // Or simple toast

            const count = cart.reduce((sum, i) => i.quantity + sum, 0);
            // Updating header badge if exists (we didn't implement badge logic in header HTML yet, let's assume it's there or user will see it on refresh)
            // Actually, main-header has a cart icon.

            // Simple toast
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full text-sm z-50 animate-bounce';
            toast.innerHTML = '<i class="fas fa-check-circle text-green-400"></i> ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        function setupEventListeners() {
            // Search
            elements.searchInput.addEventListener('input', () => renderProducts(currentProducts));

            // Sidebar
            elements.openFilterBtn.onclick = () => { elements.filterSidebar.classList.add('active'); elements.filterOverlay.classList.add('active'); };
            const close = () => { elements.filterSidebar.classList.remove('active'); elements.filterOverlay.classList.remove('active'); };
            elements.closeFilterBtn.onclick = close;
            elements.filterOverlay.onclick = close;

            elements.applyFiltersBtn.onclick = () => {
                fetchProducts(); // Triggers re-sort/filter from scratch or memory
                close();
            };
            elements.resetFiltersBtn.onclick = () => {
                elements.sidebarSort.value = 'default';
                priceSlider.noUiSlider.set([0, 50000]);
                fetchProducts();
                close();
            };
        }

        // Init
        init();

        // Splash Logic
        window.addEventListener('load', () => {
            const spl = document.getElementById('splash-screen');
            if (spl) {
                setTimeout(() => {
                    spl.classList.add('hidden-splash');
                    setTimeout(() => spl.style.display = 'none', 500);
                }, 1000);
            }
        });

    </script>
</body>

</html>