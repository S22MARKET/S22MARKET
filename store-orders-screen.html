<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S22 Kitchen - شاشة المطبخ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #111827;
            color: #f3f4f6;
            overflow-x: hidden;
        }

        /* تأثير النبض للطلبات الجديدة */
        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
                border-color: #ef4444;
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
                border-color: #f87171;
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
                border-color: #ef4444;
            }
        }

        .new-order-card {
            animation: pulse-red 2s infinite;
            border: 2px solid #ef4444;
        }

        /* ألوان الحالات */
        .status-new {
            background-color: #1f2937;
            border-top: 4px solid #3b82f6;
        }

        /* أزرق */
        .status-preparing {
            background-color: #1f2937;
            border-top: 4px solid #f59e0b;
        }

        /* برتقالي */
        .status-completed {
            opacity: 0.5;
            filter: grayscale(1);
        }

        /* باهت */

        /* شاشة البدء (لتفعيل الصوت) */
        .start-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* عداد الوقت */
        .timer-badge {
            font-variant-numeric: tabular-nums;
        }

        /* طباعة */
        @media print {
            .no-print {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            body {
                background: white;
                color: black;
            }
        }
    </style>
</head>

<body class="h-screen flex flex-col">

    <div id="start-overlay" class="start-overlay no-print">
        <i class="fas fa-utensils text-6xl text-orange-500 mb-4 animate-bounce"></i>
        <h1 class="text-3xl font-bold text-white mb-2">S22 Kitchen Display</h1>
        <p class="text-gray-400 mb-8">اضغط للبدء وتفعيل التنبيهات الصوتية</p>
        <button id="start-btn"
            class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-12 rounded-full text-xl shadow-lg transition transform hover:scale-105">
            ابدأ العمل <i class="fas fa-play ml-2"></i>
        </button>
    </div>

    <header class="bg-gray-900 border-b border-gray-800 p-4 flex justify-between items-center no-print">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-black tracking-wider" id="store-name">جاري التحميل...</h1>
            <div id="connection-status"
                class="flex items-center gap-2 px-3 py-1 rounded-full bg-gray-800 text-xs text-gray-400">
                <div class="w-2 h-2 rounded-full bg-red-500" id="status-dot"></div>
                <span id="status-text">غير متصل</span>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right hidden sm:block">
                <div class="text-sm text-gray-400">الطلبات النشطة</div>
                <div class="text-xl font-bold text-white" id="active-count">0</div>
            </div>
            <button onclick="toggleFullScreen()" class="p-2 bg-gray-800 rounded-lg hover:bg-gray-700 text-gray-300">
                <i class="fas fa-expand"></i>
            </button>
        </div>
    </header>

    <main class="flex-1 overflow-x-auto overflow-y-hidden p-4 no-print">
        <div class="flex gap-4 h-full min-w-[1000px]">

            <div class="flex-1 flex flex-col bg-gray-900/50 rounded-xl border border-gray-800 h-full">
                <div class="p-3 border-b border-gray-800 bg-blue-900/20 rounded-t-xl flex justify-between items-center">
                    <h2 class="font-bold text-blue-400 flex items-center gap-2"><i class="fas fa-bell"></i> طلبات جديدة
                    </h2>
                    <span class="bg-blue-900 text-blue-200 text-xs px-2 py-1 rounded-full" id="count-new">0</span>
                </div>
                <div class="flex-1 overflow-y-auto p-2 space-y-3 custom-scrollbar" id="col-new">
                </div>
            </div>

            <div class="flex-1 flex flex-col bg-gray-900/50 rounded-xl border border-gray-800 h-full">
                <div
                    class="p-3 border-b border-gray-800 bg-orange-900/20 rounded-t-xl flex justify-between items-center">
                    <h2 class="font-bold text-orange-400 flex items-center gap-2"><i class="fas fa-fire"></i> قيد
                        التحضير</h2>
                    <span class="bg-orange-900 text-orange-200 text-xs px-2 py-1 rounded-full"
                        id="count-preparing">0</span>
                </div>
                <div class="flex-1 overflow-y-auto p-2 space-y-3 custom-scrollbar" id="col-preparing">
                </div>
            </div>

            <div class="flex-1 flex flex-col bg-gray-900/50 rounded-xl border border-gray-800 h-full opacity-80">
                <div
                    class="p-3 border-b border-gray-800 bg-green-900/20 rounded-t-xl flex justify-between items-center">
                    <h2 class="font-bold text-green-400 flex items-center gap-2"><i class="fas fa-check-circle"></i>
                        جاهز / مكتمل</h2>
                    <span class="bg-green-900 text-green-200 text-xs px-2 py-1 rounded-full"
                        id="count-completed">0</span>
                </div>
                <div class="flex-1 overflow-y-auto p-2 space-y-3 custom-scrollbar" id="col-completed">
                </div>
            </div>

        </div>
    </main>

    <audio id="alert-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-kitchen-order-bell-start-2574.mp3"
        preload="auto"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Config
        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN_EMAILS = [
            's22market@gmail.com',
            'yacinee474474@gmail.com',
            'nourmt01@gmail.com'
        ];

        let currentUser = null;
        let targetSellerId = null; // The ID of the store we are viewing
        let audioAllowed = false;
        const audio = document.getElementById('alert-sound');

        // --- Start Screen ---
        document.getElementById('start-btn').onclick = () => {
            document.getElementById('start-overlay').classList.add('hidden');
            audioAllowed = true;
            // Play empty sound to unlock iOS/Android audio policy
            audio.play().then(() => { audio.pause(); audio.currentTime = 0; });
            toggleFullScreen();
        };

        window.toggleFullScreen = () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => console.log(e));
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        };

        // --- Data Logic ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;

                // 1. Check if user is Admin / or the Seller himself
                const urlParams = new URLSearchParams(window.location.search);
                const paramUid = urlParams.get('uid');

                if (ADMIN_EMAILS.includes(user.email)) {
                    // Admin Mode
                    if (paramUid) {
                        targetSellerId = paramUid;
                        await loadStoreInfo(targetSellerId);
                    } else {
                        // Admin but no specific store selected? redirect or show error
                        // For now let's assume they want to see their own if they have one, or just alert
                        alert("أنت أدمن. يرجى اختيار متجر من لوحة التحكم.");
                        window.location.href = 'admin-sellers.html';
                        return;
                    }
                } else {
                    // Normal Seller/Restaurant
                    targetSellerId = user.uid;
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists() && (userDoc.data().role === 'restaurant' || userDoc.data().role === 'vendor')) {
                        document.getElementById('store-name').textContent = userDoc.data().storeName || 'المطبخ';
                    } else {
                        alert("غير مصرح لك بالدخول");
                        window.location.href = 'index.html';
                        return;
                    }
                }

                initOrdersListener();

            } else {
                window.location.href = 'login.html';
            }
        });

        async function loadStoreInfo(uid) {
            const userDoc = await getDoc(doc(db, "users", uid));
            if (userDoc.exists()) {
                document.getElementById('store-name').textContent = (userDoc.data().storeName || 'المطبخ') + " (عرض أدمن)";
            }
        }

        function initOrdersListener() {
            // Fix: Remove orderBy to avoid "The query requires an index" error
            const q = query(
                collection(db, "orders"),
                where("sellerId", "==", targetSellerId)
            );

            onSnapshot(q, (snapshot) => {
                // Update Connection Status
                document.getElementById('status-dot').className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
                document.getElementById('status-text').textContent = "متصل مباشر";

                // Clear Columns
                document.getElementById('col-new').innerHTML = '';
                document.getElementById('col-preparing').innerHTML = '';
                document.getElementById('col-completed').innerHTML = '';

                let counts = { new: 0, preparing: 0, completed: 0 };
                let hasNewOrders = false;

                // 2. Client-side Sort (descending by createdAt)
                let docs = [];
                snapshot.forEach(d => docs.push({ id: d.id, ...d.data() }));

                docs.sort((a, b) => {
                    const tA = a.createdAt?.seconds || 0;
                    const tB = b.createdAt?.seconds || 0;
                    return tB - tA; // DESC
                });

                docs.forEach(order => {
                    // Filter out very old completed orders (keep only today's)
                    const isToday = order.createdAt?.toDate().toDateString() === new Date().toDateString();
                    if (order.status === 'completed' && !isToday) return;

                    const card = createOrderCard(order);

                    if (order.status === 'new') {
                        document.getElementById('col-new').appendChild(card);
                        counts.new++;
                        hasNewOrders = true;
                    } else if (order.status === 'preparing') {
                        document.getElementById('col-preparing').appendChild(card);
                        counts.preparing++;
                    } else if (order.status === 'completed') {
                        document.getElementById('col-completed').appendChild(card);
                        counts.completed++;
                    } else if (order.status === 'canceled') {
                        // Optional: Show canceled
                    }
                });

                // Update Counters
                document.getElementById('count-new').textContent = counts.new;
                document.getElementById('count-preparing').textContent = counts.preparing;
                document.getElementById('count-completed').textContent = counts.completed;
                document.getElementById('active-count').textContent = counts.new + counts.preparing;

                // Play Sound if new orders exist
                if (hasNewOrders && audioAllowed) {
                    audio.play().catch(e => console.log("Audio blocked"));
                }

            }, (error) => {
                console.error(error);
                document.getElementById('status-dot').className = "w-2 h-2 rounded-full bg-red-500";
                document.getElementById('status-text').textContent = "انقطع الاتصال";
            });
        }

        function createOrderCard(order) {
            const el = document.createElement('div');
            const timeElapsed = Math.floor((new Date() - order.createdAt.toDate()) / 60000); // Minutes

            let timeColor = "text-gray-400";
            if (timeElapsed > 15 && order.status !== 'completed') timeColor = "text-orange-500 font-bold";
            if (timeElapsed > 30 && order.status !== 'completed') timeColor = "text-red-500 font-black animate-pulse";

            const isNew = order.status === 'new' ? 'new-order-card' : '';

            // Build Items List
            const itemsHtml = order.items.map(item => `
                <div class="flex justify-between items-start py-1 border-b border-gray-700 last:border-0">
                    <div>
                        <span class="font-bold text-white text-lg">${item.quantity}x</span> 
                        <span class="text-gray-300 text-lg">${item.name}</span>
                        ${item.cookingInstructions ? `<div class="text-xs text-yellow-400 mt-1"><i class="fas fa-comment"></i> ${item.cookingInstructions}</div>` : ''}
                    </div>
                </div>
            `).join('');

            el.className = `bg-gray-800 rounded-lg p-4 shadow-lg ${isNew} flex flex-col gap-3`;
            el.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-bold text-xl text-white">#${order.id.substring(0, 4)}</h3>
                        <p class="text-sm text-gray-400">${order.customerName}</p>
                    </div>
                    <div class="text-left">
                        <div class="${timeColor} text-sm"><i class="far fa-clock"></i> ${timeElapsed} دقيقة</div>
                        <div class="text-xs text-gray-500">${order.createdAt.toDate().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}</div>
                    </div>
                </div>
                
                <div class="bg-gray-900/50 rounded p-2">
                    ${itemsHtml}
                </div>

                <div class="mt-auto pt-2 flex gap-2">
                    ${getActionButtons(order)}
                    <button onclick="printTicket('${order.id}')" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-lg"><i class="fas fa-print"></i></button>
                </div>
            `;
            return el;
        }

        function getActionButtons(order) {
            if (order.status === 'new') {
                return `<button onclick="updateStatus('${order.id}', 'preparing')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg">بدء التحضير</button>`;
            } else if (order.status === 'preparing') {
                return `<button onclick="updateStatus('${order.id}', 'completed')" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg">جاهز / مكتمل</button>`;
            } else {
                return `<button disabled class="flex-1 bg-gray-700 text-gray-500 font-bold py-2 rounded-lg cursor-not-allowed">مكتمل</button>`;
            }
        }

        // Global functions for HTML onclick
        window.updateStatus = async (id, status) => {
            try {
                await updateDoc(doc(db, "orders", id), { status: status });
            } catch (e) { console.error(e); }
        };

        window.printTicket = async (id) => {
            // (نفس كود الطباعة من seller-dashboard.html ولكن بتنسيق أصغر للطابعات الحرارية)
            const docSnap = await getDoc(doc(db, "orders", id));
            if (!docSnap.exists()) return;
            const order = docSnap.data();

            const printWindow = window.open('', '', 'width=300,height=600');
            printWindow.document.write(`
                <html dir="rtl"><body style="font-family: monospace; width: 58mm; margin: 0; padding: 5px; font-size: 12px; font-weight:bold;">
                    <div style="text-align:center; border-bottom: 2px dashed black; padding-bottom: 5px;">
                        <h2 style="margin:0; font-size: 16px;">S22 Kitchen</h2>
                        <h1 style="margin:5px 0; font-size: 24px;">#${id.substring(0, 4)}</h1>
                    </div>
                    <div style="margin: 10px 0;">
                        ${order.items.map(i => `
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size: 14px;">
                                <span>${i.quantity}x ${i.name}</span>
                            </div>
                            ${i.cookingInstructions ? `<div style="font-size:10px;">* ${i.cookingInstructions}</div>` : ''}
                        `).join('')}
                    </div>
                    <div style="border-top: 2px dashed black; padding-top: 5px; text-align:center;">
                        ${new Date().toLocaleString('ar-EG')}
                    </div>
                </body></html>
            `);
            printWindow.print();
            printWindow.close();
        };

    </script>
</body>

</html>