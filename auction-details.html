<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ø¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
        }

        .bid-item {
            transition: all 0.3s ease;
        }

        .bid-item:first-child {
            background-color: #e0e7ff;
            border-right: 4px solid #4f46e5;
        }
    </style>
</head>

<body class="pb-24">

    <header class="bg-white shadow-sm sticky top-0 z-50 px-4 py-3 flex items-center justify-between">
        <button onclick="history.back()" class="text-gray-600 text-xl"><i class="fas fa-arrow-right"></i></button>
        <h1 class="text-lg font-bold text-gray-800">ØºØ±ÙØ© Ø§Ù„Ù…Ø²Ø§Ø¯</h1>
        <div class="w-8"></div>
    </header>

    <main id="auction-content" class="max-w-lg mx-auto p-4 hidden">

        <!-- Product Info -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-4">
            <div id="product-image" class="h-56 bg-gray-200 bg-cover bg-center"></div>
            <div class="p-4">
                <div class="flex justify-between items-start">
                    <h2 id="product-title" class="text-xl font-bold text-gray-900 mb-2"></h2>
                    <span id="auction-status"
                        class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded">Ù†Ø´Ø·</span>
                </div>
                <p id="product-desc" class="text-gray-600 text-sm mb-4"></p>

                <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center text-center">
                    <div>
                        <span class="text-xs text-gray-500">Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø­Ø§Ù„ÙŠØ§Ù‹</span>
                        <div id="current-price" class="text-2xl font-black text-indigo-600">...</div>
                    </div>
                    <div>
                        <span class="text-xs text-gray-500">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span>
                        <div id="timer" class="text-lg font-bold text-red-500">...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bids History -->
        <h3 class="font-bold text-gray-700 mb-3 px-1">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø²Ø§ÙŠØ¯Ø§Øª (Ù…Ø¨Ø§Ø´Ø±)</h3>
        <div id="bids-list" class="space-y-3 mb-20">
            <!-- Bids injected here -->
            <div class="text-center py-4 text-gray-400 text-sm">ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ²Ø§ÙŠØ¯!</div>
        </div>

    </main>

    <!-- Loading State -->
    <div id="loading" class="text-center py-20">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mx-auto"></div>
    </div>

    <!-- Bidding Footer -->
    <div id="bid-footer" class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-lg hidden">
        <div class="max-w-lg mx-auto flex gap-3">
            <input type="number" id="bid-amount"
                class="flex-grow border rounded-lg px-4 py-2 text-lg font-bold outline-none ring-offset-2 focus:ring-2 focus:ring-indigo-500"
                placeholder="Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø±Ùƒ...">
            <button id="place-bid-btn"
                class="bg-indigo-600 text-white font-bold px-6 py-2 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed">
                Ø²Ø§ÙŠØ¯ Ø§Ù„Ø¢Ù†
            </button>
        </div>
    </div>

    <!-- Login Modal Trigger (Hidden) -->
    <div id="toast-container"></div>

    <script type="module">
        import { db, doc, onSnapshot, collection, addDoc, serverTimestamp, orderBy, query, limit, updateDoc } from './js/firebase-config.js';
        import { auth } from './js/firebase-config.js';
        import { showToast } from './js/ui-utils.js';

        const params = new URLSearchParams(window.location.search);
        const auctionId = params.get('id');
        let currentHighestPrice = 0;
        let isAuctionActive = false;

        if (!auctionId) {
            alert("Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø²Ø§Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­");
            window.location.href = 'auctions.html';
        }

        const auctionRef = doc(db, "auctions", auctionId);
        const bidsRef = collection(db, "auctions", auctionId, "bids");

        // 1. Listen to Auction Details
        onSnapshot(auctionRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                renderAuctionDetails(data);
                isAuctionActive = data.status === 'active';
                updateFooterState();
            } else {
                document.body.innerHTML = "<p class='text-center py-10'>Ø§Ù„Ù…Ø²Ø§Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</p>";
            }
        });

        // 2. Listen to Bids (Real-time)
        const q = query(bidsRef, orderBy("amount", "desc"), limit(20));
        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('bids-list');
            list.innerHTML = '';

            if (snapshot.empty) {
                list.innerHTML = '<div class="text-center py-4 text-gray-400 text-sm">ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ²Ø§ÙŠØ¯!</div>';
                return;
            }

            snapshot.forEach(doc => {
                const bid = doc.data();
                const isMe = auth.currentUser && bid.userId === auth.currentUser.uid;

                const item = document.createElement('div');
                item.className = `bid-item bg-white p-3 rounded-lg shadow-sm flex justify-between items-center ${isMe ? 'border border-indigo-200 bg-indigo-50' : ''}`;
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-xs">
                            ${bid.userName ? bid.userName.charAt(0) : 'U'}
                        </div>
                        <div>
                            <p class="font-bold text-sm text-gray-800">${isMe ? 'Ø£Ù†Øª' : (bid.userName || 'Ù…Ø³ØªØ®Ø¯Ù…')}</p>
                            <p class="text-xs text-gray-400">${bid.timestamp?.toDate ? bid.timestamp.toDate().toLocaleTimeString('ar-DZ') : 'Ø§Ù„Ø¢Ù†'}</p>
                        </div>
                    </div>
                    <div class="font-bold text-indigo-600">${bid.amount.toLocaleString()} Ø¯.Ø¬</div>
                `;
                list.appendChild(item);
            });
        });

        function renderAuctionDetails(data) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('auction-content').classList.remove('hidden');

            document.getElementById('product-title').textContent = data.title;
            document.getElementById('product-desc').textContent = data.description;
            if (data.imageUrl) document.getElementById('product-image').style.backgroundImage = `url('${data.imageUrl}')`;

            const price = data.currentPrice || data.startPrice || 0;
            currentHighestPrice = price;
            document.getElementById('current-price').textContent = `${price.toLocaleString()} Ø¯.Ø¬`;

            // Timer Logic
            if (data.endTime) {
                const end = data.endTime.toDate();
                const updateTimer = () => {
                    const now = new Date();
                    const diff = end - now;
                    if (diff <= 0) {
                        document.getElementById('timer').textContent = "Ø§Ù†ØªÙ‡Ù‰";
                        isAuctionActive = false;
                        updateFooterState();
                    } else {
                        const h = Math.floor(diff / (1000 * 60 * 60));
                        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const s = Math.floor((diff % (1000 * 60)) / 1000);
                        document.getElementById('timer').textContent = `${h}:${m}:${s}`;
                    }
                };
                updateTimer();
                setInterval(updateTimer, 1000);
            }
        }

        function updateFooterState() {
            const footer = document.getElementById('bid-footer');
            if (isAuctionActive) {
                footer.classList.remove('hidden');
            } else {
                footer.classList.add('hidden');
            }
        }

        // 3. Place Bid Logic
        document.getElementById('place-bid-btn').addEventListener('click', async () => {
            const amountInput = document.getElementById('bid-amount');
            const amount = parseFloat(amountInput.value);
            const user = auth.currentUser;

            if (!user) {
                showToast("ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø²Ø§ÙŠØ¯Ø©", false);
                // Ideally redirect to login or show modal
                setTimeout(() => window.location.href = 'login.html', 1500);
                return;
            }

            if (!amount || amount <= currentHighestPrice) {
                showToast(`ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø³Ø¹Ø± Ø£Ø¹Ù„Ù‰ Ù…Ù† ${currentHighestPrice}`, false);
                return;
            }

            const btn = document.getElementById('place-bid-btn');
            btn.disabled = true;
            btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

            try {
                // Determine Minimum Increment (Example 50 DA)
                const minIncrement = 50;
                if (amount < currentHighestPrice + minIncrement) {
                    throw new Error(`Ø£Ù‚Ù„ Ù…Ø¨Ù„Øº Ù„Ù„Ø²ÙŠØ§Ø¯Ø© Ù‡Ùˆ ${minIncrement} Ø¯.Ø¬`);
                }

                // Add Bid to Subcollection
                await addDoc(bidsRef, {
                    amount: amount,
                    userId: user.uid,
                    userName: user.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…',
                    timestamp: serverTimestamp()
                });

                // Update Main Auction Doc
                // Note: In a real app, use a Cloud Function or Transaction to prevent race conditions!
                // For this prototype, client-side update is acceptable but risky.
                await updateDoc(auctionRef, {
                    currentPrice: amount,
                    lastBidderId: user.uid
                });

                showToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶Ùƒ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰");
                amountInput.value = '';

            } catch (error) {
                console.error("Bid Error:", error);
                showToast(error.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø²Ø§ÙŠØ¯Ø©", false);
            } finally {
                btn.disabled = false;
                btn.textContent = "Ø²Ø§ÙŠØ¯ Ø§Ù„Ø¢Ù†";
            }
        });

    </script>
</body>

</html>