<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S22 Auctions - ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ø¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="app-style.css">

    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
            padding-bottom: 90px;
        }

        .auction-image-container {
            position: relative;
            height: 300px;
            background-color: #1f2937;
            overflow: hidden;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .auction-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .live-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(220, 38, 38, 0.9);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(4px);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }

            100% {
                opacity: 1;
            }
        }

        .timer-card {
            background: white;
            border-radius: 16px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin: -40px 20px 20px;
            position: relative;
            z-index: 10;
            border: 1px solid #f1f5f9;
        }

        .countdown {
            font-family: monospace;
            font-size: 1.8rem;
            font-weight: 800;
            color: #dc2626;
            letter-spacing: 2px;
        }

        .bid-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin: 0 20px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            border: 1px solid #f1f5f9;
        }

        .bid-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
            animation: slideIn 0.3s ease-out;
        }

        .bid-history-item:last-child {
            border-bottom: none;
        }

        .top-bidder {
            background-color: #f0fdf4;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #bbf7d0;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Floating Action Bar */
        .bid-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
            z-index: 50;
            display: flex;
            gap: 10px;
            align-items: center;
            padding-bottom: max(15px, env(safe-area-inset-bottom));
        }
    </style>
</head>

<body>

    <a href="auctions.html"
        class="fixed top-4 left-4 z-30 w-10 h-10 bg-white/80 backdrop-blur rounded-full flex items-center justify-center text-gray-800 shadow-lg hover:bg-white">
        <i class="fas fa-arrow-left"></i>
    </a>

    <div id="page-loader" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-red-200 border-t-red-600 rounded-full animate-spin"></div>
    </div>

    <main id="main-content" class="hidden">

        <div class="auction-image-container">
            <img id="auction-img" src="" class="auction-image" alt="Product">
            <div class="live-badge"><span class="w-2 h-2 bg-white rounded-full animate-ping"></span> Ù…Ø¨Ø§Ø´Ø±</div>
            <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
        </div>

        <div class="timer-card">
            <p class="text-xs text-gray-500 mb-1">ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ù…Ø²Ø§Ø¯ Ø®Ù„Ø§Ù„</p>
            <div id="countdown" class="countdown">00:00:00</div>
        </div>

        <div class="px-5 mb-6">
            <h1 id="auction-title" class="text-2xl font-black text-gray-900 mb-2">...</h1>
            <p id="auction-desc" class="text-gray-600 text-sm leading-relaxed">...</p>
            <div class="flex items-center gap-2 mt-3 text-sm text-gray-500">
                <i class="fas fa-store text-indigo-500"></i> <span id="seller-name">Ù…ØªØ¬Ø± S22</span>
            </div>
        </div>

        <div class="bid-card bg-gradient-to-r from-gray-900 to-gray-800 text-white border-none">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-gray-400 text-sm">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
                    <div class="text-4xl font-black text-yellow-400 flex items-baseline gap-1">
                        <span id="current-price">0</span> <span class="text-lg font-medium">Ø¯.Ø¬</span>
                    </div>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-400">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø²Ø§ÙŠØ¯Ø§Øª</p>
                    <p id="bids-count" class="font-bold text-xl">0</p>
                </div>
            </div>
        </div>

        <div class="bid-card">
            <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-history text-gray-400"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…Ø²Ø§ÙŠØ¯Ø§Øª
            </h3>
            <div id="bids-list" class="space-y-1">
                <p class="text-center text-gray-400 text-sm py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø²Ø§ÙŠØ¯Ø§Øª Ø¨Ø¹Ø¯. ÙƒÙ† Ø§Ù„Ø£ÙˆÙ„!</p>
            </div>
        </div>

    </main>

    <div class="bid-bar" id="bid-bar">
        <div class="flex-1">
            <div class="flex gap-2 mb-2 overflow-x-auto no-scrollbar pb-1">
                <button onclick="setBidAmount(100)"
                    class="bg-gray-100 px-3 py-1 rounded-full text-xs font-bold text-gray-600 hover:bg-gray-200">+100</button>
                <button onclick="setBidAmount(500)"
                    class="bg-gray-100 px-3 py-1 rounded-full text-xs font-bold text-gray-600 hover:bg-gray-200">+500</button>
                <button onclick="setBidAmount(1000)"
                    class="bg-gray-100 px-3 py-1 rounded-full text-xs font-bold text-gray-600 hover:bg-gray-200">+1000</button>
            </div>
            <input type="number" id="bid-amount"
                class="w-full bg-gray-50 border border-gray-300 rounded-xl px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-red-500 font-bold"
                placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº...">
        </div>
        <button id="place-bid-btn"
            class="bg-red-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg shadow-red-200 hover:bg-red-700 transition transform hover:scale-105 active:scale-95">
            <i class="fas fa-gavel text-xl"></i>
        </button>
    </div>

    <div id="auth-modal"
        class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl w-[90%] max-w-sm text-center shadow-2xl">
            <i class="fas fa-lock text-4xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-bold mb-2">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„Ù…Ø²Ø§ÙŠØ¯Ø©</h3>
            <p class="text-gray-500 text-sm mb-6">ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¹Ø¶ÙˆØ§Ù‹ Ù…Ø³Ø¬Ù„Ø§Ù‹ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ø¯Ø§Øª.</p>
            <a href="login.html"
                class="block w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700">ØªØ³Ø¬ÙŠÙ„
                Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
            <button onclick="document.getElementById('auth-modal').classList.add('hidden')"
                class="mt-4 text-gray-400 text-sm">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-24 left-1/2 -translate-x-1/2 z-[70]"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let auctionId = new URLSearchParams(window.location.search).get('product'); // using 'product' param as per logic
        if (!auctionId) auctionId = new URLSearchParams(window.location.search).get('id'); // fallback

        let auctionData = null;
        let currentHighest = 0;

        // --- Init ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            initAuction();
        });

        async function initAuction() {
            if (!auctionId) { alert("Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­"); window.location.href = 'auctions.html'; return; }

            // 1. Listen to Auction Data (Real-time)
            // Try 'auctions' collection first (legacy logic support)
            // Or 'products' where type is auction. Based on previous code, let's assume 'auctions' collection for active auctions logic.
            // If you created auction in 'products' collection, change this to 'products'.
            // In seller-dashboard, we saved to 'auctions' collection. So we listen there.

            const auctionRef = doc(db, "auctions", auctionId);

            onSnapshot(auctionRef, (docSnap) => {
                if (!docSnap.exists()) {
                    // Try products fallback just in case
                    return;
                }

                auctionData = docSnap.data();
                renderAuctionInfo(auctionData);

                // If auction ended
                const endTime = auctionData.endTime?.toDate();
                if (endTime && new Date() > endTime) {
                    endAuctionUI();
                }
            });

            // 2. Listen to Bids
            const bidsRef = collection(db, "auctions", auctionId, "bids");
            const q = query(bidsRef, orderBy("amount", "desc"));

            onSnapshot(q, (snapshot) => {
                const bidsList = document.getElementById('bids-list');
                bidsList.innerHTML = '';

                const bids = snapshot.docs.map(d => d.data());
                document.getElementById('bids-count').textContent = bids.length;

                if (bids.length > 0) {
                    currentHighest = bids[0].amount;
                    document.getElementById('current-price').textContent = currentHighest.toLocaleString();

                    bids.forEach((bid, index) => {
                        const isTop = index === 0;
                        const row = document.createElement('div');
                        row.className = `bid-history-item ${isTop ? 'top-bidder' : ''}`;
                        const time = bid.timestamp?.toDate().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) || '';

                        row.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-600">
                                    ${bid.userName ? bid.userName.charAt(0) : 'U'}
                                </div>
                                <div>
                                    <p class="font-bold text-sm text-gray-800">${bid.userName || 'Ù…Ø³ØªØ®Ø¯Ù…'}</p>
                                    <p class="text-[10px] text-gray-400">${time}</p>
                                </div>
                            </div>
                            <div class="font-black ${isTop ? 'text-green-600' : 'text-gray-600'}">
                                ${bid.amount.toLocaleString()} Ø¯.Ø¬ ${isTop ? 'ğŸ”¥' : ''}
                            </div>
                        `;
                        bidsList.appendChild(row);
                    });
                } else {
                    currentHighest = auctionData?.startPrice || 0;
                    document.getElementById('current-price').textContent = currentHighest.toLocaleString();
                    bidsList.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ²Ø§ÙŠØ¯!</p>';
                }
            });

            document.getElementById('page-loader').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        }

        function renderAuctionInfo(data) {
            document.title = data.title || 'Ù…Ø²Ø§Ø¯';
            document.getElementById('auction-title').textContent = data.title;
            document.getElementById('auction-desc').textContent = data.description;
            document.getElementById('auction-img').src = data.imageUrl || 'https://placehold.co/400';

            // Timer Logic
            const endTime = data.endTime?.toDate();
            if (endTime) {
                const timerInterval = setInterval(() => {
                    const now = new Date();
                    const diff = endTime - now;

                    if (diff <= 0) {
                        clearInterval(timerInterval);
                        document.getElementById('countdown').textContent = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ù…Ø²Ø§Ø¯";
                        document.getElementById('countdown').classList.add('text-gray-500');
                        endAuctionUI();
                    } else {
                        const h = Math.floor(diff / (1000 * 60 * 60));
                        const m = Math.floor((diff / (1000 * 60)) % 60);
                        const s = Math.floor((diff / 1000) % 60);
                        document.getElementById('countdown').textContent = `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                    }
                }, 1000);
            }
        }

        function endAuctionUI() {
            const bar = document.getElementById('bid-bar');
            bar.innerHTML = `<div class="w-full text-center font-bold text-white bg-gray-800 py-3 rounded-xl">â›” Ø§Ù†ØªÙ‡Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø²Ø§Ø¯</div>`;
        }

        // --- Bidding Logic ---

        window.setBidAmount = (amount) => {
            const input = document.getElementById('bid-amount');
            input.value = currentHighest + amount;
        };

        document.getElementById('place-bid-btn').addEventListener('click', async () => {
            if (!currentUser) {
                document.getElementById('auth-modal').classList.remove('hidden');
                return;
            }

            const input = document.getElementById('bid-amount');
            const amount = parseFloat(input.value);
            const btn = document.getElementById('place-bid-btn');

            if (!amount || amount <= currentHighest) {
                showToast(`ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø¨Ù„Øº Ø£Ø¹Ù„Ù‰ Ù…Ù† ${currentHighest} Ø¯.Ø¬`, false);
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                // Use Transaction for Safety
                await runTransaction(db, async (transaction) => {
                    const sfDoc = await transaction.get(doc(db, "auctions", auctionId));
                    if (!sfDoc.exists()) throw "Ø§Ù„Ù…Ø²Ø§Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!";

                    const data = sfDoc.data();
                    const liveHighest = data.currentPrice || data.startPrice || 0;

                    if (amount <= liveHighest) {
                        throw "Ø¹Ø°Ø±Ø§Ù‹ØŒ ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ù‚Ø¨Ù„ Ø´Ø®Øµ Ø¢Ø®Ø± Ù„Ù„ØªÙˆ!";
                    }

                    // 1. Add Bid
                    const newBidRef = doc(collection(db, "auctions", auctionId, "bids"));
                    transaction.set(newBidRef, {
                        amount: amount,
                        userId: currentUser.uid,
                        userName: currentUser.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…',
                        timestamp: serverTimestamp()
                    });

                    // 2. Update Auction Price
                    transaction.update(doc(db, "auctions", auctionId), {
                        currentPrice: amount,
                        lastBidderId: currentUser.uid
                    });
                });

                showToast('ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§ÙŠØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰');
                input.value = '';
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });

            } catch (error) {
                console.error(error);
                showToast(typeof error === 'string' ? error : 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø§', false);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-gavel text-xl"></i>';
            }
        });

        function showToast(msg, success = true) {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `${success ? 'bg-green-600' : 'bg-red-600'} text-white px-6 py-3 rounded-xl shadow-lg font-bold flex items-center gap-2 animate-bounce`;
            el.innerHTML = `<i class="fas ${success ? 'fa-check' : 'fa-exclamation-circle'}"></i> ${msg}`;
            container.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

    </script>
</body>

</html>