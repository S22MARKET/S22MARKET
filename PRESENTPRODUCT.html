<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --secondary-color: #10b981;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --border-color: #e2e8f0;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
        }

        html {
            scroll-behavior: smooth;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(20px);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 0.5rem;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .fade-in-up {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        .small-loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
            padding: 1rem;
            backdrop-filter: blur(5px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-backdrop.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: var(--bg-card);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            width: 100%;
            max-width: 700px;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: scaleIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            border-radius: 1rem;
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .modal-backdrop.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .main-image-container {
            aspect-ratio: 1 / 1;
            cursor: zoom-in;
        }

        .thumbnail {
            aspect-ratio: 1 / 1;
            border: 2px solid transparent;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .thumbnail:hover {
            border-color: var(--primary-hover);
        }

        .thumbnail.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.375rem;
        }

        #lightbox {
            display: none;
            position: fixed;
            z-index: 1000;
            inset: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
        }

        #lightbox.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #lightbox img {
            max-width: 90%;
            max-height: 80%;
            object-fit: contain;
        }

        #lightbox .close-btn {
            position: absolute;
            top: 2rem;
            right: 2rem;
            font-size: 2.5rem;
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .close-btn:hover {
            transform: scale(1.1);
        }

        #toast-container {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            width: calc(100% - 2rem);
            max-width: 400px;
        }

        @media (min-width: 640px) {
            #toast-container {
                bottom: 20px;
            }
        }

        .toast {
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            color: white;
            background-color: var(--secondary-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideInUp 0.5s, fadeOut 0.5s 4.5s forwards;
        }

        .toast.error {
            background-color: #ef4444;
        }

        #seller-social-links a {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #f1f5f9;
            color: #475569;
            font-size: 1.25rem;
            transition: all 0.2s ease;
        }

        #seller-social-links a:hover {
            background-color: #dbeafe;
            color: #2563eb;
            transform: scale(1.1);
        }

        /* Restaurant View Styles */
        .restaurant-product-view {
            animation: fadeIn 0.5s ease-out;
        }

        @media (max-width: 768px) {
            .restaurant-product-view {
                padding: 0.5rem;
            }

            .restaurant-product-view .product-info {
                background: white;
                border-radius: 1rem;
                padding: 1rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            }
        }
    </style>

    < !-- Splash Screen Styles -->
        <style>
            #splash-screen {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                transition: opacity 0.5s ease-out, visibility 0.5s;
            }

            #splash-screen.hidden-splash {
                opacity: 0;
                visibility: hidden;
            }

            .splash-content {
                text-align: center;
                color: white;
                animation: scaleIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }

            .splash-logo {
                font-size: 3rem;
                font-weight: 800;
                margin-bottom: 1rem;
                text-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            .splash-loader {
                width: 40px;
                height: 40px;
                border: 4px solid rgba(255, 255, 255, 0.3);
                border-top-color: white;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto;
            }

            /* Mobile Improvements */
            .app-touch {
                touch-action: manipulation;
                user-select: none;
                -webkit-user-select: none;
                -webkit-tap-highlight-color: transparent;
            }

            /* Bottom Navbar */
            .bottom-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-top: 1px solid var(--border-color);
                display: flex;
                justify-content: space-around;
                padding: 0.75rem 0.5rem;
                padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));
                z-index: 2000;
                /* Higher than sticky bar if present? No, sticky bar usually replaces it on product page. */
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
            }

            /* Hide bottom nav when sticky action bar is present on product page (optional, but usually good to have both if space allows, or hide nav) */
            /* In this specific product page, we have a "mobile-sticky-bar" for cart actions. 
           We might want to merge them or hide the general nav. 
           Let's keep the general nav hidden on this specific page active view if sticky bar is visible?
           Actually, sticky cart bar is crucial. Let's make bottom-nav HIDDEN on mobile for this page specifically, 
           OR push the sticky bar up? 
           The user wants "Mowiyat" like classproductindex. 
           Let's add it but handle z-index. Sticky bar is z-40. Nav is z-50.
           Sticky bar contains "Buy" buttons. It's more important here.
           Let's NOT add the global bottom nav to the PRODUCT page if it conflicts with the "Buy" bar.
           Alternatively, we can put the "Buy" bar ABOVE the bottom nav.
        */
            .bottom-nav-spacer {
                height: 70px;
            }

            /* Back to Top */
            #back-to-top {
                position: fixed;
                bottom: 90px;
                right: 20px;
                background: var(--primary-color);
                color: white;
                width: 44px;
                height: 44px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
                opacity: 0;
                pointer-events: none;
                transition: all 0.3s;
                z-index: 1000;
                border: none;
                cursor: pointer;
            }

            #back-to-top.visible {
                opacity: 1;
                pointer-events: auto;
                transform: translateY(0);
            }

            /* Pull Refresh Spinner */
            #pull-refresh-spinner {
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 2000;
                background: white;
                border-radius: 50%;
                padding: 10px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                display: none;
                animation: spin 1s linear infinite;
            }

            /* Customize Sticky Bar for Mobile */
            @media (max-width: 1024px) {
                #mobile-sticky-bar {
                    padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));
                    z-index: 5000;
                    /* Always on top */
                }

                main {
                    padding-bottom: 100px;
                }

                /* Ensure content isn't hidden */
            }
        </style>

<body class="app-touch">
    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="splash-content">
            <div class="splash-logo">S22<span class="text-blue-200">MARKET</span></div>
            <div class="splash-loader"></div>
            <p class="mt-4 text-blue-100 text-sm font-medium">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²...</p>
        </div>
    </div>

    <div id="pull-refresh-spinner"><i class="fas fa-spinner fa-spin text-blue-600 text-xl"></i></div>

    <header id="main-header" class="bg-white shadow-sm sticky top-0 z-50 transition-transform duration-300">
        <div class="max-w-7xl mx-auto py-3 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <button onclick="goBack()" class="text-2xl text-gray-600 hover:text-blue-600">
                <i class="fas fa-arrow-right"></i>
            </button>
            <h1 onclick="location.href='index.html'"
                class="cursor-pointer text-xl sm:text-2xl md:text-3xl font-bold text-gray-800">
                S22<span class="text-blue-600">MARKET</span>
            </h1>
            <button id="cart-btn" class="relative text-2xl text-gray-600 hover:text-blue-600">
                <i class="fas fa-shopping-cart"></i>
            </button>
        </div>
    </header>

    <main id="page-content" class="max-w-7xl mx-auto py-6 sm:py-8 md:py-10 px-4 sm:px-6 lg:px-8 hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
            <div id="product-gallery">
                <div
                    class="main-image-container bg-white rounded-lg shadow-md flex items-center justify-center p-2 overflow-hidden">
                    <img id="main-product-image" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" class="w-full h-full object-contain"
                        loading="lazy">
                </div>
                <div id="thumbnails" class="grid grid-cols-4 sm:grid-cols-5 gap-3 mt-4"></div>
            </div>
            <div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-start gap-4">
                        <h1 id="product-name"
                            class="flex-grow text-3xl lg:text-4xl font-extrabold text-slate-800 leading-tight"></h1>

                        <div class="flex items-center gap-2 sm:gap-3 flex-shrink-0">
                            <button id="copy-link-btn" title="Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·" class="w-10 h-10 sm:w-12 sm:h-12 rounded-full 
                                           bg-slate-50 border border-slate-200 text-slate-600 
                                           hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 hover:shadow-lg 
                                           focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 
                                           flex items-center justify-center 
                                           text-lg sm:text-xl transition-all duration-200">
                                <i class="fas fa-link"></i>
                            </button>
                            <button id="share-btn" title="Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù†ØªØ¬" class="w-10 h-10 sm:w-12 sm:h-12 rounded-full 
                                           bg-slate-50 border border-slate-200 text-slate-600 
                                           hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 hover:shadow-lg 
                                           focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 
                                           flex items-center justify-center 
                                           text-lg sm:text-xl transition-all duration-200">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        </div>

                    </div>
                    <p id="product-location-container" class="text-slate-500 text-md mt-2 mb-4 hidden"><i
                            class="fas fa-map-marker-alt fa-fw mr-1 text-slate-400"></i><span
                            id="product-location"></span></p>
                    <div class="my-6"><span id="product-price" class="text-blue-600 text-5xl font-extrabold"></span>
                    </div>
                    <div id="product-buttons-container" class="mt-8 space-y-4">
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md mt-8">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-3 text-slate-800">Ø§Ù„ÙˆØµÙ</h2>
                    <div id="product-description" class="prose max-w-none text-slate-700 space-y-4 leading-relaxed">
                    </div>
                </div>
                <div id="seller-info-card" class="bg-white p-6 rounded-lg shadow-md mt-8 hidden"
                    style="animation: fadeIn 0.5s;">
                </div>

                <!-- Reviews Section -->
                <div id="reviews-section" class="bg-white p-6 rounded-lg shadow-md mt-8 hidden fade-in-up">
                    <div class="flex items-center justify-between border-b pb-4 mb-4">
                        <h2 class="text-2xl font-bold text-slate-800">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙˆØ§Ù„Ø¢Ø±Ø§Ø¡</h2>
                        <button id="add-review-btn"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition flex items-center gap-2">
                            <i class="fas fa-plus"></i> Ø£Ø¶Ù ØªÙ‚ÙŠÙŠÙ…Ùƒ
                        </button>
                    </div>

                    <div id="reviews-summary" class="flex items-center gap-4 mb-6 bg-blue-50 p-4 rounded-lg">
                        <div class="text-4xl font-black text-blue-600" id="avg-rating-display">0.0</div>
                        <div>
                            <div class="flex text-yellow-500 text-lg" id="avg-stars-display"></div>
                            <p class="text-sm text-gray-500 mt-1"><span id="reviews-count-display">0</span> ØªÙ‚ÙŠÙŠÙ…</p>
                        </div>
                    </div>

                    <div id="reviews-list" class="space-y-4">
                        <p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯. ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠÙ‚ÙŠÙ…!</p>
                    </div>
                </div>

                <!-- Related Products Section -->
                <div id="related-products-section" class="mt-12 hidden fade-in-up" style="animation-delay: 0.2s;">
                    <h2 class="text-2xl font-bold mb-6 text-slate-800 border-r-4 border-blue-500 pr-3">Ù…Ù†ØªØ¬Ø§Øª Ù‚Ø¯ ØªØ¹Ø¬Ø¨Ùƒ
                    </h2>
                    <div id="related-products-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <!-- Related items injected here -->
                    </div>
                </div>
                <div class="text-center mt-8">
                    <button id="report-product-btn"
                        class="text-sm text-red-500 hover:text-red-700 font-semibold hover:underline">
                        <i class="fas fa-flag ml-1"></i> Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬
                    </button>
                </div>
            </div>
        </div>
        <div class="lg:hidden h-32"></div>
    </main>

    <div id="mobile-sticky-bar"
        class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-3 shadow-[0_-4px_15px_rgba(0,0,0,0.08)] lg:hidden z-40">
        <div class="flex justify-between items-center gap-3">
            <div class="flex-shrink-0 text-center">
                <span class="text-xs text-slate-500">Ø§Ù„Ø³Ø¹Ø±</span>
                <p id="mobile-sticky-price" class="text-lg font-bold text-blue-600"></p>
            </div>
            <div id="mobile-buttons-container" class="flex-grow grid grid-cols-2 gap-2">
            </div>
        </div>
    </div>

    <div id="page-loader" class="max-w-7xl mx-auto py-6 sm:py-8 md:py-10 px-4 sm:px-6 lg:px-8 mt-20">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
            <div class="aspect-square bg-gray-100 rounded-lg skeleton"></div>
            <div class="space-y-6">
                <div class="h-10 w-3/4 bg-gray-100 rounded skeleton"></div>
                <div class="h-6 w-1/4 bg-gray-100 rounded skeleton"></div>
                <div class="h-16 w-1/3 bg-gray-100 rounded skeleton"></div>
                <div class="space-y-3">
                    <div class="h-4 w-full bg-gray-100 rounded skeleton"></div>
                    <div class="h-4 w-full bg-gray-100 rounded skeleton"></div>
                    <div class="h-4 w-2/3 bg-gray-100 rounded skeleton"></div>
                </div>
                <div class="h-14 w-full bg-gray-100 rounded skeleton mt-8"></div>
            </div>
        </div>
    </div>

    <div id="lightbox" class="hidden">
        <span class="close-btn" id="close-lightbox-btn">&times;</span>
        <img id="lightbox-image" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙƒØ¨Ø±Ø©">
    </div>

    <div id="modal-container"></div>
    <div id="toast-container"></div>

    <button id="back-to-top" aria-label="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰">
        <i class="fas fa-arrow-up"></i>
    </button>

    <div id="cart-decision-modal" class="modal-backdrop">
        <div class="modal-content !max-w-md text-center p-6 sm:p-8">
            <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-900 mb-3">ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©!</h2>
            <p class="text-gray-600 mb-6">Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙØ¹Ù„ Ø§Ù„Ø¢Ù†ØŸ</p>

            <a href="cart.html"
                class="block w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg mb-3 hover:bg-blue-700">
                Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„Ø³Ù„Ø© ÙˆØ¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨
            </a>

            <a id="login-checkout-btn" href="login.html"
                onclick="localStorage.setItem('redirectToAfterLogin', 'cart.html')"
                class="block w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg text-lg hover:bg-gray-300">
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù„ÙƒØ³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· ğŸ’)
            </a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, runTransaction, updateDoc, arrayUnion, arrayRemove, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentProduct = null;
        let currentSeller = null;
        let currentUser = null;
        let activeGlobalLogo = 'https://placehold.co/100/1f2937/ffffff?text=Logo'; // Fallback

        // Fetch Global Config
        async function fetchGlobalConfig() {
            try {
                const globalSettingsSnap = await getDoc(doc(db, "settings", "storeConfig"));
                if (globalSettingsSnap.exists()) {
                    const gData = globalSettingsSnap.data();
                    if (gData.logoUrl) activeGlobalLogo = gData.logoUrl;
                }
            } catch (err) { console.log("Global logo fetch error", err); }
        }
        fetchGlobalConfig();

        const elements = {
            modalContainer: document.getElementById('modal-container'),
            pageLoader: document.getElementById('page-loader'),
            pageContent: document.getElementById('page-content'),
            productName: document.getElementById('product-name'),
            productLocation: document.getElementById('product-location'),
            productLocationContainer: document.getElementById('product-location-container'),
            productPrice: document.getElementById('product-price'),
            mobileStickyPrice: document.getElementById('mobile-sticky-price'),
            productDescription: document.getElementById('product-description'),
            mainImage: document.getElementById('main-product-image'),
            thumbnailsContainer: document.getElementById('thumbnails'),
            productButtonsContainer: document.getElementById('product-buttons-container'),
            mobileButtonsContainer: document.getElementById('mobile-buttons-container'),
            shareBtn: document.getElementById('share-btn'),
            copyLinkBtn: document.getElementById('copy-link-btn'),
            toastContainer: document.getElementById('toast-container'),
            lightbox: document.getElementById('lightbox'),
            lightboxImage: document.getElementById('lightbox-image'),
            closeLightboxBtn: document.getElementById('close-lightbox-btn'),
            mainImageContainer: document.querySelector('.main-image-container'),
            sellerInfoCard: document.getElementById('seller-info-card'),
            reportProductBtn: document.getElementById('report-product-btn'),
            cartBtn: document.getElementById('cart-btn'),
            cartDecisionModal: document.getElementById('cart-decision-modal'),
            // (*** ØªÙ… Ø§Ù„Ø­Ø°Ù ***)
            // ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± smartBannerModal
        };

        // --- Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ---

        function showToast(message, type = 'success') {
            const container = elements.toastContainer;
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'error' : ''}`;
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            toast.innerHTML = `<i class="fas ${icon} text-xl"></i><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        function showLoadingModal(text = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
            elements.modalContainer.innerHTML = `
            <div class="modal-backdrop active" id="modal-backdrop-loader">
                <div class="modal-content !max-w-sm p-8 text-center" style="animation: scaleIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);">
                    <div class="loader mx-auto"></div>
                    <p class="mt-4 text-lg font-semibold text-gray-700">${text}</p>
                </div>
            </div>`;
        }
        function closeModal() { elements.modalContainer.innerHTML = ''; }

        function showModal(title, content, showCloseButton = true) {
            if (!elements.modalContainer) { console.error("Modal container not found!"); return; }
            if (document.getElementById('modal-backdrop-generic')) { closeModal(); }
            elements.modalContainer.innerHTML = `
                <div class="modal-backdrop active" id="modal-backdrop-generic">
                    <div class="modal-content !max-w-md p-6 sm:p-8" style="animation: scaleIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);">
                        <div class="flex justify-between items-center mb-4 border-b pb-3">
                            <h3 class="text-xl font-bold text-gray-900">${title}</h3>
                            <button id="modal-close-btn" class="text-gray-400 hover:text-gray-800 text-2xl ${showCloseButton ? '' : 'hidden'}">&times;</button>
                        </div>
                        <div id="modal-body">${content}</div>
                        <div class="flex justify-end gap-4 mt-6 border-t pt-4">
                            <button id="modal-cancel-btn" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg font-semibold hover:bg-gray-300">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </div>
                </div>`;
            const backdrop = document.getElementById('modal-backdrop-generic');
            const closeBtn = document.getElementById('modal-close-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            const closeModalFunc = () => { closeModal(); };
            if (closeBtn) closeBtn.onclick = closeModalFunc;
            if (cancelBtn) cancelBtn.onclick = closeModalFunc;
            if (backdrop) backdrop.onclick = (e) => { if (e.target.id === 'modal-backdrop-generic') closeModalFunc(); };
        }

        function showDirectContactModal(product, links) {
            let buttonsHTML = '<div class="space-y-4">';
            const productName = (product.name || '').replace(/<[^>]*>?/gm, '');
            const introMessage = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ø±ÙŠØ¯ Ø·Ù„Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬: ${productName}`;
            const encodedMessage = encodeURIComponent(introMessage);
            if (links.whatsapp && links.whatsapp.trim() !== '') {
                let cleanWhatsapp = links.whatsapp.replace(/^(00|\+|0)/, '');
                if (/^[567]\d{8}$/.test(cleanWhatsapp)) { cleanWhatsapp = '213' + cleanWhatsapp; }
                buttonsHTML += `<a href="https://wa.me/${cleanWhatsapp}?text=${encodedMessage}" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center gap-3 w-full p-4 rounded-lg text-lg font-bold bg-green-500 text-white hover:bg-green-600 transition-colors">
                                    <i class="fab fa-whatsapp"></i><span>ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</span>
                                </a>`;
            }
            if (links.facebook && links.facebook.trim() !== '') {
                buttonsHTML += `<a href="${links.facebook}" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center gap-3 w-full p-4 rounded-lg text-lg font-bold bg-blue-600 text-white hover:bg-blue-700 transition-colors">
                                    <i class="fab fa-facebook"></i><span>ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙÙŠØ³Ø¨ÙˆÙƒ</span>
                                </a>`;
            }
            if (links.instagram && links.instagram.trim() !== '') {
                buttonsHTML += `<a href="${links.instagram}" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center gap-3 w-full p-4 rounded-lg text-lg font-bold text-white hover:bg-pink-600 transition-colors" style="background-color: #E1306C;">
                                    <i class="fab fa-instagram"></i><span>ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± Ø§Ù†Ø³ØªØºØ±Ø§Ù…</span>
                                </a>`;
            }
            if (links.telegram && links.telegram.trim() !== '') {
                buttonsHTML += `<a href="${links.telegram}" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center gap-3 w-full p-4 rounded-lg text-lg font-bold bg-sky-500 text-white hover:bg-sky-600 transition-colors">
                                    <i class="fab fa-telegram"></i><span>ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</span>
                                </a>`;
            }
            if (links.phone && links.phone.trim() !== '') {
                buttonsHTML += `<a href="tel:${links.phone}" target="_blank" class="flex items-center justify-center gap-3 w-full p-4 rounded-lg text-lg font-bold bg-teal-500 text-white hover:bg-teal-600 transition-colors">
                                    <i class="fas fa-phone-alt"></i><span>Ø§Ù„Ø§ØªØµØ§Ù„ Ù‡Ø§ØªÙÙŠØ§Ù‹</span>
                                </a>`;
            }
            buttonsHTML += '</div>';
            showModal('Ø§Ø®ØªØ± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„', buttonsHTML);
        }

        function updateMainImage(newImageUrl) {
            elements.mainImage.src = newImageUrl;
            elements.lightboxImage.src = newImageUrl;
            document.querySelectorAll('#thumbnails .thumbnail').forEach(th => {
                th.classList.toggle('active', th.dataset.image === newImageUrl);
            });
        }

        async function loadSellerInfo(sellerId) {
            try {
                const sellerDoc = await getDoc(doc(db, "users", sellerId));
                if (sellerDoc.exists()) {
                    currentSeller = { id: sellerDoc.id, ...sellerDoc.data() };

                    // Check if it's a restaurant
                    if (currentSeller.role === 'restaurant' || currentSeller.accountType === 'restaurant') {
                        renderRestaurantProductView();
                    } else {
                        renderStandardSellerView();
                    }
                }
            } catch (e) { console.error("Error loading seller info:", e); }
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ---

        function openAddReviewModal() {
            if (!currentUser) {
                localStorage.setItem('redirectToAfterLogin', location.href);
                window.location.href = 'login.html';
                return;
            }

            const content = `
                <div class="text-center space-y-4">
                    <p class="text-gray-600">ÙƒÙŠÙ ÙƒØ§Ù†Øª ØªØ¬Ø±Ø¨ØªÙƒ Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ</p>
                    
                    <div class="flex flex-row-reverse justify-center gap-2 text-3xl" id="star-rating-input">
                        <i class="far fa-star cursor-pointer hover:text-yellow-400 text-gray-300 transition" data-value="5"></i>
                        <i class="far fa-star cursor-pointer hover:text-yellow-400 text-gray-300 transition" data-value="4"></i>
                        <i class="far fa-star cursor-pointer hover:text-yellow-400 text-gray-300 transition" data-value="3"></i>
                        <i class="far fa-star cursor-pointer hover:text-yellow-400 text-gray-300 transition" data-value="2"></i>
                        <i class="far fa-star cursor-pointer hover:text-yellow-400 text-gray-300 transition" data-value="1"></i>
                    </div>
                    
                    <textarea id="review-comment" 
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 min-h-[100px]"
                        placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ Ù‡Ù†Ø§... (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
                    
                    <button id="submit-review-btn" onclick="submitReview()" 
                        class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        Ù†Ø´Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
                    </button>
                </div>
            `;
            showModal('Ø£Ø¶Ù ØªÙ‚ÙŠÙŠÙ…Ùƒ', content);

            // Star Logic
            const stars = document.querySelectorAll('#star-rating-input i');
            let selectedRating = 0;

            stars.forEach(star => {
                star.addEventListener('click', () => {
                    selectedRating = parseInt(star.dataset.value);
                    updateStarsVisual(selectedRating);
                    document.getElementById('submit-review-btn').dataset.rating = selectedRating;
                });

                star.addEventListener('mouseover', () => {
                    updateStarsVisual(parseInt(star.dataset.value), true);
                });

                star.addEventListener('mouseleave', () => {
                    updateStarsVisual(selectedRating);
                });
            });

            function updateStarsVisual(rating, isHover = false) {
                stars.forEach(s => {
                    const val = parseInt(s.dataset.value);
                    if (val <= rating) {
                        s.classList.remove('far', 'text-gray-300');
                        s.classList.add('fas', 'text-yellow-400');
                    } else {
                        s.classList.remove('fas', 'text-yellow-400');
                        s.classList.add('far', 'text-gray-300');
                    }
                });
            }
        }

        window.submitReview = async function () {
            const btn = document.getElementById('submit-review-btn');
            const rating = parseInt(btn.dataset.rating) || 0;
            const comment = document.getElementById('review-comment').value.trim();

            if (rating === 0) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø¬ÙˆÙ…', 'error');
                return;
            }

            if (!currentProduct || !currentUser) return;

            btn.disabled = true;
            btn.innerHTML = '<div class="small-loader mx-auto"></div>';

            try {
                // Safe Product Name/Image extraction
                const pName = currentProduct.name ? (typeof currentProduct.name === 'object' ? (currentProduct.name.ar || currentProduct.name.en) : currentProduct.name) : 'Ù…Ù†ØªØ¬';
                const pImg = currentProduct.imageUrl || (currentProduct.imageUrls && currentProduct.imageUrls[0]) || null;

                await addDoc(collection(db, 'reviews'), {
                    productId: currentProduct.id,
                    productName: pName,
                    productImage: pImg,
                    sellerId: currentProduct.sellerId || currentSeller?.id,
                    userId: currentUser.uid,
                    userName: currentUser.displayName || 'Ù…Ø³ØªØ®Ø¯Ù… S22Market',
                    userAvatar: currentUser.photoURL || null,
                    rating: rating,
                    comment: comment,
                    likes: [],
                    dislikes: [],
                    createdAt: serverTimestamp()
                });

                // Update product aggregate using transaction
                const productRef = doc(db, "products", currentProduct.id);
                try {
                    await runTransaction(db, async (transaction) => {
                        const sfDoc = await transaction.get(productRef);
                        if (!sfDoc.exists()) return; // Should not happen

                        const data = sfDoc.data();
                        const oldRating = data.rating || 0;
                        const oldCount = data.reviewsCount || 0;

                        const newCount = oldCount + 1;
                        // Calculate new average: (oldAvg * oldCount + newRating) / newCount
                        const newRating = ((oldRating * oldCount) + rating) / newCount;

                        transaction.update(productRef, {
                            rating: newRating,
                            reviewsCount: newCount
                        });
                    });
                } catch (txError) {
                    console.log("Transaction failed, simplified update might be needed", txError);
                }

                showToast('ØªÙ… Ù†Ø´Ø± ØªÙ‚ÙŠÙŠÙ…Ùƒ Ø¨Ù†Ø¬Ø§Ø­!');
                closeModal();
            } catch (error) {
                console.error("Error submitting review:", error);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹', 'error');
                btn.disabled = false;
                btn.textContent = 'Ù†Ø´Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…';
            }
        };

        function loadReviews(productId, productData) {
            const section = document.getElementById('reviews-section');
            const avgRatingDisplay = document.getElementById('avg-rating-display');
            const avgStarsDisplay = document.getElementById('avg-stars-display');
            const countDisplay = document.getElementById('reviews-count-display');
            const reviewsList = document.getElementById('reviews-list');
            const addReviewBtn = document.getElementById('add-review-btn');

            section.classList.remove('hidden');

            // Set initial summary from product data
            const initialAvg = productData.rating || 0;
            const initialCount = productData.reviewsCount || 0;

            avgRatingDisplay.textContent = initialAvg.toFixed(1);
            avgStarsDisplay.innerHTML = generateStars(initialAvg);
            countDisplay.textContent = initialCount;

            const q = query(
                collection(db, 'reviews'),
                where('productId', '==', productId),
                orderBy('createdAt', 'desc')
            );

            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    reviewsList.innerHTML = '<p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯. ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠÙ‚ÙŠÙ…!</p>';
                    return;
                }

                let totalRating = 0;
                let html = '';

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    totalRating += data.rating;
                    html += createReviewCard(doc.id, data);
                });

                reviewsList.innerHTML = html;

                // Real-time summary update from actual reviews (more accurate than product doc sometimes)
                if (snapshot.size > 0) {
                    const avg = (totalRating / snapshot.size).toFixed(1);
                    avgRatingDisplay.textContent = avg;
                    avgStarsDisplay.innerHTML = generateStars(avg);
                    countDisplay.textContent = snapshot.size;
                }
            });

            addReviewBtn.onclick = openAddReviewModal;
        }

        function createReviewCard(reviewId, data) {
            const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString('ar-EG') : '';
            const isLiked = currentUser && data.likes && data.likes.includes(currentUser.uid);
            const isDisliked = currentUser && data.dislikes && data.dislikes.includes(currentUser.uid);

            return `
            <div class="border-b border-gray-100 pb-4 last:border-0 animation: fadeIn 0.3s">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden flex-shrink-0">
                        ${data.userAvatar
                    ? `<img src="${data.userAvatar}" class="w-full h-full object-cover">`
                    : `<i class="fas fa-user text-gray-400"></i>`}
                    </div>
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-sm text-gray-900">${data.userName || 'Ù…Ø³ØªØ®Ø¯Ù…'}</h4>
                                <div class="flex text-yellow-400 text-xs mt-1">
                                    ${generateStars(data.rating)}
                                </div>
                            </div>
                            <span class="text-xs text-gray-400">${date}</span>
                        </div>
                        ${data.comment ? `<p class="text-gray-700 text-sm mt-2 leading-relaxed">${data.comment}</p>` : ''}
                        
                        <div class="flex items-center gap-4 mt-3">
                            <button onclick="toggleReviewReaction('${reviewId}', 'like')" 
                                class="flex items-center gap-1 text-xs ${isLiked ? 'text-blue-600 font-bold' : 'text-gray-500 hover:text-blue-600'} transition">
                                <i class="${isLiked ? 'fas' : 'far'} fa-thumbs-up"></i>
                                <span>${data.likes ? data.likes.length : 0}</span>
                            </button>
                            <button onclick="toggleReviewReaction('${reviewId}', 'dislike')" 
                                class="flex items-center gap-1 text-xs ${isDisliked ? 'text-red-500 font-bold' : 'text-gray-500 hover:text-red-500'} transition">
                                <i class="${isDisliked ? 'fas' : 'far'} fa-thumbs-down"></i>
                                <span>${data.dislikes ? data.dislikes.length : 0}</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        function generateStars(rating) {
            let output = '';
            for (let i = 1; i <= 5; i++) {
                if (rating >= i) output += '<i class="fas fa-star"></i>';
                else if (rating >= i - 0.5) output += '<i class="fas fa-star-half-alt"></i>';
                else output += '<i class="far fa-star text-gray-300"></i>';
            }
            return output;
        }

        window.toggleReviewReaction = async function (reviewId, type) {
            if (!currentUser) {
                showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªÙØ§Ø¹Ù„', 'error');
                return;
            }

            const reviewRef = doc(db, 'reviews', reviewId);
            const reviewSnap = await getDoc(reviewRef);
            if (!reviewSnap.exists()) return;

            const data = reviewSnap.data();
            const uid = currentUser.uid;

            try {
                if (type === 'like') {
                    if (data.likes && data.likes.includes(uid)) {
                        await updateDoc(reviewRef, { likes: arrayRemove(uid) });
                    } else {
                        await updateDoc(reviewRef, {
                            likes: arrayUnion(uid),
                            dislikes: arrayRemove(uid)
                        });
                    }
                } else {
                    if (data.dislikes && data.dislikes.includes(uid)) {
                        await updateDoc(reviewRef, { dislikes: arrayRemove(uid) });
                    } else {
                        await updateDoc(reviewRef, {
                            dislikes: arrayUnion(uid),
                            likes: arrayRemove(uid)
                        });
                    }
                }
            } catch (err) {
                console.error("Reaction error:", err);
            }
        };

        function renderRestaurantProductView() {
            // Enhanced Restaurant View
            const logo = currentSeller.storeLogo || currentSeller.logoUrl || currentSeller.photoURL || activeGlobalLogo;
            const name = currentSeller.displayName || currentSeller.storeName || 'Ù…Ø·Ø¹Ù…';
            const rating = currentSeller.rating || '4.5';
            const deliveryTime = currentSeller.deliveryTime || '30-45';

            elements.sellerInfoCard.innerHTML = `
                <div class="restaurant-product-view bg-gradient-to-r from-orange-50 to-red-50 p-6 rounded-2xl border-2 border-orange-200 shadow-sm">
                    <div class="flex items-center gap-4 mb-4">
                        <img src="${logo}" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full object-cover border-4 border-white shadow-md">
                        <div>
                            <h3 class="text-xl sm:text-2xl font-black text-gray-800 flex items-center gap-2">
                                ${name} 
                                <i class="fas fa-check-circle text-blue-500 text-sm" title="Ù…ÙˆØªÙ‘Ù‚"></i>
                            </h3>
                            <p class="text-sm text-gray-600 flex flex-wrap items-center gap-3 mt-1">
                                <span class="bg-white px-2 py-0.5 rounded-md shadow-sm border border-gray-100 flex items-center gap-1">
                                    <i class="fas fa-star text-yellow-400"></i> ${rating}
                                </span>
                                <span class="bg-white px-2 py-0.5 rounded-md shadow-sm border border-gray-100 flex items-center gap-1">
                                    <i class="fas fa-clock text-gray-400"></i> ${deliveryTime} Ø¯Ù‚ÙŠÙ‚Ø©
                                </span>
                            </p>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-xl border border-gray-100 mb-4 text-sm text-gray-600 leading-relaxed shadow-inner">
                        <i class="fas fa-quote-right text-orange-200 ml-2"></i>
                        ${currentSeller.description || 'Ù†Ù‚Ø¯Ù… Ù„ÙƒÙ… Ø£Ø´Ù‡Ù‰ Ø§Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø­Ø¶Ø±Ø© Ø¨Ø¹Ù†Ø§ÙŠØ©.'}
                    </div>

                    <a href="vendor.html?id=${currentSeller.id}&type=restaurant" 
                       class="block w-full bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-bold py-3.5 px-6 rounded-xl text-center shadow-lg hover:shadow-orange-500/30 transition-all transform hover:-translate-y-0.5">
                        <i class="fas fa-store ml-2"></i>
                        Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø¹Ø§Ù… Ø§Ù„ÙƒØ§Ù…Ù„Ø©
                    </a>
                </div>
            `;
            elements.sellerInfoCard.classList.remove('hidden');
        }

        function renderStandardSellerView() {
            const links = currentSeller.socialLinks || {};
            let socialHTML = '';
            if (links.facebook) socialHTML += `<a href="${links.facebook}" target="_blank" title="ÙÙŠØ³Ø¨ÙˆÙƒ"><i class="fab fa-facebook"></i></a>`;
            if (links.instagram) socialHTML += `<a href="https://instagram.com/${links.instagram.replace('@', '')}" target="_blank" title="Ø§Ù†Ø³ØªØºØ±Ø§Ù…"><i class="fab fa-instagram"></i></a>`;
            if (links.telegram) socialHTML += `<a href="https://t.me/${links.telegram.replace('@', '')}" target="_blank" title="ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…"><i class="fab fa-telegram"></i></a>`;

            elements.sellerInfoCard.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 border-b pb-3 text-slate-800">Ø¹Ù† Ø§Ù„Ø¨Ø§Ø¦Ø¹</h2>
                <div class="flex items-center gap-4">
                    <img src="${currentSeller.storeLogo || currentSeller.logoUrl || currentSeller.photoURL || activeGlobalLogo}" 
                         class="w-16 h-16 rounded-full object-cover border border-gray-200 shadow-sm"
                         onerror="this.onerror=null;this.parentElement.innerHTML='<i class=\'fas fa-user-tie fa-3x text-gray-400\'></i>'">
                    <div>
                        <h3 class="text-xl font-bold">${currentSeller.displayName || 'Ø¨Ø§Ø¦Ø¹ Ù…Ø¹ØªÙ…Ø¯'}</h3>
                        <p class="text-sm text-gray-500">Ù…ØªØ¬Ø±: ${currentSeller.storeName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                    </div>
                </div>
                <div id="seller-social-links" class="flex justify-center gap-4 mt-4 pt-4 border-t">
                    ${socialHTML || '<p class="text-sm text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§Ø¨Ø· ØªÙˆØ§ØµÙ„ Ù„Ù„Ø¨Ø§Ø¦Ø¹.</p>'}
                </div>
                <button id="contact-seller-btn" class="mt-4 w-full bg-gray-100 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors">
                    <i class="fas fa-envelope mr-2"></i> Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹
                </button>`;
            elements.sellerInfoCard.classList.remove('hidden');
            document.getElementById('contact-seller-btn').onclick = showSellerInquiryModal;
        }

        function showSellerInquiryModal() {
            if (!currentSeller) return;
            const content = `
                <form id="seller-inquiry-form" class="space-y-4">
                    <p class="text-sm text-gray-600">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„ØªÙƒ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø¦Ø¹: <strong>${currentSeller.displayName}</strong>.</p>
                    <input type="hidden" id="inq-seller-id" value="${currentSeller.id}">
                    <input type="hidden" id="inq-seller-name" value="${currentSeller.displayName}">
                    <div>
                        <label class="font-semibold text-sm">Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„*</label>
                        <input type="text" id="inq-name" class="mt-1 w-full p-2 border rounded bg-gray-50" required>
                    </div>
                    <div>
                        <label class="font-semibold text-sm">Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ*</label>
                        <input type="tel" id="inq-phone" class="mt-1 w-full p-2 border rounded bg-gray-50" dir="ltr" required>
                    </div>
                    <div>
                        <label class="font-semibold text-sm">Ø±Ø³Ø§Ù„ØªÙƒ*</label>
                        <textarea id="inq-message" rows="4" class="mt-1 w-full p-2 border rounded bg-gray-50" required></textarea>
                    </div>
                    <div class="text-left">
                        <button type="submit" id="inq-submit-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                            <span class="button-text">Ø¥Ø±Ø³Ø§Ù„</span>
                            <div class="small-loader button-loader hidden"></div>
                        </button>
                    </div>
                </form>`;
            showModal(`Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹`, content);
            document.getElementById('seller-inquiry-form').onsubmit = (e) => handleSellerInquirySubmit(e, 'seller_inquiry');
        }

        async function handleSellerInquirySubmit(e, type) {
            e.preventDefault();
            const btn = document.getElementById('inq-submit-btn');
            toggleButtonState(btn, true);
            try {
                const data = {
                    type: type,
                    fullName: document.getElementById('inq-name').value,
                    phone: document.getElementById('inq-phone').value,
                    message: document.getElementById('inq-message').value,
                    sellerId: document.getElementById('inq-seller-id').value,
                    sellerName: document.getElementById('inq-seller-name').value,
                    productName: currentProduct.name.replace(/<[^>]*>?/gm, ''),
                    productId: currentProduct.id,
                    status: 'Ø¬Ø¯ÙŠØ¯',
                    createdAt: serverTimestamp()
                };
                await addDoc(collection(db, "inquiries"), data);
                closeModal();
                showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­.', true);
            } catch (error) { showToast('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.', false); }
            finally { toggleButtonState(btn, false); }
        }

        function showReportModal() {
            const content = `
                <form id="report-form" class="space-y-4">
                    <p class="text-sm text-gray-600">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù„Ø§ØºÙƒ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡.</p>
                    <div>
                        <label class="font-semibold text-sm">Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„*</label>
                        <input type="text" id="report-name" class="mt-1 w-full p-2 border rounded bg-gray-50" required>
                    </div>
                    <div>
                        <label class="font-semibold text-sm">Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ*</label>
                        <input type="tel" id="report-phone" class="mt-1 w-full p-2 border rounded bg-gray-50" dir="ltr" required>
                    </div>
                    <div>
                        <label class="font-semibold text-sm">Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº*</label>
                        <select id="report-reason" class="mt-1 w-full p-2 border rounded bg-gray-50" required>
                            <option value="">-- Ø§Ø®ØªØ± Ø³Ø¨Ø¨Ø§Ù‹ --</option>
                            <option value="Ù…Ø­ØªÙˆÙ‰ Ù…Ø¶Ù„Ù„">Ù…Ø­ØªÙˆÙ‰ Ù…Ø¶Ù„Ù„</option>
                            <option value="Ù…Ù†ØªØ¬ Ù…Ù‚Ù„Ø¯">Ù…Ù†ØªØ¬ Ù…Ù‚Ù„Ø¯</option>
                            <option value="Ø§Ø­ØªÙŠØ§Ù„">Ø§Ø´ØªØ¨Ø§Ù‡ ÙÙŠ Ø§Ø­ØªÙŠØ§Ù„</option>
                            <option value="Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± Ù„Ø§Ø¦Ù‚">Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± Ù„Ø§Ø¦Ù‚</option>
                            <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                        </select>
                    </div>
                    <div>
                        <label class="font-semibold text-sm">Ø±Ø³Ø§Ù„ØªÙƒ (ØªÙˆØ¶ÙŠØ­)*</label>
                        <textarea id="report-message" rows="4" class="mt-1 w-full p-2 border rounded bg-gray-50" required></textarea>
                    </div>
                    <div class="text-left">
                        <button type="submit" id="report-submit-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 flex items-center gap-2">
                            <span class="button-text">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº</span>
                            <div class="small-loader button-loader hidden"></div>
                        </button>
                    </div>
                </form>`;
            showModal(`Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ù†ØªØ¬`, content);
            document.getElementById('report-form').onsubmit = handleReportSubmit;
        }

        async function handleReportSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('report-submit-btn');
            toggleButtonState(btn, true);
            try {
                const pNameFn = (p) => {
                    if (!p) return '';
                    if (typeof p === 'object') return p.ar || p.en || '';
                    return p;
                };
                const rawName = pNameFn(currentProduct.name);
                const data = {
                    type: 'product_report',
                    fullName: document.getElementById('report-name').value,
                    phone: document.getElementById('report-phone').value,
                    reason: document.getElementById('report-reason').value,
                    message: document.getElementById('report-message').value,
                    productName: rawName.replace(/<[^>]*>?/gm, ''),
                    productId: currentProduct.id,
                    status: 'pending',
                    createdAt: serverTimestamp()
                };
                await addDoc(collection(db, "productReports"), data);
                closeModal();
                showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù„Ø§ØºÙƒ Ø¨Ù†Ø¬Ø§Ø­. Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ.', true);
            } catch (error) { showToast('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº.', false); }
            finally { toggleButtonState(btn, false); }
        }

        // (*** ØªÙ… Ø§Ù„Ø­Ø°Ù ***)
        // function detectOS() { ... }
        // function showSmartBanner() { ... }

        function renderProduct(product) {
            currentProduct = product;

            // Helper to safe get name
            const getSafeName = (p) => {
                if (!p.name) return '';
                if (typeof p.name === 'object') return p.name.ar || p.name.en || '';
                return p.name;
            };

            const rawName = getSafeName(product);
            const productNamePlainText = rawName.replace(/<[^>]*>?/gm, '');
            const priceFormatted = `${(product.price || 0).toLocaleString()} Ø¯.Ø¬`;
            document.title = productNamePlainText;

            // Prefer innerHTML if it contains formatting, but if it is just a plain string/object, correct it.
            // If it was an object, we use the string version.
            elements.productName.textContent = productNamePlainText; // Safest for layout

            elements.productPrice.textContent = priceFormatted;
            elements.mobileStickyPrice.textContent = priceFormatted;
            elements.productDescription.innerHTML = product.description || '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ.</p>';
            if (product.location) { elements.productLocation.textContent = product.location; elements.productLocationContainer.classList.remove('hidden'); }
            else { elements.productLocationContainer.classList.add('hidden'); }

            const images = (product.imageUrls && product.imageUrls.length > 0)
                ? product.imageUrls
                : (product.imageUrl ? [product.imageUrl] : ['https://placehold.co/600x600/E2E8F0/475569?text=No+Image']);

            updateMainImage(images[0]);
            elements.mainImage.alt = productNamePlainText;
            elements.thumbnailsContainer.innerHTML = '';
            if (images.length > 1) {
                images.forEach((img, index) => {
                    const thumbDiv = document.createElement('div');
                    thumbDiv.className = `thumbnail ${index === 0 ? 'active' : ''}`;
                    thumbDiv.dataset.image = img;
                    thumbDiv.innerHTML = `<img src="${img}" alt="ØµÙˆØ±Ø© Ù…ØµØºØ±Ø© ${index + 1}">`;
                    elements.thumbnailsContainer.appendChild(thumbDiv);
                });
                elements.thumbnailsContainer.classList.remove('hidden');
            } else { elements.thumbnailsContainer.classList.add('hidden'); }

            const productType = product.productType || 'regular';
            const isOffer = product.isOffer === true;
            const availability = product.availability || 'available';

            let showDirectButton = false;
            let showCartButton = false;
            let showCourseButton = false;

            if (isOffer) {
                showCartButton = true;
            } else if (productType === 'direct') {
                showDirectButton = Object.values(product.directContactLinks || {}).some(link => link);
            } else if (productType === 'course') {
                showCourseButton = true;
            } else { // 'regular'
                showCartButton = true;
            }

            let desktopButtonsHTML = '';
            let mobileButtonsHTML = '';

            if (showCourseButton) {
                const courseLink = product.courseLink || `dawarat_content.html?id=${product.id}`;
                desktopButtonsHTML += `<a href="${courseLink}" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg text-xl flex items-center justify-center gap-3 transition-colors"><i class="fas fa-graduation-cap"></i><span>Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø°Ù„ÙˆØ±Ø©</span></a>`;
                mobileButtonsHTML += `<a href="${courseLink}" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg text-base flex items-center justify-center gap-2"><i class="fas fa-graduation-cap"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø°BØ°Ù„ÙˆØ±Ø©</a>`;
            }
            if (showDirectButton) {
                desktopButtonsHTML += `<button id="direct-order-btn-desktop" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg text-xl flex items-center justify-center gap-3 transform hover:scale-105 transition-transform"><i class="fas fa-paper-plane"></i><span>Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</span></button>`;
                mobileButtonsHTML += `<button id="direct-order-btn-mobile" class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg text-base flex items-center justify-center gap-2"><i class="fas fa-paper-plane"></i> Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</button>`;
            }

            if (showCartButton) {
                if (availability === 'available') {
                    desktopButtonsHTML += `<button id="add-to-cart-btn-desktop" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg text-xl flex items-center justify-center gap-3 transition-colors"><i class="fas fa-cart-plus"></i><span>Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</span></button>`;
                    mobileButtonsHTML += `<button id="add-to-cart-btn-mobile" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg text-base flex items-center justify-center gap-2"><i class="fas fa-cart-plus"></i> Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>`;
                } else {
                    const statusText = availability === 'soon' ? 'Ù‚Ø±ÙŠØ¨Ø§Ù‹' : 'Ù†ÙØ° Ø§Ù„Ù…Ø®Ø²ÙˆÙ†';
                    desktopButtonsHTML += `<button class="w-full bg-gray-400 text-white font-bold py-4 px-6 rounded-lg text-xl flex items-center justify-center gap-3 cursor-not-allowed" disabled>
                                            <i class="fas fa-ban"></i><span>${statusText}</span>
                                        </button>`;
                    mobileButtonsHTML += `<button class="w-full bg-gray-400 text-white font-semibold py-3 rounded-lg text-base flex items-center justify-center gap-2 cursor-not-allowed" disabled>
                                            <i class="fas fa-ban"></i><span>${statusText}</span>
                                        </button>`;
                }
            }

            elements.productButtonsContainer.innerHTML = desktopButtonsHTML;
            elements.mobileButtonsContainer.innerHTML = mobileButtonsHTML;

            const mobileButtonsCount = [showCartButton, showDirectButton, showCourseButton].filter(Boolean).length;
            if (mobileButtonsCount === 1) {
                elements.mobileButtonsContainer.classList.remove('grid-cols-2');
                elements.mobileButtonsContainer.classList.add('grid-cols-1');
            } else {
                elements.mobileButtonsContainer.classList.remove('grid-cols-1');
                elements.mobileButtonsContainer.classList.add('grid-cols-2');
            }

            if (product.sellerId && !isOffer) { loadSellerInfo(product.sellerId); }
            else { elements.sellerInfoCard.classList.add('hidden'); }

            elements.pageLoader.classList.add('hidden');
            elements.pageContent.classList.remove('hidden');

            // Trigger Animations
            elements.pageContent.classList.add('fade-in-up');

            // Load Relatet Products
            if (product.categoryId) {
                fetchAndRenderRelatedProducts(product.categoryId, product.id);
            }

            // Load Reviews
            loadReviews(product.id, product);
        }



        async function fetchItem(collectionName, itemId) {
            try {
                const docRef = doc(db, collectionName, itemId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return { id: docSnap.id, ...docSnap.data() };
                } else {
                    return null;
                }
            } catch (error) { console.error(`Error fetching from ${collectionName}:`, error); throw error; }
        }

        async function fetchAndRenderRelatedProducts(category, currentId) {
            if (!category) return;
            try {
                // Try fetching by exact categoryId first
                let q = query(
                    collection(db, "products"),
                    where("categoryId", "==", category),
                    limit(5)
                );

                // Note: If index is missing, this might fail.
                // We will wrap in try-catch and just suppress log if strictly index error to avoid alerting user with error toast

                const snapshot = await getDocs(q);
                const relatedContainer = document.getElementById('related-products-section');
                const relatedGrid = document.getElementById('related-products-grid');

                const relatedItems = snapshot.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .filter(p => p.id !== currentId)
                    .slice(0, 4); // Take max 4

                if (relatedItems.length > 0) {
                    relatedGrid.innerHTML = relatedItems.map(p => {
                        const img = p.imageUrl || p.imageUrls?.[0] || 'https://placehold.co/300';
                        return `
                        <a href="PRESENTPRODUCT.html?product=${p.id}" class="bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow p-3 border border-gray-100 group">
                            <div class="aspect-square bg-gray-100 rounded mb-3 overflow-hidden relative">
                                <img src="${img}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                            </div>
                            <h3 class="font-bold text-gray-800 text-sm line-clamp-2 mb-1">${p.name}</h3>
                            <p class="text-blue-600 font-bold text-sm text-left">${p.price} Ø¯.Ø¬</p>
                        </a>
                        `;
                    }).join('');
                    relatedContainer.classList.remove('hidden');
                }
            } catch (e) {
                console.log("Could not load related products (likely missing index or empty):", e);
            }
        }

        function addToCart() {
            if (!currentProduct) return;

            if (currentProduct.productType === 'course' || currentProduct.productType === 'direct') {
                showToast('Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ø³Ù„Ø©ØŒ Ø§Ø·Ù„Ø¨ Ø¹Ø¨Ø± Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø®ØµØµ.', 'error');
                return;
            }

            if (currentProduct.availability === 'sold_out' || currentProduct.availability === 'soon') {
                showToast('Ø¹ÙÙˆØ§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹.', 'error');
                return;
            }

            let cart = JSON.parse(localStorage.getItem('s22market_cart')) || [];

            const getSafeName = (p) => {
                if (!p.name) return '';
                if (typeof p.name === 'object') return p.name.ar || p.name.en || '';
                return p.name;
            };
            const rawName = getSafeName(currentProduct);
            const productNamePlainText = rawName.replace(/<[^>]*>?/gm, '');
            const existingItem = cart.find(item => item.id === currentProduct.id);
            if (existingItem) {
                showToast('Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø³Ù„Ø©.', 'error');
                return;
            }
            // Dual Cart Logic
            let itemType = 'market';
            let storeName = 'S22 Market';
            let storeLogo = 'https://placehold.co/50';
            const sellerId = currentProduct.sellerId || currentProduct.vendorId;

            if (currentSeller && (currentSeller.role === 'restaurant' || currentSeller.accountType === 'restaurant')) {
                itemType = 'food';
                storeName = currentSeller.storeName || currentSeller.displayName || 'Ø§Ù„Ù…Ø·Ø¹Ù…';
                storeLogo = currentSeller.storeLogo || currentSeller.logoUrl || currentSeller.photoURL || activeGlobalLogo;
            } else if (sellerId && currentSeller) {
                // Market Seller
                storeName = currentSeller.storeName || currentSeller.displayName || 'Ù…ØªØ¬Ø±';
                storeLogo = currentSeller.storeLogo || currentSeller.logoUrl || currentSeller.photoURL || activeGlobalLogo;
            }

            cart.push({
                id: currentProduct.id,
                name: productNamePlainText,
                price: currentProduct.price,
                imageUrls: currentProduct.imageUrls,
                imageUrl: currentProduct.imageUrl,
                quantity: 1,
                isOffer: currentProduct.isOffer || false,
                sellerId: sellerId,
                itemType: itemType,
                storeName: storeName,
                storeLogo: storeLogo
            });
            localStorage.setItem('s22market_cart', JSON.stringify(cart));

            if (!currentUser) {
                elements.cartDecisionModal.classList.add('active');
            } else {
                showToast(`ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©!`);
            }
        }

        async function shareProduct() {
            if (!currentProduct) return;
            const getSafeName = (p) => {
                if (!p.name) return '';
                if (typeof p.name === 'object') return p.name.ar || p.name.en || '';
                return p.name;
            };
            const productName = getSafeName(currentProduct).replace(/<[^>]*>?/gm, '');
            const shareData = {
                title: `Ø§ÙƒØªØ´Ù: ${productName}`,
                text: `Ø£Ù„Ù‚Ù Ù†Ø¸Ø±Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø±Ø§Ø¦Ø¹ "${productName}" Ø¹Ù„Ù‰ S22MARKET!`,
                url: window.location.href
            };
            if (navigator.share) {
                try { await navigator.share(shareData); } catch (err) { }
            } else {
                await copyLink();
                showToast('Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©. ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!', 'success');
            }
        }

        async function copyLink() {
            const url = window.location.href;
            try {
                await navigator.clipboard.writeText(url);
                showToast('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬! ğŸ”—');
            } catch (err) {
                console.error('Clipboard API failed, trying fallback: ', err);
                const textArea = document.createElement("textarea");
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
                showToast('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬! ğŸ”—');
            }
        }

        // Smart Back Button Logic
        function goBack() {
            if (document.referrer.includes('vendor.html') || document.referrer.includes('s22marketfood.html')) {
                history.back();
            } else {
                window.location.href = 'index.html'; // Or classproductindex.html if preferred, but index is safer default
            }
        }

        async function startApp() {
            const params = new URLSearchParams(window.location.search);
            const productId = params.get('product');
            const offerId = params.get('offer');

            let data = null;
            let errorMsg = 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ù…Ù†ØªØ¬ Ø£Ùˆ Ø¹Ø±Ø¶.';

            try {
                if (productId) {
                    data = await fetchItem('products', productId);
                    if (!data) errorMsg = 'Ø¹ÙÙˆØ§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØªÙ… Ø­Ø°ÙÙ‡.';
                }
                else if (offerId) {
                    const offerData = await fetchItem('offers', offerId);
                    if (offerData) {
                        data = {
                            id: offerData.id, name: offerData.title, description: offerData.description,
                            price: offerData.price,
                            imageUrl: offerData.imageUrl,
                            location: 'Ø¹Ø±Ø¶ Ø®Ø§Øµ', isOffer: true, availability: 'available'
                        };
                    } else {
                        errorMsg = 'Ø¹ÙÙˆØ§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØªÙ‡.';
                    }
                }

                if (data) {
                    renderProduct(data);
                } else {
                    elements.pageLoader.classList.remove('hidden');
                    showToast(errorMsg, 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                }

            } catch (error) {
                console.error("Error details:", error);
                elements.pageLoader.innerHTML = `
                    <div class="text-center py-20 flex flex-col items-center justify-center h-full">
                        <i class="fas fa-exclamation-circle text-red-500 text-6xl mb-4"></i>
                        <h3 class="text-red-600 text-2xl font-bold mb-2">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                        <p class="text-gray-500 text-sm mb-6 max-w-md mx-auto">${error.message || 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹'}</p>
                        <button onclick="location.reload()" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg hover:shadow-blue-500/30">
                            <i class="fas fa-sync-alt ml-2"></i>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                        </button>
                    </div>`;
            }

            elements.thumbnailsContainer.addEventListener('click', (e) => {
                const thumb = e.target.closest('.thumbnail');
                if (thumb) updateMainImage(thumb.dataset.image);
            });
            elements.mainImageContainer.addEventListener('click', () => elements.lightbox.classList.add('active'));
            elements.closeLightboxBtn.addEventListener('click', () => elements.lightbox.classList.remove('active'));
            elements.lightbox.addEventListener('click', (e) => { if (e.target.id === 'lightbox') elements.lightbox.classList.remove('active'); });

            const handleDirectOrder = () => { if (currentProduct && currentProduct.directContactLinks) { showDirectContactModal(currentProduct, currentProduct.directContactLinks); } };

            elements.productButtonsContainer.addEventListener('click', (e) => {
                const cartBtn = e.target.closest('#add-to-cart-btn-desktop');
                const directBtn = e.target.closest('#direct-order-btn-desktop');
                if (cartBtn) addToCart();
                if (directBtn) handleDirectOrder();
            });
            elements.mobileButtonsContainer.addEventListener('click', (e) => {
                const cartBtn = e.target.closest('#add-to-cart-btn-mobile');
                const directBtn = e.target.closest('#direct-order-btn-mobile');
                if (cartBtn) addToCart();
                if (directBtn) handleDirectOrder();
            });

            elements.shareBtn.onclick = shareProduct;
            elements.copyLinkBtn.onclick = copyLink;
            elements.reportProductBtn.onclick = showReportModal;

            elements.cartBtn.onclick = (e) => { e.preventDefault(); window.location.href = 'cart.html'; };

            // (*** ØªÙ… Ø§Ù„Ø­Ø°Ù ***)
            // elements.smartBannerSecondaryBtn.onclick = ...

            elements.cartDecisionModal.addEventListener('click', (e) => {
                if (e.target.id === 'cart-decision-modal' || e.target.closest('a')) {
                    elements.cartDecisionModal.classList.remove('active');
                }
            });

        }

        // Strict Auth Entry Point
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', startApp);
                } else {
                    startApp();
                }
            } else {
                const returnUrl = encodeURIComponent(window.location.href);
                window.location.href = `login.html?redirect=${returnUrl}`;
            }
        });



        // --- Splash Screen & Mobile Logic ---
        window.addEventListener('load', () => {
            // Splash Screen Fade Out
            const spl = document.getElementById('splash-screen');
            if (spl) {
                setTimeout(() => {
                    spl.classList.add('hidden-splash');
                    setTimeout(() => spl.style.display = 'none', 500);
                }, 1200);
            }
        });

        // Back to Top Logic
        const backToTopBtn = document.getElementById('back-to-top');
        if (backToTopBtn) {
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) backToTopBtn.classList.add('visible');
                else backToTopBtn.classList.remove('visible');
            });
            backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
        }

        // Pull to Refresh Logic
        let touchStartY = 0;
        const spinner = document.getElementById('pull-refresh-spinner');
        document.addEventListener('touchstart', e => { if (window.scrollY === 0) touchStartY = e.touches[0].clientY; }, { passive: true });
        document.addEventListener('touchend', e => {
            if (window.scrollY === 0 && touchStartY > 0) {
                const touchEndY = e.changedTouches[0].clientY;
                if (touchEndY - touchStartY > 150) {
                    if (spinner) {
                        spinner.style.display = 'block';
                        if (navigator.vibrate) navigator.vibrate(50);
                        setTimeout(() => window.location.reload(), 800);
                    }
                }
                touchStartY = 0;
            }
        }, { passive: true });

        // Hide Header on Scroll Down (Mobile)
        let lastScroll = 0;
        const header = document.getElementById('main-header');
        if (header) {
            window.addEventListener('scroll', () => {
                const currentScroll = window.scrollY;
                if (currentScroll > lastScroll && currentScroll > 100) {
                    header.style.transform = 'translateY(-100%)';
                } else {
                    header.style.transform = 'translateY(0)';
                }
                lastScroll = currentScroll;
            });
        }

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            // (*** ØªÙ… Ø§Ù„Ø­Ø°Ù ***)
            // ØªÙ… Ø­Ø°Ù Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ showSmartBanner()
        });
    </script>
</body>

</html>