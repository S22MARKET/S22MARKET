<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تفاصيل المنتج</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="app-style.css">

    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
            /* Avoid double scrollbars if content is short */
            min-height: 100vh;
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Lightbox */
        #lightbox {
            display: none;
            position: fixed;
            z-index: 5000;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            align-items: center;
            justify-content: center;
        }

        #lightbox.active {
            display: flex;
        }

        #lightbox img {
            max-width: 90vw;
            max-height: 80vh;
            object-fit: contain;
        }

        /* Thumbnails */
        .thumb-active {
            border-color: #4f46e5;
        }

        /* Mobile Sticky Bar */
        .mobile-sticky-bar {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>

<body class="pb-24 lg:pb-0">

    <!-- Header (Simple Back) -->
    <header class="bg-white shadow-sm sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
            <button onclick="history.back()"
                class="text-gray-600 hover:text-indigo-600 flex items-center gap-2 font-bold">
                <i class="fas fa-arrow-right"></i> الخلف
            </button>
            <a href="index.html" class="font-bold text-xl text-gray-800">S22<span
                    class="text-indigo-600">MARKET</span></a>
            <a href="cart.html" class="relative text-gray-600 hover:text-indigo-600">
                <i class="fas fa-shopping-bag text-xl"></i>
                <span id="header-cart-badge"
                    class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center hidden">0</span>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">

        <!-- Loader -->
        <div id="page-loader" class="flex justify-center py-20">
            <div class="loader"></div>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden text-center py-20">
            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
            <h2 class="text-xl font-bold text-gray-800 mb-2">عذراً، حدث خطأ</h2>
            <p id="error-message" class="text-gray-600 mb-6">لم نتمكن من تحميل المنتج</p>
            <a href="index.html" class="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold">العودة للرئيسية</a>
        </div>

        <!-- Content Grid -->
        <div id="product-content" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- Image Section -->
            <div class="space-y-4">
                <div class="aspect-square bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden relative group cursor-zoom-in"
                    onclick="openLightbox()">
                    <img id="main-image" src=""
                        class="w-full h-full object-cover transition duration-500 group-hover:scale-105">
                    <div
                        class="absolute inset-0 flex items-center justify-center bg-black/10 opacity-0 group-hover:opacity-100 transition duration-300 pointer-events-none">
                        <i class="fas fa-search-plus text-white text-3xl drop-shadow-lg"></i>
                    </div>
                </div>

                <!-- Thumbnails -->
                <div id="thumbnails-container" class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                    <!-- Injected via JS -->
                </div>
            </div>

            <!-- Details Section -->
            <div class="space-y-6">

                <!-- Seller Info -->
                <div id="seller-info"
                    class="hidden flex items-center gap-3 p-3 bg-indigo-50 rounded-xl border border-indigo-100">
                    <img id="seller-avatar" src="" class="w-10 h-10 rounded-full object-cover bg-white">
                    <div>
                        <div class="text-xs text-indigo-600 font-bold mb-0.5" id="seller-label">البائع</div>
                        <h3 id="seller-name" class="font-bold text-gray-800 text-sm"></h3>
                    </div>
                    <a id="seller-link" href="#"
                        class="mr-auto text-xs bg-white text-indigo-600 px-3 py-1.5 rounded-lg border border-indigo-200 font-bold hover:bg-indigo-600 hover:text-white transition">زيارة
                        المتجر</a>
                </div>

                <!-- Title & Price -->
                <div>
                    <h1 id="product-name" class="text-2xl sm:text-3xl font-extrabold text-gray-900 mb-2 leading-tight">
                        ...</h1>
                    <div class="flex items-end gap-3 mb-2">
                        <span id="product-price" class="text-3xl font-bold text-indigo-600">0</span>
                        <span id="product-unit" class="text-sm text-gray-500 font-bold mb-1.5">د.ج</span>
                        <span id="product-old-price" class="text-lg text-gray-400 line-through mb-1 hidden"></span>
                    </div>
                </div>

                <!-- Description -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                    <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">تفاصيل المنتج</h3>
                    <p id="product-description"
                        class="text-gray-600 leading-relaxed whitespace-pre-line text-sm sm:text-base">...</p>
                </div>

                <!-- Desktop Offer Countdown (if applicable) -->
                <div id="offer-countdown-container"
                    class="hidden bg-gradient-to-r from-red-500 to-pink-600 rounded-xl p-4 text-white text-center shadow-lg">
                    <p class="font-bold mb-1 text-sm opacity-90">ينتهي العرض خلال</p>
                    <div id="countdown-timer" class="text-2xl font-mono font-bold" dir="ltr">00:00:00</div>
                </div>

                <!-- Actions -->
                <div class="hidden lg:block space-y-4">
                    <button id="desktop-add-cart-btn"
                        class="w-full bg-gray-900 text-white text-lg font-bold py-4 rounded-xl hover:bg-gray-800 transition shadow-lg flex items-center justify-center gap-2">
                        <i class="fas fa-shopping-cart"></i> إضافة للسلة
                    </button>

                    <div id="desktop-contact-btns" class="grid grid-cols-2 gap-3">
                        <!-- Direct Contact btns -->
                    </div>
                </div>

                <!-- Social Share -->
                <div class="grid grid-cols-2 gap-4">
                    <button id="copy-link-btn"
                        class="flex items-center justify-center gap-2 py-3 bg-gray-100 rounded-xl text-gray-600 font-bold hover:bg-gray-200 transition">
                        <i class="fas fa-link"></i> نسخ الرابط
                    </button>
                    <button onclick="document.getElementById('report-modal').classList.remove('hidden')"
                        class="flex items-center justify-center gap-2 py-3 bg-red-50 rounded-xl text-red-500 font-bold hover:bg-red-100 transition">
                        <i class="fas fa-flag"></i> إبلاغ
                    </button>
                </div>

            </div>
        </div>

        <!-- Mobile Sticky Bar -->
        <div
            class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-3 lg:hidden z-40 mobile-sticky-bar shadow-[0_-5px_20px_rgba(0,0,0,0.1)]">
            <div class="flex gap-3">
                <div class="flex-none w-1/3">
                    <div class="text-xs text-gray-500 font-bold text-center mb-1">السعر</div>
                    <div class="text-center font-bold text-indigo-600 text-lg leading-none" id="mobile-price-display">0
                        د.ج</div>
                </div>
                <button id="mobile-add-cart-btn"
                    class="flex-grow bg-gray-900 text-white font-bold rounded-xl py-3 flex items-center justify-center gap-2 shadow-md active:scale-95 transition">
                    <i class="fas fa-shopping-cart"></i> أضف للسلة
                </button>
            </div>
        </div>

        <div class="h-20 lg:hidden"></div> <!-- Spacer -->

    </main>

    <!-- Lightbox Modal -->
    <div id="lightbox" onclick="closeLightbox()">
        <button class="absolute top-4 right-4 text-white text-4xl hover:text-gray-300">&times;</button>
        <img id="lightbox-img" src="" onclick="event.stopPropagation()">
    </div>

    <!-- Report Modal -->
    <div id="report-modal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-sm w-full p-6 text-center">
            <h3 class="text-xl font-bold mb-4">الإبلاغ عن مخالفة</h3>
            <p class="text-gray-600 mb-6 text-sm">هل تعتقد أن هذا المنتج ينتهك سياساتنا؟</p>
            <div class="flex gap-3">
                <button onclick="document.getElementById('report-modal').classList.add('hidden')"
                    class="flex-1 bg-gray-100 py-2.5 rounded-xl font-bold">إلغاء</button>
                <button onclick="submitReport();"
                    class="flex-1 bg-red-500 text-white py-2.5 rounded-xl font-bold">إبلاغ</button>
            </div>
        </div>
    </div>

    <!-- Contact Options Modal -->
    <div id="contact-modal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-sm w-full p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="font-bold text-lg">تواصل مع البائع</h3>
                <button onclick="document.getElementById('contact-modal').classList.add('hidden')"
                    class="text-2xl text-gray-400">&times;</button>
            </div>
            <div id="contact-options-list" class="space-y-3"></div>
        </div>
    </div>

    <!-- Added To Cart Modal -->
    <div id="added-to-cart-modal"
        class="fixed inset-0 bg-black/70 hidden z-[100] items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-3xl p-6 max-w-sm w-full shadow-2xl transform transition-all scale-100">
            <div class="flex flex-col items-center text-center">
                <div
                    class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4 text-green-600 animate-bounce">
                    <i class="fas fa-check text-3xl"></i>
                </div>
                <h3 class="text-xl font-black text-gray-800 mb-2">تمت الإضافة للسلة!</h3>
                <p class="text-gray-500 mb-6 font-medium">تم وضع المنتج في عربة التسوق الخاصة بك بنجاح.</p>

                <div class="grid grid-cols-2 gap-3 w-full">
                    <button onclick="hideAddedToCartModal()"
                        class="py-3 px-4 rounded-xl font-bold text-gray-600 bg-gray-100 hover:bg-gray-200 transition">
                        تابع التسوق
                    </button>
                    <a href="cart.html"
                        class="py-3 px-4 rounded-xl font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">
                        الذهاب للسلة <i class="fas fa-arrow-left mr-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script type="module">
        import { auth, db } from './app-core.js';
        import { doc, getDoc, collection, addDoc, serverTimestamp, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Globals
        let currentProduct = null;
        let currentProductType = 'product'; // 'product' or 'offer'

        // 1. Get ID from URL
        const params = new URLSearchParams(window.location.search);
        const productId = params.get('product');
        const offerId = params.get('offer');
        const targetId = productId || offerId;

        // Init
        async function init() {
            if (!targetId) {
                showError('لا يوجد معرف منتج!');
                return;
            }

            try {
                // Determine collection
                let colName = 'products';
                if (offerId) { colName = 'offers'; currentProductType = 'offer'; }

                const docRef = doc(db, colName, targetId);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    showError('المنتج غير موجود أو تم حذفه');
                    return;
                }

                currentProduct = { id: docSnap.id, ...docSnap.data() };
                renderProduct(currentProduct);

                // Load Seller Info
                if (currentProduct.sellerId) {
                    loadSeller(currentProduct.sellerId);
                }

            } catch (err) {
                console.error(err);
                showError('حدث خطأ أثناء تحميل البيانات');
            }
        }

        // Helper: Name Localization
        function getLocalizedName(obj) {
            if (!obj) return 'بدون اسم';
            if (typeof obj === 'object') {
                return obj.ar || obj.en || 'منتج';
            }
            return String(obj);
        }

        // Render Product
        function renderProduct(p) {
            document.getElementById('page-loader').classList.add('hidden');
            document.getElementById('product-content').classList.remove('hidden');

            const name = getLocalizedName(p.name);
            const desc = (typeof p.description === 'object') ? (p.description.ar || p.description.en || '') : (p.description || 'لا يوجد وصف');

            // Text
            document.getElementById('product-name').textContent = name;
            document.getElementById('product-description').innerHTML = desc;
            document.title = `${name} | S22 Market`;

            // Price
            document.getElementById('product-price').textContent = p.price;
            document.getElementById('mobile-price-display').textContent = `${p.price} د.ج`;

            if (p.oldPrice) {
                const el = document.getElementById('product-old-price');
                el.textContent = `${p.oldPrice} د.ج`;
                el.classList.remove('hidden');
            }

            // Images
            let images = [];
            if (p.imageUrls && Array.isArray(p.imageUrls) && p.imageUrls.length > 0) {
                images = p.imageUrls;
            } else if (p.imageUrl) {
                images = [p.imageUrl];
            } else {
                images = ['https://placehold.co/600?text=No+Image'];
            }

            // Main Image
            document.getElementById('main-image').src = images[0];
            document.getElementById('main-image').dataset.zoom = images[0];

            // Thumbnails
            const thumbsContainer = document.getElementById('thumbnails-container');
            if (images.length > 1) {
                thumbsContainer.innerHTML = '';
                images.forEach((img, idx) => {
                    thumbsContainer.innerHTML += `
                        <img src="${img}" class="w-16 h-16 rounded-lg border-2 ${idx === 0 ? 'border-indigo-600' : 'border-transparent'} object-cover cursor-pointer hover:opacity-80 transition" 
                        onclick="switchImage('${img}', this)">
                    `;
                });
            } else {
                thumbsContainer.classList.add('hidden');
            }

            // Add to Cart Logic
            const addToCartHandler = () => addToCart(p);
            document.getElementById('desktop-add-cart-btn').onclick = addToCartHandler;
            document.getElementById('mobile-add-cart-btn').onclick = addToCartHandler;

            // Copy Link
            document.getElementById('copy-link-btn').onclick = () => {
                navigator.clipboard.writeText(window.location.href);
                alert('تم نسخ الرابط!');
            };
        }

        // Load Seller
        async function loadSeller(sellerId) {
            try {
                const snap = await getDoc(doc(db, "users", sellerId));
                if (snap.exists()) {
                    const s = snap.data();
                    const sInfo = document.getElementById('seller-info');
                    sInfo.classList.remove('hidden');

                    document.getElementById('seller-name').textContent = s.displayName || 'بائع S22';
                    document.getElementById('seller-avatar').src = s.photoURL || `https://ui-avatars.com/api/?name=${s.displayName}`;
                    document.getElementById('seller-link').href = `vendor.html?id=${sellerId}`;

                    // Direct Contact Options
                    setupContactOptions(s, currentProduct);
                }
            } catch (e) {
                console.error("Seller load error", e);
            }
        }

        // Setup Contact
        function setupContactOptions(seller, product) {
            const container = document.getElementById('desktop-contact-btns');
            const contactLinks = seller.contactInfo || {};
            // Also check root fields if legacy
            const phone = contactLinks.phone || seller.phoneNumber;

            // Build buttons logic for Modal
            window.openContactModal = () => {
                const list = document.getElementById('contact-options-list');
                list.innerHTML = '';

                const pName = getLocalizedName(product.name);
                const msg = encodeURIComponent(`مرحباً، أستفسر عن المنتج: ${pName}`);

                if (phone) {
                    list.innerHTML += `
                        <a href="tel:${phone}" class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl hover:bg-gray-100 border border-gray-100">
                            <i class="fas fa-phone-alt text-green-600"></i>
                            <span class="font-bold text-gray-700">اتصال هاتفي</span>
                        </a>`;
                }

                // Add more logic for whatsapp/insta if available in seller object
                // For simplicity, just showing generic contact button for now
            };

            // Add "Contact Seller" button to desktop
            const btn = document.createElement('button');
            btn.className = "col-span-2 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition flex items-center justify-center gap-2";
            btn.innerHTML = '<i class="far fa-comment-dots"></i> تواصل مع البائع';
            btn.onclick = () => document.getElementById('contact-modal').classList.remove('hidden') || window.openContactModal();
            container.appendChild(btn);
        }

        // Cart Logic
        function addToCart(p) {
            let cart = [];
            try {
                cart = JSON.parse(localStorage.getItem('s22_cart') || '[]');
            } catch (e) { cart = []; }

            // Determine safe itemType
            let type = 'market';
            if (currentProductType === 'offer') type = 'food';
            else if (p.categoryId === 'restaurant_food') type = 'food';

            // Check if item exists
            const existing = cart.find(i => i.id === p.id);
            if (existing) {
                existing.quantity = (existing.quantity || 1) + 1;
                // Force update type just in case
                if (!existing.itemType) existing.itemType = type;
            } else {
                cart.push({
                    id: p.id,
                    name: getLocalizedName(p.name),
                    price: Number(p.price),
                    image: p.imageUrl || (p.imageUrls ? p.imageUrls[0] : 'https://placehold.co/100'),
                    quantity: 1,
                    sellerId: p.sellerId || 'admin',
                    storeName: p.storeName || 'S22 Market',
                    itemType: type
                });
            }

            localStorage.setItem('s22_cart', JSON.stringify(cart));

            // Visuals
            updateCartBadge();

            // Fly Animation (Desktop)
            const mainImg = document.getElementById('main-image');
            const cartIcon = document.getElementById('header-cart-icon') || document.getElementById('header-cart-btn'); // Fallback
            if (mainImg && cartIcon) {
                const flyer = mainImg.cloneNode();
                flyer.classList.add('fly-item');

                // Start pos
                const rect = mainImg.getBoundingClientRect();
                flyer.style.left = rect.left + 'px';
                flyer.style.top = rect.top + 'px';
                flyer.style.width = '100px';
                flyer.style.height = '100px';

                // End pos
                const endRect = cartIcon.getBoundingClientRect();
                flyer.style.setProperty('--tx', (endRect.left - rect.left) + 'px');
                flyer.style.setProperty('--ty', (endRect.top - rect.top) + 'px');

                document.body.appendChild(flyer);
                setTimeout(() => flyer.remove(), 1000);
            }

            // Show Success Custom Modal
            showAddedToCartModal();
        }

        function updateCartBadge() {
            const cart = JSON.parse(localStorage.getItem('s22_cart') || '[]');
            const count = cart.reduce((a, b) => a + (b.quantity || 1), 0);
            const badge = document.getElementById('header-cart-badge');
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        updateCartBadge();

        // Utilities
        window.switchImage = (src, el) => {
            document.getElementById('main-image').src = src;
            document.querySelectorAll('.thumb-active').forEach(t => t.classList.remove('thumb-active', 'border-indigo-600', 'border-2'));
            el.classList.add('thumb-active', 'border-indigo-600', 'border-2');
            el.classList.remove('border-transparent');
        };

        window.openLightbox = () => {
            const src = document.getElementById('main-image').src;
            document.getElementById('lightbox-img').src = src;
            document.getElementById('lightbox').classList.add('active');
        };

        window.closeLightbox = () => {
            document.getElementById('lightbox').classList.remove('active');
        };

        window.submitReport = async () => {
            alert('تم استلام بلاغك وسيقوم الفريق بمراجعته. شكراً لحرصك.');
            document.getElementById('report-modal').classList.add('hidden');
        };

        function showError(msg) {
            document.getElementById('page-loader').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('error-message').textContent = msg;
        }

        // --- Added to Cart Modal Logic ---
        function showAddedToCartModal() {
            const modal = document.getElementById('added-to-cart-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.hideAddedToCartModal = () => {
            const modal = document.getElementById('added-to-cart-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Run
        init();

    </script>
</body>

</html>