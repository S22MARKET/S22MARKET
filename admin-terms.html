<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - إدارة الشروط والأحكام</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="theme-manager.js"></script>
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f0f2f5;
        }

        .hidden {
            display: none;
        }

        .dashboard-tab:hover {
            background-color: #4338ca;
        }

        .dashboard-tab.active-tab {
            background-color: #4f46e5;
            color: white;
            font-weight: bold;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Quill Customization */
        .ql-editor {
            min-height: 150px;
            font-family: 'Tajawal', sans-serif;
            direction: rtl;
            text-align: right;
            font-size: 16px;
            background-color: white;
        }

        .ql-toolbar {
            background-color: #f9fafb;
            border-radius: 0.5rem 0.5rem 0 0;
            direction: ltr;
        }

        /* Toolbar LTR for icons logic usually */
        .ql-container {
            border-radius: 0 0 0.5rem 0.5rem;
            background-color: white;
        }
    </style>
</head>

<body>

    <div id="login-page" class="hidden min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-xl space-y-6 text-center">
            <h2 class="text-3xl font-extrabold text-gray-900">يرجى تسجيل الدخول</h2>
            <p class="text-red-500">يجب أن تكون مشرفاً للوصول لهذه الصفحة.</p>
            <a href="admin-login.html"
                class="inline-block bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700">تسجيل
                الدخول</a>
        </div>
    </div>

    <div id="dashboard-page" class="hidden">
        <div class="relative min-h-screen md:flex">

            <!-- Sidebar -->
            <aside id="sidebar"
                class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 right-0 transform translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30">
                <div class="p-3 text-center border-b border-gray-700">
                    <h2 class="text-2xl font-bold">S22 Market</h2>
                    <p id="admin-welcome-name" class="text-sm text-indigo-300"></p>
                </div>
                <nav class="flex-1 p-2 space-y-2">
                    <a href="dashboard.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-chart-line fa-fw mr-3"></i> لوحة التحكم</a>
                    <a href="admin-terms.html"
                        class="dashboard-tab active-tab flex items-center px-4 py-3 rounded-md"><i
                            class="fas fa-file-contract fa-fw mr-3 text-green-400"></i> إدارة الشروط</a>
                    <a href="dashboard.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-arrow-right fa-fw mr-3"></i> العودة للرئيسية</a>
                </nav>
                <div class="p-4 border-t border-gray-700">
                    <button id="logout-btn"
                        class="w-full bg-red-600 py-2 rounded-md hover:bg-red-700 transition-colors"><i
                            class="fas fa-sign-out-alt mr-2"></i> تسجيل الخروج</button>
                    <div id="sidebar-theme-container"></div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-4 md:p-8 overflow-y-auto">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h1 class="text-3xl font-bold text-gray-800">إدارة نصوص الشروط والأحكام</h1>
                    <button onclick="saveTerms()" id="save-btn"
                        class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg hover:shadow-xl transition-all flex items-center gap-2 transform hover:-translate-y-1">
                        <i class="fas fa-save"></i> حفظ التعديلات
                    </button>
                </div>

                <div class="bg-white rounded-2xl shadow-xl p-8 mb-6 border border-gray-100 relative">
                    <div id="loading-overlay"
                        class="absolute inset-0 bg-white/80 z-20 flex items-center justify-center hidden rounded-2xl">
                        <div class="loader"></div>
                    </div>

                    <div class="space-y-12">
                        <!-- General Terms -->
                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                            <div class="flex justify-between items-center mb-4">
                                <label class="text-xl font-black text-gray-800 flex items-center gap-2">
                                    <i class="fas fa-gavel text-indigo-500 bg-indigo-100 p-2 rounded-lg"></i> الأحكام
                                    العامة
                                </label>
                                <div class="flex gap-2">
                                    <button onclick="restoreOriginal('general')"
                                        class="text-sm bg-white border border-gray-300 text-gray-600 px-3 py-1.5 rounded-lg hover:bg-gray-100 transition shadow-sm"
                                        title="استعادة النص الأصلي">
                                        <i class="fas fa-history text-blue-500"></i> استعادة الأصلي
                                    </button>
                                    <button onclick="clearSection('general')"
                                        class="text-sm bg-white border border-red-200 text-red-500 px-3 py-1.5 rounded-lg hover:bg-red-50 transition shadow-sm"
                                        title="مسح المحتوى">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="editor-general" class="bg-white"></div>
                        </div>

                        <!-- User Terms -->
                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                            <div class="flex justify-between items-center mb-4">
                                <label class="text-xl font-black text-gray-800 flex items-center gap-2">
                                    <i class="fas fa-users text-green-500 bg-green-100 p-2 rounded-lg"></i> شروط
                                    المستخدمين
                                </label>
                                <div class="flex gap-2">
                                    <button onclick="restoreOriginal('users')"
                                        class="text-sm bg-white border border-gray-300 text-gray-600 px-3 py-1.5 rounded-lg hover:bg-gray-100 transition shadow-sm">
                                        <i class="fas fa-history text-blue-500"></i> استعادة الأصلي
                                    </button>
                                    <button onclick="clearSection('users')"
                                        class="text-sm bg-white border border-red-200 text-red-500 px-3 py-1.5 rounded-lg hover:bg-red-50 transition shadow-sm">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="editor-users" class="bg-white"></div>
                        </div>

                        <!-- Merchant Terms -->
                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                            <div class="flex justify-between items-center mb-4">
                                <label class="text-xl font-black text-gray-800 flex items-center gap-2">
                                    <i class="fas fa-store text-orange-500 bg-orange-100 p-2 rounded-lg"></i> شروط
                                    التجار
                                </label>
                                <div class="flex gap-2">
                                    <button onclick="restoreOriginal('merchants')"
                                        class="text-sm bg-white border border-gray-300 text-gray-600 px-3 py-1.5 rounded-lg hover:bg-gray-100 transition shadow-sm">
                                        <i class="fas fa-history text-blue-500"></i> استعادة الأصلي
                                    </button>
                                    <button onclick="clearSection('merchants')"
                                        class="text-sm bg-white border border-red-200 text-red-500 px-3 py-1.5 rounded-lg hover:bg-red-50 transition shadow-sm">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="editor-merchants" class="bg-white"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script type="module">
        import { auth, db } from './app-core.js';
        import { doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const ADMIN_EMAILS = ['s22market@gmail.com', 'yacinee474474@gmail.com', 'nourmt01@gmail.com'];
        const dashboardPage = document.getElementById('dashboard-page');
        const loginPage = document.getElementById('login-page');

        let quills = {};

        // Default Content (The Original Version)
        const DEFAULTS = {
            general: `<p>مرحباً بكم في منصة S22 Market. يمثل استخدامك لهذا التطبيق موافقة ضمنية وكاملة على الشروط والأحكام التالية:</p><br><ul><li><strong>الملكية الفكرية:</strong> جميع حقوق الملكية الفكرية للمنصة، بما في ذلك التصميم، والبرمجة، والشعارات، هي ملك لـ S22 Market ولا يجوز نسخها أو استخدامها دون إذن خطي.</li><li>يحق للمنصة تعديل هذه الشروط في أي وقت، ويعتبر استمرار استخدامك للمنصة موافقة على التعديلات.</li><li>تلتزم المنصة بحماية بيانات المستخدمين وفقاً لسياسة الخصوصية العالمية.</li><li>يمنع استخدام المنصة لأي أغراض غير قانونية أو تنتهك حقوق الآخرين.</li></ul>`,

            users: `<h3>الحسابات والأمان</h3><ul><li>يجب تقديم بيانات صحيحة وكاملة عند التسجيل (الاسم، الهاتف، العنوان).</li><li>المستخدم مسؤول مسؤولية تامة عن الحفاظ على سرية معلومات الدخول الخاصة به.</li></ul><br><h3>الطلبات والدفع</h3><ul><li>الدفع يتم إما عند الاستلام أو عبر الطرق الإلكترونية المعتمدة في المنصة.</li><li>في حال تكرار إلغاء الطلبات بعد تأكيدها، يحق للمنصة حظر الحساب مؤقتاً أو نهائياً.</li></ul>`,

            merchants: `<h3>جودة المنتج</h3><p>يلتزم الشريك بتقديم منتجات مطابقة للصور والوصف المعروض. أي شكاوى متكررة بخصوص الجودة قد تؤدي لإيقاف الحساب.</p><br><h3>سرعة التوصيل</h3><p>يجب الالتزام بأوقات التحضير والتوصيل المعلنة. التأخير غير المبرر يؤثر سلباً على تقييم المتجر.</p><br><h3>العمولات</h3><p>يتم احتساب العمولات وفقاً للاتفاق المبرم، ويتم تحويل المستحقات بشكل دوري (أسبوعياً/شهرياً) بعد تسوية الطلبات المكتملة.</p><br><h3>المحتوى الممنوع</h3><p>يمنع منعاً باتاً بيع أي منتجات مخالفة للقوانين المحلية أو السلع المقلدة أو التي تنتهك حقوق الملكية الفكرية.</p>`
        };

        // Initialize Quill with Toolbar
        function initQuill(id) {
            return new Quill(`#${id}`, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        [{ 'direction': 'rtl' }, { 'align': [] }],
                        ['link', 'clean']
                    ]
                }
            });
        }

        // Auth Logic
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                let isAdmin = ADMIN_EMAILS.includes(user.email);
                if (!isAdmin) {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists() && userDoc.data().role === 'admin') isAdmin = true;
                }

                if (isAdmin) {
                    loginPage.classList.add('hidden');
                    dashboardPage.classList.remove('hidden');
                    document.getElementById('admin-welcome-name').textContent = user.displayName || 'Admin';
                    ThemeManager.renderSidebarControl('sidebar-theme-container');

                    // Init Editors
                    quills.general = initQuill('editor-general');
                    quills.users = initQuill('editor-users');
                    quills.merchants = initQuill('editor-merchants');

                    loadTerms();
                } else {
                    forceLogin();
                }
            } else {
                forceLogin();
            }
        });

        function forceLogin() {
            dashboardPage.classList.add('hidden');
            loginPage.classList.remove('hidden');
        }

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // Load Terms
        async function loadTerms() {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.remove('hidden');
            try {
                const docSnap = await getDoc(doc(db, "settings", "terms_content"));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    quills.general.root.innerHTML = data.general || DEFAULTS.general;
                    quills.users.root.innerHTML = data.users || DEFAULTS.users;
                    quills.merchants.root.innerHTML = data.merchants || DEFAULTS.merchants;
                } else {
                    // Load Defaults if no custom data
                    quills.general.root.innerHTML = DEFAULTS.general;
                    quills.users.root.innerHTML = DEFAULTS.users;
                    quills.merchants.root.innerHTML = DEFAULTS.merchants;
                }
            } catch (error) {
                console.error("Error loading terms:", error);
                alert("خطأ في تحميل البيانات");
            } finally {
                overlay.classList.add('hidden');
            }
        }

        // Restore Original
        window.restoreOriginal = function (section) {
            if (confirm('هل أنت متأكد من استعادة النص الأصلي لهذا القسم؟ سيتم حذف أي تعديلات قمت بها.')) {
                if (quills[section] && DEFAULTS[section]) {
                    quills[section].root.innerHTML = DEFAULTS[section];
                }
            }
        };

        // Clear Section
        window.clearSection = function (section) {
            if (confirm('هل أنت متأكد من مسح محتوى هذا القسم بالكامل؟')) {
                if (quills[section]) {
                    quills[section].root.innerHTML = '';
                }
            }
        };

        // Save Terms
        window.saveTerms = async function () {
            const btn = document.getElementById('save-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...`;

            // Get HTML content from Quill
            const general = quills.general.root.innerHTML;
            const users = quills.users.root.innerHTML;
            const merchants = quills.merchants.root.innerHTML;

            try {
                await setDoc(doc(db, "settings", "terms_content"), {
                    general,
                    users,
                    merchants,
                    updatedAt: serverTimestamp()
                });
                alert("تم حفظ التعديلات بنجاح!");
            } catch (error) {
                console.error("Error saving terms:", error);
                alert("حدث خطأ أثناء الحفظ: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };
    </script>
</body>

</html>