<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - كسب النقاط (المهام)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="app-style.css">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f1f5f9;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        .small-loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
        }

        .toast {
            background-color: #2f855a;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInUp 0.3s ease, fadeOut 0.5s ease 2.5s forwards;
        }

        .toast.error {
            background-color: #c53030;
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        /* ستايل زر رفع الإثبات (من المطاعم) */
        .proof-btn.is-pending {
            background-color: #6b7280;
            /* gray-500 */
            cursor: not-allowed;
        }

        .proof-btn.is-approved {
            background-color: #16a34a;
            /* green-600 */
            cursor: not-allowed;
        }

        .fa-spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>

<body>

    <header class="bg-white shadow-sm sticky top-0 z-30">
    </header>


    <main class="max-w-3xl mx-auto py-12 px-4 sm:px-6 lg:px-8">

        <div id="auth-loader" class="text-center py-20">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600 text-lg">جاري التحقق من هويتك...</p>
        </div>

        <div id="tasks-content" class="hidden space-y-8" style="animation: slideInUp 0.5s ease-out;">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 text-center">
                <i class="fas fa-tasks text-purple-500"></i>
                مهام كسب النقاط
            </h1>
            <p class="text-center text-lg text-gray-600 -mt-4">أكمل المهام التالية واحصل على نقاط مجانية!</p>

            <div id="tasks-container" class="bg-white rounded-2xl shadow-xl p-6 mt-8">
                <h3 class="text-xl font-bold mb-4 border-b pb-2">
                    المهام المتاحة
                </h3>
                <div id="tasks-loader" class="text-center">
                    <div class="loader mx-auto !w-10 !h-10 !border-4"></div>
                    <p class="mt-2 text-gray-500">جاري تحميل المهام...</p>
                </div>
                <div id="tasks-list" class="space-y-4">
                </div>
                <div id="no-tasks-msg" class="hidden text-center text-gray-500 p-4">
                    لا توجد مهام متاحة حالياً.
                </div>
            </div>

            <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 rounded-md">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="ml-3 mr-3">
                        <p class="text-sm">
                            **ملاحظة هامة:** سيتم إضافة النقاط إلى رصيدك فقط **بعد** مراجعة الإثبات والموافقة عليه من
                            قبل الإدارة.
                        </p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <input type="file" id="proof-upload-input" class="hidden" accept="image/png, image/jpeg">

    <div id="toast-container"></div>

    <script type="module">
        // (تم التعديل) استخدام إعدادات S22 Market
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, where, orderBy, onSnapshot, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- عناصر الواجهة ---
        const authLoader = document.getElementById('auth-loader');
        const tasksContent = document.getElementById('tasks-content');

        let currentUser = null;
        let currentTaskData = {}; // لحفظ بيانات المهمة عند الرفع

        // --- (دالة مساعدة: showToast) ---
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'error' : ''}`;
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
            toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };

        // --- (جديد) دالة رفع الصور لـ ImgBB ---
        // (هذه الدالة ضرورية لصفحة المهام)
        async function uploadImageToImgBB(file) {
            // (استخدم مفتاح ImgBB الخاص بك هنا)
            const apiKey = "ac296feb5a275923598bdbfd4f9aed8c";
            const formData = new FormData();
            formData.append('image', file);
            formData.append('key', apiKey);

            const response = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: formData });

            if (!response.ok) throw new Error(`ImgBB upload failed with status ${response.status}`);

            const result = await response.json();

            if (result.success) return result.data.url;
            else throw new Error(`ImgBB Error: ${result.error.message}`);
        }


        // --- (معدل) دوال جلب وعرض المهام ---
        async function loadTasks(user) {
            const listContainer = document.getElementById('tasks-list');
            const loader = document.getElementById('tasks-loader');
            const noTasksMsg = document.getElementById('no-tasks-msg');

            listContainer.innerHTML = '';
            loader.classList.remove('hidden');
            noTasksMsg.classList.add('hidden');

            try {
                // (جديد) جلب المهام والطلبات المعلقة معاً
                // (ملاحظة) هذا هو "العقل" المنسوخ من المطاعم
                const tasksRef = collection(db, "settings", "loyalty", "tasks");
                const approvalsRef = collection(db, "loyalty_approvals");

                const [tasksSnapshot, approvalsSnapshot] = await Promise.all([
                    getDocs(query(tasksRef, orderBy("title"))),
                    getDocs(query(approvalsRef, where("userId", "==", user.uid))) // (تم التبسيط) جلب كل طلبات العميل
                ]);

                // إنشاء قائمة بالمهام التي قيد المراجعة أو تمت الموافقة عليها
                const submittedTasks = {};
                approvalsSnapshot.forEach(doc => {
                    const approval = doc.data();
                    // (تم التعديل) التأكد من أننا نتحقق فقط من مهام "task_reward"
                    if (approval.type === 'task_reward' || approval.type === 'task') { // (دعم النوع القديم والجديد)
                        submittedTasks[approval.taskTitle] = approval.status; // "pending" or "approved"
                    }
                });

                if (tasksSnapshot.empty) {
                    noTasksMsg.classList.remove('hidden');
                } else {
                    tasksSnapshot.forEach(doc => {
                        const task = doc.data();
                        const status = submittedTasks[task.title]; // التحقق من الحالة
                        listContainer.appendChild(createTaskCard(task, status));
                    });
                }
            } catch (error) {
                console.error("Error loading tasks:", error);
                noTasksMsg.textContent = 'فشل تحميل المهام المتاحة.';
                noTasksMsg.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
            }
        }

        // (معدل) دالة إنشاء كرت المهمة (مع نظام الإثبات الجديد)
        function createTaskCard(task, status) {
            const card = document.createElement('div');
            card.className = 'border rounded-lg p-4 flex flex-col md:flex-row justify-between items-center gap-4';

            let proofButtonHtml = '';
            if (status === 'pending') {
                proofButtonHtml = `
                <button class="flex-1 text-center bg-gray-500 text-white font-bold py-2 px-4 rounded-lg proof-btn is-pending" disabled>
                    <i class="fas fa-clock ml-2"></i>
                    قيد المراجعة
                </button>`;
            } else if (status === 'approved') {
                proofButtonHtml = `
                <button class="flex-1 text-center bg-green-600 text-white font-bold py-2 px-4 rounded-lg proof-btn is-approved" disabled>
                    <i class="fas fa-check-circle ml-2"></i>
                    تمت الموافقة
                </button>`;
            } else {
                // زر "إثبات الدفع" للدورات أو المهام
                proofButtonHtml = `
                <button class="proof-btn flex-1 text-center bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600"
                        data-title="${task.title}" data-points="${task.points}">
                    <i class="fas fa-camera ml-2"></i>
                    إثبات (صورة)
                </button>`;
            }

            // (جديد) تحديد الأيقونة المناسبة
            const getIconForTask = (link) => {
                if (link.includes('instagram.com')) return 'fa-instagram';
                if (link.includes('facebook.com') || link.includes('fb.me')) return 'fa-facebook';
                if (link.includes('tiktok.com')) return 'fa-tiktok';
                if (link.includes('twitter.com') || link.includes('x.com')) return 'fa-twitter';
                return 'fa-link';
            }

            card.innerHTML = `
                <div class="flex items-center gap-4">
                    <i class="fab ${getIconForTask(task.link)} fa-2x text-purple-500"></i>
                    <div>
                        <p class="font-bold text-lg">${task.title}</p>
                        <p class="font-bold text-green-600 text-lg">+${task.points} نقطة</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <a href="${task.link}" target="_blank" class="flex-1 text-center bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">
                        <i class="fas fa-external-link-alt ml-2"></i>
                        ابدأ
                    </a>
                    ${proofButtonHtml}
                </div>
            `;
            return card;
        }

        // --- (جديد) مستمعات أحداث رفع الإثبات ---
        document.getElementById('tasks-list').addEventListener('click', (e) => {
            const proofBtn = e.target.closest('.proof-btn:not(:disabled)');
            if (proofBtn) {
                // حفظ بيانات المهمة مؤقتاً
                currentTaskData = {
                    title: proofBtn.dataset.title,
                    points: parseInt(proofBtn.dataset.points, 10),
                    button: proofBtn // حفظ الزر لتعطيله
                };
                // فتح نافذة اختيار الملف
                document.getElementById('proof-upload-input').click();
            }
        });

        document.getElementById('proof-upload-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const { title, points, button } = currentTaskData;
            if (!title) return; // لا توجد مهمة محددة

            button.disabled = true;
            button.innerHTML = `<i class="fas fa-spinner fa-spin ml-2"></i> جاري الرفع...`;
            showToast('جاري رفع صورة الإثبات...', 'success');

            try {
                const imageUrl = await uploadImageToImgBB(file);

                // (جديد) إنشاء طلب موافقة في Firestore
                await addDoc(collection(db, "loyalty_approvals"), {
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    type: "task_reward", // (تم التعديل) تحديد نوع الطلب
                    taskTitle: title,
                    points: points,
                    proofImageUrl: imageUrl,
                    status: "pending", // الحالة: قيد المراجعة
                    submittedAt: serverTimestamp()
                });

                showToast('تم إرسال إثباتك! ستتم مراجعته من قبل الإدارة.', 'success');
                // تحديث الزر ليعكس الحالة الجديدة
                button.innerHTML = `<i class="fas fa-clock ml-2"></i> قيد المراجعة`;
                button.classList.add('is-pending');

            } catch (error) {
                console.error("Upload or save error:", error);
                showToast('فشل إرسال الإثبات. الرجاء المحاولة مجدداً.', 'error');
                button.disabled = false;
                button.innerHTML = `<i class="fas fa-camera ml-2"></i> إثبات (صورة)`;
            } finally {
                // مسح الملف من المدخل لإعادة الاستخدام
                e.target.value = null;
                currentTaskData = {};
            }
        });


        // --- منطق المصادقة والتحكم بالصفحة (لـ S22 Market) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user; // (جديد) حفظ المستخدم

                // (ملاحظة: هذا الكود يفترض وجود عناصر الهيدر في هذه الصفحة)
                const loginBtn = document.getElementById('login-btn');
                const userMenu = document.getElementById('user-menu');
                if (loginBtn) loginBtn.classList.add('hidden');
                if (userMenu) userMenu.classList.remove('hidden');

                const displayName = user.displayName || "عميلنا";
                const userMenuName = document.getElementById('user-menu-name');
                const userMenuDisplayName = document.getElementById('user-menu-displayname');

                if (userMenuName) userMenuName.textContent = displayName.split(' ')[0];
                if (userMenuDisplayName) userMenuDisplayName.textContent = displayName;

                // بدء تحميل بيانات الصفحة
                authLoader.classList.add('hidden');
                tasksContent.classList.remove('hidden');
                loadTasks(user);

            } else {
                window.location.href = 'login.html';
            }
        });

        // --- معالجات القائمة وتسجيل الخروج (لـ S22 Market) ---
        const userMenuButton = document.getElementById('user-menu-button');
        const userMenuDropdown = document.getElementById('user-menu-dropdown');
        const logoutBtn = document.getElementById('logout-btn');

        if (userMenuButton) {
            userMenuButton.addEventListener('click', (e) => {
                e.stopPropagation();
                userMenuDropdown.classList.toggle('show');
            });
        }
        document.addEventListener('click', () => {
            if (userMenuDropdown && userMenuDropdown.classList.contains('show')) {
                userMenuDropdown.classList.remove('show');
            }
        });
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                signOut(auth).catch((error) => console.error('Logout Error', error));
            });
        }
    </script>
</body>

</html>