<!DOCTYPE html>
<html lang="ar" dir="rtl">





<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - ط³ظ„ط© ط§ظ„ظ…ط´طھط±ظٹط§طھ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="app-style.css">
    <style>
        /* Cart Specific Overrides */
        .quantity-btn {
            width: 30px;
            height: 30px;
            background-color: #f1f5f9;
            color: #475569;
            border-radius: 50%;
            font-weight: bold;
        }

        .quantity-btn:hover {
            background-color: #e2e8f0;
        }

        #user-menu-dropdown.show {
            display: block;
            animation: slideInUp 0.2s ease-out;
        }

        :root {
            --bottom-nav-height: 56px;
        }

        body {
            padding-bottom: 168px;
            /* Mobile Sticky bar space */
        }

        @media (min-width: 1024px) {
            body {
                padding-bottom: 0;
            }
        }
    </style>
</head>

<body class="pb-24">
    <header class="bg-white shadow-sm sticky top-0 z-30">
        <div class="max-w-7xl mx-auto py-3 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-3">
                <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800">
                    S22<span class="text-blue-600">MARKET</span>
                </h1>
            </a>

            <div id="header-actions" class="flex items-center gap-4 relative">
                <a href="login.html" id="login-btn"
                    class="hidden relative text-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 px-5 py-2.5 rounded-full transition-colors items-center gap-2 sm:flex">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>ط¯ط®ظˆظ„ / طھط³ط¬ظٹظ„</span>
                </a>

                <div id="user-menu" class="hidden">
                    <button id="user-menu-button"
                        class="flex items-center gap-2 text-lg font-semibold text-gray-700 bg-green-100 hover:bg-green-200 px-5 py-2.5 rounded-full transition-colors">
                        <i class="fas fa-user-check text-green-700"></i>
                        <span id="user-menu-name">...</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div id="user-menu-dropdown"
                        class="hidden absolute left-0 top-full mt-2 w-60 bg-white rounded-xl shadow-lg border z-50 overflow-hidden">
                        <div class="p-3 border-b">
                            <p class="text-sm text-gray-500">ظ…ط±ط­ط¨ط§ظ‹ ط¨ظƒطŒ</p>
                            <p class="font-bold text-gray-800" id="user-menu-displayname">...</p>
                        </div>
                        <a href="profile.html"
                            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i
                                class="fas fa-user-circle fa-fw ml-2 text-gray-400"></i> ظ…ظ„ظپظٹ ط§ظ„ط´ط®طµظٹ
                            ظˆظ…ط­ط§ظپط·ظٹ</a>
                        <a href="seller-dashboard.html"
                            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i
                                class="fas fa-store fa-fw ml-2 text-blue-400"></i> ظ„ظˆط­ط© طھط­ظƒظ… ط§ظ„ط¨ط§ط¦ط¹</a>
                        <a href="order_history.html"
                            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i
                                class="fas fa-archive fa-fw ml-2 text-gray-400"></i> ط£ط±ط´ظٹظپ ط·ظ„ط¨ط§طھظٹ</a>
                        <a href="loyalty_card.html"
                            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i
                                class="fas fa-star fa-fw ml-2 text-orange-400"></i> ط¨ط·ط§ظ‚ط© ط§ظ„ظˆظپط§ط،
                            (ط§ظ„ط¬ظˆط§ظ‡ط±)</a>
                        <button id="logout-btn"
                            class="w-full text-right px-4 py-3 text-red-600 hover:bg-red-50 border-t transition-colors"><i
                                class="fas fa-sign-out-alt fa-fw ml-2"></i> طھط³ط¬ظٹظ„ ط§ظ„ط®ط±ظˆط¬</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main id="cart-page-container" class="max-w-7xl mx-auto py-6 sm:py-8 md:py-10 px-4 sm:px-6 lg:px-8 pb-32">

        <!-- Tabs Switcher -->
        <div class="flex justify-center mb-8">
            <div class="bg-gray-100 p-1 rounded-2xl flex w-full max-w-md relative">
                <div id="tab-indicator"
                    class="absolute top-1 bottom-1 w-[48%] bg-white rounded-xl shadow-sm transition-all duration-300 ease-in-out left-1">
                </div>
                <button onclick="switchCartTab('market')" id="tab-market"
                    class="flex-1 py-3 rounded-xl font-bold text-sm relative z-10 transition-colors text-indigo-600">
                    <i class="fas fa-shopping-bag mr-2"></i> طھط³ظˆظ‚ ظ…ظ†طھط¬ط§طھ
                </button>
                <button onclick="switchCartTab('food')" id="tab-food"
                    class="flex-1 py-3 rounded-xl font-bold text-sm relative z-10 transition-colors text-gray-500">
                    <i class="fas fa-utensils mr-2"></i> ط·ظ„ط¨ط§طھ ط·ط¹ط§ظ…
                </button>
            </div>
        </div>

        <div id="cart-loader" class="hidden max-w-4xl mx-auto space-y-4">
            <!-- Skeletons -->
            <div class="flex items-center gap-4 bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                <div class="w-20 h-20 rounded-md skeleton flex-shrink-0"></div>
                <div class="flex-grow space-y-2">
                    <div class="h-5 w-1/2 rounded skeleton"></div>
                    <div class="h-4 w-1/4 rounded skeleton"></div>
                </div>
                <div class="w-10 h-8 rounded skeleton"></div>
            </div>
        </div>

        <!-- Empty State (Global) -->
        <div id="empty-cart-msg"
            class="hidden text-center py-20 bg-white rounded-3xl shadow-sm border border-dashed border-gray-200">
            <div class="w-24 h-24 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-shopping-basket text-4xl text-gray-300"></i>
            </div>
            <h1 class="text-2xl font-extrabold text-gray-900 mb-2">ط³ظ„طھظƒ ظپط§ط±ط؛ط©!</h1>
            <p class="text-gray-500 mb-8 max-w-xs mx-auto">ظ„ظ… طھظ‚ظ… ط¨ط¥ط¶ط§ظپط© ط£ظٹ ظ…ظ†طھط¬ط§طھ ظپظٹ ظ‡ط°ط§
                ط§ظ„ظ‚ط³ظ… ط¨ط¹ط¯.</p>
            <a href="index.html"
                class="inline-flex items-center gap-2 bg-indigo-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200">
                ط§ط¨ط¯ط£ ط§ظ„طھط³ظˆظ‚
            </a>
        </div>

        <!-- Cart Content -->
        <div id="cart-content" class="hidden min-h-[400px]">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                <!-- Items List -->
                <div class="lg:col-span-2 space-y-6" id="cart-items-container">
                    <!-- Dynamic Content Injected Here -->
                </div>

                <!-- Summary Sidebar -->
                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 lg:sticky lg:top-28">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fas fa-receipt text-gray-400"></i> ظ…ظ„ط®طµ ط§ظ„ط·ظ„ط¨
                        </h2>

                        <div id="order-summary" class="space-y-4 mb-6">
                            <div class="flex justify-between font-medium text-gray-600">
                                <span>ط§ظ„ظ…ط¬ظ…ظˆط¹ ط§ظ„ظپط±ط¹ظٹ</span>
                                <span id="summary-subtotal" class="font-mono text-gray-900">0 ط¯.ط¬</span>
                            </div>

                            <!-- Coupon -->
                            <div class="pt-4 border-t border-dashed">
                                <div class="flex gap-2">
                                    <input type="text" id="coupon-code" placeholder="ظƒظˆط¯ ط®طµظ…طں"
                                        class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm font-mono uppercase focus:ring-2 focus:ring-indigo-500 outline-none">
                                    <button type="button" id="apply-coupon-btn"
                                        class="w-20 bg-gray-900 text-white font-bold rounded-xl text-sm hover:bg-gray-800 transition">
                                        طھط·ط¨ظٹظ‚
                                    </button>
                                </div>
                                <p id="coupon-msg" class="text-xs mt-2 hidden"></p>
                            </div>

                            <div class="flex justify-between font-medium text-gray-600 pt-2">
                                <span>ط§ظ„طھظˆطµظٹظ„</span>
                                <span id="summary-shipping" class="font-mono text-gray-900 text-sm">ظٹط­ط¯ط¯ ط¹ظ†ط¯
                                    ط§ظ„ط·ظ„ط¨</span>
                            </div>

                            <div class="flex justify-between text-xl font-black border-t pt-4 mt-2">
                                <span>ط§ظ„ط¥ط¬ظ…ط§ظ„ظٹ</span>
                                <span id="summary-total" class="font-mono text-indigo-600">0 ط¯.ط¬</span>
                            </div>
                        </div>

                        <button type="button" id="desktop-checkout-btn"
                            class="hidden lg:flex w-full justify-center items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-4 rounded-xl shadow-lg shadow-indigo-200 transition-all hover:scale-[1.02]">
                            <span>ط¥طھظ…ط§ظ… ط§ظ„ط·ظ„ط¨</span>
                            <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Mobile Sticky Checkout Bar -->
    <div id="mobile-checkout-bar"
        class="fixed bottom-[70px] left-4 right-4 bg-white/90 backdrop-blur-md border border-gray-100 p-4 rounded-2xl shadow-2xl z-40 lg:hidden transform transition-transform duration-300 translate-y-full">
        <div class="flex justify-between items-center gap-4">
            <div class="flex flex-col">
                <span class="text-xs text-gray-500 font-bold">ط§ظ„ط¥ط¬ظ…ط§ظ„ظٹ</span>
                <p id="mobile-sticky-total" class="text-xl font-black text-indigo-600 font-mono">0 ط¯.ط¬</p>
            </div>
            <button id="mobile-checkout-btn"
                class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-indigo-200">
                <span>ط¥طھظ…ط§ظ… ط§ظ„ط·ظ„ط¨</span>
                <i class="fas fa-arrow-left"></i>
            </button>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="modal-backdrop z-[100]">
        <div class="modal-content overflow-hidden flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-5 border-b bg-gray-50">
                <h3 class="text-xl font-black text-gray-800 flex items-center gap-2">
                    <i class="fas fa-shield-alt text-green-500"></i> ط¥طھظ…ط§ظ… ط§ظ„ط·ظ„ط¨
                </h3>
                <button id="close-checkout-modal-btn"
                    class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 hover:bg-gray-300 hover:text-red-500 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 scrollbar-hide">
                <form id="checkout-form" class="space-y-5">

                    <!-- Type Specific Notice -->
                    <div id="checkout-type-notice"
                        class="bg-blue-50 text-blue-800 p-3 rounded-xl text-sm font-bold flex items-center gap-2">
                        <i class="fas fa-info-circle"></i> <span>ط¬ط§ط±ظٹ ط¥طھظ…ط§ظ… ط·ظ„ط¨ طھط³ظˆظ‚</span>
                    </div>

                    <h3 class="font-bold text-gray-700 border-b pb-2">ظ…ط¹ظ„ظˆظ…ط§طھ ط§ظ„ط§ط³طھظ„ط§ظ…</h3>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">ط§ظ„ط§ط³ظ…</label>
                            <input type="text" id="q-customer-name"
                                class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition"
                                required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">ط±ظ‚ظ… ط§ظ„ظ‡ط§طھظپ</label>
                            <input type="tel" id="q-customer-phone"
                                class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition"
                                dir="ltr" required>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">ط§ظ„ظˆظ„ط§ظٹط© &
                            ط§ظ„ط¨ظ„ط¯ظٹط©</label>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="q-customer-wilaya" placeholder="ط§ظ„ظˆظ„ط§ظٹط©"
                                class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition"
                                required>
                            <input type="text" id="q-customer-baladiya" placeholder="ط§ظ„ط¨ظ„ط¯ظٹط©"
                                class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition"
                                required>
                        </div>
                    </div>

                    <!-- GPS Field (Enhanced for Food) -->
                    <div id="gps-field-container">
                        <label class="block text-xs font-bold text-gray-500 mb-1 flex justify-between">
                            <span>ط§ظ„ط¹ظ†ظˆط§ظ† / ط§ظ„ظ…ظˆظ‚ط¹</span>
                            <span class="text-orange-500 text-[10px]" id="gps-required-hint">* ظٹظپط¶ظ„ GPS
                                ظ„ط·ط¹ط§ظ…</span>
                        </label>
                        <div class="relative">
                            <i class="fas fa-map-marker-alt absolute right-3 top-3.5 text-gray-400"></i>
                            <input type="url" id="q-customer-gps"
                                placeholder="ط±ط§ط¨ط· ظ…ظˆظ‚ط¹ظƒ ظ…ظ† Maps (ط§ط®طھظٹط§ط±ظٹ)"
                                class="w-full p-3 pr-10 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition"
                                dir="ltr">
                        </div>
                        <textarea id="q-customer-address"
                            class="mt-2 w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition text-sm"
                            rows="2" placeholder="ظˆطµظپ ط¯ظ‚ظٹظ‚ ظ„ظ„ظ…ظ†ط²ظ„/ط§ظ„ظ…ظƒط§ظ†..." required></textarea>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">ظ…ظ„ط§ط­ط¸ط§طھ</label>
                        <textarea id="q-customer-notes"
                            class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition text-sm"
                            rows="1" placeholder="ط£ظٹ طھظپط§طµظٹظ„ ط¥ط¶ط§ظپظٹط©..."></textarea>
                    </div>

                    <!-- Extra Features (Hidden by default, toggleable) -->
                    <div class="space-y-3 pt-2">
                        <!-- Scheduling -->
                        <div class="border border-gray-100 rounded-xl overflow-hidden">
                            <button type="button"
                                onclick="document.getElementById('schedule-options').classList.toggle('hidden')"
                                class="w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 transition">
                                <span class="text-sm font-bold text-gray-700"><i
                                        class="fas fa-clock text-indigo-500 ml-2"></i> ط¬ط¯ظˆظ„ط© ط§ظ„طھظˆطµظٹظ„</span>
                                <i class="fas fa-chevron-down text-xs text-gray-400"></i>
                            </button>
                            <div id="schedule-options" class="hidden p-4 bg-white">
                                <label class="flex items-center gap-2 mb-2 cursor-pointer">
                                    <input type="checkbox" id="is-scheduled-checkbox" class="accent-indigo-600 w-4 h-4">
                                    <span class="text-sm">طھظپط¹ظٹظ„ ط§ظ„ط¬ط¯ظˆظ„ط©</span>
                                </label>
                                <select id="schedule-frequency"
                                    class="w-full p-2 bg-gray-50 rounded-lg text-sm border border-gray-200">
                                    <option value="daily">ظٹظˆظ…ظٹط§ظ‹</option>
                                    <option value="weekly">ط£ط³ط¨ظˆط¹ظٹط§ظ‹</option>
                                    <option value="monthly">ط´ظ‡ط±ظٹط§ظ‹</option>
                                </select>
                            </div>
                        </div>
                    </div>

                </form>
            </div>

            <div class="p-5 border-t bg-gray-50">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-600 font-bold">ط§ظ„ظ…ط¬ظ…ظˆط¹ ط§ظ„ظƒظ„ظٹ</span>
                    <span id="modal-summary-total" class="text-2xl font-black text-indigo-600 font-mono">0 ط¯.ط¬</span>
                </div>
                <button type="submit" form="checkout-form" id="submit-quick-checkout-btn"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-200 transition transform active:scale-95 flex justify-center items-center gap-2">
                    <span>طھط£ظƒظٹط¯ ط§ظ„ط·ظ„ط¨</span>
                    <i class="fas fa-check-circle"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <!-- Mobile Enhancements moved to app-core.js -->

    <script type="module">
        import { db, auth } from './app-core.js';
        import {
            collection, addDoc, doc, getDoc, serverTimestamp, query, where, limit, getDocs, updateDoc,
            increment
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let currentUser = null;
        let cart = [];
        let currentDiscount = null;
        let activeTab = 'market'; // 'market' or 'food'
        let activeGlobalLogo = 'https://placehold.co/100/1f2937/ffffff?text=Logo'; // Fallback

        // Fetch Global Config
        async function fetchGlobalConfig() {
            try {
                const globalSettingsSnap = await getDoc(doc(db, "settings", "storeConfig"));
                if (globalSettingsSnap.exists()) {
                    const gData = globalSettingsSnap.data();
                    if (gData.logoUrl) {
                        activeGlobalLogo = gData.logoUrl;
                        renderCartItems(); // Re-render to update logos if cart is already loaded
                    }
                }
            } catch (err) { console.log("Global logo fetch error", err); }
        }
        fetchGlobalConfig();

        const elements = {
            loader: document.getElementById('cart-loader'),
            emptyMsg: document.getElementById('empty-cart-msg'),
            content: document.getElementById('cart-content'),
            itemsList: document.getElementById('cart-items-container'),
            subtotal: document.getElementById('summary-subtotal'),
            total: document.getElementById('summary-total'),

            couponInput: document.getElementById('coupon-code'),
            couponBtn: document.getElementById('apply-coupon-btn'),
            couponMsg: document.getElementById('coupon-msg'),
            discountRow: document.getElementById('discount-row'),

            checkoutModal: document.getElementById('checkout-modal'),
            closeCheckoutModalBtn: document.getElementById('close-checkout-modal-btn'),
            checkoutForm: document.getElementById('checkout-form'),
            submitBtn: document.getElementById('submit-quick-checkout-btn'),
            modalTotal: document.getElementById('modal-summary-total'),
            checkoutTypeNotice: document.getElementById('checkout-type-notice'),

            cartBadgeBottom: document.getElementById('cart-badge-bottom'),
            mobileCheckoutBar: document.getElementById('mobile-checkout-bar'),
            mobileStickyTotal: document.getElementById('mobile-sticky-total'),
            mobileCheckoutBtn: document.getElementById('mobile-checkout-btn'),
            desktopCheckoutBtn: document.getElementById('desktop-checkout-btn'),

            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            bottomProfileBtn: document.getElementById('bottom-profile-btn'),
            bottomLoginBtn: document.getElementById('bottom-login-btn'),
            toastContainer: document.getElementById('toast-container'),

            tabIndicator: document.getElementById('tab-indicator'),
            tabMarket: document.getElementById('tab-market'),
            tabFood: document.getElementById('tab-food'),
        };

        // --- Tab Logic ---
        window.switchCartTab = (tab) => {
            activeTab = tab;

            // UI Update
            if (tab === 'market') {
                elements.tabIndicator.style.transform = 'translateX(0%)'; // Assuming LTR or absolute positioning logic
                // Adjust for RTL if needed:
                elements.tabIndicator.style.left = '1%';
                elements.tabMarket.classList.replace('text-gray-500', 'text-indigo-600');
                elements.tabFood.classList.replace('text-indigo-600', 'text-gray-500');
            } else {
                elements.tabIndicator.style.left = '51%';
                elements.tabFood.classList.replace('text-gray-500', 'text-indigo-600');
                elements.tabMarket.classList.replace('text-indigo-600', 'text-gray-500');
            }

            renderCartItems();
        };

        // --- Helper Functions ---
        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-24 left-1/2 -translate-x-1/2 z-[999] bg-gray-800 text-white px-6 py-3 rounded-full
    shadow-2xl flex items-center gap-3 animate-bounce`;
            toast.innerHTML = `<i
        class="fas ${type === 'success' ? 'fa-check-circle text-green-400' : 'fa-exclamation-circle text-red-400'}"></i>
    ${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };

        const toggleButtonState = (btn, isLoading, originalText = 'طھط£ظƒظٹط¯') => {
            if (!btn) return;
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
            } else {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        // --- Cart Logic ---
        function loadCart() {
            cart = JSON.parse(localStorage.getItem('s22market_cart')) || [];

            // Migration: Add default type if missing
            let dirt = false;
            cart = cart.map(item => {
                if (!item.itemType) {
                    item.itemType = 'market';
                    dirt = true;
                }
                return item;
            });
            if (dirt) saveCart();

            renderCartItems();
            updateCartIcon();
        }

        function saveCart() {
            localStorage.setItem('s22market_cart', JSON.stringify(cart));
            updateCartIcon();
            renderCartItems();
        }

        function updateCartIcon() {
            const total = cart.reduce((sum, i) => sum + i.quantity, 0);
            if (elements.cartBadgeBottom) {
                elements.cartBadgeBottom.textContent = total;
                elements.cartBadgeBottom.classList.toggle('hidden', total === 0);
            }
        }

        function getFilteredItems() {
            // Updated: Return ONLY active tab items for Checkout and logic coherence
            if (activeTab === 'market') {
                return cart.filter(i => i.itemType === 'market' || !i.itemType);
            } else {
                return cart.filter(i => i.itemType === 'food');
            }
        }

        function renderCartItems() {
            const allItems = cart;
            const container = elements.itemsList;

            elements.loader.classList.add('hidden');

            if (allItems.length === 0) {
                elements.emptyMsg.classList.remove('hidden');
                elements.content.classList.add('hidden');
                elements.mobileCheckoutBar.classList.add('hidden');
                return;
            }

            elements.emptyMsg.classList.add('hidden');
            elements.content.classList.remove('hidden');
            elements.mobileCheckoutBar.classList.remove('hidden');

            container.innerHTML = '';
            let subtotal = 0;

            // 1. Separate Items by Tab focus
            const mainItems = allItems.filter(i => activeTab === 'market' ? (i.itemType === 'market' || !i.itemType) : i.itemType === 'food');
            const otherItems = allItems.filter(i => activeTab === 'market' ? i.itemType === 'food' : (i.itemType === 'market' || !i.itemType));

            // 2. Group Main Items
            const groups = {};
            mainItems.forEach(item => {
                const storeId = item.sellerId || 'unknown';
                if (!groups[storeId]) {
                    groups[storeId] = {
                        name: item.storeName || (activeTab === 'market' ? 'ظ…طھط¬ط± ط¹ط§ظ…' : 'ظ…ط·ط¹ظ… ط؛ظٹط± ظ…ط¹ط±ظˆظپ'),
                        logo: item.storeLogo || item.logoUrl || item.photoURL || activeGlobalLogo,
                        items: [],
                        totalValue: 0,
                        itemCount: 0
                    };
                }
                groups[storeId].items.push(item);
                groups[storeId].totalValue += (item.price * item.quantity);
                groups[storeId].itemCount += item.quantity;
            });

            // 3. Render Groups (Vitality System)
            if (Object.keys(groups).length > 0) {
                Object.values(groups).forEach(group => {
                    subtotal += group.totalValue;

                    // Vitality / Progress Logic
                    // Example: Level 1 (0-5000), Level 2 (5000-10000), etc.
                    const progressPercent = Math.min(100, (group.totalValue / 5000) * 100);
                    const level = Math.floor(group.totalValue / 5000) + 1;

                    const groupEl = document.createElement('div');
                    groupEl.className = 'bg-white rounded-2xl p-5 shadow-sm border border-gray-100 mb-6 relative overflow-hidden group-card';
                    groupEl.innerHTML = `
                        <!-- Vitality Header -->
                        <div class="flex flex-col gap-2 mb-4 pb-3 border-b border-dashed relative z-10">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="relative">
                                        <img src="${group.logo}" class="w-10 h-10 rounded-full bg-gray-100 object-cover border-2 border-white shadow-sm">
                                        <div class="absolute -bottom-1 -right-1 bg-green-500 text-white text-[9px] w-4 h-4 flex items-center justify-center rounded-full border border-white">
                                            ${group.items.length}
                                        </div>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-800 text-base">${group.name}</h3>
                                        <p class="text-[10px] text-gray-400 font-bold">ط¨ط§ط¦ط¹ ظ…ظˆط«ظˆظ‚</p>
                                    </div>
                                </div>
                                <div class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-lg">
                                    ط§ظ„ظ…ط³طھظˆظ‰ ${level}
                                </div>
                            </div>

                            <!-- Progress Bar (Vitality) -->
                            <div class="w-full bg-gray-100 rounded-full h-1.5 mt-1 overflow-hidden">
                                <div class="bg-gradient-to-r from-indigo-500 to-purple-500 h-1.5 rounded-full transition-all duration-1000" style="width: ${progressPercent}%"></div>
                            </div>
                            <p class="text-[10px] text-gray-400 text-left w-full pl-1">ظ…طھط¨ظ‚ظٹ ${Math.max(0, (level * 5000) - group.totalValue)} ط¯.ط¬ ظ„ظ„ظ…ط³طھظˆظ‰ ط§ظ„طھط§ظ„ظٹ</p>
                        </div>

                        <!-- Items -->
                        <div class="space-y-4 relative z-10">
                            ${group.items.map(item => createItemHTML(item)).join('')}
                        </div>

                        <!-- Decorative Background (Vitality) -->
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-indigo-500/20 to-transparent"></div>
                    `;
                    container.appendChild(groupEl);
                });
            } else {
                if (activeTab === 'market') {
                    container.innerHTML = `<div class="text-center py-10 text-gray-400">ظ„ط§ طھظˆط¬ط¯ ظ…ظ†طھط¬ط§طھ طھط³ظˆظ‚ ظپظٹ ط§ظ„ط³ظ„ط©</div>`;
                } else {
                    container.innerHTML = `<div class="text-center py-10 text-gray-400">ظ„ط§ طھظˆط¬ط¯ ط·ظ„ط¨ط§طھ ط·ط¹ط§ظ… ظپظٹ ط§ظ„ط³ظ„ط©</div>`;
                }
            }


            // 4. "Next to the old one" - Cross Category Alert
            if (otherItems.length > 0) {
                const otherType = activeTab === 'market' ? 'ط·ط¹ط§ظ…' : 'طھط³ظˆظ‚';
                const otherIcon = activeTab === 'market' ? 'fa-utensils' : 'fa-shopping-bag';
                const otherColor = activeTab === 'market' ? 'orange' : 'indigo'; // Tailwinds colors

      ment.createElement('div');
                alertEl.className = `mt-6 bg-${otherColor}-50 border border-${otherColor}-100 rounded-2xl p-4 flex items-center justify-between cursor-pointer hover:bg-${otherColor}-100 transition-colors`;
                alertEl.onclick = () => switchCartTab(activeTab === 'market' ? 'food' : 'market');
                alertEl.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center text-${otherColor}-600 shadow-sm text-xl">
                            <i class="fas ${otherIcon} animate-pulse"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 text-sm">ظ„ط¯ظٹظƒ ط³ظ„ط© ${otherType} ط¬ط§ظ†ط¨ظٹط©!</h4>
                            <p class="text-xs text-gray-500">${otherItems.length} ط¹ظ†طµط± ظٹظ†طھط¸ط±ظƒ ظ‡ظ†ط§ظƒ</p>
                        </div>
                    </div>
                    <div class="bg-white px-4 py-2 rounded-lg text-xs font-bold text-${otherColor}-600 shadow-sm">
                        ط¹ط±ط¶ ط§ظ„ط³ظ„ط©
                    </div>
                `;
                container.appendChild(alertEl);
            }

            // 5. Food Upsell (Specific Request)
            if (activeTab === 'food' && mainItems.length > 0) {
                const upsellEl = document.createElement('div');
                upsellEl.className = 'mt-8 border-t pt-4';
                upsellEl.innerHTML = `
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <i class="fas fa-magic text-yellow-500"></i> ط§ظ‚طھط±ط§ط­ط§طھ Dr. S22
                    </h3>
                    <div class="flex gap-3 overflow-x-auto pb-4 scrollbar-hide">
                         <!-- Static Examples for Visuals -->
                         ${createUpsellCard('ط¨ظٹط¨ط³ظٹ', '150', 'https://images.unsplash.com/photo-1629203851122-3726ecdf080c?auto=format&fit=crop&q=80&w=100')}
                         ${createUpsellCard('ط¨ط·ط§ط·ط³ ط¥ط¶ط§ظپظٹط©', '200', 'https://images.unsplash.com/photo-1630384060421-cb20d0e0649d?auto=format&fit=crop&q=80&w=100')}
                         ${createUpsellCard('طµظˆطµ ط«ظˆظ…', '50', 'https://images.unsplash.com/photo-1472476443507-c7a392dd6182?auto=format&fit=crop&q=80&w=100')}
                    </div>
                 `;
                container.appendChild(upsellEl);
            }

            updateSummary(subtotal);
        }

        function createUpsellCard(name, price, img) {
            return `
                <div class="min-w-[100px] bg-white rounded-xl p-2 border border-gray-100 shadow-sm flex flex-col items-center gap-2 cursor-pointer hover:border-indigo-300 transition-colors">
                    <img src="${img}" class="w-12 h-12 rounded-full object-cover bg-gray-50">
                    <span class="text-[10px] font-bold text-gray-700 text-center truncate w-full">${name}</span>
                    <span class="text-xs font-black text-indigo-600">${price} ط¯.ط¬</span>
                    <button class="w-full bg-indigo-50 text-indigo-600 text-[10px] font-bold py-1 rounded hover:bg-indigo-600 hover:text-white transition-colors">ط¥ط¶ط§ظپط©</button>
                </div>
            `;
        }

        function createItemHTML(item, wrap = false) {
            const img = (item.imageUrls && item.imageUrls[0]) || item.image || 'https://placehold.co/100';
            const itemName = typeof item.name === 'object' ? (item.name.ar || item.name.en || 'ظ…ظ†طھط¬') : item.name;
            const html = `
    <div
        class="flex items-center gap-4 ${wrap ? 'bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-4' : ''}">
        <img src="${img}" class="w-20 h-20 rounded-xl bg-gray-50 object-cover border border-gray-100">
        <div class="flex-grow">
            <h4 class="font-bold text-gray-800 text-sm line-clamp-2">${itemName}</h4>
            <p class="text-indigo-600 font-mono font-bold mt-1">${item.price.toLocaleString()} ط¯.ط¬</p>
        </div>
        <div class="flex flex-col items-end gap-2">
            <div class="flex items-center bg-gray-50 rounded-lg border border-gray-200 h-8">
                <button onclick="updateQty('${item.id}', ${item.quantity + 1})"
                    class="w-8 h-full flex items-center justify-center text-gray-600 hover:bg-gray-200 rounded-r-lg">+</button>
                <span class="w-8 text-center font-bold text-sm text-gray-800">${item.quantity}</span>
                <button onclick="updateQty('${item.id}', ${item.quantity - 1})"
                    class="w-8 h-full flex items-center justify-center text-gray-600 hover:bg-gray-200 rounded-l-lg">-</button>
            </div>
            <button onclick="removeItem('${item.id}')"
                class="text-gray-400 hover:text-red-500 text-xs transition-colors">
                <i class="fas fa-trash"></i> ط­ط°ظپ
            </button>
        </div>
    </div>
    `;
            return html;
        }

        function updateSummary(subtotal) {
            let discount = 0;
            if (currentDiscount) {
                if (currentDiscount.discountType === 'percentage') discount = subtotal * (currentDiscount.discountValue / 100);
                else discount = currentDiscount.discountValue;
            }

            const total = Math.max(0, subtotal - discount);

            elements.subtotal.textContent = `${subtotal.toLocaleString()} ط¯.ط¬`;
            elements.total.textContent = `${total.toLocaleString()} ط¯.ط¬`;
            elements.mobileStickyTotal.textContent = `${total.toLocaleString()} ط¯.ط¬`;
            elements.modalTotal.textContent = `${total.toLocaleString()} ط¯.ط¬`;

            if (currentDiscount) {
                elements.couponMsg.textContent = `طھظ… طھط·ط¨ظٹظ‚ ط®طµظ… ${discount.toLocaleString()} ط¯.ط¬`;
                elements.couponMsg.className = 'text-xs mt-2 text-green-600 font-bold';
                elements.couponMsg.classList.remove('hidden');
            } else {
                elements.couponMsg.classList.add('hidden');
            }

            // Context Awareness for Checkout
            const activeCount = cart.filter(i => activeTab === 'market' ? (i.itemType === 'market' || !i.itemType) : i.itemType === 'food').length;
            if (activeCount === 0) {
                elements.mobileCheckoutBar.classList.add('hidden');
                elements.content.classList.add('hidden');
                elements.emptyMsg.classList.remove('hidden');
            } else {
                elements.mobileCheckoutBar.classList.remove('hidden');
            }
        }

        window.updateQty = (id, newQty) => {
            const idx = cart.findIndex(i => i.id === id);
            if (idx > -1) {
                if (newQty <= 0) cart.splice(idx, 1); else cart[idx].quantity = newQty; saveCart();
            }
        }; window.removeItem = (id) => {
            window.updateQty(id, 0);
        };

        // --- Coupon Logic ---
        if (elements.couponBtn) {
            elements.couponBtn.onclick = async () => {
                const code = elements.couponInput.value.trim().toUpperCase();
                if (!code) return;

                toggleButtonState(elements.couponBtn, true);
                try {
                    const q = query(collection(db, 'coupons'), where('code', '==', code), where('isActive', '==', true), limit(1));
                    const snap = await getDocs(q);

                    if (snap.empty) throw new Error('ط§ظ„ظƒظˆط¯ ط؛ظٹط± طµط­ظٹط­');
                    const data = snap.docs[0].data();

                    currentDiscount = { id: snap.docs[0].id, ...data };
                    renderCartItems(); // Re-calc
                } catch (e) {
                    elements.couponMsg.textContent = e.message;
                    elements.couponMsg.className = 'text-xs mt-2 text-red-500 font-bold';
                    elements.couponMsg.classList.remove('hidden');
                    currentDiscount = null;
                }
                toggleButtonState(elements.couponBtn, false, 'طھط·ط¨ظٹظ‚');
            };
        }

        // --- Checkout Logic ---
        async function openCheckout() {
            const user = await requireAuth(auth);
            if (!user) return; // Should have redirected

            elements.checkoutModal.classList.add('active');

            // Context Update
            if (activeTab === 'market') {
                elements.checkoutTypeNotice.className = 'bg-indigo-50 text-indigo-800 p-3 rounded-xl text-sm font-bold flex items-center gap-2';
                elements.checkoutTypeNotice.innerHTML = '<i class="fas fa-shopping-bag"></i> <span>ط¬ط§ط±ظٹ ط¥طھظ…ط§ظ… ط·ظ„ط¨ <b>طھط³ظˆظ‚</b></span>';
                document.getElementById('gps-field-container').classList.add('opacity-50'); // Dim GPS for market
            } else {
                elements.checkoutTypeNotice.className = 'bg-orange-50 text-orange-800 p-3 rounded-xl text-sm font-bold flex items-center gap-2';
                elements.checkoutTypeNotice.innerHTML = '<i class="fas fa-utensils"></i> <span>ط¬ط§ط±ظٹ ط¥طھظ…ط§ظ… ط·ظ„ط¨ <b>ط·ط¹ط§ظ…</b></span>';
                document.getElementById('gps-field-container').classList.remove('opacity-50');
            }

            // Mobile Hook
            if (window.openMobileOverlay) window.openMobileOverlay(() => elements.checkoutModal.classList.remove('active'),
                'checkout');
        }

        elements.desktopCheckoutBtn.onclick = openCheckout;
        elements.mobileCheckoutBtn.onclick = openCheckout;
        elements.closeCheckoutModalBtn.onclick = () => {
            if (window.closeMobileOverlay) window.closeMobileOverlay();
            else elements.checkoutModal.classList.remove('active');
        };

        elements.checkoutForm.onsubmit = async (e) => {
            e.preventDefault();
            const btn = elements.submitBtn;
            const originalContent = btn.innerHTML;
            toggleButtonState(btn, true);

            try {
                const checkoutItems = getFilteredItems();
                if (checkoutItems.length === 0) throw new Error('ظ„ط§ طھظˆط¬ط¯ ط¹ظ†ط§طµط± ظ„ط¥طھظ…ط§ظ… ط§ظ„ط·ظ„ط¨');

                const subtotal = checkoutItems.reduce((sum, i) => sum + (Number(i.price) * Number(i.quantity)), 0);
                const discount = currentDiscount ? (currentDiscount.discountType === 'percentage' ? subtotal *
                    (currentDiscount.discountValue / 100) : currentDiscount.discountValue) : 0;
                const total = Math.max(0, subtotal - discount);

                // Basic Data
                const isScheduled = document.getElementById('is-scheduled-checkbox').checked;
                const scheduleFrequency = document.getElementById('schedule-frequency').value;

                const order = {
                    customerName: document.getElementById('q-customer-name').value,
                    customerContact: document.getElementById('q-customer-phone').value,
                    customerWilaya: document.getElementById('q-customer-wilaya').value,
                    customerBaladiya: document.getElementById('q-customer-baladiya').value,
                    customerLocation: document.getElementById('q-customer-address').value,
                    customerGps: document.getElementById('q-customer-gps').value.trim(),
                    customerInquiry: document.getElementById('q-customer-notes').value,

                    // Scheduling Data
                    isScheduled: isScheduled,
                    scheduleFrequency: isScheduled ? scheduleFrequency : null,

                    items: checkoutItems,
                    totalPrice: total,
                    subtotal: subtotal,
                    discountAmount: discount,
                    couponCode: currentDiscount?.code || null,

                    orderType: activeTab, // 'market' or 'food'
                    status: 'new',
                    createdAt: serverTimestamp(),
                    userId: currentUser?.uid || null
                };

                // Split Orders if Food (Multi-Restaurant) ???
                // For simplicity and user UX, we create ONE main order,
                // BUT if we want to follow strict multi-vendor, we might split.
                // For now: Keep simple. Admin sees one order with items from X and Y.
                // Or better: If 'food', maybe grouping helps drivers?
                // Let's stick to Single Order Document for MVP, but array of items carries sellerIds.

                const ref = await addDoc(collection(db, 'orders'), order);

                // Clear ONLY purchased items
                cart = cart.filter(i => activeTab === 'market' ? i.itemType === 'food' : (i.itemType === 'market' ||
                    !i.itemType));
                saveCart();
                currentDiscount = null;

                // Success
                elements.content.innerHTML = `
        <div class="text-center py-20 bg-white rounded-3xl shadow-sm animate-pulse">
            <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-check text-4xl text-green-600"></i>
            </div>
            <h2 class="text-3xl font-extrabold text-gray-900 mb-2">طھظ… ط§ظ„ط·ظ„ط¨ ط¨ظ†ط¬ط§ط­!</h2>
            <p class="text-gray-500 mb-8">ط±ظ‚ظ… ط§ظ„ط·ظ„ط¨: <span
                    class="font-mono font-bold text-gray-800">#${ref.id.slice(0, 6)}</span></p>
            <a href="index.html" class="inline-block bg-gray-900 text-white font-bold py-3 px-8 rounded-xl">ط§ظ„ط¹ظˆط¯ط©
                ظ„ظ„ط±ط¦ظٹط³ظٹط©</a>
        </div>
        `;
                elements.mobileCheckoutBar.classList.add('hidden');
                if (window.closeMobileOverlay) window.closeMobileOverlay();

            } catch (err) {
                console.error(err);
                showToast(err.message, 'error');
                toggleButtonState(btn, false, originalContent);
            }
        };

        // --- Init ---
        // Initialize
        // --- INLINED AUTH LOGIN (Self-Contained) ---
        // requireAuth definition is kept here, imports and const declarations removed to avoid duplicates
        async function requireAuth(authInstance) {
            await setPersistence(authInstance, browserLocalPersistence);

            return new Promise((resolve) => {
                const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                    if (!user) {
                        // Not logged in -> Redirect to Login
                        // Save return URL manually since we removed helper
                        localStorage.setItem('s22_return_url', window.location.href);
                        window.location.href = 'login.html';
                        resolve(null);
                    } else {
                        // Logged in
                        resolve(user);
                    }
                    unsubscribe();
                });
            });
        }
        // auth and db are already defined at the top

        // Check Auth on Load for Cart
        // We use a hybrid approach here: loading the cart doesn't Strictly require auth until checkout
        // But the previous code might have enforced it. The user wants "Persistent Auth".
        // Let's keep the existing flow but use the new function if called.

        // Global User var
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadCart();
                // Pre-fill
                if (user) {
                    elements.loginBtn?.classList.add('hidden');
                    elements.bottomLoginBtn?.classList.add('hidden');
                    elements.bottomProfileBtn?.classList.remove('hidden');

                    getDoc(doc(db, 'users', user.uid)).then(s => {
                        if (s.exists()) {
                            const d = s.data();
                            if (document.getElementById('q-customer-name')) document.getElementById('q-customer-name').value = d.displayName || '';
                            if (document.getElementById('q-customer-phone')) document.getElementById('q-customer-phone').value = d.phoneNumber || '';
                        }
                    });
                }
            }
        });

        // We need to protect CHECKOUT action then.
        // Let's modify openCheckout to check auth



    </script>
</body>

</html>
