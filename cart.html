<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - سلة المشتريات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="app-style.css">
    <style>
        /* Cart Specific Overrides */
        .quantity-btn {
            width: 30px;
            height: 30px;
            background-color: #f1f5f9;
            color: #475569;
            border-radius: 50%;
            font-weight: bold;
        }

        .quantity-btn:hover {
            background-color: #e2e8f0;
        }

        #user-menu-dropdown.show {
            display: block;
            animation: slideInUp 0.2s ease-out;
        }

        :root {
            --bottom-nav-height: 56px;
        }

        body {
            padding-bottom: 168px;
            /* Mobile Sticky bar space */
        }

        @media (min-width: 1024px) {
            body {
                padding-bottom: 0;
            }
        }
    </style>
</head>

<body class="pb-24">
    <header class="bg-white shadow-sm sticky top-0 z-30">
        <div class="max-w-7xl mx-auto py-3 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-3">
                <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800">
                    S22<span class="text-blue-600">MARKET</span>
                </h1>
            </a>

            <div id="header-actions" class="flex items-center gap-4 relative">
                <a href="login.html" id="login-btn"
                    class="hidden relative text-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 px-5 py-2.5 rounded-full transition-colors items-center gap-2 sm:flex">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>دخول / تسجيل</span>
                </a>

                <div id="user-menu" class="hidden">
                    <button id="user-menu-button"
                        class="flex items-center gap-2 text-lg font-semibold text-gray-700 bg-green-100 hover:bg-green-200 px-5 py-2.5 rounded-full transition-colors">
                        <i class="fas fa-user-check text-green-700"></i>
                        <span id="user-menu-name">...</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div id="user-menu-dropdown"
                        class="hidden absolute left-0 top-full mt-2 w-60 bg-white rounded-xl shadow-lg border z-50 overflow-hidden">
                        <div class="p-3 border-b">
                            <p class="text-sm text-gray-500">مرحباً بك،</p>
                            <p class="font-bold text-gray-800" id="user-menu-displayname">...</p>
                        </div>
                        <a href="profile.html"
                            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i
                                class="fas fa-user-circle fa-fw ml-2 text-gray-400"></i> ملفي الشخصي
                            ومحافظي</a>
                        <a href="seller-dashboard.html"
                            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i
                                class="fas fa-store fa-fw ml-2 text-blue-400"></i> لوحة تحكم البائع</a>
                        <a href="order_history.html"
                            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i
                                class="fas fa-archive fa-fw ml-2 text-gray-400"></i> أرشيف طلباتي</a>
                        <a href="loyalty_card.html"
                            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i
                                class="fas fa-star fa-fw ml-2 text-orange-400"></i> بطاقة الوفاء
                            (الجواهر)</a>
                        <button id="logout-btn"
                            class="w-full text-right px-4 py-3 text-red-600 hover:bg-red-50 border-t transition-colors"><i
                                class="fas fa-sign-out-alt fa-fw ml-2"></i> تسجيل الخروج</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main id="cart-page-container" class="max-w-7xl mx-auto py-6 sm:py-8 md:py-10 px-4 sm:px-6 lg:px-8 pb-32">

        <!-- Tabs Switcher -->
        <div class="flex justify-center mb-8">
            <div class="bg-gray-100 p-1 rounded-2xl flex w-full max-w-md relative">
                <div id="tab-indicator"
                    class="absolute top-1 bottom-1 w-[48%] bg-white rounded-xl shadow-sm transition-all duration-300 ease-in-out left-1">
                </div>
                <button onclick="switchCartTab('market')" id="tab-market"
                    class="flex-1 py-3 rounded-xl font-bold text-sm relative z-10 transition-colors text-indigo-600">
                    <i class="fas fa-shopping-bag mr-2"></i> تسوق منتجات
                </button>
                <button onclick="switchCartTab('food')" id="tab-food"
                    class="flex-1 py-3 rounded-xl font-bold text-sm relative z-10 transition-colors text-gray-500">
                    <i class="fas fa-utensils mr-2"></i> طلبات طعام
                </button>
            </div>
        </div>

        <div id="cart-loader" class="hidden max-w-4xl mx-auto space-y-4">
            <!-- Skeletons -->
            <div class="flex items-center gap-4 bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                <div class="w-20 h-20 rounded-md skeleton flex-shrink-0"></div>
                <div class="flex-grow space-y-2">
                    <div class="h-5 w-1/2 rounded skeleton"></div>
                    <div class="h-4 w-1/4 rounded skeleton"></div>
                </div>
                <div class="w-10 h-8 rounded skeleton"></div>
            </div>
        </div>

        <!-- Empty State (Global) -->
        <div id="empty-cart-msg"
            class="hidden text-center py-20 bg-white rounded-3xl shadow-sm border border-dashed border-gray-200">
            <div class="w-24 h-24 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-shopping-basket text-4xl text-gray-300"></i>
            </div>
            <h1 class="text-2xl font-extrabold text-gray-900 mb-2">سلتك فارغة!</h1>
            <p class="text-gray-500 mb-8 max-w-xs mx-auto">لم تقم بإضافة أي منتجات في هذا
                القسم بعد.</p>
            <a href="index.html"
                class="inline-flex items-center gap-2 bg-indigo-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200">
                ابدأ التسوق
            </a>
        </div>

        <!-- Cart Content -->
        <div id="cart-content" class="hidden min-h-[400px]">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                <!-- Items List -->
                <div class="lg:col-span-2 space-y-6" id="cart-items-container">
                    <!-- Dynamic Content Injected Here -->
                </div>

                <!-- Summary Sidebar -->
                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 lg:sticky lg:top-28">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fas fa-receipt text-gray-400"></i> ملخص الطلب
                        </h2>

                        <div id="order-summary" class="space-y-4 mb-6">
                            <div class="flex justify-between font-medium text-gray-600">
                                <span>المجموع الفرعي</span>
                                <span id="summary-subtotal" class="font-mono text-gray-900">0 د.ج</span>
                            </div>

                            <!-- Coupon -->
                            <div class="pt-4 border-t border-dashed">
                                <div class="flex gap-2">
                                    <input type="text" id="coupon-code" placeholder="كود خصم؟"
                                        class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm font-mono uppercase focus:ring-2 focus:ring-indigo-500 outline-none">
                                    <button type="button" id="apply-coupon-btn"
                                        class="w-20 bg-gray-900 text-white font-bold rounded-xl text-sm hover:bg-gray-800 transition">
                                        تطبيق
                                    </button>
                                </div>
                                <p id="coupon-msg" class="text-xs mt-2 hidden"></p>
                            </div>

                            <div class="flex justify-between font-medium text-gray-600 pt-2">
                                <span>التوصيل</span>
                                <span id="summary-shipping" class="font-mono text-gray-900 text-sm">يحدد عند
                                    الطلب</span>
                            </div>

                            <div class="flex justify-between text-xl font-black border-t pt-4 mt-2">
                                <span>الإجمالي</span>
                                <span id="summary-total" class="font-mono text-indigo-600">0 د.ج</span>
                            </div>
                        </div>

                        <button type="button" id="desktop-checkout-btn"
                            class="hidden lg:flex w-full justify-center items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-4 rounded-xl shadow-lg shadow-indigo-200 transition-all hover:scale-[1.02]">
                            <span>إتمام الطلب</span>
                            <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Mobile Sticky Checkout Bar -->
    <div id="mobile-checkout-bar"
        class="fixed bottom-[70px] left-4 right-4 bg-white/90 backdrop-blur-md border border-gray-100 p-4 rounded-2xl shadow-2xl z-40 lg:hidden transform transition-transform duration-300 translate-y-full">
        <div class="flex justify-between items-center gap-4">
            <div class="flex flex-col">
                <span class="text-xs text-gray-500 font-bold">الإجمالي</span>
                <p id="mobile-sticky-total" class="text-xl font-black text-indigo-600 font-mono">0 د.ج</p>
            </div>
            <button id="mobile-checkout-btn"
                class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-indigo-200">
                <span>إتمام الطلب</span>
                <i class="fas fa-arrow-left"></i>
            </button>
        </div>
    </div>

    <!-- Checkout Modal (Redesigned) -->
    <div id="checkout-modal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity opacity-0 pointer-events-none"
            id="checkout-backdrop"></div>

        <!-- Modal Panel -->
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center sm:items-center p-0 sm:p-4 text-center">

                <div id="checkout-panel"
                    class="relative transform overflow-hidden bg-white text-right shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:rounded-3xl w-full rounded-t-3xl translate-y-full sm:translate-y-10 opacity-0">

                    <!-- Header -->
                    <div
                        class="bg-gray-50/50 px-4 py-4 sm:px-6 flex items-center justify-between border-b border-gray-100">
                        <h3 class="text-lg font-black leading-6 text-gray-900 flex items-center gap-2" id="modal-title">
                            <span
                                class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
                                <i class="fas fa-lock"></i>
                            </span>
                            إتمام الطلب الآمن
                        </h3>
                        <button type="button" id="close-checkout-modal-btn"
                            class="rounded-full p-2 text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none transition">
                            <span class="sr-only">إغلاق</span>
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto p-6 scrollbar-hide">
                        <form id="checkout-form" class="space-y-5">

                            <!-- Type Specific Notice -->
                            <div id="checkout-type-notice"
                                class="bg-blue-50 text-blue-800 p-3 rounded-xl text-sm font-bold flex items-center gap-2">
                                <i class="fas fa-info-circle"></i> <span>جاري إتمام طلب تسوق</span>
                            </div>

                            <h3 class="font-bold text-gray-700 border-b pb-2">معلومات الاستلام</h3>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">الاسم</label>
                                    <input type="text" id="q-customer-name"
                                        class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition"
                                        required>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">رقم الهاتف</label>
                                    <input type="tel" id="q-customer-phone"
                                        class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition"
                                        dir="ltr" required>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">الولاية &
                                    البلدية</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="text" id="q-customer-wilaya" placeholder="الولاية"
                                        class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition"
                                        required>
                                    <input type="text" id="q-customer-baladiya" placeholder="البلدية"
                                        class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition"
                                        required>
                                </div>
                            </div>

                            <!-- GPS Field (Enhanced for Food) -->
                            <div id="gps-field-container">
                                <label class="block text-xs font-bold text-gray-500 mb-1 flex justify-between">
                                    <span>العنوان / الموقع</span>
                                    <span class="text-orange-500 text-[10px]" id="gps-required-hint">* يفضل GPS
                                        لطعام</span>
                                </label>
                                <div class="relative">
                                    <i class="fas fa-map-marker-alt absolute right-3 top-3.5 text-gray-400"></i>
                                    <input type="url" id="q-customer-gps" placeholder="رابط موقعك من Maps (اختياري)"
                                        class="w-full p-3 pr-10 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition"
                                        dir="ltr">
                                </div>
                                <textarea id="q-customer-address"
                                    class="mt-2 w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition text-sm"
                                    rows="2" placeholder="وصف دقيق للمنزل/المكان..." required></textarea>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ملاحظات</label>
                                <textarea id="q-customer-notes"
                                    class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition text-sm"
                                    rows="1" placeholder="أي تفاصيل إضافية..."></textarea>
                            </div>

                            <!-- Extra Features (Hidden by default, toggleable) -->
                            <div class="space-y-3 pt-2">
                                <!-- Scheduling -->
                                <div class="border border-gray-100 rounded-xl overflow-hidden">
                                    <button type="button"
                                        onclick="document.getElementById('schedule-options').classList.toggle('hidden')"
                                        class="w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 transition">
                                        <span class="text-sm font-bold text-gray-700"><i
                                                class="fas fa-clock text-indigo-500 ml-2"></i> جدولة التوصيل</span>
                                        <i class="fas fa-chevron-down text-xs text-gray-400"></i>
                                    </button>
                                    <div id="schedule-options" class="hidden p-4 bg-white">
                                        <label class="flex items-center gap-2 mb-2 cursor-pointer">
                                            <input type="checkbox" id="is-scheduled-checkbox"
                                                class="accent-indigo-600 w-4 h-4">
                                            <span class="text-sm">تفعيل الجدولة</span>
                                        </label>
                                        <select id="schedule-frequency"
                                            class="w-full p-2 bg-gray-50 rounded-lg text-sm border border-gray-200">
                                            <option value="daily">يومياً</option>
                                            <option value="weekly">أسبوعياً</option>
                                            <option value="monthly">شهرياً</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                        </form>
                    </div>

                    <div class="p-5 border-t bg-gray-50">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-gray-600 font-bold">المجموع الكلي</span>
                            <span id="modal-summary-total" class="text-2xl font-black text-indigo-600 font-mono">0
                                د.ج</span>
                        </div>
                        <button type="submit" form="checkout-form" id="submit-quick-checkout-btn"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-200 transition transform active:scale-95 flex justify-center items-center gap-2">
                            <span>تأكيد الطلب</span>
                            <i class="fas fa-check-circle"></i>
                        </button>
                    </div>
                </div> <!-- End Panel -->
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <!-- Mobile Enhancements moved to app-core.js -->

    <script type="module">
        import { db, auth } from './app-core.js';
        import {
            collection, addDoc, doc, getDoc, serverTimestamp, query, where, limit, getDocs, updateDoc,
            increment
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let currentUser = null;
        let cart = [];
        let currentDiscount = null;
        let activeTab = 'market'; // 'market' or 'food'
        let activeGlobalLogo = 'https://placehold.co/100/1f2937/ffffff?text=Logo'; // Fallback

        // Fetch Global Config
        async function fetchGlobalConfig() {
            try {
                const globalSettingsSnap = await getDoc(doc(db, "settings", "storeConfig"));
                if (globalSettingsSnap.exists()) {
                    const gData = globalSettingsSnap.data();
                    if (gData.logoUrl) {
                        activeGlobalLogo = gData.logoUrl;
                        renderCartItems(); // Re-render to update logos if cart is already loaded
                    }
                }
            } catch (err) { console.log("Global logo fetch error", err); }
        }
        fetchGlobalConfig();

        const elements = {
            loader: document.getElementById('cart-loader'),
            emptyMsg: document.getElementById('empty-cart-msg'),
            content: document.getElementById('cart-content'),
            itemsList: document.getElementById('cart-items-container'),
            subtotal: document.getElementById('summary-subtotal'),
            total: document.getElementById('summary-total'),

            couponInput: document.getElementById('coupon-code'),
            couponBtn: document.getElementById('apply-coupon-btn'),
            couponMsg: document.getElementById('coupon-msg'),
            discountRow: document.getElementById('discount-row'),

            checkoutModal: document.getElementById('checkout-modal'),
            closeCheckoutModalBtn: document.getElementById('close-checkout-modal-btn'),
            checkoutForm: document.getElementById('checkout-form'),
            submitBtn: document.getElementById('submit-quick-checkout-btn'),
            modalTotal: document.getElementById('modal-summary-total'),
            checkoutTypeNotice: document.getElementById('checkout-type-notice'),

            cartBadgeBottom: document.getElementById('cart-badge-bottom'),
            mobileCheckoutBar: document.getElementById('mobile-checkout-bar'),
            mobileStickyTotal: document.getElementById('mobile-sticky-total'),
            mobileCheckoutBtn: document.getElementById('mobile-checkout-btn'),
            desktopCheckoutBtn: document.getElementById('desktop-checkout-btn'),

            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            bottomProfileBtn: document.getElementById('bottom-profile-btn'),
            bottomLoginBtn: document.getElementById('bottom-login-btn'),
            toastContainer: document.getElementById('toast-container'),

            tabIndicator: document.getElementById('tab-indicator'),
            tabMarket: document.getElementById('tab-market'),
            tabFood: document.getElementById('tab-food'),
        };

        // --- Tab Logic ---
        window.switchCartTab = (tab) => {
            activeTab = tab;

            // UI Update
            if (tab === 'market') {
                elements.tabIndicator.style.transform = 'translateX(0%)'; // Assuming LTR or absolute positioning logic
                // Adjust for RTL if needed:
                elements.tabIndicator.style.left = '1%';
                elements.tabMarket.classList.replace('text-gray-500', 'text-indigo-600');
                elements.tabFood.classList.replace('text-indigo-600', 'text-gray-500');
            } else {
                elements.tabIndicator.style.left = '51%';
                elements.tabFood.classList.replace('text-gray-500', 'text-indigo-600');
                elements.tabMarket.classList.replace('text-indigo-600', 'text-gray-500');
            }

            renderCartItems();
        };

        // --- Helper Functions ---
        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-24 left-1/2 -translate-x-1/2 z-[999] bg-gray-800 text-white px-6 py-3 rounded-full
    shadow-2xl flex items-center gap-3 animate-bounce`;
            toast.innerHTML = `<i
        class="fas ${type === 'success' ? 'fa-check-circle text-green-400' : 'fa-exclamation-circle text-red-400'}"></i>
    ${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };

        const toggleButtonState = (btn, isLoading, originalText = 'تأكيد') => {
            if (!btn) return;
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
            } else {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        // --- Cart Logic ---
        function loadCart() {
            cart = JSON.parse(localStorage.getItem('s22market_cart')) || [];

            // Migration: Add default type if missing
            let dirt = false;
            cart = cart.map(item => {
                if (!item.itemType) {
                    item.itemType = 'market';
                    dirt = true;
                }
                return item;
            });
            if (dirt) saveCart();

            renderCartItems();
            updateCartIcon();
        }

        function saveCart() {
            localStorage.setItem('s22market_cart', JSON.stringify(cart));
            updateCartIcon();
            renderCartItems();
        }

        function updateCartIcon() {
            const total = cart.reduce((sum, i) => sum + i.quantity, 0);
            if (elements.cartBadgeBottom) {
                elements.cartBadgeBottom.textContent = total;
                elements.cartBadgeBottom.classList.toggle('hidden', total === 0);
            }
        }

        function getFilteredItems() {
            // Updated: Return ONLY active tab items for Checkout and logic coherence
            if (activeTab === 'market') {
                return cart.filter(i => i.itemType === 'market' || !i.itemType);
            } else {
                return cart.filter(i => i.itemType === 'food');
            }
        }

        function renderCartItems() {
            const allItems = cart;
            const container = elements.itemsList;

            elements.loader.classList.add('hidden');

            if (allItems.length === 0) {
                elements.emptyMsg.classList.remove('hidden');
                elements.content.classList.add('hidden');
                elements.mobileCheckoutBar.classList.add('hidden');
                return;
            }

            elements.emptyMsg.classList.add('hidden');
            elements.content.classList.remove('hidden');
            elements.mobileCheckoutBar.classList.remove('hidden');

            container.innerHTML = '';
            let subtotal = 0;

            // 1. Separate Items by Tab focus
            const mainItems = allItems.filter(i => activeTab === 'market' ? (i.itemType === 'market' || !i.itemType) : i.itemType === 'food');
            const otherItems = allItems.filter(i => activeTab === 'market' ? i.itemType === 'food' : (i.itemType === 'market' || !i.itemType));

            // 2. Group Main Items
            const groups = {};
            mainItems.forEach(item => {
                const storeId = item.sellerId || 'unknown';
                if (!groups[storeId]) {
                    groups[storeId] = {
                        name: item.storeName || (activeTab === 'market' ? 'متجر عام' : 'مطعم غير معروف'),
                        logo: item.storeLogo || item.logoUrl || item.photoURL || activeGlobalLogo,
                        items: [],
                        totalValue: 0,
                        itemCount: 0
                    };
                }
                groups[storeId].items.push(item);
                groups[storeId].totalValue += (item.price * item.quantity);
                groups[storeId].itemCount += item.quantity;
            });

            // 3. Render Groups (Vitality System)
            if (Object.keys(groups).length > 0) {
                Object.values(groups).forEach(group => {
                    subtotal += group.totalValue;

                    // Vitality / Progress Logic
                    // Example: Level 1 (0-5000), Level 2 (5000-10000), etc.
                    const progressPercent = Math.min(100, (group.totalValue / 5000) * 100);
                    const level = Math.floor(group.totalValue / 5000) + 1;

                    const groupEl = document.createElement('div');
                    groupEl.className = 'bg-white rounded-2xl p-5 shadow-sm border border-gray-100 mb-6 relative overflow-hidden group-card';
                    groupEl.innerHTML = `
                        <!-- Vitality Header -->
                        <div class="flex flex-col gap-2 mb-4 pb-3 border-b border-dashed relative z-10">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="relative">
                                        <img src="${group.logo}" class="w-10 h-10 rounded-full bg-gray-100 object-cover border-2 border-white shadow-sm">
                                        <div class="absolute -bottom-1 -right-1 bg-green-500 text-white text-[9px] w-4 h-4 flex items-center justify-center rounded-full border border-white">
                                            ${group.items.length}
                                        </div>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-800 text-base">${group.name}</h3>
                                        <p class="text-[10px] text-gray-400 font-bold">بائع موثوق</p>
                                    </div>
                                </div>
                                <div class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-lg">
                                    المستوى ${level}
                                </div>
                            </div>

                            <!-- Progress Bar (Vitality) -->
                            <div class="w-full bg-gray-100 rounded-full h-1.5 mt-1 overflow-hidden">
                                <div class="bg-gradient-to-r from-indigo-500 to-purple-500 h-1.5 rounded-full transition-all duration-1000" style="width: ${progressPercent}%"></div>
                            </div>
                            <p class="text-[10px] text-gray-400 text-left w-full pl-1">متبقي ${Math.max(0, (level * 5000) - group.totalValue)} د.ج للمستوى التالي</p>
                        </div>

                        <!-- Items -->
                        <div class="space-y-4 relative z-10">
                            ${group.items.map(item => createItemHTML(item)).join('')}
                        </div>

                        <!-- Decorative Background (Vitality) -->
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-indigo-500/20 to-transparent"></div>
                    `;
                    container.appendChild(groupEl);
                });
            } else {
                if (activeTab === 'market') {
                    container.innerHTML = `<div class="text-center py-10 text-gray-400">لا توجد منتجات تسوق في السلة</div>`;
                } else {
                    container.innerHTML = `<div class="text-center py-10 text-gray-400">لا توجد طلبات طعام في السلة</div>`;
                }
            }


            // 4. "Next to the old one" - Cross Category Alert
            if (otherItems.length > 0) {
                const otherType = activeTab === 'market' ? 'طعام' : 'تسوق';
                const otherIcon = activeTab === 'market' ? 'fa-utensils' : 'fa-shopping-bag';
                const otherColor = activeTab === 'market' ? 'orange' : 'indigo'; // Tailwinds colors

                const alertEl = document.createElement('div');
                alertEl.className = `mt-6 bg-${otherColor}-50 border border-${otherColor}-100 rounded-2xl p-4 flex items-center justify-between cursor-pointer hover:bg-${otherColor}-100 transition-colors`;
                alertEl.onclick = () => switchCartTab(activeTab === 'market' ? 'food' : 'market');
                alertEl.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center text-${otherColor}-600 shadow-sm text-xl">
                            <i class="fas ${otherIcon} animate-pulse"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 text-sm">لديك سلة ${otherType} جانبية!</h4>
                            <p class="text-xs text-gray-500">${otherItems.length} عنصر ينتظرك هناك</p>
                        </div>
                    </div>
                    <div class="bg-white px-4 py-2 rounded-lg text-xs font-bold text-${otherColor}-600 shadow-sm">
                        عرض السلة
                    </div>
                `;
                container.appendChild(alertEl);
            }

            // 5. Food Upsell (Specific Request)
            if (activeTab === 'food' && mainItems.length > 0) {
                const upsellEl = document.createElement('div');
                upsellEl.className = 'mt-8 border-t pt-4';
                upsellEl.innerHTML = `
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <i class="fas fa-magic text-yellow-500"></i> اقتراحات Dr. S22
                    </h3>
                    <div class="flex gap-3 overflow-x-auto pb-4 scrollbar-hide">
                         <!-- Static Examples for Visuals -->
                         ${createUpsellCard('بيبسي', '150', 'https://images.unsplash.com/photo-1629203851122-3726ecdf080c?auto=format&fit=crop&q=80&w=100')}
                         ${createUpsellCard('بطاطس إضافية', '200', 'https://images.unsplash.com/photo-1630384060421-cb20d0e0649d?auto=format&fit=crop&q=80&w=100')}
                         ${createUpsellCard('صوص ثوم', '50', 'https://images.unsplash.com/photo-1472476443507-c7a392dd6182?auto=format&fit=crop&q=80&w=100')}
                    </div>
                 `;
                container.appendChild(upsellEl);
            }

            updateSummary(subtotal);
        }

        function createUpsellCard(name, price, img) {
            return `
                <div class="min-w-[100px] bg-white rounded-xl p-2 border border-gray-100 shadow-sm flex flex-col items-center gap-2 cursor-pointer hover:border-indigo-300 transition-colors">
                    <img src="${img}" class="w-12 h-12 rounded-full object-cover bg-gray-50">
                    <span class="text-[10px] font-bold text-gray-700 text-center truncate w-full">${name}</span>
                    <span class="text-xs font-black text-indigo-600">${price} د.ج</span>
                    <button class="w-full bg-indigo-50 text-indigo-600 text-[10px] font-bold py-1 rounded hover:bg-indigo-600 hover:text-white transition-colors">إضافة</button>
                </div>
            `;
        }

        function createItemHTML(item, wrap = false) {
            const img = (item.imageUrls && item.imageUrls[0]) || item.image || 'https://placehold.co/100';
            const itemName = typeof item.name === 'object' ? (item.name.ar || item.name.en || 'منتج') : item.name;
            const html = `
    <div
        class="flex items-center gap-4 ${wrap ? 'bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-4' : ''}">
        <img src="${img}" class="w-20 h-20 rounded-xl bg-gray-50 object-cover border border-gray-100">
        <div class="flex-grow">
            <h4 class="font-bold text-gray-800 text-sm line-clamp-2">${itemName}</h4>
            <p class="text-indigo-600 font-mono font-bold mt-1">${item.price.toLocaleString()} د.ج</p>
        </div>
        <div class="flex flex-col items-end gap-2">
            <div class="flex items-center bg-gray-50 rounded-lg border border-gray-200 h-8">
                <button onclick="updateQty('${item.id}', ${item.quantity + 1})"
                    class="w-8 h-full flex items-center justify-center text-gray-600 hover:bg-gray-200 rounded-r-lg">+</button>
                <span class="w-8 text-center font-bold text-sm text-gray-800">${item.quantity}</span>
                <button onclick="updateQty('${item.id}', ${item.quantity - 1})"
                    class="w-8 h-full flex items-center justify-center text-gray-600 hover:bg-gray-200 rounded-l-lg">-</button>
            </div>
            <button onclick="removeItem('${item.id}')"
                class="text-gray-400 hover:text-red-500 text-xs transition-colors">
                <i class="fas fa-trash"></i> حذف
            </button>
        </div>
    </div>
    `;
            return html;
        }

        function updateSummary(subtotal) {
            let discount = 0;
            if (currentDiscount) {
                if (currentDiscount.discountType === 'percentage') discount = subtotal * (currentDiscount.discountValue / 100);
                else discount = currentDiscount.discountValue;
            }

            const total = Math.max(0, subtotal - discount);

            elements.subtotal.textContent = `${subtotal.toLocaleString()} د.ج`;
            elements.total.textContent = `${total.toLocaleString()} د.ج`;
            elements.mobileStickyTotal.textContent = `${total.toLocaleString()} د.ج`;
            elements.modalTotal.textContent = `${total.toLocaleString()} د.ج`;

            if (currentDiscount) {
                elements.couponMsg.textContent = `تم تطبيق خصم ${discount.toLocaleString()} د.ج`;
                elements.couponMsg.className = 'text-xs mt-2 text-green-600 font-bold';
                elements.couponMsg.classList.remove('hidden');
            } else {
                elements.couponMsg.classList.add('hidden');
            }

            // Context Awareness for Checkout
            const activeCount = cart.filter(i => activeTab === 'market' ? (i.itemType === 'market' || !i.itemType) : i.itemType === 'food').length;
            if (activeCount === 0) {
                elements.mobileCheckoutBar.classList.add('hidden');
                elements.content.classList.add('hidden');
                elements.emptyMsg.classList.remove('hidden');
            } else {
                elements.mobileCheckoutBar.classList.remove('hidden');
            }
        }

        window.updateQty = (id, newQty) => {
            const idx = cart.findIndex(i => i.id === id);
            if (idx > -1) {
                if (newQty <= 0) cart.splice(idx, 1); else cart[idx].quantity = newQty; saveCart();
            }
        }; window.removeItem = (id) => {
            window.updateQty(id, 0);
        };

        // --- Coupon Logic ---
        if (elements.couponBtn) {
            elements.couponBtn.onclick = async () => {
                const code = elements.couponInput.value.trim().toUpperCase();
                if (!code) return;

                toggleButtonState(elements.couponBtn, true);
                try {
                    const q = query(collection(db, 'coupons'), where('code', '==', code), where('isActive', '==', true), limit(1));
                    const snap = await getDocs(q);

                    if (snap.empty) throw new Error('الكود غير صحيح');
                    const data = snap.docs[0].data();

                    currentDiscount = { id: snap.docs[0].id, ...data };
                    renderCartItems(); // Re-calc
                } catch (e) {
                    elements.couponMsg.textContent = e.message;
                    elements.couponMsg.className = 'text-xs mt-2 text-red-500 font-bold';
                    elements.couponMsg.classList.remove('hidden');
                    currentDiscount = null;
                }
                toggleButtonState(elements.couponBtn, false, 'تطبيق');
            };
        }

        // --- Checkout Logic ---
        async function openCheckout() {
            const user = await window.requireAuth(auth);
            if (!user) return;

            const modal = elements.checkoutModal;
            const backdrop = document.getElementById('checkout-backdrop');
            const panel = document.getElementById('checkout-panel');

            // 1. Show Modal Container
            modal.classList.remove('hidden');

            // 2. Animate In (Next Frame)
            setTimeout(() => {
                backdrop.classList.remove('opacity-0');
                backdrop.classList.add('opacity-100');

                panel.classList.remove('translate-y-full', 'sm:translate-y-10', 'opacity-0');
                panel.classList.add('translate-y-0', 'sm:translate-y-0', 'opacity-100');
            }, 10);

            // Context Update
            if (activeTab === 'market') {
                elements.checkoutTypeNotice.className = 'bg-indigo-50 text-indigo-800 p-3 rounded-xl text-sm font-bold flex items-center gap-2 border border-indigo-100';
                elements.checkoutTypeNotice.innerHTML = '<i class="fas fa-shopping-bag text-lg"></i> <span>جاري إتمام طلب <b>تسوق</b></span>';
                document.getElementById('gps-field-container').classList.add('opacity-50', 'pointer-events-none');
            } else {
                elements.checkoutTypeNotice.className = 'bg-orange-50 text-orange-800 p-3 rounded-xl text-sm font-bold flex items-center gap-2 border border-orange-100';
                elements.checkoutTypeNotice.innerHTML = '<i class="fas fa-utensils text-lg"></i> <span>جاري إتمام طلب <b>طعام</b></span>';
                document.getElementById('gps-field-container').classList.remove('opacity-50', 'pointer-events-none');
            }

            if (window.autoFillCheckout) window.autoFillCheckout();
        }

        function closeCheckout() {
            const modal = elements.checkoutModal;
            const backdrop = document.getElementById('checkout-backdrop');
            const panel = document.getElementById('checkout-panel');

            // 1. Animate Out
            backdrop.classList.remove('opacity-100');
            backdrop.classList.add('opacity-0');

            panel.classList.remove('translate-y-0', 'sm:translate-y-0', 'opacity-100');
            panel.classList.add('translate-y-full', 'sm:translate-y-10', 'opacity-0');

            // 2. Hide Container after animation
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300); // Match transition duration
        }

        elements.desktopCheckoutBtn.onclick = openCheckout;
        elements.mobileCheckoutBtn.onclick = openCheckout;
        elements.closeCheckoutModalBtn.onclick = closeCheckout;

        // Form Submit
        elements.checkoutForm.onsubmit = async (e) => {
            e.preventDefault();
            const btn = elements.submitBtn;
            const originalContent = btn.innerHTML;
            toggleButtonState(btn, true);

            try {
                const checkoutItems = getFilteredItems();
                if (checkoutItems.length === 0) throw new Error('لا توجد عناصر لإتمام الطلب');

                const subtotal = checkoutItems.reduce((sum, i) => sum + (Number(i.price) * Number(i.quantity)), 0);
                const discount = currentDiscount ? (currentDiscount.discountType === 'percentage' ? subtotal *
                    (currentDiscount.discountValue / 100) : currentDiscount.discountValue) : 0;
                const total = Math.max(0, subtotal - discount);

                if (!currentUser) throw new Error('يرجى تسجيل الدخول');

                const orderData = {
                    customerId: currentUser.uid,
                    // rest of fields... this block is just to fix the button handler context

                    customerName: document.getElementById('q-customer-name').value,
                    customerPhone: document.getElementById('q-customer-phone').value,
                    wilaya: document.getElementById('q-customer-wilaya').value,
                    baladiya: document.getElementById('q-customer-baladiya').value,
                    address: document.getElementById('q-customer-address').value,
                    gpsLocation: document.getElementById('q-customer-gps').value,
                    notes: document.getElementById('q-customer-notes').value,

                    items: checkoutItems,
                    totalPrice: total,
                    subtotal: subtotal,
                    discount: discount,
                    status: 'pending',
                    type: activeTab, // market or food
                    createdAt: serverTimestamp(),
                    sellerId: checkoutItems[0].sellerId || 'unknown' // Naive: assume single seller or primary
                    // Real app should split orders by seller, but for S22 "Market" mode, usually aggregation.
                };

                // Add Schedule if checked
                const isScheduled = document.getElementById('is-scheduled-checkbox').checked;
                if (isScheduled) {
                    orderData.scheduled = true;
                    orderData.scheduleFrequency = document.getElementById('schedule-frequency').value;
                    // Add to separate collection? or just flag? 
                    // Let's just flag it.
                }

                await addDoc(collection(db, 'orders'), orderData);

                // Clear cart (only ordered items)
                const remaining = cart.filter(i => activeTab === 'market' ? i.itemType === 'food' : (i.itemType === 'market' || !i.itemType));
                cart = remaining;
                saveCart();

                showToast(`تم إرسال الطلب بنجاح!`, 'success');
                elements.checkoutModal.classList.remove('active');
                setTimeout(() => window.location.href = 'order_history.html', 1500);

            } catch (error) {
                console.error("Checkout Error:", error);
                // Fallback alert for critical errors if toast doesn't appear
                alert("حدث خطأ أثناء إتمام الطلب: " + error.message);
                toggleButtonState(btn, false, originalContent);
            }
        };

        // --- Init ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                elements.loginBtn.classList.add('hidden');
                elements.loginBtn.classList.remove('sm:flex');
                elements.loginBtn.style.display = 'none';
                document.getElementById('user-menu').classList.remove('hidden');
                document.getElementById('user-menu-name').textContent = user.displayName?.split(' ')[0] || 'مستخدم';
                document.getElementById('user-menu-displayname').textContent = user.displayName;

                // Auto-fill checkout if form is open (unlikely on load, but good practice)
                if (window.autoFillCheckout) window.autoFillCheckout();
            } else {
                elements.loginBtn.classList.remove('hidden');
                document.getElementById('user-menu').classList.add('hidden');
            }
            loadCart();
        });

        // Dropdown Toggle
        document.getElementById('user-menu-button').onclick = (e) => {
            e.stopPropagation();
            document.getElementById('user-menu-dropdown').classList.toggle('show');
        };
        document.addEventListener('click', () => {
            document.getElementById('user-menu-dropdown').classList.remove('show');
        });
        document.getElementById('logout-btn').onclick = async () => {
            await auth.signOut();
            window.location.reload();
        };

    </script>
</body>

</html>