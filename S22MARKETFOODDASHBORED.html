<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - لوحة تحكم المطاعم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f1f5f9; }
        .small-loader {
            border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: #fff;
            border-radius: 50%; width: 20px; height: 20px;
            animation: spin 0.8s linear infinite; display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800">لوحة تحكم المطاعم</h1>
            <p class="text-gray-500 mt-2">إدارة المطاعم الشريكة وكوبونات الخصم</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 border-b pb-3"><i class="fas fa-plus-circle text-blue-500"></i> إضافة مطعم جديد</h2>
                <form id="add-restaurant-form" class="space-y-4">
                    <div>
                        <label for="restaurant-name" class="font-semibold text-gray-700">اسم المطعم</label>
                        <input type="text" id="restaurant-name" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="restaurant-logo" class="font-semibold text-gray-700">رابط شعار المطعم (Logo URL)</label>
                        <input type="url" id="restaurant-logo" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg" dir="ltr">
                    </div>
                    <button type="submit" id="add-restaurant-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors">إضافة المطعم</button>
                </form>
            </div>
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-store text-gray-600"></i> قائمة المطاعم</h2>
                <div id="restaurants-list" class="overflow-x-auto">
                    </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 border-b pb-3"><i class="fas fa-ticket-alt text-green-500"></i> إضافة كوبون جديد</h2>
                <form id="add-coupon-form" class="space-y-4">
                    <div>
                        <label for="coupon-restaurant" class="font-semibold text-gray-700">اختر المطعم</label>
                        <select id="coupon-restaurant" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg bg-white"></select>
                    </div>
                    <div>
                        <label for="coupon-title" class="font-semibold text-gray-700">عنوان العرض</label>
                        <input type="text" id="coupon-title" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg" placeholder="مثال: خصم 20% على البيتزا">
                    </div>
                    <div>
                        <label for="coupon-desc" class="font-semibold text-gray-700">وصف قصير للعرض</label>
                        <textarea id="coupon-desc" rows="2" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg"></textarea>
                    </div>
                     <div>
                        <label for="coupon-code" class="font-semibold text-gray-700">كود الخصم</label>
                        <input type="text" id="coupon-code" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg uppercase" placeholder="FOOD25">
                    </div>
                    <div>
                        <label for="coupon-expiry" class="font-semibold text-gray-700">تاريخ انتهاء الصلاحية</label>
                        <input type="date" id="coupon-expiry" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="coupon-active" class="form-checkbox h-5 w-5 text-green-600" checked>
                            <span class="font-semibold text-gray-700">الكوبون فعال</span>
                        </label>
                    </div>
                    <button type="submit" id="add-coupon-btn" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors">إضافة الكوبون</button>
                </form>
            </div>
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-tags text-gray-600"></i> قائمة الكوبونات</h2>
                <div id="coupons-list" class="overflow-x-auto">
                    </div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, doc, deleteDoc, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAxEq-nkLDc3_HM38xb3mhb8ekSXmuFQ7I",
        authDomain: "s22market-4bdb9.firebaseapp.com",
        databaseURL: "https://s22market-4bdb9-default-rtdb.firebaseio.com",
        projectId: "s22market-4bdb9",
        storageBucket: "s22market-4bdb9.appspot.com",
        messagingSenderId: "1029564929614",
        appId: "1:1029564929614:web:2866722c34cf1fb2b8951f",
        measurementId: "G-VH16M3Q33V"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let restaurantsCache = [];

    // --- Restaurant Logic ---
    const addRestaurantForm = document.getElementById('add-restaurant-form');
    const restaurantsListDiv = document.getElementById('restaurants-list');
    
    addRestaurantForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('add-restaurant-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="small-loader"></span> جاري الإضافة...';

        const name = document.getElementById('restaurant-name').value;
        const logoUrl = document.getElementById('restaurant-logo').value;

        try {
            await addDoc(collection(db, "food_restaurants"), { name, logoUrl });
            alert('تمت إضافة المطعم بنجاح!');
            addRestaurantForm.reset();
            loadRestaurants();
        } catch (error) {
            console.error(error);
            alert('حدث خطأ أثناء إضافة المطعم.');
        } finally {
            btn.disabled = false;
            btn.textContent = 'إضافة المطعم';
        }
    });
    
    async function loadRestaurants() {
        const q = query(collection(db, "food_restaurants"), orderBy("name"));
        const snapshot = await getDocs(q);
        restaurantsCache = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
        
        // Populate list
        if (restaurantsCache.length === 0) {
            restaurantsListDiv.innerHTML = '<p class="text-center text-gray-500">لا توجد مطاعم.</p>';
        } else {
            let tableHTML = '<table class="w-full text-sm text-left text-gray-500">...</table>';
            restaurantsListDiv.innerHTML = `
                <table class="w-full text-sm text-center text-gray-600">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr>
                        <th class="px-4 py-3">الشعار</th><th class="px-4 py-3">الاسم</th><th class="px-4 py-3">إجراء</th>
                    </tr></thead>
                    <tbody>${restaurantsCache.map(r => `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-4 py-2"><img src="${r.logoUrl}" class="w-10 h-10 rounded-full mx-auto"></td>
                            <td class="px-4 py-2 font-bold">${r.name}</td>
                            <td class="px-4 py-2"><button class="delete-restaurant-btn text-red-500" data-id="${r.id}"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            `;
        }
        
        // Populate dropdown
        const select = document.getElementById('coupon-restaurant');
        select.innerHTML = restaurantsCache.map(r => `<option value="${r.id}" data-logo="${r.logoUrl}">${r.name}</option>`).join('');

        document.querySelectorAll('.delete-restaurant-btn').forEach(btn => {
            btn.onclick = async (e) => {
                const id = e.currentTarget.dataset.id;
                if (confirm('هل أنت متأكد من حذف هذا المطعم؟ سيتم حذف كل كوبوناته!')) {
                    await deleteDoc(doc(db, "food_restaurants", id));
                    loadRestaurants();
                }
            }
        });
    }

    // --- Coupon Logic ---
    const addCouponForm = document.getElementById('add-coupon-form');
    const couponsListDiv = document.getElementById('coupons-list');

    addCouponForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('add-coupon-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="small-loader"></span> جاري الإضافة...';

        try {
            const restaurantSelect = document.getElementById('coupon-restaurant');
            const selectedOption = restaurantSelect.options[restaurantSelect.selectedIndex];
            
            await addDoc(collection(db, "food_coupons"), {
                restaurantId: selectedOption.value,
                restaurantName: selectedOption.text,
                restaurantLogo: selectedOption.dataset.logo,
                title: document.getElementById('coupon-title').value,
                description: document.getElementById('coupon-desc').value,
                code: document.getElementById('coupon-code').value.toUpperCase(),
                expiryDate: Timestamp.fromDate(new Date(document.getElementById('coupon-expiry').value)),
                isActive: document.getElementById('coupon-active').checked
            });
            alert('تمت إضافة الكوبون بنجاح!');
            addCouponForm.reset();
            loadCoupons();
        } catch (error) {
            console.error(error);
            alert('حدث خطأ أثناء إضافة الكوبون.');
        } finally {
            btn.disabled = false;
            btn.textContent = 'إضافة الكوبون';
        }
    });
    
    async function loadCoupons() {
        const q = query(collection(db, "food_coupons"), orderBy("expiryDate", "desc"));
        const snapshot = await getDocs(q);
        const coupons = snapshot.docs.map(d => ({id: d.id, ...d.data()}));

        if (coupons.length === 0) {
            couponsListDiv.innerHTML = '<p class="text-center text-gray-500">لا توجد كوبونات.</p>';
        } else {
            couponsListDiv.innerHTML = `
                <table class="w-full text-sm text-center text-gray-600">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr>
                        <th class="px-4 py-3">المطعم</th><th class="px-4 py-3">العنوان</th><th class="px-4 py-3">الكود</th>
                        <th class="px-4 py-3">تاريخ الانتهاء</th><th class="px-4 py-3">الحالة</th><th class="px-4 py-3">إجراء</th>
                    </tr></thead>
                    <tbody>${coupons.map(c => `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-4 py-2 font-semibold">${c.restaurantName}</td>
                            <td class="px-4 py-2">${c.title}</td>
                            <td class="px-4 py-2 font-mono text-blue-600">${c.code}</td>
                            <td class="px-4 py-2">${c.expiryDate.toDate().toLocaleDateString('fr-CA')}</td>
                            <td class="px-4 py-2">${c.isActive ? '<span class="text-green-500 font-bold">فعال</span>' : '<span class="text-gray-500">معطل</span>'}</td>
                            <td class="px-4 py-2"><button class="delete-coupon-btn text-red-500" data-id="${c.id}"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            `;
        }
        
        document.querySelectorAll('.delete-coupon-btn').forEach(btn => {
            btn.onclick = async (e) => {
                const id = e.currentTarget.dataset.id;
                if (confirm('هل أنت متأكد من حذف هذا الكوبون؟')) {
                    await deleteDoc(doc(db, "food_coupons", id));
                    loadCoupons();
                }
            }
        });
    }

    // Initial Load
    await loadRestaurants();
    await loadCoupons();

</script>
</body>
</html>