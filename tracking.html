<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨ - S22 Market</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="app-style.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background: #f0f2f5;
        }

        /* Map Background Simulation */
        .map-bg {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/e/ec/World_map_blank_without_borders.svg');
            /* Simplified or custom map pattern */
            background-color: #e5e7eb;
            background-size: cover;
            position: relative;
            overflow: hidden;
        }

        .road {
            position: absolute;
            height: 12px;
            background: #cbd5e1;
            border-radius: 6px;
        }

        /* Bike Animation */
        .bike-container {
            position: absolute;
            transition: all 1s linear;
            z-index: 10;
        }

        .bike-icon {
            font-size: 32px;
            color: #ea580c;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.2));
            animation: bounceBike 0.5s infinite alternate;
        }

        @keyframes bounceBike {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(-3px);
            }
        }

        @keyframes movePath {
            0% {
                left: 10%;
                top: 20%;
                transform: rotate(0deg);
            }

            25% {
                left: 40%;
                top: 20%;
                transform: rotate(0deg);
            }

            26% {
                left: 40%;
                top: 20%;
                transform: rotate(90deg);
            }

            50% {
                left: 40%;
                top: 60%;
                transform: rotate(90deg);
            }

            51% {
                left: 40%;
                top: 60%;
                transform: rotate(0deg);
            }

            100% {
                left: 80%;
                top: 60%;
                transform: rotate(0deg);
            }
        }

        .animating-bike {
            animation: movePath 10s linear infinite;
        }
    </style>
</head>

<body class="bg-gray-100 flex flex-col h-screen">

    <!-- Header -->
    <div class="bg-white p-4 shadow-sm z-20 flex justify-between items-center">
        <a href="s22marketfood.html" class="text-gray-600"><i class="fas fa-arrow-right"></i> Ø¹ÙˆØ¯Ø©</a>
        <h1 class="font-bold text-lg">ØªØªØ¨Ø¹ Ø·Ù„Ø¨ÙŠ</h1>
        <div class="w-8"></div>
    </div>

    <!-- Live Map Area -->
    <div class="flex-1 map-bg relative w-full overflow-hidden">
        <!-- Roads (Visual decoration) -->
        <div class="road w-[40%] top-[23%] left-[10%]"></div>
        <div class="road w-[12px] h-[45%] top-[23%] left-[42%]"></div>
        <div class="road w-[50%] top-[63%] left-[40%]"></div>

        <!-- Bike -->
        <div class="bike-container animating-bike" id="delivery-bike">
            <div class="bike-icon"><i class="fas fa-motorcycle"></i></div>
            <div
                class="bg-black/80 text-white text-[10px] px-2 py-1 rounded absolute -top-8 -right-4 whitespace-nowrap">
                Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ù…Ø­Ù…Ø¯ ÙˆØ§ØµÙ„ ğŸš€</div>
        </div>

        <!-- Destination (You) -->
        <div class="absolute top-[60%] left-[82%] transform -translate-y-1/2">
            <i class="fas fa-map-marker-alt text-4xl text-red-600 animate-bounce"></i>
        </div>

        <!-- Restaurant -->
        <div class="absolute top-[18%] left-[8%]">
            <div
                class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-lg border-2 border-orange-500">
                <i class="fas fa-store text-orange-500"></i>
            </div>
        </div>
    </div>

    <!-- Status Sheet -->
    <div class="bg-white rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] p-6 z-20">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>

        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-xl font-black text-gray-800">Ø·Ù„Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚! ğŸ›µ</h2>
                <p class="text-sm text-gray-500">Ø³ÙŠØµÙ„ Ø®Ù„Ø§Ù„ 15-20 Ø¯Ù‚ÙŠÙ‚Ø©</p>
            </div>
            <div class="text-right">
                <p id="REQ-ID" class="font-bold text-lg text-indigo-600">#REQ-loading</p>
            </div>
        </div>

        <!-- Steps -->
        <div class="flex justify-between items-center relative mb-4">
            <div class="absolute top-1/2 left-0 right-0 h-1 bg-gray-100 -z-10"></div>
            <div class="absolute top-1/2 left-0 right-1/4 h-1 bg-green-500 -z-10"></div> <!-- Progress Bar -->

            <div class="flex flex-col items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center text-xs"><i
                        class="fas fa-check"></i></div>
                <span class="text-[10px] font-bold text-gray-600">ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯</span>
            </div>
            <div class="flex flex-col items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center text-xs"><i
                        class="fas fa-fire"></i></div>
                <span class="text-[10px] font-bold text-gray-600">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±</span>
            </div>
            <div class="flex flex-col items-center gap-2">
                <div
                    class="w-10 h-10 rounded-full bg-orange-500 text-white flex items-center justify-center shadow-lg transform scale-110 border-4 border-white">
                    <i class="fas fa-motorcycle"></i>
                </div>
                <span class="text-[10px] font-bold text-orange-600">ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚</span>
            </div>
            <div class="flex flex-col items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-400 flex items-center justify-center text-xs"><i
                        class="fas fa-home"></i></div>
                <span class="text-[10px] font-bold text-gray-400">ÙˆØµÙ„</span>
            </div>
        </div>

        <div class="bg-indigo-50 p-4 rounded-xl flex items-center gap-4 mt-6">
            <img src="https://randomuser.me/api/portraits/men/32.jpg"
                class="w-12 h-12 rounded-full border-2 border-white">
            <div class="flex-1">
                <h4 class="font-bold text-gray-800">Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ</h4>
                <div class="flex items-center gap-1 text-xs text-yellow-600 font-bold">
                    <i class="fas fa-star"></i> 4.9 (Ø¹Ø§Ù…Ù„ ØªÙˆØµÙŠÙ„)
                </div>
            </div>
            <button
                class="bg-green-500 w-10 h-10 rounded-full text-white flex items-center justify-center hover:bg-green-600 shadow-md">
                <i class="fas fa-phone"></i>
            </button>
        </div>
    </div>

    <script type="module">
        import { db, auth } from './app-core.js';
        import { doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const orderId = new URLSearchParams(window.location.search).get('orderId');

        // Status Map: Firestore Status -> Step Index
        const statusMap = {
            'pending': 0,
            'accepted': 1,
            'preparing': 1,
            'ready': 2,
            'shipping': 2,
            'completed': 3,
            'delivered': 3,
            'cancelled': -1
        };

        const stepsInfo = [
            { title: "ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯", desc: "Ø§Ø³ØªÙ„Ù… Ø§Ù„Ù…Ø·Ø¹Ù… Ø·Ù„Ø¨Ùƒ" },
            { title: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±", desc: "Ø§Ù„Ø´ÙŠÙ ÙŠØ¬Ù‡Ø² ÙˆØ¬Ø¨ØªÙƒ Ø§Ù„Ù„Ø°ÙŠØ°Ø© ğŸ‘¨â€ğŸ³" },
            { title: "ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚", desc: "Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø§Ø³ØªÙ„Ù… Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¬Ø§ÙŠ Ù„Ùƒ ğŸš€" },
            { title: "ÙˆØµÙ„", desc: "Ø¨Ø§Ù„Ø¹Ø§ÙÙŠØ© Ø¹Ù„ÙŠÙƒ! ğŸ˜‹" }
        ];

        async function initTracking() {
            // Check Auth First
            const user = await window.requireAuth(auth);
            if (!user) return; // requireAuth handles the redirect/toast

            if (!orderId) {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ø·Ù„Ø¨ Ù„Ù„ØªØªØ¨Ø¹!');
                window.location.href = 'order_history.html';
                return;
            }

            document.querySelector('#REQ-ID').textContent = `#${orderId.slice(0, 8)}`;

            // Listen to order updates
            onSnapshot(doc(db, "orders", orderId), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    updateUI(data);
                } else {
                    console.log("No such order!");
                    // Optional: Handle case where user has no permission to read this specific order
                    // Since rules allow read if (userId == auth.uid), if docSnap breaks or permission denied comes from onSnapshot error handler
                }
            }, (error) => {
                console.error("Tracking Error:", error);
                if (error.code === 'permission-denied') {
                    document.querySelector('.bg-white.rounded-t-3xl').innerHTML = `
                        <div class="text-center p-8">
                            <i class="fas fa-lock text-4xl text-red-500 mb-4"></i>
                            <h2 class="text-xl font-bold mb-2">ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ</h2>
                            <p class="text-gray-600">Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØªØ¨Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø£Ù†Ù‡ Ù„Ø§ ÙŠØ®Øµ Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ.</p>
                            <button onclick="window.history.back()" class="mt-4 bg-gray-800 text-white px-6 py-2 rounded-full">Ø¹ÙˆØ¯Ø©</button>
                        </div>
                     `;
                }
            });
        }

        function updateUI(order) {
            let stepIndex = statusMap[order.status] !== undefined ? statusMap[order.status] : 0;

            // Handle Cancelled
            if (order.status === 'cancelled' || order.status === 'rejected') {
                document.querySelector('h2').textContent = "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ âŒ";
                document.querySelector('h2 + p').textContent = "Ù†Ø£Ø³ÙØŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨.";
                document.querySelectorAll('.flex.flex-col.items-center div').forEach(div => div.classList.add('grayscale'));
                return;
            }

            const steps = document.querySelectorAll('.flex.flex-col.items-center');

            steps.forEach((step, index) => {
                const iconContainer = step.querySelector('div');
                const text = step.querySelector('span');

                if (index <= stepIndex) {
                    // Active or Past
                    if (index === stepIndex && stepIndex < 3) {
                        iconContainer.classList.add('animate-pulse', 'ring', 'ring-green-300');
                        iconContainer.classList.remove('bg-gray-200', 'text-gray-400');

                        if (index === 2) { // Bike
                            iconContainer.classList.add('bg-orange-500', 'text-white');
                        } else {
                            iconContainer.classList.add('bg-green-500', 'text-white');
                        }

                        text.classList.remove('text-gray-400');
                        text.classList.add('text-gray-800', 'font-black');
                    } else {
                        // Completed Past Steps
                        iconContainer.classList.remove('animate-pulse', 'ring', 'ring-green-300', 'bg-gray-200', 'text-gray-400');
                        iconContainer.classList.add('bg-green-500', 'text-white');
                        text.classList.remove('text-gray-400');
                        text.classList.add('text-gray-600');
                    }
                } else {
                    // Future Steps
                    iconContainer.classList.remove('bg-green-500', 'text-white', 'bg-orange-500');
                    iconContainer.classList.add('bg-gray-200', 'text-gray-400');
                    text.classList.remove('text-gray-800', 'font-black', 'text-gray-600');
                    text.classList.add('text-gray-400');
                }
            });

            // Update Progress Bar
            const progressLine = document.querySelector('.absolute.top-1\\/2.left-0.right-1\\/4');
            // Tailwind class is tricky to animate purely with width inlinestyle on a div that might rely on right-1/4. 
            // The HTML structure used right-1/4 which complicates dynamic width. 
            // Let's assume the green bar is the one with bg-green-500

            // Re-selecting specifically
            const progressBar = document.querySelector('.bg-green-500.absolute.h-1'); // This is the one
            if (progressBar) {
                let width = '10%';
                if (stepIndex === 1) width = '40%';
                if (stepIndex === 2) width = '75%';
                if (stepIndex === 3) width = '100%';
                progressBar.style.width = width;
            }

            // Update Text
            const titleEl = document.querySelector('h2');
            const descEl = document.querySelector('h2 + p');

            if (stepsInfo[stepIndex]) {
                titleEl.textContent = stepsInfo[stepIndex].title + (stepIndex === 2 ? ' ğŸ›µ' : '');
                descEl.textContent = stepsInfo[stepIndex].desc;
            }

            // Bike Animation logic
            const bike = document.getElementById('delivery-bike');
            if (stepIndex === 2) { // In delivery
                bike.classList.add('animating-bike');
            } else {
                bike.classList.remove('animating-bike');
                if (stepIndex === 3) {
                    bike.style.left = '82%';
                    bike.style.top = '60%';
                }
            }
        }

        window.addEventListener('DOMContentLoaded', initTracking);
    </script>
</body>

</html>