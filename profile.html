<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S22 Market - Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
            padding-bottom: 90px;
        }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© */
        .profile-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            padding-bottom: 60px;
            position: relative;
            overflow: hidden;
        }

        .header-pattern {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.1;
            background-image: radial-gradient(circle, #ffffff 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* ÙƒØ§Ø±Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
        .user-card {
            margin-top: -50px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 20px;
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .user-avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin: -55px auto 10px;
            background: #e0e7ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: #4f46e5;
        }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© */
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
            border: 1px solid #f1f5f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: transform 0.2s;
        }

        .stat-card:active {
            transform: scale(0.97);
        }

        /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
        .menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: white;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
            transition: background 0.2s;
            cursor: pointer;
        }

        .menu-item:active {
            background: #f8fafc;
        }

        .menu-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-left: 15px;
        }

        /* Ø¨Ø§Ù†Ø± Ø§Ù„Ù…ØªØ¬Ø± */
        .store-banner {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 16px;
            padding: 20px;
            color: white;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2);
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: 20px;
            padding: 24px;
            transform: scale(0.95);
            transition: transform 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        /* Responsive Modal (Bottom Sheet on Mobile) */
        @media (max-width: 768px) {
            .modal {
                align-items: flex-end;
                /* Align to bottom */
            }

            .modal-content {
                width: 100%;
                max-width: 100%;
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
                border-top-left-radius: 25px;
                border-top-right-radius: 25px;
                padding: 30px 24px 40px;
                /* Extra padding at bottom */
                transform: translateY(100%);
                transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            }

            .modal.active .modal-content {
                transform: translateY(0);
            }
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            height: 70px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            color: #94a3b8;
            gap: 4px;
        }

        .nav-item.active {
            color: #4f46e5;
            font-weight: bold;
        }

        .nav-item i {
            font-size: 20px;
        }
    </style>
</head>

<body>

    <div class="profile-header">
        <div class="header-pattern"></div>
        <div class="relative z-10 px-6 pt-8 pb-4 flex justify-between items-center text-white">
            <h1 class="text-xl font-bold">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h1>
            <button onclick="auth.signOut()"
                class="bg-white/20 backdrop-blur px-3 py-1.5 rounded-lg text-sm hover:bg-white/30 transition">
                <i class="fas fa-sign-out-alt ml-1"></i> Ø®Ø±ÙˆØ¬
            </button>
        </div>
    </div>

    <div class="px-4 pb-4">
        <div class="user-card">
            <div id="avatar-placeholder" class="user-avatar">
                <i class="fas fa-user"></i>
            </div>
            <h2 id="user-name" class="text-xl font-bold text-gray-800 mt-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
            <p id="user-email" class="text-gray-500 text-sm mb-3">...</p>
            <span id="user-role-badge"
                class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold">Ø¹Ø¶Ùˆ</span>
        </div>

        <div class="grid grid-cols-3 gap-3 mt-4">
            <div class="stat-card">
                <div class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center"><i
                        class="fas fa-gem"></i></div>
                <span class="font-bold text-gray-800" id="points-val">0</span>
                <span class="text-xs text-gray-500">Ø¬ÙˆØ§Ù‡Ø±</span>
            </div>
            <div class="stat-card">
                <div class="w-8 h-8 rounded-full bg-yellow-50 text-yellow-600 flex items-center justify-center"><i
                        class="fas fa-coins"></i></div>
                <span class="font-bold text-gray-800" id="coins-val">0</span>
                <span class="text-xs text-gray-500">Ø¹Ù…Ù„Ø§Øª</span>
            </div>
            <div class="stat-card" onclick="location.href='order_history.html'">
                <div class="w-8 h-8 rounded-full bg-green-50 text-green-600 flex items-center justify-center"><i
                        class="fas fa-shopping-bag"></i></div>
                <span class="font-bold text-gray-800" id="orders-val">0</span>
                <span class="text-xs text-gray-500">Ø·Ù„Ø¨Ø§Øª</span>
            </div>
        </div>

        <div id="store-section" class="mt-6">
            <div id="start-selling-banner" class="store-banner hidden cursor-pointer" onclick="openStoreModal()">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-lg mb-1">Ø§Ø¨Ø¯Ø£ ØªØ¬Ø§Ø±ØªÙƒ Ù…Ø¹Ù†Ø§! ğŸš€</h3>
                        <p class="text-xs text-green-100 opacity-90">Ø§ÙØªØ­ Ù…ØªØ¬Ø±Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø¬Ø§Ù†Ø§Ù‹ ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ø¨ÙŠØ¹.</p>
                    </div>
                    <div class="bg-white/20 p-2 rounded-lg"><i class="fas fa-store text-2xl"></i></div>
                </div>
            </div>

            <div id="pending-banner"
                class="hidden bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-4 flex items-start gap-3">
                <i class="fas fa-clock text-yellow-500 text-xl mt-1"></i>
                <div>
                    <h3 class="font-bold text-yellow-800">Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h3>
                    <p class="text-xs text-yellow-700 mt-1">ÙØ±ÙŠÙ‚Ù†Ø§ ÙŠØ±Ø§Ø¬Ø¹ Ø·Ù„Ø¨Ùƒ Ù„ÙØªØ­ Ø§Ù„Ù…ØªØ¬Ø±. Ø³ÙŠØµÙ„Ùƒ Ø¥Ø´Ø¹Ø§Ø± Ù‚Ø±ÙŠØ¨Ø§Ù‹.</p>
                </div>
            </div>

            <div id="rejected-banner" class="hidden bg-red-50 border border-red-200 rounded-xl p-4 mb-4">
                <div class="flex items-start gap-3">
                    <i class="fas fa-times-circle text-red-500 text-xl mt-1"></i>
                    <div>
                        <h3 class="font-bold text-red-800">ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨</h3>
                        <p class="text-xs text-red-700 mt-1" id="reject-reason">...</p>
                        <button onclick="openStoreModal()" class="mt-2 text-xs font-bold text-red-600 underline">ØªØ¹Ø¯ÙŠÙ„
                            ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                </div>
            </div>

            <a href="seller-dashboard.html" id="dashboard-btn"
                class="hidden w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 mb-6 hover:bg-indigo-700 transition">
                <i class="fas fa-chart-pie"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ØªØ§Ø¬Ø±
            </a>
        </div>

        <div class="space-y-1">
            <div class="menu-item" onclick="openEditProfileModal()">
                <div class="flex items-center">
                    <div class="menu-icon bg-gray-50 text-gray-600"><i class="fas fa-user-edit"></i></div>
                    <span class="font-bold text-gray-700">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</span>
                </div>
                <i class="fas fa-chevron-left text-gray-400 text-xs"></i>
            </div>

            <a href="loyalty_card.html" class="menu-item">
                <div class="flex items-center">
                    <div class="menu-icon bg-orange-50 text-orange-500"><i class="fas fa-id-card"></i></div>
                    <span class="font-bold text-gray-700">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆÙØ§Ø¡</span>
                </div>
                <i class="fas fa-chevron-left text-gray-400 text-xs"></i>
            </a>

            <a href="order_history.html" class="menu-item">
                <div class="flex items-center">
                    <div class="menu-icon bg-blue-50 text-blue-500"><i class="fas fa-archive"></i></div>
                    <span class="font-bold text-gray-700">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
                </div>
                <i class="fas fa-chevron-left text-gray-400 text-xs"></i>
            </a>

            <a href="wishlist.html" class="menu-item">
                <div class="flex items-center">
                    <div class="menu-icon bg-pink-50 text-pink-500"><i class="fas fa-heart"></i></div>
                    <span class="font-bold text-gray-700">Ø§Ù„Ù…ÙØ¶Ù„Ø©</span>
                </div>
                <i class="fas fa-chevron-left text-gray-400 text-xs"></i>
            </a>
            <div class="menu-item" onclick="openCredentialModal()">
                <div class="flex items-center">
                    <div class="menu-icon bg-purple-50 text-purple-500"><i class="fas fa-key"></i></div>
                    <span class="font-bold text-gray-700">ØªÙˆÙ„ÙŠØ¯ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
                </div>
                <i class="fas fa-chevron-left text-gray-400 text-xs"></i>
            </div>
        </div>

        <div class="mt-6 bg-indigo-50 border-2 border-dashed border-indigo-200 rounded-xl p-4 text-center">
            <p class="text-xs text-indigo-500 font-bold mb-1">ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</p>
            <div class="flex justify-center items-center gap-3">
                <span id="ref-code" class="text-2xl font-black text-indigo-700 tracking-widest">...</span>
                <button onclick="copyRef()" class="text-indigo-400 hover:text-indigo-600"><i
                        class="fas fa-copy"></i></button>
            </div>
            <p class="text-[10px] text-indigo-400 mt-2">Ø´Ø§Ø±Ùƒ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ø±Ø¨Ø­ 50 Ø¬ÙˆÙ‡Ø±Ø© Ù„ÙƒÙ„ ØµØ¯ÙŠÙ‚! ğŸ</p>
        </div>

    </div>

    <div id="store-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="font-bold text-lg text-gray-800">Ø·Ù„Ø¨ ÙØªØ­ Ù…ØªØ¬Ø±</h3>
                <button onclick="closeModal('store-modal')" class="text-gray-400 hover:text-red-500 text-xl"><i
                        class="fas fa-times"></i></button>
            </div>
            <form id="store-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø± / Ø§Ù„Ù†Ø´Ø§Ø·</label>
                    <input type="text" id="req-name"
                        class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-indigo-500"
                        placeholder="Ù…Ø«Ø§Ù„: Ù…Ø·Ø¹Ù… Ø§Ù„Ø³Ø¹Ø§Ø¯Ø©" required>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·</label>
                    <select id="req-type"
                        class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-indigo-500">
                        <option value="vendor">Ù…ØªØ¬Ø± (Ø¨ÙŠØ¹ Ù…Ù†ØªØ¬Ø§Øª)</option>
                        <option value="restaurant">Ù…Ø·Ø¹Ù… (Ù…Ø£ÙƒÙˆÙ„Ø§Øª)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">ÙˆØµÙ Ù…Ø®ØªØµØ±</label>
                    <textarea id="req-desc"
                        class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-indigo-500"
                        rows="3" placeholder="Ù…Ø§Ø°Ø§ ØªÙ‚Ø¯Ù… Ù„Ø²Ø¨Ø§Ø¦Ù†ÙƒØŸ"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„ØªÙˆØ§ØµÙ„</label>
                    <input type="tel" id="req-phone"
                        class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-indigo-500"
                        dir="ltr" required>
                </div>
                <button type="submit" id="submit-req-btn"
                    class="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition">
                    Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
                </button>
            </form>
        </div>
    </div>

    <div id="edit-profile-modal" class="modal">
        <div class="modal-content">
            <h3 class="font-bold text-lg text-gray-800 mb-4">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h3>
            <form id="profile-edit-form" class="space-y-4">
                <input type="text" id="edit-name" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3"
                    placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
                <input type="tel" id="edit-phone" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3"
                    placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" dir="ltr">
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeModal('edit-profile-modal')"
                        class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit"
                        class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700">Ø­ÙØ¸</button>
                </div>
            </form>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home"></i> <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </a>
        <a href="s22marketfood.html" class="nav-item">
            <i class="fas fa-utensils text-orange-500"></i> <span>Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</span>
        </a>
        <a href="auctions.html" class="nav-item">
            <i class="fas fa-gavel text-red-500"></i> <span>Ø§Ù„Ù…Ø²Ø§Ø¯Ø§Øª</span>
        </a>
        <a href="cart.html" class="nav-item">
            <i class="fas fa-shopping-cart"></i> <span>Ø§Ù„Ø³Ù„Ø©</span>
        </a>
        <a href="profile.html" class="nav-item active">
            <i class="fas fa-user"></i> <span>Ø­Ø³Ø§Ø¨ÙŠ</span>
        </a>
    </nav>

    <div id="toast-container" class="fixed bottom-24 left-1/2 -translate-x-1/2 z-50"></div>

    <!-- Credential Card Modal -->
    <div id="credential-modal" class="modal">
        <div class="modal-content">
            <h3 class="font-bold text-lg text-gray-800 mb-4 text-center">ğŸ” Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù…Ù†Ø©</h3>
            <p class="text-xs text-gray-500 text-center mb-4">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„ØªÙˆÙ„ÙŠØ¯ ØµÙˆØ±Ø© ØªØ°ÙƒÙŠØ± Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„Ùƒ.</p>

            <div id="card-preview-container" class="hidden mb-4 flex-col items-center">
                <canvas id="cred-canvas" class="w-full rounded-lg shadow-lg mb-3"></canvas>
                <a id="download-card-link" href="#" download="S22-Credentials.png"
                    class="w-full bg-green-600 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 hover:bg-green-700">
                    <i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
                </a>
            </div>

            <form id="credential-form" class="space-y-4">
                <input type="password" id="confirm-pass"
                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3"
                    placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©" required>
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeModal('credential-modal')"
                        class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="submit" id="gen-card-btn"
                        class="flex-1 bg-purple-600 text-white font-bold py-3 rounded-xl hover:bg-purple-700">ØªÙˆÙ„ÙŠØ¯</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mobile Enhancements -->
    <script>
        /**
         * Mobile Enhancements Script
         * Handles back button for overlays, pull-to-refresh, and page transitions.
         */

        class MobileEnhancements {
            constructor() {
                this.overlayStack = []; // Stack to track open overlays (sidebar, modals)
                this.touchStartY = 0;
                this.refreshThreshold = 150; // Pull distance to trigger refresh
                this.isPulling = false;
                this.spinner = null;

                this.init();
            }

            init() {
                this.setupBackButton();
                this.setupPullToRefresh();
                this.setupPageTransitions();
                this.setupAutoHidingNavbar();
                this.setupPWAInstall();
                this.injectStyles();
            }

            // --- Back Button Logic ---

            setupBackButton() {
                // Push initial state to handle the first back press
                window.history.replaceState({ overlay: null }, document.title, window.location.href);

                window.addEventListener('popstate', (event) => {
                    if (this.overlayStack.length > 0) {
                        // If overlays are open, close the top one
                        const topOverlay = this.overlayStack.pop();
                        if (topOverlay && typeof topOverlay.close === 'function') {
                            topOverlay.close();
                            // Prevent default back navigation by pushing state again ONLY if we closed something
                            // However, popstate already happened, effectively "going back".
                            // If we want to stay on page, we need to push state again.
                            // But standard pattern:
                            // Open Overlay -> Push State
                            // Back Press -> Pop State -> Close Overlay

                            // So we don't need to push state here. The "Back" action removed the state we added when opening.
                        }
                    } else {
                        // Normal back navigation matches browser behavior
                    }
                });
            }

            /**
             * Call this when opening an overlay (Sidebar, Modal)
             * @param {Function} closeCallback - Function to actually close the UI element
             * @param {string} name - Name for debugging
             */
            pushOverlay(closeCallback, name = 'overlay') {
                this.overlayStack.push({ close: closeCallback, name });
                window.history.pushState({ overlay: name }, document.title, window.location.href);
            }

            /**
             * Call this when closing an overlay Programmatically (e.g. clicking 'X' button)
             * This ensures the history state is kept in sync (removes the state we added)
             */
            closeOverlay() {
                if (this.overlayStack.length > 0) {
                    // We do NOT pop here. We let the popstate event handler do it.
                    // This ensures consistent behavior whether the user presses Back or clicks 'X'.
                    window.history.back();
                }
            }

            // --- Pull to Refresh Logic ---

            setupPullToRefresh() {
                // Create Spinner
                this.spinner = document.createElement('div');
                this.spinner.className = 'ptr-spinner';
                this.spinner.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>';
                document.body.prepend(this.spinner);

                window.addEventListener('touchstart', (e) => {
                    if (window.scrollY === 0) {
                        this.touchStartY = e.touches[0].clientY;
                    }
                }, { passive: true });

                window.addEventListener('touchmove', (e) => {
                    if (window.scrollY === 0 && this.touchStartY > 0) {
                        const touchY = e.touches[0].clientY;
                        const pullDistance = touchY - this.touchStartY;

                        if (pullDistance > 0) {
                            this.isPulling = true;
                            // Visual feedback
                            this.spinner.style.transform = `translateY(${Math.min(pullDistance / 2, 80)}px) translateX(-50%) rotate(${pullDistance}deg)`;
                            this.spinner.style.opacity = Math.min(pullDistance / 100, 1);
                        }
                    }
                }, { passive: true });

                window.addEventListener('touchend', (e) => {
                    if (this.isPulling) {
                        const touchY = e.changedTouches[0].clientY;
                        const pullDistance = touchY - this.touchStartY;

                        if (pullDistance > this.refreshThreshold) {
                            this.triggerRefresh();
                        } else {
                            this.resetSpinner();
                        }
                        this.isPulling = false;
                        this.touchStartY = 0;
                    }
                });
            }

            triggerRefresh() {
                this.spinner.style.transition = '0.3s';
                this.spinner.style.transform = 'translateY(60px) translateX(-50%) rotate(360deg)';
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            }

            resetSpinner() {
                this.spinner.style.transition = '0.3s';
                this.spinner.style.transform = 'translateY(-50px) translateX(-50%)';
                this.spinner.style.opacity = '0';
            }

            // --- Page Transitions ---

            setupPageTransitions() {
                document.body.classList.add('page-enter');

                // Hijack internal links for exit animation (optional, can be disabled if buggy)
                // document.addEventListener('click', (e) => {
                //     const link = e.target.closest('a');
                //     if (link && link.href && link.href.startsWith(window.location.origin) && !link.target) {
                //         e.preventDefault();
                //         document.body.classList.add('page-exit');
                //         setTimeout(() => {
                //             window.location.href = link.href;
                //         }, 300);
                //     }
                // });
            }

            injectStyles() {
                const style = document.createElement('style');
                style.textContent = `
            /* Pull to Refresh Spinner */
            .ptr-spinner {
                position: fixed;
                top: -50px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 40px;
                background: white;
                border-radius: 50%;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                color: var(--primary, #4f46e5);
                opacity: 0;
                pointer-events: none;
            }

            /* Page Transitions */
            .page-enter {
                animation: fadeEnter 0.4s ease-out forwards;
            }
            @keyframes fadeEnter {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .page-exit {
                opacity: 0;
                transform: scale(0.98);
                transition: 0.3s;
            }

            /* Auto Hide Navbar */
            .bottom-nav {
                transition: transform 0.3s ease-in-out;
            }
            .bottom-nav.nav-hidden {
                transform: translateY(100%);
            }

            /* PWA Modal */
            .pwa-modal {
                position: fixed;
                bottom: 20px;
                left: 20px;
                right: 20px;
                background: white;
                border-radius: 16px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.15);
                z-index: 9999;
                transform: translateY(150%);
                transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                max-width: 400px;
                margin: 0 auto;
                border: 1px solid rgba(0,0,0,0.05);
            }
            
            .pwa-modal.active {
                transform: translateY(0);
            }

            .pwa-content {
                padding: 20px;
            }
        `;
                document.head.appendChild(style);
            }



            setupAutoHidingNavbar() {
                let lastScrollY = window.scrollY;
                const bottomNav = document.querySelector('.bottom-nav');
                if (!bottomNav) return;

                window.addEventListener('scroll', () => {
                    const currentScrollY = window.scrollY;
                    if (Math.abs(currentScrollY - lastScrollY) < 10) return;
                    if (currentScrollY > lastScrollY && currentScrollY > 100) {
                        bottomNav.classList.add('nav-hidden');
                    } else {
                        bottomNav.classList.remove('nav-hidden');
                    }
                    lastScrollY = currentScrollY;
                }, { passive: true });
            }

            // --- PWA Install Logic ğŸ“² ---
            setupPWAInstall() {
                let deferredPrompt;

                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;

                    // Check if user already dismissed it recently (optional: use localStorage)
                    if (localStorage.getItem('pwa-dismissed')) return;

                    // Show Custom Modal
                    this.showInstallModal(deferredPrompt);
                });
            }

            showInstallModal(deferredPrompt) {
                // Create Modal HTML
                const modal = document.createElement('div');
                modal.className = 'pwa-modal';
                modal.innerHTML = `
            <div class="pwa-content">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center text-indigo-600 text-2xl">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-gray-800">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
                        <p class="text-xs text-gray-500">ØªØ¬Ø±Ø¨Ø© Ø£Ø³Ø±Ø¹ ÙˆØ£ÙØ¶Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª!</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button id="pwa-dismiss" class="flex-1 py-2 text-gray-500 font-bold bg-gray-50 rounded-lg">Ù„ÙŠØ³ Ø§Ù„Ø¢Ù†</button>
                    <button id="pwa-install" class="flex-1 py-2 text-white font-bold bg-indigo-600 rounded-lg shadow-lg shadow-indigo-200">ØªØ«Ø¨ÙŠØª</button>
                </div>
            </div>
        `;
                document.body.appendChild(modal);

                // Animate In
                setTimeout(() => modal.classList.add('active'), 100);

                // Handlers
                document.getElementById('pwa-dismiss').onclick = () => {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                    localStorage.setItem('pwa-dismissed', 'true');
                };

                document.getElementById('pwa-install').onclick = async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                        }
                        deferredPrompt = null;
                    }
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                };
            }
        }

        // Initialize
        const mobileApp = new MobileEnhancements();

        // Global Helper for existing code to call
        window.openMobileOverlay = (closeCallback, name) => mobileApp.pushOverlay(closeCallback, name);
        window.closeMobileOverlay = () => mobileApp.closeOverlay();
        window.openMobileOverlay = (closeCallback, name) => mobileApp.pushOverlay(closeCallback, name);
        window.closeMobileOverlay = () => mobileApp.closeOverlay();

        // Canvas Generation Logic
        window.generateCredentialCard = (name, email, password) => {
            const canvas = document.getElementById('cred-canvas');
            const ctx = canvas.getContext('2d');

            // High Resolution
            canvas.width = 1080;
            canvas.height = 1920; // Story format

            // 1. Background (Gradient)
            const grd = ctx.createLinearGradient(0, 0, 0, canvas.height);
            grd.addColorStop(0, '#4f46e5');
            grd.addColorStop(1, '#7c3aed');
            ctx.fillStyle = grd;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 2. Pattern Overlay
            ctx.globalAlpha = 0.05;
            for (let i = 0; i < canvas.width; i += 40) {
                for (let j = 0; j < canvas.height; j += 40) {
                    ctx.beginPath();
                    ctx.arc(i, j, 2, 0, Math.PI * 2);
                    ctx.fillStyle = 'white';
                    ctx.fill();
                }
            }
            ctx.globalAlpha = 1.0;

            // 3. Glass Card
            const cardX = 100, cardY = 500, cardW = 880, cardH = 920;
            ctx.save();
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
            ctx.shadowBlur = 40;
            ctx.shadowOffsetY = 20;
            ctx.roundRect(cardX, cardY, cardW, cardH, 40);
            ctx.fill();

            // Glass Border
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 4;
            ctx.stroke();
            ctx.restore();

            // 4. Content
            ctx.textAlign = 'center';
            ctx.fillStyle = 'white';

            // Logo/Title
            ctx.font = 'bold 80px Tajawal';
            ctx.fillText('S22 MARKET', canvas.width / 2, cardY + 150);

            ctx.font = '50px Tajawal';
            ctx.globalAlpha = 0.8;
            ctx.fillText('Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ', canvas.width / 2, cardY + 230);
            ctx.globalAlpha = 1.0;

            // Fields
            const startY = cardY + 400;
            const gap = 180;

            const drawField = (label, value, y) => {
                ctx.fillStyle = 'rgba(255,255,255,0.6)';
                ctx.font = '40px Tajawal';
                ctx.fillText(label, canvas.width / 2, y);

                ctx.fillStyle = 'white';
                ctx.font = 'bold 60px Tajawal';
                ctx.fillText(value, canvas.width / 2, y + 70);
            };

            drawField('Ø§Ù„Ø§Ø³Ù…', name, startY);
            drawField('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', email, startY + gap);
            drawField('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', password, startY + (gap * 2));

            // Warning
            ctx.fillStyle = '#fca5a5';
            ctx.font = '30px Tajawal';
            ctx.fillText('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø­ÙØ¸ Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ù…Ù†', canvas.width / 2, cardY + cardH - 60);

            // Footer
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.font = '30px Tajawal';
            ctx.fillText('s22market.com', canvas.width / 2, canvas.height - 100);

            return canvas.toDataURL('image/png');
        };
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc, query, orderBy, serverTimestamp, where, limit, updateDoc, onSnapshot, arrayUnion, arrayRemove, setDoc, writeBatch, Timestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, sendPasswordResetEmail, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let userData = {};

        // --- Auth Logic ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserProfile(user.uid);
            } else {
                window.location.href = 'login.html';
            }
        });

        // --- Load Profile ---
        async function loadUserProfile(uid) {
            try {
                const docSnap = await getDoc(doc(db, "users", uid));
                if (docSnap.exists()) {
                    userData = docSnap.data();
                    renderProfile(userData);
                    checkStoreStatus(userData);

                    // Generate Referral if missing
                    if (!userData.referralCode) {
                        const code = uid.substring(0, 6).toUpperCase();
                        await updateDoc(doc(db, "users", uid), { referralCode: code });
                        document.getElementById('ref-code').textContent = code;
                    } else {
                        document.getElementById('ref-code').textContent = userData.referralCode;
                    }
                }
            } catch (e) { console.error(e); }
        }

        function renderProfile(data) {
            document.getElementById('user-name').textContent = data.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…';
            document.getElementById('user-email').textContent = data.email;
            document.getElementById('points-val').textContent = (data.loyaltyPoints || 0);
            document.getElementById('coins-val').textContent = (data.dawarat_coins || 0);
            // Badge
            const badge = document.getElementById('user-role-badge');
            if (data.role === 'vendor') { badge.textContent = 'ØªØ§Ø¬Ø±'; badge.className = 'bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold'; }
            else if (data.role === 'restaurant') { badge.textContent = 'Ù…Ø·Ø¹Ù…'; badge.className = 'bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-bold'; }

            // Edit Inputs
            document.getElementById('edit-name').value = data.displayName || '';
            document.getElementById('edit-phone').value = data.phone || '';
        }

        // --- Store Request Logic ---
        function checkStoreStatus(data) {
            const dashboardBtn = document.getElementById('dashboard-btn');
            const startBanner = document.getElementById('start-selling-banner');
            const pendingBanner = document.getElementById('pending-banner');
            const rejectedBanner = document.getElementById('rejected-banner');

            // Reset
            dashboardBtn.classList.add('hidden');
            startBanner.classList.add('hidden');
            pendingBanner.classList.add('hidden');
            rejectedBanner.classList.add('hidden');

            if (data.role === 'vendor') {
                dashboardBtn.href = 'seller-dashboard.html';
                dashboardBtn.classList.remove('hidden');
            } else if (data.role === 'restaurant') {
                dashboardBtn.href = 'restaurant-dashboard.html';
                dashboardBtn.classList.remove('hidden');
            } else if (data.storeRequest?.status === 'pending') {
                pendingBanner.classList.remove('hidden');
            } else if (data.storeRequest?.status === 'rejected') {
                rejectedBanner.classList.remove('hidden');
                document.getElementById('reject-reason').textContent = data.storeRequest.rejectionReason || 'Ù„Ù… ÙŠØªÙ… Ø°ÙƒØ± Ø³Ø¨Ø¨.';
            } else {
                startBanner.classList.remove('hidden');
                // Open modal if url has action param
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('action') === 'open_store') {
                    openStoreModal();
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }

        // --- Modal Functions ---
        window.openStoreModal = () => {
            const modal = document.getElementById('store-modal');
            modal.classList.add('active');

            // Mobile Overlay Hook
            if (window.openMobileOverlay) {
                window.openMobileOverlay(() => {
                    modal.classList.remove('active');
                }, 'store-modal');
            }

            // Pre-fill phone
            if (userData.phone) document.getElementById('req-phone').value = userData.phone;
        };

        window.openEditProfileModal = () => {
            const modal = document.getElementById('edit-profile-modal');
            modal.classList.add('active');

            // Mobile Overlay Hook
            if (window.openMobileOverlay) {
                window.openMobileOverlay(() => {
                    modal.classList.remove('active');
                }, 'edit-profile-modal');
            }
        };

        window.closeModal = (id) => {
            // Check if we are closing via button, we should sync history
            if (window.closeMobileOverlay) {
                // This triggers the callback passed in openMobileOverlay, effectively closing the modal
                window.closeMobileOverlay();
            } else {
                document.getElementById(id).classList.remove('active');
            }
        };

        // --- Form Submissions ---

        // 1. Submit Store Request
        document.getElementById('store-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-req-btn');
            btn.disabled = true; btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

            const reqData = {
                storeName: document.getElementById('req-name').value,
                storeType: document.getElementById('req-type').value,
                description: document.getElementById('req-desc').value,
                phone: document.getElementById('req-phone').value,
                status: 'pending',
                requestedAt: serverTimestamp()
            };

            try {
                await updateDoc(doc(db, "users", currentUser.uid), {
                    storeRequest: reqData,
                    phone: reqData.phone // Update user phone too
                });

                closeModal('store-modal');
                // Reload profile logic locally
                userData.storeRequest = reqData;
                checkStoreStatus(userData);

                // Confetti
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!');

            } catch (err) {
                console.error(err);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£');
            } finally {
                btn.disabled = false; btn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨';
            }
        });

        // 2. Edit Profile
        document.getElementById('profile-edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('edit-name').value;
            const phone = document.getElementById('edit-phone').value;

            try {
                await updateProfile(currentUser, { displayName: name });
                await updateDoc(doc(db, "users", currentUser.uid), {
                    displayName: name,
                    phone: phone
                });

                document.getElementById('user-name').textContent = name;
                closeModal('edit-profile-modal');
                showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª');
            } catch (e) { console.error(e); }
        });

        // --- Utils ---
        window.copyRef = () => {
            const code = document.getElementById('ref-code').textContent;
            navigator.clipboard.writeText(code);
            showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯!');
        };

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg text-sm mb-2 animate-bounce';
            el.textContent = msg;
            container.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        window.auth = auth; // For HTML access

        // Credential Modal Logic
        window.openCredentialModal = () => {
            const modal = document.getElementById('credential-modal');
            if (modal) {
                modal.classList.add('active');
                if (window.openMobileOverlay) window.openMobileOverlay(() => closeModal('credential-modal'), 'credentialModal');

                // Reset State
                document.getElementById('credential-form').reset();
                document.getElementById('card-preview-container').classList.add('hidden');
                document.getElementById('credential-form').classList.remove('hidden');

                // Ensure canvas is visible for drawing (even if hidden by container initially)
                const canvas = document.getElementById('cred-canvas');
                if (canvas) canvas.style.display = 'block';
            }
        };

        if (document.getElementById('credential-form')) {
            document.getElementById('credential-form').onsubmit = async (e) => {
                e.preventDefault();
                const btn = document.getElementById('gen-card-btn');
                const password = document.getElementById('confirm-pass').value;

                btn.disabled = true;
                btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';

                try {
                    // Verify password by re-authenticating
                    // Note: This requires the user to know their password. If Google Sign-In, this flow might error (no password).
                    // We assume Email/Password auth here as per request.
                    const credential = await signInWithEmailAndPassword(auth, currentUser.email, password);
                    if (credential.user) {
                        // Success: Generate Card
                        btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...';

                        if (window.generateCredentialCard) {
                            const imgData = window.generateCredentialCard(
                                userData.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…',
                                currentUser.email,
                                password
                            );

                            document.getElementById('credential-form').classList.add('hidden');
                            const previewContainer = document.getElementById('card-preview-container');
                            previewContainer.classList.remove('hidden');
                            previewContainer.style.display = 'flex';

                            document.getElementById('download-card-link').href = imgData;
                        } else {
                            alert("Ø®Ø·Ø£: Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙˆÙ„ÙŠØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");
                        }
                    }
                } catch (error) {
                    console.error(error);
                    alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!');
                } finally {
                    btn.disabled = false;
                    btn.innerText = 'ØªÙˆÙ„ÙŠØ¯';
                }
            };
        }
    </script>
</body>

</html>