<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ ÙˆÙ…Ø­Ø§ÙØ·ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f1f5f9;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        .small-loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                translateY(0);
            }
        }

        #user-menu-dropdown.show {
            display: block;
            animation: slideInUp 0.2s ease-out;
        }

        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
        }

        .toast {
            background-color: #2d3748;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInUp 0.3s ease, fadeOut 0.5s ease 2.5s forwards;
        }

        .toast.error {
            background-color: #c53030;
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        /* (Ø¬Ø¯ÙŠØ¯) Ø³ØªØ§ÙŠÙ„ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø© */
        .wallet-card {
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid white;
            text-align: center;
        }

        .wallet-title {
            font-weight: 700;
            font-size: 1.125rem;
            color: #475569;
        }

        .wallet-balance {
            font-weight: 800;
            font-size: 2.5rem;
            line-height: 1;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        /* (Ø¬Ø¯ÙŠØ¯) Ø³ØªØ§ÙŠÙ„ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .modal-backdrop.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
            z-index: 50;
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .modal-backdrop.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }
    </style>
</head>

<body>

    <header class="bg-white shadow-sm sticky top-0 z-30">
        <div class="max-w-7xl mx-auto py-3 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-3">
                <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800">
                    S22<span class="text-blue-600">MARKET</span>
                </h1>
            </a>

            <div id="header-actions" class="flex items-center gap-4 relative">
                <a href="index.html" id="store-btn"
                    class="relative text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 px-5 py-2.5 rounded-full transition-colors flex items-center gap-2 shadow-lg">
                    <i class="fas fa-store"></i>
                    <span>Ø§Ù„Ù…ØªØ¬Ø±</span>
                </a>
                <a href="login.html" id="login-btn"
                    class="hidden relative text-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 px-5 py-2.5 rounded-full transition-colors items-center gap-2 sm:flex">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</span>
                </a>

                <div id="user-menu" class="hidden">
                    <button id="user-menu-button"
                        class="flex items-center gap-2 text-lg font-semibold text-gray-700 bg-green-100 hover:bg-green-200 px-5 py-2.5 rounded-full transition-colors">
                        <i class="fas fa-user-check text-green-700"></i>
                        <span id="user-menu-name">...</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div id="user-menu-dropdown"
                        class="hidden absolute left-0 top-full mt-2 w-60 bg-white rounded-xl shadow-lg border z-50 overflow-hidden">
                        <div class="p-3 border-b">
                            <p class="text-sm text-gray-500">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ</p>
                            <p class="font-bold text-gray-800" id="user-menu-displayname">...</p>
                        </div>
                        <a href="profile.html"
                            class="block px-4 py-3 text-gray-700 bg-gray-100 font-bold transition-colors"><i
                                class="fas fa-user-circle fa-fw ml-2 text-gray-400"></i> Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ ÙˆÙ…Ø­Ø§ÙØ·ÙŠ</a>

                        <div class="px-4 pt-3 pb-1 text-xs font-semibold text-gray-400 uppercase">Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©</div>
                        <a href="dawarat_learning_dashboard.html"
                            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i
                                class="fas fa-graduation-cap fa-fw ml-2 text-indigo-400"></i> Ø¨Ø°Ù„ÙˆØ±Ø§ØªÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</a>
                        <a href="dawarat_loyalty_tasks.html"
                            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i
                                class="fas fa-tasks fa-fw ml-2 text-purple-400"></i> ÙƒØ³Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Øª (Ø§Ù„Ù…Ù‡Ø§Ù…)</a>
                        <a href="dawarat_loyalty_rewards.html"
                            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i
                                class="fas fa-gift fa-fw ml-2 text-yellow-400"></i> Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª</a>

                        <div class="px-4 pt-3 pb-1 text-xs font-semibold text-gray-400 uppercase">Ø§Ù„Ù…ØªØ¬Ø±</div>
                        <a href="seller-dashboard.html"
                            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i
                                class="fas fa-store fa-fw ml-2 text-blue-400"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¨Ø§Ø¦Ø¹</a>
                        <a href="order_history.html"
                            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i
                                class="fas fa-archive fa-fw ml-2 text-gray-400"></i> Ø£Ø±Ø´ÙŠÙ Ø·Ù„Ø¨Ø§ØªÙŠ</a>
                        <a href="loyalty_card.html"
                            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i
                                class="fas fa-star fa-fw ml-2 text-orange-400"></i> Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆÙØ§Ø¡ (Ø§Ù„Ø¬ÙˆØ§Ù‡Ø±)</a>

                        <button id="logout-btn"
                            class="w-full text-right px-4 py-3 text-red-600 hover:bg-red-50 border-t transition-colors"><i
                                class="fas fa-sign-out-alt fa-fw ml-2"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto py-12 px-4 sm:px-6 lg:px-8">

        <div id="auth-loader" class="text-center py-20">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600 text-lg">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ...</p>
        </div>

        <div id="profile-content" class="hidden" style="animation: slideInUp 0.5s ease-out;">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 text-center mb-8">
                Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ ÙˆÙ…Ø­Ø§ÙØ·ÙŠ
            </h1>

            <div class="mb-8">
                <!-- Status Banner for Pending Requests -->
                <div id="pending-request-banner"
                    class="hidden bg-yellow-50 border-r-4 border-yellow-400 p-4 rounded-lg mb-6 flex items-start">
                    <i class="fas fa-clock text-yellow-500 text-xl ml-3 mt-1"></i>
                    <div>
                        <h3 class="font-bold text-yellow-800">Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h3>
                        <p class="text-sm text-yellow-700 mt-1">Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ù„ÙØªØ­ Ù…ØªØ¬Ø±/Ù…Ø·Ø¹Ù…. Ø³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø±Ùƒ ÙÙˆØ±
                            Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„ÙŠÙ‡ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.</p>
                    </div>
                </div>

                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-2xl font-bold text-gray-700">Ø§Ù„Ù…Ø­Ø§ÙØ¸</h2>

                    <!-- Only show if NOT a vendor and NO pending request -->
                    <button id="open-store-btn"
                        class="hidden bg-gradient-to-l from-indigo-600 to-blue-600 text-white px-5 py-2 rounded-lg font-bold shadow hover:shadow-lg transition transform hover:-translate-y-1">
                        <i class="fas fa-store ml-2"></i> Ø§ÙØªØ­ Ù…ØªØ¬Ø±Ùƒ Ø§Ù„Ø¢Ù†
                    </button>

                    <!-- If Vendor -->
                    <a id="go-to-dashboard-btn" href="seller-dashboard.html"
                        class="hidden bg-green-600 text-white px-5 py-2 rounded-lg font-bold shadow hover:shadow-lg transition">
                        <i class="fas fa-chart-line ml-2"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                    </a>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                    <div class="wallet-card md:col-span-1">
                        <div class="wallet-title">Ø¬ÙˆØ§Ù‡Ø± Ø§Ù„Ù…ØªØ¬Ø± <i class="fas fa-gem text-blue-500"></i></div>
                        <div id="jewels-balance" class="wallet-balance text-blue-600">0</div>
                        <div class="text-sm text-gray-500">ØªØ³ØªØ®Ø¯Ù… Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±.</div>
                    </div>
                    <div class="text-center md:col-span-1">
                        <button id="open-convert-modal-btn"
                            class="bg-gray-700 text-white font-bold p-4 rounded-full shadow-lg hover:bg-gray-800 transform hover:scale-105 transition-transform">
                            <i class="fas fa-exchange-alt fa-fw"></i>
                        </button>
                        <p class="text-sm font-semibold text-gray-600 mt-2">ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª</p>
                    </div>
                    <div class="wallet-card md:col-span-1">
                        <div class="wallet-title">Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© <i class="fas fa-coins text-yellow-500"></i></div>
                        <div id="coins-balance" class="wallet-balance text-green-600">0</div>
                        <div class="text-sm text-gray-500">ØªØ³ØªØ®Ø¯Ù… Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª.</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-3">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h2>
                    <form id="profile-form" class="space-y-4">
                        <div>
                            <label for="profile-name" class="block text-sm font-bold text-gray-700">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                            <input type="text" id="profile-name"
                                class="mt-1 block w-full p-3 bg-gray-50 border border-gray-300 rounded-lg" required>
                        </div>
                        <div>
                            <label for="profile-phone" class="block text-sm font-bold text-gray-700">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù„Ø·Ù„Ø¨Ø§Øª
                                Ø§Ù„Ù…ØªØ¬Ø±)</label>
                            <input type="tel" id="profile-phone" dir="ltr"
                                class="mt-1 block w-full p-3 bg-gray-50 border border-gray-300 rounded-lg"
                                placeholder="05xxxxxxxx">
                        </div>
                        <div>
                            <label for="profile-email" class="block text-sm font-bold text-gray-700">Ø§Ù„Ø¨Ø±ÙŠØ¯
                                Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                            <input type="email" id="profile-email"
                                class="mt-1 block w-full p-3 bg-gray-200 border border-gray-300 rounded-lg text-gray-500"
                                disabled>
                        </div>
                        <button id="save-profile-btn" type="submit"
                            class="w-full flex justify-center items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-transform transform hover:scale-105 disabled:bg-indigo-400">
                            <span class="button-text">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</span>
                            <div class="small-loader button-loader hidden"></div>
                        </button>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-3">ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</h2>
                    <p class="text-gray-600">Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ. Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„Ù‡Ù… Ø¨Ù‡ØŒ Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ **<span
                            id="referral-bonus-amount">...</span> Ø¹Ù…Ù„Ø© ğŸª™** (Ø¨Ø¹Ø¯ Ø§Ø¹ØªÙ…Ø§Ø¯Ù‡Ù… Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©).</p>

                    <div id="referral-loader" class="text-center py-10">
                        <div class="loader mx-auto !w-10 !h-10"></div>
                        <p class="mt-2 text-gray-500">Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ©...</p>
                    </div>

                    <div id="referral-code-container" class="hidden mt-6 text-center">
                        <p class="text-lg font-bold text-gray-500">Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ùˆ:</p>
                        <div class="my-3 p-4 bg-indigo-50 border-2 border-dashed border-indigo-300 rounded-lg">
                            <span id="referral-code"
                                class="text-4xl font-extrabold text-indigo-600 tracking-widest"></span>
                        </div>
                        <button id="copy-referral-code-btn"
                            class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg transition-colors">
                            <i class="fas fa-copy mr-2"></i> <span>Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="convert-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-xl font-bold">ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª</h3>
                <button id="close-convert-modal-btn" class="text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
            </div>

            <form id="convert-form">
                <div class="space-y-4">
                    <div>
                        <label class="font-semibold">ØªØ­ÙˆÙŠÙ„ Ù…Ù†:</label>
                        <select id="convert-from"
                            class="mt-1 block w-full p-3 bg-gray-50 border border-gray-300 rounded-lg">
                            <option value="jewels">Ø¬ÙˆØ§Ù‡Ø± Ø§Ù„Ù…ØªØ¬Ø± ğŸ’</option>
                            <option value="coins">Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ğŸª™</option>
                        </select>
                    </div>
                    <div>
                        <label for="convert-amount" class="font-semibold">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­ÙˆÙŠÙ„Ù‡:</label>
                        <input type="number" id="convert-amount"
                            class="mt-1 block w-full p-3 bg-gray-50 border border-gray-300 rounded-lg" placeholder="0">
                    </div>
                    <div class="text-center p-4 bg-indigo-50 rounded-lg">
                        <p class="text-gray-600">Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰:</p>
                        <p id="convert-result" class="text-3xl font-extrabold text-indigo-600">0.00</p>
                        <p id="convert-rate-display" class="text-sm text-gray-500 mt-2">Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù: ...</p>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6 border-t pt-4">
                    <button id="convert-confirm-btn" type="submit"
                        class="w-full flex justify-center items-center gap-2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-transform transform hover:scale-105 disabled:bg-green-400">
                        <span class="button-text">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„</span>
                        <div class="small-loader button-loader hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-container"></div>

















    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, writeBatch, increment, runTransaction, collection, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
        const loginBtn = document.getElementById('login-btn');
        const userMenu = document.getElementById('user-menu');
        const userMenuButton = document.getElementById('user-menu-button');
        const userMenuDropdown = document.getElementById('user-menu-dropdown');
        const userMenuName = document.getElementById('user-menu-name');
        const userMenuDisplayName = document.getElementById('user-menu-displayname');
        const logoutBtn = document.getElementById('logout-btn');

        const authLoader = document.getElementById('auth-loader');
        const profileContent = document.getElementById('profile-content');

        const profileForm = document.getElementById('profile-form');
        const saveProfileBtn = document.getElementById('save-profile-btn');

        const referralLoader = document.getElementById('referral-loader');
        const referralContainer = document.getElementById('referral-code-container');
        const referralCodeEl = document.getElementById('referral-code');
        const copyReferralCodeBtn = document.getElementById('copy-referral-code-btn');
        const referralBonusAmountEl = document.getElementById('referral-bonus-amount');

        const jewelsBalanceEl = document.getElementById('jewels-balance');
        const coinsBalanceEl = document.getElementById('coins-balance');

        const convertModal = document.getElementById('convert-modal');
        const openConvertModalBtn = document.getElementById('open-convert-modal-btn');
        const closeConvertModalBtn = document.getElementById('close-convert-modal-btn');
        const convertForm = document.getElementById('convert-form');
        const convertFromSelect = document.getElementById('convert-from');
        const convertAmountInput = document.getElementById('convert-amount');
        const convertResultEl = document.getElementById('convert-result');
        const convertRateDisplayEl = document.getElementById('convert-rate-display');
        const convertConfirmBtn = document.getElementById('convert-confirm-btn');

        let currentUser = null;
        let currentUserData = {};
        let exchangeRates = {};
        let dawaratSettings = {};

        // --- (Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©) ---
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'error' : ''}`;
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
            toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        };
        function toggleButtonState(button, isLoading) {
            const text = button.querySelector('.button-text');
            const loader = button.querySelector('.button-loader');
            if (isLoading) {
                button.disabled = true;
                if (text) text.classList.add('hidden');
                if (loader) loader.classList.remove('hidden');
            } else {
                button.disabled = false;
                if (text) text.classList.remove('hidden');
                if (loader) loader.classList.add('hidden');
            }
        }

        // --- (Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ - Ù…Ø¹Ø¯Ù„Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„) ---
        async function loadProfileData(user) {
            try {
                // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                const settingsPromises = [
                    getDoc(doc(db, "settings", "storeConfig")),
                    getDoc(doc(db, "settings", "dawarat_loyalty_config"))
                ];
                const [storeConfigSnap, dawaratSettingsSnap] = await Promise.all(settingsPromises);

                if (storeConfigSnap.exists()) {
                    exchangeRates = storeConfigSnap.data().exchangeRates || {};
                }

                if (dawaratSettingsSnap.exists()) {
                    dawaratSettings = dawaratSettingsSnap.data();
                    referralBonusAmountEl.textContent = dawaratSettings.referralBonus || 0;
                } else {
                    referralBonusAmountEl.textContent = 0;
                }

                // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    currentUserData = userDocSnap.data();

                    document.getElementById('profile-phone').value = currentUserData.phone || '';

                    jewelsBalanceEl.textContent = (currentUserData.loyaltyPoints || 0).toLocaleString();
                    coinsBalanceEl.textContent = (currentUserData.dawarat_coins || 0).toLocaleString();

                    // === Store Request Logic ===
                    const startStoreBtn = document.getElementById('open-store-btn');
                    const dashboardBtn = document.getElementById('go-to-dashboard-btn');
                    const pendingBanner = document.getElementById('pending-request-banner');

                    if (startStoreBtn) startStoreBtn.classList.add('hidden');
                    if (dashboardBtn) dashboardBtn.classList.add('hidden');
                    if (pendingBanner) pendingBanner.classList.add('hidden');

                    if (user.uid && (currentUserData.role === 'vendor' || currentUserData.role === 'restaurant')) {
                        if (dashboardBtn) dashboardBtn.classList.remove('hidden');
                    } else if (currentUserData.storeRequest && currentUserData.storeRequest.status === 'pending') {
                        if (pendingBanner) pendingBanner.classList.remove('hidden');
                    } else {
                        if (startStoreBtn) {
                            startStoreBtn.classList.remove('hidden');
                            startStoreBtn.onclick = () => showStoreModal();
                        }
                    }

                    // Check URL params again inside async load
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('action') === 'open_store' && !currentUserData.role && (!currentUserData.storeRequest || currentUserData.storeRequest.status !== 'pending')) {
                        showStoreModal();
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }

                    // === Referral Code Logic ===
                    if (currentUserData.referralCode) {
                        referralCodeEl.textContent = currentUserData.referralCode;
                    } else {
                        const newCode = user.uid.substring(0, 8).toUpperCase();
                        try {
                            await updateDoc(userDocRef, { referralCode: newCode });
                            referralCodeEl.textContent = newCode;
                        } catch (updateError) {
                            // Ignore silent rule error
                            referralCodeEl.textContent = newCode;
                        }
                    }
                    referralLoader.classList.add('hidden');
                    referralContainer.classList.remove('hidden');

                } else {
                    throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
                }

                authLoader.classList.add('hidden');
                profileContent.classList.remove('hidden');

            } catch (error) {
                console.error("Error loading profile data: ", error);
                authLoader.innerHTML = `<p class="text-red-500 text-center">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ: ${error.message}</p>`;
            }
        }

        // Modal Logic
        function showStoreModal() {
            const modalHTML = `
            <div class="modal-backdrop" id="store-request-modal">
                <div class="modal-content animate-fade-in-up w-full max-w-2xl">
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h3 class="text-xl font-bold text-indigo-700">Ø·Ù„Ø¨ ÙØªØ­ Ù…ØªØ¬Ø± / Ù…Ø·Ø¹Ù…</h3>
                        <button onclick="document.getElementById('store-request-modal').remove()" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button>
                    </div>
                    <form id="store-request-form">
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block font-semibold mb-1">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø± / Ø§Ù„Ù…Ø·Ø¹Ù…</label>
                                    <input type="text" id="req-store-name" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø·Ø¹Ù… Ø§Ù„Ø³Ø¹Ø§Ø¯Ø©" required>
                                </div>
                                <div>
                                    <label class="block font-semibold mb-1">Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·</label>
                                    <select id="req-store-type" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="vendor">Ù…ØªØ¬Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø¨ÙŠØ¹ Ù…Ù†ØªØ¬Ø§Øª)</option>
                                        <option value="restaurant">Ù…Ø·Ø¹Ù… / ÙƒØ§ÙÙŠÙ‡ (Ø·Ø¹Ø§Ù… ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª)</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block font-semibold mb-1">ÙˆØµÙ Ù…Ø®ØªØµØ±</label>
                                <textarea id="req-store-desc" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500" rows="3" placeholder="Ù…Ø§Ø°Ø§ ØªØ¨ÙŠØ¹ØŸ"></textarea>
                            </div>

                            <div class="pt-4 border-t">
                                <h4 class="font-bold text-gray-700 mb-2">Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="flex items-center gap-2">
                                        <i class="fab fa-facebook text-blue-600 text-xl"></i>
                                        <input type="url" id="req-fb" class="w-full p-2 border rounded text-sm" placeholder="Ø±Ø§Ø¨Ø· ÙÙŠØ³Ø¨ÙˆÙƒ">
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fab fa-instagram text-pink-600 text-xl"></i>
                                        <input type="url" id="req-insta" class="w-full p-2 border rounded text-sm" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù†Ø³ØªØºØ±Ø§Ù…">
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fab fa-telegram text-blue-400 text-xl"></i>
                                        <input type="url" id="req-telegram" class="w-full p-2 border rounded text-sm" placeholder="Ø±Ø§Ø¨Ø· ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…">
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-phone text-green-600 text-xl"></i>
                                        <input type="tel" id="req-phone" class="w-full p-2 border rounded text-sm" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø¥Ø¶Ø§ÙÙŠ">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button type="button" onclick="document.getElementById('store-request-modal').remove()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" id="submit-request-btn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-lg">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            document.getElementById('store-request-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('submit-request-btn');
                const name = document.getElementById('req-store-name').value;
                const type = document.getElementById('req-store-type').value;
                const desc = document.getElementById('req-store-desc').value;

                const socialLinks = {
                    facebook: document.getElementById('req-fb').value.trim(),
                    instagram: document.getElementById('req-insta').value.trim(),
                    telegram: document.getElementById('req-telegram').value.trim(),
                    phone: document.getElementById('req-phone').value.trim()
                };

                btn.disabled = true;
                btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

                try {
                    await updateDoc(doc(db, "users", currentUser.uid), {
                        storeRequest: {
                            status: 'pending',
                            storeName: name,
                            storeType: type,
                            description: desc,
                            links: socialLinks,
                            requestedAt: Timestamp.now()
                        }
                    });
                    document.getElementById('store-request-modal').remove();
                    showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ø³ØªØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ Ù‚Ø±ÙŠØ¨Ø§Ù‹.', 'success');
                    setTimeout(() => window.location.reload(), 2000); // Reload to show banner
                } catch (err) {
                    console.error(err);
                    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.', 'error');
                    btn.disabled = false;
                    btn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨';
                }
            });
        }

        // --- (Ù…Ø¹Ø§Ù„Ø¬ Ø­ÙØ¸ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„) ---
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleButtonState(saveProfileBtn, true);
            const newName = document.getElementById('profile-name').value.trim();
            const newPhone = document.getElementById('profile-phone').value.trim();
            if (!newName || !newPhone) {
                showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.', 'error');
                toggleButtonState(saveProfileBtn, false);
                return;
            }
            try {
                const batch = writeBatch(db);
                const userDocRef = doc(db, 'users', currentUser.uid);
                batch.update(userDocRef, { displayName: newName, phone: newPhone });
                await updateProfile(currentUser, { displayName: newName });
                await batch.commit();
                userMenuName.textContent = newName.split(' ')[0];
                userMenuDisplayName.textContent = newName;
                showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            } catch (error) {
                console.error("Error updating profile: ", error);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª.', 'error');
            } finally {
                toggleButtonState(saveProfileBtn, false);
            }
        });

        // --- (Ù…Ø¹Ø§Ù„Ø¬ Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ©) ---
        copyReferralCodeBtn.addEventListener('click', () => {
            const code = referralCodeEl.textContent;
            navigator.clipboard.writeText(code).then(() => {
                copyReferralCodeBtn.querySelector('span').textContent = 'ØªÙ… Ø§Ù„Ù†Ø³Ø®!';
                copyReferralCodeBtn.classList.add('bg-green-200');
                setTimeout(() => {
                    copyReferralCodeBtn.querySelector('span').textContent = 'Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯';
                    copyReferralCodeBtn.classList.remove('bg-green-200');
                }, 2000);
            });
        });

        // --- (Ø¯Ø§Ù„Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…) ---
        const getNum = (id) => parseFloat(document.getElementById(id).value) || 0;

        // --- (Ù…Ù†Ø·Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„) ---
        openConvertModalBtn.addEventListener('click', () => {
            updateConversionRate();
            convertModal.classList.add('active');
        });
        closeConvertModalBtn.addEventListener('click', () => convertModal.classList.remove('active'));

        function updateConversionRate() {
            const fromCurrency = convertFromSelect.value;
            let rateText = "";
            let toCurrencyText = "";
            let result = 0;
            const amount = getNum('convert-amount');
            const rate_J_to_C = (exchangeRates.jewels_to_coins || 0) / 100;
            const rate_C_to_J = (exchangeRates.coins_to_jewels || 0) / 100;

            if (fromCurrency === 'jewels') {
                result = amount * rate_J_to_C;
                toCurrencyText = "Ø¹Ù…Ù„Ø© ğŸª™";
                rateText = `Ø§Ù„Ø³Ø¹Ø±: 100 Ø¬ÙˆÙ‡Ø±Ø© ğŸ’ = ${exchangeRates.jewels_to_coins || 0} Ø¹Ù…Ù„Ø© ğŸª™`;
            } else { // from 'coins'
                result = amount * rate_C_to_J;
                toCurrencyText = "Ø¬ÙˆÙ‡Ø±Ø© ğŸ’";
                rateText = `Ø§Ù„Ø³Ø¹Ø±: 100 Ø¹Ù…Ù„Ø© ğŸª™ = ${exchangeRates.coins_to_jewels || 0} Ø¬ÙˆÙ‡Ø±Ø© ğŸ’`;
            }

            convertResultEl.textContent = `${result.toFixed(2)} ${toCurrencyText}`;
            convertRateDisplayEl.textContent = rateText;
        }

        convertFromSelect.addEventListener('change', updateConversionRate);
        convertAmountInput.addEventListener('input', updateConversionRate);

        // (Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­ÙˆÙŠÙ„)
        convertForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleButtonState(convertConfirmBtn, true);
            const amount = getNum('convert-amount');
            const fromCurrency = convertFromSelect.value;
            const currentJewels = currentUserData.loyaltyPoints || 0;
            const currentCoins = currentUserData.dawarat_coins || 0;
            const rate_J_to_C = (exchangeRates.jewels_to_coins || 0) / 100;
            const rate_C_to_J = (exchangeRates.coins_to_jewels || 0) / 100;

            let jewelsToRemove = 0, coinsToGet = 0, coinsToRemove = 0, jewelsToGet = 0;

            if (fromCurrency === 'jewels') {
                jewelsToRemove = amount;
                coinsToGet = amount * rate_J_to_C;
                if (jewelsToRemove > currentJewels) {
                    showToast('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø±ØµÙŠØ¯ Ø¬ÙˆØ§Ù‡Ø± ğŸ’ ÙƒØ§ÙÙ.', 'error');
                    toggleButtonState(convertConfirmBtn, false); return;
                }
            } else {
                coinsToRemove = amount;
                jewelsToGet = amount * rate_C_to_J;
                if (coinsToRemove > currentCoins) {
                    showToast('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø±ØµÙŠØ¯ Ø¹Ù…Ù„Ø§Øª ğŸª™ ÙƒØ§ÙÙ.', 'error');
                    toggleButtonState(convertConfirmBtn, false); return;
                }
            }
            if (amount <= 0) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.', 'error');
                toggleButtonState(convertConfirmBtn, false); return;
            }
            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userDocRef);
                    if (!userDoc.exists()) throw "User document does not exist!";
                    const data = userDoc.data();
                    const newJewels = (data.loyaltyPoints || 0) - jewelsToRemove + jewelsToGet;
                    const newCoins = (data.dawarat_coins || 0) - coinsToRemove + coinsToGet;
                    if (newJewels < 0 || newCoins < 0) throw "Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ. ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.";
                    transaction.update(userDocRef, { loyaltyPoints: newJewels, dawarat_coins: newCoins });
                });
                currentUserData.loyaltyPoints = (currentUserData.loyaltyPoints || 0) - jewelsToRemove + jewelsToGet;
                currentUserData.dawarat_coins = (currentUserData.dawarat_coins || 0) - coinsToRemove + coinsToGet;
                jewelsBalanceEl.textContent = currentUserData.loyaltyPoints.toLocaleString();
                coinsBalanceEl.textContent = currentUserData.dawarat_coins.toLocaleString();
                convertAmountInput.value = "";
                updateConversionRate();
                convertModal.classList.remove('active');
                showToast('ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            } catch (error) {
                console.error("Conversion Error: ", error);
                showToast(`ÙØ´Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„: ${error.toString()}`, 'error');
            } finally {
                toggleButtonState(convertConfirmBtn, false);
            }
        });

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ØµÙØ­Ø© ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loginBtn.classList.add('hidden');
                loginBtn.classList.remove('sm:flex');
                userMenu.classList.remove('hidden');

                const displayName = user.displayName || "Ø¹Ù…ÙŠÙ„Ù†Ø§";
                userMenuName.textContent = displayName.split(' ')[0];
                userMenuDisplayName.textContent = displayName;

                loadProfileData(user);
            } else {
                window.location.href = 'login.html';
            }
        });

        // --- Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ (Ù„Ù€ S22 Market) ---
        userMenuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            userMenuDropdown.classList.toggle('show');
        });
        document.addEventListener('click', () => {
            if (userMenuDropdown.classList.contains('show')) {
                userMenuDropdown.classList.remove('show');
            }
        });
        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch((error) => console.error('Logout Error', error));
        });
    </script>
</body>

</html>