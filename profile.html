<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S22 Market - Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="app-style.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
            padding-bottom: 90px;
        }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© */
        .profile-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            padding-bottom: 60px;
            position: relative;
            overflow: hidden;
        }

        .header-pattern {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.1;
            background-image: radial-gradient(circle, #ffffff 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* ÙƒØ§Ø±Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
        .user-card {
            margin-top: -50px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 20px;
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .user-avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin: -55px auto 10px;
            background: #e0e7ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: #4f46e5;
        }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© */
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
            border: 1px solid #f1f5f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: transform 0.2s;
        }

        .stat-card:active {
            transform: scale(0.97);
        }

        /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
        .menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: white;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
            transition: background 0.2s;
            cursor: pointer;
        }

        .menu-item:active {
            background: #f8fafc;
        }

        .menu-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-left: 15px;
        }

        /* Ø¨Ø§Ù†Ø± Ø§Ù„Ù…ØªØ¬Ø± */
        .store-banner {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 16px;
            padding: 20px;
            color: white;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2);
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: 20px;
            padding: 24px;
            transform: scale(0.95);
            transition: transform 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        /* Responsive Modal (Bottom Sheet on Mobile) */
        @media (max-width: 768px) {
            .modal {
                align-items: flex-end;
                /* Align to bottom */
            }

            .modal-content {
                width: 100%;
                max-width: 100%;
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
                border-top-left-radius: 25px;
                border-top-right-radius: 25px;
                padding: 30px 24px 40px;
                /* Extra padding at bottom */
                transform: translateY(100%);
                transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            }

            .modal.active .modal-content {
                transform: translateY(0);
            }
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            height: 70px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            color: #94a3b8;
            gap: 4px;
        }

        .nav-item.active {
            color: #4f46e5;
            font-weight: bold;
        }

        .nav-item i {
            font-size: 20px;
        }
    </style>
</head>

<body>

    <div class="profile-header">
        <div class="header-pattern"></div>
        <div class="relative z-10 px-6 pt-8 pb-4 flex justify-between items-center text-white">
            <h1 class="text-xl font-bold">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h1>
            <button onclick="handleSignOut()"
                class="bg-white/20 backdrop-blur px-3 py-1.5 rounded-lg text-sm hover:bg-white/30 transition">
                <i class="fas fa-sign-out-alt ml-1"></i> Ø®Ø±ÙˆØ¬
            </button>
        </div>
    </div>

    <div class="px-4 pb-4">
        <div class="user-card">
            <div id="avatar-placeholder" class="user-avatar">
                <i class="fas fa-user"></i>
            </div>
            <h2 id="user-name" class="text-xl font-bold text-gray-800 mt-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
            <p id="user-email" class="text-gray-500 text-sm mb-3">...</p>
            <span id="user-role-badge"
                class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold">Ø¹Ø¶Ùˆ</span>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-4">
            <div class="stat-card">
                <div class="w-8 h-8 rounded-full bg-yellow-50 text-yellow-600 flex items-center justify-center"><i
                        class="fas fa-coins"></i></div>
                <span class="font-bold text-gray-800" id="coins-val">0</span>
                <span class="text-xs text-gray-500">Ø¹Ù…Ù„Ø§Øª</span>
            </div>
            <div class="stat-card" onclick="location.href='order_history.html'">
                <div class="w-8 h-8 rounded-full bg-green-50 text-green-600 flex items-center justify-center"><i
                        class="fas fa-shopping-bag"></i></div>
                <span class="font-bold text-gray-800" id="orders-val">0</span>
                <span class="text-xs text-gray-500">Ø·Ù„Ø¨Ø§Øª</span>
            </div>
        </div>

        <div id="store-section" class="mt-6">
            <div id="start-selling-banner" class="store-banner hidden cursor-pointer" onclick="openStoreModal()">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-lg mb-1">Ø§Ø¨Ø¯Ø£ ØªØ¬Ø§Ø±ØªÙƒ Ù…Ø¹Ù†Ø§! ğŸš€</h3>
                        <p class="text-xs text-green-100 opacity-90">Ø§ÙØªØ­ Ù…ØªØ¬Ø±Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø¬Ø§Ù†Ø§Ù‹ ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ø¨ÙŠØ¹.</p>
                    </div>
                    <div class="bg-white/20 p-2 rounded-lg"><i class="fas fa-store text-2xl"></i></div>
                </div>
            </div>

            <div id="pending-banner"
                class="hidden bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-4 flex items-start gap-3">
                <i class="fas fa-clock text-yellow-500 text-xl mt-1"></i>
                <div>
                    <h3 class="font-bold text-yellow-800">Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h3>
                    <p class="text-xs text-yellow-700 mt-1">ÙØ±ÙŠÙ‚Ù†Ø§ ÙŠØ±Ø§Ø¬Ø¹ Ø·Ù„Ø¨Ùƒ Ù„ÙØªØ­ Ø§Ù„Ù…ØªØ¬Ø±. Ø³ÙŠØµÙ„Ùƒ Ø¥Ø´Ø¹Ø§Ø± Ù‚Ø±ÙŠØ¨Ø§Ù‹.</p>
                </div>
            </div>

            <div id="rejected-banner" class="hidden bg-red-50 border border-red-200 rounded-xl p-4 mb-4">
                <div class="flex items-start gap-3">
                    <i class="fas fa-times-circle text-red-500 text-xl mt-1"></i>
                    <div>
                        <h3 class="font-bold text-red-800">ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨</h3>
                        <p class="text-xs text-red-700 mt-1" id="reject-reason">...</p>
                        <button onclick="openStoreModal()" class="mt-2 text-xs font-bold text-red-600 underline">ØªØ¹Ø¯ÙŠÙ„
                            ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                </div>
            </div>

            <a href="seller-dashboard.html" id="dashboard-btn"
                class="hidden w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 mb-3 hover:bg-indigo-700 transition">
                <i class="fas fa-chart-pie"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ØªØ§Ø¬Ø±
            </a>

            <!-- Store Share Actions -->
            <div id="store-share-container" class="hidden grid grid-cols-2 gap-3 mb-6">
                <button onclick="copyStoreLink()"
                    class="bg-gray-100 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-200 flex items-center justify-center gap-2 transition">
                    <i class="fas fa-copy"></i> Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
                </button>
                <button onclick="shareStoreLink()"
                    class="bg-blue-50 text-blue-600 font-bold py-3 rounded-xl hover:bg-blue-100 flex items-center justify-center gap-2 transition">
                    <i class="fas fa-share-alt"></i> Ù…Ø´Ø§Ø±ÙƒØ©
                </button>
            </div>
        </div>

        <div class="space-y-1">
            <div class="menu-item" onclick="openEditProfileModal()">
                <div class="flex items-center">
                    <div class="menu-icon bg-gray-50 text-gray-600"><i class="fas fa-user-edit"></i></div>
                    <span class="font-bold text-gray-700">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</span>
                </div>
                <i class="fas fa-chevron-left text-gray-400 text-xs"></i>
            </div>



            <a href="order_history.html" class="menu-item">
                <div class="flex items-center">
                    <div class="menu-icon bg-blue-50 text-blue-500"><i class="fas fa-archive"></i></div>
                    <span class="font-bold text-gray-700">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
                </div>
                <i class="fas fa-chevron-left text-gray-400 text-xs"></i>
            </a>

            <a href="wishlist.html" class="menu-item">
                <div class="flex items-center">
                    <div class="menu-icon bg-pink-50 text-pink-500"><i class="fas fa-heart"></i></div>
                    <span class="font-bold text-gray-700">Ø§Ù„Ù…ÙØ¶Ù„Ø©</span>
                </div>
                <i class="fas fa-chevron-left text-gray-400 text-xs"></i>
            </a>
            <div class="menu-item" onclick="openCredentialModal()">
                <div class="flex items-center">
                    <div class="menu-icon bg-purple-50 text-purple-500"><i class="fas fa-key"></i></div>
                    <span class="font-bold text-gray-700">ØªÙˆÙ„ÙŠØ¯ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
                </div>
                <i class="fas fa-chevron-left text-gray-400 text-xs"></i>
            </div>
        </div>

        <div class="mt-6 bg-indigo-50 border-2 border-dashed border-indigo-200 rounded-xl p-4 text-center">
            <p class="text-xs text-indigo-500 font-bold mb-1">ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</p>
            <div class="flex justify-center items-center gap-3">
                <span id="ref-code" class="text-2xl font-black text-indigo-700 tracking-widest">...</span>
                <button onclick="copyRef()" class="text-indigo-400 hover:text-indigo-600"><i
                        class="fas fa-copy"></i></button>
            </div>
            <p class="text-[10px] text-indigo-400 mt-2">Ø´Ø§Ø±Ùƒ Ø§Ù„ÙƒÙˆØ¯ ğŸ</p>
        </div>

    </div>

    <div id="store-modal" class="modal">
        <div class="modal-content !max-w-2xl">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="font-bold text-lg text-gray-800">Ø·Ù„Ø¨ ÙØªØ­ Ù…ØªØ¬Ø± / Ø§Ù†Ø¶Ù…Ø§Ù… ÙƒØ¨Ø§Ø¦Ø¹</h3>
                <button onclick="closeModal('store-modal')" class="text-gray-400 hover:text-red-500 text-xl"><i
                        class="fas fa-times"></i></button>
            </div>
            <form id="store-form" class="space-y-4">

                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                    <h4 class="font-bold text-indigo-800 mb-3 text-sm"><i class="fas fa-user-circle"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØµØ§Ø­Ø¨
                        Ø§Ù„Ù…ØªØ¬Ø±</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨</label>
                            <input type="text" id="req-applicant-name"
                                class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"
                                placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <input type="tel" id="req-phone"
                                class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"
                                dir="ltr" required>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <h4 class="font-bold text-gray-800 mb-3 text-sm"><i class="fas fa-store"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±</label>
                            <input type="text" id="req-name"
                                class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"
                                placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯/Ø§Ù„Ù…Ø­Ù„" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·</label>
                            <select id="req-type"
                                class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500">
                                <option value="vendor">Ù…ØªØ¬Ø± (Ù…Ù†ØªØ¬Ø§ØªØŒ Ù…Ù„Ø§Ø¨Ø³ØŒ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª...)</option>
                                <option value="restaurant">Ù…Ø·Ø¹Ù… / Ù…Ù‚Ù‡Ù‰ / Ø£ÙƒÙ„ Ù…Ù†Ø²Ù„ÙŠ</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Ø§Ù„ØªØ®ØµØµ / Ø§Ù„Ù…Ø¬Ø§Ù„</label>
                        <input type="text" id="req-specialty"
                            class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"
                            placeholder="Ù…Ø«Ø§Ù„: Ø¨ÙŠØ¹ Ø§Ù„Ø¹Ø·ÙˆØ±ØŒ Ø·Ø¨Ø® ØªÙ‚Ù„ÙŠØ¯ÙŠØŒ ØµÙŠØ§Ù†Ø© Ù‡ÙˆØ§ØªÙ..." required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">ÙˆØµÙ Ø§Ù„Ù…ØªØ¬Ø±</label>
                        <textarea id="req-desc"
                            class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"
                            rows="2" placeholder="Ù†Ø¨Ø°Ø© Ù…Ø®ØªØµØ±Ø© Ø¹Ù† Ù…Ø§ ØªÙ‚Ø¯Ù…Ù‡..."></textarea>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <h4 class="font-bold text-gray-800 mb-3 text-sm"><i class="fas fa-map-marker-alt"></i> Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„
                    </h4>
                    <div class="mb-3">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù†Ø´Ø§Ø·</label>
                        <select id="req-region-type"
                            class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"
                            onchange="toggleWilayaInput()">
                            <option value="national">ÙƒØ§Ù…Ù„ Ø§Ù„ØªØ±Ø§Ø¨ Ø§Ù„ÙˆØ·Ù†ÙŠ (ØªÙˆØµÙŠÙ„ 58 ÙˆÙ„Ø§ÙŠØ©)</option>
                            <option value="local">Ù…Ù†Ø·Ù‚Ø© Ù…Ø­Ø¯Ø¯Ø© (ÙˆÙ„Ø§ÙŠØ©/Ø¨Ù„Ø¯ÙŠØ©)</option>
                        </select>
                    </div>
                    <div id="wilaya-input-container" class="hidden">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ© / Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                        <input type="text" id="req-region-specific"
                            class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"
                            placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± Ø§Ù„Ø¹Ø§ØµÙ…Ø© ÙˆØ¶ÙˆØ§Ø­ÙŠÙ‡Ø§">
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <h4 class="font-bold text-gray-800 mb-3 text-sm"><i class="fas fa-link"></i> Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1"><i
                                    class="fab fa-facebook text-blue-600"></i> ÙÙŠØ³Ø¨ÙˆÙƒ</label>
                            <input type="url" id="req-fb"
                                class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"
                                placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø©">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1"><i
                                    class="fab fa-instagram text-pink-600"></i> Ø§Ù†Ø³ØªØºØ±Ø§Ù…</label>
                            <input type="url" id="req-insta"
                                class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"
                                placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø­Ø³Ø§Ø¨">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-1">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
                    <textarea id="req-extra"
                        class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"
                        rows="2" placeholder="Ø£ÙŠ ØªÙØ§ØµÙŠÙ„ Ø£Ø®Ø±Ù‰ ØªÙˆØ¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§..."></textarea>
                </div>

                <button type="submit" id="submit-req-btn"
                    class="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition">
                    Ù…ØªØ§Ø¨Ø¹Ø© <i class="fas fa-arrow-left mr-2"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Terms Modal -->
    <div id="terms-modal" class="modal z-[110]">
        <div class="modal-content">
            <h3 class="font-bold text-lg text-gray-800 mb-4 text-center">ğŸ“œ Ø´Ø±ÙˆØ· ÙˆØ£Ø­ÙƒØ§Ù… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</h3>
            <div id="terms-content"
                class="bg-gray-50 p-4 rounded-xl text-sm text-gray-600 h-64 overflow-y-auto border mb-4 leading-relaxed whitespace-pre-wrap">
                Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø±ÙˆØ·...
            </div>
            <div class="flex items-start gap-3 mb-6 bg-indigo-50 p-3 rounded-lg">
                <input type="checkbox" id="terms-agree-check" class="mt-1 w-5 h-5 text-indigo-600 rounded">
                <label for="terms-agree-check" class="text-sm font-bold text-gray-700 cursor-pointer">Ù„Ù‚Ø¯ Ù‚Ø±Ø£Øª Ø§Ù„Ø´Ø±ÙˆØ·
                    ÙˆØ£ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŒ ÙˆØ£ØªØ¹Ù‡Ø¯ Ø¨Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ù…Ù†ØµØ©.</label>
            </div>
            <div class="flex gap-3">
                <button onclick="closeModal('terms-modal')"
                    class="flex-1 bg-gray-200 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-300">Ø¥Ù„ØºØ§Ø¡</button>
                <button id="confirm-terms-btn"
                    class="flex-1 bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 shadow-lg opacity-50 cursor-not-allowed"
                    disabled>Ù…ÙˆØ§ÙÙ‚ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
            </div>
        </div>
    </div>

    <div id="edit-profile-modal" class="modal">
        <div class="modal-content">
            <h3 class="font-bold text-lg text-gray-800 mb-4">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h3>
            <form id="profile-edit-form" class="space-y-4">
                <input type="text" id="edit-name" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3"
                    placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>

                <select id="edit-wilaya"
                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-gray-700">
                    <option value="">Ø§Ø®ØªØ± ÙˆÙ„Ø§ÙŠØªÙƒ (Ù„ØªØµÙÙŠØ© Ø§Ù„Ù…Ø·Ø§Ø¹Ù…)</option>
                    <!-- Wilayas populated by JS -->
                </select>

                <input type="tel" id="edit-phone" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3"
                    placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" dir="ltr">
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeModal('edit-profile-modal')"
                        class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit"
                        class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700">Ø­ÙØ¸</button>
                </div>
            </form>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home"></i> <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </a>
        <a href="s22marketfood.html" class="nav-item">
            <i class="fas fa-utensils text-orange-500"></i> <span>Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</span>
        </a>
        <a href="auctions.html" class="nav-item">
            <i class="fas fa-gavel text-red-500"></i> <span>Ø§Ù„Ù…Ø²Ø§Ø¯Ø§Øª</span>
        </a>
        <a href="cart.html" class="nav-item">
            <i class="fas fa-shopping-cart"></i> <span>Ø§Ù„Ø³Ù„Ø©</span>
        </a>
        <a href="profile.html" class="nav-item active">
            <i class="fas fa-user"></i> <span>Ø­Ø³Ø§Ø¨ÙŠ</span>
        </a>
    </nav>

    <div id="toast-container" class="fixed bottom-24 left-1/2 -translate-x-1/2 z-50"></div>

    <!-- Credential Card Modal -->
    <div id="credential-modal" class="modal">
        <div class="modal-content">
            <h3 class="font-bold text-lg text-gray-800 mb-4 text-center">ğŸ” Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù…Ù†Ø©</h3>
            <p class="text-xs text-gray-500 text-center mb-4">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„ØªÙˆÙ„ÙŠØ¯ ØµÙˆØ±Ø© ØªØ°ÙƒÙŠØ± Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„Ùƒ.</p>

            <div id="card-preview-container" class="hidden mb-4 flex-col items-center">
                <canvas id="cred-canvas" class="w-full rounded-lg shadow-lg mb-3"></canvas>
                <a id="download-card-link" href="#" download="S22-Credentials.png"
                    class="w-full bg-green-600 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 hover:bg-green-700">
                    <i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
                </a>
            </div>

            <form id="credential-form" class="space-y-4">
                <input type="password" id="confirm-pass"
                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3"
                    placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©" required>
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeModal('credential-modal')"
                        class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="submit" id="gen-card-btn"
                        class="flex-1 bg-purple-600 text-white font-bold py-3 rounded-xl hover:bg-purple-700">ØªÙˆÙ„ÙŠØ¯</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './app-core.js';
        import { signOut, onAuthStateChanged, updateProfile, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { collection, query, where, getDocs, orderBy, limit, getDoc, doc, updateDoc, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose auth to window for inline onclick logic
        window.auth = auth;

        window.handleSignOut = () => {
            signOut(auth).then(() => window.location.href = 'index.html');
        };

        let currentUser = null;
        let userData = {};

        // Auth Logic
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserProfile(user.uid);
            } else {
                // Save return URL and redirect
                localStorage.setItem('s22_return_url', window.location.href);
                window.location.href = 'login.html';
            }
        });

        // --- Load Profile ---
        async function loadUserProfile(uid) {
            try {
                const docSnap = await getDoc(doc(db, "users", uid));
                if (docSnap.exists()) {
                    userData = docSnap.data();
                    renderProfile(userData);
                    checkStoreStatus(userData);

                    if (!userData.referralCode) {
                        const code = uid.substring(0, 6).toUpperCase();
                        await updateDoc(doc(db, "users", uid), { referralCode: code });
                        document.getElementById('ref-code').innerText = code;
                    } else {
                        document.getElementById('ref-code').innerText = userData.referralCode;
                    }
                }
            } catch (e) { console.error('Error loading profile:', e); }
        }

        // --- Wilaya List ---
        const WILAYAS = [
            "Ø£Ø¯Ø±Ø§Ø±", "Ø§Ù„Ø´Ù„Ù", "Ø§Ù„Ø£ØºÙˆØ§Ø·", "Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ", "Ø¨Ø§ØªÙ†Ø©", "Ø¨Ø¬Ø§ÙŠØ©", "Ø¨Ø³ÙƒØ±Ø©", "Ø¨Ø´Ø§Ø±", "Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©", "Ø§Ù„Ø¨ÙˆÙŠØ±Ø©", "ØªÙ…Ù†Ø±Ø§Ø³Øª", "ØªØ¨Ø³Ø©", "ØªÙ„Ù…Ø³Ø§Ù†", "ØªÙŠØ§Ø±Øª", "ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ", "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±", "Ø§Ù„Ø¬Ù„ÙØ©", "Ø¬ÙŠØ¬Ù„", "Ø³Ø·ÙŠÙ", "Ø³Ø¹ÙŠØ¯Ø©", "Ø³ÙƒÙŠÙƒØ¯Ø©", "Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³", "Ø¹Ù†Ø§Ø¨Ø©", "Ù‚Ø§Ù„Ù…Ø©", "Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©", "Ø§Ù„Ù…Ø¯ÙŠØ©", "Ù…Ø³ØªØºØ§Ù†Ù…", "Ø§Ù„Ù…Ø³ÙŠÙ„Ø©", "Ù…Ø¹Ø³ÙƒØ±", "ÙˆØ±Ù‚Ù„Ø©", "ÙˆÙ‡Ø±Ø§Ù†", "Ø§Ù„Ø¨ÙŠØ¶", "Ø¥Ù„ÙŠØ²ÙŠ", "Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬", "Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³", "Ø§Ù„Ø·Ø§Ø±Ù‚", "ØªÙ†Ø¯ÙˆÙ", "ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª", "Ø§Ù„ÙˆØ§Ø¯ÙŠ", "Ø®Ù†Ø´Ù„Ø©", "Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³", "ØªÙŠØ¨Ø§Ø²Ø©", "Ù…ÙŠÙ„Ø©", "Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰", "Ø§Ù„Ù†Ø¹Ø§Ù…Ø©", "Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª", "ØºØ±Ø¯Ø§ÙŠØ©", "ØºÙ„ÙŠØ²Ø§Ù†", "ØªÙŠÙ…ÙŠÙ…ÙˆÙ†", "Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±", "Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„", "Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³", "Ø¹ÙŠÙ† ØµØ§Ù„Ø­", "Ø¹ÙŠÙ† Ù‚Ø²Ø§Ù…", "ØªÙ‚Ø±Øª", "Ø¬Ø§Ù†ÙˆØª", "Ø§Ù„Ù…ØºÙŠØ±", "Ø§Ù„Ù…Ù†ÙŠØ¹Ø©"
        ];

        const wSelect = document.getElementById('edit-wilaya');
        if (wSelect) {
            // Clear existing options to prevent duplicates if any
            wSelect.innerHTML = '<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</option>';
            WILAYAS.forEach((w, i) => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.textContent = `${i + 1} - ${w}`;
                wSelect.appendChild(opt);
            });
        }

        function renderProfile(data) {
            document.getElementById('user-name').innerText = data.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…';
            document.getElementById('user-email').innerText = data.email;

            document.getElementById('coins-val').innerText = (data.dawarat_coins || 0);

            // Badge
            const badge = document.getElementById('user-role-badge');
            if (data.role === 'vendor') {
                badge.innerText = 'ØªØ§Ø¬Ø±';
                badge.className = 'bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold';
            } else if (data.role === 'restaurant') {
                badge.innerText = 'Ù…Ø·Ø¹Ù…';
                badge.className = 'bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-bold';
            } else {
                badge.innerText = 'Ø¹Ø¶Ùˆ';
                badge.className = 'bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold';
            }

            // Edit Inputs
            document.getElementById('edit-name').value = data.displayName || '';
            document.getElementById('edit-phone').value = data.phone || '';
            if (data.wilaya) document.getElementById('edit-wilaya').value = data.wilaya;
        }

        function checkStoreStatus(data) {
            const dashboardBtn = document.getElementById('dashboard-btn');
            const shareContainer = document.getElementById('store-share-container');
            const startBanner = document.getElementById('start-selling-banner');
            const pendingBanner = document.getElementById('pending-banner');
            const rejectedBanner = document.getElementById('rejected-banner');

            dashboardBtn.classList.add('hidden');
            shareContainer.classList.add('hidden');
            startBanner.classList.add('hidden');
            pendingBanner.classList.add('hidden');
            rejectedBanner.classList.add('hidden');

            if (data.role === 'vendor' || data.role === 'restaurant') {
                dashboardBtn.classList.remove('hidden');
                shareContainer.classList.remove('hidden');
            } else if (data.storeRequest?.status === 'pending') {
                pendingBanner.classList.remove('hidden');
            } else if (data.storeRequest?.status === 'rejected') {
                rejectedBanner.classList.remove('hidden');
                document.getElementById('reject-reason').innerText = data.storeRequest.rejectionReason || 'Ù„Ù… ÙŠØªÙ… Ø°ÙƒØ± Ø³Ø¨Ø¨.';
            } else {
                startBanner.classList.remove('hidden');
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('action') === 'open_store') {
                    openStoreModal();
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }

        // --- Utils ---
        window.copyRef = () => {
            const code = document.getElementById('ref-code').innerText;
            navigator.clipboard.writeText(code);
            showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯!');
        };

        window.getStoreLink = () => {
            if (!userData) return '';
            const type = userData.role === 'restaurant' ? 'restaurant' : 'vendor';
            return `${window.location.origin}/S22MARKET/vendor.html?id=${currentUser.uid}&type=${type}`;
        };

        window.copyStoreLink = async () => {
            const link = getStoreLink();
            if (link) {
                try {
                    await navigator.clipboard.writeText(link);
                    showToast('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØ¬Ø±!');
                } catch (e) {
                    const t = document.createElement("textarea"); t.value = link; document.body.appendChild(t); t.select(); document.execCommand("copy"); document.body.removeChild(t);
                    showToast('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØ¬Ø±!');
                }
            }
        };

        window.shareStoreLink = async () => {
            const link = getStoreLink();
            if (!link) return;
            try {
                await navigator.share({ title: userData.displayName, text: 'Ø²ÙˆØ±ÙˆØ§ Ù…ØªØ¬Ø±ÙŠ Ø¹Ù„Ù‰ S22 Market', url: link });
            } catch (e) { copyStoreLink(); }
        };

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg text-sm mb-2 animate-bounce';
            el.innerText = msg;
            container.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        // --- Store Request Form Logic ---

        let pendingStoreRequestData = null;

        // Toggle Wilaya Input
        window.toggleWilayaInput = () => {
            const type = document.getElementById('req-region-type').value;
            const container = document.getElementById('wilaya-input-container');
            if (type === 'local') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        };

        // Terms Check
        const termsCheck = document.getElementById('terms-agree-check');
        const confirmTermsBtn = document.getElementById('confirm-terms-btn');
        if (termsCheck) {
            termsCheck.addEventListener('change', (e) => {
                confirmTermsBtn.disabled = !e.target.checked;
                if (e.target.checked) confirmTermsBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                else confirmTermsBtn.classList.add('opacity-50', 'cursor-not-allowed');
            });
        }

        // Submit Store Request
        const storeForm = document.getElementById('store-form');
        if (storeForm) {
            storeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('submit-req-btn');

                // Collect Data
                const regionType = document.getElementById('req-region-type').value;
                const regionSpecific = document.getElementById('req-region-specific').value;
                const regionText = regionType === 'national' ? 'ÙƒØ§Ù…Ù„ Ø§Ù„ØªØ±Ø§Ø¨ Ø§Ù„ÙˆØ·Ù†ÙŠ' : (regionSpecific || 'Ù…Ù†Ø·Ù‚Ø© Ù…Ø­Ø¯Ø¯Ø©');

                pendingStoreRequestData = {
                    applicantName: document.getElementById('req-applicant-name').value,
                    storeName: document.getElementById('req-name').value,
                    storeType: document.getElementById('req-type').value,
                    specialty: document.getElementById('req-specialty').value,
                    description: document.getElementById('req-desc').value,
                    phone: document.getElementById('req-phone').value,
                    region: regionText,
                    facebook: document.getElementById('req-fb').value,
                    instagram: document.getElementById('req-insta').value,
                    additionalInfo: document.getElementById('req-extra').value,
                    status: 'pending',
                    requestedAt: serverTimestamp()
                };

                btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';

                try {
                    const settingsSnap = await getDoc(doc(db, "settings", "storeConfig"));
                    let termsText = "Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.";
                    if (settingsSnap.exists() && settingsSnap.data().termsAndConditions) {
                        termsText = settingsSnap.data().termsAndConditions;
                    }
                    document.getElementById('terms-content').innerText = termsText;
                    document.getElementById('terms-modal').classList.add('active');
                } catch (error) {
                    console.error("Error fetching terms:", error);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø±ÙˆØ·.");
                } finally {
                    btn.disabled = false; btn.innerText = 'Ù…ØªØ§Ø¨Ø¹Ø©';
                }
            });
        }

        // Confirm Terms
        if (confirmTermsBtn) {
            confirmTermsBtn.addEventListener('click', async () => {
                if (!pendingStoreRequestData) return;
                confirmTermsBtn.disabled = true; confirmTermsBtn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

                try {
                    await updateDoc(doc(db, "users", currentUser.uid), {
                        storeRequest: pendingStoreRequestData,
                        phone: pendingStoreRequestData.phone
                    });

                    closeModal('terms-modal');
                    closeModal('store-modal');

                    userData.storeRequest = pendingStoreRequestData;
                    checkStoreStatus(userData);

                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!');
                } catch (err) {
                    console.error(err);
                    alert('Ø®Ø·Ø£: ' + err.message);
                } finally {
                    confirmTermsBtn.disabled = false; confirmTermsBtn.innerText = 'Ù…ÙˆØ§ÙÙ‚ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨';
                }
            });
        }

        // Edit Profile
        const profileEditForm = document.getElementById('profile-edit-form');
        if (profileEditForm) {
            profileEditForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('edit-name').value;
                const phone = document.getElementById('edit-phone').value;
                const wilaya = document.getElementById('edit-wilaya').value;

                try {
                    await updateProfile(currentUser, { displayName: name });
                    await updateDoc(doc(db, "users", currentUser.uid), {
                        displayName: name,
                        phone: phone,
                        wilaya: wilaya
                    });

                    document.getElementById('user-name').innerText = name;
                    closeModal('edit-profile-modal');
                    showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª');
                } catch (e) { console.error(e); }
            });
        }

        // --- Credential Generation ---
        const credentialForm = document.getElementById('credential-form');
        if (credentialForm) {
            credentialForm.onsubmit = async (e) => {
                e.preventDefault();
                const btn = document.getElementById('gen-card-btn');
                const password = document.getElementById('confirm-pass').value;
                btn.disabled = true; btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';

                try {
                    const credential = await signInWithEmailAndPassword(auth, currentUser.email, password);
                    if (credential.user) {
                        if (window.generateCredentialCard) {
                            const imgData = window.generateCredentialCard(
                                userData.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…',
                                currentUser.email,
                                password
                            );
                            credentialForm.classList.add('hidden');
                            const preview = document.getElementById('card-preview-container');
                            preview.classList.remove('hidden'); preview.style.display = 'flex';
                            document.getElementById('download-card-link').href = imgData;
                        } else { alert("Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©"); }
                    }
                } catch (e) { alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!'); }
                finally { btn.disabled = false; btn.innerText = 'ØªÙˆÙ„ÙŠØ¯'; }
            };
        }

        // --- Modal Helpers ---
        window.openStoreModal = () => {
            const modal = document.getElementById('store-modal');
            modal.classList.add('active');
            if (userData.phone) document.getElementById('req-phone').value = userData.phone;
        };

        window.openEditProfileModal = () => document.getElementById('edit-profile-modal').classList.add('active');
        window.openCredentialModal = () => {
            const modal = document.getElementById('credential-modal');
            modal.classList.add('active');
            document.getElementById('credential-form').reset();
            document.getElementById('card-preview-container').classList.add('hidden');
            document.getElementById('credential-form').classList.remove('hidden');
        };
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');

        // Canvas Generator (Helper)
        window.generateCredentialCard = (name, email, password) => {
            const canvas = document.getElementById('cred-canvas');
            if (!canvas) return null;
            const ctx = canvas.getContext('2d');
            canvas.width = 1080; canvas.height = 1920;

            const grd = ctx.createLinearGradient(0, 0, 0, canvas.height);
            grd.addColorStop(0, '#4f46e5'); grd.addColorStop(1, '#7c3aed');
            ctx.fillStyle = grd; ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Simple pattern
            ctx.globalAlpha = 0.05;
            for (let i = 0; i < canvas.width; i += 40) {
                for (let j = 0; j < canvas.height; j += 40) {
                    ctx.beginPath(); ctx.arc(i, j, 2, 0, Math.PI * 2); ctx.fillStyle = 'white'; ctx.fill();
                }
            }
            ctx.globalAlpha = 1.0;

            // Content
            const cardX = 100, cardY = 500, cardW = 880, cardH = 920;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.shadowColor = 'rgba(0, 0, 0, 0.2)'; ctx.shadowBlur = 40; ctx.shadowOffsetY = 20;
            ctx.roundRect(cardX, cardY, cardW, cardH, 40); ctx.fill();

            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)'; ctx.lineWidth = 4; ctx.stroke();

            ctx.textAlign = 'center'; ctx.fillStyle = 'white';
            ctx.font = 'bold 80px Tajawal'; ctx.fillText('S22 MARKET', canvas.width / 2, cardY + 150);
            ctx.font = '50px Tajawal'; ctx.globalAlpha = 0.8; ctx.fillText('Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ', canvas.width / 2, cardY + 230); ctx.globalAlpha = 1.0;

            const startY = cardY + 400; const gap = 180;
            const drawField = (label, value, y) => {
                ctx.fillStyle = 'rgba(255,255,255,0.6)'; ctx.font = '40px Tajawal'; ctx.fillText(label, canvas.width / 2, y);
                ctx.fillStyle = 'white'; ctx.font = 'bold 60px Tajawal'; ctx.fillText(value, canvas.width / 2, y + 70);
            };
            drawField('Ø§Ù„Ø§Ø³Ù…', name, startY);
            drawField('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', email, startY + gap);
            drawField('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', password, startY + (gap * 2));

            ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.font = '30px Tajawal';
            ctx.fillText('s22market.com', canvas.width / 2, canvas.height - 100);

            return canvas.toDataURL('image/png');
        };
    </script>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </a>
        <a href="s22marketfood.html" class="nav-item">
            <i class="fas fa-utensils"></i>
            <span>Ø·Ø¹Ø§Ù…</span>
        </a>
        <a href="cart.html" class="nav-item">
            <div class="relative">
                <i class="fas fa-shopping-basket"></i>
                <span id="cart-badge"
                    class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 text-xs flex items-center justify-center hidden">0</span>
            </div>
            <span>Ø§Ù„Ø³Ù„Ø©</span>
        </a>
        <div class="nav-item active">
            <i class="fas fa-user mb-1 text-lg"></i>
            <span>Ø­Ø³Ø§Ø¨ÙŠ</span>
        </div>
    </nav>
</body>

</html>