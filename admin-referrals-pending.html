<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§Ù„Ø¯Ø¹ÙˆØ§Øª (Ø§Ù„Ù…ØªØ¬Ø±)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f0f2f5;
        }

        .hidden {
            display: none;
        }

        .dashboard-tab:hover {
            background-color: #4338ca;
        }

        .dashboard-tab.active-tab {
            background-color: #4f46e5;
            color: white;
            font-weight: bold;
        }

        .dashboard-panel {
            animation: fadeIn 0.5s;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        .spinner-dark {
            width: 24px;
            height: 24px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top-color: #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .fa-spinner {
            animation: spin 1s linear infinite;
        }

        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }

        .toast {
            background-color: #2f855a;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInUp 0.3s ease, fadeOut 0.5s ease 2.5s forwards;
        }

        .toast.error {
            background-color: #c53030;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Skeleton & Animation */
        .skeleton {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 6px;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .fade-in-up {
            opacity: 0;
            animation: fadeInUp 0.4s ease-out forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to: {
                opacity: 0;
            }
        }
    </style>
</head>

<body>

    <div id="login-page" class="hidden min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-xl space-y-6">
            <h2 class="text-3xl font-extrabold text-center text-gray-900">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <p class="text-center text-red-500">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ <a href="dashboard.html"
                    class="font-bold underline">ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>.</p>
        </div>
    </div>

    <div id="dashboard-page" class="hidden">
        <div class="relative min-h-screen md:flex">

            <aside id="sidebar"
                class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 right-0 transform translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30">
                <div class="p-3 text-center border-b border-gray-700">
                    <h2 class="text-2xl font-bold">S22 Market</h2>
                    <p id="admin-welcome-name" class="text-sm text-indigo-300"></p>
                </div>
                <nav class="flex-1 p-2 space-y-2">
                    <a href="dashboard.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-chart-line fa-fw mr-3"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
                    <a href="admin-sellers.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-users-cog fa-fw mr-3"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹ÙŠÙ†</a>
                    <a href="admin-reports.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-flag fa-fw mr-3 text-red-400"></i> Ø§Ù„Ø¥Ø¨Ù„Ø§ØºØ§Øª</a>
                    <a href="admin-products.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-boxes fa-fw mr-3"></i> Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
                    <a href="admin-offers.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-star fa-fw mr-3"></i> Ø§Ù„Ø¹Ø±ÙˆØ¶</a>
                    <a href="admin-product-requests.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-user-plus fa-fw mr-3"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²ÙˆØ§Ø±</a>
                    <a href="admin-categories.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-sitemap fa-fw mr-3"></i> Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</a>
                    <a href="admin-orders.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-clipboard-list fa-fw mr-3"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
                    <a href="admin-coupons.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-tags fa-fw mr-3"></i> Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª</a>
                    <a href="admin-inquiries.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-envelope-open-text fa-fw mr-3"></i> Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</a>
                    <a href="admin-applications.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fab fa-google-play fa-fw mr-3"></i> Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</a>
                    <a href="admin-notepad.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-book fa-fw mr-3"></i> Ø§Ù„Ù…ÙÙƒØ±Ø©</a>

                    <hr class="border-gray-700 my-2">
                    <h6 class="px-4 text-xs font-semibold text-gray-400 uppercase">Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆÙ„Ø§Ø¡ (Ø§Ù„Ù…ØªØ¬Ø±)</h6>
                    <a href="admin-loyalty-settings.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-gem fa-fw mr-3 text-yellow-400"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù‡Ø± ğŸ’</a>
                    <a href="admin-loyalty-approvals.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-check-to-slot fa-fw mr-3 text-green-400"></i> Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù…</a>
                    <a href="admin-referrals-pending.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-check-double fa-fw mr-3 text-blue-400"></i> Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</a>
                    <hr class="border-gray-700 my-2">

                    <a href="admin-settings.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"><i
                            class="fas fa-cogs fa-fw mr-3"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±</a>

                    <hr class="border-gray-700 my-2">
                    <h6 class="px-4 text-xs font-semibold text-gray-400 uppercase">Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©</h6>
                    <a href="dawarat_admin_manager.html"
                        class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-indigo-700"
                        target="_blank">
                        <i class="fas fa-graduation-cap fa-fw mr-3 text-gray-400"></i>
                        <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø°Ù„ÙˆØ±Ø§Øª</span>
                        <i class="fas fa-external-link-alt fa-xs ml-auto"></i>
                    </a>

                </nav>
                <div class="p-4 border-t border-gray-700">
                    <button id="logout-btn"
                        class="w-full bg-red-600 py-2 rounded-md hover:bg-red-700 transition-colors"><i
                            class="fas fa-sign-out-alt mr-2"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                </div>
            </aside>
            <main class="flex-1 p-4 md:p-8 overflow-y-auto">

                <div id="main-loader" class="text-center p-12">
                    <div class="loader mx-auto"></div>
                    <p class="mt-4 text-gray-600">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª...</p>
                </div>

                <div id="main-content" class="hidden dashboard-panel">
                    <div class="mb-8">
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">Ù…ÙƒØ§ÙØ¢Øª Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© (Ù„Ù„Ù…ØªØ¬Ø±)</h1>
                        <p class="text-gray-600 mb-4">Ù‡Ø¤Ù„Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø³Ø¬Ù„ÙˆØ§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø¯Ø¹ÙˆØ© ÙˆÙ„Ù… ØªØªÙ… Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¯Ø§Ø¹ÙŠ Ø¨Ø¹Ø¯.
                            Ø§Ø¶ØºØ· "Ø§Ø¹ØªÙ…Ø§Ø¯" Ù„Ø¥Ø±Ø³Ø§Ù„ "Ø§Ù„Ø¬ÙˆØ§Ù‡Ø± ğŸ’".</p>

                        <div class="overflow-x-auto bg-white rounded-xl shadow-md">
                            <table class="w-full text-right">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-3">Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¨)</th>
                                        <th class="p-3">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ (Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©)</th>
                                        <th class="p-3">Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                        <th class="p-3">Ø§Ù„Ø¯Ø§Ø¹ÙŠ (Ø£)</th>
                                        <th class="p-3">Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ù…Ù‚Ø±Ø±Ø©</th>
                                        <th class="p-3">Ø§Ø¹ØªÙ…Ø§Ø¯</th>
                                    </tr>
                                </thead>
                                <tbody id="pending-referrals-tbody">
                                </tbody>
                            </table>
                        </div>
                        <p id="no-pending-msg"
                            class="hidden text-center p-8 bg-white rounded-xl shadow-md text-gray-500 font-semibold">
                            <i class="fas fa-check-circle text-green-500 text-3xl mb-3"></i><br>
                            Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙŠ Ù…ÙƒØ§ÙØ¢Øª Ù…Ø¹Ù„Ù‚Ø©. Ø£Ù†Øª Ù…ÙØ·Ù„Ø¹ Ø¹Ù„Ù‰ ÙƒÙ„ Ø´ÙŠØ¡!
                        </p>
                    </div>

                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-trophy text-yellow-500"></i> Ù„ÙˆØ­Ø© ØµØ¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª
                        </h1>
                        <p class="text-gray-600 mb-4">Ø£ÙƒØ«Ø± Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù†Ø¬Ø§Ø­Ø§Ù‹ ÙÙŠ Ø¯Ø¹ÙˆØ© Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¬Ø¯Ø¯ (ÙÙ‚Ø· Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„ØªÙŠ ØªÙ…
                            Ø§Ø¹ØªÙ…Ø§Ø¯Ù‡Ø§).</p>

                        <div class="overflow-x-auto bg-white rounded-xl shadow-md">
                            <table class="w-full text-right">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-3">#</th>
                                        <th class="p-3">Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ø¹ÙŠ</th>
                                        <th class="p-3">Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡</th>
                                        <th class="p-3">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ù†Ø§Ø¬Ø­Ø©</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboard-tbody">
                                </tbody>
                            </table>
                        </div>
                        <p id="no-leaderboard-msg"
                            class="hidden text-center p-8 bg-white rounded-xl shadow-md text-gray-500 font-semibold">
                            Ù„Ù… ÙŠØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø£ÙŠ Ø¯Ø¹ÙˆØ§Øª Ù†Ø§Ø¬Ø­Ø© Ø¨Ø¹Ø¯.
                        </p>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, serverTimestamp, orderBy, getDoc, setDoc, getDocs, where, Timestamp, increment, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const ADMIN_EMAILS = [
            's22market@gmail.com',
            'yacinee474474@gmail.com',
            'nourmt01@gmail.com'
        ];

        // --- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const logoutBtn = document.getElementById('logout-btn');
        const getEl = (id) => document.getElementById(id);

        const mainLoader = getEl('main-loader');
        const mainContent = getEl('main-content');
        const pendingTbody = getEl('pending-referrals-tbody');
        const noPendingMsg = getEl('no-pending-msg');
        const leaderboardTbody = getEl('leaderboard-tbody');
        const noLeaderboardMsg = getEl('no-leaderboard-msg');

        // --- Ù…Ø®Ø²Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
        let allUsersCache = [];
        let usersByCodeMap = new Map();
        let usersByIdMap = new Map();
        // (*** ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø± ***)
        let loyaltySettings = {};

        // --- (Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©: showToast) ---
        const showToast = (message, type = 'success') => {
            const container = getEl('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'error' : ''}`;
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
            toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };
        // --- (Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©) ---

        // --- (Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„ØªÙ†Ù‚Ù„) ---
        function checkAdminPermissions(user) {
            if (user && ADMIN_EMAILS.includes(user.email)) {
                loginPage.classList.add('hidden');
                dashboardPage.classList.remove('hidden');
                getEl('admin-welcome-name').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${user.displayName || user.email.split('@')[0]}`;
                initializeDashboard();
            } else {
                dashboardPage.classList.add('hidden');
                loginPage.classList.remove('hidden');
                if (user) signOut(auth);
            }
        }
        onAuthStateChanged(auth, user => { checkAdminPermissions(user); });
        logoutBtn.addEventListener('click', async () => { await signOut(auth); });

        function setActiveTab() {
            const currentPage = window.location.pathname.split('/').pop();
            const tabs = document.querySelectorAll('.dashboard-tab');
            tabs.forEach(tab => {
                const tabHref = tab.getAttribute('href').split('/').pop();
                if (tabHref === currentPage) {
                    tab.classList.add('active-tab');
                } else {
                    tab.classList.remove('active-tab');
                }
            });
        }

        // --- (Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) ---
        function initializeDashboard() {
            setActiveTab();
            loadInitialData(); // <-- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        }

        // --- (*** Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© - Ù…Ø¹Ø¯Ù„ ***) ---

        // 1. Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ + Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±)
        async function loadInitialData() {
            // Skeleton during load
            const mainLoader = getEl('main-loader');
            const mainContent = getEl('main-content');

            mainLoader.classList.add('hidden'); // We use our own skeletons inside the table
            mainContent.classList.remove('hidden');

            getEl('pending-referrals-tbody').innerHTML = Array(5).fill(0).map(() => `
            <tr class="border-b animate-pulse">
                <td class="p-3"><div class="skeleton w-32 h-6"></div></td>
                <td class="p-3 space-y-2"><div class="skeleton w-48 h-4"></div><div class="skeleton w-40 h-4"></div></td>
                <td class="p-3"><div class="skeleton w-24 h-6"></div></td>
                <td class="p-3"><div class="skeleton w-28 h-6"></div></td>
                <td class="p-3"><div class="skeleton w-20 h-6"></div></td>
                <td class="p-3"><div class="skeleton w-24 h-10 rounded-lg"></div></td>
            </tr>
        `).join('');

            try {
                // (*** ØªØ¹Ø¯ÙŠÙ„: Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø± ***)
                const [usersSnapshot, settingsSnap] = await Promise.all([
                    getDocs(collection(db, "users")),
                    getDoc(doc(db, "settings", "loyalty"))
                ]);

                if (settingsSnap.exists()) {
                    loyaltySettings = settingsSnap.data();
                } else {
                    showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆÙØ§Ø¡. Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… 50 ÙƒØ¬ÙˆÙ‡Ø±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©.', 'error');
                }

                allUsersCache = usersSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                usersByCodeMap.clear();
                usersByIdMap.clear();
                allUsersCache.forEach(user => {
                    usersByIdMap.set(user.id, user);
                    if (user.referralCode) {
                        usersByCodeMap.set(user.referralCode, user);
                    }
                });

                renderPendingReferrals();
                renderLeaderboard();

                mainLoader.classList.add('hidden');
                mainContent.classList.remove('hidden');

            } catch (error) {
                console.error("Error loading data: ", error);
                mainLoader.innerHTML = `<p class="text-red-500">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}</p>`;
            }
        }

        // 2. Ø±Ø³Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙƒØ§ÙØ¢t Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
        function renderPendingReferrals() {
            pendingTbody.innerHTML = '';
            // (*** ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ù…ØªØ¬Ø± ***)
            const bonusAmount = loyaltySettings.referralBonusPoints || 50;

            const pendingUsers = allUsersCache.filter(user =>
                user.referredBy && (user.referralProcessed === false || user.referralProcessed === undefined)
            );

            if (pendingUsers.length === 0) {
                noPendingMsg.classList.remove('hidden');
            } else {
                noPendingMsg.classList.add('hidden');
            }

            pendingUsers.forEach((newUser, index) => {
                const referrerCodeOrId = newUser.referredBy; // (Ù‚Ø¯ ÙŠÙƒÙˆÙ† ÙƒÙˆØ¯ Ø£Ùˆ ID)

                // (*** Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø®Ù„Ù„: Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø¨Ø§Ù„Ù€ ID ***)
                let referrer = usersByCodeMap.get(referrerCodeOrId); // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯
                if (!referrer) {
                    referrer = usersByIdMap.get(referrerCodeOrId); // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù€ ID (Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
                }

                let referrerName = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                let referrerId = null;
                if (referrer) {
                    referrerName = referrer.displayName;
                    referrerId = referrer.id;
                } else {
                    referrerName = `<span class="text-red-500">ÙƒÙˆØ¯/ID ØºÙŠØ± ØµØ§Ù„Ø­: ${referrerCodeOrId}</span>`;
                }

                const newUserPhone = newUser.phone || '<span class="text-red-500 font-bold">Ù„Ù… ÙŠÙØ¯Ø®Ù„</span>';
                const newUserEmail = newUser.email || '<span class="text-red-500 font-bold">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>';

                const row = document.createElement('tr');
                row.className = 'border-b fade-in-up';
                row.style.animationDelay = `${index * 0.05}s`;
                row.id = `pending-row-${newUser.id}`;
                row.innerHTML = `
                <td class="p-3 font-semibold">${newUser.displayName}</td>
                <td class="p-3" style="min-width: 220px;">
                    <div class="text-sm" dir="ltr" style="text-align: right;"><strong>Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„:</strong> ${newUserEmail}</div>
                    <div class="text-sm" dir="ltr" style="text-align: right;"><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${newUserPhone}</div>
                </td>
                <td class="p-3 font-mono">${newUser.referredBy}</td> 
                <td class="p-3 font-semibold">${referrerName}</td>
                <td class="p-3 font-bold text-green-600">${bonusAmount} Ø¬ÙˆÙ‡Ø±Ø© ğŸ’</td>
                <td class="p-3">
                    <button class="approve-btn bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 disabled:bg-gray-400" 
                            data-new-user-id="${newUser.id}" 
                            data-new-user-name="${newUser.displayName}" 
                            data-referrer-id="${referrerId}"
                            data-bonus-amount="${bonusAmount}"
                            ${!referrerId ? 'disabled title="Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©ØŒ Ø§Ù„Ø¯Ø§Ø¹ÙŠ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"' : `title="Ù…ÙƒØ§ÙØ£Ø© ${referrerName}"`}>
                        <i class="fas fa-check"></i> Ø§Ø¹ØªÙ…Ø§Ø¯
                    </button>
                </td>
            `;
                pendingTbody.appendChild(row);
            });
        }

        // 3. Ø±Ø³Ù… Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø© (Leaderboard)
        function renderLeaderboard() {
            leaderboardTbody.innerHTML = '';

            const referralCounts = new Map();

            const processedUsers = allUsersCache.filter(user => user.referredBy && user.referralProcessed === true);

            processedUsers.forEach(user => {
                // (*** Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø®Ù„Ù„: Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ù€ ID ***)
                const referrerCodeOrId = user.referredBy;
                let referrer = usersByCodeMap.get(referrerCodeOrId);
                if (!referrer) {
                    referrer = usersByIdMap.get(referrerCodeOrId);
                }

                if (referrer) {
                    const count = (referralCounts.get(referrer.id) || 0) + 1;
                    referralCounts.set(referrer.id, count);
                }
            });

            if (referralCounts.size === 0) {
                noLeaderboardMsg.classList.remove('hidden');
                return;
            } else {
                noLeaderboardMsg.classList.add('hidden');
            }

            const sortedLeaderboard = Array.from(referralCounts.entries()).sort((a, b) => b[1] - a[1]);

            sortedLeaderboard.slice(0, 10).forEach(([referrerId, count], index) => {
                const referrer = usersByIdMap.get(referrerId);
                const referrerName = referrer ? referrer.displayName : 'Ø¹Ø¶Ùˆ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                const referrerCode = referrer ? referrer.referralCode : '---';

                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                <td class="p-3 font-bold text-lg ${index === 0 ? 'text-yellow-500' : (index === 1 ? 'text-gray-500' : (index === 2 ? 'text-orange-700' : ''))}">
                    ${index === 0 ? '<i class="fas fa-trophy"></i>' : (index + 1)}
                </td>
                <td class="p-3 font-semibold">${referrerName}</td>
                <td class="p-3 font-mono">${referrerCode}</td>
                <td class="p-3 font-bold text-xl">${count}</td>
            `;
                leaderboardTbody.appendChild(row);
            });
        }

        // 4. Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©
        async function handleApproveReferral(e) {
            const btn = e.target.closest('.approve-btn');
            if (!btn) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';

            const { newUserId, newUserName, referrerId, bonusAmount } = btn.dataset;
            const bonus = parseInt(bonusAmount, 10);

            if (!referrerId || referrerId === "null") {
                showToast('Ø®Ø·Ø£: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù‘Ù Ù„Ù„Ø¯Ø§Ø¹ÙŠ.', 'error');
                btn.innerHTML = 'Ø®Ø·Ø£';
                return;
            }

            try {
                const batch = writeBatch(db);

                // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„ "Ø§Ù„Ø¬Ø¯ÙŠØ¯" (Ø¨)
                const newUserDocRef = doc(db, "users", newUserId);
                batch.update(newUserDocRef, { referralProcessed: true });

                // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„ "Ø§Ù„Ù‚Ø¯ÙŠÙ…" (Ø£)
                const referrerDocRef = doc(db, "users", referrerId);

                // (*** ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¶Ø§ÙØ© "Ø¬ÙˆØ§Ù‡Ø±" Ø§Ù„Ù…ØªØ¬Ø± ***)
                batch.update(referrerDocRef, {
                    loyaltyPoints: increment(bonus)
                });

                // 3. Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ÙÙŠ "Ø³Ø¬Ù„ Ø§Ù„Ù†Ù‚Ø§Ø·" Ù„Ù„Ø¹Ù…ÙŠÙ„ "Ø£"
                const reason = `Ù…ÙƒØ§ÙØ£Ø© Ø¯Ø¹ÙˆØ©: ${newUserName}`;
                // (*** ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø³Ø¬Ù„ Ø§Ù„Ù…ØªØ¬Ø± ***)
                const logRef = doc(collection(db, `users/${referrerId}/loyaltyChanges`));
                batch.set(logRef, {
                    type: 'referral_bonus_market', // (Ù†ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ Ù„ØªÙ…ÙŠÙŠØ²Ù‡)
                    pointsAdded: bonus,
                    reason: reason,
                    timestamp: serverTimestamp(),
                    referredUserId: newUserId
                });

                // 4. Ø¥Ø¶Ø§ÙØ© "Ø¥Ø´Ø¹Ø§Ø±" Ù„Ù„Ø¹Ù…ÙŠÙ„ "Ø£"
                const notifRef = doc(collection(db, `users/${referrerId}/notifications`));
                batch.set(notifRef, {
                    title: "ğŸ Ù…ÙƒØ§ÙØ£Ø© Ø¯Ø¹ÙˆØ©!",
                    // (*** ØªØ¹Ø¯ÙŠÙ„: ØªØºÙŠÙŠØ± Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ "Ø¬ÙˆÙ‡Ø±Ø©" ***)
                    body: `Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ! Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ${bonus} Ø¬ÙˆÙ‡Ø±Ø© ğŸ’ ÙƒÙ…ÙƒØ§ÙØ£Ø© Ù„ØªØ³Ø¬ÙŠÙ„ ${newUserName} Ø¹Ø¨Ø± Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ.`,
                    isRead: false,
                    timestamp: serverTimestamp(),
                    type: "referral_bonus"
                });

                await batch.commit();

                showToast('ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬ÙˆØ§Ù‡Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'success');

                getEl(`pending-row-${newUserId}`).remove();

                const userInCache = usersByIdMap.get(newUserId);
                if (userInCache) userInCache.referralProcessed = true;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´
                const referrerInCache = usersByIdMap.get(referrerId);
                if (referrerInCache) referrerInCache.loyaltyPoints = (referrerInCache.loyaltyPoints || 0) + bonus;

                renderLeaderboard();

                if (pendingTbody.children.length === 0) {
                    noPendingMsg.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Error approving referral: ", error);
                showToast('ÙØ´Ù„ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©: ' + error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i> Ø§Ø¹ØªÙ…Ø§Ø¯';
            }
        }

        pendingTbody.addEventListener('click', handleApproveReferral);

    </script>

</body>

</html>