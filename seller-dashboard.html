<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - لوحة التاجر</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="app-style.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="theme-manager.js"></script>

    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f1f5f9;
        }

        .sidebar {
            transition: transform 0.3s ease;
            width: 260px;
            height: 100vh;
            position: fixed;
            right: 0;
            top: 0;
            background: #1e293b;
            color: white;
            z-index: 50;
        }

        .sidebar.closed {
            transform: translateX(100%);
        }

        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 40;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }

        th {
            text-align: right;
            padding: 12px 16px;
            background: #f8fafc;
            color: #64748b;
            font-size: 0.85rem;
            font-weight: 700;
        }

        td {
            padding: 12px 16px;
            border-top: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .status-new {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-preparing {
            background: #fef3c7;
            color: #92400e;
        }

        .status-completed {
            background: #dcfce7;
            color: #166534;
        }

        .status-canceled {
            background: #fee2e2;
            color: #991b1b;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #10b981;
        }

        input:checked+.slider:before {
            transform: translateX(24px);
        }

        @keyframes flyToCart {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.5);
                opacity: 0.8;
            }

            100% {
                transform: translate(var(--tx), var(--ty)) scale(0.1);
                opacity: 0;
            }
        }

        .cart-flyer {
            position: fixed;
            z-index: 9999;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            pointer-events: none;
            object-fit: cover;
            animation: flyToCart 0.8s ease-in-out forwards;
        }

        @keyframes flash-green {
            0% {
                background-color: rgba(16, 185, 129, 0.2);
            }

            100% {
                background-color: transparent;
            }
        }

        .new-order-row {
            animation: flash-green 2s infinite alternate;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: white;
            width: 95%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 16px;
            padding: 20px;
            transform: scale(0.95);
            transition: transform 0.3s;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 80%;
            }

            .content-area {
                margin-right: 0 !important;
            }
        }


        /* Custom Scrollbar for Sidebar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body>
    <audio id="order-sound" src="alerta.mp3" preload="auto"></audio>

    <header
        class="bg-white shadow-sm h-16 fixed top-0 w-full z-40 flex items-center justify-between px-4 lg:pr-[260px]">
        <div class="flex items-center gap-3">
            <button id="menu-btn" class="lg:hidden text-gray-600 text-xl"><i class="fas fa-bars"></i></button>
            <h1 class="font-bold text-lg text-gray-800">لوحة التاجر</h1>
        </div>
        <div class="flex items-center gap-4">

            <button id="enable-sound-btn" onclick="enableAudio()"
                class="hidden bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold hover:bg-indigo-200 transition animate-pulse">
                <i class="fas fa-volume-up"></i> تفعيل التنبيهات
            </button>
            <button id="wake-lock-btn" onclick="toggleWakeLock()"
                class="hidden sm:flex items-center gap-2 bg-slate-100 text-slate-500 px-3 py-1 rounded-full text-xs font-bold hover:bg-slate-200 transition"
                title="منع الشاشة من الانطفاء">
                <i class="fas fa-sun"></i> <span class="hidden md:inline">وضع النشاط</span>
            </button>
            <a href="restaurant-settings.html"
                class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold hover:bg-indigo-200 transition cursor-pointer"
                id="user-avatar" title="الملف الشخصي / الإعدادات">
                <i class="fas fa-user"></i>
            </a>
        </div>
    </header>

    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <aside class="sidebar flex flex-col bg-slate-900 text-white transition-all duration-300 z-50" id="sidebar">
        <div class="p-6 text-center border-b border-gray-800 relative overflow-hidden group">
            <button id="sidebar-close-btn"
                class="lg:hidden absolute top-4 left-4 text-gray-400 hover:text-white transition-colors z-30">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <div
                class="absolute inset-0 bg-gradient-to-r from-indigo-600 to-purple-600 opacity-0 group-hover:opacity-20 transition duration-500">
            </div>
            <h2 class="text-2xl font-black tracking-wider relative z-10">S22 <span
                    class="text-indigo-400">PARTNER</span></h2>
            <p class="text-xs text-gray-400 mt-2 font-medium bg-gray-800 py-1 px-3 rounded-full inline-block"
                id="shop-name">TEXMEX</p>

            <div class="flex justify-center gap-2 mt-3 z-20 relative">
                <button id="theme-toggle"
                    class="w-8 h-8 rounded-lg bg-gray-700 hover:bg-gray-600 text-gray-300 transition-colors flex items-center justify-center"
                    title="تبديل الوضع (نهاري/ليلي)">
                    <i class="fas fa-moon"></i>
                </button>
                <button id="eye-care-toggle"
                    class="w-8 h-8 rounded-lg bg-gray-700 hover:bg-gray-600 text-yellow-500 transition-colors flex items-center justify-center"
                    title="وضع حماية العين">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        </div>

        <nav class="flex-1 p-3 space-y-1 overflow-y-auto custom-scrollbar">
            <!-- نظرة عامة -->
            <a href="seller-dashboard.html"
                class="w-full flex items-center gap-3 px-4 py-3 bg-gray-800 text-white rounded-xl transition-all duration-200 nav-btn group shadow-inner">
                <div class="w-8 h-8 rounded-lg bg-indigo-600 text-white flex items-center justify-center">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <span class="font-medium">نظرة عامة</span>
            </a>

            <!-- الطلبات -->
            <a href="restaurant-orders.html"
                class="w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-xl transition-all duration-200 nav-btn group">
                <div
                    class="w-8 h-8 rounded-lg bg-gray-800 text-gray-400 group-hover:bg-indigo-600 group-hover:text-white flex items-center justify-center transition-colors">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <span class="font-medium">الطلبات</span>
            </a>

            <!-- شاشة المطبخ (للمطاعم فقط) - يمكن إخفاؤها لاحقاً لغير المطاعم -->
            <a href="store-orders-screen.html" target="_blank"
                class="w-full flex items-center gap-3 px-4 py-3 text-amber-500 hover:bg-gray-800 hover:text-amber-400 rounded-xl transition-all duration-200 nav-btn group border border-amber-500/10 bg-amber-500/5">
                <div
                    class="w-8 h-8 rounded-lg bg-amber-500/10 text-amber-500 group-hover:bg-amber-500 group-hover:text-amber-900 flex items-center justify-center transition-colors">
                    <i class="fas fa-desktop"></i>
                </div>
                <span class="font-bold">شاشة الطلبات/المطبخ</span>
            </a>

            <div class="my-2 border-t border-gray-800"></div>

            <!-- المنتجات/القائمة -->
            <a href="restaurant-menu.html"
                class="w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-xl transition-all duration-200 nav-btn group">
                <div
                    class="w-8 h-8 rounded-lg bg-gray-800 text-gray-400 group-hover:bg-indigo-600 group-hover:text-white flex items-center justify-center transition-colors">
                    <i class="fas fa-box-open"></i>
                </div>
                <span class="font-medium">المنتجات / القائمة</span>
            </a>

            <!-- الأقسام -->
            <a href="restaurant-sections.html"
                class="w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-xl transition-all duration-200 nav-btn group">
                <div
                    class="w-8 h-8 rounded-lg bg-gray-800 text-gray-400 group-hover:bg-indigo-600 group-hover:text-white flex items-center justify-center transition-colors">
                    <i class="fas fa-folder"></i>
                </div>
                <span class="font-medium">أقسام المتجر</span>
            </a>

            <div class="my-2 border-t border-gray-800"></div>

            <!-- العملاء -->
            <a href="restaurant-customers.html"
                class="w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-xl transition-all duration-200 nav-btn group">
                <div
                    class="w-8 h-8 rounded-lg bg-gray-800 text-gray-400 group-hover:bg-indigo-600 group-hover:text-white flex items-center justify-center transition-colors">
                    <i class="fas fa-users"></i>
                </div>
                <span class="font-medium">زبائني</span>
            </a>

            <!-- سجل العملاء -->
            <a href="restaurant-customer-log.html"
                class="w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-xl transition-all duration-200 nav-btn group">
                <div
                    class="w-8 h-8 rounded-lg bg-gray-800 text-gray-400 group-hover:bg-indigo-600 group-hover:text-white flex items-center justify-center transition-colors">
                    <i class="fas fa-address-book"></i>
                </div>
                <span class="font-medium">سجل الزوار</span>
            </a>

            <!-- الولاء والنقاط -->
            <a href="restaurant-loyalty.html"
                class="w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-xl transition-all duration-200 nav-btn group">
                <div
                    class="w-8 h-8 rounded-lg bg-gray-800 text-gray-400 group-hover:bg-indigo-600 group-hover:text-white flex items-center justify-center transition-colors">
                    <i class="fas fa-star"></i>
                </div>
                <span class="font-medium">الولاء والنقاط</span>
            </a>

            <div class="my-2 border-t border-gray-800"></div>

            <!-- الكوبونات -->
            <a href="restaurant-coupons.html"
                class="w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-xl transition-all duration-200 nav-btn group">
                <div
                    class="w-8 h-8 rounded-lg bg-gray-800 text-gray-400 group-hover:bg-indigo-600 group-hover:text-white flex items-center justify-center transition-colors">
                    <i class="fas fa-ticket-alt"></i>
                </div>
                <span class="font-medium">الكوبونات</span>
            </a>

            <!-- العروض -->
            <a href="restaurant-offers.html"
                class="w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-xl transition-all duration-200 nav-btn group">
                <div
                    class="w-8 h-8 rounded-lg bg-gray-800 text-gray-400 group-hover:bg-indigo-600 group-hover:text-white flex items-center justify-center transition-colors">
                    <i class="fas fa-percent"></i>
                </div>
                <span class="font-medium">العروض</span>
            </a>

            <!-- السائقين (يمكن إخفاؤه) -->
            <a href="restaurant-drivers.html"
                class="w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-xl transition-all duration-200 nav-btn group">
                <div
                    class="w-8 h-8 rounded-lg bg-gray-800 text-gray-400 group-hover:bg-indigo-600 group-hover:text-white flex items-center justify-center transition-colors">
                    <i class="fas fa-motorcycle"></i>
                </div>
                <span class="font-medium">السائقين</span>
            </a>

            <!-- التقييمات -->
            <a href="restaurant-reviews.html"
                class="w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-xl transition-all duration-200 nav-btn group">
                <div
                    class="w-8 h-8 rounded-lg bg-gray-800 text-gray-400 group-hover:bg-indigo-600 group-hover:text-white flex items-center justify-center transition-colors">
                    <i class="fas fa-comment-alt"></i>
                </div>
                <span class="font-medium">التقييمات</span>
            </a>

            <!-- الإحصائيات -->
            <a href="restaurant-stats.html"
                class="w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-xl transition-all duration-200 nav-btn group">
                <div
                    class="w-8 h-8 rounded-lg bg-gray-800 text-gray-400 group-hover:bg-indigo-600 group-hover:text-white flex items-center justify-center transition-colors">
                    <i class="fas fa-chart-line"></i>
                </div>
                <span class="font-medium">الإحصائيات</span>
            </a>

            <div class="my-2 border-t border-gray-800"></div>

            <!-- إعدادات الوفاء -->
            <a href="restaurant-fulfillment-settings.html"
                class="w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-xl transition-all duration-200 nav-btn group">
                <div
                    class="w-8 h-8 rounded-lg bg-gray-800 text-gray-400 group-hover:bg-indigo-600 group-hover:text-white flex items-center justify-center transition-colors">
                    <i class="fas fa-gift"></i>
                </div>
                <span class="font-medium">طرق الاستلام</span>
            </a>

            <!-- إعدادات التوصيل -->
            <a href="restaurant-delivery-settings.html"
                class="w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-xl transition-all duration-200 nav-btn group">
                <div
                    class="w-8 h-8 rounded-lg bg-gray-800 text-gray-400 group-hover:bg-indigo-600 group-hover:text-white flex items-center justify-center transition-colors">
                    <i class="fas fa-map-marked-alt"></i>
                </div>
                <span class="font-medium">إعدادات التوصيل</span>
            </a>

            <!-- الإعدادات -->
            <a href="restaurant-settings.html"
                class="w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-xl transition-all duration-200 nav-btn group">
                <div
                    class="w-8 h-8 rounded-lg bg-gray-800 text-gray-400 group-hover:bg-indigo-600 group-hover:text-white flex items-center justify-center transition-colors">
                    <i class="fas fa-cogs"></i>
                </div>
                <span class="font-medium">إعدادات المتجر</span>
            </a>

            <!-- Theme Switcher Container -->
            <div id="sidebar-theme-container"></div>
        </nav>

        <div class="p-4 border-t border-gray-800 bg-gray-900/50">
            <a href="index.html"
                class="flex items-center gap-2 text-gray-500 hover:text-white text-xs mb-3 transition-colors justify-center">
                <i class="fas fa-external-link-alt"></i> معاينة المتجر
            </a>
            <button id="logout-btn"
                class="w-full bg-gradient-to-r from-red-600 to-rose-600 hover:from-red-700 hover:to-rose-700 text-white py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-red-900/20 transition-all transform active:scale-95">
                <i class="fas fa-sign-out-alt md:hidden lg:inline mr-1"></i> تسجيل الخروج
            </button>
        </div>
    </aside>

    <main class="content-area pt-20 px-4 pb-8 lg:mr-[260px] transition-all">

        <section id="dashboard-section" class="space-y-6">
            <section id="dashboard-section" class="space-y-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-black text-gray-800">ملخص اليوم</h2>
                        <p class="text-sm text-gray-500" id="current-date-display">...</p>
                    </div>
                    <div class="hidden md:flex gap-2">
                        <button onclick="window.location.reload()"
                            class="bg-white p-2 rounded-lg text-gray-500 hover:text-indigo-600 shadow-sm border border-gray-200 transition"><i
                                class="fas fa-sync-alt"></i></button>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Share Store Card (Premium) -->
                    <div
                        class="stat-card bg-gradient-to-br from-indigo-600 to-purple-700 text-white border-none relative overflow-hidden group shadow-lg shadow-indigo-500/30">
                        <div class="relative z-10 p-1 w-full">
                            <div class="flex items-center gap-2 mb-2">
                                <div
                                    class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white font-bold backdrop-blur-sm">
                                    <i class="fas fa-store"></i>
                                </div>
                                <div>
                                    <p class="text-[10px] text-indigo-200 font-bold uppercase tracking-wider">متجرك</p>
                                    <h4 class="font-bold text-white text-sm" id="dashboard-store-name">...</h4>
                                </div>
                            </div>

                            <div class="bg-black/20 rounded-lg p-2 mb-3 backdrop-blur-sm border border-white/10">
                                <p class="text-xs text-indigo-100 mb-1">رابط المتجر:</p>
                                <h3 class="font-mono text-xs text-white truncate w-full dir-ltr select-all"
                                    id="store-link-display">...</h3>
                            </div>

                            <div class="flex gap-2">
                                <button onclick="window.copyStoreLink()"
                                    class="flex-1 bg-white text-indigo-600 px-3 py-2 rounded-lg text-xs font-bold hover:bg-indigo-50 transition-all flex items-center justify-center gap-2 shadow-sm">
                                    <i class="fas fa-copy"></i> <span>نسخ</span>
                                </button>
                                <button onclick="window.shareStoreNative()"
                                    class="flex-1 bg-indigo-500/50 backdrop-blur-sm border border-white/20 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-indigo-500 transition-all flex items-center justify-center gap-2">
                                    <i class="fas fa-share-alt"></i> <span>مشاركة</span>
                                </button>
                            </div>
                        </div>
                        <div
                            class="absolute -right-6 -bottom-6 text-white/10 text-9xl transform rotate-12 group-hover:scale-110 transition-transform duration-500">
                            <i class="fas fa-store"></i>
                        </div>
                    </div>

                    <!-- Subscription Card (Premium Enhanced) -->
                    <div class="stat-card bg-gradient-to-br from-indigo-900 to-blue-800 text-white border-none relative overflow-hidden group shadow-lg shadow-blue-900/20"
                        id="sub-card">
                        <div class="relative z-10 p-1">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-[10px] text-blue-200 font-bold uppercase tracking-wider mb-1">حالة
                                        الاشتراك</p>
                                    <h3 class="text-xl font-bold" id="sub-plan-name">Basi</h3>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"
                                            id="sub-status-dot"></span>
                                        <span class="text-xs font-bold text-blue-100" id="sub-status-text">نشط</span>
                                    </div>
                                </div>
                                <div
                                    class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center backdrop-blur-md border border-white/10">
                                    <i class="fas fa-crown text-yellow-400 text-lg"></i>
                                </div>
                            </div>

                            <!-- Dates & Progress -->
                            <div class="bg-black/20 rounded-lg p-3 backdrop-blur-sm border border-white/10">
                                <div class="flex justify-between text-xs text-blue-200 mb-2">
                                    <span>المتبقي</span>
                                    <span class="text-white font-bold" id="sub-days-remain">-- يوم</span>
                                </div>
                                <div class="w-full bg-white/10 rounded-full h-1.5 mb-2 overflow-hidden">
                                    <div class="bg-gradient-to-r from-green-400 to-emerald-400 h-full rounded-full transition-all duration-1000"
                                        id="sub-progress" style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between text-[10px] text-blue-300">
                                    <span id="sub-start-date">--/--</span>
                                    <span id="sub-end-date">--/--</span>
                                </div>
                            </div>
                        </div>

                        <!-- Decorative BG -->
                        <div class="absolute -right-4 -bottom-4 text-white/5 text-8xl transform rotate-12">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                    </div>

                    <!-- Sales Card -->
                    <div
                        class="stat-card bg-white p-5 rounded-2xl shadow-sm border border-gray-100 group hover:shadow-md transition-all duration-300">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-400 font-bold uppercase tracking-wider">المبيعات (اليوم)</p>
                                <h3 class="text-2xl font-black text-gray-800 mt-2" id="stats-daily-sales">0 د.ج</h3>
                                <div id="store-status-badge"
                                    class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 text-gray-500 text-[10px] font-bold mt-2">
                                    <span class="w-2 h-2 rounded-full bg-gray-400"></span>
                                    <span>جاري التحميل...</span>
                                </div>
                            </div>
                            <div
                                class="w-10 h-10 bg-emerald-50 rounded-xl flex items-center justify-center text-emerald-500 group-hover:scale-110 transition-transform">
                                <i class="fas fa-wallet text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Card -->
                    <div
                        class="stat-card bg-white p-5 rounded-2xl shadow-sm border border-gray-100 group hover:shadow-md transition-all duration-300">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-400 font-bold uppercase tracking-wider">الطلبات الجديدة</p>
                                <h3 class="text-2xl font-black text-gray-800 mt-2" id="stats-new-orders">0</h3>
                                <p class="text-[10px] text-gray-400 mt-1">بانتظار التأكيد</p>
                            </div>
                            <div
                                class="w-10 h-10 bg-amber-50 rounded-xl flex items-center justify-center text-amber-500 group-hover:scale-110 transition-transform relative">
                                <i class="fas fa-bell text-xl"></i>
                                <span
                                    class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white animate-pulse"
                                    id="stat-badge-dot" style="display:none"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Products Card -->
                    <div
                        class="stat-card bg-white p-5 rounded-2xl shadow-sm border border-gray-100 group hover:shadow-md transition-all duration-300">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-400 font-bold uppercase tracking-wider">إجمالي العناصر</p>
                                <h3 class="text-2xl font-black text-gray-800 mt-2" id="stats-products">0</h3>
                                <p class="text-[10px] text-indigo-500 font-bold mt-1 cursor-pointer hover:underline"
                                    onclick="showSection('products')">إدارة القائمة</p>
                            </div>
                            <div
                                class="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center text-blue-500 group-hover:scale-110 transition-transform">
                                <i class="fas fa-box text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Sales Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-4">إحصائيات المبيعات (آخر 7 أيام)</h3>
                        <div style="height: 300px;">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>

                    <!-- Top Products -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-4">الأكثر مبيعاً</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-gray-50 text-gray-600">
                                    <tr>
                                        <th class="p-3 rounded-r-lg">المنتج</th>
                                        <th class="p-3">المبيعات</th>
                                        <th class="p-3 rounded-l-lg">الإيرادات</th>
                                    </tr>
                                </thead>
                                <tbody id="top-products-tbody">
                                    <!-- JS will populate this -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="orders-section" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">إدارة الطلبات</h2>
                    <button onclick="loadOrders()" class="text-indigo-600 hover:text-indigo-800"><i
                            class="fas fa-sync"></i>
                        تحديث</button>
                </div>
                <div id="new-order-alert"
                    class="hidden bg-green-600 text-white p-4 rounded-lg shadow-lg mb-4 flex justify-between items-center animate-bounce">
                    <div class="font-bold text-lg"><i class="fas fa-bell mr-2"></i> لديك طلب جديد!</div>
                    <button onclick="this.parentElement.classList.add('hidden')"
                        class="text-white hover:text-gray-200"><i class="fas fa-times"></i></button>
                </div>
                <div class="table-container">
                    <table id="orders-table">
                        <thead>
                            <tr>
                                <th>رقم الطلب</th>
                                <th>العميل</th>
                                <th>المبلغ</th>
                                <th>العنوان</th>
                                <th>الحالة</th>
                                <th>الوقت</th>
                                <th>إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="orders-tbody"></tbody>
                    </table>
                    <div id="no-orders-msg" class="hidden text-center py-10 text-gray-500">لا توجد طلبات حالياً</div>
                </div>
            </section>

            <section id="products-section" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">منتجاتي</h2>
                    <button onclick="openProductModal()"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 transition flex items-center gap-2"><i
                            class="fas fa-plus"></i> إضافة منتج</button>
                </div>
                <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                </div>
            </section>

            <section id="reviews-section" class="hidden space-y-6">
                <h2 class="text-2xl font-bold text-gray-800">إدارة التقييمات</h2>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="table-container">
                        <table class="w-full">
                            <thead class="bg-gray-50 text-gray-600 border-b">
                                <tr>
                                    <th class="text-right p-4">المنتج</th>
                                    <th class="text-right p-4">العميل</th>
                                    <th class="text-right p-4">التقييم</th>
                                    <th class="text-right p-4">التعليق</th>
                                    <th class="text-right p-4">التاريخ</th>
                                    <th class="text-center p-4">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="reviews-tbody" class="divide-y divide-gray-100">
                                <!-- Reviews will be loaded here -->
                            </tbody>
                        </table>
                        <div id="no-reviews-msg" class="hidden text-center py-12 text-gray-500">
                            <i class="far fa-star text-4xl mb-3 text-gray-300 block"></i>
                            لا توجد تقييمات حتى الآن
                        </div>
                    </div>
                </div>
            </section>

            <section id="settings-section" class="hidden space-y-6">
                <h2 class="text-2xl font-bold text-gray-800">إعدادات المتجر</h2>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 max-w-2xl">
                    <form id="settings-form" class="space-y-4">
                        <!-- Store Status Control (Moved here for safety) -->
                        <div
                            class="bg-indigo-50 p-4 rounded-lg border border-indigo-100 flex justify-between items-center">
                            <div>
                                <h4 class="font-bold text-indigo-800 text-sm">حالة المتجر</h4>
                                <p class="text-xs text-indigo-600 mt-1">التحكم في استقبال الطلبات (مفتوح/مغلق). عند
                                    الإغلاق، سيظهر المتجر كمغلق للزبائن.</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="store-status-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <!-- Logo Upload Section -->
                        <div class="flex items-center gap-4 mb-4 bg-gray-50 p-4 rounded-lg border border-gray-100">
                            <div
                                class="w-20 h-20 border-2 border-white shadow-sm rounded-lg overflow-hidden flex items-center justify-center bg-gray-200 relative group">
                                <img id="logo-preview" src="https://via.placeholder.com/150?text=Logo"
                                    class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer"
                                    onclick="document.getElementById('logo-upload').click()">
                                    <i class="fas fa-camera text-white"></i>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">شعار المتجر</label>
                                <p class="text-xs text-gray-500 mb-2">صورة مربعة (مثل انستغرام)</p>
                                <input type="file" id="logo-upload" accept="image/*" class="hidden">
                                <button type="button" onclick="document.getElementById('logo-upload').click()"
                                    class="text-indigo-600 text-sm font-bold hover:bg-indigo-50 px-3 py-1 rounded transition">
                                    <i class="fas fa-upload mr-1"></i> رفع صورة
                                </button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">اسم المتجر</label>
                            <input type="text" id="set-name" class="w-full p-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">وصف قصير</label>
                            <textarea id="set-desc" rows="3" class="w-full p-2 border rounded-lg"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">رقم الهاتف</label>
                                <input type="text" id="set-phone" class="w-full p-2 border rounded-lg" dir="ltr">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">سعر التوصيل الافتراضي
                                    (د.ج)</label>
                                <input type="number" id="set-delivery" class="w-full p-2 border rounded-lg">
                            </div>
                        </div>

                        <!-- Store Coverage Settings -->
                        <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100 mt-4">
                            <h4 class="font-bold text-indigo-800 text-sm mb-2">نطاق التوصيل والظهور</h4>
                            <div class="space-y-2">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="coverage-type" value="national" checked
                                        onchange="toggleCoverageMode()">
                                    <span class="text-sm font-bold">توصيل لكامل التراب الوطني (58 ولاية)</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="coverage-type" value="specific"
                                        onchange="toggleCoverageMode()">
                                    <span class="text-sm font-bold">توصيل لولايات محددة فقط</span>
                                </label>
                            </div>

                            <!-- Specific Wilayas Selection -->
                            <div id="specific-coverage-div" class="hidden mt-3 pt-3 border-t border-indigo-200">
                                <p class="text-xs text-gray-600 mb-2">اختر الولايات التي تشحن إليها (سيظهر متجرك لعملاء
                                    هذه
                                    الولايات فقط):</p>
                                <div class="max-h-40 overflow-y-auto border rounded bg-white p-2 grid grid-cols-2 gap-2 text-xs"
                                    id="coverage-wilayas-list">
                                    <!-- JS will populate -->
                                </div>
                            </div>
                        </div>

                        <!-- Delivery By Wilaya Button -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <div>
                                    <h4 class="font-bold text-gray-800 text-sm">أسعار التوصيل حسب الولاية</h4>
                                    <p class="text-xs text-gray-500">تخصيص سعر التوصيل لكل ولاية (منزل / مكتب)</p>
                                </div>
                                <button type="button" onclick="openDeliveryModal()"
                                    class="bg-indigo-100 text-indigo-600 px-3 py-2 rounded-lg text-sm font-bold hover:bg-indigo-200 transition">
                                    <i class="fas fa-map-marker-alt"></i> تخصيص الأسعار
                                </button>
                            </div>
                        </div>

                        <div class="border-t pt-4 mt-4">
                            <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2"><i
                                    class="fas fa-music text-indigo-500"></i> نغمة الإشعارات</h3>
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 flex items-center gap-3">
                                <div class="flex-1">
                                    <label class="text-xs font-bold text-gray-600 block mb-1">اختر النغمة</label>
                                    <select id="set-sound" class="w-full p-2 border rounded-lg text-sm bg-white"
                                        onchange="previewSound(this.value)">
                                        <option value="alerta.mp3">Alerta 1 (الافتراضي)</option>
                                        <option value="alerta_02.mp3">Alerta 2</option>
                                        <option value="alerta_03.mp3">Alerta 3</option>
                                        <option value="alerta_04.mp3">Alerta 4</option>
                                    </select>
                                </div>
                                <button type="button" onclick="previewSound(document.getElementById('set-sound').value)"
                                    class="mt-4 bg-indigo-100 text-indigo-600 p-2 rounded-lg hover:bg-indigo-200 transition"
                                    title="توجربة النغمة">
                                    <i class="fas fa-play"></i>
                                </button>
                            </div>
                        </div>

                </div>

                <div class="border-t pt-4">
                    <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2"><i
                            class="fas fa-share-alt text-indigo-500"></i> روابط التواصل الاجتماعي</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-600 block mb-1">فيسبوك</label>
                            <input type="url" id="set-fb" placeholder="https://facebook.com/..."
                                class="w-full p-2 border rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-600 block mb-1">انستغرام</label>
                            <input type="url" id="set-insta" placeholder="https://instagram.com/..."
                                class="w-full p-2 border rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-600 block mb-1">تيليجرام</label>
                            <input type="url" id="set-telegram" placeholder="https://t.me/..."
                                class="w-full p-2 border rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-600 block mb-1">تيك توك</label>
                            <input type="url" id="set-tiktok" placeholder="https://tiktok.com/@..."
                                class="w-full p-2 border rounded-lg text-sm">
                        </div>
                    </div>

                    <div class="flex items-center gap-3 mt-4 bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <input type="checkbox" id="set-show-phone"
                            class="w-5 h-5 text-indigo-600 rounded cursor-pointer">
                        <label for="set-show-phone" class="text-sm font-bold text-gray-700 cursor-pointer">عرض رقم
                            الهاتف للعملاء (زر الاتصال)</label>
                    </div>
                </div>

                <button type="submit"
                    class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 mt-4 shadow-lg transition">حفظ
                    التغييرات</button>
                </form>
                </div>
            </section>

    </main>

    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-xl font-bold" id="modal-title">إضافة منتج</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <form id="product-form" class="space-y-4">
                <input type="hidden" id="prod-id">

                <!-- Product Type Selection -->
                <div class="flex gap-4 mb-4 bg-gray-50 p-2 rounded-lg">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="prod-type" value="regular" checked onchange="toggleAuctionFields()">
                        <span class="font-bold text-sm">منتج عادي</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="prod-type" value="auction" onchange="toggleAuctionFields()">
                        <span class="font-bold text-sm text-red-600">مزاد علني 🔥</span>
                    </label>
                </div>

                <div>
                    <label class="block text-sm font-bold mb-1">اسم المنتج</label>
                    <input type="text" id="prod-name" class="w-full p-2 border rounded" required>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-1" id="price-label">السعر (د.ج)</label>
                        <input type="number" id="prod-price" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">القسم</label>
                        <select id="prod-category" class="w-full p-2 border rounded bg-white"></select>
                    </div>
                </div>

                <!-- Auction Specific Fields -->
                <div id="auction-fields" class="hidden space-y-4 bg-red-50 p-4 rounded-lg border border-red-100">
                    <div>
                        <label class="block text-sm font-bold mb-1 text-red-800">تاريخ انتهاء المزاد</label>
                        <input type="datetime-local" id="auction-end-time" class="w-full p-2 border rounded bg-white">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold mb-1">صورة المنتج</label>
                    <div class="flex items-center gap-3">
                        <div
                            class="relative w-20 h-20 bg-gray-100 rounded-lg overflow-hidden border border-gray-200 flex items-center justify-center group">
                            <img id="img-preview" src="https://placehold.co/100"
                                class="w-full h-full object-cover hidden">
                            <i id="img-placeholder" class="fas fa-image text-gray-400 text-2xl"></i>
                            <div id="upload-loader"
                                class="absolute inset-0 bg-black/50 flex items-center justify-center hidden">
                                <div
                                    class="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin">
                                </div>
                            </div>
                        </div>
                        <div class="flex-1">
                            <input type="file" id="prod-image-file" accept="image/*"
                                class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 mb-2">
                            <input type="hidden" id="prod-image-url"> <!-- Stores the ImgBB URL -->
                            <p class="text-[10px] text-gray-400">يدعم JPG, PNG. الحد الأقصى 5MB.</p>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-bold">الوصف</label>
                        <button type="button" onclick="window.generateAIDescription()"
                            class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded-full border border-indigo-100 hover:bg-indigo-100 transition flex items-center gap-1">
                            <i class="fas fa-magic"></i> توليد بالذكاء الاصطناعي
                        </button>
                    </div>
                    <div id="quill-editor" style="height: 100px;"></div>
                </div>
                <div class="flex items-center gap-2 mt-2">
                    <input type="checkbox" id="prod-available" checked>
                    <label for="prod-available" class="text-sm font-bold text-gray-700">المنتج متوفر</label>
                </div>

                <!-- Add-ons (Restaurant Only) -->
                <div id="addons-container" class="border-t pt-4 mt-4 hidden">
                    <label class="block text-sm font-bold text-gray-700 mb-2">الإضافات (اختياري)</label>
                    <div id="addons-list" class="space-y-2 mb-2"></div>
                    <div class="flex gap-2">
                        <input type="text" id="new-addon-name" placeholder="اسم الإضافة (مثال: جبن إضافي)"
                            class="flex-1 p-2 border rounded text-sm">
                        <input type="number" id="new-addon-price" placeholder="السعر"
                            class="w-24 p-2 border rounded text-sm">
                        <button type="button" onclick="addAddonItem()"
                            class="bg-gray-200 px-3 rounded hover:bg-gray-300"><i class="fas fa-plus"></i></button>
                    </div>
                </div>

                <button type="submit" id="save-prod-btn"
                    class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 mt-4">حفظ
                    المنتج</button>
            </form>
        </div>
    </div>

    <!-- Delivery Rates Modal -->
    <div id="delivery-modal" class="modal">
        <div class="modal-content !max-w-2xl">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-xl font-bold">أسعار التوصيل حسب الولاية</h3>
                <button onclick="closeDeliveryModal()"
                    class="text-gray-500 hover:text-red-500 text-2xl">&times;</button>
            </div>

            <div class="flex gap-2 mb-3 sticky top-0 bg-white z-10 py-2">
                <input type="text" id="wilaya-search" placeholder="ابحث عن ولاية..."
                    class="w-full p-2 border rounded-lg text-sm">
            </div>

            <div class="space-y-3 max-h-[60vh] overflow-y-auto px-1" id="wilaya-list">
                <!-- Wilaya items will be injected here -->
            </div>

            <div class="mt-4 pt-3 border-t flex justify-end gap-3 sticky bottom-0 bg-white z-10">
                <button onclick="closeDeliveryModal()"
                    class="px-4 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded-lg">إلغاء</button>
                <button onclick="saveDeliveryRates()"
                    class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">حفظ
                    الأسعار</button>
            </div>
        </div>
    </div>

    <!-- Offer Modal -->
    <div id="offer-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800" id="offer-modal-title">إضافة عرض</h3>
                <button onclick="closeOfferModal()" class="text-gray-400 hover:text-gray-600"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <form id="offer-form" class="space-y-4">
                <input type="hidden" id="offer-id">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">عنوان العرض</label>
                    <input type="text" id="offer-title" required
                        class="w-full p-2 border rounded focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">وصف العرض</label>
                    <textarea id="offer-desc" required
                        class="w-full p-2 border rounded focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">السعر الأصلي</label>
                        <input type="number" id="offer-original-price" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">سعر العرض</label>
                        <input type="number" id="offer-price" required class="w-full p-2 border rounded">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">صورة العرض</label>
                    <input type="file" id="offer-image-file"
                        class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    <input type="hidden" id="offer-image-url">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeOfferModal()"
                        class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">إلغاء</button>
                    <button type="submit"
                        class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 font-bold">حفظ
                        العرض</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-50"></div>

    <script type="module">
        import { auth, db } from './app-core.js';
        import { collection, getDocs, doc, getDoc, addDoc, query, orderBy, serverTimestamp, where, limit, updateDoc, onSnapshot, arrayUnion, arrayRemove, setDoc, writeBatch, Timestamp, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, sendPasswordResetEmail, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let currentUser = null;
        let quill;
        let salesChart;

        // --- Initialization ---
        // JS Execution Test
        // alert("JS LOADED - STARTING INIT");

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        async function initApp() {
            try {
                console.log("Starting initApp...");
                // Use global requireAuth
                const user = await window.requireAuth(auth);
                if (!user) {
                    console.log("User not authenticated, redirect handled by requireAuth");
                    return;
                }

                console.log("User authenticated:", user.uid);
                const userDoc = await getDoc(doc(db, "users", user.uid));

                if (userDoc.exists()) {
                    const data = userDoc.data();
                    console.log("User role:", data.role);

                    // Professional Welcome
                    showToast(`مرحباً بك، ${data.storeName || 'التاجر'}! 👋`);
                    console.log("Dashboard data loaded successfully.");

                    if (data.role === 'vendor' || data.role === 'restaurant') {
                        if (data.isSuspended) {
                            // ... existing suspension logic ...
                            document.body.innerHTML = `
                            <div class="min-h-screen flex flex-col items-center justify-center bg-gray-100 p-4">
                                <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md text-center">
                                    <div class="text-red-500 text-5xl mb-4"><i class="fas fa-store-slash"></i></div>
                                    <h1 class="text-2xl font-bold text-gray-800 mb-2">تم تجميد حساب المتجر</h1>
                                    <p class="text-gray-600 mb-6">نأسف، تم إيقاف حساب متجرك مؤقتاً من قبل الإدارة. يرجى التواصل مع الدعم الفني لمزيد من التفاصيل.</p>
                                    <button onclick="window.location.reload()" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300">تحديث الصفحة</button>
                                    <button onclick="auth.signOut().then(() => window.location.href='index.html')" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 mt-2 block w-full">تسجيل الخروج</button>
                                </div>
                            </div>
                        `;
                            await signOut(auth);
                            return;
                        }
                        currentUser = user;
                        // Inject UID into data for downstream functions
                        data.uid = user.uid;
                        console.log("Initializing Dashboard Components for:", data.storeName);
                        initDashboardComponents(data);
                    } else {
                        console.log('Role mismatch:', data.role);
                        alert(`غير مصرح لك بالوصول. دورك الحالي: ${data.role || 'مستخدم'}.`);
                        window.location.href = 'index.html';
                    }
                } else {
                    console.error("User document not found!");
                    alert("خطأ: لم يتم العثور على بيانات المستخدم.");
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error("Critical Error in initApp:", error);
                alert("حدث خطأ غير متوقع أثناء الدخول للوحة التحكم:\n" + error.message);
            }
        }

        function initDashboardComponents(data) {
            console.log("Loading Dashboard Data...");

            try { document.getElementById('shop-name').textContent = data.storeName || data.displayName; } catch (e) { console.error("Header Error", e); }

            // Safeguarded Initialization Helper
            const safeInit = (fn, name) => {
                try {
                    console.log(`Initializing ${name}...`);
                    fn();
                } catch (error) {
                    console.error(`Error initializing ${name}:`, error);
                    // alert(`خطأ في تحميل ${name}: ${error.message}`); // Disabled for production
                }
            };

            safeInit(() => loadOrdersListener(), "Orders");
            safeInit(() => loadProducts(), "Products");
            safeInit(() => loadReviewsListener(), "Reviews");
            safeInit(() => loadCategories(), "Categories");
            safeInit(() => loadSettings(data), "Settings");
            safeInit(() => initQuill(), "Quill Editor");
            safeInit(() => initChart(), "Chart");
            // safeInit(() => renderStoreLink(), "Store Link"); // Removed to avoid conflict with updateInterfaceForUser
            safeInit(() => updateSubscriptionUI(data), "Subscription UI");

            safeInit(() => {
                if (window.ThemeManager) {
                    ThemeManager.renderSidebarControl('sidebar-theme-container');
                } else {
                    console.warn("ThemeManager not found");
                }
            }, "Theme Manager");

            // Navigation Logic
            safeInit(() => setupNavigation(), "Navigation");

            // Restaurant Specific UI & Adaptation
            safeInit(() => updateInterfaceForUser(data), "Interface Adaptation");

            if (data.role === 'restaurant') {
                safeInit(() => loadOffers(), "Offers");
            }

            // Logout
            try { document.getElementById('logout-btn').onclick = () => signOut(auth); } catch (e) { }

            console.log("Dashboard Initialization Complete");
        }

        function initQuill() {
            try {
                quill = new Quill('#quill-editor', {
                    theme: 'snow',
                    modules: { toolbar: [['bold', 'italic'], [{ 'list': 'ordered' }, { 'list': 'bullet' }]] }
                });
            } catch (e) { console.error("Quill init error", e); }
        }

        // Global Navigation Helper
        window.showSection = (sectionId) => {
            const section = document.getElementById(`${sectionId}-section`);
            if (!section) {
                console.warn(`Section ${sectionId}-section not found`);
                return;
            }

            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            section.classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active', 'bg-gray-800', 'text-white'));
            const btn = document.getElementById(`btn-${sectionId}`);
            if (btn) btn.classList.add('active', 'bg-gray-800', 'text-white');

            if (window.innerWidth < 1024) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                if (sidebar) sidebar.classList.add('closed');
                if (overlay) overlay.classList.remove('active');
            }
        };

        function setupNavigation() {
            // Logic moved to global window.showSection
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const menuBtn = document.getElementById('menu-btn');

            if (menuBtn) {
                menuBtn.onclick = () => {
                    sidebar.classList.toggle('closed');
                    overlay.classList.toggle('active');
                };
            }

            const closeBtn = document.getElementById('sidebar-close-btn');
            if (closeBtn) {
                closeBtn.onclick = () => {
                    sidebar.classList.add('closed');
                    overlay.classList.remove('active');
                };
            }

            if (overlay) {
                overlay.onclick = () => {
                    sidebar.classList.add('closed');
                    overlay.classList.remove('active');
                };
            }

            if (window.innerWidth < 1024) sidebar.classList.add('closed');
        }


        // --- Orders Logic ---
        let ordersCache = [];

        // --- Audio Manager (Added) ---
        const audioManager = {
            element: null,
            isUnlocked: false,
            init() {
                this.element = document.getElementById('notification-sound');
            },
            unlock() {
                if (!this.element) this.init();
                if (this.element && !this.isUnlocked) {
                    this.element.play().then(() => {
                        this.element.pause();
                        this.element.currentTime = 0;
                        this.isUnlocked = true;
                    }).catch(e => console.warn("Audio unlock failed", e));
                }
            },
            play() {
                if (!this.element) this.init();
                if (this.element) {
                    this.element.currentTime = 0;
                    this.element.play().catch(e => console.error("Play failed", e));
                }
            }
        };

        window.enableAudio = () => {
            audioManager.unlock();
            showToast('تم تفعيل التنبيهات الصوتية d🔔');
            const btn = document.getElementById('enable-sound-btn');
            if (btn) btn.classList.add('hidden');
            if (Notification.permission !== "granted") Notification.requestPermission();
        };

        function playNotification(order = null) {
            audioManager.play();
            showToast('طلب جديد! 🔔', 'info');

            if (Notification.permission === "granted" && order) {
                const formattedPrice = (order.totalPrice || 0).toLocaleString('fr-DZ');
                new Notification("S22 Market - طلب جديد!", {
                    body: `طلب من ${order.customerName} بقيمة ${formattedPrice} د.ج`,
                    icon: 'logo.png'
                });
            }
        }

        function loadOrdersListener() {
            const q = query(collection(db, "orders"), where("sellerId", "==", currentUser.uid), orderBy("createdAt", "desc"));

            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('orders-tbody');
                tbody.innerHTML = '';

                let newOrders = 0;
                let dailyTotal = 0;
                let salesData = Array(7).fill(0); // For Chart (Last 7 days)
                ordersCache = [];

                if (snapshot.empty) {
                    document.getElementById('no-orders-msg').classList.remove('hidden');
                } else {
                    document.getElementById('no-orders-msg').classList.add('hidden');

                    snapshot.forEach(docSnap => {
                        const order = docSnap.data();
                        const id = docSnap.id;
                        ordersCache.push({ id, ...order });

                        const dateObj = order.createdAt?.toDate();
                        const timeStr = dateObj?.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) || '--:--';

                        // Stats
                        if (order.status === 'new') newOrders++;
                        if (order.status === 'completed' && isToday(dateObj)) dailyTotal += (order.totalPrice || 0);

                        // Chart Data (Last 7 Days)
                        if (order.status === 'completed' && dateObj) {
                            const dayDiff = getDaysDifference(dateObj);
                            if (dayDiff >= 0 && dayDiff < 7) {
                                salesData[6 - dayDiff] += (order.totalPrice || 0);
                            }
                        }

                        // Sound & Notification
                        if (snapshot.docChanges().some(change => change.type === 'added' && change.doc.id === id && order.status === 'new')) {
                            playNotification(order);
                        }

                        // Render Row
                        const statusClass = `status-${order.status}`;
                        const statusText = { 'new': 'جديد', 'preparing': 'تحضير', 'completed': 'مكتمل', 'canceled': 'ملغي' }[order.status] || order.status;

                        const row = `
                            <tr class="${order.status === 'new' ? 'new-order-row' : ''}">
                                <td>#${id.substring(0, 6)}</td>
                                <td>${order.customerName}<br><span class="text-xs text-gray-500">${order.customerContact || order.customerPhone || 'غير متوفر'}</span></td>
                                <td class="font-bold text-indigo-600">${order.totalPrice} د.ج</td>
                                <td class="text-xs truncate max-w-[150px]">${order.customerLocation}</td>
                                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                <td class="text-xs text-gray-500">${timeStr}</td>
                                <td>
                                    <div class="flex gap-2">
                                        <button onclick="window.printReceipt('${id}')" class="text-gray-500 hover:text-gray-800" title="طباعة"><i class="fas fa-print"></i></button>
                                        <!-- Delete button removed as per owner policy: Merchants can only change status -->
                                        <select onchange="window.updateOrderStatus('${id}', this.value)" class="text-xs border rounded p-1">
                                            <option value="new" ${order.status === 'new' ? 'selected' : ''}>جديد</option>
                                            <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>تحضير</option>
                                            <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>مكتمل</option>
                                            <option value="canceled" ${order.status === 'canceled' ? 'selected' : ''}>إلغاء</option>
                                        </select>
                                    </div>
                                </td>
                            </tr>`;
                        tbody.insertAdjacentHTML('beforeend', row);
                    });
                }

                // Update Stats
                document.getElementById('stats-new-orders').textContent = newOrders;
                document.getElementById('stats-daily-sales').textContent = dailyTotal.toLocaleString() + ' د.ج';

                const badge = document.getElementById('new-orders-badge');
                if (newOrders > 0) {
                    badge.textContent = newOrders;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }

                // Update Chart
                const last7Days = Array(7).fill(0).map((_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - (6 - i));
                    return d.toLocaleDateString('en-CA'); // YYYY-MM-DD
                });

                const chartData = Array(7).fill(0);

                ordersCache.forEach(o => {
                    if (o.status !== 'canceled' && o.createdAt) {
                        const d = o.createdAt.toDate ? o.createdAt.toDate() : new Date(o.createdAt);
                        const dateStr = d.toLocaleDateString('en-CA');
                        const index = last7Days.indexOf(dateStr);
                        if (index !== -1) {
                            chartData[index] += (o.totalPrice || 0);
                        }
                    }
                });

                updateChart(chartData);
                updateTopProducts(ordersCache);
            });
        }

        function updateTopProducts(orders) {
            const productsMap = {};

            orders.forEach(order => {
                if (order.status !== 'canceled' && order.items) {
                    order.items.forEach(item => {
                        const itemName = typeof item.name === 'object' ? (item.name.ar || item.name.en || 'منتج') : item.name;
                        if (!productsMap[itemName]) {
                            productsMap[itemName] = { count: 0, revenue: 0 };
                        }
                        productsMap[itemName].count += (item.quantity || 1);
                        productsMap[itemName].revenue += (item.price * (item.quantity || 1));
                    });
                }
            });

            const sortedProducts = Object.entries(productsMap)
                .sort(([, a], [, b]) => b.count - a.count)
                .slice(0, 5);

            const tbody = document.getElementById('top-products-tbody');
            if (!tbody) return;

            tbody.innerHTML = sortedProducts.length ? '' : '<tr><td colspan="3" class="p-4 text-center text-gray-400">لا توجد بيانات</td></tr>';

            sortedProducts.forEach(([name, data]) => {
                const row = `
                    <tr class="border-b border-gray-50 hover:bg-gray-50">
                        <td class="p-3 font-medium text-gray-800">${name}</td>
                        <td class="p-3 text-gray-600 font-bold">${data.count}</td>
                        <td class="p-3 text-indigo-600 font-bold">${data.revenue.toLocaleString()} د.ج</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Global Order Functions (exposed to window)
        window.updateOrderStatus = async (id, status) => {
            try { await updateDoc(doc(db, "orders", id), { status }); showToast('تم تحديث حالة الطلب'); }
            catch (e) { console.error(e); }
        };

        window.deleteOrder = async (id) => {
            if (!confirm('هل أنت متأكد من حذف هذا الطلب؟ لا يمكن التراجع عن هذا الإجراء.')) return;
            try {
                await deleteDoc(doc(db, "orders", id));
                showToast('تم حذف الطلب بنجاح', 'success');
            } catch (e) {
                console.error("Error deleting order:", e);
                showToast('حدث خطأ أثناء الحذف', 'error');
            }
        };

        window.printReceipt = async (orderId) => {
            const docSnap = await getDoc(doc(db, "orders", orderId));
            if (!docSnap.exists()) return;
            const order = docSnap.data();
            const itemsHTML = order.items.map(i => {
                const iName = typeof i.name === 'object' ? (i.name.ar || i.name.en || 'منتج') : i.name;
                return `<div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:12px;"><span>${i.quantity}x ${iName}</span><span>${i.price * i.quantity}</span></div>`;
            }).join('');

            // Create print window
            const printWindow = window.open('', '', 'width=350,height=600');
            printWindow.document.write(`
                <html dir="rtl">
                <body style="font-family: 'Tajawal', sans-serif; width: 80mm; padding: 10px; margin: 0;">
                    <div style="text-align:center; border-bottom: 1px dashed #000; padding-bottom: 10px;">
                        <h2 style="margin:0;">${document.getElementById('shop-name').textContent}</h2>
                        <p style="margin:5px 0; font-size:12px;">طلب #${orderId.substring(0, 6)}</p>
                        <p style="margin:0; font-size:12px;">${new Date().toLocaleString('ar-EG')}</p>
                    </div>
                    <div style="margin: 15px 0;">
                        <p style="margin:2px 0; font-size:14px;"><b>العميل:</b> ${order.customerName}</p>
                        <p style="margin:2px 0; font-size:14px;"><b>الهاتف:</b> ${order.customerContact}</p>
                        <p style="margin:2px 0; font-size:12px;"><b>العنوان:</b> ${order.customerLocation}</p>
                    </div>
                    <div style="border-top: 1px solid #000; padding-top: 10px;">${itemsHTML}</div>
                    <div style="border-top: 2px solid #000; margin-top: 10px; padding-top: 5px; display:flex; justify-content:space-between; font-weight:bold;">
                        <span>الإجمالي:</span><span>${order.totalPrice} د.ج</span>
                    </div>
                    <div style="text-align:center; margin-top: 20px; font-size: 10px;">شكراً لطلبكم!</div>
                    <script>window.print(); window.close();<\/script>
                </body>
                </html>`
            );
        };

        window.exportOrdersCSV = () => {
            if (ordersCache.length === 0) return showToast("لا توجد طلبات لتصديرها", "error");

            let csvContent = "\uFEFFرقم الطلب,العميل,الهاتف,العنوان,المبلغ,الحالة,التاريخ\n";
            ordersCache.forEach(o => {
                const date = o.createdAt?.toDate().toLocaleString('ar-EG') || '';
                const row = [
                    `#${o.id.substring(0, 6)}`,
                    o.customerName || '',
                    o.customerContact || '',
                    `"${o.customerLocation || ''}"`,
                    o.totalPrice || 0,
                    o.status || '',
                    `"${date}"`
                ];
                csvContent += row.join(",") + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "orders_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };


        // --- DASHBOARD ADAPTATION LOGIC ---
        function updateInterfaceForUser(userData) {
            const role = userData.role || 'seller';
            const isRestaurant = role === 'restaurant';

            // Show/Hide Restaurant specific elements
            document.querySelectorAll('.restaurant-only').forEach(el => {
                el.classList.toggle('hidden', !isRestaurant);
            });

            // Update Labels
            const productsLabel = document.getElementById('nav-products-label');
            if (productsLabel) productsLabel.textContent = isRestaurant ? 'قائمة الطعام' : 'المنتجات';

            const shopNameEl = document.getElementById('shop-name');
            if (shopNameEl) shopNameEl.textContent = userData.storeName || userData.displayName || 'المتجر';

            // Update Store Name in Dashboard
            const dashNameEl = document.getElementById('dashboard-store-name');
            if (dashNameEl) dashNameEl.textContent = userData.storeName || userData.displayName || 'المتجر';

            // Subscription Check
            updateSubscriptionUI(userData);

            // Update Link Display inside the Share Card
            const linkDisplay = document.getElementById('store-link-display');
            if (linkDisplay) {
                try {
                    const uid = userData.uid || currentUser?.uid;
                    if (uid) {
                        const origin = window.location.origin;
                        const link = `${origin}/S22MARKET/vendor.html?id=${uid}&type=${isRestaurant ? 'restaurant' : 'vendor'}`;
                        linkDisplay.textContent = link.replace(/^https?:\/\//, '');
                    } else {
                        linkDisplay.textContent = 'رابط غير متوفر حالياً';
                        console.warn("UID missing for link generation");
                    }
                } catch (e) {
                    console.error("Link Gen Error:", e);
                    linkDisplay.textContent = 'خطأ في الرابط';
                }
            }

            // Update Store Status Badge
            try {
                const statusBadge = document.getElementById('store-status-badge');
                if (statusBadge) {
                    const isOpen = userData.isOpen !== false; // Default true
                    if (isOpen) {
                        statusBadge.className = "inline-flex items-center gap-1 px-2 py-1 rounded-full bg-green-100 text-green-600 text-[10px] font-bold mt-2";
                        statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span><span>مفتوح - يستقبل الطلبات</span>';
                    } else {
                        statusBadge.className = "inline-flex items-center gap-1 px-2 py-1 rounded-full bg-red-100 text-red-600 text-[10px] font-bold mt-2";
                        statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span><span>مغلق مؤقتاً</span>';
                    }
                }
            } catch (e) {
                console.error("Badge Update Error:", e);
            }
        }

        window.copyStoreLink = () => {
            if (!currentUser) return;
            const typeParam = currentUser.role === 'restaurant' ? 'restaurant' : 'seller';
            const link = `${window.location.origin}/S22MARKET/vendor.html?id=${currentUser.uid}&type=${typeParam}`;

            navigator.clipboard.writeText(link).then(() => {
                showToast("تم نسخ رابط المتجر بنجاح ✅");
            }).catch(err => console.error("Copy failed", err));
        };

        // --- Subscription Logic ---
        // --- Subscription Logic ---


        function showExpirationBanner(msg) {
            // Check if banner exists
            let banner = document.getElementById('sub-alert-banner');
            if (!banner) {
                banner = document.createElement('div');
                banner.id = 'sub-alert-banner';
                banner.className = "bg-red-600 text-white text-center py-2 px-4 shadow-md font-bold text-sm fixed top-16 w-full z-30 animate-pulse";
                document.body.prepend(banner);

                // Insert after header
                const header = document.querySelector('header');
                if (header) {
                    header.insertAdjacentElement('afterend', banner);
                }
            }
            banner.textContent = msg;
            banner.classList.remove('hidden');
        }
        async function loadProducts() {
            const q = query(collection(db, "products"), where("sellerId", "==", currentUser.uid), orderBy("createdAt", "desc"));
            onSnapshot(q, (snap) => {
                const grid = document.getElementById('products-grid');
                grid.innerHTML = '';
                document.getElementById('stats-products').textContent = snap.size;

                snap.forEach(docSnap => {
                    const p = docSnap.data();
                    const card = document.createElement('div');
                    card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-200 relative group";
                    card.innerHTML = `
                        <div class="absolute top-2 left-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                            <button onclick="window.editProduct('${docSnap.id}')" class="bg-blue-100 text-blue-600 p-2 rounded-full hover:bg-blue-200"><i class="fas fa-edit"></i></button>
                            <button onclick="window.deleteProduct('${docSnap.id}')" class="bg-red-100 text-red-600 p-2 rounded-full hover:bg-red-200"><i class="fas fa-trash"></i></button>
                        </div>
                        <img src="${p.imageUrls?.[0] || 'https://placehold.co/150'}" class="w-full h-32 object-cover rounded-lg mb-3">
                        <h3 class="font-bold text-gray-800 text-sm truncate">${p.name}</h3>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-indigo-600 font-bold">${p.price} د.ج</span>
                            <span class="text-xs ${p.availability === 'sold_out' ? 'text-red-500' : 'text-green-500'} font-bold">${p.availability === 'sold_out' ? 'نفذ' : 'متوفر'}</span>
                        </div>`;
                    grid.appendChild(card);
                });
            });
        }

        window.openProductModal = () => {
            document.getElementById('product-form').reset();
            document.getElementById('prod-id').value = '';
            document.getElementById('modal-title').textContent = 'إضافة منتج';
            if (quill) quill.root.innerHTML = '';

            // Reset Image
            document.getElementById('prod-image-url').value = '';
            const fileInput = document.getElementById('prod-image-file');
            if (fileInput) fileInput.value = '';
            document.getElementById('img-preview').classList.add('hidden');
            document.getElementById('img-placeholder').classList.remove('hidden');

            document.getElementById('addons-list').innerHTML = '';
            if (currentUser.role === 'restaurant') document.getElementById('addons-container').classList.remove('hidden');

            document.getElementById('product-modal').classList.add('active');
        };

        window.closeModal = () => document.getElementById('product-modal').classList.remove('active');

        document.getElementById('product-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('save-prod-btn');
            btn.disabled = true; btn.textContent = 'جاري الحفظ...';

            const id = document.getElementById('prod-id').value;
            const data = {
                name: document.getElementById('prod-name').value,
                price: parseFloat(document.getElementById('prod-price').value),
                categoryId: document.getElementById('prod-category').value,
                description: quill ? quill.root.innerHTML : document.getElementById('prod-name').value,
                imageUrls: [document.getElementById('prod-image-url').value],
                availability: document.getElementById('prod-available').checked ? 'available' : 'sold_out',
                addOns: Array.from(document.querySelectorAll('.addon-item')).map(item => ({
                    name: item.querySelector('.addon-name').value,
                    price: Number(item.querySelector('.addon-price').value)
                })).filter(a => a.name && a.price),
                sellerId: currentUser.uid,
                storeName: currentUser.storeName || currentUser.displayName || 'متجر',
                categoryName: document.getElementById('prod-category').options[document.getElementById('prod-category').selectedIndex]?.text || 'عام',
                updatedAt: serverTimestamp()
            };

            try {
                if (id) {
                    await updateDoc(doc(db, "products", id), data);
                } else {
                    data.createdAt = serverTimestamp();
                    data.productType = 'regular';
                    await addDoc(collection(db, "products"), data);
                }
                closeModal();
                showToast('تم حفظ المنتج بنجاح');
            } catch (err) {
                console.error(err);
                alert('حدث خطأ');
            } finally {
                btn.disabled = false;
                btn.textContent = 'حفظ المنتج';
            }
        };

        window.deleteProduct = async (id) => {
            if (confirm('حذف المنتج نهائياً؟')) {
                await deleteDoc(doc(db, "products", id));
            }
        };

        window.editProduct = async (id) => {
            const snap = await getDoc(doc(db, "products", id));
            const p = snap.data();

            document.getElementById('prod-id').value = id;
            document.getElementById('prod-name').value = p.name;
            document.getElementById('prod-price').value = p.price;
            document.getElementById('prod-category').value = p.categoryId;
            // Image handling for edit
            const imgUrl = p.imageUrls?.[0] || '';
            document.getElementById('prod-image-url').value = imgUrl;
            if (imgUrl) {
                document.getElementById('img-preview').src = imgUrl;
                document.getElementById('img-preview').classList.remove('hidden');
                document.getElementById('img-placeholder').classList.add('hidden');
            } else {
                document.getElementById('img-preview').classList.add('hidden');
                document.getElementById('img-placeholder').classList.remove('hidden');
            }
            document.getElementById('prod-available').checked = p.availability !== 'sold_out';

            // Add-ons
            const addonsList = document.getElementById('addons-list');
            addonsList.innerHTML = '';
            if (p.addOns) {
                document.getElementById('addons-container').classList.remove('hidden'); // Ensure visible if used
                p.addOns.forEach(ad => addAddonItem(ad.name, ad.price));
            }

            if (quill) quill.root.innerHTML = p.description;

            document.getElementById('modal-title').textContent = 'تعديل منتج';
            document.getElementById('product-modal').classList.add('active');
        };


        // --- Settings Logic ---
        async function loadSettings(userData) {
            document.getElementById('store-status-toggle').checked = userData.isOpen !== false;

            // Load Logo
            if (userData.storeLogo || userData.logoUrl) {
                document.getElementById('logo-preview').src = userData.storeLogo || userData.logoUrl;
            }

            document.getElementById('set-name').value = userData.storeName || '';
            document.getElementById('set-desc').value = userData.description || '';
            document.getElementById('set-phone').value = userData.phone || '';
            document.getElementById('set-delivery').value = userData.deliveryFee || '';

            const links = userData.socialLinks || {};
            document.getElementById('set-fb').value = links.facebook || '';
            document.getElementById('set-insta').value = links.instagram || '';
            document.getElementById('set-telegram').value = links.telegram || '';
            document.getElementById('set-tiktok').value = links.tiktok || '';
            document.getElementById('set-show-phone').checked = userData.showPhone !== false;

            // Sound Loading
            const savedSound = userData.notificationSound || 'alerta.mp3';
            const soundSelect = document.getElementById('set-sound');
            if (soundSelect) {
                soundSelect.value = savedSound;
                // Update audio element source
                const audio = document.getElementById('order-sound');
                if (audio) audio.src = savedSound;
            }

            // Coverage loading
            const fulfillment = userData.fulfillment || { isNational: true };
            if (fulfillment.isNational) {
                const natRadio = document.querySelector('input[name="coverage-type"][value="national"]');
                if (natRadio) natRadio.checked = true;
            } else {
                const specRadio = document.querySelector('input[name="coverage-type"][value="specific"]');
                if (specRadio) {
                    specRadio.checked = true;
                    // Trigger visibility manually as onchange doesn't fire programmatically usually
                    const div = document.getElementById('specific-coverage-div');
                    if (div) div.classList.remove('hidden');
                }

                // Check boxes
                if (fulfillment.coveredWilayas) {
                    const checkboxes = document.querySelectorAll('input[name="specific_wilayas"]');
                    checkboxes.forEach(cb => {
                        if (fulfillment.coveredWilayas.includes(cb.value)) cb.checked = true;
                    });
                }
            }

            // Listener for toggle
            document.getElementById('store-status-toggle').onchange = async (e) => {
                await updateDoc(doc(db, "users", currentUser.uid), { isOpen: e.target.checked });
                showToast(e.target.checked ? 'المتجر مفتوح الآن ✅' : 'المتجر مغلق ⛔');
            };
        }

        document.getElementById('settings-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true; btn.textContent = "جاري الحفظ...";

            // Upload Logo if changed
            let logoUrl = null;
            const logoFile = document.getElementById('logo-upload').files[0];
            if (logoFile) {
                try {
                    logoUrl = await uploadImageToImgBB(logoFile);
                } catch (err) {
                    console.error("Logo upload failed", err);
                    showToast("فشل رفع الشعار: " + err.message, "error");
                    btn.disabled = false; btn.textContent = "حفظ التغييرات";
                    return;
                }
            }

            // Coverage data gathering
            const coverageType = document.querySelector('input[name="coverage-type"]:checked').value;
            const isNational = coverageType === 'national';
            let coveredWilayas = [];
            if (!isNational) {
                document.querySelectorAll('input[name="specific_wilayas"]:checked').forEach(cb => {
                    coveredWilayas.push(cb.value);
                });
            }

            const updates = {
                fulfillment: {
                    isNational: isNational,
                    coveredWilayas: isNational ? null : coveredWilayas
                },
                storeName: document.getElementById('set-name').value,
                description: document.getElementById('set-desc').value,
                phone: document.getElementById('set-phone').value,
                deliveryFee: parseFloat(document.getElementById('set-delivery').value),
                socialLinks: {
                    facebook: document.getElementById('set-fb').value,
                    instagram: document.getElementById('set-insta').value,
                    telegram: document.getElementById('set-telegram').value,
                    tiktok: document.getElementById('set-tiktok').value
                },
                showPhone: document.getElementById('set-show-phone').checked,
                notificationSound: document.getElementById('set-sound').value
            };

            // Add Logo if uploaded
            if (logoUrl) {
                updates.storeLogo = logoUrl;
                updates.logoUrl = logoUrl; // Save as both for compatibility
            }

            try {
                await updateDoc(doc(db, "users", currentUser.uid), updates);
                showToast("تم حفظ الإعدادات بنجاح");
            } catch (e) { console.error(e); showToast("خطأ في الحفظ", "error"); }
            finally { btn.disabled = false; btn.textContent = "حفظ التغييرات"; }
        };


        // --- Chart Logic (New) ---
        function initChart() {
            const ctx = document.getElementById('salesChart');
            if (!ctx) return;

            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: getLast7DaysLabels(),
                    datasets: [{
                        label: 'المبيعات (د.ج)',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateChart(data) {
            if (salesChart) {
                salesChart.data.datasets[0].data = data;
                salesChart.update();
            }
        }




        // --- Utils ---
        async function loadCategories() {
            const snap = await getDocs(query(collection(db, "categories"), orderBy("orderIndex")));
            const select = document.getElementById('prod-category');
            select.innerHTML = '';
            snap.forEach(d => { select.innerHTML += `<option value="${d.id}">${d.data().name}</option>`; });
        }





        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg text-sm mb-2 animate-bounce flex items-center gap-2';
            el.innerHTML = `<i class="fas ${type === 'error' ? 'fa-exclamation-circle text-red-400' : 'fa-check-circle text-green-400'}"></i> ${msg}`;
            container.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        window.previewSound = (soundFile) => {
            const tempAudio = new Audio(soundFile);
            tempAudio.play().catch(e => console.error("Preview failed", e));
        };

        function isToday(date) {
            if (!date) return false;
            const today = new Date();
            return date.getDate() === today.getDate() && date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
        }

        // --- Audio Logic ---
        window.enableAudio = () => {
            const audio = document.getElementById('order-sound');
            audio.play().then(() => {
                audio.pause();
                audio.currentTime = 0;
                document.getElementById('enable-sound-btn').classList.add('hidden');
                localStorage.setItem('s22_sound_enabled', 'true');
                showToast('تم تفعيل التنبيهات الصوتية 🔊');

                // Auto-trigger Wake Lock if sound is enabled (UX convenience)
                if (!wakeLock) toggleWakeLock();
            }).catch(e => console.log('Audio enable failed', e));
        };

        // --- Screen Wake Lock API ---
        let wakeLock = null;
        async function toggleWakeLock() {
            const btn = document.getElementById('wake-lock-btn');
            if ('wakeLock' in navigator) {
                try {
                    if (wakeLock) {
                        await wakeLock.release();
                        wakeLock = null;
                        btn.className = "hidden sm:flex items-center gap-2 bg-slate-100 text-slate-500 px-3 py-1 rounded-full text-xs font-bold hover:bg-slate-200 transition";
                        btn.querySelector('i').className = "fas fa-sun";
                        showToast('تم إيقاف وضع النشاط (الشاشة قد تنطفئ)', 'info');
                    } else {
                        wakeLock = await navigator.wakeLock.request('screen');
                        btn.className = "flex items-center gap-2 bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-yellow-200 transition shadow-sm border border-yellow-200";
                        btn.querySelector('i').className = "fas fa-lightbulb animate-pulse";
                        showToast('تم تفعيل وضع النشاط (الشاشة ستبقى تعمل) 💡', 'success');

                        wakeLock.addEventListener('release', () => {
                            console.log('Wake Lock released');
                            // UI update handled above or by system
                        });
                    }
                } catch (err) {
                    console.error(`${err.name}, ${err.message}`);
                    showToast('المتصفح لا يدعم هذه الميزة', 'error');
                }
            } else {
                showToast('جهازك لا يدعم Wake Lock API', 'error');
            }
        }

        // Re-acquire lock when page becomes visible
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                // The lock is released when tab is hidden, so re-acquire
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                } catch (err) { console.log('Wake Lock re-acquire failed', err); }
            }
        });



        // Check legacy enabled state
        if (localStorage.getItem('s22_sound_enabled') === 'true') {
            // Try silent play to warm up
        }

        function getDaysDifference(date) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const target = new Date(date);
            target.setHours(0, 0, 0, 0);
            const diff = today - target;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        function getLast7DaysLabels() {
            const days = ['أحد', 'إثنين', 'ثلاثاء', 'أربعاء', 'خميس', 'جمعة', 'سبت'];
            const labels = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                labels.push(days[d.getDay()]);
            }
            return labels;
        }

        // --- Image Upload Logic (ImgBB) ---
        async function uploadImageToImgBB(file) {
            const formData = new FormData();
            formData.append('image', file);
            formData.append('key', "ac296feb5a275923598bdbfd4f9aed8c"); // User provided key

            // Show loader
            const loader = document.getElementById('upload-loader');
            if (loader) loader.classList.remove('hidden');

            try {
                const response = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: formData });
                if (!response.ok) throw new Error(`ImgBB upload failed with status ${response.status}`);
                const result = await response.json();

                if (result.success) {
                    return result.data.url;
                } else {
                    throw new Error(`ImgBB Error: ${result.error.message}`);
                }
            } finally {
                if (loader) loader.classList.add('hidden');
            }
        }

        // Setup File Input Listener
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('prod-image-file');
            if (fileInput) {
                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    // Preview
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('img-preview').src = e.target.result;
                        document.getElementById('img-preview').classList.remove('hidden');
                        document.getElementById('img-placeholder').classList.add('hidden');
                    };
                    reader.readAsDataURL(file);

                    // Upload
                    try {
                        const url = await uploadImageToImgBB(file);
                        document.getElementById('prod-image-url').value = url;
                        showToast('تم رفع الصورة بنجاح');
                    } catch (err) {
                        console.error(err);
                        showToast('فشل رفع الصورة: ' + err.message, 'error');
                        // Reset
                        fileInput.value = '';
                        document.getElementById('img-preview').classList.add('hidden');
                        document.getElementById('img-placeholder').classList.remove('hidden');
                    }
                });
            }

            // Check if we need to render store link on load (moved here to ensure DOM is ready)

            // Logo Preview Listener
            const logoInput = document.getElementById('logo-upload');
            if (logoInput) {
                logoInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => document.getElementById('logo-preview').src = e.target.result;
                        reader.readAsDataURL(file);
                    }
                });
            }
        });


        // --- Store Link Logic ---
        window.copyStoreLink = () => {
            const link = `${window.location.origin}/S22MARKET/vendor.html?id=${currentUser.uid}&type=vendor`;
            navigator.clipboard.writeText(link).then(() => {
                showToast('تم نسخ رابط المتجر ✅');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                prompt("نسخ الرابط يدوياً:", link);
            });
        };

        // --- Store Link Logic ---
        window.copyStoreLink = () => {
            const link = `${window.location.origin}/S22MARKET/vendor.html?id=${currentUser.uid}&type=${currentUser.role === 'restaurant' ? 'restaurant' : 'vendor'}`;
            navigator.clipboard.writeText(link).then(() => {
                showToast('تم نسخ رابط المتجر ✅');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                prompt("نسخ الرابط يدوياً:", link);
            });
        };

        window.shareStoreNative = async () => {
            if (!currentUser) return;
            const link = `${window.location.origin}/S22MARKET/vendor.html?id=${currentUser.uid}&type=${currentUser.role === 'restaurant' ? 'restaurant' : 'vendor'}`;
            const text = `مرحباً! تفضل بزيارة متجري ${currentUser.storeName || ''} على S22 Market وتسوق أفضل المنتجات.`;

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: currentUser.storeName || 'S22 Market Store',
                        text: text,
                        url: link
                    });
                } catch (err) {
                    console.log('Share cancelled', err);
                }
            } else {
                // Fallback UI (SweetAlert2)
                Swal.fire({
                    title: 'مشاركة المتجر',
                    html: `
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <a href="https://wa.me/?text=${encodeURIComponent(text + '\n' + link)}" target="_blank" class="flex flex-col items-center justify-center gap-2 p-4 rounded-xl bg-green-50 text-green-600 hover:bg-green-100 transition border border-green-200">
                                <i class="fab fa-whatsapp text-3xl"></i>
                                <span class="font-bold text-sm">واتساب</span>
                            </a>
                            <a href="https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}" target="_blank" class="flex flex-col items-center justify-center gap-2 p-4 rounded-xl bg-sky-50 text-sky-500 hover:bg-sky-100 transition border border-sky-200">
                                <i class="fab fa-telegram-plane text-3xl"></i>
                                <span class="font-bold text-sm">تيليجرام</span>
                            </a>
                            <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}" target="_blank" class="flex flex-col items-center justify-center gap-2 p-4 rounded-xl bg-blue-50 text-blue-600 hover:bg-blue-100 transition border border-blue-200">
                                <i class="fab fa-facebook-f text-3xl"></i>
                                <span class="font-bold text-sm">فيسبوك</span>
                            </a>
                            <div onclick="window.copyStoreLink(); Swal.close();" class="cursor-pointer flex flex-col items-center justify-center gap-2 p-4 rounded-xl bg-gray-50 text-gray-600 hover:bg-gray-100 transition border border-gray-200">
                                <i class="fas fa-copy text-3xl"></i>
                                <span class="font-bold text-sm">نسخ</span>
                            </div>
                        </div>
                    `,
                    showConfirmButton: false,
                    showCloseButton: true,
                    customClass: { popup: 'rounded-2xl' }
                });
            }
        };

        function renderStoreLink() {
            if (!currentUser) return;
            const link = `${window.location.origin}/S22MARKET/vendor.html?id=${currentUser.uid}&type=vendor`;
            const displayEl = document.getElementById('store-link-display');
            if (displayEl) displayEl.textContent = link.replace('http://', '').replace('https://', '');
        }

        // --- Subscription Card Logic ---
        window.updateSubscriptionUI = (user) => {
            try {
                const subCard = document.getElementById('sub-card');
                if (!subCard || !user.subscription) return;

                subCard.classList.remove('hidden');

                const sub = user.subscription;
                const now = new Date();

                // Safe Date Helper
                const toDateSafe = (val) => {
                    if (!val) return null;
                    if (val.toDate && typeof val.toDate === 'function') return val.toDate();
                    if (val.seconds) return new Date(val.seconds * 1000); // Firestore JSON like
                    return new Date(val); // String or JS Date
                };

                let endDate = toDateSafe(sub.endDate);
                let daysRemaining = 0;
                let progress = 0;
                let startDate = null;

                if (endDate && !isNaN(endDate.getTime())) {
                    startDate = sub.startDate ? toDateSafe(sub.startDate) : new Date(endDate.getTime() - (30 * 24 * 60 * 60 * 1000));

                    const totalDuration = endDate - startDate;
                    const timePassed = now - startDate;

                    daysRemaining = Math.max(0, Math.ceil((endDate - now) / (1000 * 60 * 60 * 24)));
                    if (totalDuration > 0) {
                        progress = Math.min(100, Math.max(0, (timePassed / totalDuration) * 100));
                    }
                }

                // Update DOM
                const formatDate = (d) => d && !isNaN(d.getTime()) ? d.toLocaleDateString('ar-EG', { day: 'numeric', month: 'numeric', year: 'numeric' }) : '--/--';

                document.getElementById('sub-plan-name').textContent = sub.planName || 'الباقة الأساسية';
                document.getElementById('sub-days-remain').textContent = daysRemaining > 0 ? `${daysRemaining} يوم` : 'منتهي';
                document.getElementById('sub-start-date').textContent = formatDate(startDate || new Date());
                document.getElementById('sub-end-date').textContent = formatDate(endDate);

                const statusText = document.getElementById('sub-status-text');
                const statusDot = document.getElementById('sub-status-dot');
                const progressBar = document.getElementById('sub-progress');

                if (progressBar) progressBar.style.width = `${progress}%`;

                if (daysRemaining > 5) {
                    if (statusText) {
                        statusText.textContent = 'نشط';
                        statusText.className = "text-xs font-bold text-green-100";
                    }
                    if (statusDot) statusDot.className = "w-2 h-2 rounded-full bg-green-400 animate-pulse";
                    if (progressBar) progressBar.className = "bg-gradient-to-r from-green-400 to-emerald-400 h-full rounded-full transition-all duration-1000";
                } else if (daysRemaining > 0) {
                    if (statusText) {
                        statusText.textContent = 'ينتهي قريباً';
                        statusText.className = "text-xs font-bold text-orange-100";
                    }
                    if (statusDot) statusDot.className = "w-2 h-2 rounded-full bg-orange-400 animate-pulse";
                    if (progressBar) progressBar.className = "bg-gradient-to-r from-orange-400 to-yellow-400 h-full rounded-full transition-all duration-1000";
                    if (typeof showExpirationBanner === 'function') showExpirationBanner(`تنبيه: سينتهي اشتراكك خلال ${daysRemaining} أيام.`);
                } else {
                    if (statusText) {
                        statusText.textContent = 'منتهي';
                        statusText.className = "text-xs font-bold text-red-100";
                    }
                    if (statusDot) statusDot.className = "w-2 h-2 rounded-full bg-red-400";
                    if (progressBar) {
                        progressBar.className = "bg-red-500 h-full rounded-full transition-all duration-1000";
                        progressBar.style.width = "100%";
                    }
                    if (typeof showExpirationBanner === 'function') showExpirationBanner("انتهت صلاحية اشتراك المتجر! يرجى تجديد الاشتراك.");
                }
            } catch (err) {
                console.error("Subscription UI Error:", err);
            }
        }



        // --- Delivery Pricing Logic & Coverage ---
        const WILAYAS = [
            "أدرار", "الشلف", "الأغواط", "أم البواقي", "باتنة", "بجاية", "بسكرة", "بشار", "البليدة", "البويرة", "تمنراست", "تبسة", "تلمسان", "تيارت", "تيزي وزو", "الجزائر", "الجلفة", "جيجل", "سطيف", "سعيدة", "سكيكدة", "سيدي بلعباس", "عنابة", "قالمة", "قسنطينة", "المدية", "مستغانم", "المسيلة", "معسكر", "ورقلة", "وهران", "البيض", "إليزي", "برج بوعريريج", "بومرداس", "الطارق", "تندوف", "تيسمسيلت", "الوادي", "خنشلة", "سوق أهراس", "تيبازة", "ميلة", "عين الدفلى", "النعامة", "عين تموشنت", "غرداية", "غليزان", "تيميمون", "برج باجي مختار", "أولاد جلال", "بني عباس", "عين صالح", "عين قزام", "تقرت", "جانوت", "المغير", "المنيعة"
        ];

        // Initial setup for Wilayas List in Coverage settings
        document.addEventListener('DOMContentLoaded', () => {
            const list = document.getElementById('coverage-wilayas-list');
            if (list) {
                WILAYAS.forEach((w, i) => {
                    const id = i + 1;
                    list.innerHTML += `
                         <label class="flex items-center gap-2 hover:bg-gray-50 p-1 rounded cursor-pointer">
                             <input type="checkbox" name="specific_wilayas" value="${w}" class="text-indigo-600 rounded focus:ring-indigo-500">
                             <span>${id} - ${w}</span>
                         </label>
                     `;
                });
            }
        });

        window.toggleCoverageMode = () => {
            const mode = document.querySelector('input[name="coverage-type"]:checked').value;
            const div = document.getElementById('specific-coverage-div');
            if (mode === 'specific') {
                div.classList.remove('hidden');
            } else {
                div.classList.add('hidden');
            }
        };


        let deliveryRates = {}; // Store rates here

        window.openDeliveryModal = async () => {
            document.getElementById('delivery-modal').classList.add('active');

            // Fetch current rates if not loaded (or rely on loaded user data)
            // For now assuming we pass data or fetch it fresh
            if (currentUser) {
                const snap = await getDoc(doc(db, "users", currentUser.uid));
                if (snap.exists()) {
                    deliveryRates = snap.data().deliveryRates || {};
                }
            }

            renderWilayaList();
        };

        window.closeDeliveryModal = () => document.getElementById('delivery-modal').classList.remove('active');

        function renderWilayaList() {
            const list = document.getElementById('wilaya-list');
            list.innerHTML = '';

            const search = document.getElementById('wilaya-search').value.toLowerCase();

            WILAYAS.forEach(w => {
                if (!w.name.includes(search)) return;

                const rates = deliveryRates[w.id] || { home: 0, desk: 0 };

                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100 hover:border-indigo-200 transition';
                item.innerHTML = `
                    <div class="font-bold text-gray-700 w-1/3">${w.id}. ${w.name}</div>
                    <div class="flex gap-2 w-2/3">
                        <div class="flex-1">
                            <label class="text-[10px] text-gray-500 block">توصيل للمنزل</label>
                            <input type="number" value="${rates.home || ''}" placeholder="0" 
                                onchange="updateRate(${w.id}, 'home', this.value)"
                                class="w-full p-1 text-sm border rounded">
                        </div>
                        <div class="flex-1">
                            <label class="text-[10px] text-gray-500 block">توصيل للمكتب</label>
                            <input type="number" value="${rates.desk || ''}" placeholder="0" 
                                 onchange="updateRate(${w.id}, 'desk', this.value)"
                                class="w-full p-1 text-sm border rounded">
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        window.updateRate = (wid, type, value) => {
            if (!deliveryRates[wid]) deliveryRates[wid] = {};
            deliveryRates[wid][type] = parseFloat(value);
        };

        window.saveDeliveryRates = async () => {
            const btn = document.querySelector('#delivery-modal button.bg-indigo-600');
            btn.textContent = 'جاري الحفظ...'; btn.disabled = true;

            try {
                await updateDoc(doc(db, "users", currentUser.uid), {
                    deliveryRates: deliveryRates
                });
                showToast('تم حفظ أسعار التوصيل');
                closeDeliveryModal();
            } catch (e) {
                console.error(e);
                showToast('حدث خطأ أثناء الحفظ', 'error');
            } finally {
                btn.textContent = 'حفظ الأسعار'; btn.disabled = false;
            }
        };

        document.getElementById('wilaya-search').addEventListener('input', renderWilayaList);

        // --- Restaurant Features: Offers & Add-ons ---

        let offersCache = [];

        function loadOffers() {
            const q = query(collection(db, "offers"), where("sellerId", "==", currentUser.uid));
            onSnapshot(q, (snapshot) => {
                offersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOffers();
            });
        }

        function renderOffers() {
            const grid = document.getElementById('offers-grid');
            grid.innerHTML = '';

            offersCache.forEach(offer => {
                const el = document.createElement('div');
                el.className = "bg-white p-4 rounded-xl shadow-sm border border-orange-100 flex gap-4 relative group";
                el.innerHTML = `
                    <img src="${offer.imageUrl || 'https://placehold.co/100'}" class="w-20 h-20 object-cover rounded-lg">
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-800">${offer.title}</h3>
                        <p class="text-xs text-gray-500 line-clamp-2">${offer.description}</p>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="text-green-600 font-bold">${offer.price} د.ج</span>
                            ${offer.originalPrice ? `<span class="text-red-400 line-through text-xs">${offer.originalPrice}</span>` : ''}
                        </div>
                    </div>
                    <button onclick="deleteOffer('${offer.id}')" class="absolute top-2 left-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button>
                `;
                grid.appendChild(el);
            });
        }

        window.openOfferModal = () => {
            document.getElementById('offer-form').reset();
            document.getElementById('offer-id').value = '';
            document.getElementById('offer-modal').classList.add('active');
        };

        window.closeOfferModal = () => {
            document.getElementById('offer-modal').classList.remove('active');
        };

        document.getElementById('offer-image-file').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const url = await uploadImageToImgBB(file);
                if (url) {
                    document.getElementById('offer-image-url').value = url;
                    showToast('تم رفع الصورة بنجاح');
                }
            }
        });

        document.getElementById('offer-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('offer-id').value;
            const data = {
                sellerId: currentUser.uid,
                title: document.getElementById('offer-title').value,
                description: document.getElementById('offer-desc').value,
                price: Number(document.getElementById('offer-price').value),
                originalPrice: document.getElementById('offer-original-price').value ? Number(document.getElementById('offer-original-price').value) : null,
                imageUrl: document.getElementById('offer-image-url').value,
                createdAt: serverTimestamp()
            };

            try {
                if (id) {
                    await updateDoc(doc(db, "offers", id), data);
                    showToast("تم تحديث العرض");
                } else {
                    await addDoc(collection(db, "offers"), data);
                    showToast("تم إضافة العرض");
                }
                closeOfferModal();
            } catch (err) {
                console.error(err);
                showToast("خطأ في الحفظ", "error");
            }
        });

        window.deleteOffer = async (id) => {
            if (confirm("هل أنت متأكد من حذف هذا العرض؟")) {
                await deleteDoc(doc(db, "offers", id));
                showToast("تم الحذف");
            }
        };

        // Add-ons Logic
        window.addAddonItem = (name = '', price = '') => {
            const container = document.getElementById('addons-list');
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center addon-item";
            div.innerHTML = `
                <input type="text" placeholder="اسم الإضافة" value="${name}" class="flex-1 p-2 border rounded text-sm addon-name">
                <input type="number" placeholder="سعر" value="${price}" class="w-24 p-2 border rounded text-sm addon-price">
                <button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
            `;
            container.appendChild(div);

            // Clear inputs if adding new
            if (!name && !price) {
                document.getElementById('new-addon-name').value = '';
                document.getElementById('new-addon-price').value = '';
            }
        }

        // --- AI Description Logic ✨ ---
        window.generateAIDescription = () => {
            const name = document.getElementById('prod-name').value;
            const price = document.getElementById('prod-price').value;
            const catSelect = document.getElementById('prod-category');
            const category = catSelect.options[catSelect.selectedIndex]?.text || 'المنتج';

            if (!name) return showToast('يرجى كتابة اسم المنتج أولاً ⚠️', 'error');

            const btn = document.querySelector('button[onclick="window.generateAIDescription()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الكتابة...';
            btn.disabled = true;

            // Simulate AI Delay
            setTimeout(() => {
                const descriptions = [
                    `<p>استمتع بأفضل تجربة مع <strong>${name}</strong>. منتج رائع يجمع بين الجودة والأداء المتميز. مثالي لـ ${category}، ويأتي بسعر مميز <span style="color:green;font-weight:bold">${price} د.ج</span> فقط! اطلبه الآن قبل نفاذ الكمية.</p>`,
                    `<p>هل تبحث عن ${category} مميز؟ <strong>${name}</strong> هو الخيار الأمثل لك! تصميم عصري وجودة عالية تضمن لك الرضا التام. احصل عليه اليوم بسعر ${price} د.ج.</p>`,
                    `<p>لا تفوت فرصة اقتناء <strong>${name}</strong>. يعتبر من أفضل ما قدمنا في قسم ${category}. جودة تستحق الثقة وتوصيل سريع لباب منزلك. 🚚</p>`
                ];

                const randomDesc = descriptions[Math.floor(Math.random() * descriptions.length)];

                if (quill) {
                    quill.root.innerHTML = randomDesc;
                } else {
                    // Fallback
                }
                showToast('✨ تم توليد الوصف بنجاح');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 1500);
        };
        // --- Review Management ---

        function loadReviewsListener() {
            if (!currentUser) return;

            const q = query(
                collection(db, "reviews"),
                where("sellerId", "==", currentUser.uid),
                orderBy("createdAt", "desc")
            );

            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('reviews-tbody');
                const noMsg = document.getElementById('no-reviews-msg');

                if (snapshot.empty) {
                    tbody.innerHTML = '';
                    noMsg.classList.remove('hidden');
                    return;
                }

                noMsg.classList.add('hidden');
                tbody.innerHTML = snapshot.docs.map(doc => {
                    const r = doc.data();
                    const date = r.createdAt ? new Date(r.createdAt.seconds * 1000).toLocaleDateString('ar-EG') : '-';
                    const stars = Array(5).fill(0).map((_, i) => `<i class="fas fa-star ${i < r.rating ? 'text-yellow-400' : 'text-gray-300'} text-xs"></i>`).join('');

                    return `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="p-4">
                            <a href="PRESENTPRODUCT.html?product=${r.productId}" target="_blank" class="text-indigo-600 font-bold hover:underline text-sm block max-w-[150px] truncate">
                                ${r.productName || 'عرض المنتج'} <i class="fas fa-external-link-alt text-xs"></i>
                            </a>
                        </td>
                        <td class="p-4">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 overflow-hidden">
                                    ${r.userAvatar ? `<img src="${r.userAvatar}" class="w-full h-full object-cover">` : '<i class="fas fa-user"></i>'}
                                </div>
                                <span class="font-bold text-sm text-gray-700">${r.userName || 'مستخدم'}</span>
                            </div>
                        </td>
                        <td class="p-4">
                            <div class="flex">${stars}</div>
                        </td>
                        <td class="p-4">
                            <p class="text-sm text-gray-600 max-w-xs break-words">${r.comment || r.comment || ''}</p>
                        </td>
                        <td class="p-4 text-sm text-gray-500">${date}</td>
                        <td class="p-4 text-center">
                            <button onclick="deleteReview('${doc.id}', '${r.productId}', ${r.rating})" 
                                class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition" title="حذف التقييم">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    `;
                }).join('');
            });
        }

        window.deleteReview = async function (reviewId, productId, rating) {
            if (!confirm('هل أنت متأكد من حذف هذا التقييم؟')) return;

            try {
                await deleteDoc(doc(db, "reviews", reviewId));

                // Update product stats
                const productRef = doc(db, "products", productId);
                await runTransaction(db, async (transaction) => {
                    const sfDoc = await transaction.get(productRef);
                    if (!sfDoc.exists()) return;

                    const data = sfDoc.data();
                    let newCount = (data.reviewsCount || 1) - 1;
                    if (newCount < 0) newCount = 0;

                    let newRating = 0;
                    if (newCount > 0) {
                        const oldTotal = (data.rating || 0) * (data.reviewsCount || 1);
                        // Note: If rating field in product is accurate. 
                        // If it's slightly off due to float, this reversal might be slightly off.
                        // But it's usually acceptable. A full recalculation query would be more accurate but expensive.
                        newRating = (oldTotal - rating) / newCount;
                        if (newRating < 0) newRating = 0;
                        if (newRating > 5) newRating = 5;
                    }

                    transaction.update(productRef, {
                        rating: newRating,
                        reviewsCount: newCount
                    });
                });

                showToast('تم حذف التقييم بنجاح');
            } catch (error) {
                console.error("Error deleting review:", error);
                alert('حدث خطأ أثناء الحذف');
            }
        };
    </script>

    <script>
        // Bind Dashboard Buttons to ThemeManager
        document.addEventListener('DOMContentLoaded', () => {
            const themeToggleBtn = document.getElementById('theme-toggle');
            const eyeCareBtn = document.getElementById('eye-care-toggle');

            // Sync initial state
            if (themeToggleBtn) {
                const currentTheme = localStorage.getItem('s22-theme') || 'light';
                if (currentTheme === 'dark') themeToggleBtn.innerHTML = '<i class="fas fa-sun text-yellow-400"></i>';

                themeToggleBtn.addEventListener('click', () => {
                    const current = localStorage.getItem('s22-theme') || 'light';
                    const next = current === 'dark' ? 'light' : 'dark';
                    ThemeManager.applyTheme(next);
                    // Update Icon
                    if (next === 'dark') {
                        themeToggleBtn.innerHTML = '<i class="fas fa-sun text-yellow-400"></i>';
                    } else {
                        themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
                    }
                });
            }

            if (eyeCareBtn) {
                const isEyeCare = localStorage.getItem('s22-eye-care') === 'true';
                if (isEyeCare) {
                    eyeCareBtn.classList.replace('text-yellow-500', 'text-yellow-300');
                    eyeCareBtn.style.backgroundColor = 'rgba(234, 179, 8, 0.2)';
                }

                eyeCareBtn.addEventListener('click', () => {
                    ThemeManager.toggleEyeCare();
                    const isActive = document.documentElement.classList.contains('eye-care-active');
                    if (isActive) {
                        eyeCareBtn.style.backgroundColor = 'rgba(234, 179, 8, 0.2)';
                    } else {
                        eyeCareBtn.style.backgroundColor = '';
                    }
                });
            }
        });
    </script>
    <audio id="order-sound" src="alerta.mp3" preload="auto"></audio>
    <script type="module">
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { auth, db } from "./app-core.js";

        // Global User State
        window.currentUser = null;

        // Main Initialization
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Fetch full profile
                const userDoc = await getDoc(doc(db, "users", user.uid));
                window.currentUser = { ...user, ...(userDoc.exists() ? userDoc.data() : {}) };

                // Update UI Identity
                const nameDisplay = document.getElementById('shop-name');
                const dashboardName = document.getElementById('dashboard-store-name');
                const storeLinkDisplay = document.getElementById('store-link-display');

                if (window.currentUser.storeName) {
                    if (nameDisplay) nameDisplay.textContent = window.currentUser.storeName;
                    if (dashboardName) dashboardName.textContent = window.currentUser.storeName;
                }

                // Store Link
                const link = `${window.location.origin}/vendor.html?id=${user.uid}`;
                if (storeLinkDisplay) storeLinkDisplay.textContent = link;

                // Start Listeners (Call global functions)
                if (typeof window.loadOrdersListener === 'function') window.loadOrdersListener();
                if (typeof window.loadReviewsListener === 'function') window.loadReviewsListener();
                if (typeof window.loadDashboardStats === 'function') window.loadDashboardStats();

                // Request Notification Permission
                if (Notification.permission !== "granted") {
                    // Optional: Show a UI hint to enable notifications
                }

            } else {
                window.location.href = 'admin-login.html';
            }
        });
    </script>
</body>

</html>