<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S22 Market - Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¨Ø§Ø¦Ø¹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.6/purify.min.js"></script>
    <style>
        :root {
            --primary-color: #3b82f6;
            --bg-body: #f1f5f9;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-body);
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .small-loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 0.5rem;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Stats Card Animation */
        .stat-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        #user-menu-dropdown.show {
            display: block;
            animation: slideInUp 0.2s ease-out;
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 700px;
            z-index: 50;
            max-height: 90vh;
            overflow-y: auto;
        }

        .ql-toolbar {
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }

        .ql-container {
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            min-height: 120px;
        }

        .ql-editor {
            font-family: 'Tajawal', sans-serif;
        }

        .dashboard-tab {
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #475569;
            /* text-gray-600 */
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dashboard-tab:hover {
            color: #1e293b;
            /* text-gray-800 */
            background-color: #f8fafc;
            /* bg-gray-50 */
        }

        .dashboard-tab.active {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .dashboard-panel {
            animation: fadeIn 0.3s ease-out;
        }

        .responsive-table {
            border-collapse: collapse;
            width: 100%;
        }

        .responsive-table th,
        .responsive-table td {
            padding: 1rem;
            text-align: right;
            border-bottom: 1px solid #e2e8f0;
            /* border-gray-200 */
        }

        .responsive-table th {
            background-color: #f8fafc;
            /* bg-gray-50 */
            font-weight: 700;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: capitalize;
        }

        .status-new {
            background-color: #dbeafe;
            color: #1d4ed8;
        }

        .status-completed {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-canceled {
            background-color: #fee2e2;
            color: #991b1b;
        }

        @media (max-width: 768px) {
            .responsive-table thead {
                display: none;
            }

            .responsive-table tr {
                display: block;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 1rem;
                margin-bottom: 1rem;
                background-color: white;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            }

            .responsive-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 0;
                border-bottom: 1px solid #f3f4f6;
            }

            .responsive-table td:last-child {
                border-bottom: none;
            }

            .responsive-table td::before {
                content: attr(data-label);
                font-weight: 700;
                margin-left: 0.5rem;
                color: #4b5563;
                /* text-gray-600 */
            }
        }
    </style>
</head>

<body>

    <header class="bg-white shadow-sm sticky top-0 z-30">
        <div class="max-w-7xl mx-auto py-3 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-3">
                <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800">
                    S22<span class="text-blue-600">MARKET</span>
                </h1>
            </a>

            <div id="header-actions" class="flex items-center gap-4 relative">
                <a href="index.html" id="store-btn"
                    class="relative text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 px-5 py-2.5 rounded-full transition-colors flex items-center gap-2 shadow-lg">
                    <i class="fas fa-store"></i>
                    <span>Ø§Ù„Ù…ØªØ¬Ø±</span>
                </a>
                <a href="login.html" id="login-btn"
                    class="hidden relative text-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 px-5 py-2.5 rounded-full transition-colors items-center gap-2 sm:flex">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</span>
                </a>
                <div id="user-menu" class="hidden">
                    <button id="user-menu-button"
                        class="flex items-center gap-2 text-lg font-semibold text-gray-700 bg-green-100 hover:bg-green-200 px-5 py-2.5 rounded-full transition-colors">
                        <i class="fas fa-user-check text-green-700"></i>
                        <span id="user-menu-name">...</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div id="user-menu-dropdown"
                        class="hidden absolute left-0 top-full mt-2 w-60 bg-white rounded-xl shadow-lg border z-50 overflow-hidden">
                        <div class="p-3 border-b">
                            <p class="text-sm text-gray-500">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ</p>
                            <p class="font-bold text-gray-800" id="user-menu-displayname">...</p>
                        </div>
                        <a href="seller-dashboard.html"
                            class="block px-4 py-3 text-gray-700 bg-gray-100 font-bold transition-colors"><i
                                class="fas fa-store fa-fw ml-2 text-blue-400"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¨Ø§Ø¦Ø¹</a>
                        <a href="profile.html"
                            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i
                                class="fas fa-user-circle fa-fw ml-2 text-gray-400"></i> Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</a>
                        <a href="order_history.html"
                            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i
                                class="fas fa-archive fa-fw ml-2 text-gray-400"></i> Ø£Ø±Ø´ÙŠÙ Ø·Ù„Ø¨Ø§ØªÙŠ</a>
                        <a href="loyalty_card.html"
                            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i
                                class="fas fa-star fa-fw ml-2 text-orange-400"></i> Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆÙØ§Ø¡</a>
                        <button id="logout-btn"
                            class="w-full text-right px-4 py-3 text-red-600 hover:bg-red-50 border-t transition-colors"><i
                                class="fas fa-sign-out-alt fa-fw ml-2"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                    </div>
                </div>
            </div>

        </div>
    </header>

    <main class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">

        <div id="auth-loader" class="text-center py-20">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600 text-lg">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙˆÙŠØªÙƒ...</p>
        </div>

        <div id="seller-content" class="hidden" style="animation: slideInUp 0.5s ease-out;">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-6">
                <i class="fas fa-store text-blue-500"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¨Ø§Ø¦Ø¹
            </h1>

            <div class="border-b border-gray-200 bg-white rounded-t-lg shadow-sm">
                <nav class="flex -mb-px overflow-x-auto" aria-label="Tabs">
                    <button class="dashboard-tab active" data-target="overview-panel">
                        <i class="fas fa-chart-pie ml-2"></i> Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©
                    </button>
                    <button class="dashboard-tab" data-target="products-panel">
                        <i class="fas fa-boxes ml-2"></i> Ù…Ù†ØªØ¬Ø§ØªÙŠ
                    </button>
                    <button class="dashboard-tab" data-target="orders-panel">
                        <i class="fas fa-clipboard-list ml-2"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
                    </button>
                    <button class="dashboard-tab" data-target="customers-panel">
                        <i class="fas fa-users ml-2"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (CRM)
                    </button>
                    <button class="dashboard-tab" data-target="messages-panel">
                        <i class="fas fa-envelope-open-text ml-2"></i> Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                    </button>
                    <button class="dashboard-tab" data-target="settings-panel">
                        <i class="fas fa-cog ml-2"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±
                    </button>
                </nav>
            </div>


            <!-- Overview Panel -->
            <div id="overview-panel" class="dashboard-panel bg-white p-6 rounded-b-lg shadow-sm">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Stats Cards -->
                    <div class="stat-card bg-indigo-50 p-6 rounded-xl border border-indigo-100">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-indigo-600 font-bold text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</p>
                                <h3 class="text-3xl font-extrabold text-indigo-900 mt-2" id="stat-total-sales">0 Ø¯.Ø¬
                                </h3>
                            </div>
                            <div class="p-3 bg-white rounded-lg shadow-sm text-indigo-600">
                                <i class="fas fa-wallet text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card bg-green-50 p-6 rounded-xl border border-green-100">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-green-600 font-bold text-sm">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</p>
                                <h3 class="text-3xl font-extrabold text-green-900 mt-2" id="stat-orders-count">0</h3>
                            </div>
                            <div class="p-3 bg-white rounded-lg shadow-sm text-green-600">
                                <i class="fas fa-check-circle text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card bg-orange-50 p-6 rounded-xl border border-orange-100">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-orange-600 font-bold text-sm">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</p>
                                <h3 class="text-3xl font-extrabold text-orange-900 mt-2" id="stat-new-orders">0</h3>
                            </div>
                            <div class="p-3 bg-white rounded-lg shadow-sm text-orange-600">
                                <i class="fas fa-bell text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card bg-blue-50 p-6 rounded-xl border border-blue-100">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-blue-600 font-bold text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</p>
                                <h3 class="text-3xl font-extrabold text-blue-900 mt-2" id="stat-products-count">0</h3>
                            </div>
                            <div class="p-3 bg-white rounded-lg shadow-sm text-blue-600">
                                <i class="fas fa-box text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Quick Actions -->
                    <div class="bg-white border rounded-xl p-6">
                        <h3 class="font-bold text-gray-800 mb-4">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <button
                                onclick="document.querySelector('[data-target=\'products-panel\']').click(); setTimeout(()=>document.getElementById('add-product-btn').click(), 100);"
                                class="p-4 bg-gray-50 hover:bg-gray-100 rounded-lg text-center transition">
                                <i class="fas fa-plus text-2xl text-green-500 mb-2"></i>
                                <p class="font-bold text-sm">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</p>
                            </button>
                            <button onclick="document.querySelector('[data-target=\'settings-panel\']').click()"
                                class="p-4 bg-gray-50 hover:bg-gray-100 rounded-lg text-center transition">
                                <i class="fas fa-cog text-2xl text-gray-500 mb-2"></i>
                                <p class="font-bold text-sm">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</p>
                            </button>
                        </div>
                    </div>
                    <!-- Recent Tips -->
                    <div
                        class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-xl p-6 text-white relative overflow-hidden">
                        <div class="relative z-10">
                            <h3 class="font-bold text-xl mb-2">ğŸ’¡ Ù†ØµÙŠØ­Ø© Ù„Ø²ÙŠØ§Ø¯Ø© Ù…Ø¨ÙŠØ¹Ø§ØªÙƒ</h3>
                            <p class="text-indigo-100 leading-relaxed">Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« ØµÙˆØ± Ù…Ù†ØªØ¬Ø§ØªÙƒ Ø¨Ø§Ù†ØªØ¸Ø§Ù… ÙˆØ´Ø§Ø±Ùƒ Ø±Ø§Ø¨Ø· Ù…ØªØ¬Ø±Ùƒ
                                Ø¹Ù„Ù‰ Ù…Ù†ØµØ§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¸Ù‡ÙˆØ±.</p>
                        </div>
                        <i class="fas fa-lightbulb absolute -bottom-4 -left-4 text-9xl text-white opacity-10"></i>
                    </div>
                </div>
            </div>

            <div id="products-panel" class="dashboard-panel bg-white p-6 rounded-b-lg shadow-sm hidden">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">
                        Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†ØªØ¬Ø§ØªÙƒ
                    </h2>
                    <button id="add-product-btn"
                        class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-colors flex items-center justify-center gap-2">
                        <i class="fas fa-plus-circle"></i>
                        <span>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</span>
                    </button>
                </div>

                <div id="products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>

                <div id="no-products-msg" class="hidden text-center py-20">
                    <i class="fas fa-box-open text-5xl text-gray-400"></i>
                    <p class="mt-4 text-xl font-semibold text-gray-500">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯.</p>
                    <p class="mt-2 text-gray-500">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯" Ù„Ù„Ø¨Ø¯Ø¡.</p>
                </div>
            </div>

            <div id="orders-panel" class="dashboard-panel bg-white p-6 rounded-b-lg shadow-sm hidden">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">
                        Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬Ø§ØªÙƒ
                    </h2>
                </div>

                <div id="orders-list-container" class="overflow-x-auto">
                    <div class="space-y-4 py-4" id="orders-loader">
                        <div class="bg-gray-50 border rounded-lg p-4 flex justify-between items-center">
                            <div class="space-y-2 w-1/3">
                                <div class="h-4 bg-gray-200 rounded skeleton w-3/4"></div>
                                <div class="h-4 bg-gray-200 rounded skeleton w-1/2"></div>
                            </div>
                            <div class="h-8 bg-gray-200 rounded skeleton w-20"></div>
                        </div>
                        <div class="bg-gray-50 border rounded-lg p-4 flex justify-between items-center">
                            <div class="space-y-2 w-1/3">
                                <div class="h-4 bg-gray-200 rounded skeleton w-3/4"></div>
                                <div class="h-4 bg-gray-200 rounded skeleton w-1/2"></div>
                            </div>
                            <div class="h-8 bg-gray-200 rounded skeleton w-20"></div>
                        </div>
                    </div>
                    <table class="w-full text-right responsive-table hidden" id="orders-table">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-4">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th>
                                <th class="p-4">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                <th class="p-4">Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th class="p-4">Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                                <th class="p-4">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                <th class="p-4">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th class="p-4">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body"></tbody>
                    </table>
                    <div id="no-orders-msg" class="hidden text-center py-20">
                        <i class="fas fa-clipboard-list text-5xl text-gray-400"></i>
                        <p class="mt-4 text-xl font-semibold text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ø±Ø¯Ø© Ø¨Ø¹Ø¯.</p>
                    </div>
                </div>
            </div>

            <div id="messages-panel" class="dashboard-panel bg-white p-6 rounded-b-lg shadow-sm hidden">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">
                        Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª
                    </h2>
                </div>

                <div id="messages-list-container" class="overflow-x-auto">
                    <div class="text-center py-20" id="messages-loader">
                        <div class="loader mx-auto"></div>
                        <p class="mt-4 text-gray-500">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</p>
                    </div>
                    <table class="w-full text-right responsive-table hidden" id="messages-table">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-4">Ø§Ù„Ù…Ø±Ø³Ù„</th>
                                <th class="p-4">Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th class="p-4">Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th>
                                <th class="p-4">Ø¨Ø®ØµÙˆØµ Ù…Ù†ØªØ¬</th>
                                <th class="p-4">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            </tr>
                        </thead>
                        <tbody id="messages-table-body"></tbody>
                    </table>
                    <div id="no-messages-msg" class="hidden text-center py-20">
                        <i class="fas fa-envelope-open-text text-5xl text-gray-400"></i>
                        <p class="mt-4 text-xl font-semibold text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ø±Ø¯Ø© Ø¨Ø¹Ø¯.</p>
                    </div>
                </div>
            </div>

            <!-- Customer Log Panel -->
            <div id="customers-panel" class="dashboard-panel bg-white p-6 rounded-b-lg shadow-sm hidden">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">
                        Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (CRM)
                    </h2>
                    <div class="text-sm text-gray-500">
                        ÙŠØªÙ… Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                    </div>
                </div>

                <div id="customers-list-container" class="overflow-x-auto">
                    <div class="text-center py-20" id="customers-loader">
                        <div class="loader mx-auto"></div>
                        <p class="mt-4 text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...</p>
                    </div>

                    <div class="mb-4 flex gap-4">
                        <input type="text" id="customer-search" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…..."
                            class="p-2 border rounded-lg w-full max-w-md">
                    </div>

                    <table class="w-full text-right responsive-table hidden" id="customers-table">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-4">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                <th class="p-4">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th class="p-4">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th>
                                <th class="p-4">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</th>
                                <th class="p-4">Ø¢Ø®Ø± Ø·Ù„Ø¨</th>
                                <th class="p-4">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø¹ØªØ§Ø¯</th>
                            </tr>
                        </thead>
                        <tbody id="customers-table-body"></tbody>
                    </table>
                    <div id="no-customers-msg" class="hidden text-center py-20">
                        <i class="fas fa-users-slash text-5xl text-gray-400"></i>
                        <p class="mt-4 text-xl font-semibold text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>
                    </div>
                </div>
            </div>

            <!-- Store Settings Panel -->
            <div id="settings-panel" class="dashboard-panel bg-white p-6 rounded-b-lg shadow-sm hidden">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">
                        Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±
                    </h2>
                    <a href="store-orders-screen.html" target="_blank"
                        class="bg-gray-800 hover:bg-black text-white px-6 py-2 rounded-lg shadow-lg font-bold flex items-center gap-2 transition-transform transform hover:scale-105">
                        <i class="fas fa-desktop"></i>
                        Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø·Ø¨Ø® (KDS)
                    </a>
                </div>

                <form id="store-settings-form" class="space-y-6 max-w-2xl mx-auto">
                    <!-- Basic Info -->
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <h3 class="font-bold text-lg mb-4 text-indigo-700">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block font-semibold mb-1">Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·</label>
                                <select id="set-store-type" class="w-full p-2 border rounded bg-gray-100" disabled>
                                    <option value="vendor">Ù…ØªØ¬Ø± Ø¹Ø§Ù…</option>
                                    <option value="restaurant">Ù…Ø·Ø¹Ù…</option>
                                </select>
                            </div>
                            <div>
                                <label class="block font-semibold mb-1">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±</label>
                                <input type="text" id="set-store-name" class="w-full p-2 border rounded" required>
                            </div>
                            <div>
                                <label class="block font-semibold mb-1">ÙˆØµÙ Ø§Ù„Ù…ØªØ¬Ø±</label>
                                <textarea id="set-store-desc" class="w-full p-2 border rounded" rows="3"></textarea>
                            </div>
                            <div>
                                <label class="block font-semibold mb-1">Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø¯.Ø¬)</label>
                                <input type="number" id="set-store-delivery" class="w-full p-2 border rounded"
                                    placeholder="200">
                            </div>
                            <div>
                                <label class="block font-semibold mb-1">Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø± (Logo URL)</label>
                                <input type="url" id="set-logo-url" class="w-full p-2 border rounded"
                                    placeholder="https://...">
                            </div>
                            <div>
                                <label class="block font-semibold mb-1">Ø±Ø§Ø¨Ø· Ø§Ù„ØºÙ„Ø§Ù (Cover URL)</label>
                                <input type="url" id="set-cover-url" class="w-full p-2 border rounded"
                                    placeholder="https://...">
                            </div>
                        </div>
                    </div>

                    <!-- Social Links -->
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <h3 class="font-bold text-lg mb-4 text-indigo-700">Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„</h3>
                        <div class="space-y-4">
                            <div class="flex items-center gap-2">
                                <i class="fab fa-facebook text-blue-600 w-6 text-center text-xl"></i>
                                <input type="url" id="set-fb" class="w-full p-2 border rounded text-sm"
                                    placeholder="Facebook URL">
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fab fa-instagram text-pink-600 w-6 text-center text-xl"></i>
                                <input type="url" id="set-insta" class="w-full p-2 border rounded text-sm"
                                    placeholder="Instagram URL">
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fab fa-telegram text-blue-400 w-6 text-center text-xl"></i>
                                <input type="url" id="set-telegram" class="w-full p-2 border rounded text-sm"
                                    placeholder="Telegram URL">
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-phone text-green-600 w-6 text-center text-xl"></i>
                                <input type="tel" id="set-phone" class="w-full p-2 border rounded text-sm"
                                    placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…ØªØ¬Ø±">
                            </div>
                        </div>
                    </div>

                    <!-- Store Actions -->
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <h3 class="font-bold text-lg mb-4 text-indigo-700">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø£Ø®Ø±Ù‰</h3>
                        <div class="flex flex-col gap-3">
                            <div class="flex items-center justify-between bg-white p-3 rounded border">
                                <div>
                                    <span class="font-bold block">ÙØªØ­ / Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØ¬Ø±</span>
                                    <span class="text-xs text-gray-500">Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ØŒ Ù„Ù† ÙŠØ¸Ù‡Ø± Ø²Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡.</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="set-is-open" class="sr-only peer">
                                    <div
                                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                                    </div>
                                </label>
                            </div>

                            <div class="flex gap-2">
                                <button type="button" onclick="copyStoreLink()"
                                    class="flex-1 bg-blue-100 text-blue-700 py-2 rounded hover:bg-blue-200 font-bold">
                                    <i class="fas fa-link ml-1"></i> Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
                                </button>
                                <button type="button" onclick="requestClosure()"
                                    class="flex-1 bg-red-100 text-red-700 py-2 rounded hover:bg-red-200 font-bold">
                                    <i class="fas fa-door-closed ml-1"></i> Ø¥ØºÙ„Ø§Ù‚ Ù†Ù‡Ø§Ø¦ÙŠ
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end pt-4">
                        <button type="submit" id="save-settings-btn"
                            class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 font-bold shadow-lg transform transition hover:scale-105">
                            Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                        </button>
                    </div>
                </form>
            </div>
            <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold text-gray-800">
                    Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±
                </h2>
                <a href="store-orders-screen.html" target="_blank"
                    class="bg-gray-800 hover:bg-black text-white px-6 py-2 rounded-lg shadow-lg font-bold flex items-center gap-2 transition-transform transform hover:scale-105">
                    <i class="fas fa-desktop"></i>
                    Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø·Ø¨Ø® (KDS)
                </a>
            </div>

            <form id="store-settings-form" class="space-y-6 max-w-2xl mx-auto">
                <!-- Basic Info -->
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <h3 class="font-bold text-lg mb-4 text-indigo-700">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block font-semibold mb-1">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±</label>
                            <input type="text" id="set-store-name" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block font-semibold mb-1">ÙˆØµÙ Ø§Ù„Ù…ØªØ¬Ø±</label>
                            <textarea id="set-store-desc" class="w-full p-2 border rounded" rows="3"></textarea>
                        </div>
                        <div>
                            <label class="block font-semibold mb-1">Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø± (Logo URL)</label>
                            <input type="url" id="set-logo-url" class="w-full p-2 border rounded"
                                placeholder="https://...">
                        </div>
                        <div>
                            <label class="block font-semibold mb-1">Ø±Ø§Ø¨Ø· Ø§Ù„ØºÙ„Ø§Ù (Cover URL)</label>
                            <input type="url" id="set-cover-url" class="w-full p-2 border rounded"
                                placeholder="https://...">
                        </div>
                    </div>
                </div>

                <!-- Social Links -->
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <h3 class="font-bold text-lg mb-4 text-indigo-700">Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„</h3>
                    <div class="space-y-4">
                        <div class="flex items-center gap-2">
                            <i class="fab fa-facebook text-blue-600 w-6 text-center text-xl"></i>
                            <input type="url" id="set-fb" class="w-full p-2 border rounded text-sm"
                                placeholder="Facebook URL">
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fab fa-instagram text-pink-600 w-6 text-center text-xl"></i>
                            <input type="url" id="set-insta" class="w-full p-2 border rounded text-sm"
                                placeholder="Instagram URL">
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fab fa-telegram text-blue-400 w-6 text-center text-xl"></i>
                            <input type="url" id="set-telegram" class="w-full p-2 border rounded text-sm"
                                placeholder="Telegram URL">
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-phone text-green-600 w-6 text-center text-xl"></i>
                            <input type="tel" id="set-phone" class="w-full p-2 border rounded text-sm"
                                placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…ØªØ¬Ø±">
                        </div>
                    </div>
                </div>

                <!-- Store Actions -->
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <h3 class="font-bold text-lg mb-4 text-indigo-700">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø£Ø®Ø±Ù‰</h3>
                    <div class="flex flex-col gap-3">
                        <div class="flex items-center justify-between bg-white p-3 rounded border">
                            <div>
                                <span class="font-bold block">ÙØªØ­ / Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØ¬Ø±</span>
                                <span class="text-xs text-gray-500">Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ØŒ Ù„Ù† ÙŠØ¸Ù‡Ø± Ø²Ø± Ø§Ù„Ø´Ø±Ø§Ø¡.</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="set-is-open" class="sr-only peer">
                                <div
                                    class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                                </div>
                            </label>
                        </div>

                        <div class="flex gap-2">
                            <button type="button" onclick="copyStoreLink()"
                                class="flex-1 bg-blue-100 text-blue-700 py-2 rounded hover:bg-blue-200 font-bold">
                                <i class="fas fa-link ml-1"></i> Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØ¬Ø±
                            </button>
                            <button type="button" onclick="requestClosure()"
                                class="flex-1 bg-red-100 text-red-700 py-2 rounded hover:bg-red-200 font-bold">
                                <i class="fas fa-door-closed ml-1"></i> Ø·Ù„Ø¨ Ø¥ØºÙ„Ø§Ù‚ Ù†Ù‡Ø§Ø¦ÙŠ
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end pt-4">
                    <button type="submit" id="save-settings-btn"
                        class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 font-bold shadow-lg transform transition hover:scale-105">
                        Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                    </button>
                </div>
            </form>
        </div>
        <div id="settings-panel" class="dashboard-panel bg-white p-6 rounded-b-lg shadow-sm hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø§Ù„Ù…Ø·Ø¹Ù… / Ø§Ù„Ù…ØªØ¬Ø±)</h2>

            <form id="store-settings-form" class="space-y-6 max-w-2xl">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±/Ø§Ù„Ù…Ø·Ø¹Ù…</label>
                        <input type="text" id="store-name"
                            class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                            placeholder="Ù…Ø«Ø§Ù„: Ù…Ø·Ø¹Ù… Ø§Ù„Ø¨ÙŠØªØ²Ø§ Ø§Ù„Ù„Ø°ÙŠØ°Ø©">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·</label>
                        <select id="store-type" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                            disabled>
                            <option value="vendor">Ù…ØªØ¬Ø± Ø¹Ø§Ù…</option>
                            <option value="restaurant">Ù…Ø·Ø¹Ù…</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p>
                    </div>
                </div>

                <div>
                    <label class="block text-gray-700 font-bold mb-2">ÙˆØµÙ Ø§Ù„Ù…ØªØ¬Ø± (ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡)</label>
                    <textarea id="store-desc" rows="3"
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Ù†Ù‚Ø¯Ù… Ù„ÙƒÙ… Ø£Ø´Ù‡Ù‰ Ø§Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª..."></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù (Cover URL)</label>
                        <input type="url" id="store-cover"
                            class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                            placeholder="https://...">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø± (Logo URL)</label>
                        <input type="url" id="store-logo"
                            class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                            placeholder="https://...">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</label>
                        <input type="number" id="store-delivery"
                            class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="200">
                    </div>
                    <div class="flex items-center gap-4 mt-8">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="store-open" class="form-checkbox h-6 w-6 text-green-600">
                            <span class="mr-2 text-gray-700 font-bold">Ø§Ù„Ù…ØªØ¬Ø± Ù…ÙØªÙˆØ­ Ø§Ù„Ø¢Ù†</span>
                        </label>
                    </div>
                </div>

                <div class="pt-4 border-t">
                    <button type="submit" id="save-settings-btn"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                        Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                    </button>
                </div>
            </form>
        </div>
        </div>
    </main>

    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, getDocs, query, where, serverTimestamp, Timestamp, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQwj4Sb7n40wey9UwsG_3fYPn7yg8KnrY",
            authDomain: "s22market-4e3e6.firebaseapp.com",
            projectId: "s22market-4e3e6",
            storageBucket: "s22market-4e3e6.appspot.com",
            messagingSenderId: "119186699901",
            appId: "1:119186699901:web:1b04100b5c5c40f5ca2314",
            measurementId: "G-MWYNCVP4WQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Animated Counter Function
        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    obj.innerHTML = end.toLocaleString(); // Ensure final value
                }
            };
            window.requestAnimationFrame(step);
        }

        let currentUser = null;
        let sellerProductsCache = [];
        let categoriesCache = [];
        let quillEditor = null;

        const getEl = (id) => document.getElementById(id);
        const getVal = (id) => getEl(id)?.value || '';
        const getNum = (id) => parseFloat(getVal(id));
        const getChecked = (id) => getEl(id)?.checked || false;

        // Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const loginBtn = document.getElementById('login-btn');
        const userMenu = document.getElementById('user-menu');
        const userMenuButton = document.getElementById('user-menu-button');
        const userMenuDropdown = document.getElementById('user-menu-dropdown');
        const userMenuName = document.getElementById('user-menu-name');
        const userMenuDisplayName = document.getElementById('user-menu-displayname');
        const logoutBtn = document.getElementById('logout-btn');
        const authLoader = document.getElementById('auth-loader');
        const sellerContent = document.getElementById('seller-content');
        const modalContainer = document.getElementById('modal-container');

        // Ø¹Ù†Ø§ØµØ± Ù„ÙˆØ­Ø© "Ù…Ù†ØªØ¬Ø§ØªÙŠ"
        const addProductBtn = document.getElementById('add-product-btn');
        const productsList = document.getElementById('products-list');
        const noProductsMsg = document.getElementById('no-products-msg');

        // Ø¹Ù†Ø§ØµØ± Ù„ÙˆØ­Ø© "Ø§Ù„Ø·Ù„Ø¨Ø§Øª"
        const ordersLoader = document.getElementById('orders-loader');
        const ordersTable = document.getElementById('orders-table');
        const ordersTableBody = document.getElementById('orders-table-body');
        const noOrdersMsg = document.getElementById('no-orders-msg');

        const messagesLoader = document.getElementById('messages-loader');
        const messagesTable = document.getElementById('messages-table');
        const messagesTableBody = document.getElementById('messages-table-body');
        const noMessagesMsg = document.getElementById('no-messages-msg');

        const tabs = document.querySelectorAll('.dashboard-tab');
        const panels = document.querySelectorAll('.dashboard-panel');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const targetPanelId = tab.dataset.target;
                panels.forEach(panel => {
                    panel.classList.toggle('hidden', panel.id !== targetPanelId);
                });

                if (targetPanelId === 'overview-panel' && !tab.dataset.loaded) {
                    loadOverviewData();
                    tab.dataset.loaded = 'true';
                }
                if (targetPanelId === 'orders-panel' && !tab.dataset.loaded) {
                    loadSellerOrders();
                    tab.dataset.loaded = 'true';
                }
                if (targetPanelId === 'messages-panel' && !tab.dataset.loaded) {
                    loadSellerMessages();
                    tab.dataset.loaded = 'true';
                }
                if (targetPanelId === 'customers-panel' && !tab.dataset.loaded) {
                    loadCustomerLog();
                    tab.dataset.loaded = 'true';
                }
            });
        });

        async function loadOverviewData() {
            // Fetch basic stats
            try {
                // Products Count
                const productsSnap = await getDocs(query(collection(db, "products"), where("sellerId", "==", currentUser.uid)));
                const productsCount = productsSnap.size;
                animateValue(document.getElementById('stat-products-count'), 0, productsCount, 1500);

                // Orders Stats
                const ordersSnap = await getDocs(query(collection(db, "orders"), where("sellerId", "==", currentUser.uid)));
                let totalSales = 0;
                let completedCount = 0;
                let newCount = 0;

                ordersSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'completed') {
                        completedCount++;
                        totalSales += (data.totalPrice || 0);
                    } else if (data.status === 'new') {
                        newCount++;
                    }
                });

                document.getElementById('stat-total-sales').textContent = totalSales.toLocaleString() + ' Ø¯.Ø¬'; // No animation for text+currency yet
                animateValue(document.getElementById('stat-orders-count'), 0, completedCount, 1500);
                animateValue(document.getElementById('stat-new-orders'), 0, newCount, 1500);

            } catch (e) {
                console.error("Error loading overview:", e);
            }
        }

        // === (CRM: Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡) ===
        async function loadCustomerLog() {
            const customersLoader = document.getElementById('customers-loader');
            const noCustomersMsg = document.getElementById('no-customers-msg');
            const customersTable = document.getElementById('customers-table');
            const tbody = document.getElementById('customers-table-body');
            const searchInput = document.getElementById('customer-search');

            try {
                // Fetch all orders to analyze customers
                // Note: In a production app with huge data, you'd want a separate 'customers' collection
                // or use a cloud function to aggregate this. For now, client-side aggregation is fine.
                const q = query(collection(db, "orders"), where("sellerId", "==", currentUser.uid), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);

                const customersMap = new Map();

                querySnapshot.docs.forEach(doc => {
                    const order = doc.data();
                    const phone = order.customerContact || 'unknown';

                    if (!customersMap.has(phone)) {
                        customersMap.set(phone, {
                            name: order.customerName,
                            phone: phone,
                            orderCount: 0,
                            totalSpent: 0,
                            lastOrder: null,
                            address: order.customerLocation
                        });
                    }

                    const entry = customersMap.get(phone);
                    entry.orderCount += 1;
                    entry.totalSpent += (order.totalPrice || 0);
                    if (!entry.lastOrder) entry.lastOrder = order.createdAt; // First one is latest due to orderBy desc
                });

                let customers = Array.from(customersMap.values());

                // Render Function
                const renderCustomers = (list) => {
                    tbody.innerHTML = '';
                    if (list.length === 0) {
                        customersTable.classList.add('hidden');
                        if (customers.length === 0) noCustomersMsg.classList.remove('hidden'); // No customers at all
                    } else {
                        noCustomersMsg.classList.add('hidden');
                        customersTable.classList.remove('hidden');
                        list.forEach(c => {
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-50';
                            row.innerHTML = `
                                <td data-label="Ø§Ù„Ø¹Ù…ÙŠÙ„" class="p-4 font-bold text-gray-800">${c.name}</td>
                                <td data-label="Ø§Ù„Ù‡Ø§ØªÙ" class="p-4 font-mono dir-ltr">${c.phone}</td>
                                <td data-label="Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª" class="p-4 text-center"><span class="bg-blue-100 text-blue-800 py-1 px-3 rounded-full text-sm font-bold">${c.orderCount}</span></td>
                                <td data-label="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ" class="p-4 font-bold text-green-600">${c.totalSpent.toLocaleString()} Ø¯.Ø¬</td>
                                <td data-label="Ø¢Ø®Ø± Ø·Ù„Ø¨" class="p-4 text-sm text-gray-500">${c.lastOrder?.toDate().toLocaleDateString('ar-EG') || '-'}</td>
                                <td data-label="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" class="p-4 text-sm truncate max-w-xs" title="${c.address}">${c.address}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                };

                customersLoader.classList.add('hidden');
                renderCustomers(customers);

                // Search Logic
                searchInput.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = customers.filter(c =>
                        (c.name && c.name.toLowerCase().includes(term)) ||
                        (c.phone && c.phone.includes(term))
                    );
                    renderCustomers(filtered);
                });

            } catch (error) {
                console.error("Error loading customer log:", error);
                customersLoader.innerHTML = '<p class="text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>';
            }
        }

        // --- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ---
        async function loadCategories() {
            try {
                const snapshot = await getDocs(query(collection(db, "categories"), orderBy("orderIndex")));
                categoriesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) { console.error("Error loading categories", e); }
        }

        async function uploadImageToImgBB(file) {
            const apiKey = "ac296feb5a275923598bdbfd4f9aed8c";
            const formData = new FormData();
            formData.append('image', file);
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, { method: 'POST', body: formData });
                if (!response.ok) return { success: false, error: 'Upload failed' };
                const result = await response.json();
                if (result.success) return { success: true, url: result.data.url };
                else return { success: false, error: result.error.message };
            } catch (error) { return { success: false, error: 'Network error' }; }
        }
        function resizeAndCompressImage(file, maxWidth = 800, quality = 0.85) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let { width, height } = img;
                        if (width > maxWidth) { const scale = maxWidth / width; width = maxWidth; height = height * scale; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob(blob => { resolve(new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() })); }, 'image/jpeg', quality);
                    }; img.onerror = reject;
                }; reader.onerror = reject;
            });
        }

        // --- (Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª Ù†Ø§Ù‚ØµØ©) ---
        function showProductModal(product = null) {
            const productType = product?.productType || 'regular';
            let title = product ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯';

            const categoryOptions = categoriesCache.map(cat => `<option value="${cat.id}" ${product && product.categoryId === cat.id ? 'selected' : ''}>${cat.name}</option>`).join('');
            let existingImages = product ? (product.imageUrls || (product.imageUrl ? [product.imageUrl] : [])) : [];
            const existingImagesHTML = existingImages.map(url => `<div class="relative group"><img src="${url}" class="w-16 h-16 rounded object-cover border"><div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><span class="text-white text-xs">Ø­Ø°ÙØŸ</span></div></div>`).join('');

            const content = `
                <div class="space-y-4">
                     <div>
                        <label class="font-semibold block mb-1">Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬</label>
                        <select id="product-type" class="w-full p-2 border rounded bg-white">
                            <option value="regular" ${productType === 'regular' ? 'selected' : ''}>Ù…Ù†ØªØ¬ Ø¹Ø§Ø¯ÙŠ (Ø¨ÙŠØ¹ Ù…Ø¨Ø§Ø´Ø±)</option>
                            <option value="direct" ${productType === 'direct' ? 'selected' : ''}>Ø®Ø¯Ù…Ø© / ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø± (Ø­Ø±Ù, Ù…Ø·Ø§Ø¹Ù…...)</option>
                        </select>
                    </div>

                    <div id="direct-contact-fields" class="${productType === 'direct' ? '' : 'hidden'} bg-blue-50 p-3 rounded border border-blue-200">
                        <p class="text-sm text-blue-800 mb-2">ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ØŒ Ø³ÙŠØ¸Ù‡Ø± Ø²Ø± "Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†" Ø§Ù„Ø°ÙŠ ÙŠÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø£Ùˆ ÙÙŠØ³Ø¨ÙˆÙƒ Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ.</p>
                        <input type="text" id="contact-whatsapp" class="w-full p-2 border rounded mb-2" placeholder="Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ (Ù…Ø«Ø§Ù„: 0712345678)" value="${product?.directContactLinks?.whatsapp || ''}">
                        <input type="text" id="contact-phone" class="w-full p-2 border rounded" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" value="${product?.directContactLinks?.phone || ''}">
                    </div>

                    <div><label class="font-semibold">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬/Ø§Ù„Ø®Ø¯Ù…Ø©</label><input type="text" id="product-name-input" class="w-full p-2 border rounded mt-1" value="${product?.name?.replace(/<[^>]*>?/gm, '') || ''}"></div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="font-semibold">Ø§Ù„Ø³Ø¹Ø± (Ø¯.Ø¬)</label><input type="number" id="product-price" class="w-full p-2 border rounded mt-1" value="${product?.price || ''}"></div>
                        <div><label class="font-semibold">Ø§Ù„Ù‚Ø³Ù…</label><select id="product-category" class="w-full p-2 border rounded mt-1"><option value="">Ø§Ø®ØªØ±...</option>${categoryOptions}</select></div>
                    </div>

                    <div><label class="font-semibold">Ø§Ù„ÙˆØµÙ</label><div id="product-description-editor" class="bg-white" style="min-height: 100px;"></div></div>

                    <div>
                        <label class="font-semibold">ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬</label>
                        <input type="file" id="product-images" class="w-full mt-1 text-sm text-gray-500" multiple accept="image/*">
                        <div class="flex gap-2 mt-2 flex-wrap">${existingImagesHTML}</div>
                    </div>
                </div>`;

            let quill;
            showModal(title, content, async () => { // onConfirm
                const name = getVal('product-name-input');
                const price = getNum('product-price');
                const categoryId = getVal('product-category');
                const type = getVal('product-type');
                const desc = quill.root.innerHTML;
                const imageFiles = getEl('product-images').files;

                if (!name || !categoryId || (type === 'regular' && !price)) return alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø³Ø¹Ø±ØŒ Ø§Ù„Ù‚Ø³Ù…)');

                showLoadingModal('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...');

                let imageUrls = product ? (product.imageUrls || []) : [];
                if (imageFiles.length > 0) {
                    const uploads = await Promise.all(Array.from(imageFiles).map(f => resizeAndCompressImage(f).then(uploadImageToImgBB)));
                    const success = uploads.filter(u => u.success).map(u => u.url);
                    if (success.length > 0) imageUrls = success; // Replace for now, can be append logic if needed
                }

                if (imageUrls.length === 0) { closeModal(); return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); }

                const data = {
                    name, price: price || 0, description: desc, categoryId, productType: type, imageUrls,
                    sellerId: currentUser.uid, sellerName: currentUser.displayName || 'Ø¨Ø§Ø¦Ø¹',
                    updatedAt: serverTimestamp()
                };

                if (type === 'direct') {
                    data.directContactLinks = {
                        whatsapp: getVal('contact-whatsapp'),
                        phone: getVal('contact-phone')
                    };
                }

                try {
                    if (product) {
                        await updateDoc(doc(db, "products", product.id), data);
                    } else {
                        data.createdAt = serverTimestamp();
                        await addDoc(collection(db, "products"), data);
                    }
                    closeModal();
                    loadSellerProducts(currentUser); // Refresh
                } catch (e) {
                    console.error(e);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + e.message);
                    closeModal();
                }
            });

            quill = new Quill('#product-description-editor', { theme: 'snow', modules: { toolbar: [['bold', 'italic'], [{ 'list': 'ordered' }, { 'list': 'bullet' }]] } });
            if (product?.description) quill.root.innerHTML = product.description;

            getEl('product-type').addEventListener('change', (e) => {
                getEl('direct-contact-fields').classList.toggle('hidden', e.target.value !== 'direct');
            });
        }

        function showModal(title, content, onConfirm) {
            modalContainer.innerHTML = `
                <div class="modal-backdrop" id="modal-backdrop">
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-4 border-b pb-3">
                            <h3 class="text-xl font-bold">${title}</h3>
                            <button onclick="document.getElementById('modal-container').innerHTML=''" class="text-gray-400 text-2xl">&times;</button>
                        </div>
                        <div class="max-h-[60vh] overflow-y-auto">${content}</div>
                        <div class="flex justify-end gap-4 mt-6 border-t pt-4">
                            <button id="modal-cancel" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg font-semibold">Ø¥Ù„ØºØ§Ø¡</button>
                            ${onConfirm ? `<button id="modal-confirm" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold">Ø­ÙØ¸</button>` : ''}
                        </div>
                    </div>
                </div>`;
            getEl('modal-backdrop').addEventListener('click', (e) => { if (e.target === getEl('modal-backdrop')) closeModal(); });
            getEl('modal-cancel').onclick = closeModal;
            if (onConfirm) getEl('modal-confirm').onclick = onConfirm;
        }

        function closeModal() { modalContainer.innerHTML = ''; }
        function showLoadingModal(text) {
            modalContainer.innerHTML = `<div class="modal-backdrop"><div class="bg-white p-6 rounded-lg shadow-xl"><div class="loader mx-auto mb-2"></div><p>${text}</p></div></div>`;
        }

        function showDeleteConfirmationModal(onConfirm) {
            showModal('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', '<p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</p>', onConfirm);
        }

        async function loadSellerProducts(user) {
            try {
                const q = query(collection(db, "products"), where("sellerId", "==", user.uid), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                sellerProductsCache = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (sellerProductsCache.length === 0) {
                    noProductsMsg.classList.remove('hidden');
                    productsList.classList.add('hidden');
                } else {
                    noProductsMsg.classList.add('hidden');
                    productsList.classList.remove('hidden');
                    productsList.innerHTML = '';
                    sellerProductsCache.forEach(product => productsList.appendChild(createProductCard(product)));
                }
            } catch (error) {
                console.error("Error fetching seller products: ", error);
            }
        }
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-xl shadow-md flex flex-col relative border';
            const image = (product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls[0] : 'https://placehold.co/300x160/e2e8f0/94a3b8?text=No+Image';

            // Strip HTML from name for safe display
            const nameDiv = document.createElement('div');
            nameDiv.innerHTML = product.name;
            const cleanName = nameDiv.textContent || nameDiv.innerText || "";

            card.innerHTML = `
                <img src="${image}" class="w-full h-40 object-cover rounded-lg mb-4 bg-gray-100">
                <h3 class="font-bold text-xl mb-2 flex-grow">${cleanName}</h3>
                <p class="text-gray-500 text-sm mb-2">${product.productType === 'direct' ? 'ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø±' : 'Ø¨ÙŠØ¹ Ù…Ø¨Ø§Ø´Ø±'}</p>
                <p class="text-lg font-bold text-blue-600 mb-4">${(product.price || 0).toLocaleString()} Ø¯.Ø¬</p>
                <div class="border-t mt-4 pt-3 flex justify-end gap-2">
                    <button class="edit-product-btn text-gray-400 hover:text-blue-600" data-id="${product.id}" title="ØªØ¹Ø¯ÙŠÙ„"><i class="fas fa-edit fa-lg"></i></button>
                    <button class="delete-product-btn text-gray-400 hover:text-red-600" data-id="${product.id}" title="Ø­Ø°Ù"><i class="fas fa-trash fa-lg"></i></button>
                </div>`;
            card.querySelector('.edit-product-btn').onclick = () => showProductModal(product);
            card.querySelector('.delete-product-btn').onclick = () => showDeleteConfirmationModal(async () => {
                await deleteDoc(doc(db, "products", product.id));
                closeModal();
                loadSellerProducts(currentUser);
            });
            return card;
        }


        // ... (Ø¯ÙˆØ§Ù„ "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©" ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ) ...
        async function loadSellerOrders() {
            try {
                const ordersSnapshot = await getDocs(query(collection(db, "orders"), orderBy("createdAt", "desc")));
                const allOrders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const mySellerId = currentUser.uid;
                const myOrders = allOrders.filter(order => {
                    return order.items.some(item => {
                        return sellerProductsCache.some(sellerProd => sellerProd.id === item.id);
                    });
                });

                ordersLoader.classList.add('hidden');

                if (myOrders.length === 0) {
                    noOrdersMsg.classList.remove('hidden');
                    ordersTable.classList.add('hidden');
                } else {
                    ordersTableBody.innerHTML = '';
                    myOrders.forEach(order => {
                        ordersTableBody.appendChild(createOrderRow(order));
                    });
                    noOrdersMsg.classList.add('hidden');
                    ordersTable.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error loading seller orders: ", error);
                ordersLoader.innerHTML = `<p class="text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.</p>`;
            }
        }
        function createOrderRow(order) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            const date = order.createdAt?.toDate().toLocaleDateString('ar-EG', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' }) || '---';

            const myItemsInOrder = order.items.filter(item =>
                sellerProductsCache.some(sellerProd => sellerProd.id === item.id)
            );

            const itemsHtml = myItemsInOrder.map(item => `
                <div class="font-semibold text-gray-800">${item.quantity} x ${item.name}</div>
            `).join('');

            const subtotal = myItemsInOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            // Status Dropdown Logic
            const statusOptions = [
                { val: 'new', label: 'Ø¬Ø¯ÙŠØ¯', color: 'bg-blue-100 text-blue-800' },
                { val: 'preparing', label: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±', color: 'bg-yellow-100 text-yellow-800' },
                { val: 'completed', label: 'Ù…ÙƒØªÙ…Ù„', color: 'bg-green-100 text-green-800' },
                { val: 'canceled', label: 'Ù…Ù„ØºÙŠ', color: 'bg-red-100 text-red-800' }
            ];

            const currentStatus = statusOptions.find(s => s.val === order.status) || statusOptions[0];

            // Build Select Options
            const optionsHtml = statusOptions.map(opt =>
                `<option value="${opt.val}" ${order.status === opt.val ? 'selected' : ''}>${opt.label}</option>`
            ).join('');

            row.innerHTML = `
                <td data-label="Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª" class="p-4 text-sm">${itemsHtml}</td>
                <td data-label="Ø§Ù„Ø¹Ù…ÙŠÙ„" class="p-4 font-semibold">
                    ${order.customerName}
                    <div class="text-xs text-gray-400 font-normal">${date}</div>
                </td>
                <td data-label="Ø§Ù„Ù‡Ø§ØªÙ" class="p-4 font-mono text-sm" dir="ltr">${order.customerContact}</td>
                <td data-label="Ø§Ù„Ù…ÙˆÙ‚Ø¹" class="p-4 text-sm text-gray-600 truncate max-w-xs">${order.customerLocation}</td>
                <td data-label="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ" class="p-4 font-bold text-blue-600">${subtotal.toLocaleString()} Ø¯.Ø¬</td>
                <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©" class="p-4">
                    <select class="status-select p-2 rounded-lg text-sm font-bold border-0 cursor-pointer ${currentStatus.color}" data-id="${order.id}">
                        ${optionsHtml}
                    </select>
                </td>
                <td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" class="p-4">
                     <button class="print-order-btn text-gray-500 hover:text-gray-800 ml-2" data-id="${order.id}" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„">
                        <i class="fas fa-print fa-lg"></i>
                    </button>
                </td>
            `;

            // Attach Event Listeners
            const select = row.querySelector('.status-select');
            select.addEventListener('change', async (e) => {
                const newStatus = e.target.value;
                const selectedOpt = statusOptions.find(s => s.val === newStatus);

                // Update Color immediately
                select.className = `status-select p-2 rounded-lg text-sm font-bold border-0 cursor-pointer ${selectedOpt.color}`;

                try {
                    await updateDoc(doc(db, "orders", order.id), { status: newStatus });
                    showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } catch (err) {
                    console.error(err);
                    showToast('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©', 'error');
                }
            });

            row.querySelector('.print-order-btn').onclick = () => printOrder(order);

            return row;
        }


        // === (Ù„ÙˆØ­Ø© "Ø§Ù„Ø±Ø³Ø§Ø¦Ù„") ===
        async function loadSellerMessages() {
            try {
                // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø°ÙŠ ÙŠØªØ·Ù„Ø¨ ÙÙ‡Ø±Ø³
                const q = query(
                    collection(db, "inquiries"),
                    where("sellerId", "==", currentUser.uid),
                    orderBy("createdAt", "desc")
                );

                const querySnapshot = await getDocs(q);
                const myMessages = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                messagesLoader.classList.add('hidden');

                if (myMessages.length === 0) {
                    noMessagesMsg.classList.remove('hidden');
                    messagesTable.classList.add('hidden');
                } else {
                    messagesTableBody.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                    myMessages.forEach(msg => {
                        messagesTableBody.appendChild(createMessageRow(msg));
                    });
                    noMessagesMsg.classList.add('hidden');
                    messagesTable.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error loading seller messages: ", error);
                messagesLoader.innerHTML = `<p class="text-red-500 text-center"><b>Ø®Ø·Ø£:</b> Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„. <br>Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø­ØªÙ…Ù„ Ù‡Ùˆ Ø£Ù† Ø§Ù„ÙÙ‡Ø±Ø³ (Index) Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ 'inquiries' Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨Ø¹Ø¯. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Firebase.</p>`;
            }
        }

        function createMessageRow(msg) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';

            const date = msg.createdAt?.toDate().toLocaleDateString('ar-EG', { day: '2-digit', month: 'long', year: 'numeric' }) || '---';

            row.innerHTML = `
                <td data-label="Ø§Ù„Ù…Ø±Ø³Ù„" class="p-4 font-semibold">${msg.fullName}</td>
                <td data-label="Ø§Ù„Ù‡Ø§ØªÙ" class="p-4 font-mono" dir="ltr">${msg.phone || '---'}</td>
                <td data-label="Ø§Ù„Ø±Ø³Ø§Ù„Ø©" class="p-4 text-sm" style="white-space: pre-wrap; max-width: 300px;">${msg.message}</td>
                <td data-label="Ø¨Ø®ØµÙˆØµ Ù…Ù†ØªØ¬" class="p-4 text-sm font-semibold">${msg.productName || 'Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø©'}</td>
                <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®" class="p-4 text-sm font-mono">${date}</td>
            `;
            return row;
        }

        // --- Store Settings Logic ---
        async function loadStoreSettings() {
            if (!currentUser) return;
            try {
                const userDoc = await getDoc(doc(db, "users", currentUser.uid));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    if (document.getElementById('store-name')) document.getElementById('store-name').value = data.storeName || data.displayName || '';
                    if (document.getElementById('store-type')) document.getElementById('store-type').value = data.role === 'restaurant' ? 'restaurant' : 'vendor';
                    if (document.getElementById('store-desc')) document.getElementById('store-desc').value = data.description || '';
                    if (document.getElementById('store-cover')) document.getElementById('store-cover').value = data.coverUrl || '';
                    if (document.getElementById('store-logo')) document.getElementById('store-logo').value = data.logoUrl || data.photoURL || '';
                    if (document.getElementById('store-delivery')) document.getElementById('store-delivery').value = data.deliveryFee || '';
                    if (document.getElementById('store-open')) document.getElementById('store-open').checked = data.isOpen !== false;
                }
            } catch (e) { console.error(e); }
        }


        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ØµÙØ­Ø© ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loginBtn.classList.add('hidden');
                userMenu.classList.remove('hidden');
                const displayName = user.displayName || "Ø§Ù„ØªØ§Ø¬Ø±";
                userMenuName.textContent = displayName.split(' ')[0];
                userMenuDisplayName.textContent = displayName;

                sellerContent.classList.remove('hidden');
                authLoader.classList.add('hidden');

                loadSellerProducts(user);
                loadCategories();

                // Initial load based on active tab
                const activeTab = document.querySelector('.dashboard-tab.active');
                if (activeTab && activeTab.dataset.target === 'overview-panel') {
                    loadOverviewData();
                    activeTab.dataset.loaded = 'true';
                }

                loadStoreSettings(); // Pre-load settings
            } else {
                window.location.href = 'login.html';
            }
        });

        // --- Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ---
        userMenuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            userMenuDropdown.classList.toggle('show');
        });
        document.addEventListener('click', () => {
            if (userMenuDropdown.classList.contains('show')) {
                userMenuDropdown.classList.remove('show');
            }
        });
        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch((error) => console.error('Logout Error', error));
        });

        addProductBtn.addEventListener('click', () => {
            showProductModal(null);
        });


        // === (Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±) ===
        // 1. Load Settings
        async function loadStoreSettings() {
            try {
                const docSnap = await getDoc(doc(db, "users", currentUser.uid));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const req = data.storeRequest || {};
                    const links = req.links || {};

                    document.getElementById('set-store-type').value = data.role === 'restaurant' ? 'restaurant' : 'vendor';
                    document.getElementById('set-store-name').value = data.storeName || req.storeName || '';
                    document.getElementById('set-store-desc').value = data.description || req.description || '';
                    document.getElementById('set-store-delivery').value = data.deliveryFee || '';
                    document.getElementById('set-logo-url').value = data.logoUrl || req.logoUrl || '';
                    document.getElementById('set-cover-url').value = data.coverUrl || req.coverUrl || '';

                    document.getElementById('set-fb').value = links.facebook || '';
                    document.getElementById('set-insta').value = links.instagram || '';
                    document.getElementById('set-telegram').value = links.telegram || '';
                    document.getElementById('set-phone').value = links.phone || '';

                    document.getElementById('set-is-open').checked = data.isOpen !== false; // Default Open
                }
            } catch (e) {
                console.error("Error loading settings:", e);
            }
        }


        // 2. Save Settings
        const settingsForm = document.getElementById('store-settings-form');
        if (settingsForm) {
            settingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('save-settings-btn');
                btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
                btn.disabled = true;

                const updates = {
                    storeName: document.getElementById('set-store-name').value,
                    "storeRequest.description": document.getElementById('set-store-desc').value,
                    "storeRequest.logoUrl": document.getElementById('set-logo-url').value,
                    "storeRequest.coverUrl": document.getElementById('set-cover-url').value,
                    description: document.getElementById('set-store-desc').value,
                    logoUrl: document.getElementById('set-logo-url').value,
                    coverUrl: document.getElementById('set-cover-url').value,
                    deliveryFee: parseFloat(document.getElementById('set-store-delivery').value) || 0,
                    "storeRequest.links": {
                        facebook: document.getElementById('set-fb').value,
                        instagram: document.getElementById('set-insta').value,
                        telegram: document.getElementById('set-telegram').value,
                        phone: document.getElementById('set-phone').value
                    },
                    isOpen: document.getElementById('set-is-open').checked
                };

                try {
                    await updateDoc(doc(db, "users", currentUser.uid), updates);
                    showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!", "success");
                } catch (error) {
                    console.error("Save failed:", error);
                    showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸.", "error");
                } finally {
                    btn.textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
                    btn.disabled = false;
                }
            });
        }

        // 3. Actions
        window.copyStoreLink = () => {
            const link = `${window.location.origin}/vendor.html?id=${currentUser.uid}`;
            navigator.clipboard.writeText(link).then(() => showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!", "success"));
        };

        window.requestClosure = async () => {
            if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø·Ù„Ø¨ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØ¬Ø± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø´Ø±Ù.")) {
                try {
                    await updateDoc(doc(db, "users", currentUser.uid), {
                        "storeRequest.closureStatus": "pending",
                        "storeRequest.closureRequestedAt": Timestamp.now()
                    });
                    showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚.", "success");
                } catch (e) { console.error(e); showToast("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.", "error"); }
            }
        };

        window.printOrder = (order) => {
            const printWindow = window.open('', '_blank');
            const itemsHtml = (order.items || []).map(item => {
                let addons = (item.selectedAddons || []).map(a => `<li class="addon-item">+ ${a.name}</li>`).join('');
                if (addons) addons = `<ul class="addons-list">${addons}</ul>`;
                let instructions = item.cookingInstructions ? `<div class="instructions">Ù…Ù„Ø§Ø­Ø¸Ø©: ${item.cookingInstructions}</div>` : '';

                return `<tr class="item-row">
                                <td class="quantity">${item.quantity}x</td>
                                <td class="item-details">
                                    <div class="item-name">${item.name}</div>
                                    ${addons}
                                    ${instructions}
                                </td>
                                <td class="price">${(item.price * item.quantity).toLocaleString()}</td>
                            </tr>`;
            }).join('');

            const total = (order.totalPrice || 0).toLocaleString();
            const date = order.createdAt?.toDate ? order.createdAt.toDate().toLocaleString('ar-EG') : '---';

            printWindow.document.write(`
                    <html><head><title>Order #${order.id.substring(0, 5)}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
                    <style>
                        body { 
                            font-family: 'Tajawal', sans-serif; 
                            direction: rtl; 
                            margin: 0; 
                            padding: 10px;
                            width: 80mm; 
                            color: #000;
                        }
                        .header { text-align: center; margin-bottom: 20px; border-bottom: 1px dashed #000; padding-bottom: 10px;}
                        .header h1 { margin: 0; font-size: 22px; font-weight: 800; }
                        .header p { margin: 5px 0 0; font-size: 14px; }
                        
                        .info { font-size: 14px; margin-bottom: 15px; }
                        .info div { margin-bottom: 4px; }
                        
                        table { width: 100%; border-collapse: collapse; font-size: 14px; }
                        th { text-align: right; border-bottom: 1px solid #000; padding-bottom: 4px; }
                        td { vertical-align: top; padding: 6px 0; }
                        .quantity { width: 30px; font-weight: bold; }
                        .price { text-align: left; font-weight: bold; }
                        
                        .addons-list { list-style: none; padding-right: 10px; margin: 2px 0; font-size: 12px; color: #444; }
                        .instructions { background: #eee; padding: 2px; font-size: 11px; margin-top: 2px; }
                        
                        .totals { border-top: 2px solid #000; margin-top: 10px; padding-top: 10px; font-size: 16px; font-weight: bold; }
                        .totals div { display: flex; justify-content: space-between; margin-bottom: 5px; }
                        
                        .footer { text-align: center; margin-top: 20px; font-size: 12px; border-top: 1px dashed #000; padding-top: 10px; }
                        @media print { .no-print { display: none; } }
                    </style>
                    </head><body>
                        <div class="header">
                            <h1>${currentUser.storeName || 'S22 Market'}</h1>
                            <p>${date}</p>
                            <p>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: #${order.id.substring(0, 5)}</p>
                        </div>
                        
                        <div class="info">
                            <div><b>Ø§Ù„Ø¹Ù…ÙŠÙ„:</b> ${order.customerName}</div>
                            <div><b>Ø§Ù„Ù‡Ø§ØªÙ:</b> ${order.customerContact}</div>
                            <div style="font-size:12px"><b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${order.customerLocation}</div>
                        </div>

                        <table>
                            <thead><tr><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„ØµÙ†Ù</th><th style="text-align:left">Ø§Ù„Ø³Ø¹Ø±</th></tr></thead>
                            <tbody>${itemsHtml}</tbody>
                        </table>

                        <div class="totals">
                            <div>
                                <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                                <span>${total} Ø¯.Ø¬</span>
                            </div>
                        </div>

                        <div class="footer">
                            <p>Ø´ÙƒØ±Ø§Ù‹ Ù„Ø·Ù„Ø¨ÙƒÙ…!</p>
                            <p>S22Market.com</p>
                        </div>

                        <script>
                            window.onload = function() { window.print(); window.close(); }
                        <\/script>
                    </body></html>
                `);
            printWindow.document.close();
        };

        // Initialize Tab
        document.querySelector('[data-target="settings-panel"]')?.addEventListener('click', loadStoreSettings);
    </script>
</body>

</html>